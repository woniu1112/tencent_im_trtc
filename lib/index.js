(function (global, factory) {
	typeof exports === 'object' && typeof module !== 'undefined' ? module.exports = factory() :
	typeof define === 'function' && define.amd ? define(factory) :
	(global = typeof globalThis !== 'undefined' ? globalThis : global || self, global.jkyTRTC = factory());
})(this, (function () { 'use strict';

	var commonjsGlobal = typeof globalThis !== 'undefined' ? globalThis : typeof window !== 'undefined' ? window : typeof global !== 'undefined' ? global : typeof self !== 'undefined' ? self : {};

	function getDefaultExportFromCjs (x) {
		return x && x.__esModule && Object.prototype.hasOwnProperty.call(x, 'default') ? x['default'] : x;
	}

	var chat$1 = {exports: {}};

	var chat = chat$1.exports;

	var hasRequiredChat;

	function requireChat () {
		if (hasRequiredChat) return chat$1.exports;
		hasRequiredChat = 1;
		(function (module, exports) {
	!function(e,t){module.exports=t();}(chat,function(){function o(t,e){var n,o=Object.keys(t);return Object.getOwnPropertySymbols&&(n=Object.getOwnPropertySymbols(t),e&&(n=n.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),o.push.apply(o,n)),o}function y(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?o(Object(n),!0).forEach(function(e){c(t,e,n[e]);}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e));});}return t}function r(e){return (r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function d(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o);}}function e(e,t,n){return t&&i(e.prototype,t),n&&i(e,n),Object.defineProperty(e,"prototype",{writable:!1}),e}function c(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function t(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&l(e,t);}function u(e){return (u=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function l(e,t){return (l=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function p(){if("undefined"==typeof Reflect||!Reflect.construct)return !1;if(Reflect.construct.sham)return !1;if("function"==typeof Proxy)return !0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(e){return !1}}function _(e,t,n){return (_=p()?Reflect.construct:function(e,t,n){var o=[null],t=(o.push.apply(o,t),new(Function.bind.apply(e,o)));return n&&l(t,n.prototype),t}).apply(null,arguments)}function n(e){var n="function"==typeof Map?new Map:void 0;return function(e){if(null===e||-1===Function.toString.call(e).indexOf("[native code]"))return e;if("function"!=typeof e)throw new TypeError("Super expression must either be null or a function");if(void 0!==n){if(n.has(e))return n.get(e);n.set(e,t);}function t(){return _(e,arguments,u(this).constructor)}return t.prototype=Object.create(e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),l(t,e)}(e)}function g(e,t){if(null==e)return {};var n,o=function(e,t){if(null==e)return {};for(var n,o={},i=Object.keys(e),a=0;a<i.length;a++)n=i[a],0<=t.indexOf(n)||(o[n]=e[n]);return o}(e,t);if(Object.getOwnPropertySymbols)for(var i=Object.getOwnPropertySymbols(e),a=0;a<i.length;a++)n=i[a],0<=t.indexOf(n)||Object.prototype.propertyIsEnumerable.call(e,n)&&(o[n]=e[n]);return o}function h(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function f(n){var o=p();return function(){var e,t=u(n),t=(e=o?(e=u(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments),this);if(e&&("object"==typeof e||"function"==typeof e))return e;if(void 0!==e)throw new TypeError("Derived constructors may only return object or undefined");return h(t)}}function m(e,t){return E(e)||function(e,t){var n=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=n){var o,i,a=[],s=!0,r=!1;try{for(n=n.call(e);!(s=(o=n.next()).done)&&(a.push(o.value),!t||a.length!==t);s=!0);}catch(e){r=!0,i=e;}finally{try{s||null==n.return||n.return();}finally{if(r)throw i}}return a}}(e,t)||S(e,t)||O()}function D(e){return function(e){if(Array.isArray(e))return k(e)}(e)||L(e)||S(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function E(e){if(Array.isArray(e))return e}function L(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}function S(e,t){if(e){if("string"==typeof e)return k(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return "Map"===(n="Object"===n&&e.constructor?e.constructor.name:n)||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?k(e,t):void 0}}function k(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,o=new Array(t);n<t;n++)o[n]=e[n];return o}function O(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function N(e,t){var n,o="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!o){if(Array.isArray(e)||(o=S(e))||t&&e&&"number"==typeof e.length)return o&&(e=o),n=0,{s:t=function(){},n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:t};throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var i,a=!0,s=!1;return {s:function(){o=o.call(e);},n:function(){var e=o.next();return a=e.done,e},e:function(e){s=!0,i=e;},f:function(){try{a||null==o.return||o.return();}finally{if(s)throw i}}}}var G={SDK_READY:"sdkStateReady",SDK_NOT_READY:"sdkStateNotReady",SDK_DESTROY:"sdkDestroy",MESSAGE_RECEIVED:"onMessageReceived",ROOM_CUSTOM_DATA_RECEIVED:"onRoomCustomDataReceived",MESSAGE_MODIFIED:"onMessageModified",MESSAGE_REVOKED:"onMessageRevoked",MESSAGE_READ_BY_PEER:"onMessageReadByPeer",MESSAGE_READ_RECEIPT_RECEIVED:"onMessageReadReceiptReceived",MESSAGE_EXTENSIONS_UPDATED:"onMessageExtensionsUpdated",MESSAGE_EXTENSIONS_DELETED:"onMessageExtensionsDeleted",MESSAGE_REACTIONS_UPDATED:"onMessageReactionsUpdated",CONVERSATION_LIST_UPDATED:"onConversationListUpdated",TOTAL_UNREAD_MESSAGE_COUNT_UPDATED:"onTotalUnreadMessageCountUpdated",CONVERSATION_GROUP_LIST_UPDATED:"onConversationGroupListUpdated",CONVERSATION_IN_GROUP_UPDATED:"onConversationInGroupUpdated",GROUP_LIST_UPDATED:"onGroupListUpdated",GROUP_ATTRIBUTES_UPDATED:"groupAttributesUpdated",GROUP_COUNTER_UPDATED:"onGroupCounterUpdated",TOPIC_CREATED:"onTopicCreated",TOPIC_DELETED:"onTopicDeleted",TOPIC_UPDATED:"onTopicUpdated",PROFILE_UPDATED:"onProfileUpdated",USER_STATUS_UPDATED:"onUserStatusUpdated",BLACKLIST_UPDATED:"blacklistUpdated",FRIEND_LIST_UPDATED:"onFriendListUpdated",FRIEND_GROUP_LIST_UPDATED:"onFriendGroupListUpdated",FRIEND_APPLICATION_LIST_UPDATED:"onFriendApplicationListUpdated",MY_FOLLOWERS_LIST_UPDATED:"onMyFollowersListUpdated",MY_FOLLOWING_LIST_UPDATED:"onMyFollowingListUpdated",MUTUAL_FOLLOWERS_LIST_UPDATED:"onMutualFollowersListUpdated",KICKED_OUT:"kickedOut",ERROR:"error",NET_STATE_CHANGE:"netStateChange",ALL_RECEIVE_MESSAGE_OPT_UPDATED:"onAllReceiveMessageOptUpdated"},R={MSG_TEXT:"TIMTextElem",MSG_IMAGE:"TIMImageElem",MSG_SOUND:"TIMSoundElem",MSG_AUDIO:"TIMSoundElem",MSG_FILE:"TIMFileElem",MSG_FACE:"TIMFaceElem",MSG_VIDEO:"TIMVideoFileElem",MSG_GEO:"TIMLocationElem",MSG_LOCATION:"TIMLocationElem",MSG_GRP_TIP:"TIMGroupTipElem",MSG_GRP_SYS_NOTICE:"TIMGroupSystemNoticeElem",MSG_CUSTOM:"TIMCustomElem",MSG_MERGER:"TIMRelayElem",MSG_PRIORITY_HIGH:"High",MSG_PRIORITY_NORMAL:"Normal",MSG_PRIORITY_LOW:"Low",MSG_PRIORITY_LOWEST:"Lowest",CONV_C2C:"C2C",CONV_GROUP:"GROUP",CONV_TOPIC:"TOPIC",CONV_SYSTEM:"@TIM#SYSTEM",CONV_AT_ME:1,CONV_AT_ALL:2,CONV_AT_ALL_AT_ME:3,CONV_MARK_TYPE_STAR:1,CONV_MARK_TYPE_UNREAD:2,CONV_MARK_TYPE_FOLD:4,CONV_MARK_TYPE_HIDE:8,GRP_PRIVATE:"Private",GRP_WORK:"Private",GRP_PUBLIC:"Public",GRP_CHATROOM:"ChatRoom",GRP_MEETING:"ChatRoom",GRP_AVCHATROOM:"AVChatRoom",GRP_COMMUNITY:"Community",GRP_ROOM:"Room",GRP_LIVE:"Live",GRP_MBR_ROLE_OWNER:"Owner",GRP_MBR_ROLE_ADMIN:"Admin",GRP_MBR_ROLE_MEMBER:"Member",GRP_MBR_ROLE_CUSTOM:"Custom",GRP_TIP_MBR_JOIN:1,GRP_TIP_MBR_QUIT:2,GRP_TIP_MBR_KICKED_OUT:3,GRP_TIP_MBR_SET_ADMIN:4,GRP_TIP_MBR_CANCELED_ADMIN:5,GRP_TIP_GRP_PROFILE_UPDATED:6,GRP_TIP_MBR_PROFILE_UPDATED:7,GRP_TIP_BAN_AVCHATROOM_MEMBER:10,GRP_TIP_UNBAN_AVCHATROOM_MEMBER:11,MSG_REMIND_ACPT_AND_NOTE:"AcceptAndNotify",MSG_REMIND_ACPT_NOT_NOTE:"AcceptNotNotify",MSG_REMIND_DISCARD:"Discard",RECEIVE_WITH_OFFLINE_PUSH_EXCEPT_AT:"AcceptNotNotifyExceptAt",NOT_RECEIVE_OFFLINE_PUSH_EXCEPT_AT:"AcceptNotNotifyExceptAt",NOT_RECEIVE_MSG_EXCEPT_AT:"NotReceiveMsgExceptAt",GENDER_UNKNOWN:"Gender_Type_Unknown",GENDER_FEMALE:"Gender_Type_Female",GENDER_MALE:"Gender_Type_Male",KICKED_OUT_MULT_ACCOUNT:"multipleAccount",KICKED_OUT_MULT_DEVICE:"multipleDevice",KICKED_OUT_USERSIG_EXPIRED:"userSigExpired",KICKED_OUT_REST_API:"REST_API_Kick",ALLOW_TYPE_ALLOW_ANY:"AllowType_Type_AllowAny",ALLOW_TYPE_NEED_CONFIRM:"AllowType_Type_NeedConfirm",ALLOW_TYPE_DENY_ANY:"AllowType_Type_DenyAny",FORBID_TYPE_NONE:"AdminForbid_Type_None",FORBID_TYPE_SEND_OUT:"AdminForbid_Type_SendOut",JOIN_OPTIONS_FREE_ACCESS:"FreeAccess",JOIN_OPTIONS_NEED_PERMISSION:"NeedPermission",JOIN_OPTIONS_DISABLE_APPLY:"DisableApply",JOIN_STATUS_SUCCESS:"JoinedSuccess",JOIN_STATUS_ALREADY_IN_GROUP:"AlreadyInGroup",JOIN_STATUS_WAIT_APPROVAL:"WaitAdminApproval",INVITE_OPTIONS_DISABLE_INVITE:"DisableInvite",INVITE_OPTIONS_NEED_PERMISSION:"NeedPermission",INVITE_OPTIONS_FREE_ACCESS:"FreeAccess",GRP_PROFILE_OWNER_ID:"ownerID",GRP_PROFILE_CREATE_TIME:"createTime",GRP_PROFILE_LAST_INFO_TIME:"lastInfoTime",GRP_PROFILE_MEMBER_NUM:"memberNum",GRP_PROFILE_MAX_MEMBER_NUM:"maxMemberNum",GRP_PROFILE_JOIN_OPTION:"joinOption",GRP_PROFILE_INVITE_OPTION:"inviteOption",GRP_PROFILE_INTRODUCTION:"introduction",GRP_PROFILE_NOTIFICATION:"notification",GRP_PROFILE_MUTE_ALL_MBRS:"muteAllMembers",SNS_ADD_TYPE_SINGLE:"Add_Type_Single",SNS_ADD_TYPE_BOTH:"Add_Type_Both",SNS_DELETE_TYPE_SINGLE:"Delete_Type_Single",SNS_DELETE_TYPE_BOTH:"Delete_Type_Both",SNS_APPLICATION_TYPE_BOTH:"Pendency_Type_Both",SNS_APPLICATION_SENT_TO_ME:"Pendency_Type_ComeIn",SNS_APPLICATION_SENT_BY_ME:"Pendency_Type_SendOut",SNS_APPLICATION_AGREE:"Response_Action_Agree",SNS_APPLICATION_AGREE_AND_ADD:"Response_Action_AgreeAndAdd",SNS_CHECK_TYPE_BOTH:"CheckResult_Type_Both",SNS_CHECK_TYPE_SINGLE:"CheckResult_Type_Single",SNS_TYPE_NO_RELATION:"CheckResult_Type_NoRelation",SNS_TYPE_A_WITH_B:"CheckResult_Type_AWithB",SNS_TYPE_B_WITH_A:"CheckResult_Type_BWithA",SNS_TYPE_BOTH_WAY:"CheckResult_Type_BothWay",NET_STATE_CONNECTED:"connected",NET_STATE_CONNECTING:"connecting",NET_STATE_DISCONNECTED:"disconnected",MSG_AT_ALL:"__kImSDK_MesssageAtALL__",READ_ALL_C2C_MSG:"readAllC2CMessage",READ_ALL_GROUP_MSG:"readAllGroupMessage",READ_ALL_MSG:"readAllMessage",USER_STATUS_UNKNOWN:0,USER_STATUS_ONLINE:1,USER_STATUS_OFFLINE:2,USER_STATUS_UNLOGINED:3,IOS_OFFLINE_PUSH_NO_SOUND:"push.no_sound",IOS_OFFLINE_PUSH_DEFAULT_SOUND:"default"},P={NEW_INVITATION_RECEIVED:"newInvitationReceived",INVITEE_ACCEPTED:"ts_invitee_accepted",INVITEE_REJECTED:"ts_invitee_rejected",INVITATION_CANCELLED:"ts_invitation_cancelled",INVITATION_TIMEOUT:"ts_invitation_timeout",INVITATION_MODIFIED:"ts_invitation_modified",ACTION_TYPE_UNKNOWN:0,ACTION_TYPE_INVITE:1,ACTION_TYPE_CANCEL_INVITE:2,ACTION_TYPE_ACCEPT_INVITE:3,ACTION_TYPE_REJECT_INVITE:4,ACTION_TYPE_INVITE_TIMEOUT:5},U=(e(j,[{key:"use",value:function(e){if("function"!=typeof e)throw "middleware must be a function";return this.cache.push(e),this}},{key:"next",value:function(e){if(this.middlewares&&0<this.middlewares.length)return this.middlewares.shift().call(this,this.options,this.next.bind(this))}},{key:"run",value:function(e){return this.middlewares=this.cache.map(function(e){return e}),this.options=e,this.next()}}]),j),b=(e(W,[{key:"equal",value:function(e){return null!==e&&this.low===e.low&&this.high===e.high}},{key:"toString",value:function(){var e=Number(this.high).toString(16),t=Number(this.low).toString(16);if(t.length<8)for(var n=8-t.length;n;)t="0"+t,n--;return e+t}}]),W),w={TEST:{CHINA:{DEFAULT:"wss://wss-dev.tim.qq.com"},OVERSEA:{DEFAULT:"wss://wss-dev.tim.qq.com"},SINGAPORE:{DEFAULT:"wss://wsssgp-dev.im.qcloud.com"},KOREA:{DEFAULT:"wss://wsskr-dev.im.qcloud.com"},GERMANY:{DEFAULT:"wss://wssger-dev.im.qcloud.com"},IND:{DEFAULT:"wss://wssind-dev.im.qcloud.com"},JPN:{DEFAULT:"wss://wssjpn-dev.im.qcloud.com"},USA:{DEFAULT:"wss://wssusa-dev.im.qcloud.com"},INDONESIA:{DEFAULT:"wss://wssidn-dev.im.qcloud.com"}},PRODUCTION:{CHINA:{DEFAULT0:"wss://*w4c.my-imcloud.com",DEFAULT:"wss://wss.im.qcloud.com",IPV6:"wss://wssv6.im.qcloud.com",BACKUP:"wss://wss.tim.qq.com",STAT:"https://events.im.qcloud.com",ANYCAST:"wss://162.14.13.203"},OVERSEA:{DEFAULT0:"wss://*w4c.my-imcloud.com",DEFAULT:"wss://wss.im.qcloud.com",BACKUP:"wss://wss.my-imcloud.com",STAT:"https://api.my-imcloud.com"},SINGAPORE:{DEFAULT0:"wss://*w4s.my-imcloud.com",DEFAULT:"wss://wsssgp.im.qcloud.com",IPV6:"wss://wsssgpv6.im.qcloud.com",BACKUP:"wss://wsssgp.my-imcloud.com",STAT:"https://apisgp.my-imcloud.com",ANYCAST:"wss://162.14.19.159"},KOREA:{DEFAULT0:"wss://*w4k.my-imcloud.com",DEFAULT:"wss://wsskr.im.qcloud.com",IPV6:"wss://wsskrv6.im.qcloud.com",BACKUP:"wss://wsskr.my-imcloud.com",STAT:"https://apikr.my-imcloud.com",ANYCAST:"wss://162.14.13.104"},GERMANY:{DEFAULT0:"wss://*w4g.my-imcloud.com",DEFAULT:"wss://wssger.im.qcloud.com",IPV6:"wss://wssgerv6.im.qcloud.com",BACKUP:"wss://wssger.my-imcloud.com",STAT:"https://apiger.my-imcloud.com",ANYCAST:"wss://162.14.3.17"},IND:{DEFAULT0:"wss://*w4i.my-imcloud.com",DEFAULT:"wss://wssind.my-imcloud.com",IPV6:"wss://wssindv6.im.qcloud.com",BACKUP:"wss://wssind.im.qcloud.com",STAT:"https://apiind.my-imcloud.com",ANYCAST:"wss://162.14.19.46"},JPN:{DEFAULT0:"wss://*w4j.my-imcloud.com",DEFAULT:"wss://wssjpn.im.qcloud.com",IPV6:"wss://wssjpnv6.im.qcloud.com",BACKUP:"wss://wssjpn.my-imcloud.com",STAT:"https://apijpn.my-imcloud.com"},USA:{DEFAULT0:"wss://*w4u.my-imcloud.com",DEFAULT:"wss://wssusa.im.qcloud.com",IPV6:"wss://wssusav6.im.qcloud.com",BACKUP:"wss://wssusa.my-imcloud.com",STAT:"https://apiusa.my-imcloud.com",ANYCAST:"wss://162.14.10.42"},INDONESIA:{DEFAULT0:"wss://*w4y.my-imcloud.com",DEFAULT:"wss://wssidn.im.qcloud.com",IPV6:"wss://wssidnv6.im.qcloud.com",BACKUP:"wss://wssidn.my-imcloud.com",STAT:"https://apiidn.my-imcloud.com",ANYCAST:"wss://43.129.34.169"}}},F={ANDROID:2,IOS:3,MAC:4,WEB:7,WX_MP:8,QQ_MP:9,TT_MP:10,BAIDU_MP:11,ALI_MP:12,IPAD:13,UNI_NATIVE_APP:15,DONUT_NATIVE_APP:19,NS_NATIVE_APP:20,RN_NATIVE_APP:21},q="1.7.3",x=537048168,V="CHINA",a={HOST:{CURRENT:{DEFAULT:"wss://wss.im.qcloud.com",STAT:"https://events.im.qcloud.com"},setCurrent:function(){this.CURRENT=w.PRODUCTION[0<arguments.length&&void 0!==arguments[0]?arguments[0]:V];}},NAME:{OPEN_IM:"openim",OPEN_IM_MSG_EXT:"openim_msg_ext_http_svc",GRP:"group_open_http_svc",GRP_AV:"group_open_avchatroom_http_svc",GRP_COMMUNITY:"million_group_open_http_svc",GRP_ATTR:"group_open_attr_http_svc",FD:"sns",PROFILE:"profile",RECENT_CONTACT:"recentcontact",PIC:"openpic",BIG_GRP_NO_AUTH:"group_open_http_noauth_svc",BIG_GRP_POLLING:"group_open_long_polling_http_svc",BIG_GRP_POLLING_NO_AUTH:"group_open_long_polling_http_noauth_svc",IM_OPEN_STAT:"imopenstat",WEB_IM:"webim",IM_COS_SIGN:"im_cos_sign_svr",CUSTOM_UPLOAD:"im_cos_msg",HEARTBEAT:"heartbeat",IM_OPEN_PUSH:"im_open_push",IM_OPEN_STATUS:"im_open_status",IM_LONG_MSG:"im_long_msg",IM_CONFIG_MANAGER:"im_sdk_config_mgr",STAT_SERVICE:"StatSvc",OVERLOAD_PUSH:"OverLoadPush",IM_MSG_AUDIT_MGR:"im_msg_audit_mgr",TUIROOM_SVR:"tui_room_svr",IM_OPEN_TRANSLATE:"im_open_translate",IM_OPEN_SPEECH:"im_open_speech",MSG_SEARCH:"message_search",GRP_SEARCH:"group_search",GRP_MEMBER_SEARCH:"group_member_search",USER_SEARCH:"user_search",FOLLOW:"follow",OFFLINE_PUSH_REPORT:"offline_push_report",IM_MSG_LOGIC:"im_msg_db_logic"}},H={SEARCH_GRP_SNS:new b(0,Math.pow(2,1)).toString(),AV_HISTORY_MSG:new b(0,Math.pow(2,2)).toString(),GRP_COMMUNITY:new b(0,Math.pow(2,3)).toString(),MSG_TO_SPECIFIED_GRP_MBR:new b(0,Math.pow(2,4)).toString(),AV_MBR_LIST:new b(0,Math.pow(2,6)).toString(),USER_STATUS:new b(0,Math.pow(2,7)).toString(),CONV_MARK:new b(0,Math.pow(2,9)).toString(),CONV_GROUP:new b(0,Math.pow(2,10)).toString(),AV_BAN_MBR:new b(0,Math.pow(2,11)).toString(),MSG_EXT:new b(0,Math.pow(2,13)).toString(),GRP_COUNTER:new b(0,Math.pow(2,15)).toString(),PLUGIN_TRANSLATE:new b(Math.pow(2,6)).toString(),PLUGIN_VOICE_TO_TEXT:new b(Math.pow(2,7)).toString(),PLUGIN_CS:new b(Math.pow(2,8)).toString(),PLUGIN_PUSH:new b(Math.pow(2,9)).toString(),PLUGIN_BOT:new b(Math.pow(2,10)).toString(),MSG_REACTION:new b(Math.pow(2,16)).toString(),FOLLOW:new b(Math.pow(2,20)).toString()},B="group_profile",K=["Type","Name","Introduction","Notification","FaceUrl","Owner_Account","CreateTime","InfoSeq","LastInfoTime","LastMsgTime","MemberNum","MaxMemberNum","ApplyJoinOption","NextMsgSeq","ShutUpAllMember","InviteJoinOption"],Y=["Role","JoinTime","MsgSeq","MsgFlag"];function W(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:0,t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:0;d(this,W),this.high=e,this.low=t;}function j(){d(this,j),this.cache=[],this.options=null;}a.HOST.setCurrent(V);for(var J,z="undefined"!=typeof wx&&"function"==typeof wx.getSystemInfoSync&&Boolean(wx.getSystemInfoSync().fontSizeSetting),X=z&&"function"==typeof wx.createGamePortal,Z="undefined"!=typeof qq&&"function"==typeof qq.getSystemInfoSync&&Boolean(qq.getSystemInfoSync().fontSizeSetting),Q="undefined"!=typeof tt&&"function"==typeof tt.getSystemInfoSync&&Boolean(tt.getSystemInfoSync().fontSizeSetting),$="undefined"!=typeof swan&&"function"==typeof swan.getSystemInfoSync&&Boolean(swan.getSystemInfoSync().fontSizeSetting),ee="undefined"!=typeof my&&"function"==typeof my.getSystemInfoSync&&Boolean(my.getSystemInfoSync().fontSizeSetting),te="undefined"!=typeof jd&&"function"==typeof jd.getSystemInfoSync,ne="undefined"!=typeof uni&&"undefined"==typeof window&&"function"==typeof uni.requireNativePlugin,oe=z&&"object"===r(wx.miniapp),ie="undefined"!=typeof uni,ae=z||Z||Q||$||ee||ne||te,se="undefined"==typeof window&&!ae&&"undefined"!=typeof commonjsGlobal&&void 0!==commonjsGlobal.NativeScriptGlobals,re="undefined"!=typeof commonjsGlobal&&(void 0!==commonjsGlobal.nativeModuleProxy||void 0!==commonjsGlobal.ReactNative),ce="undefined"!=typeof uni?!ae:"undefined"!=typeof window&&!ae&&!re,ue=Z?qq:Q?tt:$?swan:ee?my:z?wx:ne?uni:te?jd:{},le=ce&&window&&window.navigator&&window.navigator.userAgent||"",de=(te="WEB",/(micromessenger|webbrowser)/i.test(le)?te="WEB":Z?te="QQ_MP":Q?te="TT_MP":$?te="BAIDU_MP":ee?te="ALI_MP":z?te=oe?"DONUT_NATIVE_APP":"WX_MP":ne?te="UNI_NATIVE_APP":se?te="NS_NATIVE_APP":re&&(te="RN_NATIVE_APP"),F[te]),oe=/iPad/i.test(le),se=/iPhone/i.test(le)&&!oe,te=/iPod/i.test(le),pe=se||oe||te,_e=(se=le.match(/OS (\d+)_/i))&&se[1]?se[1]:null,he=/Android/i.test(le),ge=function(){var e=le.match(/Android (\d+)(?:\.(\d+))?(?:\.(\d+))*/i);if(!e)return null;var t=e[1]&&parseFloat(e[1]),n=e[2]&&parseFloat(e[2]);return t&&n?parseFloat(e[1]+"."+e[2]):t||null}(),oe=/Edge/i.test(le),te=!oe&&/Chrome/i.test(le),fe=/MSIE/.test(le)||-1<le.indexOf("Trident")&&-1<le.indexOf("rv:11.0"),me=se=!(se=(se=/MSIE\s(\d+)\.\d/.exec(le))&&parseFloat(se[1]))&&/Trident\/7.0/i.test(le)&&/rv:11.0/.test(le)?11:se,ve=/Safari/i.test(le)&&!te&&!he&&!oe,Ie=/Windows/i.test(le),Me=/MAC OS X/i.test(le),ye=ce&&"undefined"!=typeof Worker&&!fe,Ce=he||pe,Te=ce&&void 0!==window.tencent_cloud_im_csig_flutter_for_web_25F_cy,De=function(){if("undefined"==typeof window||void 0===window.navigator)return !1;var e=window.navigator.standalone;return !(!pe||e||ve)}(),Ee="undefined"!=typeof console?console:"undefined"!=typeof commonjsGlobal&&commonjsGlobal.console?commonjsGlobal.console:"undefined"!=typeof window&&window.console?window.console:{},Le=function(){},Se=["assert","clear","count","debug","dir","dirxml","error","group","groupCollapsed","groupEnd","info","log","profile","profileEnd","table","time","timeEnd","timeStamp","trace","warn"],ke=Se.length;ke--;)J=Se[ke],console[J]||(Ee[J]=Le);function Re(){var e=new Date;return e.setTime(Pe()),e}function Ae(){Ge=0;}function Oe(){return Math.floor(Pe()/1e3)}var Ne=Ee,Ge=0,Pe=function(){return (new Date).getTime()+Ge},Ue=0;function be(){return jt()?"%c Chat %c":"Chat"}function we(){var e=Re();return e.toLocaleTimeString("en-US",{hour12:!1})+"."+function(e){var t;switch(e.toString().length){case 1:t="00"+e;break;case 2:t="0"+e;break;default:t=e;}return t}(e.getMilliseconds())}var v={arguments2String:function(e){var t="";if(1===e.length)t=e[0];else for(var n=0,o=e.length;n<o;n++){if(mt(e[n]))try{t+=vt(e[n])?JSON.stringify(e[n],["message","code"]):JSON.stringify(e[n]);}catch(e){t+=e?e.message:"";break}else t+=e[n];t+=" ";}return t},_exec:function(e,t){jt()?Ne[e](be(),"background:#0abf5b; padding:1px; border-radius:3px; color: #fff","background:transparent",we(),t):Ne[e]("".concat(be()," ").concat(we()," ").concat(t));},d:function(){var e;Ue<=-1&&(e=this.arguments2String(arguments),this._exec("debug",e));},l:function(){var e;Ue<=0&&(e=this.arguments2String(arguments),this._exec("log",e));},log:function(){var e;Ue<=0&&(e=this.arguments2String(arguments),this._exec("log",e));},i:function(){var e;Ue<=1&&(e=this.arguments2String(arguments),this._exec("info",e));},w:function(){var e;Ue<=2&&(e=this.arguments2String(arguments),this._exec("warn",e));},e:function(){var e;Ue<=3&&(e=this.arguments2String(arguments),this._exec("error",e));},setLevel:function(e){e<4&&this._exec("log","set level from "+Ue+" to "+e),Ue=e;},getLevel:function(){return Ue}},Fe={JPG:1,JPEG:1,GIF:2,PNG:3,BMP:4,UNKNOWN:255},se="Tag_Profile_IM_",qe={NICK:"".concat(se,"Nick"),GENDER:"".concat(se,"Gender"),BIRTHDAY:"".concat(se,"BirthDay"),LOCATION:"".concat(se,"Location"),SELFSIGNATURE:"".concat(se,"SelfSignature"),ALLOWTYPE:"".concat(se,"AllowType"),LANGUAGE:"".concat(se,"Language"),AVATAR:"".concat(se,"Image"),MESSAGESETTINGS:"".concat(se,"MsgSettings"),ADMINFORBIDTYPE:"".concat(se,"AdminForbidType"),LEVEL:"".concat(se,"Level"),ROLE:"".concat(se,"Role")},xe={GROUP:"".concat("Tag_SNS_IM_","Group"),REMARK:"".concat("Tag_SNS_IM_","Remark"),ADDSOURCE:"".concat("Tag_SNS_IM_","AddSource"),ADDWORDING:"".concat("Tag_SNS_IM_","Wording"),ADDTIME:"".concat("Tag_SNS_IM_","AddTime")},te="Gender_Type_",Ve={UNKNOWN:"".concat(te,"Unknown"),FEMALE:"".concat(te,"Female"),MALE:"".concat(te,"Male")},He={NONE:"".concat("AdminForbid_Type_","None"),SEND_OUT:"".concat("AdminForbid_Type_","SendOut")},Be={NEED_CONFIRM:"".concat("AllowType_Type_","NeedConfirm"),ALLOW_ANY:"".concat("AllowType_Type_","AllowAny"),DENY_ANY:"".concat("AllowType_Type_","DenyAny")},Ke="JoinedSuccess",Ye="WaitAdminApproval",We="@TOPIC#_",je=Object.prototype.hasOwnProperty;function Je(e){if(null==e)return !0;if("boolean"==typeof e)return !1;if("number"==typeof e)return 0===e;if("string"==typeof e)return 0===e.length;if("function"==typeof e)return 0===e.length;if(Array.isArray(e))return 0===e.length;if(e instanceof Error)return ""===e.message;if(et(e)){for(var t in e)if(je.call(e,t))return !1;return !0}return !!(ze(e)||Xe(e)||Ze(e))&&0===e.size}function ze(e){return "map"===It(e)}function Xe(e){return "set"===It(e)}function Ze(e){return "file"===It(e)}function Qe(e){return null!==e&&("number"==typeof e&&!isNaN(+e)||"object"===r(e)&&e.constructor===Number)}function $e(e){return null!==e&&"object"===r(e)}function et(e){if("object"===r(e)&&null!==e){if(null===(e=Object.getPrototypeOf(e)))return 1;for(var t=e;null!==Object.getPrototypeOf(t);)t=Object.getPrototypeOf(t);return e===t}}function nt(e){return "function"==typeof Array.isArray?Array.isArray(e):"array"===It(e)}function ot(e){return nt(e)&&0<e.length}function it(e){return "function"==typeof e}function at(e){return "filelist"===It(e)}function st(e){return "string"==typeof e&&(e=e[0],!/[^a-zA-Z0-9]/.test(e))}function rt(e,t,n,o){if(!mt(e)||!mt(t))return 0;for(var i,a=0,s=Object.keys(t),r=0,c=s.length;r<c;r++)if(i=s[r],!(A(t[i])||n&&n.includes(i)))if(mt(e[i])&&mt(t[i]))a+=rt(e[i],t[i],n,o);else {if(o&&o.includes(t[i]))continue;e[i]!==t[i]&&(e[i]=t[i],a+=1);}return a}function ct(e,t){var n,o=new Map,i=N(e.entries());try{for(i.s();!(n=i.n()).done;){var a=m(n.value,2),s=a[0],r=a[1];r&&o.set(s,t?JSON.stringify(r):JSON.parse(JSON.stringify(r)));}}catch(e){i.e(e);}finally{i.f();}return o}function ut(e){if(0===e.length)return 0;for(var t=0,n=0,o="undefined"!=typeof document&&void 0!==document.characterSet?document.characterSet:"UTF-8";void 0!==e[t];)n+=e[t++].charCodeAt[t]<=255?1:!1===o?3:2;return n}function lt(e){return e=e||99999999,Math.round(Math.random()*e)}function dt(){for(var e="",t=32;0<t;--t)e+=Mt[Math.floor(Math.random()*yt)];return e}function pt(e,t){for(var n in e)if(e[n]===t)return 1}function _t(e){return -1===e.indexOf("http://")||-1===e.indexOf("https://")?"https://"+e:e.replace(/https|http/,"https")}function ht(e){if(0===Object.getOwnPropertyNames(e).length)return Object.create(null);var t,n,o=Array.isArray(e)?[]:Object.create(null);for(n in e)null!==e[n]?void 0!==e[n]?(t=r(e[n]),0<=["string","number","function","boolean"].indexOf(t)?o[n]=e[n]:o[n]=ht(e[n])):o[n]=void 0:o[n]=null;return o}var gt=["url"],ft=function(e){return "string"==typeof e},A=function(e){return void 0===e},mt=function(e){return nt(e)||$e(e)},vt=function(e){return e instanceof Error},It=function(e){return Object.prototype.toString.call(e).match(/^\[object (.*)\]$/)[1].toLowerCase()},Mt=(Date.now||(Date.now=function(){return (new Date).getTime()}),"0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ"),yt=Mt.length,Ct={};function Tt(o,e){if(!nt(o)||!nt(e))return !1;var i=!1;return e.forEach(function(e){var t=e.key,e=e.value,n=o.find(function(e){return e.key===t});n?n.value!==e&&(n.value=e,i=!0):(o.push({key:t,value:e}),i=!0);}),i}function Dt(e){return Je(e)?[]:e.filter(function(e){return !0===e.isModified})}function Et(e){return Je(e)?[]:e.filter(function(e){return !1===e.isModified})}function Lt(e){return e===R.GRP_AVCHATROOM}function St(e){var t=e.type,e=e.groupID;return t===R.GRP_COMMUNITY||"".concat(e).startsWith("@TGS#_")&&!"".concat(e).includes(We)}function kt(e){return "".concat(e).startsWith("@TGS#_")&&"".concat(e).includes(We)}function Rt(e){return ft(e)&&e.slice(0,3)===R.CONV_C2C}function At(e){return ft(e)&&e.slice(0,5)===R.CONV_GROUP}function Ot(e){return ft(e)&&e===R.CONV_SYSTEM}function Nt(t,n){var o={};return Object.keys(t).forEach(function(e){o[e]=n(t[e],e);}),o}function Gt(o){return re?Promise.resolve({width:0,height:0}):ae?new Promise(function(t,e){ue.getImageInfo({src:o,success:function(e){t({width:e.width,height:e.height});},fail:function(){t({width:0,height:0});}});}):fe&&9===me?Promise.resolve({width:0,height:0}):new Promise(function(e,t){var n=new Image;n.onload=function(){e({width:this.width,height:this.height}),n=null;},n.onerror=function(){e({width:0,height:0}),n=null;},n.src=o;})}function Pt(){function e(){return (65536*(1+Math.random())|0).toString(16).substring(1)}return "".concat(e()+e()).concat(e()).concat(e()).concat(e()).concat(e()).concat(e()).concat(e())}function Ut(){var e=he?"android":pe?"ios":Ie?"windows":Me?"mac":"unknown";if(ae)try{var t=ue.getSystemInfoSync().platform;void 0!==t&&(e=t);}catch(e){}return e}function bt(e,t){e=e.split("."),t=t.split(".");for(var n=Math.max(e.length,t.length);e.length<n;)e.push("0");for(;t.length<n;)t.push("0");for(var o=0;o<n;o++){var i=parseInt(e[o]),a=parseInt(t[o]);if(a<i)return 1;if(i<a)return -1}return 0}function wt(e){var t=e.originUrl,t=void 0===t?void 0:t,n=e.originWidth,o=e.originHeight,e=e.min,e=void 0===e?198:e,n=parseInt(n),o=parseInt(o),i={url:void 0,width:0,height:0};return (n<=o?n:o)<=e?(i.url=t,i.width=n,i.height=o):(o<=n?(i.width=Math.ceil(n*e/o),i.height=e):(i.width=e,i.height=Math.ceil(o*e/n)),o=t&&-1<t.indexOf("?")?"".concat(t,"&"):"".concat(t,"?"),i.url="".concat(o,198===e?"imageView2/3/w/198/h/198":"imageView2/3/w/720/h/720")),A(t)?(i.url,g(i,gt)):i}function Ft(e){var t=e[2];e[2]=e[1],e[1]=t;for(var n=0;n<e.length;n++)e[n].setType(n);}function qt(e){e=e.servcmd;return e.slice(e.indexOf(".")+1)}function xt(e,t){return Math.round(Number(e)*Math.pow(10,t))/Math.pow(10,t)}function Vt(e,t){return e.includes(t)}function Ht(e,t){return e.includes(t)}function Bt(e){return e.split(We)[0]}var Kt=function(e,t,n){if(A(t))return "";switch(e){case R.MSG_TEXT:return t.text;case R.MSG_IMAGE:return n?"[Image]":"[图片]";case R.MSG_LOCATION:return n?"[Location]":"[位置]";case R.MSG_AUDIO:return n?"[Voice]":"[语音]";case R.MSG_VIDEO:return n?"[Video]":"[视频]";case R.MSG_FILE:return n?"[File]":"[文件]";case R.MSG_CUSTOM:return n?"[Custom Messages]":"[自定义消息]";case R.MSG_GRP_TIP:return n?"[Group Notification]":"[群提示消息]";case R.MSG_GRP_SYS_NOTICE:return n?"[Group System Message]":"[群系统通知]";case R.MSG_FACE:return n?"[Animated Sticker]":"[动画表情]";case R.MSG_MERGER:return n?"[Chat Record]":"[聊天记录]";default:return ""}};function Yt(e){return e===R.MSG_TEXT||e===R.MSG_CUSTOM||e===R.MSG_LOCATION||e===R.MSG_FACE}function Wt(e){var t=[];if(!ft(e))return t;var n=e.length;if(0===n)return t;for(var o=n-1;0<=o;o--)"1"===e[o]&&t.push(Math.pow(2,n-o-1));return t}function jt(){return !fe&&!ae}function Jt(e){return "the length of userIDList cannot exceed ".concat(e)}function zt(e){var t;if(nt(e)&&0!==e.length)return t=0,e.forEach(function(e){t+=e;}),t.toFixed(0)}function Xt(e){var t;if(nt(e)&&0!==e.length)return t=0,e.forEach(function(e){t+=e;}),(t/e.length).toFixed(0)}function Zt(e,t,n){var t=!(1<arguments.length&&void 0!==t)||t,n=!(2<arguments.length&&void 0!==n)||n,o=Date.now();return t?n?"".concat(o-e," ms"):"".concat(Math.round((o-e)/1e3)," s"):n?o-e:Math.round((o-e)/1e3)}function Qt(e){return e&&1<e?!0:!1}function $t(e,t,n,o){if(void 0===t)return 1;var i,a,s=!0;return t.required&&Je(e)&&(v.e("[".concat(n,'] Missing required params: "').concat(o,'".')),s=!1),Je(e)||(i=It(e))!==(a=t.type.toLowerCase())&&("asyncfunction"===i&&"function"===a||(v.e("[".concat(n,'] Invalid params: type check failed for "').concat(o,'". Expected ').concat(t.type,".")),s=!1)),t.validator&&!t.validator(e,n,o)&&(v.e("[".concat(n,'] Invalid params: custom validator check failed for "').concat(o,'".')),s=!1),s}function en(e){return !!e&&(!!(Rt(e)||At(e)||Ot(e))||((e=qn("InvalidConversationID",e))&&v.w(e),!1))}function s(e){""!==e.desc&&""!==qn("API_REFER")&&v.w("[".concat(e.api,"] | ").concat(e.paramName," | ").concat(e.desc,", ").concat(qn("API_REFER")).concat(e.api));}function tn(){return qn("StringRequiredLog")}function nn(e){return qn("NonEmptyStringRequiredLog",e)}function on(){return qn("NumberRequiredLog")}function an(){return qn("UndefinedNotAllowedLog")}function sn(){return qn("FileRequiredLog")}function rn(){return qn("FunctionRequiredLog")}function cn(){return qn("ArrayRequiredLog")}function un(){return qn("NonEmptyArrayLog")}function ln(){return qn("CallbackMissingLog")}function dn(){return qn("PositiveIntegerRequiredLog")}function pn(e,t){return qn("StringNotLongerThanLog",e,t)}function _n(e,t){return qn("NumberGreaterThanLog",e,t)}function hn(e,t){return qn("NumberGreaterOrEqualLog",e,t)}function gn(e){return qn("KeyValueStringRequiredLog",e)}function fn(){return qn("PlainObjectRequiredLog")}function mn(){return qn("NonEmptyContentRequiredLog")}function vn(){return qn("FileNotSelectedLog")}function In(){return qn("MessageInstanceRequiredLog")}function Mn(){return qn("NonAnonymousFunctionLog")}function yn(){return qn("MessageExtensionNotAvailableLog")}function Cn(){return qn("MessageReactionRequiredLog")}function Tn(e,t){return qn("ContainsUnsupportedTypeLog",e,t)}function Dn(e,t,n,o){var i=o.allowUndefined,a=o.allowEmpty,o=o.maxLength;return A(e)?!!i||(s({api:t,paramName:n,desc:an()}),!1):nt(e)?!(0===e.length&&(s({api:t,paramName:n,desc:un()}),!a)||o&&e.length>o&&(s({api:t,paramName:n,desc:qn("MaximumArrayLengthLog",n,o)}),1)):(s({api:t,paramName:n,desc:cn()}),!1)}function En(e,t,n,o){var i=o.allowUndefined,a=o.min,o=o.max;return A(e)?!!i||(s({api:t,paramName:n,desc:an()}),!1):Qe(e)?Qe(a)&&e<a?(s({api:t,paramName:n,desc:0===a?hn(n,a):_n(n,a-1)}),!1):!(Qe(o)&&o<e&&(s({api:t,paramName:n,desc:qn("MaximumNumberLog",n,o)}),1)):(s({api:t,paramName:n,desc:on()}),!1)}function Ln(e){return {code:0,data:e||{}}}function Sn(e){return Promise.resolve(Ln(e))}function C(e){var t=1<arguments.length&&void 0!==arguments[1]&&arguments[1];if(e instanceof Hn)return t&&null!==Bn&&Bn.emit(G.ERROR,e),Promise.reject(e);if(e instanceof Error)return n=new Hn({code:T.UNCAUGHT_ERROR}),t&&null!==Bn&&Bn.emit(G.ERROR,n),Promise.reject(n);if(A(e)||A(e.code))return Promise.reject(new Hn({code:T.UNCAUGHT_ERROR}));var n=new Hn(e);return t&&null!==Bn&&Bn.emit(G.ERROR,n),Promise.reject(n)}var kn,Rn="unSend",An="success",On="fail",Nn="notStart",Gn="pending",Pn="resolved",Un="rejected",oe={type:"String",required:!0},se={type:"Array",required:!0},te={type:"Object",required:!0},bn={type:"Boolean",required:!0},wn={type:"number",required:!0},Fn={keywordListForMsg:{type:"Array",required:!1,validator:function(e,t,n){return Dn(e,t,n,{allowUndefined:!0,allowEmpty:!0,maxLength:5})}},keywordListExceptMsg:{type:"Array",required:!0,validator:function(e,t,n){return Dn(e,t,n,{allowUndefined:!1,allowEmpty:!1,maxLength:5})}},keywordListMatchType:{type:"String",required:!1,validator:function(e,t,n){return !e||"or"===e||"and"===e||s({api:t,paramName:n,desc:"".concat(e," is invalid match type")})}},cursor:{type:"String",required:!1},count:{type:"Number",required:!1,validator:function(e,t,n){return En(e,t,n,{allowUndefined:!0,min:1,max:100})}},groupTypeList:{type:"Array",required:!1,validator:function(e,t,n){if(!e)return !0;if(!Dn(e,t,n,{allowUndefined:!0,allowEmpty:!0}))return !1;var o=[R.GRP_PUBLIC,R.GRP_COMMUNITY,R.GRP_WORK,R.GRP_MEETING];return !(0<e.filter(function(e){return -1===o.indexOf(e)}).length&&(s({api:t,paramName:n,desc:Tn(n,"group")}),1))}}},qn=null,xn={hookGetAPITips:function(e){qn=e;},login:{userID:oe,userSig:oe},addToBlacklist:{userIDList:se},removeFromBlacklist:{userIDList:se},on:[{name:"eventName",type:"String",validator:function(e,t,n){return "string"==typeof e&&0!==e.length||(s({api:t,paramName:n,desc:nn(n)}),!1)}},{name:"handler",type:"Function",validator:function(e,t,n){return "function"!=typeof e?(s({api:t,paramName:n,desc:rn()}),!1):(""===e.name&&s({api:t,paramName:n,desc:Mn()}),!0)}}],once:[{name:"eventName",type:"String",validator:function(e,t,n){return "string"==typeof e&&0!==e.length||(s({api:t,paramName:n,desc:nn(n)}),!1)}},{name:"handler",type:"Function",validator:function(e,t,n){return "function"!=typeof e?(s({api:t,paramName:n,desc:rn()}),!1):(""===e.name&&s({api:t,paramName:n,desc:Mn()}),!0)}}],off:[{name:"eventName",type:"String",validator:function(e,t,n){return "string"==typeof e&&0!==e.length||(s({api:t,paramName:n,desc:nn(n)}),!1)}},{name:"handler",type:"Function",validator:function(e,t,n){return "function"!=typeof e?(s({api:t,paramName:n,desc:rn()}),!1):(""===e.name&&s({api:t,paramName:n,desc:Mn()}),!0)}}],sendMessage:[y({name:"message"},te)],setMessageExtensions:[y(y({name:"message"},te),{},{validator:function(e,t,n){return e.status===An&&!0===e.isSupportExtension||(s({api:t,paramName:n,desc:yn()}),!1)}}),y({name:"extensions"},se)],getMessageExtensions:[y(y({name:"message"},te),{},{validator:function(e,t,n){return e.status===An&&!0===e.isSupportExtension||(s({api:t,paramName:n,desc:yn()}),!1)}})],deleteMessageExtensions:[y(y({name:"message"},te),{},{validator:function(e,t,n){return e.status===An&&!0===e.isSupportExtension||(s({api:t,paramName:n,desc:yn()}),!1)}})],addMessageReaction:[y(y({name:"message"},te),{},{validator:function(e,t,n){return e.status===An||(s({api:t,paramName:n,desc:Cn()}),!1)}}),y({name:"reactionID"},oe)],removeMessageReaction:[y(y({name:"message"},te),{},{validator:function(e,t,n){return e.status===An||(s({api:t,paramName:n,desc:Cn()}),!1)}}),y({name:"reactionID"},oe)],getMessageReactions:{messageList:y({},se)},getAllUserListOfMessageReaction:{message:y(y({},te),{},{validator:function(e,t,n){return e.status===An||(s({api:t,paramName:n,desc:Cn()}),!1)}}),reactionID:y({},oe),nextSeq:{type:"Number"},count:{type:"Number"}},getMessageList:{conversationID:y(y({},oe),{},{validator:en}),nextReqMessageID:{type:"String"},count:{type:"Number",validator:function(e,t,n){return !(!A(e)&&!/^[1-9][0-9]*$/.test(e)&&(s({api:t,paramName:n,desc:dn()}),1))}}},getMessageListHopping:{conversationID:y(y({},oe),{},{validator:en}),sequence:{type:"Number"},time:{type:"Number"},direction:{type:"Number",validator:function(e,t,n){return !(!A(e)&&0!==e&&1!==e&&(s({api:t,paramName:n,desc:qn("0Or1RequiredLog")}),1))}},count:{type:"Number",validator:function(e,t,n){return !(!A(e)&&!/^[1-9][0-9]*$/.test(e)&&(s({api:t,paramName:n,desc:dn}),1))}}},setMessageRead:{conversationID:y(y({},oe),{},{validator:en})},setAllMessageRead:{scope:{type:"String",required:!1,validator:function(e,t,n){return !e||-1!==[R.READ_ALL_C2C_MSG,R.READ_ALL_GROUP_MSG,R.READ_ALL_MSG].indexOf(e)||(s({api:t,paramName:n,desc:qn("ValidScopeRequired")}),!1)}}},getConversationProfile:[y(y({name:"conversationID"},oe),{},{validator:en})],clearHistoryMessage:[y(y({name:"conversationID"},oe),{},{validator:en})],pinConversation:{conversationID:y(y({},oe),{},{validator:en}),isPinned:y({},bn)},setConversationDraft:{conversationID:y(y({},oe),{},{validator:en}),draftText:{type:"String",validator:function(e,t,n){return !!ft(e)||(s({api:t,paramName:n,desc:tn()}),!1)}}},setConversationCustomData:{conversationIDList:y({},se),customData:{type:"String",validator:function(e,t,n){return ft(e)?!(256<e.length&&(s({api:t,paramName:n,desc:pn(n,256)}),1)):(s({api:t,paramName:n,desc:tn()}),!1)}}},markConversation:{conversationIDList:y({},se),markType:{type:"number",validator:function(e,t,n){return Qe(e)?e<=0?(s({api:t,paramName:n,desc:_n(n,0)}),!1):!(e>=Math.pow(2,64)&&(s({api:t,paramName:n,desc:qn("NumberLessThanLog",n,"Math.pow(2,64)")}),1)):(s({api:t,paramName:n,desc:on()}),!1)}},enableMark:y({},bn)},createConversationGroup:{conversationIDList:y({},se),groupName:y(y({},oe),{},{validator:function(e,t,n){return !(!e||32<e.length&&(s({api:t,paramName:n,desc:pn(n,32)}),1))}})},deleteConversationGroup:[y({name:"groupName"},oe)],renameConversationGroup:{oldName:y({},oe),newName:y(y({},oe),{},{validator:function(e,t,n){return !(!e||32<e.length&&(s({api:t,paramName:n,desc:pn(n,32)}),1))}})},addConversationsToGroup:{conversationIDList:y({},se),groupName:y({},oe)},deleteConversationsFromGroup:{conversationIDList:y({},se),groupName:y({},oe)},getGroupList:{groupProfileFilter:{type:"Array"}},getGroupProfile:{groupID:oe,groupCustomFieldFilter:{type:"Array"},memberCustomFieldFilter:{type:"Array"}},getGroupProfileAdvance:{groupIDList:se},createGroup:{name:oe},joinGroup:{groupID:oe,type:{type:"String"},applyMessage:{type:"String"}},quitGroup:[y({name:"groupID"},oe)],handleApplication:{message:te,handleAction:oe,handleMessage:{type:"String"}},changeGroupOwner:{groupID:oe,newOwnerID:oe},updateGroupProfile:{groupID:oe,muteAllMembers:{type:"Boolean"}},dismissGroup:[y({name:"groupID"},oe)],searchGroupByID:[y({name:"groupID"},oe)],getGroupOnlineMemberCount:[y({name:"groupID"},oe)],initGroupAttributes:{groupID:oe,groupAttributes:y(y({},te),{},{validator:function(t,n,o){var i=!0;return Object.keys(t).forEach(function(e){if(!ft(t[e]))return s({api:n,paramName:o,desc:gn("value")}),i=!1}),i}})},setGroupAttributes:{groupID:oe,groupAttributes:y(y({},te),{},{validator:function(t,n,o){var i=!0;return Object.keys(t).forEach(function(e){if(!ft(t[e]))return s({api:n,paramName:o,desc:gn("value")}),i=!1}),i}})},deleteGroupAttributes:{groupID:oe,keyList:{type:"Array",validator:function(e,t,n){return A(e)||!nt(e)?(s({api:t,paramName:n,desc:cn()}),!1):!!Je(e)||(o=!0,e.forEach(function(e){if(!ft(e))return s({api:t,paramName:n,desc:qn("StringArrayRequiredLog")}),o=!1}),o);var o;}}},getGroupAttributes:{groupID:oe,keyList:{type:"Array",validator:function(e,t,n){return A(e)||!nt(e)?(s({api:t,paramName:n,desc:cn()}),!1):!!Je(e)||(o=!0,e.forEach(function(e){if(!ft(e))return s({api:t,paramName:n,desc:gn("key")}),o=!1}),o);var o;}}},setGroupCounters:{groupID:oe,counters:te},increaseGroupCounter:{groupID:oe,key:oe,value:wn},decreaseGroupCounter:{groupID:oe,key:oe,value:wn},getGroupCounters:{groupID:oe},getGroupMemberList:{groupID:oe,count:{type:"Number"}},getGroupMemberProfile:{groupID:oe,userIDList:se,memberCustomFieldFilter:{type:"Array"}},addGroupMember:{groupID:oe,userIDList:se},setGroupMemberRole:{groupID:oe,userID:oe,role:oe},setGroupMemberMuteTime:{groupID:oe,userID:oe,muteTime:{type:"Number",validator:function(e){return 0<=e}}},setGroupMemberNameCard:{groupID:oe,userID:{type:"String"},nameCard:{type:"String",validator:function(e,t,n){return ft(e)?(e.length,!0):(s({api:t,paramName:n,desc:tn()}),!1)}}},setGroupMemberCustomField:{groupID:oe,userID:{type:"String"},memberCustomField:se},deleteGroupMember:{groupID:oe},markGroupMemberList:{groupID:oe,markType:{type:"number",validator:function(e,t,n){return Qe(e)?!(e<1e3&&(s({api:t,paramName:n,desc:hn(n,1e3)}),1)):(s({api:t,paramName:n,desc:on()}),!1)}},userIDList:y({},se),enableMark:y({},bn)},createTextMessage:{to:oe,conversationType:oe,payload:y(y({},te),{},{validator:function(e,t,n){return et(e)?ft(e.text)?0!==e.text.length||(s({api:t,paramName:"payload.text",desc:mn()}),!1):(s({api:t,paramName:"payload.text",desc:tn()}),!1):(s({api:t,paramName:n,desc:fn()}),!1)}})},createTextAtMessage:{to:oe,conversationType:oe,payload:y(y({},te),{},{validator:function(e,t,n){return et(e)?ft(e.text)?0===e.text.length?(s({api:t,paramName:"payload.text",desc:mn()}),!1):!(e.atUserList&&!nt(e.atUserList)&&(s({api:t,paramName:"payload.atUserList",desc:cn()}),1)):(s({api:t,paramName:"payload.text",desc:tn()}),!1):(s({api:t,paramName:n,desc:fn()}),!1)}})},createCustomMessage:{to:oe,conversationType:oe,payload:y(y({},te),{},{validator:function(e,t,n){return et(e)?e.data&&!ft(e.data)?(s({api:t,paramName:"payload.data",desc:tn()}),!1):e.description&&!ft(e.description)?(s({api:t,paramName:"payload.description",desc:tn()}),!1):!(e.extension&&!ft(e.extension)&&(s({api:t,paramName:"payload.extension",desc:tn()}),1)):(s({api:t,paramName:"payload",desc:fn()}),!1)}})},createImageMessage:{to:oe,conversationType:oe,payload:y(y({},te),{},{validator:function(e,t,n){if(!et(e))return s({api:t,paramName:n,desc:fn()}),!1;if(A(e.file))return s({api:t,paramName:"payload.file",desc:an()}),!1;if(ce){if(!(e.file instanceof HTMLInputElement||Ze(e.file)))return et(e.file)&&"undefined"!=typeof uni?0!==e.file.tempFilePaths.length&&0!==e.file.tempFiles.length||(s({api:t,paramName:"payload.file",desc:vn()}),!1):(s({api:t,paramName:"payload.file",desc:sn()}),!1);if(e.file instanceof HTMLInputElement&&0===e.file.files.length)return s({api:t,paramName:"payload.file",desc:vn()}),!1}return !0},onProgress:{type:"Function",required:!1,validator:function(e,t,n){return A(e)&&s({api:t,paramName:n,desc:ln()}),!0}}})},createAudioMessage:{to:oe,conversationType:oe,payload:y(y({},te),{},{validator:function(e,t,n){return !!et(e)||(s({api:t,paramName:n,desc:fn()}),!1)}}),onProgress:{type:"Function",required:!1,validator:function(e,t,n){return A(e)&&s({api:t,paramName:n,desc:ln()}),!0}}},createVideoMessage:{to:oe,conversationType:oe,payload:y(y({},te),{},{validator:function(e,t,n){if(!et(e))return s({api:t,paramName:n,desc:fn()}),!1;if(A(e.file))return s({api:t,paramName:"payload.file",desc:an()}),!1;if(ce){if(!(e.file instanceof HTMLInputElement||Ze(e.file)))return et(e.file)&&"undefined"!=typeof uni?!!Ze(e.file.tempFile)||(s({api:t,paramName:"payload.file",desc:vn()}),!1):(s({api:t,paramName:"payload.file",desc:sn()}),!1);if(e.file instanceof HTMLInputElement&&0===e.file.files.length)return s({api:t,paramName:"payload.file",desc:vn()}),!1}return !0}}),onProgress:{type:"Function",required:!1,validator:function(e,t,n){return A(e)&&s({api:t,paramName:n,desc:ln()}),!0}}},createFaceMessage:{to:oe,conversationType:oe,payload:y(y({},te),{},{validator:function(e,t,n){return et(e)?Qe(e.index)?!!ft(e.data)||(s({api:t,paramName:"payload.data",desc:tn()}),!1):(s({api:t,paramName:"payload.index",desc:on()}),!1):(s({api:t,paramName:n,desc:fn()}),!1)}})},createFileMessage:{to:oe,conversationType:oe,payload:y(y({},te),{},{validator:function(e,t,n){if(!et(e))return s({api:t,paramName:n,desc:fn()}),!1;if(A(e.file))return s({api:t,paramName:"payload.file",desc:an()}),!1;if(ce){if(!(e.file instanceof HTMLInputElement||Ze(e.file)))return et(e.file)&&"undefined"!=typeof uni?0!==e.file.tempFilePaths.length&&0!==e.file.tempFiles.length||(s({api:t,paramName:"payload.file",desc:vn()}),!1):(s({api:t,paramName:"payload.file",desc:sn()}),!1);if(e.file instanceof HTMLInputElement&&0===e.file.files.length)return s({api:t,paramName:"payload.file",desc:vn()}),!1}return !0}}),onProgress:{type:"Function",required:!1,validator:function(e,t,n){return A(e)&&s({api:t,paramName:n,desc:ln()}),!0}}},createLocationMessage:{to:oe,conversationType:oe,payload:y(y({},te),{},{validator:function(e,t,n){return et(e)?ft(e.description)?Qe(e.longitude)?!!Qe(e.latitude)||(s({api:t,paramName:"payload.latitude",desc:on()}),!1):(s({api:t,paramName:"payload.longitude",desc:on()}),!1):(s({api:t,paramName:"payload.description",desc:tn()}),!1):(s({api:t,paramName:n,desc:fn()}),!1)}})},createMergerMessage:{to:oe,conversationType:oe,payload:y(y({},te),{},{validator:function(e,t,n){if(Je(e.messageList))return s({api:t,paramName:"payload.messageList",desc:un()}),!1;if(Je(e.compatibleText))return s({api:t,paramName:"payload.compatibleText",desc:nn("compatibleText")}),!1;var o=!1;return e.messageList.forEach(function(e){e.status===On&&(o=!0);}),!o||(s({api:t,paramName:"payload.messageList",desc:qn("MergeFailedMessageLog")}),!1)}})},revokeMessage:[y(y({name:"message"},te),{},{validator:function(e,t,n){return Je(e)?(s({api:t,paramName:n,desc:In()}),!1):e.conversationType===R.CONV_SYSTEM?(s({api:t,paramName:n,desc:qn("MessageCanBeRevokedDesc")}),!1):!0!==e.isRevoked||(s({api:t,paramName:n,desc:qn("MessageRevokedLog")}),!1)}})],deleteMessage:[y(y({name:"messageList"},se),{},{validator:function(e,t,n){return !Je(e)||(s({api:t,paramName:n,desc:un()}),!1)}})],translateText:{sourceTextList:se,sourceLanguage:oe,targetLanguage:oe},convertVoiceToText:{message:y(y({},te),{},{validator:function(e,t,n){return Je(e)?(s({api:t,paramName:n,desc:In()}),!1):e.type===R.MSG_AUDIO&&e.status===An||(s({api:t,paramName:n,desc:qn("AudioMessageRequiredLog")}),!1)}})},modifyMessage:[y(y({name:"message"},te),{},{validator:function(e,t,n){return Je(e)?(s({api:t,paramName:n,desc:In()}),!1):e.conversationType===R.CONV_SYSTEM?(s({api:t,paramName:n,desc:qn("MessageCanBeModifiedLog")}),!1):!0!==e._onlineOnlyFlag||(s({api:t,paramName:n,desc:qn("OnlineMessageNotSupportLog")}),!1)}})],searchCloudMessages:{keywordList:Fn.keywordListForMsg,keywordListMatchType:Fn.keywordListMatchType,cursor:Fn.cursor,senderUserIDList:{type:"Array",required:!1,validator:function(e,t,n){return Dn(e,t,n,{allowUndefined:!0,allowEmpty:!0,maxLength:5})}},messageTypeList:{type:"Array",required:!1,validator:function(e,t,n){if(!e)return !0;if(!Dn(e,t,n,{allowUndefined:!0,allowEmpty:!0}))return !1;var o=[R.MSG_TEXT,R.MSG_IMAGE,R.MSG_AUDIO,R.MSG_FILE,R.MSG_VIDEO,R.MSG_LOCATION,R.MSG_CUSTOM,R.MSG_MERGER];return !(0<e.filter(function(e){return -1===o.indexOf(e)}).length&&(s({api:t,paramName:n,desc:Tn(n,"message")}),1))}},conversationID:{type:"String",required:!1,validator:function(e){return !e||en(e)}},timePosition:{type:"number",required:!1,validator:function(e,t,n){return En(e,t,n,{allowUndefined:!0,min:0})}},timePeriod:{type:"number",required:!1,validator:function(e,t,n){return En(e,t,n,{allowUndefined:!0,min:0})}}},searchCloudUsers:{keywordList:Fn.keywordListExceptMsg,keywordListMatchType:Fn.keywordListMatchType,cursor:Fn.cursor,count:Fn.count,miniBirthday:{type:"Number",required:!1,validator:function(e,t,n){return En(e,t,n,{allowUndefined:!0,min:0})}},maxBirthday:{type:"Number",required:!1,validator:function(e,t,n){return En(e,t,n,{allowUndefined:!0,min:0})}},gender:{type:"String",required:!1,validator:function(e,t,n){return !e||e===R.GENDER_FEMALE||e===R.GENDER_MALE||s({api:t,paramName:n,desc:"".concat(e," is invalid match type")})}}},searchCloudGroups:{keywordList:Fn.keywordListExceptMsg,keywordListMatchType:Fn.keywordListMatchType,cursor:Fn.cursor,count:Fn.count,groupTypeList:Fn.groupTypeList},searchCloudGroupMembers:{keywordList:Fn.keywordListExceptMsg,keywordListMatchType:Fn.keywordListMatchType,cursor:Fn.cursor,count:Fn.count,groupTypeList:Fn.groupTypeList,groupIDList:{type:"Array",required:!1,validator:function(e,t,n){return Dn(e,t,n,{allowUndefined:!0,allowEmpty:!0})}}},getUserProfile:{userIDList:{type:"Array",validator:function(e,t,n){return nt(e)?(0===e.length&&s({api:t,paramName:n,desc:un()}),!0):(s({api:t,paramName:n,desc:cn()}),!1)}}},updateMyProfile:{profileCustomField:{type:"Array",validator:function(e,t,n){return !!A(e)||!!nt(e)||(s({api:t,paramName:n,desc:cn()}),!1)}}},setSelfStatus:{customStatus:{type:"String",validator:function(e,t,n){return !!ft(e)||(s({api:t,paramName:n,desc:tn()}),!1)}}},getUserStatus:{userIDList:{type:"Array",validator:function(e,t,n){return nt(e)?0!==e.length||(s({api:t,paramName:n,desc:un()}),!1):(s({api:t,paramName:n,desc:cn()}),!1)}}},subscribeUserStatus:{userIDList:{type:"Array",validator:function(e,t,n){return nt(e)?0!==e.length||(s({api:t,paramName:n,desc:un()}),!1):(s({api:t,paramName:n,desc:cn()}),!1)}}},unsubscribeUserStatus:{userIDList:{type:"Array",validator:function(e,t,n){return !e||!!nt(e)||(s({api:t,paramName:n,desc:cn()}),!1)}}},addFriend:{to:oe,source:{type:"String",required:!0,validator:function(e,t,n){return !(!e||(e.startsWith("AddSource_Type_")?8<e.replace("AddSource_Type_","").length&&(s({api:t,paramName:n,desc:pn("keyword",8)}),1):(s({api:t,paramName:n,desc:qn("SourcePrefixLog")}),1)))}},remark:{type:"String",required:!1,validator:function(e,t,n){return !(ft(e)&&96<e.length&&(s({api:t,paramName:n,desc:pn(n,96)}),1))}}},deleteFriend:{userIDList:se},checkFriend:{userIDList:se},getFriendProfile:{userIDList:se},updateFriend:{userID:oe,remark:{type:"String",required:!1,validator:function(e,t,n){return !(ft(e)&&96<e.length&&(s({api:t,paramName:n,desc:pn(n,96)}),1))}},friendCustomField:{type:"Array",required:!1,validator:function(e,t,n){if(e){if(!nt(e))return s({api:t,paramName:n,desc:cn()}),!1;var o=!0;return e.forEach(function(e){return ft(e.key)&&-1!==e.key.indexOf("Tag_SNS_Custom")?ft(e.value)?8<e.key.replace("Tag_SNS_Custom_","").length?(s({api:t,paramName:n,desc:pn("keyword",8)}),o=!1):void 0:(s({api:t,paramName:n,desc:gn("value")}),o=!1):(s({api:t,paramName:n,desc:qn("FriendCustomFieldPrefixLog")}),o=!1)}),o}return !0}}},acceptFriendApplication:{userID:oe},refuseFriendApplication:{userID:oe},deleteFriendApplication:{userID:oe},createFriendGroup:{name:oe},deleteFriendGroup:{name:oe},addToFriendGroup:{name:oe,userIDList:se},removeFromFriendGroup:{name:oe,userIDList:se},renameFriendGroup:{oldName:oe,newName:oe},sendMessageReadReceipt:[{name:"messageList",type:"Array",validator:function(e,t,n){return nt(e)?0!==e.length||(s({api:t,paramName:n,desc:un()}),!1):(s({api:t,paramName:n,desc:cn()}),!1)}}],getMessageReadReceiptList:[{name:"messageList",type:"Array",validator:function(e,t,n){return nt(e)?0!==e.length||(s({api:t,paramName:n,desc:un()}),!1):(s({api:t,paramName:n,desc:cn()}),!1)}}],createTopicInCommunity:{groupID:oe,topicName:oe},deleteTopicFromCommunity:{groupID:oe,topicIDList:{type:"Array",validator:function(e,t,n){return !e||!!nt(e)||(s({api:t,paramName:n,desc:cn()}),!1)}}},updateTopicProfile:{groupID:oe,topicID:oe},getTopicList:{groupID:oe,topicIDList:{type:"Array",validator:function(e,t,n){return !e||!!nt(e)||(s({api:t,paramName:n,desc:cn()}),!1)}}},followUser:[y({name:"userIDList"},se)],unfollowUser:[y({name:"userIDList"},se)],getMyFollowingList:[y(y({name:"startIndex"},oe),{},{required:!1})],getMyFollowersList:[y(y({name:"startIndex"},oe),{},{required:!1})],getMutualFollowersList:[y(y({name:"startIndex"},oe),{},{required:!1})],getUserFollowInfo:[y(y({name:"userIDList"},se),{},{required:!1})],checkFollowType:[y({name:"userIDList"},se)],addSignalingListener:[{name:"eventName",type:"String",validator:function(e,t,n){return "string"==typeof e&&0!==e.length||(s({api:t,paramName:n,desc:nn(n)}),!1)}},{name:"handler",type:"Function",validator:function(e,t,n){return "function"!=typeof e?(s({api:t,paramName:n,desc:rn()}),!1):(""===e.name&&s({api:t,paramName:n,desc:Mn()}),!0)}}],removeSignalingListener:[{name:"eventName",type:"String",validator:function(e,t,n){return "string"==typeof e&&0!==e.length||(s({api:t,paramName:n,desc:nn(n)}),!1)}},{name:"handler",type:"Function",validator:function(e,t,n){return "function"!=typeof e?(s({api:t,paramName:n,desc:rn()}),!1):(""===e.name&&s({api:t,paramName:n,desc:Mn()}),!0)}}],invite:{userID:oe},inviteSync:[y(y({},te),{},{validator:function(e,t,n){return et(e)?!!ft(e.userID)||(s({api:t,paramName:"options.userID",desc:tn()}),!1):(s({api:t,paramName:"options",desc:fn()}),!1)}}),{name:"successCb",type:"Function",required:!1,validator:function(e,t,n){return A(e)&&s({api:t,paramName:n,desc:rn()}),!0}},{name:"errorCb",type:"Function",required:!1,validator:function(e,t,n){return A(e)&&s({api:t,paramName:n,desc:rn()}),!0}}],inviteInGroup:{groupID:oe,inviteeList:se},inviteInGroupSync:[y(y({},te),{},{validator:function(e,t,n){return et(e)?ft(e.groupID)?!!nt(e.inviteeList)||(s({api:t,paramName:"options.inviteeList",desc:cn()}),!1):(s({api:t,paramName:"options.groupID",desc:tn()}),!1):(s({api:t,paramName:"options",desc:fn()}),!1)}}),{name:"successCb",type:"Function",required:!1,validator:function(e,t,n){return A(e)&&s({api:t,paramName:n,desc:rn()}),!0}},{name:"errorCb",type:"Function",required:!1,validator:function(e,t,n){return A(e)&&s({api:t,paramName:n,desc:rn()}),!0}}],accept:{inviteID:oe},reject:{inviteID:oe},getSignalingInfo:[y(y({name:"message"},te),{},{validator:function(e,t,n){return !Je(e)||(s({api:t,paramName:n,desc:In()}),!1)}})],modifyInvitation:{inviteID:oe,data:oe}},Vn={login:1,logout:1,getLoginUser:1,getServerTime:1,on:1,once:1,off:1,setLogLevel:1,registerPlugin:1,destroy:1,isReady:1,createTextMessage:1,createTextAtMessage:1,createImageMessage:1,createAudioMessage:1,createVideoMessage:1,createCustomMessage:1,createFaceMessage:1,createFileMessage:1,createLocationMessage:1,createMergerMessage:1,downloadMergerMessage:1,createForwardMessage:1,sendMessage:1,resendMessage:1,revokeMessage:1,deleteMessage:1,translateText:1,convertVoiceToText:1,modifyMessage:1,sendMessageReadReceipt:1,getGroupMessageReadMemberList:1,getMessageReadReceiptList:1,setMessageExtensions:1,getMessageExtensions:1,deleteMessageExtensions:1,addMessageReaction:1,removeMessageReaction:1,getMessageReactions:1,getAllUserListOfMessageReaction:1,getMessageList:1,findMessage:1,getMessageListHopping:1,setMessageRead:1,setAllMessageRead:1,getConversationList:1,getConversationProfile:1,deleteConversation:1,setConversationDraft:1,pinConversation:1,getTotalUnreadMessageCount:1,setConversationCustomData:1,markConversation:1,createConversationGroup:1,getConversationGroupList:1,deleteConversationGroup:1,renameConversationGroup:1,addConversationsToGroup:1,deleteConversationsFromGroup:1,clearHistoryMessage:1,setMessageRemindType:1,setAllReceiveMessageOpt:1,getAllReceiveMessageOpt:1,getGroupList:1,getGroupProfile:1,createGroup:1,joinGroup:1,updateGroupProfile:1,quitGroup:1,dismissGroup:1,changeGroupOwner:1,searchGroupByID:1,getGroupApplicationList:1,handleGroupApplication:1,initGroupAttributes:1,setGroupAttributes:1,deleteGroupAttributes:1,getGroupAttributes:1,setGroupCounters:1,increaseGroupCounter:1,decreaseGroupCounter:1,getGroupCounters:1,getJoinedCommunityList:1,createTopicInCommunity:1,deleteTopicFromCommunity:1,updateTopicProfile:1,getTopicList:1,getGroupMemberProfile:1,getGroupMemberList:1,addGroupMember:1,deleteGroupMember:1,setGroupMemberNameCard:1,setGroupMemberMuteTime:1,setGroupMemberRole:1,setGroupMemberCustomField:1,getGroupOnlineMemberCount:1,markGroupMemberList:1,getMyProfile:1,getUserProfile:1,updateMyProfile:1,setSelfStatus:1,getUserStatus:1,subscribeUserStatus:1,unsubscribeUserStatus:1,getBlacklist:1,addToBlacklist:1,removeFromBlacklist:1,searchCloudMessages:1,searchCloudUsers:1,searchCloudGroups:1,searchCloudGroupMembers:1,getFriendList:1,addFriend:1,deleteFriend:1,checkFriend:1,updateFriend:1,getFriendProfile:1,getFriendApplicationList:1,refuseFriendApplication:1,deleteFriendApplication:1,acceptFriendApplication:1,setFriendApplicationRead:1,getFriendGroupList:1,createFriendGroup:1,renameFriendGroup:1,deleteFriendGroup:1,addToFriendGroup:1,removeFromFriendGroup:1,followUser:1,unfollowUser:1,getMyFollowingList:1,getMyFollowersList:1,getMutualFollowersList:1,getUserFollowInfo:1,checkFollowType:1,callExperimentalAPI:1,addSignalingListener:1,removeSignalingListener:1,invite:1,inviteSync:1,inviteInGroup:1,inviteInGroupSync:1,cancel:1,accept:1,reject:1,getSignalingInfo:1,modifyInvitation:1},Hn=(t(co,n(Error)),kn=f(co),e(co)),T={NO_SDKAPPID:2e3,NO_ACCOUNT_TYPE:2001,NO_IDENTIFIER:2002,NO_USERSIG:2003,NO_TINYID:2022,NO_A2KEY:2023,USER_NOT_LOGGED_IN:2024,REPEAT_LOGIN:2025,COS_UNDETECTED:2040,COS_GET_SIG_FAIL:2041,MSG_SEND_FAIL:2100,MSG_SEND_FAIL_NOT_IN_AV:2101,MSG_INSTANCE_REQUIRED:2105,MSG_INVALID_CONV_TYPE:2106,MSG_F_IS_EMPTY:2108,MSG_ONPROGRESS_ERR:2109,MSG_REVOKE_FAIL:2110,MSG_DELETE_FAIL:2111,MSG_UNREAD_ALL_FAIL:2112,READ_RECEIPT_MSG_LIST_EMPTY:2114,MSG_SEND_GRP_WITH_TOPIC_FAIL:2115,CANNOT_DELETE_GRP_SYSTEM_NOTICE:2116,TRANSLATE_TEXT_FAIL:2117,VOICE_TO_TEXT_FAIL:2118,UNSUPPORTED_VOICE_FORMAT:2119,MSG_I_SELECT_F_FIRST:2251,MSG_I_TYPES_LIMIT:2252,MSG_I_SIZE_LIMIT:2253,MSG_A_UPLOAD_FAIL:2300,MSG_A_SIZE_LIMIT:2301,MSG_V_UPLOAD_FAIL:2350,MSG_V_SIZE_LIMIT:2351,MSG_V_TYPES_LIMIT:2352,MSG_F_UPLOAD_FAIL:2400,MSG_F_SELECT_F_FIRST:2401,MSG_F_SIZE_LIMIT:2402,MSG_F_URL_IS_EMPTY:2403,MSG_MERGER_TYPE_INVALID:2450,MSG_MERGER_KEY_INVALID:2451,MSG_MERGER_DOWNLOAD_FAIL:2452,MSG_FORWARD_TYPE_INVALID:2453,MSG_FORWARD_INVALID_ELEMENTS:2454,MSG_MODIFY_CONFLICT:2480,MSG_MODIFY_DISABLED_IN_AV:2481,CONV_NOT_FOUND:2500,USER_OR_GRP_NOT_FOUND:2501,CONV_UN_RECORDED_TYPE:2502,INVALID_CONV_ID:2503,ILLEGAL_GRP_TYPE:2600,ILLEGAL_GRP_ID:2602,CANNOT_FIND_GRP:2603,CANNOT_CHANGE_OWNER_IN_AV:2620,CANNOT_CHANGE_OWNER_TO_SELF:2621,MEMBER_NOT_IN_GRP:2623,JOIN_GRP_FAIL:2660,CANNOT_ADD_MEMBER_IN_AV:2661,CANNOT_JOIN_NON_AV_WITHOUT_LOGIN:2662,NOT_OWNER:2681,INVALID_MEMBER_ROLE:2683,CANNOT_SET_SELF_MEMBER_ROLE:2684,CANNOT_MUTE_SELF:2685,BAN_DURATION_INVALID:2686,OPERATION_NOT_SUPPORTED_IN_AV:2687,NOT_MY_FRIEND:2700,ALREADY_MY_FRIEND:2701,FRIEND_GRP_EXISTED:2710,FRIEND_GRP_NOT_EXIST:2711,FRIEND_APPLICATION_NOT_EXIST:2716,UPDATE_PROFILE_INVALID_PARAM:2721,UPDATE_PROFILE_NO_KEY:2722,CANNOT_ADD_SELF_TO_BLACKLIST:2742,NETWORK_ERROR:2800,NETWORK_TIMEOUT:2801,NO_NETWORK:2805,UNCAUGHT_ERROR:2903,INVALID_OPERATION:2905,INVALID_TRTC_CMD:2995,OVER_FREQUENCY_LIMIT:2996,NO_PROTOCOL:2997,NO_MODULE:2998,SDK_IS_NOT_READY:2999,LOGGING_IN:3e3,LOGIN_FAILED:3001,KICKED_OUT_MULT_DEVICE:3002,KICKED_OUT_MULT_ACCOUNT:3003,KICKED_OUT_USERSIG_EXPIRED:3004,LOGGED_OUT:3005,KICKED_OUT_REST_API:3006,ILLEGAL_TOPIC_ID:3021,NO_USE:3122,PROFANITY_FOUND:3123,OPTIONS_IS_EMPTY:3153,MSG_A2KEY_EXPIRED:20002,ACCOUNT_A2KEY_EXPIRED:70001,HELLO_ANSWER_KICKED_OUT:1002,OPEN_SERVICE_OVERLOAD_ERROR:60022,SIGNALING_INVALID_INVITE_ID:8010,SIGNALING_NO_PERMISSION:8011,SIGNALING_ALREADY_EXISTS:8012,INVALID_CANCEL_MESSAGE:8020,MSG_SEARCH_CURSOR_INVALID:27002,MSG_SEARCH_CURSOR_EXPIRED:27003,CLOUD_SEARCH_UNAVAILABLE:60020,CLOUD_SEARCH_OVER_FREQUENCY_LIMIT:60018},Bn=null,wn=(e(ro,[{key:"isLoggedIn",value:function(){return this._m.get(12).isLoggedIn()}},{key:"isOversea",value:function(){return this._m.get(12).isOversea()}},{key:"isPrivateNetWork",value:function(){var e=this._m.get(12);return e.isPrivateNetWork()&&!e.getFileDownloadProxy()}},{key:"getFileDownloadProxy",value:function(){return this._m.get(12).getFileDownloadProxy()}},{key:"getDowloadFileAuthKey",value:function(){return this._m.get(12).getDowloadFileAuthKey()}},{key:"getMyUserID",value:function(){return this._m.get(12).getUserID()}},{key:"getMyTinyID",value:function(){return this._m.get(12).getTinyID()}},{key:"getSDKAppID",value:function(){return this._m.get(12).getSDKAppID()}},{key:"isIntl",value:function(){return this._m.get(12).isIntl()}},{key:"isUsingChatCore",value:function(){return this._m.get(12).isUsingChatCore()}},{key:"isDevMode",value:function(){return this._m.get(12).isDevMode()}},{key:"get",value:function(e){return this._m.get(e)}},{key:"getPlatform",value:function(){return de}},{key:"getCloudConfig",value:function(e){return this._m.get(23).getCloudConfig(e)}},{key:"emitOEvt",value:function(e,t){this._m.getOEmitInst().emit(e,t);}},{key:"emitIEvt",value:function(e,t){this._m.getIEmitInst().emit(e,t);}},{key:"getIEmitInst",value:function(){return this._m.getIEmitInst()}},{key:"req",value:function(e){return this._m.get(20).req(e)}},{key:"canIUse",value:function(e){return this._m.get(27).canIUse(e)}},{key:"getErrMsg",value:function(e,t,n){return this._m.getErrMsg(e,t,n)}},{key:"warn",value:function(e,t,n){e=this.getErrMsg(e,t,n);e&&v.w(e);}},{key:"noUse",value:function(e){var t=T.NO_USE;return C({code:t,message:this.getErrMsg(t,e)})}}]),ro),I={LOGIN:"wslogin",LOGOUT:"wslogout",HELLO:"wshello",KICK_OTHER:"KickOther",SYNC_UNREAD_MSG:"getmsg",SEND_C2C_MSG:"sendmsg",SEND_GRP_MSG:"send_group_msg",GET_USER_PROFILE:"portrait_get_all",UPDATE_MY_PROFILE:"portrait_set",GET_BL:"black_list_get",ADD_TO_BL:"black_list_add",RM_FROM_BL:"black_list_delete",GET_FD_LIST:"friend_get",GET_FD_PROFILE:"friend_get_specified",CHECK_FD:"friend_check",DEL_FD:"friend_delete",ADD_FD:"friend_add",UPDATE_FD:"friend_update",RESPOND_FD_APPLICATION:"friend_response",GET_FD_APPLICATION_LIST:"pendency_get",DEL_FD_APPLICATION:"pendency_delete",REFUSE_FD_APPLICATION:"pendency_refuse",REPORT_FD_APPLICATION:"pendency_report",GET_FD_GRP_LIST:"group_get",CREATE_FD_GRP:"group_add",DEL_FD_GRP:"group_delete",UPDATE_FD_GRP:"group_update",REVOKE_C2C_MSG:"msgwithdraw",SET_C2C_MSG_READ:"msgreaded",SET_C2C_PEER_MUTE_NOTIFICATIONS:"set_c2c_peer_mute_notifications",GET_C2C_PEER_MUTE_NOTIFICATIONS:"get_c2c_peer_mute_notifications",GET_C2C_ROAMING_MSG:"getroammsg",GET_C2C_PEER_READ_TIME:"get_peer_read_time",DEL_C2C_MSG:"delete_c2c_msg_ramble",MODIFY_C2C_MSG:"modify_c2c_msg",MODIFY_C2C_MSG_EXT:"set_key_values",GET_C2C_MSG_EXT:"get_key_values",ADD_C2C_MSG_REACTION:"reaction_add",RM_C2C_MSG_REACTION:"reaction_del",GET_C2C_MSG_REACTIONS:"reaction_multi_stat",GET_C2C_MSG_REACTION_USER_LIST:"reaction_iterate",PAGING_GET_CONV_LIST:"page_get",DEL_CONV:"batch_delete",CLEAR_HISTORY_MSG:"clear_msg",PIN_CONV:"top",DEL_GROUP_AT_TIPS:"deletemsg",SET_CONV_CUSTOM_DATA:"set_conv_custom_data",MARK_CONV:"mark_contact",CREATE_CONV_GRP:"create_contact_group",DEL_CONV_GRP:"del_contact_group",RENAME_CONV_GRP:"update_contact_group",ADD_CONV_TO_GRP:"add_conv_to_group",DEL_CONV_FROM_GRP:"del_conv_from_group",GET_CONV_GRP_LIST:"get_contact_group",SEARCH_CONV_GRP_MARK:"search_contact_group",GET_GRP_LIST:"get_joined_group_list",GET_GRP_PROFILE:"get_group_self_member_info",CREATE_GRP:"create_group",DISMISS_GRP:"destroy_group",UPDATE_GRP_PROFILE:"modify_group_base_info",APPLY_JOIN_GRP:"apply_join_group",APPLY_JOIN_GRP_NOAUTH:"apply_join_group_noauth",QUIT_GRP:"quit_group",SEARCH_GRP:"get_group_public_info",CHANGE_GRP_OWNER:"change_group_owner",HANDLE_GRP_APPLICATION:"handle_apply_join_group",HANDLE_INVITE_JOIN_GRP:"handle_invite_join_permission_group",HANDLE_GRP_INVITATION:"handle_invite_join_group",REVOKE_GRP_MSG:"group_msg_recall",SET_GRP_MSG_READ:"msg_read_report",SET_ALL_MSG_READ:"read_all_unread_msg",GET_GRP_ROAMING_MSG:"group_msg_get",GET_READ_RECEIPT:"get_group_msg_receipt",SEND_READ_RECEIPT:"group_msg_receipt",SEND_C2C_READ_RECEIPT:"c2c_msg_read_receipt",GET_READ_RECEIPT_DETAIL:"get_group_msg_receipt_detail",GET_GRP_PENDENCY:"get_pendency",DEL_GRP_SYSTEM_NOTICE:"deletemsg",AV_POLLING:"get_msg",AV_NOAUTH_POLLING:"get_msg_noauth",GET_ONLINE_MBR_NUM:"get_online_member_num",DEL_GRP_MSG:"delete_group_ramble_msg_by_seq",MODIFY_GRP_MSG:"modify_group_msg",SET_GRP_ATTR:"set_group_attr",MODIFY_GRP_ATTR:"modify_group_attr",DEL_GRP_ATTR:"delete_group_attr",CLEAR_GRP_ATTR:"clear_group_attr",GET_GRP_ATTR:"get_group_attr",MODIFY_GRP_MSG_EXT:"group_set_key_values",GET_GRP_MSG_EXT:"group_get_key_values",GET_GRP_NOTIFY:"batch_get_group_notify",UPDATE_GRP_COUNTER:"update_group_counter",GET_GRP_COUNTER:"get_group_counter",ADD_GRP_MSG_REACTION:"group_reaction_add",RM_GRP_MSG_REACTION:"group_reaction_del",GET_GRP_MSG_REACTIONS:"group_reaction_multi_stat",GET_GRP_MSG_REACTION_USER_LIST:"group_reaction_iterate",GET_GRP_MBR_LIST:"get_group_member_info",GET_AV_MBR_LIST:"get_members",GET_GRP_MBR_PROFILE:"get_specified_group_member_info",ADD_GRP_MBR:"add_group_member",DEL_GRP_MBR:"delete_group_member",BAN_AV_MBR:"ban_group_member",MODIFY_GRP_MBR_INFO:"modify_group_member_info",MARK_AV_MBR_INFO:"modify_user_info",COS_SIGN:"cos",COS_PRE_SIG:"pre_sig",SIMPLE_COS_PRE_SIG:"simple_sig",GET_IMAGE_INFO:"get_imageinfo",GET_IP:"get_final_ip",VIDEO_COVER:"video_cover",SSO_STAT:"tim_web_report_v2",PING:"alive",MSG_PUSH:"msg_push",CS:"query",GRP_CS:"query_grp",MBR_CS:"query_grp_member",USER_CS:"query_user",MULTI_MSG_PUSH:"multi_msg_push_ws",MSG_PUSH_ACK:"ws_msg_push_ack",STATUS_FORCE_OFFLINE:"stat_forceoffline",UPLOAD_MERGER_MSG:"save_relay_json_msg",DOWNLOAD_MERGER_MSG:"get_relay_json_msg",FETCH_CLOUD_CTRL_CONFIG:"fetch_config",PUSHED_CLOUD_CTRL_CONFIG:"push_configv2",FETCH_COMMERCIAL_CONFIG:"fetch_imsdk_purchase_bitsv2",PUSHED_COMMERCIAL_CONFIG:"push_imsdk_purchase_bitsv2",OVERLOAD_NOTIFY:"notify2",CREATE_TOPIC:"create_topic",DEL_TOPIC:"destroy_topic",UPDATE_TOPIC_PROFILE:"modify_topic",GET_TOPIC_LIST:"get_topic",SET_SELF_STATUS:"ws_set_custom_status",GET_USER_STATUS:"ws_get_user_status",SUB_USER_STATUS:"ws_status_subscribe",UNSUB_USER_STATUS:"ws_status_unsubscribe",STAT_BACKGROUND:"ws_stat_background",STAT_FOREGROUND:"ws_stat_foreground",SET_TOKEN:"ws_stat_settoken",PUSH_REPORT:"uniapp_sdk_report",GET_PROFANITY_LIST:"get_local_words",TRANSLATE_TEXT:"ws_batch_trans_text",VOICE_TO_TEXT:"ws_sentence_recognition",FOLLOW:"follow_add",UNFOLLOW:"follow_delete",GET_FOLLOW:"follow_get",GET_FOLLOW_INFO:"follow_get_info",CHECK_FOLLOW_TYPE:"follow_check",SET_ALL_RECEIVE_MSG_OPT:"ws_set_do_not_disturb",GET_ALL_RECEIVE_MSG_OPT:"ws_get_do_not_disturb"},Kn="networkRTT",Yn="messageE2EDelay",Wn="sendMessageC2C",jn="sendMessageGroup",Jn="sendMessageGroupAV",zn="sendMessageRichMedia",Xn="cosUpload",Zn="messageReceivedGroup",Qn="messageReceivedGroupAVPush",$n="messageReceivedGroupAVPull",eo=(c(bn={},Kn,2),c(bn,Yn,3),c(bn,Wn,4),c(bn,jn,5),c(bn,Jn,6),c(bn,zn,7),c(bn,Zn,8),c(bn,Qn,9),c(bn,$n,10),c(bn,Xn,11),bn),to={info:4,warning:5,error:6},no={wifi:1,"2g":2,"3g":3,"4g":4,"5g":5,unknown:6,none:7,online:8},oo={login:4,plugin_search:16,plugin_translate:16,plugin_voice_to_text:16,plugin_cs:16,plugin_push:16,plugin_bot:16,plugin_emoji_reaction:16,tui_key_features:16},M=(e(so,[{key:"updateTimeStamp",value:function(){this.timestamp=Pe();}},{key:"start",value:function(e){return this._startts=e,this}},{key:"end",value:function(){var e,t=this,n=0<arguments.length&&void 0!==arguments[0]&&arguments[0];this._sentFlag||(this._netMonitorModule&&(e=this._netMonitorModule.getNetworkType(),this.setNetworkType(e)),e=Pe(),0===this.costTime&&(this.costTime=e-this._startts),this.setMoreMessage("startts:".concat(this._startts," endts:").concat(e)),n?(this._sentFlag=!0,this._eventStatModule&&this._eventStatModule.pushIn(this)):setTimeout(function(){t._sentFlag=!0,t._eventStatModule&&t._eventStatModule.pushIn(t);},0));}},{key:"setError",value:function(e){if(!(e instanceof Error))return v.w("".concat(this._n,".setError value not instanceof Error, please check!")),this;if(this._sentFlag)return this;var t=!0;return (t=this._netMonitorModule?this._netMonitorModule.isOnline():t)?(e.code&&this.setCode(e.code),e.message&&this.setMoreMessage(e.message)):this.setCode(T.NO_NETWORK),this.setLevel("error"),this}},{key:"setCode",value:function(e){return A(e)||this._sentFlag||("ECONNABORTED"===e&&(this.code=103),Qe(e)?this.code=e:v.w("".concat(this._n,".setCode value not a number, please check!"),e,r(e))),this}},{key:"setMessage",value:function(e){return A(e)||this._sentFlag||(Qe(e)&&(this.message=e.toString()),ft(e)&&(this.message=e)),this}},{key:"setCostTime",value:function(e){return this.costTime=e,this}},{key:"setLevel",value:function(e){return A(e)||this._sentFlag||(this.level=to[e]),this}},{key:"setMoreMessage",value:function(e){return Je(this.moreMessage)?this.moreMessage="".concat(e):this.moreMessage+=" ".concat(e),this}},{key:"setNetworkType",value:function(e){return A(e)?v.w("".concat(this._n,".setNetworkType value is undefined, please check!")):(e=no[e.toLowerCase()],A(e)||(this.networkType=e)),this}},{key:"getStartTs",value:function(){return this._startts}},{key:"setUIPlatform",value:function(e){return this.uiPlatform=e,this}},{key:"setExtension",value:function(e){return this.extension=e,this}},{key:"setEventType",value:function(e){return this.eventType=e,this}}],[{key:"bindEventStatModule",value:function(e){so.prototype._eventStatModule=e;}},{key:"bindNetMonitorModule",value:function(e){so.prototype._netMonitorModule=e;}}]),so),io=(e(ao,[{key:"setText",value:function(e){this.content.text=e;}},{key:"sendable",value:function(){return 0!==this.content.text.length}}]),ao);function ao(e){d(this,ao),this.type=R.MSG_TEXT,this.content={text:e.text||""};}function so(e){d(this,so),this._n="SSOLogData",this.eventType=oo[e]||0,this.timestamp=0,this.networkType=8,this.code=0,this.message="",this.moreMessage="",this.extension=e,this.costTime=0,this.duplicate=!1,this.level=4,this.uiPlatform=void 0,this._sentFlag=!1,this._startts=Pe();}function ro(e){d(this,ro),this._m=e,this._n="";}function co(e){d(this,co),t=kn.call(this);var t,n=e.code,o=e.message,e=e.data;return t.code=n,o?t.message=o:t._getErrMsg&&(t.message=t._getErrMsg(t.code)),t.data=e||{},t}function uo(e,t,n,o){var i,o=3<arguments.length&&void 0!==o?o:[];if(e)return i=e,t&&(e.startsWith("http://")?i=e.replace(/^http:\/\/[^/]+/,t):e.startsWith("https://")&&(i=e.replace(/^https:\/\/[^/]+/,t))),n&&-1===i.indexOf("authKey=")&&_o(i,o)?(-1<i.indexOf("?")?"".concat(i,"&authKey="):"".concat(i,"?authKey=")).concat(n):i}function lo(e,t,n){var n=2<arguments.length&&void 0!==n?n:[];return e===R.MSG_VIDEO?_o((t[0].content||t[0].payload).snapshotUrl,n)&&(t[0].content?(t[0].content.snapshotUrl=po(t[0].content.snapshotUrl),t[0].content.thumbUrl=po(t[0].content.thumbUrl)):(t[0].payload.snapshotUrl=po(t[0].payload.snapshotUrl),t[0].payload.thumbUrl=po(t[0].payload.thumbUrl))):e===R.MSG_FILE?_o((t[0].content||t[0].payload).fileUrl,n)&&(t[0].content?t[0].content.fileUrl=po(t[0].content.fileUrl):t[0].payload.fileUrl=po(t[0].payload.fileUrl)):e===R.MSG_MERGER&&(e=(n=t[0].content||t[0].payload).downloadKey,n=void 0===(n=n.messageList)?[]:n,Je(void 0===e?"":e)&&n.forEach(function(e){lo(e.messageBody[0].type,e.messageBody);})),t}function po(e){if(!e)return e;if(-1===e.indexOf("authKey="))return e;for(var e=e.split("?"),t=e[1].split("&"),n=0,o=0;o<t.length;o++)if(-1<t[o].indexOf("authKey=")){n=o;break}return t.splice(n,1),0<t.length?"".concat(e[0],"?").concat(t.join("&")):e[0]}function _o(e,t){var n=!1;if(e){var e=e.match(/:\/\/([0-9]?\.)?(.[^/:]+)/),o=e&&e[2]||"";if(o.includes("rich-dev"))return 1;for(var i=0;i<t.length;i++)if(o.endsWith(t[i])){n=!0;break}}return n}e(Vo,[{key:"_initImageInfoModel",value:function(){var t=this;this._ImageInfoModel=function(e){this.instanceID=lt(9999999),this.sizeType=e.type||0,this.type=0,this.size=e.size||0,this.width=e.width||0,this.height=e.height||0,this.imageUrl=e.imageUrl||e.url||"",this.url=uo(e.url||t._imageMemoryURL,t._fileDownloadProxy,t._authKey,t._fileDNList);},this._ImageInfoModel.prototype={setSizeType:function(e){this.sizeType=e;},setType:function(e){this.type=e;},setImageUrl:function(e){e&&(this.imageUrl=e);},getImageUrl:function(){return this.imageUrl}};}},{key:"initImageInfoArray",value:function(e){for(var t,n=0,o=null;n<=2;)t=A(e)||A(e[n])?{type:0,size:0,width:0,height:0,url:""}:e[n],(o=new this._ImageInfoModel(t)).setSizeType(n+1),o.setType(n),this.addImageInfo(o),n++;this.updateAccessSideImageInfoArray();}},{key:"updateImageInfoArray",value:function(e){for(var t,n=this.content.imageInfoArray.length,o=0;o<n;o++)t=this.content.imageInfoArray[o],e[o].size&&(t.size=e[o].size),e[o].url&&t.setImageUrl(e[o].url),e[o].width&&(t.width=e[o].width),e[o].height&&(t.height=e[o].height);}},{key:"_autoFixUrl",value:function(){for(var e=this.content.imageInfoArray.length,t="",n="",o=["http","https"],i=null,a=0;a<e;a++)this.content.imageInfoArray[a].url&&""!==(i=this.content.imageInfoArray[a]).imageUrl&&(n=i.imageUrl.slice(0,i.imageUrl.indexOf("://")+1),t=i.imageUrl.slice(i.imageUrl.indexOf("://")+1),o.indexOf(n)<0&&(n="https:"),this.content.imageInfoArray[a].setImageUrl([n,t].join("")));}},{key:"updatePercent",value:function(e){this._percent=e,1<this._percent&&(this._percent=1);}},{key:"updateImageFormat",value:function(e){this.content.imageFormat=Fe[e.toUpperCase()]||Fe.UNKNOWN;}},{key:"createImageDataASURLInWeb",value:function(e){void 0!==e&&0<e.files.length&&(this._imageMemoryURL=window.URL.createObjectURL(e.files[0]));}},{key:"createImageDataASURL",value:function(e){e&&e.url&&(this._imageMemoryURL=e.url);}},{key:"replaceImageInfo",value:function(e,t){this.content.imageInfoArray[t]instanceof this._ImageInfoModel||(this.content.imageInfoArray[t]=e);}},{key:"addImageInfo",value:function(e){3<=this.content.imageInfoArray.length||this.content.imageInfoArray.push(e);}},{key:"updateAccessSideImageInfoArray",value:function(){var e=this.content.imageInfoArray,t=e[0],n=t.width,n=void 0===n?0:n,t=t.height,t=void 0===t?0:t;0!==n&&0!==t&&(Ft(e),Object.assign(e[2],wt({originWidth:n,originHeight:t,min:720})));}},{key:"sendable",value:function(){return 0!==this.content.imageInfoArray.length&&""!==this.content.imageInfoArray[0].imageUrl&&0!==this.content.imageInfoArray[0].size}}]);var ho=Vo,go=(e(xo,[{key:"sendable",value:function(){return null!==this.content}}]),xo),fo=(e(qo,[{key:"updatePercent",value:function(e){this._percent=e,1<this._percent&&(this._percent=1);}},{key:"updateAudioUrl",value:function(e){this.content.remoteAudioUrl=e;}},{key:"sendable",value:function(){return ""!==this.content.remoteAudioUrl}}]),qo),mo={from:!0,groupID:!0,groupName:!0,to:!0},vo=(e(Fo,[{key:"_initContent",value:function(t){var n=this;Object.keys(t).forEach(function(e){switch(e){case"remarkInfo":break;case"groupProfile":n.content.groupProfile={},n._initGroupProfile(t[e]);break;case"operatorInfo":n.content.operatorInfo={},n._initOperatorInfo(t[e]);break;case"memberInfoList":case"msgMemberInfo":n._updateMemberList(t[e]);break;case"memberExtraInfo":case"onlineMemberInfo":break;case"memberNum":n.content[e]=t[e],n.content.memberCount=t[e];break;case"newGroupProfile":n.content.newGroupProfile={},n._initNewGroupProfile(t[e]);break;default:n.content[e]=t[e];}}),this.content.userIDList||(this.content.userIDList=[this.content.operatorID]);}},{key:"_initGroupProfile",value:function(e){for(var t=Object.keys(e),n=0;n<t.length;n++){var o=t[n];mo[o]&&(this.content.groupProfile[o]=e[o]);}}},{key:"_initOperatorInfo",value:function(e){for(var t=Object.keys(e),n=0;n<t.length;n++){var o=t[n];this.content.operatorInfo[o]=e[o];}}},{key:"_updateMemberList",value:function(e){Je(this.content.memberList)?this.content.memberList=e:this.content.memberList.forEach(function(t){e.forEach(function(e){t.userID===e.userID&&Object.assign(t,e);});});}},{key:"_initNewGroupProfile",value:function(e){for(var t=Object.keys(e),n=0;n<t.length;n++){var o=t[n];this.content.newGroupProfile[o]="muteAllMembers"!==o?e[o]:1===e[o];}}}]),Fo),Io={from:!0,groupID:!0,groupName:!0,to:!0,groupType:!0},Mo=(e(wo,[{key:"_initContent",value:function(t){var n=this;Object.keys(t).forEach(function(e){switch(e){case"memberInfoList":break;case"remarkInfo":n.content.handleMessage=t[e];break;case"groupProfile":n.content.groupProfile={},n._initGroupProfile(t[e]);break;default:n.content[e]=t[e];}});}},{key:"_initGroupProfile",value:function(e){for(var t=Object.keys(e),n=0;n<t.length;n++){var o=t[n];Io[o]&&("groupName"===o?this.content.groupProfile.name=e[o]:this.content.groupProfile[o]=e[o]);}}}]),wo),yo=(e(bo,[{key:"_getFileInfo",value:function(e){if(!A(e.fileName)&&!A(e.fileSize))return {size:e.fileSize,name:e.fileName};var t,e=e.file.files[0];return ne&&(e.path&&-1!==e.path.indexOf(".")&&(t=e.path.slice(e.path.lastIndexOf(".")+1).toLowerCase(),e.type=t,e.name||(e.name="".concat(lt(999999),".").concat(t))),e.name||(e.type="",e.name=e.path.slice(e.path.lastIndexOf("/")+1).toLowerCase()),e.suffix&&(e.type=e.suffix),e.url||(e.url=e.path)),{size:e.size,name:e.name}}},{key:"updatePercent",value:function(e){this._percent=e,1<this._percent&&(this._percent=1);}},{key:"updateFileUrl",value:function(e){this.content.fileUrl=e;}},{key:"sendable",value:function(){return ""!==this.content.fileUrl&&""!==this.content.fileName&&0!==this.content.fileSize}}]),bo),Co=(e(Uo,[{key:"setData",value:function(e){return this.content.data=e,this}},{key:"setDescription",value:function(e){return this.content.description=e,this}},{key:"setExtension",value:function(e){return this.content.extension=e,this}},{key:"sendable",value:function(){return 0!==this.content.data.length||0!==this.content.description.length||0!==this.content.extension.length}}]),Uo),To=(e(Po,[{key:"updatePercent",value:function(e){this._percent=e,1<this._percent&&(this._percent=1);}},{key:"updateVideoUrl",value:function(e){e&&(this.content.remoteVideoUrl=e);}},{key:"updateSnapshotInfo",value:function(e){var t=e.snapshotUrl,n=e.snapshotWidth,e=e.snapshotHeight;Je(t)||(this.content.thumbUrl=this.content.snapshotUrl=t),Je(n)||(this.content.thumbWidth=this.content.snapshotWidth=Number(n)),Je(e)||(this.content.thumbHeight=this.content.snapshotHeight=Number(e));}},{key:"sendable",value:function(){return ""!==this.content.remoteVideoUrl}}]),Po),Do=(e(Go,[{key:"sendable",value:function(){return !0}}]),Go),Eo=(e(No,[{key:"_patchRichMediaPayload",value:function(e,t){e===R.MSG_IMAGE?t.imageInfoArray.forEach(function(e){!e.imageUrl&&e.url&&(e.imageUrl=e.url,e.sizeType=e.type,1===e.type?e.type=0:3===e.type&&(e.type=1));}):e===R.MSG_VIDEO?!t.remoteVideoUrl&&t.videoUrl&&(t.remoteVideoUrl=t.videoUrl):e===R.MSG_AUDIO?!t.remoteAudioUrl&&t.url&&(t.remoteAudioUrl=t.url):e===R.MSG_FILE&&!t.fileUrl&&t.url&&(t.fileUrl=t.url,t.url=void 0);}},{key:"_updateRichMediaDownloadUrl",value:function(e,t,n,o,i){(n||o)&&(e===R.MSG_IMAGE?t.imageInfoArray.forEach(function(e){e.url=uo(e.url,n,o,i);}):e===R.MSG_VIDEO?(t.videoUrl=uo(t.videoUrl,n,o,i),t.snapshotUrl=uo(t.thumbUrl,n,o,i),t.snapshotHeight=t.thumbHeight,t.snapshotWidth=t.thumbWidth):e===R.MSG_AUDIO?t.url=uo(t.url,n,o,i):e===R.MSG_FILE&&(t.fileUrl=uo(t.fileUrl,n,o,i)));}}]),No),Lo=(e(Oo,[{key:"sendable",value:function(){return !Je(this.content.messageList)||!Je(this.content.downloadKey)}}]),Oo),So={1:R.MSG_PRIORITY_HIGH,2:R.MSG_PRIORITY_NORMAL,3:R.MSG_PRIORITY_LOW,4:R.MSG_PRIORITY_LOWEST},ko=(e(Ao,[{key:"elements",get:function(){return this._elements}},{key:"getElements",value:function(){return this._elements}},{key:"extractGroupInfo",value:function(e){null!==e&&(ft(e.nick)&&(this.nick=e.nick),ft(e.avatar)&&(this.avatar=e.avatar),e=e.messageFromAccountExtraInformation,et(e)&&ft(e.nameCard)&&(this.nameCard=e.nameCard));}},{key:"handleGroupAtInfo",value:function(e){var t=this;e.payload&&e.payload.atUserList&&e.payload.atUserList.forEach(function(e){e!==R.MSG_AT_ALL?(t._groupAtInfoList.push({groupAtAllFlag:0,groupAtUserID:e}),t.atUserList.push(e)):(t._groupAtInfoList.push({groupAtAllFlag:1}),t.atUserList.push(R.MSG_AT_ALL));}),nt(e.groupAtInfo)&&e.groupAtInfo.forEach(function(e){0===e.groupAtAllFlag?t.atUserList.push(e.groupAtUserID):1===e.groupAtAllFlag&&t.atUserList.push(R.MSG_AT_ALL);});}},{key:"getGroupAtInfoList",value:function(){return this._groupAtInfoList}},{key:"_initProxy",value:function(){this._elements[0]&&(this.payload=this._elements[0].content,this.type=this._elements[0].type);}},{key:"reInitialize",value:function(e){e&&(this.status=this.from?An:Rn,this.from||(this.from=e)),this._initFlow(e),this._initSequence(e),this._concatConversationID(e),this.generateMessageID();}},{key:"isSendable",value:function(){return 0!==this._elements.length&&(!0===this._relayFlag||"function"==typeof this._elements[0].sendable&&this._elements[0].sendable())}},{key:"_initTo",value:function(e){this.conversationType===R.CONV_GROUP&&(this.to=e.groupID);}},{key:"_initSequence",value:function(e){var t,n,o;0===this.clientSequence&&e&&(this.clientSequence=!!(e=e)&&(void 0===Ct[e]&&(o=new Date,t="3".concat(o.getHours()).slice(-2),n="0".concat(o.getMinutes()).slice(-2),o="0".concat(o.getSeconds()).slice(-2),Ct[e]=parseInt([t,n,o,"0001"].join("")),o=n=t=null,v.l("autoIncrementIndex start index:".concat(Ct[e]))),Ct[e]++)),0===this.sequence&&this.conversationType===R.CONV_C2C&&(this.sequence=this.clientSequence);}},{key:"generateMessageID",value:function(){this.from===R.CONV_SYSTEM&&(this.senderTinyID="144115198244471703"),this.ID="".concat(this.senderTinyID,"-").concat(this.clientTime,"-").concat(this.random);}},{key:"_initFlow",value:function(e){""!==e&&(e===this.from?(this.flow="out",this.isRead=!0):this.flow="in");}},{key:"_concatConversationID",value:function(e){var t=this.to,n=this.conversationType;n!==R.CONV_SYSTEM?(e=n===R.CONV_C2C?e===this.from?t:this.from:this.to,this.conversationID=e?"".concat(n).concat(e):null):this.conversationID=R.CONV_SYSTEM;}},{key:"isElement",value:function(e){return e instanceof io||e instanceof ho||e instanceof go||e instanceof fo||e instanceof yo||e instanceof To||e instanceof vo||e instanceof Mo||e instanceof Co||e instanceof Do||e instanceof Lo}},{key:"setElement",value:function(e,t,n,o){var i=this;if(this.isElement(e))return this._elements=[e],void this._initProxy();function a(e){if(e.type&&e.content)switch(e.type){case R.MSG_TEXT:i.setTextElement(e.content);break;case R.MSG_IMAGE:i.setImageElement(e.content,t,n,o);break;case R.MSG_AUDIO:i.setAudioElement(e.content,t,n,o);break;case R.MSG_FILE:i.setFileElement(e.content,t,n,o);break;case R.MSG_VIDEO:i.setVideoElement(e.content,t,n,o);break;case R.MSG_CUSTOM:i.setCustomElement(e.content);break;case R.MSG_LOCATION:i.setLocationElement(e.content);break;case R.MSG_GRP_TIP:i.setGroupTipElement(e.content);break;case R.MSG_GRP_SYS_NOTICE:i.setGroupSystemNoticeElement(e.content);break;case R.MSG_FACE:i.setFaceElement(e.content);break;case R.MSG_MERGER:i.setMergerElement(e.content,t,n,o);}}if(nt(e))for(var s=0;s<e.length;s++)a(e[s]);else a(e);this._initProxy();}},{key:"clearElement",value:function(){this._elements.length=0;}},{key:"setTextElement",value:function(e){e="string"==typeof e?e:e.text,e=new io({text:e});this._elements.push(e);}},{key:"setImageElement",value:function(e,t,n,o){e=new ho(e,t,n,o);this._elements.push(e);}},{key:"setAudioElement",value:function(e,t,n,o){e=new fo(e,t,n,o);this._elements.push(e);}},{key:"setFileElement",value:function(e,t,n,o){e=new yo(e,t,n,o);this._elements.push(e);}},{key:"setVideoElement",value:function(e,t,n,o){e=new To(e,t,n,o);this._elements.push(e);}},{key:"setLocationElement",value:function(e){e=new Do(e);this._elements.push(e);}},{key:"setCustomElement",value:function(e){e=new Co(e);this._elements.push(e);}},{key:"setGroupTipElement",value:function(e){var t,n={},o=e.operationType;Je(e.memberInfoList)?e.operatorInfo&&(n=e.operatorInfo):o!==R.GRP_TIP_MBR_JOIN&&o!==R.GRP_TIP_MBR_KICKED_OUT&&o!==R.GRP_TIP_MBR_SET_ADMIN&&o!==R.GRP_TIP_MBR_CANCELED_ADMIN||(n=e.memberInfoList[0]),Je(e.memberExtraInfo)||(t=e.memberExtraInfo.reason,e.msgMemberInfo.forEach(function(e){e.reason=t;}));o=n.nick,n=n.avatar,ft(o)&&(this.nick=o),ft(n)&&(this.avatar=n),o=new vo(e);this._elements.push(o);}},{key:"setGroupSystemNoticeElement",value:function(e){e=new Mo(e);this._elements.push(e);}},{key:"setFaceElement",value:function(e){e=new go(e);this._elements.push(e);}},{key:"setMergerElement",value:function(e,t,n,o){e=new Lo(e,t,n,o);this._elements.push(e);}},{key:"setIsRead",value:function(e){this.isRead=e;}},{key:"setRelayFlag",value:function(e){this._relayFlag=e;}},{key:"_computePriority",value:function(e){if(A(e))return R.MSG_PRIORITY_NORMAL;if(ft(e)&&-1!==Object.values(So).indexOf(e))return e;if(Qe(e)){e=""+e;if(-1!==Object.keys(So).indexOf(e))return So[e]}return R.MSG_PRIORITY_NORMAL}},{key:"setNickAndAvatar",value:function(e){var t=e.nick,e=e.avatar;ft(t)&&(this.nick=t),ft(e)&&(this.avatar=e);}},{key:"setNameCard",value:function(e){ft(e)&&(this.nameCard=e);}},{key:"initC2CReadReceiptInfo",value:function(e){var t=e.readReceiptSentByPeer,e=e.timestamp,e=void 0===e?0:e;this.conversationType===R.CONV_C2C&&!0===this.needReadReceipt&&(this.readReceiptInfo.isPeerRead=1===(void 0===t?void 0:t),this.readReceiptInfo.timestamp=e);}}]),Ao),Ro=["sound","FCMChannelID"];function Ao(e){d(this,Ao),this.ID="",this.conversationID=e.conversationID||null,this.conversationType=e.conversationType||R.CONV_C2C,this.conversationSubType=e.conversationSubType,this.time=e.time||Math.ceil(Date.now()/1e3),this.sequence=e.sequence||0,this.clientSequence=e.clientSequence||e.sequence||0,this.random=e.random||0===e.random?e.random:lt(),this.priority=this._computePriority(e.priority),this.nick=e.nick||"",this.avatar=e.avatar||"",this.isPeerRead=!1,this.nameCard="",this.hasRiskContent=Qt(e.checkResult),this._elements=[],this.isPlaceMessage=e.isPlaceMessage||0,this.isRevoked=2===e.isPlaceMessage||8===e.msgFlagBits,this.from=e.from||null,this.to=e.to||null,this.flow="",this.isSystemMessage=e.isSystemMessage||!1,this.protocol=e.protocol||"JSON",this.isResend=!1,this.isRead=!1,this.status=e.status||An,this._onlineOnlyFlag=!1,this._groupAtInfoList=[],this._relayFlag=!1,this.atUserList=[],this.cloudCustomData=e.cloudCustomData||"",this.isDeleted=!1,this.isModified=!!e.messageVersion,this._isExcludedFromUnreadCount=!(!e.messageControlInfo||1!==e.messageControlInfo.excludedFromUnreadCount),this._isExcludedFromLastMessage=!(!e.messageControlInfo||1!==e.messageControlInfo.excludedFromLastMessage),this.clientTime=e.clientTime||Oe()||0,this.senderTinyID=e.senderTinyID||e.tinyID||"",this.readReceiptInfo=e.readReceiptInfo||{readCount:void 0,unreadCount:void 0,isPeerRead:void 0,timestamp:0},this.needReadReceipt=!0===e.needReadReceipt||1===e.needReadReceipt,this.version=e.messageVersion||0,this.isBroadcastMessage=e.isBroadcastMessage||!1,this._receiverList=e.receiverList||void 0,this.isSupportExtension=!0===e.isSupportExtension||1===e.isSupportExtension,this._cmConfigID=e.customModerationConfigurationID,this.revoker=e.revokerInfo&&e.revokerInfo.revoker||"",this.revokerInfo=e.revokerInfo||{userID:"",nick:"",avatar:""},this.revokeReason=e.revokeReason||"",this.reInitialize(e.currentUser),this.extractGroupInfo(e.groupProfile||null),this.handleGroupAtInfo(e),this.initC2CReadReceiptInfo(e);}function Oo(e,t,n,l){var o,i,a,s,r,c,u;d(this,Oo),this.type=R.MSG_MERGER,this.content={downloadKey:"",pbDownloadKey:"",messageList:[],title:"",abstractList:[],compatibleText:"",version:0,layersOverLimit:!1},e.downloadKey?(i=e.downloadKey,a=e.pbDownloadKey,s=e.title,r=e.abstractList,c=e.compatibleText,o=e.version,this.content.downloadKey=i,this.content.pbDownloadKey=a,this.content.title=s,this.content.abstractList=r,this.content.compatibleText=c,this.content.version=o||0):Je(e.messageList)?1===e.layersOverLimit&&(this.content.layersOverLimit=!0):(i=e.messageList,a=e.title,s=e.abstractList,r=e.compatibleText,c=e.version,u=[],i.forEach(function(e){Je(e)||(e=new Eo(e,t,n,l),u.push(e));}),this.content.messageList=u,this.content.title=a,this.content.abstractList=s,this.content.compatibleText=r,this.content.version=c||0);}function No(e,t,n,o){var i,a;d(this,No),this.from=e.from,this.messageSender=e.from,this.time=e.time,this.messageSequence=e.sequence,this.clientSequence=e.clientSequence||e.sequence,this.messageRandom=e.random,this.cloudCustomData=e.cloudCustomData||"",this.clientTime=e.clientTime||void 0,e.ID?(this.ID=e.ID||"",this.nick=e.nick||"",this.avatar=e.avatar||"",e.messageBody?this.messageBody=JSON.parse(JSON.stringify(e.messageBody)):this.messageBody=[{type:e.type,payload:e.payload}],e.conversationType?e.conversationType.startsWith(R.CONV_C2C)?this.receiverUserID=e.to:e.conversationType.startsWith(R.CONV_GROUP)&&(this.receiverGroupID=e.to):e.receiverGroupID?this.receiverGroupID=e.receiverGroupID:e.receiverUserID&&(this.receiverUserID=e.receiverUserID),this.messageReceiver=e.to||e.messageReceiver):(this.nick=e.nick||"",this.avatar=e.avatar||"",this.messageBody=[],i=e.elements[0].type,a=e.elements[0].content,this._patchRichMediaPayload(i,a),this._updateRichMediaDownloadUrl(i,a,t,n,o),i===R.MSG_MERGER?this.messageBody.push({type:i,payload:new Lo(a,t,n,o).content}):this.messageBody.push({type:i,payload:a}),e.groupID&&(this.receiverGroupID=e.groupID,this.messageReceiver=e.groupID),e.to&&(this.receiverUserID=e.to,this.messageReceiver=e.to),this.ID="".concat(e.tinyID,"-").concat(e.clientTime,"-").concat(e.random));}function Go(e){d(this,Go),this.type=R.MSG_LOCATION;var t=e.description,n=e.longitude,e=e.latitude;this.content={description:t,longitude:n,latitude:e};}function Po(e,t,n,o){d(this,Po),this.type=R.MSG_VIDEO,this._percent=0,this.content={remoteVideoUrl:e.remoteVideoUrl||e.videoUrl||"",videoFormat:e.videoFormat,videoSecond:parseInt(e.videoSecond,10),videoSize:e.videoSize,videoUrl:uo(e.videoUrl,t,n,o),videoDownloadFlag:2,videoUUID:e.videoUUID,thumbUUID:e.thumbUUID,thumbFormat:e.thumbFormat,thumbWidth:e.thumbWidth,snapshotWidth:e.thumbWidth,thumbHeight:e.thumbHeight,snapshotHeight:e.thumbHeight,thumbSize:e.thumbSize,snapshotSize:e.thumbSize,thumbDownloadFlag:2,thumbUrl:uo(e.thumbUrl,t,n,o),snapshotUrl:uo(e.thumbUrl,t,n,o)};}function Uo(e){d(this,Uo),this.type=R.MSG_CUSTOM,this.content={data:e.data||"",description:e.description||"",extension:e.extension||""};}function bo(e,t,n,o){d(this,bo),this.type=R.MSG_FILE,this._percent=0;var i=this._getFileInfo(e);this.content={downloadFlag:2,fileUrl:uo(e.url||e.fileUrl,t,n,o)||"",uuid:e.uuid,fileName:i.name||"",fileSize:i.size||0};}function wo(e){d(this,wo),this.type=R.MSG_GRP_SYS_NOTICE,this.content={},this._initContent(e);}function Fo(e){d(this,Fo),this.type=R.MSG_GRP_TIP,this.content={},this._initContent(e);}function qo(e,t,n,o){d(this,qo),this.type=R.MSG_AUDIO,this._percent=0,this.content={downloadFlag:2,second:e.second,size:e.size,url:uo(e.url,t,n,o),remoteAudioUrl:e.url||"",uuid:e.uuid};}function xo(e){d(this,xo),this.type=R.MSG_FACE,this.content=e||null;}function Vo(e,t,n,o){d(this,Vo),this._imageMemoryURL="",this._fileDownloadProxy=t,this._authKey=n,this._fileDNList=o,ae||re?this.createImageDataASURL(e.file):this.createImageDataASURLInWeb(e.file),this._initImageInfoModel(),this.type=R.MSG_IMAGE,this._percent=0,this.content={imageFormat:e.imageFormat||Fe.UNKNOWN,uuid:e.uuid,imageInfoArray:[]},this.initImageInfoArray(e.imageInfoArray),this._autoFixUrl();}function Ho(e){if(et(e))return {pushFlag:!0===e.disablePush?1:0,title:e.title||"",desc:e.description||"",ext:e.extension||"",apnsInfo:(n=void 0===(n=(t=e).apnsInfo)?{}:n,o=t.ignoreIOSBadge,t=t.disableVoipPush,o=!0===n.ignoreIOSBadge||!0===(void 0!==o&&o)?1:0,i=void 0,A(t)||(i=!1===t?1:0),A(n.disableVoipPush)||(i=!1===n.disableVoipPush?1:0),y(y({},n),{},{badgeMode:o,isVoipPush:i})),androidInfo:(n=void 0===(n=(t=e).androidInfo)?{}:n,t=t.androidOPPOChannelID,t=n.OPPOChannelID||(void 0===t?"":t),o=void 0===(o=n.sound)?"":o,i=void 0===(i=n.FCMChannelID)?"":i,y(y({},g(n,Ro)),{},{Sound:-1===(o=(n=o).lastIndexOf("."))?n:n.slice(0,o),OPPOChannelID:t,GoogleChannelID:i}))};var t,n,o,i;}t(Jo,wn),Bo=f(Jo),e(Jo,[{key:"onNewMessage",value:function(e){var t=e.dataList,n=e.isInstantMessage,o=e.C2CRemainingUnreadList,i=e.C2CPairUnreadList,e=e.isSyncingEnded,t=(n||v.l("".concat(this._n,".onNewMessage C2CPairUnreadList:"),i,"C2CRemainingUnreadList:",o),this._assembly({dataList:t,C2CRemainingUnreadList:o,C2CPairUnreadList:i,isInstantMessage:n})),o=t.conversationOptionsList,i=t.messageList,t=t.isUnreadC2CMessage,a=Dt(i),a=(0<a.length&&this.emitOEvt(G.MESSAGE_MODIFIED,a),this.get(11).onNewMessage({conversationOptionsList:o,isInstantMessage:n,isUnreadC2CMessage:t,isSyncingEnded:e}),Et(i));n&&0<a.length&&this.emitOEvt(G.MESSAGE_RECEIVED,a),i.length=0;}},{key:"_assembly",value:function(e){for(var l=e.dataList,d=e.C2CRemainingUnreadList,n=e.C2CPairUnreadList,p=e.isInstantMessage,t=null,o=[],_=[],h={},g=this.get(26),f=!1,i=this.get(11),m=this.get(4),e=this.get(17),v=this.getFileDownloadProxy(),I=this.getDowloadFileAuthKey(),M=e.getFileDNList(),a=0,y=l.length;a<y;a++)if(this._isC2CNotice(l[a]))this._noticeFromUnreadDBList.push(l[a].eventArray[0].c2CNotifyMsgArray[0]);else {var s=l[a],r=(s.currentUser=this.getMyUserID(),s.conversationType=R.CONV_C2C,s.isSystemMessage=!!s.isSystemMessage,(A(s.nick)||A(s.avatar))&&(f=!0),(t=new ko(s)).setElement(s.elements,v,I,M),t.setNickAndAvatar({nick:s.nick,avatar:s.avatar}),t.conversationID);if(p){if(this._msgFromUnreadDBMap.get(t.ID))continue;var c,u,C=!1,T=(t.from!==this.getMyUserID()?(u=i.getLatestMessageSentByPeer(r))&&(c=u.nick,u=u.avatar,f?t.setNickAndAvatar({nick:c,avatar:u}):c===t.nick&&u===t.avatar||(C=!0)):(c=i.getLatestMessageSentByMe(r))&&(u=c.nick,T=c.avatar,u===t.nick&&T===t.avatar||(i.modifyMessageSentByMe({conversationID:r,latestNick:t.nick,latestAvatar:t.avatar}),m.mockOnNickAvatarModified(t.nick,t.avatar))),1===l[a].isModified);if(i.isMessageSentByCurrentInstance(t)?t.isModified=T:T=!1,0===s.msgLifeTime)t._onlineOnlyFlag=!0,i.isMessageSentByCurrentInstance(t)||_.push(t);else {if(!i.pushIntoMessageList(_,t,T))continue;C&&(i.modifyMessageSentByPeer({conversationID:r,latestNick:t.nick,latestAvatar:t.avatar}),i.updateUserProfileSpecifiedKey({conversationID:r,nick:t.nick,avatar:t.avatar}));}p&&0<t.clientTime&&g.addMessageDelay(t.clientTime);}else this._msgFromUnreadDBMap.set(t.ID,t);if(0!==s.msgLifeTime){if(!1===t._onlineOnlyFlag){C=i.getLastMessageTime(r);if(Qe(C)&&t.time<C)continue;p&&(A(h[r])?(s=0,"in"===t.flow&&(t._isExcludedFromUnreadCount||(s=1)),h[r]=o.push({conversationID:r,unreadCount:s,type:t.conversationType,subType:t.conversationSubType,lastMessage:t._isExcludedFromLastMessage?"":t})-1):(s=h[r],o[s].type=t.conversationType,o[s].subType=t.conversationSubType,o[s].lastMessage=t._isExcludedFromLastMessage?"":t,"in"===t.flow&&(t._isExcludedFromUnreadCount||o[s].unreadCount++)));}}else t._onlineOnlyFlag=!0;}this._handleNoticeFromUnreadDB();var D=!1;if(nt(n)&&0<n.length)for(var E=0,L=n.length;E<L;E++)!function(t){if(n[t].from===R.CONV_SYSTEM)return;D=!0;var e=o.find(function(e){return e.conversationID==="".concat(R.CONV_C2C).concat(n[t].from)});e?e.unreadCount=n[t].unreadCount:o.push({conversationID:"".concat(R.CONV_C2C).concat(n[t].from),unreadCount:n[t].unreadCount,type:R.CONV_C2C});}(E);if(nt(d))for(var S=0,k=d.length;S<k;S++)!function(t){o.find(function(e){return e.conversationID==="".concat(R.CONV_C2C).concat(d[t].from)})||o.push({conversationID:"".concat(R.CONV_C2C).concat(d[t].from),type:R.CONV_C2C,lastMsgTime:d[t].lastMsgTime});}(S);return {conversationOptionsList:o,messageList:_,isUnreadC2CMessage:D}}},{key:"getMessageListFromUnreadDB",value:function(){return D(this._msgFromUnreadDBMap.values())}},{key:"_isC2CNotice",value:function(e){e=e.eventArray;return !(!nt(e)||10!==e[0].event)}},{key:"_handleNoticeFromUnreadDB",value:function(){var t,e=this._noticeFromUnreadDBList.length;0!==e&&(v.l("".concat(this._n,"._handleNoticeFromUnreadDB count:").concat(e)),t=[],this._noticeFromUnreadDBList.forEach(function(e){e.hasOwnProperty("c2cMessageRevokedNotify")&&t.push(e);}),this.onMsgRevoked({dataList:t}),this._noticeFromUnreadDBList.length=0,t.length=0);}},{key:"onMsgRevoked",value:function(e){var a,s=this,r=this.get(11),c=[];e.dataList.forEach(function(e){e.c2cMessageRevokedNotify&&(e=e.c2cMessageRevokedNotify.revokedInfos,A(e)||e.forEach(function(e){var t=s.getMyUserID()===e.from?"".concat(R.CONV_C2C).concat(e.to):"".concat(R.CONV_C2C).concat(e.from);a=r.revoke(t,e.sequence,e.random);var n,o=e.revokerInfo&&e.revokerInfo.revoker,i=e.revokerInfo&&e.revokerInfo.reason||"";a?n=a:(n={conversationID:t,sequence:e.sequence},e.tinyID&&e.clientTime&&e.random&&(n.ID="".concat(e.tinyID,"-").concat(e.clientTime,"-").concat(e.random)),e.time&&(n.time=e.time)),n&&(n.revoker=o,n.revokeReason=i,n.revokerInfo={userID:o,nick:"",avatar:""},c.push(n));}));}),0!==c.length&&(r.onMessageRevoked(c),v.l("".concat(this._n,".onMsgRevoked count:").concat(c.length)),r.updateRevokerInfo(c).then(function(e){s.emitOEvt(G.MESSAGE_REVOKED,e);}));}},{key:"onMsgReadReceipt",value:function(e){var i=this;e.dataList.forEach(function(e){var o;Je(e.c2cMessageReadReceipt)||(o=e.c2cMessageReadReceipt.to,e.c2cMessageReadReceipt.uinPairReadArray.forEach(function(e){var e=e.peerReadTime,t=(v.l("".concat(i._n,".onMsgReadReceipt to:").concat(o," peerReadTime:").concat(e)),"".concat(R.CONV_C2C).concat(o)),n=i.get(11);n.recordPeerReadTime(t,e),n.updateMsgIsPeerReadProp(t,e);}));});}},{key:"onMsgReadNotice",value:function(e){var o=this;e.dataList.forEach(function(e){var n;Je(e.c2cMessageReadNotice)||(n=o.get(11),e.c2cMessageReadNotice.uinPairReadArray.forEach(function(e){var t=e.from,e=e.peerReadTime,t=(v.l("".concat(o._n,".onMsgReadNotice from:").concat(t," lastReadTime:").concat(e)),"".concat(R.CONV_C2C).concat(t));n.updateIsReadAfterReadReport({conversationID:t,lastMessageTime:e}),n.updateUnreadCount(t);}));});}},{key:"onMsgModified",value:function(e){v.l("".concat(this._n,".onMsgModified options:"),e);var t=this.get(11);e.dataList.forEach(function(e){t.onMessageModified(y(y({},e),{},{conversationType:R.CONV_C2C}));});}},{key:"onReadReceiptList",value:function(e){v.l("".concat(this._n,".onReadReceiptList options:"),e),this.get(11).updateReadReceiptInfo(e.dataList);}},{key:"sendMessage",value:function(e,t){e=this._createC2CMessagePack(e,t);return this.req(e)}},{key:"_createC2CMessagePack",value:function(e,t){var n=null,o=(t&&(t.offlinePushInfo&&(n=t.offlinePushInfo),!0===t.onlineUserOnly&&(n?n.disablePush=!0:n={disablePush:!0})),""),i=(ft(e.cloudCustomData)&&0<e.cloudCustomData.length&&(o=e.cloudCustomData),[]),a=(et(t)&&et(t.messageControlInfo)&&(a=(r=t.messageControlInfo).excludedFromUnreadCount,s=r.excludedFromLastMessage,r=r.excludedFromContentModeration,!0===a&&i.push("NoUnread"),!0===s&&i.push("NoLastMsg"),!0===r&&i.push("NoMsgCheck")),this.isOnlineMessage(e,t)?0:void 0),s=JSON.parse(JSON.stringify(e.getElements())),r=this.get(17).getFileDNList();return {P:I.SEND_C2C_MSG,data:{fromAccount:this.getMyUserID(),toAccount:e.to,msgBody:lo(e.type,s,r),cloudCustomData:o,msgSeq:e.sequence,msgRandom:e.random,msgLifeTime:a,nick:e.nick,avatar:e.avatar,offlinePushInfo:Ho(n),messageControlInfo:0!==a?i:void 0,clientTime:e.clientTime,needReadReceipt:!0===e.needReadReceipt?1:0,isSupportExtension:!0===e.isSupportExtension?1:0,isRelayMessage:!0===e._relayFlag?1:0,cmConfigID:e._cmConfigID}}}},{key:"isOnlineMessage",value:function(e,t){return !(!t||!0!==t.onlineUserOnly)}},{key:"revokeMessage",value:function(e){return this.req({P:I.REVOKE_C2C_MSG,data:{msgInfo:{fromAccount:e.from,toAccount:e.to,msgSeq:e.sequence,msgRandom:e.random,msgTimeStamp:e.time}}})}},{key:"deleteMessage",value:function(e){var t=e.to,e=e.keyList;return v.l("".concat(this._n,".deleteMessage toAccount:").concat(t," count:").concat(e.length)),this.req({P:I.DEL_C2C_MSG,data:{fromAccount:this.getMyUserID(),to:t,keyList:e}})}},{key:"modifyRemoteMessage",value:function(e){var t=e.from,n=e.to,o=e.version,o=void 0===o?0:o,i=e.sequence,a=e.random,s=e.time,r=e.payload,c=e.type,l=e.cloudCustomData,e=e._elements,u=void 0;return Yt(c)&&(1<e.length&&e.splice(0,1,{type:c,content:r}),u=e),this.req({P:I.MODIFY_C2C_MSG,data:{from:t,to:n,version:o,sequence:i,random:a,time:s,elements:u,cloudCustomData:l}})}},{key:"setMessageRead",value:function(e){var t=this,n=e.conversationID,o=e.lastMessageTime,i="".concat(this._n,".").concat("setMessageRead"),e="convID:".concat(n," lastMessageTime:").concat(o),a=(v.l("".concat(i," ").concat(e)),Qe(o)||this.warn("DoNotModifyLastTime"),new M("setMessageRead"));return a.setMessage(e),this.req({P:I.SET_C2C_MSG_READ,data:{C2CMsgReaded:{cookie:"",C2CMsgReadedItem:[{toAccount:n.replace("C2C",""),lastMessageTime:o,receipt:1}]}}}).then(function(){a.end(),v.l("".concat(i," ok"));var e=t.get(11);return e.updateIsReadAfterReadReport({conversationID:n,lastMessageTime:o}),e.updateUnreadCount(n),Ln()}).catch(function(e){return a.setError(e).end(),v.l("".concat(i," failed. error:"),e),C(e)})}},{key:"getRoamingMessage",value:function(e){var s=this,r="".concat(this._n,".").concat("getRoamingMessage"),t=e.peerAccount,c=e.conversationID,n=e.count,o=e.lastMessageTime,e=e.messageKey,u="peerAccount:".concat(t," count:").concat(n||15," lastMessageTime:").concat(o||0," messageKey:").concat(e),l=(v.l("".concat(r," ").concat(u)),new M("getRoamingMessage"));return this.req({P:I.GET_C2C_ROAMING_MSG,data:{peerAccount:t,count:n||15,lastMessageTime:o||0,messageKey:e}}).then(function(e){var e=e.data,t=e.complete,n=e.messageList,o=e.messageKey,e=e.lastMessageTime,i=(A(n)?v.l("".concat(r," ok. complete:").concat(t," but messageList is undefined!")):v.l("".concat(r," ok. complete:").concat(t," count:").concat(n.length)),l.setMessage("".concat(u," complete:").concat(t," length:").concat(n.length)).end(),s.get(11)),t=1===t,a=(t&&i.setCompleted(c),[]),n=i.onRoamingMessage(n,c,!0,a),o=(i.modifyMessageList(c),i.updateIsRead(c),i.updateRoamingMsgKeyAndTime(c,o,e),i.getPeerReadTime(c)),o=(v.l("".concat(r," update isPeerRead property. convID:").concat(c," peerReadTime:").concat(o)),o?i.updateMsgIsPeerReadProp(c,o):(e=c.replace(R.CONV_C2C,""),s.getRemotePeerReadTime([e]).then(function(){i.updateMsgIsPeerReadProp(c,i.getPeerReadTime(c));})),"");return 0<n.length?o=n[0].ID:(e=i.getLocalOldestMessage(c))&&(o=e.ID),v.l("".concat(r," nextReqID:").concat(o," storedMsgCount:").concat(n.length)),{nextReqID:o,storedMessageList:n,assembledMessageList:a,isPullingCompleted:t}}).catch(function(e){return l.setMessage(u).setError(e).end(),v.w("".concat(r," failed. error:"),e),C(e)})}},{key:"getRoamingMessagesHopping",value:function(e){var a=this,s="".concat(this._n,".").concat("getRoamingMessagesHopping"),t=e.peerAccount,n=e.time,n=void 0===n?0:n,o=e.count,r=e.direction,c="".concat(R.CONV_C2C).concat(t),u="peerAccount:".concat(t," count:").concat(o," time:").concat(n," direction:").concat(r),l=(v.l("".concat(s," ").concat(u)),new M("getRoamingMessagesHopping"));return this.req({P:I.GET_C2C_ROAMING_MSG,data:{peerAccount:t,count:o+1,lastMessageTime:n,direction:r}}).then(function(e){var e=e.data,t=e.complete,n=e.messageList,n=void 0===n?[]:n,e=e.lastMessageTime,o="complete:".concat(t," count:").concat(n.length),i=(v.l("".concat(s," ok. ").concat(o)),l.setMessage("".concat(u," ").concat(o)).end(),1!==t&&(1===r?n.pop():n.shift()),a.get(11)),o=i.onRoamingMessage(n,c,!1),n=(a._modifyMessageList(c,o),a._computeResult({complete:t,lastMessageTime:e,resultList:o})),t=(i.storeHoppingMessageList(n.messageList),i.getPeerReadTime(c));return v.l("".concat(s," update isPeerRead property. convID:").concat(c," peerReadTime:").concat(t)),t?i.updateMsgIsPeerReadProp(c,t):(e=c.replace(R.CONV_C2C,""),a.getRemotePeerReadTime([e]).then(function(){i.updateMsgIsPeerReadProp(c,i.getPeerReadTime(c));})),Ln(n)}).catch(function(e){return l.setMessage(u).setError(e).end(),v.w("".concat(s," failed. error:"),e),C(e)})}},{key:"_computeResult",value:function(e){var t=e.complete,t=void 0===t?0:t,n=e.lastMessageTime,e=e.resultList,e={messageList:D(void 0===e?[]:e),isCompleted:!1,nextMessageTime:""};return 1===t?e.isCompleted=!0:e.nextMessageTime=n,e}},{key:"_modifyMessageList",value:function(e,t){e=this.get(11).getLocalConversation(e);if(e)for(var n=e.userProfile.nick,o=e.userProfile.avatar,e=this.get(4).getNickAndAvatarByUserID(this.getMyUserID()),i=e.nick,a=e.avatar,s=t.length-1;0<=s;s--){var r=t[s];"in"===r.flow&&(r.nick!==n&&r.setNickAndAvatar({nick:n}),r.avatar!==o&&r.setNickAndAvatar({avatar:o})),"out"===r.flow&&(r.nick!==i&&r.setNickAndAvatar({nick:i}),r.avatar!==a&&r.setNickAndAvatar({avatar:a}));}}},{key:"getRemotePeerReadTime",value:function(a){var s=this,r="".concat(this._n,".").concat("getRemotePeerReadTime");if(Je(a))return Promise.resolve();var c=new M("getRemotePeerReadTime");return v.l("".concat(r," userIDList:").concat(a)),this.req({P:I.GET_C2C_PEER_READ_TIME,data:{userIDList:a}}).then(function(e){var t=e.data.peerReadTimeList;v.l("".concat(r," ok. peerReadTimeList:").concat(t));for(var n="",o=s.get(11),i=0;i<a.length;i++)n+="".concat(a[i],"-").concat(t[i]," "),0<t[i]&&o.recordPeerReadTime("".concat(R.CONV_C2C).concat(a[i]),t[i]);c.setMessage(n).end();}).catch(function(e){c.setError(e).end(),v.w("".concat(r," failed. error:"),e);})}},{key:"sendReadReceipt",value:function(e){var t=e[0].conversationID.replace(R.CONV_C2C,""),n=new M("sendReadReceipt"),o=(n.setMessage("peerAccount:".concat(t)),this.getMyUserID()),e=e.filter(function(e){return e.from!==o&&!0===e.needReadReceipt}).map(function(e){return {fromAccount:e.from,toAccount:e.to,sequence:e.sequence,random:e.random,time:e.time,clientTime:e.clientTime}});if(0===e.length)return C({code:T.READ_RECEIPT_MSG_LIST_EMPTY});var i="".concat(this._n,".").concat("sendReadReceipt");return v.l("".concat(i,". peerAccount:").concat(t," length:").concat(e.length)),this.req({P:I.SEND_C2C_READ_RECEIPT,data:{peerAccount:t,messageInfoList:e}}).then(function(e){return n.end(),v.l("".concat(i," ok")),Ln()}).catch(function(e){return n.setError(e).end(),v.w("".concat(i," failed. error:"),e),C(e)})}},{key:"getReadReceiptList",value:function(e){var t=e[0].conversationID.replace(R.CONV_C2C,"");return v.l("".concat(this._n,".getReadReceiptList peerAccount:").concat(t," msgCount:").concat(e.length)),Sn({messageList:e})}},{key:"getMessageExtensions",value:function(e,t){return v.l("".concat(this._n,".getMessageExtensions startSequence:").concat(t)),this.req({P:I.GET_C2C_MSG_EXT,data:{from:e.from,to:e.to,messageKey:this.getMessageKey(e),startSequence:t}})}},{key:"modifyMsgExts",value:function(e,t){var n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:1;return v.l("".concat(this._n,".modifyMsgExts operateType:").concat(n)),this.req({P:I.MODIFY_C2C_MSG_EXT,data:{from:e.from,to:e.to,messageKey:this.getMessageKey(e),extensionList:t,operateType:n}})}},{key:"getMessageKey",value:function(e){var t=e.clientSequence,n=e.random,e=e.time;return "".concat(t,"_").concat(n,"_").concat(e)}},{key:"reset",value:function(){v.l("".concat(this._n,".reset")),this._msgFromUnreadDBMap.clear(),this._noticeFromUnreadDBList.length=0;}}]);var Bo,Ko=Jo,Yo={A2KEY_AND_TINYID_UPDATED:"_inner".concat(1),CLOUD_CONFIG:"_inner".concat(2),PROFILE_UPDATED:"_inner".concat(3),CONV_SYNC_COMPLETED:"_inner".concat(4),C2C_UNREAD_HANDLE_COMPLETED:"_inner".concat(5)},Wo=(e(jo,[{key:"_onCloudConfig",value:function(){var e=this._convM.getCloudConfig("topic_msg_limit");A(e)||(this.TOPIC_MSG_LIMIT=Number(e)),v.l("".concat(this._n,"._onCloudConfig topicMsgLimit:").concat(this.TOPIC_MSG_LIMIT));}},{key:"onCheckTimer",value:function(e){if(e%20==0&&0<this._map.size){var t,n=N(this._map);try{for(n.s();!(t=n.n()).done;){var o=m(t.value,2),i=o[0],a=o[1];i.includes(We)&&a.size>=this.TOPIC_MSG_LIMIT&&this._convM.clearMemMsg(i,!0);}}catch(e){n.e(e);}finally{n.f();}}}},{key:"pushIn",value:function(e){var t=1<arguments.length&&void 0!==arguments[1]&&arguments[1],n=e.conversationID,o=!0,i=(this._map.has(n)||this._map.set(n,new Map),this._getUniqueIDOfMsg(e));if(this._map.get(n).has(i)){var a=this._map.get(n).get(i);if(!t||!0===a.isModified)return !1}return this._map.get(n).set(i,e),this._setLatestMsgSentByPeer(n,e),this._setLatestMsgSentByMe(n,e),o}},{key:"unshift",value:function(e,t){var n;if(nt(e)?0<e.length&&(n=e[0].conversationID,this._unshiftMultipleMsgs(e,t)):(n=e.conversationID,this._unshiftSingleMsg(e,t)),n){var o=Array.from(this._map.get(n).values()),e=o.length;if(0!==e){for(var i=e-1;0<=i;i--)if("out"===o[i].flow){this._setLatestMsgSentByMe(n,o[i]);break}if(n.startsWith(R.CONV_C2C))for(var a=e-1;0<=a;a--)if("in"===o[a].flow){this._setLatestMsgSentByPeer(n,o[a]);break}}}}},{key:"_unshiftSingleMsg",value:function(e,t){var n=e.conversationID,o=this._getUniqueIDOfMsg(e);if(!this._map.has(n))return this._map.set(n,new Map),this._map.get(n).set(o,e),void t.push(e);var i=this._map.get(n),a=Array.from(i);i.has(o)||(a.unshift([o,e]),this._map.set(n,new Map(a)),t.push(e));}},{key:"_unshiftMultipleMsgs",value:function(e,t){for(var n=e.length,o=[],i=e[0].conversationID,a=this._map.get(i),s=this._map.has(i)?Array.from(a):[],r=0;r<n;r++){var c=this._getUniqueIDOfMsg(e[r]);a&&a.has(c)||(o.push([c,e[r]]),t.push(e[r]));}this._map.set(i,new Map(o.concat(s)));}},{key:"remove",value:function(e){var t=e.conversationID,e=this._getUniqueIDOfMsg(e);this._map.has(t)&&this._map.get(t).delete(e);}},{key:"revoke",value:function(e,t,n){var o;return this._map.has(e)?(o=this._map.get(e),this._updateMsgIsRevoked(o,t,n)):this._hoppingMsgMap.has(e)?(o=this._hoppingMsgMap.get(e),this._updateMsgIsRevoked(o,t,n)):null}},{key:"_updateMsgIsRevoked",value:function(e,t,n){var o,i=N(e);try{for(i.s();!(o=i.n()).done;){var a=m(o.value,2)[1];if(a.sequence===t&&(A(n)||a.random===n))return a.isRevoked||(a.isRevoked=!0),a}}catch(e){i.e(e);}finally{i.f();}}},{key:"removeByConvID",value:function(e){var t=this._map.has(e);v.l("".concat(this._n,".removeByConvID convID:").concat(e," has:").concat(t)),t&&(this._map.delete(e),this._latestMsgSentByPeerMap.delete(e),this._latestMsgSentByMeMap.delete(e));}},{key:"findMessage",value:function(e){var t=null;return t=(t=this._findMsg(e,this._map))?t:this._findMsg(e,this._hoppingMsgMap)}},{key:"_findMsg",value:function(e,t){var n,o=null,i=N(t);try{for(i.s();!(n=i.n()).done;)for(var a=D(m(n.value,2)[1].values()),s=a.length,r=0;r<s;r++)if(a[r].ID===e){o=a[r];break}}catch(e){i.e(e);}finally{i.f();}return o}},{key:"updateMsgIsPeerReadProp",value:function(e,t){var n,o=[];return this._map.has(e)?(n=this._map.get(e),o=this._updateMsgIsPeerReadProp(n,t)):this._hoppingMsgMap.has(e)&&(n=this._hoppingMsgMap.get(e),o=this._updateMsgIsPeerReadProp(n,t)),v.l("".concat(this._n,".updateMsgIsPeerReadProp convID:").concat(e," peerReadTime:").concat(t," count:").concat(o.length)),o}},{key:"_updateMsgIsPeerReadProp",value:function(e,t){var n,o=[],i=N(e);try{for(i.s();!(n=i.n()).done;){var a=m(n.value,2)[1];a.time<=t&&!a.isPeerRead&&"out"===a.flow&&(a.isPeerRead=!0,o.push(a));}}catch(e){i.e(e);}finally{i.f();}return o}},{key:"updateMsgIsModifiedProp",value:function(e){var t=e.conversationID;this._map.has(t)&&(e=this._getUniqueIDOfMsg(e),(t=this._map.get(t).get(e))&&(t.isModified=!0));}},{key:"hasLocalMsgList",value:function(e){return this._map.has(e)}},{key:"getLocalMsgList",value:function(e){return this.hasLocalMsgList(e)?D(this._map.get(e).values()):[]}},{key:"getLocalMaxSeq",value:function(e){if(!this.hasLocalMsgList(e))return 0;e=D(this._map.get(e).values()).map(function(e){return e.sequence});return Math.max.apply(Math,D(e))}},{key:"getLocalMaxTime",value:function(e){if(!this.hasLocalMsgList(e))return 0;e=D(this._map.get(e).values()).map(function(e){return e.time});return Math.max.apply(Math,D(e))}},{key:"hasLocalMsg",value:function(e,t){for(var n=!1,o=this.getLocalMsgList(e),i=o.length,a=0;a<i;a++)o[a].ID===t&&(n=!0);return n}},{key:"getLocalMsg",value:function(e,t){for(var n=null,o=this.getLocalMsgList(e),i=o.length,a=0;a<i;a++)if(o[a].ID===t){n=o[a];break}return n}},{key:"getLocalLastMsg",value:function(e){e=this.getLocalMsgList(e);return e[e.length-1]}},{key:"getLocalSecondLastMsg",value:function(e){e=this.getLocalMsgList(e);return e[e.length-2]}},{key:"getLocalOldestMsg",value:function(e){return this.getLocalMsgList(e)[0]}},{key:"_setLatestMsgSentByPeer",value:function(e,t){e.startsWith(R.CONV_C2C)&&"in"===t.flow&&this._latestMsgSentByPeerMap.set(e,t);}},{key:"_setLatestMsgSentByMe",value:function(e,t){"out"===t.flow&&this._latestMsgSentByMeMap.set(e,t);}},{key:"getLatestMsgSentByPeer",value:function(e){return this._latestMsgSentByPeerMap.get(e)}},{key:"getLatestMsgSentByMe",value:function(e){return this._latestMsgSentByMeMap.get(e)}},{key:"modifyMsgSentByPeer",value:function(e){var t=e.conversationID,n=e.latestNick,o=e.latestAvatar,e=this._map.get(t);if(!Je(e)){var i=Array.from(e.values()),e=i.length;if(0!==e){for(var a=null,s=0,r=!1,c=e-1;0<=c;c--)"in"===i[c].flow&&((a=i[c]).nick!==n&&(a.setNickAndAvatar({nick:n}),r=!0),a.avatar!==o&&(a.setNickAndAvatar({avatar:o}),r=!0),r&&(s+=1));v.l("".concat(this._n,".modifyMsgSentByPeer convID:").concat(t," count:").concat(s));}}}},{key:"modifyMsgSentByMe",value:function(e){var t=e.conversationID,n=e.latestNick,o=e.latestAvatar,e=this._map.get(t);if(!Je(e)){var i=Array.from(e.values()),e=i.length;if(0!==e){for(var a=null,s=0,r=!1,c=e-1;0<=c;c--)"out"===i[c].flow&&((a=i[c]).nick!==n&&(a.setNickAndAvatar({nick:n}),r=!0),a.avatar!==o&&(a.setNickAndAvatar({avatar:o}),r=!0),r&&(s+=1));v.l("".concat(this._n,".modifyMsgSentByMe convID:").concat(t," count:").concat(s));}}}},{key:"getTopicConvIDList",value:function(t){return D(this._map.keys()).filter(function(e){return e.startsWith("".concat(R.CONV_GROUP).concat(t))})}},{key:"onMsgModified",value:function(e,t){if(!this._map.has(e)&&!this._hoppingMsgMap.has(e))return {isUpdated:!1,message:null};var n="".concat(this._n,".onMsgModified"),o=this._getUniqueIDOfMsg(t),i=this._getTargetMsg(e,o),a=!!i;return v.l("".concat(n," convID:").concat(e," uniqueID:").concat(o," has:").concat(a)),a?(e=t.messageVersion,o=t.elements,a=t.cloudCustomData,t=t.checkResult,v.l("".concat(n," localVersion:").concat(i.version," remoteVersion:").concat(e)),i.version<e?(i.version=e,i._elements=JSON.parse(JSON.stringify(o)),i.payload=i._elements[0].content,i.type=i._elements[0].type,i.cloudCustomData=a,i.isModified=!0,i.hasRiskContent=Qt(t),{isUpdated:!0,message:i}):{isUpdated:!1,message:i}):{isUpdated:!1,message:null}}},{key:"_getUniqueIDOfMsg",value:function(e){var t=e.from,n=e.to,o=e.random,i=e.sequence,e=e.time;return "".concat(t,"-").concat(n,"-").concat(o,"-").concat(i,"-").concat(e)}},{key:"_getTargetMsg",value:function(e,t){if(this._map.has(e))return this._map.get(e).get(t);var n=void 0;if(this._hoppingMsgMap.has(e))for(var o=D(this._hoppingMsgMap.get(e).values()),i=0;i<o.length;i++)if(this._getUniqueIDOfMsg(o[i])===t){n=o[i];break}return n}},{key:"storeHoppingMsgList",value:function(e){if(0!==e.length){var t=e[0].conversationID,n=e.length;this._hoppingMsgMap.has(t)||this._hoppingMsgMap.set(t,new Map);for(var o=this._hoppingMsgMap.get(t),i=0;i<n;i++){var a=e[i];o.has(a.ID)||o.set(a.ID,a);}}}},{key:"getHoppingMsg",value:function(e,t){if(this._hoppingMsgMap.has(e))return this._hoppingMsgMap.get(e).get(t)}},{key:"reset",value:function(){this._map.clear(),this._latestMsgSentByPeerMap.clear(),this._latestMsgSentByMeMap.clear(),this._hoppingMsgMap.clear();}}]),jo);function jo(e){d(this,jo),this._convM=e,this._map=new Map,this._n="MsgListHandler",this._latestMsgSentByPeerMap=new Map,this._latestMsgSentByMeMap=new Map,this._hoppingMsgMap=new Map,this.TOPIC_MSG_LIMIT=1e3,this._convM.getIEmitInst().on(Yo.CLOUD_CONFIG,this._onCloudConfig,this);}function Jo(e){return d(this,Jo),(e=Bo.call(this,e))._n="C2CModule",e._msgFromUnreadDBMap=new Map,e._noticeFromUnreadDBList=[],e}function zo(e){this.mixin(e);}zo.mixin=function(e){e=e.prototype||e;e._isReady=!1,e.ready=function(e){if(e)return this._isReady?void(1<arguments.length&&void 0!==arguments[1]&&arguments[1]?e.call(this):setTimeout(e,1)):(this._readyQueue=this._readyQueue||[],void this._readyQueue.push(e))},e.triggerReady=function(){var t=this;this._isReady=!0,setTimeout(function(){var e=t._readyQueue;t._readyQueue=[],e&&0<e.length&&e.forEach(function(e){e.call(this);},t);},1);},e.resetReady=function(){this._isReady=!1,this._readyQueue=[];},e.isReady=function(){return this._isReady};};function Xo(e,t,n){return A(e)?{lastTime:0,lastSequence:0,fromAccount:"",messageForShow:"",payload:null,type:"",isRevoked:!1,cloudCustomData:"",onlineOnlyFlag:!1,nick:"",nameCard:"",version:0,isPeerRead:!1,revoker:null}:n&&e.ID||e instanceof ko?{lastTime:e.time||0,lastSequence:e.sequence||0,fromAccount:e.from||"",messageForShow:Kt(e.type,e.payload,t),payload:e.payload||null,type:e.type||null,isRevoked:e.isRevoked||!1,cloudCustomData:e.cloudCustomData||"",onlineOnlyFlag:e._onlineOnlyFlag||!1,nick:e.nick||"",nameCard:e.nameCard||"",version:e.version||0,isPeerRead:e.isPeerRead||!1,revoker:e.revoker||null}:y(y({},e),{},{messageForShow:Kt(e.type,e.payload,t)})}function Zo(e,t){return Je(e)?{lastTime:0,lastSequence:0,fromAccount:"",payload:null,type:"",messageForShow:"",nick:"",avatar:"",version:0,cloudCustomData:"",isRevoked:!1,revoker:null}:{lastTime:e.time||0,lastSequence:e.sequence||0,fromAccount:e.from||"",payload:e.payload||null,type:e.type||"",messageForShow:Kt(e.type,e.payload,t),nick:e.nick||"",avatar:e.avatar||"",version:e.version||0,cloudCustomData:e.cloudCustomData||"",isRevoked:e.isRevoked||!1,revoker:e.revoker||null}}function Qo(e){var t=String(e).replace(/[=]+$/,""),n="";if(t.length%4==1)return "";for(var o,i,a=0,s=0;i=t.charAt(s++);~i&&(o=a%4?64*o+i:i,a++%4)&&(n+=String.fromCharCode(255&o>>(-2*a&6))))i="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".indexOf(i);try{return decodeURIComponent(escape(n))}catch(e){return ""}}var $o,ei,ti,ni,oi,ii=["jpg","jpeg","gif","png","bmp","image","webp"],ai=["mp4","quicktime","mov"],si=(e(ua,[{key:"validate",value:function(e){var t,n=!0,o="";if(Je(e))return {valid:!1,tips:"empty options"};if(e.profileCustomField)for(var i=e.profileCustomField.length,a=null,s=0;s<i;s++){if(a=e.profileCustomField[s],!ft(a.key)||-1===a.key.indexOf("Tag_Profile_Custom"))return {valid:!1,tips:"The prefix of keys of the custom profile key-value pairs (which is profileCustomField) must be Tag_Profile_Custom"};if(!ft(a.value))return {valid:!1,tips:"The type of values of the custom profile key-value pairs (which is profileCustomField) must be String"}}for(t in e)if(Object.prototype.hasOwnProperty.call(e,t)){if("profileCustomField"===t)continue;if(Je(e[t])&&!ft(e[t])&&!Qe(e[t])){o="key:"+t+", invalid value:"+e[t],n=!1;continue}switch(t){case"nick":ft(e[t])||(n=!(o="nick must be a string")),500<ut(e[t])&&(o="nick name limited: must less than or equal to ".concat(500," bytes, current size: ").concat(ut(e[t])," bytes"),n=!1);break;case"gender":pt(Ve,e.gender)||(o="key:gender, invalid value:"+e.gender,n=!1);break;case"birthday":Qe(e.birthday)||(n=!(o="birthday must be a number"));break;case"location":ft(e.location)||(n=!(o="location must be a string"));break;case"selfSignature":ft(e.selfSignature)||(n=!(o="selfSignature must be a string"));break;case"allowType":pt(Be,e.allowType)||(o="key:allowType, invalid value:"+e.allowType,n=!1);break;case"language":Qe(e.language)||(n=!(o="language must be a number"));break;case"avatar":ft(e.avatar)||(n=!(o="avatar must be a string"));break;case"messageSettings":0!==e.messageSettings&&1!==e.messageSettings&&(n=!(o="messageSettings must be 0 or 1"));break;case"adminForbidType":pt(He,e.adminForbidType)||(o="key:adminForbidType, invalid value:"+e.adminForbidType,n=!1);break;case"level":Qe(e.level)||(n=!(o="level must be a number"));break;case"role":Qe(e.role)||(n=!(o="role must be a number"));break;default:o="unknown key:"+t+"  "+e[t],n=!1;}}return {valid:n,tips:o}}}]),ua),ri=(e(ca,[{key:"set",value:function(e){var t;this.map.size>=this.MAX_LENGTH&&(t=this.map.entries().next().value[0],this.map.delete(t)),this.map.set(e,1);}},{key:"has",value:function(e){return this.map.has(e)}},{key:"delete",value:function(e){this.has(e)&&this.map.delete(e);}},{key:"reset",value:function(){this.map.clear();}}]),ca),ci=["groupID","name","avatar","type","introduction","notification","ownerID","selfInfo","createTime","infoSequence","lastInfoTime","lastMessage","nextMessageSeq","memberNum","maxMemberNum","memberList","joinOption","groupCustomField","muteAllMembers","isSupportTopic","inviteOption","_lastRevokedTime"],ui=(e(ra,[{key:"memberNum",get:function(){return this.memberCount},set:function(e){}},{key:"maxMemberNum",get:function(){return this.maxMemberCount},set:function(e){}},{key:"_initGroup",value:function(e){for(var t in e)ci.indexOf(t)<0||("selfInfo"!==t?("memberNum"===t&&(this.memberCount=e[t]),"maxMemberNum"===t&&(this.maxMemberCount=e[t]),"isSupportTopic"!==t?this[t]=e[t]:this.isSupportTopic=1===e[t]):this.updateSelfInfo(e[t]));}},{key:"updateGroup",value:function(e){var t=this,e=(e.appid=void 0,e.grossTopicNextMsgSeq=void 0,e.selfInfo&&(e.selfInfo.grossTopicReadSeq=void 0),JSON.parse(JSON.stringify(e)));e.lastMsgTime&&(this.lastMessage.lastTime=e.lastMsgTime),A(e.muteAllMembers)||("On"===e.muteAllMembers?e.muteAllMembers=!0:e.muteAllMembers=!1),e.groupCustomField&&Tt(this.groupCustomField,e.groupCustomField),A(e.memberNum)||(this.memberCount=e.memberNum),A(e.maxMemberNum)||(this.maxMemberCount=e.maxMemberNum),A(e.isSupportTopic)||(this.isSupportTopic=Qe(e.isSupportTopic)?1===e.isSupportTopic:e.isSupportTopic),rt(this,e,["members","errorCode","lastMsgTime","groupCustomField","memberNum","maxMemberNum","isSupportTopic"]),nt(e.members)&&0<e.members.length&&e.members.forEach(function(e){e.userID===t.selfInfo.userID&&rt(t.selfInfo,e,["sequence"]);});}},{key:"updateSelfInfo",value:function(e){e={nameCard:e.nameCard,joinTime:e.joinTime,role:e.role,messageRemindType:e.messageRemindType,readedSequence:e.readedSequence,excludedUnreadSequenceList:e.excludedUnreadSequenceList};rt(this.selfInfo,y({},e),[],["",null,void 0,0,NaN]);}},{key:"setSelfNameCard",value:function(e){this.selfInfo.nameCard=e;}}]),ra),li=(e(sa,[{key:"toAccount",get:function(){return this.conversationID.startsWith(R.CONV_C2C)?this.conversationID.replace(R.CONV_C2C,""):this.conversationID.startsWith(R.CONV_GROUP)?this.conversationID.replace(R.CONV_GROUP,""):""}},{key:"_initProfile",value:function(t){var n=this;Object.keys(t).forEach(function(e){switch(e){case"userProfile":n.userProfile=t.userProfile;break;case"groupProfile":n.groupProfile=t.groupProfile;}}),A(this.userProfile)&&this.type===R.CONV_C2C?this.userProfile=new si({userID:t.conversationID.replace("C2C","")}):A(this.groupProfile)&&this.type===R.CONV_GROUP&&(this.groupProfile=new ui({groupID:t.conversationID.replace("GROUP","")}));}},{key:"updateUnreadCount",value:function(e){var t=e.nextUnreadCount,n=e.isFromGetConversations,e=e.isUnreadC2CMessage;A(t)||(Lt(this.subType)?this.unreadCount=0:n&&this.type===R.CONV_GROUP||n&&this.type===R.CONV_TOPIC||e&&this.type===R.CONV_C2C?this.unreadCount=t:this.unreadCount=this.unreadCount+t);}},{key:"updateLastMessage",value:function(e){this.lastMessage=Xo(e);}},{key:"updateGroupAtInfoList",value:function(e){var t;this._isNeedMergeGroupAtInfo(e)||(-1!==(t=(E(t=e.groupAtType)||L(t)||S(t)||O()).slice(0)).indexOf(R.CONV_AT_ME)&&-1!==t.indexOf(R.CONV_AT_ALL)&&(t=[R.CONV_AT_ALL_AT_ME]),t={from:e.from,groupID:e.groupID,topicID:e.topicID,messageSequence:e.sequence,atTypeArray:t,__random:e.__random,__sequence:e.__sequence},this.groupAtInfoList.push(t));}},{key:"_isNeedMergeGroupAtInfo",value:function(t){var e=t.groupID,n=t.sequence;if(!St({groupID:e}))return !1;var o=!1;return this.groupAtInfoList.forEach(function(e){e.messageSequence===n&&(-1<e.atTypeArray.indexOf(R.CONV_AT_ME)&&-1<t.groupAtType.indexOf(R.CONV_AT_ALL)&&(e.atTypeArray=[R.CONV_AT_ALL_AT_ME]),-1<e.atTypeArray.indexOf(R.CONV_AT_ALL)&&-1<t.groupAtType.indexOf(R.CONV_AT_ME)&&(e.atTypeArray=[R.CONV_AT_ALL_AT_ME],e.__random=t.__random,e.__sequence=t.__sequence),o=!0);}),o}},{key:"clearGroupAtInfoList",value:function(){this.groupAtInfoList.length=0;}},{key:"reduceUnreadCount",value:function(){return 1<=this.unreadCount&&(--this.unreadCount,!0)}},{key:"isLastMessageRevoked",value:function(e){var t=e.sequence,e=e.time;return this.type===R.CONV_C2C&&t===this.lastMessage.lastSequence&&e===this.lastMessage.lastTime||this.type===R.CONV_GROUP&&t===this.lastMessage.lastSequence}},{key:"setLastMessageRevoked",value:function(e){this.lastMessage.isRevoked=e;}},{key:"setLastMessageRevoker",value:function(e){this.lastMessage.revoker=e;}},{key:"setDraftText",value:function(e){this.draftText=e;}}]),sa),di=(c(Fn={},R.MSG_REMIND_ACPT_AND_NOTE,0),c(Fn,R.MSG_REMIND_DISCARD,1),c(Fn,R.MSG_REMIND_ACPT_NOT_NOTE,2),Fn),pi=(e(aa,[{key:"onAllRcvMsgOptNotify",value:function(e){e=this._handleResult(e);this._convM.emitOEvt(G.ALL_RECEIVE_MESSAGE_OPT_UPDATED,e);}},{key:"getC2CMsgRemindType",value:function(t){var n=this,o="".concat(this._n,".getC2CMsgRemindType");return this._convM.req({P:I.GET_C2C_PEER_MUTE_NOTIFICATIONS,data:{toAccount:this._convM.getMyUserID(),userIDList:t}}).then(function(e){v.l("".concat(o," ok. userIDList:").concat(t));e=e.data.muteFlagList;n._convM.onC2CMsgRemindTypeFetched(e);}).catch(function(e){v.e("".concat(o," failed. error:"),e);})}},{key:"set",value:function(e){return e.groupID?this._setGroupMsgRemindType(e):nt(e.userIDList)?this._setC2CMsgRemindType(e):void 0}},{key:"_setGroupMsgRemindType",value:function(t){var n=this,o="".concat(this._n,".").concat("_setGroupMsgRemindType"),e=t.groupID,i=t.messageRemindType,a="groupID:".concat(e," messageRemindType:").concat(i),s=new M("_setGroupMsgRemindType"),r=(s.setMessage(a),this._get(7));return r?r.modifyGroupMemberInfo({groupID:e,messageRemindType:i,userID:this._convM.getMyUserID()}).then(function(){s.end(),v.l("".concat(o," ok. ").concat(a));var e=n.onGroupMsgRemindTypeUpdated(t);return n._convM.onTotalUnreadCountUpdate(),Ln(e)}).catch(function(e){return s.setError(e).end(),v.e("".concat(o," failed. error:"),e),C(e)}):C({code:T.NO_MODULE})}},{key:"onGroupMsgRemindTypeUpdated",value:function(e){var t,n,o=e.groupID,e=e.messageRemindType,i=(v.l("".concat(this._n,".onGroupMsgRemindTypeUpdated groupID:").concat(o," messageRemindType:").concat(e)),this._get(7).getLocalGroupProfile(o));return i&&(i.selfInfo.messageRemindType=e),kt(o)?(t=Bt(n=o),(n=this._get(10).getLocalTopic(t,n))&&n.updateSelfInfo({messageRemindType:e})&&this._convM.emitOEvt(G.TOPIC_UPDATED,{groupID:t,topic:n}),{topic:n}):(this._convM.patchMsgRemindType({ID:o,isC2CConversation:!1,messageRemindType:e})&&this._emitConvUpdate(),{group:i})}},{key:"_setC2CMsgRemindType",value:function(e){var i=this,a="".concat(this._n,".").concat("_setC2CMsgRemindType"),t=e.userIDList,s=e.messageRemindType,r=t.slice(0,30),e=di[s]||0,c="userIDList:".concat(r," messageRemindType:").concat(s),u=new M("_setC2CMsgRemindType");return u.setMessage(c),this._convM.req({P:I.SET_C2C_PEER_MUTE_NOTIFICATIONS,data:{userIDList:r,muteFlag:e}}).then(function(e){u.end();var e=e.data.errorList,t=[],n=[],e=(nt(e)&&e.forEach(function(e){t.push(e.userID),n.push({userID:e.userID,code:e.errorCode});}),r.filter(function(e){return -1===t.indexOf(e)})),o=(v.l("".concat(a," ok. ").concat(c," successUserIDList:").concat(e," failureUserIDList:").concat(JSON.stringify(n))),0);return e.forEach(function(e){i._convM.patchMsgRemindType({ID:e,isC2CConversation:!0,messageRemindType:s})&&(o+=1);}),1<=o&&i._emitConvUpdate(),r.length=t.length=0,i._convM.onTotalUnreadCountUpdate(),Sn({successUserIDList:e.map(function(e){return {userID:e}}),failureUserIDList:n})}).catch(function(e){return u.setError(e).end(),v.e("".concat(a," failed. error:"),e),C(e)})}},{key:"_get",value:function(e){return this._convM.get(e)}},{key:"_emitConvUpdate",value:function(){this._convM.emitConvUpdate(!0,!1);}},{key:"setAllRcvMsgOpt",value:function(e){var t="".concat(this._n,".").concat("setAllRcvMsgOpt"),n=e.messageRemindType,n=void 0===n?R.MSG_REMIND_ACPT_NOT_NOTE:n,o=e.isRepeated,o=void 0===o||o,i=this._calcStartAndEndTime(e),a=i.startTime,a=void 0===a?0:a,i=i.endTime,i=void 0===i?0:i,e=JSON.stringify(e),s=new M("setAllRcvMsgOpt");return s.setMessage(e),v.l("".concat(t," options:").concat(e)),this._convM.req({P:I.SET_ALL_RECEIVE_MSG_OPT,data:{messageRemindType:di[n],startTime:a,endTime:i,isRepeated:o?1:0}}).then(function(e){return s.end(),v.l("".concat(t," ok.")),Ln(e)}).catch(function(e){return s.setError(e).end(),v.e("".concat(t," failed. error:"),e),C(e)})}},{key:"_calcStartAndEndTime",value:function(e){var t=e.startHour,t=void 0===t?0:t,n=e.startMinute,n=void 0===n?0:n,o=e.startSecond,o=void 0===o?0:o,i=e.duration,i=void 0===i?0:i,e=e.isRepeated,e=void 0===e||e,a=new Date,s=a.getFullYear(),r=a.getMonth(),a=a.getDate(),s=Math.round(new Date(s,r,a,t,n,o).getTime()/1e3);return {startTime:s,endTime:e&&86400<=i?s+86400:s+i}}},{key:"getAllRcvMsgOpt",value:function(){var t=this,n="".concat(this._n,".").concat("getAllRcvMsgOpt"),o=new M("getAllRcvMsgOpt");return this._convM.req({P:I.GET_ALL_RECEIVE_MSG_OPT,data:{toAccount:this._convM.getMyUserID()}}).then(function(e){e=e.data,o.setMessage(JSON.stringify(e)).end(),v.l("".concat(n," ok. data:").concat(JSON.stringify(e))),e=t._handleResult(e);return Ln(e)}).catch(function(e){return o.setError(e).end(),v.e("".concat(n," failed. error:"),e),C(e)})}},{key:"_handleResult",value:function(e){var t=e.messageRemindType,n=e.startTime,o=e.endTime,e=e.isRepeated,i=R.MSG_REMIND_ACPT_AND_NOTE;return 1===t&&(i=R.MSG_REMIND_DISCARD),{messageRemindType:i=2===t?R.MSG_REMIND_ACPT_NOT_NOTE:i,startTime:n,endTime:o,isRepeated:1===e}}},{key:"reset",value:function(){v.l("".concat(this._n,".reset"));}}]),aa),_i=(e(ia,[{key:"setConvCustomData",value:function(e){var i=this,a="".concat(this._n,".").concat("setConvCustomData"),t=e.conversationIDList,s=e.customData,r=(v.l("".concat(a," options:"),e),new M("setConvCustomData")),n=(r.setMessage(JSON.stringify(e)),{fromAccount:this._getMyUserID(),itemList:[]}),c=[],u=[];return t.forEach(function(e){if(!i._hasLocalConv(e))return i._onConvNotFound(u,e),!0;if(!Rt(e)&&!At(e))return i._onConvIDInvalid(u,e),!0;var t={operationType:2,contactItem:void 0,customMark:s};Rt(e)?t.contactItem={type:1,toAccount:e.replace(R.CONV_C2C,"")}:At(e)&&(t.contactItem={type:2,groupID:e.replace(R.CONV_GROUP,"")}),n.itemList.push(t);}),u.length===t.length?Sn({successConversationIDList:c,failureConversationIDList:u}):this._convM.req({P:I.SET_CONV_CUSTOM_DATA,data:n}).then(function(e){r.end(),v.l("".concat(a," ok"));var t,n,o,e=e.data.resultItem;return nt(e)&&(o=!1,e.forEach(function(e){t=i._concatConvID(e.contactItem),0===e.resultCode?(c.push(t),(n=i._getLocalConv(t))&&n.customData!==s&&(n.customData=s,o=!0)):u.push({conversationID:t,code:e.resultCode,message:e.resultInfo});}),!0===o&&i._emitConvUpdate()),Ln({successConversationIDList:c,failureConversationIDList:u})}).catch(function(e){return r.setError(e).end(),v.e("".concat(a," failed. error:"),e),C(e)})}},{key:"markConv",value:function(e){var a=this;if(!this._convM.canIUse(H.CONV_MARK))return this._convM.noUse("markConv");var t="".concat(this._n,".").concat("markConv"),n=e.conversationIDList,s=e.markType,r=e.enableMark,c=(v.l("".concat(t," options:"),e),new M("markConv")),o=(c.setMessage(JSON.stringify(e)),void 0),i=void 0,e=this._getFlagBit(s),d=(!0===r?i=[e]:o=[e],{fromAccount:this._getMyUserID(),itemList:[]}),u=[],l=[];return n.forEach(function(e){if(!a._hasLocalConv(e))return a._onConvNotFound(l,e),!0;if(!Rt(e)&&!At(e))return a._onConvIDInvalid(l,e),!0;var t={operationType:1,contactItem:void 0,clearMark:o,setMark:i};Rt(e)?t.contactItem={type:1,toAccount:e.replace(R.CONV_C2C,"")}:At(e)&&(t.contactItem={type:2,groupID:e.replace(R.CONV_GROUP,"")}),d.itemList.push(t);}),l.length===n.length?Sn({successConversationIDList:u,failureConversationIDList:l}):this._convM.req({P:I.MARK_CONV,data:d}).then(function(e){c.end(),v.l("".concat(t," ok"));var n,o,i,e=e.data.resultItem;return nt(e)&&(i=!1,e.forEach(function(e){var t;n=a._concatConvID(e.contactItem),0===e.resultCode?(u.push(n),(o=a._getLocalConv(n))&&(t=o.markList.indexOf(s),!0===r?-1===t&&(o.markList.push(s),i=!0):-1!==t&&(o.markList.splice(t,1),i=!0))):l.push({conversationID:n,code:e.resultCode,message:e.resultInfo});}),!0===i&&a._emitConvUpdate()),Ln({successConversationIDList:u,failureConversationIDList:l})}).catch(function(e){return c.setError(e).end(),v.e("".concat(t," failed. error:"),e),C(e)})}},{key:"getLocalConvGroupList",value:function(){var e=this;return v.l("".concat(this._n,".getLocalConvGroupList pagingStatus:").concat(this._pagingStatus)),this._pagingStatus===Un?this.getRemoteConvGroupList().then(function(){return Ln(D(e._convGroupMap.values()))}):Sn(D(this._convGroupMap.values()))}},{key:"searchConvGroupAndMark",value:function(e,t){var n=this,o="".concat(this._n,".searchConvGroupAndMark"),i=[];return e.forEach(function(e){1===t?i.push({type:1,toAccount:e}):2===t&&i.push({type:2,groupID:e});}),v.l("".concat(o," type:").concat(t," list:"),e),this._convM.req({P:I.SEARCH_CONV_GRP_MARK,data:{fromAccount:this._getMyUserID(),contactItem:i}}).then(function(e){var e=e.data,t=e.contactItem,e=e.groupItem;v.l("".concat(o," ok. contactItem:"),t,"groupItem:",e),n._fillConvGroupMap(e),n._handleContactItem(t),n._emitConvUpdate();}).catch(function(e){v.w("".concat(o," failed. error:"),e);})}},{key:"_fillConvGroupMap",value:function(e){var n=this;nt(e)&&e.forEach(function(e){var t=e.convGroupID,e=e.groupName;n._convGroupMap.set(t,e);});}},{key:"_handleContactItem",value:function(e){var a,s=this;nt(e)&&e.forEach(function(e){var t=[],n=e.standardMark,o=e.customData,i=e.convGroupIDList;nt(i)&&i.forEach(function(e){s._convGroupMap.has(e)&&t.push(s._convGroupMap.get(e));}),a=s._concatConvID(e),(a=s._getLocalConv(a))&&(a.markList=Wt(n),a.customData=o||"",a.conversationGroupList=[].concat(t));});}},{key:"getRemoteConvGroupList",value:function(){var i=this,a="".concat(this._n,".getRemoteConvGroupList");return this._pagingStatus=Gn,this._convM.req({P:I.GET_CONV_GRP_LIST,data:{fromAccount:this._getMyUserID(),startIndex:this._startIndex}}).then(function(e){var e=e.data,t=e.completeFlag,n=e.contactItem,o=e.nextStartIndex,o=void 0===o?0:o,e=e.groupItem;if(i._startIndex=o,v.l("".concat(a," completeFlag:").concat(t," nextStartIndex:").concat(o,", groupItem:"),e,"contactItem:",n),i._fillConvGroupMap(e),i._handleContactItem(n),0===t)return i.getRemoteConvGroupList();1===t&&(i._pagingStatus=Pn,i._emitConvUpdate(),i._emitConvGroupListUpdate());}).catch(function(e){i._pagingStatus=Un,v.w("".concat(a," failed. error:"),e);})}},{key:"createConvGroup",value:function(e){var a=this;if(!this._convM.canIUse(H.CONV_GROUP))return this._convM.noUse("createConvGroup");var s="".concat(this._n,".").concat("createConvGroup"),r=(v.l("".concat(s," options:"),e),new M("createConvGroup")),c=(r.setMessage(JSON.stringify(e)),e.groupName),e=e.conversationIDList,t={fromAccount:this._getMyUserID(),itemList:[{groupName:c,contactItem:[]}]},u=[],l=[];return e.forEach(function(e){return a._hasLocalConv(e)?Rt(e)||At(e)?void(Rt(e)?t.itemList[0].contactItem.push({type:1,toAccount:e.replace(R.CONV_C2C,"")}):At(e)&&t.itemList[0].contactItem.push({type:2,groupID:e.replace(R.CONV_GROUP,"")})):(a._onConvIDInvalid(l,e),!0):(a._onConvNotFound(l,e),!0)}),l.length===e.length?Sn({successConversationIDList:u,failureConversationIDList:l}):this._convM.req({P:I.CREATE_CONV_GRP,data:t}).then(function(e){r.end(),v.l("".concat(s," ok"));var t,n,o,e=e.data.groupResultItem[0],i=e.groupItem,e=e.resultItem;return et(i)&&(a._convGroupMap.set(i.convGroupID,i.groupName),a._emitConvGroupListUpdate()),nt(e)&&(o=!1,e.forEach(function(e){t=a._concatConvID(e.contactItem),0===e.resultCode?(u.push(t),(n=a._getLocalConv(t))&&-1===n.conversationGroupList.indexOf(c)&&(n.conversationGroupList.push(c),o=!0)):l.push({conversationID:t,code:e.resultCode,message:e.resultInfo});}),!0===o&&(a._emitConvUpdate(),a._emitConvGroupListUpdate())),Ln({successConversationIDList:u,failureConversationIDList:l})}).catch(function(e){return r.setError(e).end(),v.e("".concat(s," failed. error:"),e),C(e)})}},{key:"deleteConvGroup",value:function(n){var o=this;if(!this._convM.canIUse(H.CONV_GROUP))return this._convM.noUse("deleteConvGroup");var i="".concat(this._n,".").concat("deleteConvGroup"),a=(v.l("".concat(i," groupName:").concat(n)),new M("deleteConvGroup"));return a.setMessage(n),this._convM.req({P:I.DEL_CONV_GRP,data:{fromAccount:this._getMyUserID(),groupName:[n]}}).then(function(e){a.end(),v.l("".concat(i," ok"));var t,e=e.data.groupItem;nt(e)&&(t=!1,e.forEach(function(e){o._convGroupMap.has(e.convGroupID)&&(o._convGroupMap.delete(e.convGroupID),t=!0);}),!0===t&&o._emitConvGroupListUpdate()),o._eraseFromConversationGroupList([n]);}).catch(function(e){return a.setError(e).end(),v.e("".concat(i," failed. error:"),e),C(e)})}},{key:"renameConvGroup",value:function(e){var i=this;if(!this._convM.canIUse(H.CONV_GROUP))return this._convM.noUse("renameConvGroup");var a="".concat(this._n,".").concat("renameConvGroup"),s=(v.l("".concat(a," options:"),e),new M("renameConvGroup")),r=(s.setMessage(JSON.stringify(e)),e.oldName),c=e.newName;return this._convM.req({P:I.RENAME_CONV_GRP,data:{fromAccount:this._getMyUserID(),updateType:1,updateGroup:{updateGroupType:1,oldName:r,newName:c}}}).then(function(e){s.end(),v.l("".concat(a," ok"));e=e.data.updateGroupResult.convGroupID;i._convGroupMap.set(e,c),i._emitConvGroupListUpdate();var t,n,e=i._convM.getLocalConvList(),o=!1;e.forEach(function(e){t=e.conversationGroupList,-1!==(n=t.indexOf(r))&&(t.splice(n,1,c),o=!0);}),!0===o&&i._emitConvUpdate();}).catch(function(e){return s.setError(e).end(),v.e("".concat(a," failed. error:"),e),C(e)})}},{key:"addConvsToGroup",value:function(e){var i=this;if(!this._convM.canIUse(H.CONV_GROUP))return this._convM.noUse("addConvsToGroup");var a="".concat(this._n,".").concat("addConvsToGroup"),s=(v.l("".concat(a," options:"),e),new M("addConvsToGroup")),t=(s.setMessage(JSON.stringify(e)),e.conversationIDList),r=e.groupName,n={fromAccount:this._getMyUserID(),updateType:1,updateGroup:{updateGroupType:2,groupName:r,updateItem:[]}},c=[],u=[];return t.forEach(function(e){return i._hasLocalConv(e)?Rt(e)||At(e)?void(Rt(e)?n.updateGroup.updateItem.push({operationType:1,contactItem:{type:1,toAccount:e.replace(R.CONV_C2C,"")}}):At(e)&&n.updateGroup.updateItem.push({operationType:1,contactItem:{type:2,groupID:e.replace(R.CONV_GROUP,"")}})):(i._onConvIDInvalid(u,e),!0):(i._onConvNotFound(u,e),!0)}),u.length===t.length?Sn({successConversationIDList:c,failureConversationIDList:u}):this._convM.req({P:I.ADD_CONV_TO_GRP,data:n}).then(function(e){s.end(),v.l("".concat(a," ok"));var t,n,o,e=e.data.updateGroupResult.contactResultItem;return nt(e)&&(o=!1,e.forEach(function(e){t=i._concatConvID(e.contactItem),0===e.resultCode?(n=i._getLocalConv(t))&&-1===n.conversationGroupList.indexOf(r)&&(n.conversationGroupList.push(r),c.push(t),o=!0):u.push({conversationID:t,code:e.resultCode,message:e.resultInfo});}),!0===o&&(i._emitConvUpdate(),i._emitConvInGroupUpdate(r))),Ln({successConversationIDList:c,failureConversationIDList:u})}).catch(function(e){return s.setError(e).end(),v.e("".concat(a," failed. error:"),e),C(e)})}},{key:"deleteConvsFromGroup",value:function(e){var a=this,t="deleteConvsFromGroup";if(!this._convM.canIUse(H.CONV_GROUP))return this._convM.noUse(t);var s="".concat(this._n,".").concat(t),r=(v.l("".concat(s," options:"),e),new M(t)),t=(r.setMessage(JSON.stringify(e)),e.conversationIDList),c=e.groupName,n={fromAccount:this._getMyUserID(),updateType:1,updateGroup:{updateGroupType:2,groupName:c,updateItem:[]}},u=[],l=[];return t.forEach(function(e){return a._hasLocalConv(e)?Rt(e)||At(e)?void(Rt(e)?n.updateGroup.updateItem.push({operationType:2,contactItem:{type:1,toAccount:e.replace(R.CONV_C2C,"")}}):At(e)&&n.updateGroup.updateItem.push({operationType:2,contactItem:{type:2,groupID:e.replace(R.CONV_GROUP,"")}})):(a._onConvIDInvalid(l,e),!0):(a._onConvNotFound(l,e),!0)}),l.length===t.length?Sn({successConversationIDList:u,failureConversationIDList:l}):this._convM.req({P:I.DEL_CONV_FROM_GRP,data:n}).then(function(e){r.end(),v.l("".concat(s," ok"));var n,o,i,e=e.data.updateGroupResult.contactResultItem;return nt(e)&&(i=!1,e.forEach(function(e){var t;n=a._concatConvID(e.contactItem),0===e.resultCode?!(o=a._getLocalConv(n))||-1!==(t=o.conversationGroupList.indexOf(c))&&(o.conversationGroupList.splice(t,1),u.push(n),i=!0):l.push({conversationID:n,code:e.resultCode,message:e.resultInfo});}),!0===i&&(a._emitConvUpdate(),a._emitConvInGroupUpdate(c))),Ln({successConversationIDList:u,failureConversationIDList:l})}).catch(function(e){return r.setError(e).end(),v.e("".concat(s," failed. error:"),e),C(e)})}},{key:"onConvMarkUpdated",value:function(e){var i,a,s=this;Je(e)||(v.l("".concat(this._n,".onConvMarkUpdated markItemList:"),e),a=!1,e.forEach(function(e){var t=e.recentContactItem,n=e.optType,o=e.standardMark,e=e.customMark;i=s._concatConvID(t),(i=s._getLocalConv(i))&&(1===n?a=s._diffStandardMark(i,o):2===n?a=s._diffCustomMark(i,e):3===n&&(t=s._diffStandardMark(i,o),n=s._diffCustomMark(i,e),a=t||n));}),!0===a&&this._emitConvUpdate());}},{key:"_diffStandardMark",value:function(e,t){var t=Wt(t),n=!1;return !0!==function(e,t){if(e===t)return !0;if(!e||!t)return !1;if(e.length!==t.length)return !1;for(var n=0,o=e.length;n<o;n++)if(e[n]!==t[n])return !1;return !0}(e.markList,t)&&(e.markList=t,n=!0),n}},{key:"_diffCustomMark",value:function(e,t){var n=!1;return e.customData!==t&&void 0!==t&&(e.customData=t,n=!0),n}},{key:"onConvGroupCreated",value:function(e){var a=this,s=(v.l("".concat(this._n,".onConvGroupCreated resultList:"),e),!1),r=!1;nt(e)&&(e.forEach(function(e){var t=e.msgGroupItem,n=t.groupID,o=t.groupName;a._convGroupMap.get(n)!==o&&(a._convGroupMap.set(n,o),r=!0);var i,t=e.msgRecentContactItem;nt(t)&&t.forEach(function(e){i=a._concatConvID(e),(i=a._getLocalConv(i))&&-1===i.conversationGroupList.indexOf(o)&&(i.conversationGroupList.push(o),s=!0);});}),!0===s&&this._emitConvUpdate(),!0===r&&this._emitConvGroupListUpdate());}},{key:"onConvGroupDeleted",value:function(e){var n,o=this,i=(v.l("".concat(this._n,".onConvGroupDeleted groupItemList:"),e),[]);nt(e)&&(n=!1,e.forEach(function(e){var t=e.groupID,e=e.groupName;o._convGroupMap.has(t)&&(o._convGroupMap.delete(t),n=!0,i.push(e));}),!0===n&&this._emitConvGroupListUpdate()),this._eraseFromConversationGroupList(i);}},{key:"_eraseFromConversationGroupList",value:function(t){Je(t)||(this._convM.getLocalConvList().forEach(function(e){e.conversationGroupList=e.conversationGroupList.filter(function(e){return !t.includes(e)});}),this._emitConvUpdate());}},{key:"onConvGroupNameUpdated",value:function(e){v.l("".concat(this._n,".onConvGroupNameUpdated options:"),e);var t,n,o,i=e.groupID,a=e.groupName,s=e.oldGroupName;this._convGroupMap.get(i)!==a&&(this._convGroupMap.set(i,a),this._emitConvGroupListUpdate(),e=this._convM.getLocalConvList(),o=!1,e.forEach(function(e){t=e.conversationGroupList,-1!==(n=t.indexOf(s))&&(t.splice(n,1,a),o=!0);}),!0===o&&this._emitConvUpdate());}},{key:"onConvInGroupUpdated",value:function(e){var n,o,i,a=this,s=(v.l("".concat(this._n,".onConvInGroupUpdated options:"),e),e.oldGroupName),e=e.recentContactUpdateGroupItem;nt(e)&&(i=!1,e.forEach(function(e){var t=e.contactOptType,e=e.recentContactItem;n=a._concatConvID(e),(n=a._getLocalConv(n))&&(o=n.conversationGroupList.indexOf(s),1===t?-1===o&&(n.conversationGroupList.push(s),i=!0):2===t&&-1!==o&&(n.conversationGroupList.splice(o,1),i=!0));}),!0===i&&(this._emitConvUpdate(),this._emitConvInGroupUpdate(s)));}},{key:"onConvAddedToOrDeletedFromGroup",value:function(e){var n,o,i=this,t=(v.l("".concat(this._n,".onConvAddedToOrDeletedFromGroup options:"),e),e.msgRecentContactItem),e=e.msgRecentContactUpdateContactItem,t=this._concatConvID(t),a=this._getLocalConv(t);a&&nt(e)&&(o=!1,e.forEach(function(e){var t=e.groupOptType,e=e.recentContactGroupItem.groupName;n=a.conversationGroupList.indexOf(e),1===t?-1===n&&(a.conversationGroupList.push(e),o=!0):2===t&&-1!==n&&(a.conversationGroupList.splice(n,1),o=!0),!0===o&&i._emitConvInGroupUpdate(e);}),!0===o&&this._emitConvUpdate());}},{key:"onConvGroupListSynced",value:function(e){nt(e)&&0!==e.length&&(v.l("".concat(this._n,".onConvGroupListSynced groupItem:"),e),this._fillConvGroupMap(e));}},{key:"getConvGroupListByID",value:function(e){var t,n=this;if(!Je(e))return t=[],e.forEach(function(e){n._convGroupMap.has(e)&&t.push(n._convGroupMap.get(e));}),t}},{key:"_onConvNotFound",value:function(e,t){e.push({conversationID:t,code:T.CONV_NOT_FOUND,message:this._convM.getErrMsg(T.CONV_NOT_FOUND)});}},{key:"_onConvIDInvalid",value:function(e,t){e.push({conversationID:t,code:T.INVALID_CONV_ID,message:this._convM.getErrMsg(T.INVALID_CONV_ID)});}},{key:"_getFlagBit",value:function(e){for(var t=e.toString(2),n=t.length,o=n-1;0<=o;o--)if("1"===t[o])return n-o-1}},{key:"_concatConvID",value:function(e){var t,n=e.type,o=e.to,i=e.groupID,e=e.userID;return 1===n?A(e)?A(o)||(t="".concat(R.CONV_C2C).concat(o)):t="".concat(R.CONV_C2C).concat(e):2===n&&(t="".concat(R.CONV_GROUP).concat(i)),t}},{key:"_getMyUserID",value:function(){return this._convM.getMyUserID()}},{key:"_getLocalConv",value:function(e){return this._convM.getLocalConversation(e)}},{key:"_hasLocalConv",value:function(e){return this._convM.hasLocalConversation(e)}},{key:"_emitConvUpdate",value:function(){this._convM.emitConvUpdate(!0,!1);}},{key:"_emitConvGroupListUpdate",value:function(){this._convM.emitOEvt(G.CONVERSATION_GROUP_LIST_UPDATED,D(this._convGroupMap.values()));}},{key:"_emitConvInGroupUpdate",value:function(t){var e={groupName:t,conversationList:[]},n=this._convM.getLocalConvList();e.conversationList=n.filter(function(e){return e.conversationGroupList.includes(t)}),this._convM.emitOEvt(G.CONVERSATION_IN_GROUP_UPDATED,e);}},{key:"reset",value:function(){v.l("".concat(this._n,".reset")),this._convGroupMap.clear(),this._startIndex=0,this._pagingStatus=Nn;}}]),ia),hi=(t(oa,wn),oi=f(oa),e(oa,[{key:"_initListeners",value:function(){var e=this.getIEmitInst();e.on(Yo.A2KEY_AND_TINYID_UPDATED,this._init,this),e.on(Yo.PROFILE_UPDATED,this._onProfileUpdated,this),e.on(Yo.CLOUD_CONFIG,this._onCloudConfig,this);}},{key:"_init",value:function(){var e=this,t=(v.l("".concat(this._n,"._init")),this.get(13).getItem("conversationMap")),n=this.isIntl(),o=this.isUsingChatCore();if(t){for(var i=t.length,a=0;a<i;a++){var s=t[a];if(s){if(this._isNonExistentAccount(s.conversationID))continue;if(s.groupProfile&&Lt(s.groupProfile.type))continue}this._convMap.set(s.conversationID,new li(t[a],n,o));}this.emitConvUpdate(!0,!1);}this.ready(function(){0<e._tmpGroupList.length&&(e.updateConvGroupProfile(e._tmpGroupList),e._tmpGroupList.length=0);}),this.syncConvList();}},{key:"_isNonExistentAccount",value:function(e){var t;return "@TLS#ERROR"===(t=e.startsWith(R.CONV_C2C)?e.replace(R.CONV_C2C,""):t)||"@TLS#NOT_FOUND"===t}},{key:"onCheckTimer",value:function(e){this.isLoggedIn()&&this._msgListHandler.onCheckTimer(e);}},{key:"onMessageSent",value:function(e){this._onSendOrRcvMsg({conversationOptionsList:e.conversationOptionsList,isInstantMessage:!0});}},{key:"onNewMessage",value:function(e){this._onSendOrRcvMsg(e);}},{key:"_onSendOrRcvMsg",value:function(e){var t=this,n=e.conversationOptionsList,o=e.isInstantMessage,o=void 0===o||o,i=e.isUnreadC2CMessage,i=void 0!==i&&i,a=e.updateUnreadCount,a=void 0===a||a,s=e.isSyncingEnded,s=void 0!==s&&s;this._isReady?0!==n.length?(!0===o&&this._checkNewConv(n),this._updateLocalConvList({conversationOptionsList:n,isInstantMessage:o,isUnreadC2CMessage:i,isFromGetConversations:!1,updateUnreadCount:a}),o||(this._convIDFromUnreadDBMap=new Map([].concat(D(this._convIDFromUnreadDBMap),D(n.map(function(e){return [e.conversationID,1]})))),this._diffAndDeleteConv(),s&&this.emitIEvt(Yo.C2C_UNREAD_HANDLE_COMPLETED)),0<n.filter(function(e){return !t._isConvNeedShow(e.conversationID)}).length||this.emitConvUpdate()):s&&this.emitIEvt(Yo.C2C_UNREAD_HANDLE_COMPLETED):this.ready(function(){t._onSendOrRcvMsg(e);});}},{key:"updateConvGroupProfile",value:function(e){var n,o=this;nt(e)&&0===e.length||(0!==this._convMap.size?(n=!1,e.forEach(function(e){var t="".concat(R.CONV_GROUP).concat(e.groupID);o._convMap.has(t)&&(n=!0,(t=o._convMap.get(t)).groupProfile=JSON.parse(JSON.stringify(e)),t.lastMessage.lastSequence<e.nextMessageSeq&&(t.lastMessage.lastSequence=e.nextMessageSeq-1),t.subType||(t.subType=e.type));}),n&&this.emitConvUpdate(!0,!1)):this._tmpGroupList=e);}},{key:"onMessageRevoked",value:function(e,t){var n,o,i,a=this;0!==e.length&&(n=null,o=!1,i=[],e.forEach(function(e){(n=a._convMap.get(e.conversationID))&&(t&&n.reduceUnreadCount()&&(o=n.type!==R.CONV_TOPIC),n.type===R.CONV_TOPIC?i.push(e):n.isLastMessageRevoked({sequence:e.sequence,time:e.time})&&(n.setLastMessageRevoked(!0),n.setLastMessageRevoker(e.revoker),o=!0));}),this.get(10).onMessageRevoked(i),o&&this.emitConvUpdate(!0,!1));}},{key:"updateRevokerInfo",value:function(u){for(var e=new Set,t=0;t<u.length;t++){var n=u[t].revoker;e.add(n);}var o=D(e),i=this.get(4);return new Promise(function(c){i.getUserProfile({userIDList:o}).then(function(e){e=e.data;if(!nt(e)||0===e.length)return c(u);var t,n={},o=N(e);try{for(o.s();!(t=o.n()).done;){var i=t.value,a=i.userID,s=i.nick,r=i.avatar;n[a]={nick:s,avatar:r};}}catch(e){o.e(e);}finally{o.f();}u.forEach(function(e){var t=e.revoker;n[t]&&(e.revokerInfo.nick=n[t].nick||"",e.revokerInfo.avatar=n[t].avatar||"");}),c(u);}).catch(function(){c(u);});})}},{key:"isLastMessageRevoked",value:function(e){var t=!1,n=e.conversationID,o=e.sequence,i=e.time,a=this._convMap.get(n);return a&&(t=a.type===R.CONV_TOPIC?this.get(10).isLastMessageRevoked({topicID:n.replace(R.CONV_GROUP,""),sequence:o}):a.isLastMessageRevoked({sequence:o,time:i})),v.l("".concat(this._n,".isLastMessageRevoked options:"),e,"ret:".concat(t)),t}},{key:"onMessageDeleted",value:function(e){var t=this;if(0!==e.length){var n=null;e.forEach(function(e){(n=t._msgListHandler.getLocalMsg(e.conversationID,e.ID))&&(n.isDeleted=!0),e!==n&&(e.isDeleted=!0);});for(var e=e[0].conversationID,o=this._msgListHandler.getLocalMsgList(e),i={},a=o.length-1;0<=a;a--)if(!o[a].isDeleted){i=o[a];break}var s,r=this._convMap.get(e);r&&(s=!1,r.lastMessage.lastSequence===i.sequence&&r.lastMessage.lastTime===i.time||(Je(i)&&(i=void 0),r.updateLastMessage(i),r.type!==R.CONV_TOPIC&&(s=!0),v.l("".concat(this._n,".onMessageDeleted. update convID:").concat(e," with lastMessage:"),r.lastMessage)),e.startsWith(R.CONV_C2C)&&this.updateUnreadCount(e),s&&this.emitConvUpdate(!0,!1));}}},{key:"onMessageModified",value:function(e){var t="".concat(this._n,".onMessageModified"),n=e.conversationType,o=e.from,i=e.to,l=e.time,d=e.sequence,a=e.elements,p=e.cloudCustomData,s=e.messageVersion,r=this.getMyUserID(),c="".concat(n).concat(i),r=(i===r&&n===R.CONV_C2C&&(c="".concat(n).concat(o)),this._msgListHandler.onMsgModified(c,e)),n=r.isUpdated,r=r.message,u=(!0===n&&this.emitOEvt(G.MESSAGE_MODIFIED,[r]),this._isTopicConv(c));return null===r?v.l("".concat(t," message is null! options:"),e):v.l("".concat(t," isUpdated:").concat(n," isTopicMessage:").concat(u," from:").concat(o," to:").concat(i," sequence:").concat(r.sequence," time:").concat(r.time)),u?this.get(10).onMessageModified(e):!(n=this._convMap.get(c))||(o=n.lastMessage)&&o.lastTime===l&&o.lastSequence===d&&o.version!==s&&(v.l("".concat(t," convID:").concat(c," lastMessage updated")),o.type=a[0].type,o.payload=a[0].content,o.messageForShow=Kt(o.type,o.payload,this.isIntl()),o.cloudCustomData=p,o.version=s,this.emitConvUpdate(!0,!1)),r}},{key:"onNewGroupAtTips",value:function(e){var t=this,e=e.dataList,n=null;e.forEach(function(e){e.groupAtTips?n=e.groupAtTips:e.elements?n=y(y({},e.elements),{},{sync:!0}):e.groupAtType&&(n=y(y({},e),{},{sync:!0})),n.__random=e.random,n.__sequence=e.clientSequence,t._tmpGroupAtTipsList.push(n);}),v.l("".concat(this._n,".onNewGroupAtTips isReady:").concat(this._isReady),this._tmpGroupAtTipsList),this._isReady&&this._handleGroupAtTipsList();}},{key:"_handleGroupAtTipsList",value:function(){var a,s=this;0!==this._tmpGroupAtTipsList.length&&(a=!1,this._tmpGroupAtTipsList.forEach(function(e){var t=e.groupID,n=e.from,o=e.topicID,o=void 0===o?void 0:o,i=e.sync,i=void 0!==i&&i;n!==s.getMyUserID()&&(A(o)?(n=s._convMap.get("".concat(R.CONV_GROUP).concat(t)))&&(n.updateGroupAtInfoList(e),a=!0):((t=s._convMap.get("".concat(R.CONV_GROUP).concat(o)))&&(t.updateGroupAtInfoList(e),s.get(10).onAtInfoUpdated({topicID:o,groupAtInfoList:t.groupAtInfoList})),Je(t)&&i&&(s.updateTopicConversation([{conversationID:"".concat(R.CONV_GROUP).concat(o),type:R.CONV_TOPIC}]),s._convMap.get("".concat(R.CONV_GROUP).concat(o)).updateGroupAtInfoList(e))));}),a&&this.emitConvUpdate(!0,!1),this._tmpGroupAtTipsList.length=0);}},{key:"_checkNewConv",value:function(e){var t=this,n=[],o=[];e.forEach(function(e){t._convMap.has(e.conversationID)||(e.type===R.CONV_C2C?n.push(e.conversationID.replace(R.CONV_C2C,"")):e.type===R.CONV_GROUP&&o.push(e.conversationID.replace(R.CONV_GROUP,"")));}),0<n.length&&(this._onNewC2CConv(n),n=null),0<o.length&&(this._onNewGroupConv(o),o=null);}},{key:"_onNewC2CConv",value:function(e){var t=this.get(6);return Promise.all([t.getRemotePeerReadTime(e),this._msgRemindHandler.getC2CMsgRemindType(e),this._convGroupHandler.searchConvGroupAndMark(e,1)])}},{key:"_onNewGroupConv",value:function(e){var t=this.get(7);return t?Promise.all([t.getMsgRemindType(e),this._convGroupHandler.searchConvGroupAndMark(e,2)]):Promise.resolve()}},{key:"_setStorageConvList",value:function(){var e=0<arguments.length&&void 0!==arguments[0]&&arguments[0],t=this.getLocalConvList().filter(function(e){return e.type===R.CONV_C2C||e.type===R.CONV_GROUP&&e.lastMessage.type!==R.MSG_GRP_TIP}).slice(0,20).map(function(e){return {conversationID:e.conversationID,type:e.type,subType:e.subType,lastMessage:e.lastMessage,groupProfile:e.groupProfile,userProfile:e.userProfile}});this.get(13).setItem("conversationMap",t,e);}},{key:"emitConvUpdate",value:function(){var e=!(0<arguments.length&&void 0!==arguments[0])||arguments[0],t=!(1<arguments.length&&void 0!==arguments[1])||arguments[1],n=this.getLocalConvList();!t||(t=this.get(7))&&t.updateGroupLastMessage(n),e&&(this.get(12).isPartialUpdatedConvs()?(this._diffConvMap(this._convMapForDiff,this._convMap),0<this._partialUpdatedConvMap.size&&(this.emitOEvt(G.CONVERSATION_LIST_UPDATED),this.onTotalUnreadCountUpdate(),this._convMapForDiff.clear(),this._convMapForDiff=ct(this._convMap,!0)),0===this._convMapForDiff.size&&(this._convMapForDiff=ct(this._convMap,!0))):(this.emitOEvt(G.CONVERSATION_LIST_UPDATED),this.onTotalUnreadCountUpdate()));}},{key:"_diffConvMap",value:function(e,t){var n,o=N(t);try{for(o.s();!(n=o.n()).done;){var i=m(n.value,2),a=i[0],s=i[1];e.has(a)&&JSON.stringify(s)===e.get(a)||this._partialUpdatedConvMap.set(a,s);}}catch(e){o.e(e);}finally{o.f();}}},{key:"getPartialUpdatedConvs",value:function(){var e=D(ct(this._partialUpdatedConvMap,!1).values());return this._partialUpdatedConvMap.clear(),e}},{key:"getLocalConvList",value:function(){var t=this;return D(this._convMap.values()).filter(function(e){return t._isConvNeedShow(e.conversationID)})}},{key:"getLocalConversation",value:function(e){return this._convMap.get(e)}},{key:"hasLocalConversation",value:function(e){return this._convMap.has(e)}},{key:"getLocalOldestMessage",value:function(e){return this._msgListHandler.getLocalOldestMsg(e)}},{key:"syncConvList",value:function(){var o=this,e=!(0<arguments.length&&void 0!==arguments[0])||arguments[0],i="syncConvList",a=new M(i);return this._pagingStatus===Nn&&this._convMap.clear(),this._pagingGetConvList(e).then(function(e){var t=Xt(o._pagingGetCostList),n=zt(o._pagingGetCostList),n=(o._pagingGetCostList.length=0,o._pagingStatus=Pn,o._diffAndDeleteConv(),o.emitConvUpdate(!0,!1),o._setStorageConvList(),o._handleC2CPeerReadTime(),o.emitIEvt(Yo.CONV_SYNC_COMPLETED),"count:".concat(o._convMap.size," sum:").concat(n," avg:").concat(t));return v.l("".concat(o._n,".").concat(i,". ").concat(n)),a.setMessage(n).end(),e}).catch(function(e){return o._pagingStatus=Un,a.setMessage(o._pagingTs).setError(e).end(),C(e)})}},{key:"_diffAndDeleteConv",value:function(){var n,o=this;this._isSyncCompleted()&&(n=[],this._convMap.forEach(function(e,t){!o._pagingConvIDMap.has(t)&&o._convIDFromUnreadDBMap.has(t)&&(o._convMap.delete(t),n.push(t));}),v.l("".concat(this._n,"._diffAndDeleteConv list:").concat(n)),n=null);}},{key:"_pagingGetConvList",value:function(){var r=this,e=!(0<arguments.length&&void 0!==arguments[0])||arguments[0],c="".concat(this._n,"._pagingGetConvList"),u=(v.l("".concat(c," incrementalPullFlag:").concat(e," ts:").concat(this._pagingTs," startIdx:").concat(this._pagingStartIdx)+" pinnedTs:".concat(this._pagingPinnedTs," pinnedStartIdx:").concat(this._pagingPinnedStartIdx)),Date.now());return this._pagingStatus=Gn,this.req({P:I.PAGING_GET_CONV_LIST,data:{fromAccount:this.getMyUserID(),timeStamp:e?this._pagingTs:0,startIndex:e?this._pagingStartIdx:0,pinnedTimeStamp:e?this._pagingPinnedTs:0,pinnedStartIndex:e?this._pagingPinnedStartIdx:0,orderType:1}}).then(function(e){var e=e.data,t=e.completeFlag,n=e.conversations,n=void 0===n?[]:n,o=e.timeStamp,i=e.startIndex,a=e.pinnedTimeStamp,s=e.pinnedStartIndex,e=e.groupItem;if(r._pagingGetCostList.push(Zt(u,!1)),v.l("".concat(c," ok. completeFlag:").concat(t," count:").concat(n.length," cost:").concat(Zt(u))),r._convGroupHandler.onConvGroupListSynced(e),0<n.length&&(e=r._getConvOptions(n),r._pagingConvIDMap=new Map([].concat(D(r._pagingConvIDMap),D(e.map(function(e){return [e.conversationID,1]})))),r._updateLocalConvList({conversationOptionsList:e,isFromGetConversations:!0,updateUnreadCount:!0}),r.isLoggedIn()&&r.emitConvUpdate()),!r._isReady){if(!r.isLoggedIn())return Sn();r.triggerReady();}return r._pagingTs=o,r._pagingStartIdx=i,r._pagingPinnedTs=a,r._pagingPinnedStartIdx=s,1!==t?r._pagingGetConvList():(r._handleGroupAtTipsList(),r._convGroupHandler.getRemoteConvGroupList(),Sn())}).catch(function(e){throw r.isLoggedIn()&&(r._isReady||(v.w("".concat(c," failed. error:"),e),r.triggerReady())),e})}},{key:"_updateLocalConvList",value:function(e){var t=e.isFromGetConversations,n=Date.now(),e=this._getTmpConvListMapping(e).newConvList;this._convMap=new Map(this._sortConvList(D(this._convMap))),t||this._updateUserOrGroupProfile(e),v.l("".concat(this._n,"._updateLocalConvList cost:").concat(Zt(n)));}},{key:"_getTmpConvListMapping",value:function(e){for(var t=e.conversationOptionsList,l=e.isFromGetConversations,d=e.isInstantMessage,p=e.isUnreadC2CMessage,_=void 0!==p&&p,h=e.updateUnreadCount,g=[],f=[],m=this.get(7),v=this.get(8),I=this.isIntl(),M=this.isUsingChatCore(),n=0,y=t.length;n<y;n++){var o=new li(t[n],I,M),i=o.conversationID,a=o.type;if(!this._isNonExistentAccount(i)){if(this._convMap.has(i)){var s=this._convMap.get(i);if(l&&a!==R.CONV_TOPIC){this._convMap.set(i,o),a===R.CONV_C2C?o.unreadCount=s.unreadCount:a===R.CONV_GROUP&&(o.groupProfile=JSON.parse(JSON.stringify(s.groupProfile)));continue}var r=["unreadCount","allowType","adminForbidType","payload"],c=(!1===d&&r.push("lastMessage"),"boolean"==typeof d&&r.push("isPinned"),t[n].lastMessage),u=!A(c);u||t[n].type===R.CONV_TOPIC||this._onLastMsgNotExist(t[n]),A(d)&&u&&null===s.lastMessage.payload&&(s.lastMessage.payload=c.payload),Je(s.lastMessage.revoker)||(s.lastMessage.revoker=null),rt(s,o,r,[null,void 0,"",0,NaN]),!0===h&&s.updateUnreadCount({nextUnreadCount:o.unreadCount,isFromGetConversations:l,isUnreadC2CMessage:_}),d&&u&&(c.payload&&(s.lastMessage.payload=c.payload),s.type===R.CONV_GROUP&&(s.lastMessage.nameCard=c.nameCard,s.lastMessage.nick=c.nick)),u&&s.lastMessage.cloudCustomData!==c.cloudCustomData&&(s.lastMessage.cloudCustomData=c.cloudCustomData||"");}else a===R.CONV_GROUP&&m?(r=o.groupProfile.groupID,(u=m.getLocalGroupProfile(r))&&(o.groupProfile=u,!0===h&&o.updateUnreadCount({nextUnreadCount:0}))):a===R.CONV_C2C&&(s=i.replace(R.CONV_C2C,""),v&&v.isMyFriend(s)&&(o.remark=v.getFriendRemark(s))),g.push(o),this._convMap.set(i,o);this._convMap.get(i).type===R.CONV_TOPIC&&f.push(this._convMap.get(i));}}for(var C=this.get(10),T=0,D=f.length;T<D;T++){var E=f[T],L=E.conversationID,E=E.groupAtInfoList;Je(E)||C.onAtInfoUpdated({topicID:L.replace(R.CONV_GROUP,""),groupAtInfoList:E});}return {newConvList:g}}},{key:"_onLastMsgNotExist",value:function(e){new M("lastMsgNotExist").setMessage(JSON.stringify(e)).end();}},{key:"_sortConvList",value:function(e){var t=[],n=[],o=[],i=[];return e.forEach(function(e){(!0===e[1].isPinned?Je(e[1].lastMessage.lastTime)?n:t:Je(e[1].lastMessage.lastTime)?i:o).push(e);}),t.sort(function(e,t){return t[1].lastMessage.lastTime-e[1].lastMessage.lastTime}).concat(n).concat(o.sort(function(e,t){return t[1].lastMessage.lastTime-e[1].lastMessage.lastTime})).concat(i)}},{key:"_sortConvListAndEmitEvent",value:function(){this._convMap=new Map(this._sortConvList(D(this._convMap))),this.emitConvUpdate(!0,!1);}},{key:"_updateUserOrGroupProfile",value:function(e){var n,o,t,i,a=this;0!==e.length&&(n=[],o=[],t=this.get(4),i=this.get(7),e.forEach(function(e){var t;e.type===R.CONV_C2C?n.push(e.toAccount):e.type===R.CONV_GROUP&&(t=e.toAccount,i.hasLocalGroup(t)?e.groupProfile=i.getLocalGroupProfile(t):o.push(t));}),v.l("".concat(this._n,"._updateUserOrGroupProfile userIDList:").concat(n," groupIDList:").concat(o)),0<n.length&&t.getUserProfile({userIDList:n}).then(function(e){e=e.data;nt(e)?e.forEach(function(e){a._doUpdateUserProfile("".concat(R.CONV_C2C).concat(e.userID),e);}):a._doUpdateUserProfile("".concat(R.CONV_C2C).concat(e.userID),e);}),0<o.length&&i.getGroupProfileAdvance({groupIDList:o,responseFilter:{groupBaseInfoFilter:["Type","Name","FaceUrl"]}}).then(function(e){var e=e.data.successGroupList,n=!1;e.forEach(function(e){var t="".concat(R.CONV_GROUP).concat(e.groupID);a._convMap.has(t)&&(t=a._convMap.get(t),rt(t.groupProfile,e,[],[null,void 0,"",0,NaN]),!t.subType&&e.type&&(t.subType=e.type),n=!0);}),n&&a.emitConvUpdate();}));}},{key:"_doUpdateUserProfile",value:function(e,t){this.hasLocalConversation(e)&&(this.getLocalConversation(e).userProfile=t,this.emitConvUpdate());}},{key:"_getConvOptions",value:function(e){var n=this,o=[],e=e.filter(function(e){var t=e.type,e=e.userID;return 1===t&&!n._isNonExistentAccount(e)||2===t}),i=this.getMyUserID(),e=e.map(function(e){var t;return A(e.lastMsg)&&(e.lastMsg={elements:[]}),1===e.type?(t={userID:e.userID,nick:e.peerNick,avatar:e.peerAvatar},o.push(t),{conversationID:"".concat(R.CONV_C2C).concat(e.userID),type:R.CONV_C2C,lastMessage:{lastTime:e.time,lastSequence:e.sequence,fromAccount:e.lastC2CMsgFromAccount,type:e.lastMsg.elements[0]?e.lastMsg.elements[0].type:null,payload:e.lastMsg.elements[0]?n._amendLayersOverLimitProp(e.lastMsg.elements[0].content):null,cloudCustomData:e.lastMsg.cloudCustomData||"",isRevoked:8===e.lastMessageFlag,onlineOnlyFlag:!1,nick:"",nameCard:"",version:0,isPeerRead:e.lastC2CMsgFromAccount===i&&e.time<=e.c2cPeerReadTime,revoker:e.lastMsg.revokerInfo?e.lastMsg.revokerInfo.revoker:null},unreadCount:0,userProfile:new si(t),peerReadTime:e.c2cPeerReadTime,isPinned:1===e.isPinned,customData:e.customMark||"",markList:Wt(e.standardMark),conversationGroupList:n._convGroupHandler.getConvGroupListByID(e.contactGroupId),remark:e.friendRemark||"",messageRemindType:n._transMsgRemindType(e.messageRemindType)}):{conversationID:"".concat(R.CONV_GROUP).concat(e.groupID),type:R.CONV_GROUP,lastMessage:y(y({lastTime:e.time,lastSequence:e.sequence,fromAccount:e.msgGroupFromAccount},n._patchTypeAndPayload(e)),{},{cloudCustomData:e.lastMsg.cloudCustomData||"",isRevoked:2===e.lastMessageFlag,onlineOnlyFlag:!1,nick:e.senderNick||"",nameCard:e.senderNameCard||"",revoker:e.lastMsg.revokerInfo?e.lastMsg.revokerInfo.revoker:null}),groupProfile:new ui({groupID:e.groupID,name:e.groupNick,avatar:e.groupImage,type:e.groupType,nextMessageSeq:e.nextMessageSeq}),unreadCount:n._computeGroupUnreadCount(e),peerReadTime:0,isPinned:1===e.isPinned,version:0,customData:e.customMark||"",markList:Wt(e.standardMark),conversationGroupList:n._convGroupHandler.getConvGroupListByID(e.contactGroupId),messageRemindType:n._transMsgRemindType(e.messageRemindType)}});return 0<o.length&&this.get(4).onConvProfileUpdated(o),e}},{key:"_transMsgRemindType",value:function(e){var t="";return 0===e?t=R.MSG_REMIND_ACPT_AND_NOTE:1===e?t=R.MSG_REMIND_DISCARD:2===e?t=R.MSG_REMIND_ACPT_NOT_NOTE:3===e&&(t=R.NOT_RECEIVE_OFFLINE_PUSH_EXCEPT_AT),t}},{key:"_computeGroupUnreadCount",value:function(e){var t=e.unreadCount,e=e.noUnreadCount,t=(void 0===t?0:t)-(void 0===e?0:e);return 0<t?t:0}},{key:"_patchTypeAndPayload",value:function(e){var e=e.lastMsg,t=e.event,n=e.elements,n=void 0===n?[]:n,e=e.groupTips,e=void 0===e?{}:e;return A(void 0===t?void 0:t)||Je(e)?{type:n[0]?n[0].type:null,payload:n[0]?this._amendLayersOverLimitProp(n[0].content):null}:((t=new ko(e)).setElement({type:R.MSG_GRP_TIP,content:y(y({},e.elements),{},{groupProfile:e.groupProfile})}),n=JSON.parse(JSON.stringify(t.payload)),t=null,{type:R.MSG_GRP_TIP,payload:n})}},{key:"_amendLayersOverLimitProp",value:function(e){var t=e.layersOverLimit;return 0===t?e.layersOverLimit=!1:1===t&&(e.layersOverLimit=!0),e}},{key:"getLocalMessageList",value:function(e){return this._msgListHandler.getLocalMsgList(e)}},{key:"deleteLocalMessage",value:function(e){e instanceof ko&&this._msgListHandler.remove(e);}},{key:"onConvDeleted",value:function(e){nt(e)&&(e=e.map(function(e){var t=e.type,n=e.userID,e=e.groupID;return 1===t?"".concat(R.CONV_C2C).concat(n):2===t?"".concat(R.CONV_GROUP).concat(e):void 0}),v.l("".concat(this._n,".onConvDeleted convIDList:").concat(e)),this.deleteLocalConvList(e));}},{key:"onConvPinnedStatus",value:function(e,i){var a,s=this;nt(e)&&(a=!1,e.forEach(function(e){var t,n=e.type,o=e.userID,e=e.groupID;1===n?t=s.getLocalConversation("".concat(R.CONV_C2C).concat(o)):2===n&&(t=s.getLocalConversation("".concat(R.CONV_GROUP).concat(e))),t&&(v.l("".concat(s._n,".onConvPinnedStatus convID:").concat(t.conversationID," localPinned:").concat(t.isPinned," remotePinned:").concat(i)),i?t.isPinned||(t.isPinned=!0,a=!0):t.isPinned&&(t.isPinned=!1,a=!0));}),a&&this._sortConvListAndEmitEvent());}},{key:"getMessageList",value:function(e){var r=this,c=e.conversationID,t=e.nextReqMessageID,e=e.count,u="".concat(this._n,".getMessageList"),n=this.getLocalConversation(c),o="";if(n&&n.groupProfile&&(o=n.groupProfile.type),Lt(o))return v.l("".concat(u," not available in ").concat(o,". convID:").concat(c)),Sn({messageList:[],nextReqMessageID:"",isCompleted:!0});(A(e)||15<e)&&(e=15),t||this._isMeInCommunity(c)||this.clearMemMsg(c);var l=this._computeRemainingCount({conversationID:c,nextReqMessageID:t}),n=this._completedMap.has(c);if(v.l("".concat(u," convID:").concat(c," isEverCleared:").concat(this._isEverCleared(c)," nextReqMessageID:").concat(t)+" remainingCount:".concat(l," count:").concat(e," isCompleted:").concat(n)),this._needGetHistory({conversationID:c,remainingCount:l,count:e}))return this.getHistoryMessages({conversationID:c,nextReqMessageID:t,count:20}).then(function(e){var t=e.nextReqID,n=e.storedMessageList,o=e.assembledMessageList,e=e.isPullingCompleted,i=r._completedMap.has(c),a=n,s=(0<l&&(a=r._msgListHandler.getLocalMsgList(c).slice(0,n.length+l)),{nextReqMessageID:void 0,messageList:void 0,isCompleted:void 0}),n=(r._isEverCleared(c)?(s.nextReqMessageID=t,s.messageList=o,s.isCompleted=e):(s.nextReqMessageID=i?"":t,s.messageList=a,s.isCompleted=i),s.messageList.filter(function(e){return e.isRevoked})||[]),o=s.messageList.map(function(e){return e.sequence});return v.l("".concat(u," ret.nextReqMessageID:").concat(s.nextReqMessageID," ret.isCompleted:").concat(s.isCompleted," sequenceList:"),o),nt(n)&&0!==n.length?r.updateRevokerInfo(n).then(function(e){return e.forEach(function(t){var n=t.revokerInfo;s.messageList=s.messageList.map(function(e){return e.ID===t.ID&&n&&(e.revokeReason=n.reason||"",e.revokerInfo={userID:n.revoker||e.revoker,nick:n.nick,avatar:n.avatar}),e});}),Ln(s)}):Ln(s)});this.modifyMessageList(c);o=this._getMsgListFromMem({conversationID:c,nextReqMessageID:t,count:e});return Sn(o)}},{key:"_isEverCleared",value:function(e){return this._everClearedMap.has(e)}},{key:"_getMsgListFromMem",value:function(e){var t=e.conversationID,n=e.nextReqMessageID,e=e.count,o="".concat(this._n,"._getMsgListFromMem"),i=this._msgListHandler.getLocalMsgList(t),a=i.length,s=Rt(t),r=0,c={isCompleted:!1,nextReqMessageID:"",messageList:[]},e=(n?(r=s?i.findIndex(function(e){return e.ID===n}):i.findIndex(function(e){return e.sequence+""===n}))>e?(c.messageList=i.slice(r-e,r),c.nextReqMessageID=s?i[r-e].ID:i[r-e].sequence+""):(c.messageList=i.slice(0,r),c.isCompleted=!0):e<a?(c.messageList=i.slice(r=a-e,a),c.nextReqMessageID=s?i[r].ID:i[r].sequence+""):(c.messageList=i.slice(0,a),c.isCompleted=!0),c.messageList.map(function(e){return e.sequence}));return v.l("".concat(o," convID:").concat(t)+" ret.nextReqMessageID:".concat(c.nextReqMessageID," ret.isCompleted:").concat(c.isCompleted," sequenceList:").concat(e)),c}},{key:"getMessageListHopping",value:function(e){var t,n,o=e.conversationID,i=e.sequence,a=e.time,s=e.count,e=e.direction,e=void 0===e?0:e;return (A(s)||15<s)&&(s=15),o.startsWith(R.CONV_C2C)?(t=this.get(6),n=o.replace(R.CONV_C2C,""),t.getRoamingMessagesHopping({peerAccount:n,time:a,count:s,direction:e})):o.startsWith(R.CONV_GROUP)?(t=this.get(7),n=o.replace(R.CONV_GROUP,""),t.getRoamingMessagesHopping({groupID:n,sequence:i,count:s,direction:e})):void 0}},{key:"_computeRemainingCount",value:function(e){var t=e.conversationID,n=e.nextReqMessageID,e=this._msgListHandler.getLocalMsgList(t),o=e.length;if(v.l("".concat(this._n,"._computeRemainingCount convID:").concat(t," nextReqMessageID:").concat(n," length:").concat(o)),!n)return o;o=0;return Rt(t)?o=e.findIndex(function(e){return e.ID===n}):At(t)&&(o=-1!==n.indexOf("-")?e.findIndex(function(e){return e.ID===n}):e.findIndex(function(e){return e.sequence+""===n})),o=-1===o?0:o}},{key:"_needGetHistory",value:function(e){var t=e.conversationID,n=e.remainingCount,e=e.count,o=this.getLocalConversation(t),i="";if(o&&o.groupProfile&&(i=o.groupProfile.type),Ot(t)||Lt(i))return !1;if(this._isEverCleared(t))return !0;o=n<=e&&!this._completedMap.has(t);return v.l("".concat(this._n,"._needGetHistory convID:").concat(t," ret:").concat(o)),o}},{key:"_isTopicConv",value:function(e){e=e.replace(R.CONV_GROUP,"");return kt(e)}},{key:"getHistoryMessages",value:function(e){var t=e.conversationID,n=e.count,e=e.nextReqMessageID;if(t===R.CONV_SYSTEM)return Sn();var o,i,a=15,n=(20<n&&(a=20),null);if(Rt(t))return c=0,o="",i=!1,r=this._roamingMsgKeyAndTimeMap.has(t),e&&(i=!0,r?(c=this._roamingMsgKeyAndTimeMap.get(t).lastMessageTime,o=this._roamingMsgKeyAndTimeMap.get(t).messageKey):(s=this._msgListHandler.findMessage(e))&&(c=s.time,v.l("".concat(this._n,".getHistoryMessages convID:").concat(t," isRelayInfoExisted:").concat(r," lastMessageTime:").concat(c)))),(n=this.get(6)).getRoamingMessage({conversationID:t,peerAccount:t.replace(R.CONV_C2C,""),count:a,lastMessageTime:i?c:0,messageKey:i?o:""});if(At(t)){if(!(n=this.get(7)))return C({code:T.NO_MODULE});var s=t.replace(R.CONV_GROUP,""),r=null,c=(this._convMap.has(t)&&!kt(s)&&(r=this._convMap.get(t).lastMessage),0);return e?c=Number(e):r&&(c=r.lastSequence),n.getRoamingMessage({conversationID:t,groupID:s,count:a,sequence:c})}return Sn()}},{key:"patchConvLastMessage",value:function(e){var t,n,o=1<arguments.length&&void 0!==arguments[1]&&arguments[1],i=this.getLocalConversation(e);i&&(t=(n=i.lastMessage).messageForShow,n=n.payload,!(Je(t)||Je(n)||o)||0!==(t=this._msgListHandler.getLocalMsgList(e)).length&&(n=t[t.length-1],v.l("".concat(this._n,".patchConvLastMessage bForceUpdate:").concat(o," convID:").concat(e," payload:"),n.payload),i.updateLastMessage(n)));}},{key:"onRoamingMessage",value:function(){for(var e,t,n=0<arguments.length&&void 0!==arguments[0]?arguments[0]:[],o=1<arguments.length?arguments[1]:void 0,u=!(2<arguments.length&&void 0!==arguments[2])||arguments[2],l=3<arguments.length?arguments[3]:void 0,i=o.startsWith(R.CONV_C2C)?R.CONV_C2C:R.CONV_GROUP,a=null,s=[],o=[],r=0,d=n.length,c=i===R.CONV_GROUP,p=this.getFileDownloadProxy(),_=this.getDowloadFileAuthKey(),h=nt(l),g=this.get(17).getFileDNList(),f=function(){c?--r:++r;},m=function(){return c?d<=r:r<d},r=c?n.length-1:0,d=c?0:n.length;m();f())1!==n[r].isPlaceMessage&&((a=new ko(n[r])).to=n[r].to,i!==R.CONV_GROUP||A(n[r].topicID)||(a.to=n[r].topicID),a.isSystemMessage=!!n[r].isSystemMessage,a.conversationType=i,e=4===n[r].event?{type:R.MSG_GRP_TIP,content:y(y({},n[r].elements),{},{groupProfile:n[r].groupProfile})}:n[r].elements,c||a.setNickAndAvatar({nick:n[r].nick,avatar:n[r].avatar}),Je(e)?((t=new M("emptyMessageBody")).setMessage("from:".concat(a.from," to:").concat(a.to," sequence:").concat(a.sequence," event:").concat(n[r].event)),t.setLevel("warning").end()):(a.setElement(e,p,_,g),a.reInitialize(this.getMyUserID()),s.push(a),h&&l.push(a)));return f=m=null,u?(this._msgListHandler.unshift(s,o),s=null,o):(o=null,s)}},{key:"findMessage",value:function(e){return this._msgListHandler.findMessage(e)}},{key:"_isMeInCommunity",value:function(e){var t=!0;return this._isTopicConv(e)&&(e=Bt(e.replace(R.CONV_GROUP,"")),this.get(7).hasLocalGroup(e)||(t=!1,v.l("".concat(this._n,"._isMeInCommunity groupID:").concat(e," ret:").concat(t)))),t}},{key:"deleteTopicRoamingInfo",value:function(e){var t=this;St({groupID:e})&&this._msgListHandler.getTopicConvIDList(e).forEach(function(e){t.clearMemMsg(e);});}},{key:"deleteGroupRoamingInfo",value:function(e){e="".concat(R.CONV_GROUP).concat(e);0<this._msgListHandler.getLocalMsgList(e).length&&this.clearMemMsg(e);}},{key:"setMessageRead",value:function(e){var t=e.conversationID,n=this.getLocalConversation(t),e="".concat(this._n,".setMessageRead");if(v.l("".concat(e," convID:").concat(t," unreadCount:").concat(n?n.unreadCount:0)),!n)return Sn();if(n.type!==R.CONV_GROUP&&n.type!==R.CONV_TOPIC||Je(n.groupAtInfoList)||this.deleteGroupAtTips(t),0===n.unreadCount)return Sn();var o=this._msgListHandler.getLocalLastMsg(t),i=n.lastMessage.lastTime,a=this._msgListHandler.getLocalMaxTime(t),a=(i<a&&(v.l("".concat(e," update lastMessageTime from ").concat(i," to ").concat(a)),i=a),this._msgListHandler.getLocalMaxSeq(t)),s=n.lastMessage.lastSequence,r=(s<a&&(v.l("".concat(e," update lastMessageSeq from ").concat(s," to ").concat(a)),s=a),n.type===R.CONV_TOPIC&&A(o)&&(e=this.get(10),o=Bt(a=t.replace(R.CONV_GROUP,"")),(e=e.getLocalTopic(o,a))&&(s=e.nextMessageSeq-1)),null);switch(n.type){case R.CONV_C2C:return (r=this.get(6))?r.setMessageRead({conversationID:t,lastMessageTime:i}):C({code:T.NO_MODULE});case R.CONV_GROUP:case R.CONV_TOPIC:return (r=this.get(7))?r.setMessageRead({conversationID:t,lastMessageSeq:s}):C({code:T.NO_MODULE});case R.CONV_SYSTEM:return n.unreadCount=0,this.emitConvUpdate(!0,!1),Sn();default:return Sn()}}},{key:"setAllMessageRead",value:function(){var t=this,n=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},e="setAllMessageRead",o="".concat(this._n,".").concat(e),i=(n.scope||(n.scope=R.READ_ALL_MSG),v.l("".concat(o," options:"),n),this._createSetAllMessageReadPack(n));if(0===i.readAllC2CMessage&&0===i.groupMessageReadInfoList.length)return Sn();var a=new M(e);return this.req({P:I.SET_ALL_MSG_READ,data:i}).then(function(e){e=e.data,e=t._handleAllMsgRead(e);return a.setMessage("scope:".concat(n.scope," failureGroups:").concat(JSON.stringify(e))).end(),Sn()}).catch(function(e){return a.setError(e).end(),v.w("".concat(o," failed. error:"),e),C({code:e&&e.code?e.code:T.MSG_UNREAD_ALL_FAIL,message:e&&e.message?e.message:void 0})})}},{key:"setConvCustomData",value:function(e){return this._convGroupHandler.setConvCustomData(e)}},{key:"markConv",value:function(e){return this._convGroupHandler.markConv(e)}},{key:"getConvGroupList",value:function(){return this._convGroupHandler.getLocalConvGroupList()}},{key:"createConvGroup",value:function(e){return this._convGroupHandler.createConvGroup(e)}},{key:"deleteConvGroup",value:function(e){return this._convGroupHandler.deleteConvGroup(e)}},{key:"renameConvGroup",value:function(e){return this._convGroupHandler.renameConvGroup(e)}},{key:"addConvsToGroup",value:function(e){return this._convGroupHandler.addConvsToGroup(e)}},{key:"deleteConvsFromGroup",value:function(e){return this._convGroupHandler.deleteConvsFromGroup(e)}},{key:"onConvMarkUpdated",value:function(e){this._convGroupHandler.onConvMarkUpdated(e);}},{key:"onConvGroupCreated",value:function(e){this._convGroupHandler.onConvGroupCreated(e);}},{key:"onConvGroupDeleted",value:function(e){this._convGroupHandler.onConvGroupDeleted(e);}},{key:"onConvGroupNameUpdated",value:function(e){this._convGroupHandler.onConvGroupNameUpdated(e);}},{key:"onConvInGroupUpdated",value:function(e){this._convGroupHandler.onConvInGroupUpdated(e);}},{key:"onConvAddedToOrDeletedFromGroup",value:function(e){this._convGroupHandler.onConvAddedToOrDeletedFromGroup(e);}},{key:"_getConvLastMessageSeq",value:function(e){var t=this._msgListHandler.getLocalLastMsg(e.conversationID),e=e.lastMessage.lastSequence;return e=t&&e<t.sequence?t.sequence:e}},{key:"_getConvLastMessageTime",value:function(e){var t=this._msgListHandler.getLocalLastMsg(e.conversationID),e=e.lastMessage.lastTime;return e=t&&e<t.time?t.time:e}},{key:"_createSetAllMessageReadPack",value:function(e){var t,n={readAllC2CMessage:0,groupMessageReadInfoList:[]},o=e.scope,i=N(this._convMap);try{for(i.s();!(t=i.n()).done;){var a,s=m(t.value,2)[1];if(0<s.unreadCount)if(s.type===R.CONV_C2C&&0===n.readAllC2CMessage){if(o===R.READ_ALL_MSG)n.readAllC2CMessage=1;else if(o===R.READ_ALL_C2C_MSG){n.readAllC2CMessage=1;break}}else s.type!==R.CONV_GROUP||o!==R.READ_ALL_GROUP_MSG&&o!==R.READ_ALL_MSG||(a=this._getConvLastMessageSeq(s),n.groupMessageReadInfoList.push({groupID:s.groupProfile.groupID,messageSequence:a}));}}catch(e){i.e(e);}finally{i.f();}return n}},{key:"onPushedAllMessageRead",value:function(e){this._handleAllMsgRead(e);}},{key:"_handleAllMsgRead",value:function(e){var t=e.groupMessageReadInfoList,e=e.readAllC2CMessage,t=this._parseGroupReadInfo(t);return 1<=this._updateAllConvUnreadCount({readAllC2CMessage:e})&&this.emitConvUpdate(!0,!1),t}},{key:"_parseGroupReadInfo",value:function(e){var t=[];if(e&&e.length)for(var n=0,o=e.length;n<o;n++){var i=e[n],a=i.groupID,s=i.sequence,r=i.retCode,i=i.lastMessageSeq;A(r)?this._remoteGroupReadSeqMap.set(a,i):(this._remoteGroupReadSeqMap.set(a,s),0!==r&&t.push("".concat(a,"-").concat(s,"-").concat(r)));}return t}},{key:"_updateAllConvUnreadCount",value:function(l){var e,d=l.readAllC2CMessage,t=0,n=N(this._convMap);try{for(n.s();!(e=n.n()).done;){var o,i,a,s,r=m(e.value,2),c=r[0],u=r[1];1<=u.unreadCount&&(1===d&&u.type===R.CONV_C2C?(o=this._getConvLastMessageTime(u),this.updateIsReadAfterReadReport({conversationID:c,lastMessageTime:o})):u.type===R.CONV_GROUP&&(i=c.replace(R.CONV_GROUP,""),this._remoteGroupReadSeqMap.has(i)&&(a=this._remoteGroupReadSeqMap.get(i),s=this._getConvLastMessageSeq(u),this.updateIsReadAfterReadReport({conversationID:c,remoteReadSequence:a}),a<=s&&this._remoteGroupReadSeqMap.delete(i))),this.updateUnreadCount(c,!1)&&(t+=1));}}catch(e){n.e(e);}finally{n.f();}return t}},{key:"isRemoteRead",value:function(e){var t,n=e.conversationID,e=e.sequence,o=n.replace(R.CONV_GROUP,""),i=!1;return this._remoteGroupReadSeqMap.has(o)&&(e<=(t=this._remoteGroupReadSeqMap.get(o))&&(i=!0,v.l("".concat(this._n,".isRemoteRead convID:").concat(n," msgSeq:").concat(e," remoteReadSeq:").concat(t))),t+10<=e&&this._remoteGroupReadSeqMap.delete(o)),i}},{key:"updateIsReadAfterReadReport",value:function(e){var t=e.conversationID,n=e.lastMessageSeq,o=e.lastMessageTime,i=this._msgListHandler.getLocalMsgList(t);if(0!==i.length)for(var a,s=i.length-1;0<=s;s--)if(a=i[s],!(o&&a.time>o||n&&a.sequence>n)){if("in"===a.flow&&a.isRead)break;a.setIsRead(!0);}}},{key:"updateUnreadCount",value:function(e){var t,n=!(1<arguments.length&&void 0!==arguments[1])||arguments[1],o=!1,i=this.getLocalConversation(e),a=this._msgListHandler.getLocalMsgList(e);if(i)return (t=i.unreadCount)!==(a=a.filter(function(e){return !e.isRead&&!e._onlineOnlyFlag&&!e.isDeleted}).length)&&(i.unreadCount=a,o=!0,v.l("".concat(this._n,".updateUnreadCount from ").concat(t," to ").concat(a,", convID:").concat(e)),!0===n&&this.emitConvUpdate(!0,!1)),o&&i.type===R.CONV_TOPIC&&(t=i.unreadCount,a=this.get(10),n=e.replace(R.CONV_GROUP,""),a.onUnreadCountUpdatedFromConv(n,t)),o}},{key:"clearGroupAtInfoList",value:function(e){var t,n=!(1<arguments.length&&void 0!==arguments[1])||arguments[1],o=this.getLocalConversation(e);o&&0<o.groupAtInfoList.length&&(o.clearGroupAtInfoList(),v.l("".concat(this._n,".clearGroupAtInfoList convID:").concat(e)),o.type===R.CONV_TOPIC&&(o=o.groupAtInfoList,t=this.get(10),e=e.replace(R.CONV_GROUP,""),t.onAtInfoUpdated({topicID:e,groupAtInfoList:o})),!0===n&&this.emitConvUpdate(!0,!1));}},{key:"updateReadReceiptInfo",value:function(e){var a,s,o,r=this,t=e.userID,i=void 0===t?void 0:t,t=e.groupID,c=void 0===t?void 0:t,t=e.readReceiptList,e=e.timestamp,u=void 0===e?0:e;Je(t)||(a=[],A(i)?A(c)||(s="".concat(R.CONV_GROUP).concat(c),t.forEach(function(e){var t=e.tinyID,n=e.clientTime,o=e.random,i=e.readCount,e=e.unreadCount,t="".concat(t,"-").concat(n,"-").concat(o),n=r._msgListHandler.getLocalMsg(s,t)||r._msgListHandler.getHoppingMsg(s,t),o={groupID:c,messageID:t,readCount:0,unreadCount:0};n&&(Qe(i)&&(n.readReceiptInfo.readCount=i,o.readCount=i),Qe(e)&&(n.readReceiptInfo.unreadCount=e,o.unreadCount=e),a.push(o));})):(o="".concat(R.CONV_C2C).concat(i),t.forEach(function(e){var t=e.tinyID,n=e.clientTime,e=e.random,t="".concat(t,"-").concat(n,"-").concat(e),n=r._msgListHandler.getLocalMsg(o,t)||r._msgListHandler.getHoppingMsg(o,t);n&&!n.readReceiptInfo.isPeerRead&&(n.readReceiptInfo.isPeerRead=!0,n.readReceiptInfo.timestamp=u,a.push({userID:i,messageID:t,isPeerRead:!0,timestamp:u}));})),0<a.length&&this.emitOEvt(G.MESSAGE_READ_RECEIPT_RECEIVED,a));}},{key:"updateIsRead",value:function(e){var t=this.getLocalConversation(e),n=this.getLocalMessageList(e);if(t&&0!==n.length&&!Ot(t.type)){for(var o=[],i=0,a=n.length;i<a;i++)"in"!==n[i].flow?"out"!==n[i].flow||n[i].isRead||n[i].setIsRead(!0):o.push(n[i]);var s=0;s=t.type===R.CONV_C2C?(e=o.slice(-t.unreadCount).filter(function(e){return e.isRevoked}).length,o.length-t.unreadCount-e):o.length-t.unreadCount;for(var r=0;r<s&&!o[r].isRead;r++)o[r].setIsRead(!0);}}},{key:"deleteGroupAtTips",value:function(e){var t=this,n="".concat(this._n,".deleteGroupAtTips"),o=(v.l("".concat(n)),this._convMap.get(e));if(!o)return Promise.resolve();var i=o.groupAtInfoList;if(0===i.length)return Promise.resolve();var o=void 0,a=(e.startsWith(R.CONV_GROUP)&&(o=e.replace(R.CONV_GROUP,"")),D(i));if((St({groupID:o})||kt(o))&&0===(a=i.filter(function(e){return !e.atTypeArray.includes(R.CONV_AT_ALL)})).length)return this.clearGroupAtInfoList(e,!1),Promise.resolve();var s=this.getMyUserID();return this.req({P:I.DEL_GROUP_AT_TIPS,data:{messageListToDelete:a.map(function(e){return {from:e.from,to:s,messageSeq:e.__sequence,messageRandom:e.__random,groupID:A(e.topicID)?e.groupID:e.topicID}})}}).then(function(){return v.l("".concat(n," ok. count:").concat(i.length)),t.clearGroupAtInfoList(e,!1),Promise.resolve()}).catch(function(e){return v.e("".concat(n," failed. error:"),e),C(e)})}},{key:"appendToMessageList",value:function(e){return this._msgListHandler.pushIn(e)}},{key:"setMessageRandom",value:function(e){this._sll.set(e.random);}},{key:"deleteMessageRandom",value:function(e){this._sll.delete(e.random);}},{key:"pushIntoMessageList",value:function(e,t,n){return !(!this._msgListHandler.pushIn(t,n)||this._sll.has(t.random)&&!n||(e.push(t),0))}},{key:"revoke",value:function(e,t,n){return this._msgListHandler.revoke(e,t,n)}},{key:"getPeerReadTime",value:function(e){return this._peerReadTimeMap.get(e)}},{key:"recordPeerReadTime",value:function(e,t){(!this._peerReadTimeMap.has(e)||this._peerReadTimeMap.get(e)<t)&&this._peerReadTimeMap.set(e,t);}},{key:"updateMsgIsPeerReadProp",value:function(e,t){var n;e.startsWith(R.CONV_C2C)&&0<t&&(0<(n=this._msgListHandler.updateMsgIsPeerReadProp(e,t)).length&&this.emitOEvt(G.MESSAGE_READ_BY_PEER,n),this._convMap.has(e)&&(Je(n=this._convMap.get(e).lastMessage)||n.fromAccount===this.getMyUserID()&&n.lastTime<=t&&!n.isPeerRead&&(n.isPeerRead=!0,this.emitConvUpdate(!0,!1))));}},{key:"updateMsgIsModifiedProp",value:function(e){this._msgListHandler.updateMsgIsModifiedProp(e);}},{key:"setCompleted",value:function(e){v.l("".concat(this._n,".setCompleted convID:").concat(e)),this._completedMap.set(e,!0);}},{key:"updateRoamingMsgKeyAndTime",value:function(e,t,n){this._roamingMsgKeyAndTimeMap.set(e,{messageKey:t,lastMessageTime:n});}},{key:"getConvList",value:function(t){var n,o=this,i="".concat(this._n,".").concat("getConvList"),e="pagingStatus:".concat(this._pagingStatus,", local conversation count:").concat(this._convMap.size,", options:").concat(JSON.stringify(t));if(v.l("".concat(i,". ").concat(e)),this._pagingStatus===Un)return (n=new M("getConvList")).setMessage(e),this.syncConvList().then(function(){n.end();var e=o._getConvList(t);return Ln({conversationList:e,isSyncCompleted:o._isSyncCompleted()})}).catch(function(e){return n.setError(e).end(),v.e("".concat(i," failed. error:"),e),C(e)});e=this._getConvList(t);return v.l("".concat(i,". returned conversation count:").concat(e.length)),Sn({conversationList:e,isSyncCompleted:this._isSyncCompleted()})}},{key:"_getConvList",value:function(t){var n,o,i,a,s,r=this;return A(t)?this.getLocalConvList():nt(t)?0===t.length?[]:this.getLocalConvList().filter(function(e){return t.includes(e.conversationID)}):et(t)?(n=t.type,o=t.markType,i=t.groupName,a=t.hasUnreadCount,s=t.hasGroupAtInfo,this.getLocalConvList().filter(function(e){return r._filterType(e,n)&&r._filterMarkType(e,o)&&r._filterGroupName(e,i)&&r._filterUnreadCount(e,a)&&r._filterGroupAtInfo(e,s)})):[]}},{key:"_filterType",value:function(e,t){return t!==R.CONV_C2C&&t!==R.CONV_GROUP||e.type===t}},{key:"_filterGroupName",value:function(e,t){return !ft(t)||(""===t?0===e.conversationGroupList.length:e.conversationGroupList.includes(t))}},{key:"_filterMarkType",value:function(e,t){return !Qe(t)||(0===t?0===e.markList.length:e.markList.includes(t))}},{key:"_filterUnreadCount",value:function(e,t){var n=!0;return !0===t?n=1<=e.unreadCount:!1===t&&(n=0===e.unreadCount),n}},{key:"_filterGroupAtInfo",value:function(e,t){var n=!0;return !0===t?n=1<=e.groupAtInfoList.length:!1===t&&(n=0===e.groupAtInfoList.length),n}},{key:"_handleC2CPeerReadTime",value:function(){var e,t=N(this._convMap);try{for(t.s();!(e=t.n()).done;){var n=m(e.value,2),o=n[0],i=n[1];i.type===R.CONV_C2C&&this.recordPeerReadTime(o,i.peerReadTime);}}catch(e){t.e(e);}finally{t.f();}}},{key:"_isPagingGetGroupListCompleted",value:function(){var e=this.get(7);return !e||e.isPagingGetCompleted()}},{key:"_getLocalGroupCount",value:function(){var e=this.get(7);return e?e.getLocalGroupList().length:0}},{key:"_hasLocalGroup",value:function(e){var t=this.get(7);return !!t&&t.hasLocalGroup(e.replace(R.CONV_GROUP,""))}},{key:"getConversationProfile",value:function(o){var i,a=this,s=!1;if(this._convMap.has(o)?i=this._convMap.get(o):(i=new li({conversationID:o,type:Rt(o)?R.CONV_C2C:R.CONV_GROUP},this.isIntl(),this.isUsingChatCore()),s=!0),i._isInfoCompleted||i.type===R.CONV_SYSTEM)return Sn({conversation:i});if(At(o)){if(!this.get(7))return C({code:T.NO_MODULE});if(!this._hasLocalGroup(o))return Sn({conversation:i})}var r="".concat(this._n,".").concat("getConversationProfile"),c=new M("getConversationProfile");return v.l("".concat(r,". convID:").concat(o," remark:").concat(i.remark," lastMessage:"),i.lastMessage),this._getUserOrGroupProfile(i).then(function(e){c.setMessage("convID:".concat(o," unreadCount:").concat(e.data.conversation.unreadCount)).end();var t,n=a.get(8);if(n&&i.type===R.CONV_C2C&&(t=o.replace(R.CONV_C2C,""),n.isMyFriend(t)&&(n=n.getFriendRemark(t),i.remark!==n&&(i.remark=n,v.l("".concat(r,". convID:").concat(o," patch remark:").concat(i.remark))))),v.l("".concat(r," ok. isNewConv:").concat(s," convID:").concat(o)),s){if(i.type===R.CONV_C2C)return a._onNewC2CConv([o.replace(R.CONV_C2C,"")]).then(function(){return Sn({conversation:i})});if(i.type===R.CONV_GROUP)return a._onNewGroupConv([o.replace(R.CONV_GROUP,"")]).then(function(){return Sn({conversation:i})})}return e}).catch(function(e){return c.setError(e).setMessage("convID:".concat(o)).end(),v.e("".concat(r," failed. error:"),e),C(e)})}},{key:"_getUserOrGroupProfile",value:function(t){var n=this;return t.type===R.CONV_C2C?this.get(4).getUserProfile({userIDList:[t.toAccount]}).then(function(e){e=e.data;return 0===e.length?C({code:T.USER_OR_GRP_NOT_FOUND}):(t.userProfile=e[0],t._isInfoCompleted=!0,n._insertConvAfterTopmost(t),Sn({conversation:t}))}):this.get(7).getGroupProfile({groupID:t.toAccount}).then(function(e){return t.groupProfile=e.data.group,t._isInfoCompleted=!0,n._insertConvAfterTopmost(t),Sn({conversation:t})})}},{key:"_insertConvAfterTopmost",value:function(e){var t,n;e instanceof li&&!this._convMap.has(e.conversationID)&&(n=(t=D(this._convMap)).findIndex(function(e){return !1===e[1].isPinned}),t.splice(n,0,[e.conversationID,e]),this._convMap=new Map(t),this._setStorageConvList(),this.emitConvUpdate(!0,!1));}},{key:"_onProfileUpdated",value:function(e){var n=this;e.data.forEach(function(e){var t=e.userID;t===n.getMyUserID()?n._onMyProfileModified({latestNick:e.nick,latestAvatar:e.avatar}):(t=n._convMap.get("".concat(R.CONV_C2C).concat(t)))&&(t.userProfile=e);});}},{key:"_onCloudConfig",value:function(e){"0"===this.getCloudConfig("pull_on_invite")&&(this._bPullOnInvite=!1),v.l("".concat(this._n,"._onCloudConfig bPullOnInvite:").concat(this._bPullOnInvite));}},{key:"disableMsgPullOnInvite",value:function(){this._bPullOnInvite=!1;}},{key:"_isSyncCompleted",value:function(){return this._pagingStatus===Pn}},{key:"_errorLog",value:function(e,t,n,o){var i=new Error("Params validate failed."),a="".concat(this.getErrMsg("API_REFER")).concat(e);throw v.w("[".concat(e,"] | ").concat(t," | ").concat(this.getErrMsg(n,o),", ").concat(a)),v.e("[".concat(e,"] Invalid ").concat(t,": type check failed for ").concat(t,".")),i}},{key:"_isValidConvID",value:function(e){return Rt(e)||At(e)||Ot(e)}},{key:"deleteConversation",value:function(e){var t=this,n="deleteConversation";return ft(e)||$e(e)||this._errorLog(n,"options","StringOrObjectRequiredLog"),ft(e)?(this._isValidConvID(e)||this._errorLog(n,"options","InvalidConversationID",e),v.l("".concat(this._n,".").concat(n," convID:").concat(e)),this.deleteConvList({conversationIDList:[e],flag:1})):(nt(e.conversationIDList)||this._errorLog(n,"conversationIDList","ArrayRequiredLog"),0===e.conversationIDList.length&&this._errorLog(n,"conversationIDList","NonEmptyArrayLog"),e.conversationIDList.forEach(function(e){t._isValidConvID(e)||t._errorLog(n,"conversationIDList","InvalidConversationID",e);}),"clearHistoryMessage"in e&&"boolean"!=typeof e.clearHistoryMessage&&this._errorLog(n,"clearHistoryMessage","BooleanRequiredLog"),100<e.conversationIDList.length&&(e.conversationIDList=e.conversationIDList.slice(0,100)),this.deleteConvList(e))}},{key:"deleteConvList",value:function(e){var t=e.conversationIDList,t=void 0===t?[]:t,n=e.clearHistoryMessage,n=void 0===n||n,e=e.flag,o=void 0===e?0:e,i="".concat(this._n,".").concat("deleteConvList"),e="convIDList:".concat(t," clearHistoryMessage:").concat(n),a=(v.l("".concat(i," ").concat(e)),new M("deleteConvList"));return a.setMessage(e),Promise.all([this.rmLocalOnlyConvList(t),this.rmLocalAndRemoteConvList(t,n)]).then(function(e){a.end();e=[].concat(D(e[0]),D(e[1]));return 0===e.length?C(new Hn({code:T.CONV_NOT_FOUND})):(v.l("".concat(i," ok")),Sn(1===o?{conversationID:e[0]}:{conversationIDList:e}))}).catch(function(e){return a.setError(e).end(),v.e("".concat(i," failed. error:"),e),C(e)})}},{key:"rmLocalOnlyConvList",value:function(e){var n=this;return e.filter(function(e){if(!n._convMap.has(e))return !1;var t=n.getLocalConversation(e).type;return t!==R.CONV_GROUP||n._hasLocalGroup(e)?t===R.CONV_SYSTEM&&(n.get(7).deleteGroupSystemNotice({messageList:n._msgListHandler.getLocalMsgList(e)}),n.deleteLocalConv(e),!0):(n.deleteLocalConv(e),!0)})}},{key:"rmLocalAndRemoteConvList",value:function(e,t){var n=this,o={fromAccount:this.getMyUserID(),conversationList:[],clearHistoryMessage:t?1:0};return e.forEach(function(e){var t;n._convMap.has(e)&&((t=n.getLocalConversation(e).type)===R.CONV_C2C?o.conversationList.push({toAccount:e.replace(t,""),type:1}):t===R.CONV_GROUP&&n._hasLocalGroup(e)&&o.conversationList.push({toGroupID:e.replace(t,""),type:2}));}),0===o.conversationList.length?[]:this.req({P:I.DEL_CONV,data:o}).then(function(e){var t=[];return 0<e.data.resultList.length&&e.data.resultList.map(function(e){0===e.code&&(e=1===e.type?"".concat(R.CONV_C2C).concat(e.to):"".concat(R.CONV_GROUP).concat(e.groupID),t.push(e));}),n.deleteLocalConvList(t),t})}},{key:"setConvDraft",value:function(e){var t=e.conversationID,e=e.draftText,n="".concat(this._n,".").concat("setConvDraft");if(v.l("".concat(n," convID:").concat(t," draftText:").concat(e)),!this._convMap.has(t))return C({code:T.CONV_NOT_FOUND});n=this._convMap.get(t);return n.setDraftText(e),this.emitConvUpdate(),Sn({code:0,conversation:n})}},{key:"clearHistoryMessage",value:function(t){var n=this,e={fromAccount:this.getMyUserID(),toAccount:void 0,type:void 0,toGroupID:void 0};if(!this._convMap.has(t))return C({code:T.CONV_NOT_FOUND});var o=this._convMap.get(t).type;if(o===R.CONV_C2C)e.type=1,e.toAccount=t.replace(R.CONV_C2C,"");else {if(o!==R.CONV_GROUP)return o===R.CONV_SYSTEM?(this.get(7).deleteGroupSystemNotice({messageList:this._msgListHandler.getLocalMsgList(t)}),Sn({conversationID:t})):C({code:T.CONV_UN_RECORDED_TYPE});e.type=2,e.toGroupID=t.replace(R.CONV_GROUP,"");}var i="".concat(this._n,".").concat("clearHistoryMessage"),a=new M("clearHistoryMessage");return a.setMessage("convID:".concat(t)),v.l("".concat(i,". convID:").concat(t)),this.setMessageRead({conversationID:t}).then(function(){return n.req({P:I.CLEAR_HISTORY_MSG,data:e})}).then(function(){a.end(),v.l("".concat(i," ok")),n.clearMemMsg(t);var e=n.getLocalConversation(t);return e&&(e.updateLastMessage(),n._sortConvListAndEmitEvent()),Sn({conversationID:t})}).catch(function(e){return a.setError(e).end(),v.e("".concat(i," failed. error:"),e),C(e)})}},{key:"pinConversation",value:function(e){var t=this,n=e.conversationID,o=e.isPinned,i=this.getLocalConversation(n);if(i&&i.isPinned===o)return Sn({conversationID:n});if(Ot(n))return i&&(i.isPinned=o),this._sortConvListAndEmitEvent(),Sn({conversationID:n});e=null;if(Rt(n)?e={type:1,toAccount:n.replace(R.CONV_C2C,"")}:At(n)&&(e={type:2,groupID:n.replace(R.CONV_GROUP,"")}),null===e)return C({code:T.INVALID_CONV_ID});var a="".concat(this._n,".").concat("pinConversation"),s="convID:".concat(n," isPinned:").concat(o),r=new M("pinConversation");return r.setMessage(s),v.l("".concat(a,". ").concat(s)),this.req({P:I.PIN_CONV,data:{fromAccount:this.getMyUserID(),operationType:!0===o?1:2,itemList:[e]}}).then(function(){return r.end(),v.l("".concat(a," ok")),i?i.isPinned!==o&&(i.isPinned=o):t._convMap.set(n,new li({conversationID:n,type:Rt(n)?R.CONV_C2C:R.CONV_GROUP,isPinned:o},t.isIntl(),t.isUsingChatCore())),t._sortConvListAndEmitEvent(),Ln({conversationID:n})}).catch(function(e){return r.setError(e).end(),v.e("".concat(a," failed. error:"),e),C(e)})}},{key:"setMessageRemindType",value:function(e){return this._msgRemindHandler.set(e)}},{key:"patchMsgRemindType",value:function(e){var t=e.ID,n=e.isC2CConversation,o=e.messageRemindType,i=!1,n=this.getLocalConversation("".concat(n?R.CONV_C2C:R.CONV_GROUP).concat(t));return n&&n.messageRemindType!==o&&(n.messageRemindType=o,i=!0),v.l("".concat(this._n,".patchMsgRemindType options:"),e,"ret:".concat(i)),i}},{key:"onC2CMsgRemindTypeFetched",value:function(e){var n,o=this;nt(e)&&0<e.length&&(n=0,e.forEach(function(e){var t=e.userID,e=e.muteFlag,e=o._transMsgRemindType(e);!0===o.patchMsgRemindType({ID:t,isC2CConversation:!0,messageRemindType:e})&&(n+=1);}),v.l("".concat(this._n,".onC2CMsgRemindTypeFetched updateCount:").concat(n)),1<=n&&this.emitConvUpdate(!0,!1));}},{key:"onC2CMsgRemindTypeSynced",value:function(e){var n=this,o="".concat(this._n,".onC2CMsgRemindTypeSynced");e.dataList.forEach(function(e){var t;Je(e.muteNotificationsSync)||(t=(e=e.muteNotificationsSync).to,e=e.muteFlag,e=n._transMsgRemindType(e),n.patchMsgRemindType({ID:t,isC2CConversation:!(t=0),messageRemindType:e})&&(t+=1),v.l("".concat(o," updateCount:").concat(t)),1<=t&&n.emitConvUpdate(!0,!1));});}},{key:"onGroupMsgRemindTypeUpdated",value:function(e){this._msgRemindHandler.onGroupMsgRemindTypeUpdated(e);}},{key:"deleteLocalConv",value:function(e){var t=!(1<arguments.length&&void 0!==arguments[1])||arguments[1],n=this._convMap.has(e);v.l("".concat(this._n,".deleteLocalConv convID:").concat(e," has:").concat(n)),n&&(this._convMap.delete(e),this._convMapForDiff.delete(e),this.clearMemMsg(e),this._setStorageConvList(!0),t)&&(n=!this._isTopicConv(e),this.emitConvUpdate(n,!1));}},{key:"pullMsgOnInvite",value:function(e){var t,n,o,i,a,s=this.get(7);s&&(t="".concat(this._n,".pullMsgOnInvite"),v.l("".concat(t," flag:").concat(this._bPullOnInvite)),this._bPullOnInvite&&(a=this.getLocalLastMessage(e),n=this.getLocalSecondLastMessage(e),i=o=1,a&&(o=a.sequence),n&&(i=n.sequence),a=s.getGroupRemoteLastSeq(e.replace(R.CONV_GROUP,"")),v.l("".concat(t," convID:").concat(e," localLastSeq:").concat(o," localSecondLastSeq:").concat(i," remoteLastSeq:").concat(a)),this.clearMemMsg(e),1<o-i?this._recursiveGetMsgList([],e,!1,o,i):1<a-o&&this._recursiveGetMsgList([],e,!0,a,o)));}},{key:"_recursiveGetMsgList",value:function(i,a,s,r,c,e){var u=this;this.getMessageList({conversationID:a,nextReqMessageID:e}).then(function(e){var e=e.data,t=e.messageList,n=e.isCompleted,e=e.nextReqMessageID,o=t.filter(function(e){return s?e.sequence>c&&e.sequence<=r:e.sequence>c&&e.sequence<r});i.unshift.apply(i,D(o)),!n&&0<t.length&&t[0].sequence>c&&i.length<60?u._recursiveGetMsgList(i,a,s,r,c,e):u._emitMsgReceived(a,i);});}},{key:"_emitMsgReceived",value:function(e,t){var n,o,i=this;0<t.length&&(t=t.filter(function(t,e,n){return e===n.findIndex(function(e){return e.sequence===t.sequence})}),n=this.hasLocalConversation(e),o=t.map(function(e){return e.sequence}),v.l("".concat(this._n,"._emitMsgReceived convID:").concat(e," has:").concat(n," count:").concat(o.length," sequenceList:"),o),this.emitOEvt(G.MESSAGE_RECEIVED,t),n?this.patchConvLastMessage(e,!0):this.getConversationProfile(e).then(function(){i.patchConvLastMessage(e,!0);}));}},{key:"deleteLocalConvList",value:function(e){var t=this,n=!1;e.forEach(function(e){t._convMap.has(e)&&(t.deleteLocalConv(e,!1),n=!0);}),v.l("".concat(this._n,".deleteLocalConvList convID:").concat(e," isConvIDExisted:").concat(n)),n&&this.emitConvUpdate(!0,!1);}},{key:"isMessageSentByCurrentInstance",value:function(e){return !(!this._msgListHandler.hasLocalMsg(e.conversationID,e.ID)&&!this._sll.has(e.random))}},{key:"modifyMessageList",value:function(e){var t,n;e.startsWith(R.CONV_C2C)&&this._convMap.has(e)&&(n=this._convMap.get(e),t=Date.now(),this._msgListHandler.modifyMsgSentByPeer({conversationID:e,latestNick:n.userProfile.nick,latestAvatar:n.userProfile.avatar}),n=this.get(4).getNickAndAvatarByUserID(this.getMyUserID()),this._msgListHandler.modifyMsgSentByMe({conversationID:e,latestNick:n.nick,latestAvatar:n.avatar}),v.l("".concat(this._n,".modifyMessageList convID:").concat(e," cost:").concat(Zt(t))));}},{key:"updateUserProfileSpecifiedKey",value:function(e){v.l("".concat(this._n,".updateUserProfileSpecifiedKey options:"),e);var t=e.conversationID,n=e.nick,e=e.avatar;this._convMap.has(t)&&(t=this._convMap.get(t).userProfile,ft(n)&&t.nick!==n&&(t.nick=n),ft(e)&&t.avatar!==e&&(t.avatar=e),this.emitConvUpdate(!0,!1));}},{key:"_onMyProfileModified",value:function(t){var n=this,e=this.getLocalConvList(),o=Date.now();e.forEach(function(e){n.modifyMessageSentByMe(y({conversationID:e.conversationID},t));}),v.l("".concat(this._n,"._onMyProfileModified. modify all messages sent by me, cost:").concat(Zt(o)));}},{key:"modifyMessageSentByMe",value:function(e){this._msgListHandler.modifyMsgSentByMe(e);}},{key:"getLatestMessageSentByMe",value:function(e){return this._msgListHandler.getLatestMsgSentByMe(e)}},{key:"modifyMessageSentByPeer",value:function(e){this._msgListHandler.modifyMsgSentByPeer(e);}},{key:"getLatestMessageSentByPeer",value:function(e){return this._msgListHandler.getLatestMsgSentByPeer(e)}},{key:"pushIntoNoticeResult",value:function(e,t){return !(!this._msgListHandler.pushIn(t)||this._sll.has(t.random)||(e.push(t),0))}},{key:"getLocalLastMessage",value:function(e){return this._msgListHandler.getLocalLastMsg(e)}},{key:"getLocalSecondLastMessage",value:function(e){return this._msgListHandler.getLocalSecondLastMsg(e)}},{key:"checkAndPatchRemark",value:function(){var e,n,o=this.get(8);0===this._convMap.size||!o||0!==(e=D(this._convMap.values()).filter(function(e){return e.type===R.CONV_C2C})).length&&(n=0,e.forEach(function(e){var t=e.conversationID.replace(R.CONV_C2C,"");o.isMyFriend(t)&&(t=o.getFriendRemark(t),e.remark!==t&&(e.remark=t,n+=1));}),v.l("".concat(this._n,".checkAndPatchRemark. c2cConvCount:").concat(e.length," patchedCount:").concat(n)),0<n&&this.emitConvUpdate(!0,!1));}},{key:"updateTopicConversation",value:function(e){this._updateLocalConvList({conversationOptionsList:e,isFromGetConversations:!0,updateUnreadCount:!0});}},{key:"sendReadReceipt",value:function(e){var t=e[0],n=null;return t.conversationType===R.CONV_C2C?n=this._m.get(6):t.conversationType===R.CONV_GROUP&&(n=this._m.get(7)),n?n.sendReadReceipt(e):C({code:T.NO_MODULE})}},{key:"getReadReceiptList",value:function(e){var t=e[0],n=null;return t.conversationType===R.CONV_C2C?n=this._m.get(6):t.conversationType===R.CONV_GROUP&&(n=this._m.get(7)),n?n.getReadReceiptList(e):C({code:T.NO_MODULE})}},{key:"getLastMessageTime",value:function(e){e=this.getLocalConversation(e);return e?e.lastMessage.lastTime:0}},{key:"getTotalUnreadCount",value:function(){var e=this.getLocalConvList(),t=0;return e.forEach(function(e){e.type!==R.CONV_SYSTEM&&(""!==e.messageRemindType&&e.messageRemindType!==R.MSG_REMIND_ACPT_AND_NOTE||(t+=e.unreadCount));}),t}},{key:"onTotalUnreadCountUpdate",value:function(){var e=this.getTotalUnreadCount();this._convTotalUnreadCount!==e&&(v.l("".concat(this._n,".onTotalUnreadCountUpdate from ").concat(this._convTotalUnreadCount," to ").concat(e)),this._convTotalUnreadCount=e,this.emitOEvt(G.TOTAL_UNREAD_MESSAGE_COUNT_UPDATED));}},{key:"_isConvNeedShow",value:function(e){e=this.getLocalConversation(e);if(A(e))return !0;var t=e.type===R.CONV_TOPIC,n=e.type===R.CONV_GROUP&&e.groupProfile.type===R.GRP_ROOM,e=e.type===R.CONV_GROUP&&e.groupProfile.type===R.GRP_LIVE;return !(t||n||e)}},{key:"setAllRcvMsgOpt",value:function(e){return this._msgRemindHandler.setAllRcvMsgOpt(e)}},{key:"getAllRcvMsgOpt",value:function(){return this._msgRemindHandler.getAllRcvMsgOpt()}},{key:"onAllRcvMsgOptNotify",value:function(e){this._msgRemindHandler.onAllRcvMsgOptNotify(e);}},{key:"clearUnreadCount",value:function(e){e=this.getLocalConversation(e);e&&0<e.unreadCount&&(e.unreadCount=0,this.emitConvUpdate(!0,!1));}},{key:"storeHoppingMessageList",value:function(e){this._msgListHandler.storeHoppingMsgList(e);}},{key:"clearMemMsg",value:function(e){var t=1<arguments.length&&void 0!==arguments[1]&&arguments[1];v.l("".concat(this._n,".clearMemMsg convID:").concat(e," isOverLimit:").concat(t)),this._msgListHandler.removeByConvID(e),this._completedMap.delete(e),this._roamingMsgKeyAndTimeMap.delete(e),this._everClearedMap.set(e,1);}},{key:"reset",value:function(){v.l("".concat(this._n,".reset")),this._setStorageConvList(!0),this._pagingStatus=Nn,this._msgListHandler.reset(),this._msgRemindHandler.reset(),this._roamingMsgKeyAndTimeMap.clear(),this._sll.reset(),this._peerReadTimeMap.clear(),this._completedMap.clear(),this._convMap.clear(),this._pagingTs=0,this._pagingStartIdx=0,this._pagingPinnedTs=0,this._pagingPinnedStartIdx=0,this._remoteGroupReadSeqMap.clear(),this._convTotalUnreadCount=0,this._pagingGetCostList.length=0,this._pagingConvIDMap.clear(),this._convIDFromUnreadDBMap.clear(),this._pagingGetCostList.length=0,this._convMapForDiff.clear(),this._partialUpdatedConvMap.clear(),this._everClearedMap.clear(),this._bPullOnInvite=!0,this._convGroupHandler.reset(),this.resetReady();}}]),oa),gi=(e(na,[{key:"onCheckTimer",value:function(e){e%1==0&&0<this._cachedGroupTipsMap.size&&this._check();}},{key:"_check",value:function(){var i=this;this._cachedGroupTipsMap.forEach(function(e,t){var n=i._checkCountMap.get(t),o=i._grpM.hasLocalGroup(t);v.l("".concat(i._n,"._check groupID:").concat(t," hasLocalGroup:").concat(o," checkCount:").concat(n)),o?(i._notifyCachedGroupTips(t),i._checkCountMap.delete(t),i._grpM.deleteUnjoinedAVChatRoom(t)):n>=i.MAX_CHECK_COUNT?(i._deleteCachedGroupTips(t),i._checkCountMap.delete(t)):i._checkCountMap.set(t,++n);});}},{key:"onNewGroupTips",value:function(e){v.l("".concat(this._n,".onNewGroupTips options:").concat(JSON.stringify(e.dataList)));var e=this._assembly(e),t=e.eventDataList,n=e.result,e=e.AVChatRoomMessageList;0<e.length&&this._grpM.onAVChatRoomMessage(e),0<n.length&&(this._grpM.emitOEvt(G.MESSAGE_RECEIVED,n),this._handleTips(n)),0<t.length&&(this._grpM.updateNextMessageSeq(t),this._grpM.get(11).onNewMessage({conversationOptionsList:t,isInstantMessage:!0}));}},{key:"_assembly",value:function(l){for(var e=l.event,d=l.dataList,t=null,n=[],p=[],_={},h=[],g=0,f=d.length;g<f;g++){var o=ht(d[g]);if(6===e){if(this._grpM.isGroupAttributesUpdatedNotice(o))continue;if(this._grpM.isGroupCountersNotice(o))continue}var i=o.groupProfile,m=i.groupID,a=i.communityType,a=void 0===a?0:a,s=i.topicID,s=void 0===s?void 0:s,r=i.invisible,i=i.groupType,i=void 0===i?void 0:i,v=void 0,c=this._grpM.isMessageFromTopic(a,s),u=(c&&(v=R.CONV_TOPIC,o.to=s),this._grpM.hasLocalGroup(m));if(u||!this._grpM.isUnjoinedAVChatRoom(m))if(u||c)if(this._grpM.isMessageFromOrToAVChatroom(m))o.event=e,h.push(o);else if(o.currentUser=this._grpM.getMyUserID(),o.conversationType=R.CONV_GROUP,(t=new ko(o)).setElement({type:R.MSG_GRP_TIP,content:y(y({},o.elements),{},{groupProfile:o.groupProfile})}),t.isSystemMessage=!1,1!==r){var u=this._grpM.get(11),c=t,r=c.conversationID,c=c.sequence;if(6===e)t._onlineOnlyFlag=!0,p.push(t);else if(!u.pushIntoNoticeResult(p,t))continue;this._grpM.isMessageFromCommunityOfTopic(a,s)||6===e&&u.getLocalConversation(r)||(6!==e&&this._qualityStat(t),a=u.isRemoteRead({conversationID:r,sequence:c}),A(_[r])?(s=0,"in"===t.flow&&(t._isExcludedFromUnreadCount||t._onlineOnlyFlag||a||(s=1)),_[r]=n.push({conversationID:r,unreadCount:s,type:A(v)?t.conversationType:v,subType:t.conversationSubType,lastMessage:t._isExcludedFromLastMessage?"":t})-1):(n[u=_[r]].type=t.conversationType,n[u].subType=t.conversationSubType,n[u].lastMessage=t._isExcludedFromLastMessage?"":t,"in"===t.flow&&(t._isExcludedFromUnreadCount||t._onlineOnlyFlag||a||n[u].unreadCount++)));}else this._qualityStat(t);else this._cacheAndCompare({groupID:m,event:e,item:o,groupType:i});}return {eventDataList:n,result:p,AVChatRoomMessageList:h}}},{key:"_qualityStat",value:function(e){this._grpM.get(26).addMessageSequence({key:Zn,message:e});}},{key:"_handleTips",value:function(e){var t=this;e.forEach(function(e){switch(e.payload.operationType){case 1:t._onNewMemberComeIn(e);break;case 2:t._onMemberQuit(e);break;case 3:t._onMemberKickedOut(e);break;case 4:t._onMemberSetAdmin(e);break;case 5:t._onMemberCancelledAdmin(e);break;case 6:t._onGroupProfileModified(e);break;case 7:t._onMemberInfoModified(e);break;case 8:t._onTopicProfileUpdated(e);break;default:v.w("".concat(t._n,"._handleTips unknown operationType:").concat(e.payload.operationType));}});}},{key:"_onNewMemberComeIn",value:function(e){var e=e.payload,t=e.memberNum,e=e.groupProfile.groupID,e=this._grpM.getLocalGroupProfile(e);e&&Qe(t)&&e.memberCount!==t&&(e.memberCount=t,this._updateConvGroupProfile(e));}},{key:"_onMemberQuit",value:function(e){var t=e.payload,n=t.memberNum,t=t.groupProfile.groupID,o=this._grpM.getLocalGroupProfile(t);o&&Qe(n)&&o.memberCount!==n&&(o.memberCount=n,this._updateConvGroupProfile(o)),this._grpM.getGroupMemberHandler().deleteLocalGroupMembers(t,e.payload.userIDList);}},{key:"_onMemberKickedOut",value:function(e){var t=e.payload,n=t.memberNum,t=t.groupProfile.groupID,o=this._grpM.getLocalGroupProfile(t);o&&Qe(n)&&o.memberCount!==n&&(o.memberCount=n,this._updateConvGroupProfile(o)),this._grpM.getGroupMemberHandler().deleteLocalGroupMembers(t,e.payload.userIDList);}},{key:"_updateConvGroupProfile",value:function(e){this._grpM.get(11).updateConvGroupProfile([e]);}},{key:"_onMemberSetAdmin",value:function(e){var t=e.payload.groupProfile.groupID,e=e.payload.userIDList,n=this._grpM.getGroupMemberHandler();e.forEach(function(e){e=n.getLocalGroupMemberInfo(t,e);e&&e.updateRole(R.GRP_MBR_ROLE_ADMIN);});}},{key:"_onMemberCancelledAdmin",value:function(e){var t=e.payload.groupProfile.groupID,e=e.payload.userIDList,n=this._grpM.getGroupMemberHandler();e.forEach(function(e){e=n.getLocalGroupMemberInfo(t,e);e&&e.updateRole(R.GRP_MBR_ROLE_MEMBER);});}},{key:"_onGroupProfileModified",value:function(e){var t=this,e=e.payload,n=e.newGroupProfile,o=e.groupProfile,i=e.operatorInfo,e=o.groupID,a=this._grpM.getLocalGroupProfile(e),o=(Object.keys(n).forEach(function(e){switch(e){case"ownerID":t._ownerChanged(a,n);break;case"groupName":a.name=n[e];break;default:a[e]=n[e];}}),A(i)||Object.keys(i).forEach(function(e){var t;"nameCard"===e?a.updateSelfInfo({nameCard:i[e]}):"role"===e&&(t="",400===i[e]?t=R.GRP_MBR_ROLE_OWNER:300===i[e]?t=R.GRP_MBR_ROLE_ADMIN:200===i[e]&&(t=R.GRP_MBR_ROLE_MEMBER),a.updateSelfInfo({role:t}));}),!a.isSupportTopic);this._grpM.emitGroupListUpdate(!0,o);}},{key:"_ownerChanged",value:function(e,t){var e=e.groupID,n=this._grpM.getLocalGroupProfile(e),o=this._grpM.getMyUserID();o===t.ownerID&&(n.updateGroup({selfInfo:{role:R.GRP_MBR_ROLE_OWNER}}),n=(t=this._grpM.getGroupMemberHandler()).getLocalGroupMemberInfo(e,o),o=this._grpM.getLocalGroupProfile(e).ownerID,t=t.getLocalGroupMemberInfo(e,o),n&&n.updateRole(R.GRP_MBR_ROLE_OWNER),t&&t.updateRole(R.GRP_MBR_ROLE_MEMBER));}},{key:"_onMemberInfoModified",value:function(e){var t=e.to,n=e.payload,o=n.groupProfile,n=n.memberList,i=o.groupID,a=(kt(t)&&this._updateTopicMuteTime(e),this._grpM.getGroupMemberHandler());n.forEach(function(e){var t=a.getLocalGroupMemberInfo(i,e.userID);t&&Qe(e.muteTime)&&t.updateMuteUntil(e.muteTime);});}},{key:"_updateTopicMuteTime",value:function(e){var t=e.to,e=e.payload,n=e.groupProfile,e=e.memberList,o=void 0===e?[]:e,e=this._grpM.get(10),n=n.groupID,i=e.getLocalTopic(n,t);if(i){for(var a=!1,s=0;s<o.length;s++){var r=o[s];if(r.userID===this._grpM.getMyUserID()&&0<=r.muteTime){i.updateSelfInfo({muteTime:r.muteTime}),a=!0;break}}a&&this._grpM.emitOEvt(G.TOPIC_UPDATED,{groupID:n,topic:i});}}},{key:"_onTopicProfileUpdated",value:function(e){var t=e.payload,n=t.groupProfile.groupID,t=t.newTopicInfo;this._grpM.get(10).onTopicProfileUpdated(y({groupID:n,topicID:e.to},t));}},{key:"_cacheGroupTips",value:function(e,t){this._cachedGroupTipsMap.has(e)||this._cachedGroupTipsMap.set(e,[]),this._cachedGroupTipsMap.get(e).push(t);}},{key:"_deleteCachedGroupTips",value:function(e){this._cachedGroupTipsMap.has(e)&&this._cachedGroupTipsMap.delete(e);}},{key:"_notifyCachedGroupTips",value:function(e,t){var n=this,o=this._cachedGroupTipsMap.get(e)||[];v.l("".concat(this._n,"._notifyCachedGroupTips groupID:").concat(e," groupType:").concat(t," count:").concat(o.length)),o.forEach(function(e){n.onNewGroupTips(e);}),this._deleteCachedGroupTips(e);}},{key:"_cacheAndCompare",value:function(e){var t=e.groupID,n=e.event,o=e.item,e=e.groupType,n=(v.l("".concat(this._n,"._cacheAndCompare groupID:").concat(t," groupType:").concat(e)),this._cacheGroupTips(t,{event:n,dataList:[o]}),{groupID:t,type:e});e===R.GRP_AVCHATROOM?this._grpM.hasLocalGroup(t)?this._notifyCachedGroupTips(t,e):this._grpM.setUnjoinedAVChatRoom(t):(this._grpM.updateGroupMap([n]),this._notifyCachedGroupTips(t,e)),this._checkCountMap.has(t)||this._checkCountMap.set(t,0);}},{key:"reset",value:function(){this._cachedGroupTipsMap.clear(),this._checkCountMap.clear();}}]),na),fi=(e(ta,[{key:"onCheckTimer",value:function(e){e%1==0&&0<this._cachedGroupMessageMap.size&&this._check();}},{key:"_check",value:function(){var i=this;this._cachedGroupMessageMap.forEach(function(e,t){var n=i._checkCountMap.get(t),o=i._grpM.hasLocalGroup(t);v.l("".concat(i._n,"._check groupID:").concat(t," hasLocalGroup:").concat(o," checkCount:").concat(n)),o?(i._notifyCachedGroupMessage(t),i._checkCountMap.delete(t),i._grpM.deleteUnjoinedAVChatRoom(t)):n>=i.MAX_CHECK_COUNT?(i._deleteCachedGroupMessage(t),i._checkCountMap.delete(t)):i._checkCountMap.set(t,++n);});}},{key:"updateLastMsg",value:function(e){var t="".concat(this._n,".updateLastMsg");if(0!==this._grpM.getGroupMap().size){for(var n,o,i,a,s=!1,r=e.length,c=0;c<r;c++)(n=e[c]).type===R.CONV_GROUP&&0!==n.lastMessage.lastSequence&&null!==n.lastMessage.payload&&(o=n.conversationID.split(/^GROUP/)[1],(o=this._grpM.getLocalGroupProfile(o))&&(i=o.lastMessage,a=n.lastMessage,JSON.stringify(i)!==JSON.stringify(a)&&(o.lastMessage=y({},n.lastMessage),s=!0)));v.l("".concat(t," convCount:").concat(r," groupCount:").concat(this._grpM.getLocalGroupList().length," isUpdated:").concat(s)),s&&(this._grpM.sortLocalGroupList(),this._grpM.emitGroupListUpdate(!0,!1));}else this.tempConversationList=e;}},{key:"onNewMessage",value:function(e){var t=this._assembly(e),n=t.conversationOptionsList,o=t.messageList,t=t.AVChatRoomMessageList,t=(0<t.length&&this._grpM.onAVChatRoomMessage(t),Dt(o)),t=(0<t.length&&this._grpM.emitOEvt(G.MESSAGE_MODIFIED,t),0<n.length&&(this._grpM.get(11).onNewMessage({conversationOptionsList:n,isInstantMessage:!1!==e.isInstantMessage,updateUnreadCount:!1!==e.updateUnreadCount}),this._grpM.updateNextMessageSeq(n)),Et(o));0<t.length&&this._grpM.emitOEvt(G.MESSAGE_RECEIVED,t),o.length=0;}},{key:"_assembly",value:function(l){var d=l.dataList,p=l.event,_=l.isInstantMessage,e=null,t=[],h=[],g=[],f={},m=this._grpM.getFileDownloadProxy(),v=this._grpM.getDowloadFileAuthKey(),I=this._grpM.get(17).getFileDNList(),M=d.length;1<M&&d.sort(function(e,t){return e.sequence-t.sequence});for(var n=this._grpM.get(11),y=this._grpM.get(4),C=0;C<M;C++){var o,i=ht(d[C]),a=i.groupProfile,T=a.groupID,s=a.communityType,s=void 0===s?0:s,r=a.topicID,r=void 0===r?void 0:r,D=a.invisible,a=a.groupType,a=void 0===a?void 0:a,E=void 0,c=this._grpM.isMessageFromTopic(s,r),u=(c&&(E=R.CONV_TOPIC,i.to=r),this._grpM.hasLocalGroup(T));!u&&this._grpM.isUnjoinedAVChatRoom(T)||(u||c?this._grpM.isMessageFromOrToAVChatroom(T)?(i.event=p,g.push(i)):(i.currentUser=this._grpM.getMyUserID(),i.conversationType=R.CONV_GROUP,i.isSystemMessage=!!i.isSystemMessage,(e=new ko(i)).setElement(i.elements,m,v,I),1!==D?(u=1===d[C].isModified,n.isMessageSentByCurrentInstance(e)?e.isModified=u:u=!1,1===i.onlineOnlyFlag?(e._onlineOnlyFlag=!0,n.isMessageSentByCurrentInstance(e)||h.push(e)):this._grpM.isMessageFromCommunityOfTopic(s,r)?h.push(e):(e.from!==this._grpM.getMyUserID()||(c=n.getLatestMessageSentByMe(e.conversationID))&&(D=c.nick,s=c.avatar,D===e.nick&&s===e.avatar||(n.modifyMessageSentByMe({conversationID:o,latestNick:e.nick,latestAvatar:e.avatar}),y.mockOnNickAvatarModified(e.nick,e.avatar))),n.pushIntoMessageList(h,e,u)&&(this._qualityStat(_,e),o=(r=e).conversationID,c=r.sequence,D=n.isRemoteRead({conversationID:o,sequence:c}),A(f[o])?(s=0,"in"===e.flow&&(e._isExcludedFromUnreadCount||D||(s=1)),f[o]=t.push({conversationID:o,unreadCount:s,type:A(E)?e.conversationType:E,subType:e.conversationSubType,lastMessage:e._isExcludedFromLastMessage?"":e})-1):(t[u=f[o]].type=A(E)?e.conversationType:E,t[u].subType=e.conversationSubType,t[u].lastMessage=e._isExcludedFromLastMessage?"":e,"in"===e.flow&&(e._isExcludedFromUnreadCount||D||t[u].unreadCount++))))):this._qualityStat(_,e)):this._cacheAndCompare({groupID:T,event:p,item:i,groupType:a}));}return {conversationOptionsList:t,messageList:h,AVChatRoomMessageList:g}}},{key:"_qualityStat",value:function(e,t){var n=this._grpM.get(26);n.addMessageSequence({key:Zn,message:t}),e&&0<t.clientTime&&n.addMessageDelay(t.clientTime);}},{key:"onMsgRevoked",value:function(e,t){var n=this,u=this._grpM.get(11),l=[],d=[];e.dataList.forEach(function(e){var t=e.elements.revokedInfos,s=e.revokerInfo,r=e.groupProfile,c=!1;r&&(c=St({groupID:r.groupID})||!Je(r.topicID)),A(t)||t.forEach(function(e){var t,n=Je(e.topicID)?"GROUP".concat(e.groupID):"GROUP".concat(e.topicID),o=u.getLocalConversation(n),i=e.revokerInfo&&e.revokerInfo.revoker||s&&s.revoker,a=s&&s.reason||"";o&&Lt(o.type)?t={conversationID:n,sequence:e.sequence,ID:"".concat(e.tinyID,"-").concat(e.clientTime,"-").concat(e.random)}:(o=u.revoke(n,e.sequence,e.random))?t=o:(t={conversationID:n,sequence:e.sequence},e.tinyID&&e.clientTime&&e.random&&(t.ID="".concat(e.tinyID,"-").concat(e.clientTime,"-").concat(e.random)),e.time&&(t.time=e.time)),t&&(t.revoker=i,t.revokeReason=a,t.revokerInfo={userID:i,nick:"",avatar:""},c?(t.revokerInfo.nick=r.nick,t.revokerInfo.avatar=r.avatar,l.push(t)):d.push(t));});}),0===d.length&&0===l.length||(u.onMessageRevoked([].concat(l,d),t),0<l.length&&this._grpM.emitOEvt(G.MESSAGE_REVOKED,l),0<d.length&&u.updateRevokerInfo(d).then(function(e){n._grpM.emitOEvt(G.MESSAGE_REVOKED,e);}));}},{key:"_groupListTreeShaking",value:function(e){for(var n=new Map(D(this._grpM.getGroupMap())),t=0,o=e.length;t<o;t++)n.delete(e[t].groupID);this._grpM.hasJoinedAVChatRoom()&&this._grpM.getJoinedAVChatRoom().forEach(function(e){n.delete(e);}),this._grpM.getGroupMap().forEach(function(e,t){e.isSupportTopic&&n.delete(t);});for(var i=D(n.keys()),a=0,s=i.length;a<s;a++)this._grpM.deleteGroup(i[a]);}},{key:"syncGroupList",value:function(){var o=this,e=0<arguments.length&&void 0!==arguments[0]&&arguments[0],t=(this._pagingStatus===Nn&&this._grpM.clearGroupMap(),D(K)),n=this.PAGING_GRP_COUNT_LIMIT,i=[];if(!0===e)return this._pagingGetGroupListWithTopic({limit:n,offset:0,groupBaseInfoFilter:t,groupList:i});var e="syncGroupList",a="".concat(this._n,".").concat(e),s=new M(e);return this._pagingGetGroupList({limit:n,offset:0,groupBaseInfoFilter:t,groupList:i}).then(function(){var e=Xt(o._pagingGetCostList),t=zt(o._pagingGetCostList),n=(o._pagingGetCostList.length=0,o._pagingStatus=Pn,o._groupListTreeShaking(i),o._grpM.updateGroupMap(i),o._grpM.getLocalGroupList().length),n="count:".concat(n," sum:").concat(t," avg:").concat(e);return v.l("".concat(a," ok. ").concat(n)),s.setMessage(n).end(),o.tempConversationList&&(o.updateLastMsg(o.tempConversationList),o.tempConversationList=null),o._grpM.emitGroupListUpdate(!0,!0),Ln({groupList:o._grpM.getLocalGroupList()})}).catch(function(e){return o._pagingStatus=Un,s.setError(e).end(),v.e("".concat(a," failed. error:"),e),C(e)})}},{key:"getGroupList",value:function(){var t=this,n="".concat(this._n,".").concat("getGroupList");if(v.l("".concat(n," pagingStatus:").concat(this._pagingStatus)),this._pagingStatus===Un||this._pagingStatus===Nn)return this.syncGroupList().then(function(){var e=t._grpM.getLocalGroupList();return Ln({groupList:e,isSyncCompleted:t.isPagingGetCompleted()})}).catch(function(e){return v.e("".concat(n," failed. error:"),e),C(e)});var e=this._grpM.getLocalGroupList();return v.l("".concat(n,". returned group count:").concat(e.length)),Sn({groupList:e,isSyncCompleted:this.isPagingGetCompleted()})}},{key:"isPagingGetCompleted",value:function(){return this._pagingStatus===Pn}},{key:"_pagingGetGroupList",value:function(e){var o=this,i="".concat(this._n,".").concat("_pagingGetGroupList"),t=e.isCommunityRelay,a=void 0!==t&&t,s=e.limit,r=e.offset,c=e.groupBaseInfoFilter,u=e.groupList,l=Date.now();return this._grpM.req({P:I.GET_GRP_LIST,data:{type:a?R.GRP_COMMUNITY:void 0,memberAccount:this._grpM.getMyUserID(),limit:s,offset:r,responseFilter:{groupBaseInfoFilter:c,selfInfoFilter:["Role","JoinTime","MsgFlag","MsgSeq"]}}}).then(function(e){var e=e.data,t=e.groups,t=void 0===t?[]:t,e=e.totalCount,t=(u.push.apply(u,D(t)),o._handleGroupAtInfoWithoutTopic(a,t),r+s),n=!(t<e),e="offset:".concat(r," limit:").concat(s," total:").concat(e," isCompleted:").concat(n," ")+"current:".concat(u.length," isCommunityRelay:").concat(a);return o._pagingGetCostList.push(Zt(l,!1)),v.l("".concat(i," ok. ").concat(e," cost:").concat(Zt(l))),a||n?!a&&n?(v.l("".concat(i," start to get community list")),r=0,o._pagingGetGroupList({limit:s,offset:r,groupBaseInfoFilter:c,groupList:u,isCommunityRelay:!0})):a&&!n?(r=t,o._pagingGetGroupList({limit:s,offset:r,groupBaseInfoFilter:c,groupList:u,isCommunityRelay:!0})):Ln({groupList:u}):(r=t,o._pagingGetGroupList({limit:s,offset:r,groupBaseInfoFilter:c,groupList:u}))}).catch(function(e){return 10018===e.code?(v.w("".concat(o.logPrefix," response size exceeds the limit, request count:").concat(s)),s=50,o._pagingGetGroupList({limit:s,offset:r,groupBaseInfoFilter:c,groupList:u,isCommunityRelay:a})):a?(11e3===e.code&&v.l("".concat(i," ok. community unavailable")),Sn({groupList:u})):C(e)})}},{key:"_pagingGetGroupListWithTopic",value:function(e){var o=this,i="".concat(this._n,"._pagingGetGroupListWithTopic"),a=e.limit,s=e.offset,r=e.groupBaseInfoFilter,c=e.groupList,u=Date.now();return this._grpM.req({P:I.GET_GRP_LIST,data:{type:R.GRP_COMMUNITY,memberAccount:this._grpM.getMyUserID(),limit:a,offset:s,responseFilter:{groupBaseInfoFilter:r,selfInfoFilter:D(Y)},isSupportTopic:1,needAppDefineData:1}}).then(function(e){var e=e.data,t=e.groups,e=e.totalCount,t=(c.push.apply(c,D(void 0===t?[]:t)),s+a),n=!(t<e);if(v.l("".concat(i," ok. offset:").concat(s," limit:").concat(a," totalCount:").concat(e," isCompleted:").concat(n," currentCount:").concat(c.length," cost:").concat(Zt(u))),!n)return s=t,o._pagingGetGroupListWithTopic({limit:a,offset:s,groupBaseInfoFilter:r,groupList:c});o._grpM.updateGroupMap(c),o._grpM.emitGroupListUpdate(!0,!1);e=o._grpM.getLocalGroupList().filter(function(e){return !0===e.isSupportTopic});return Ln({groupList:e})}).catch(function(e){return 10018===e.code?(v.w("".concat(o.logPrefix," response size exceeds the limit, request count:").concat(a)),a=50,o._pagingGetGroupListWithTopic({limit:a,offset:s,groupBaseInfoFilter:r,groupList:c})):C(e)})}},{key:"_cacheGroupMessage",value:function(e,t){this._cachedGroupMessageMap.has(e)||this._cachedGroupMessageMap.set(e,[]),this._cachedGroupMessageMap.get(e).push(t);}},{key:"_deleteCachedGroupMessage",value:function(e){this._cachedGroupMessageMap.has(e)&&this._cachedGroupMessageMap.delete(e);}},{key:"_notifyCachedGroupMessage",value:function(e,t){var n=this,o=this._cachedGroupMessageMap.get(e)||[];v.l("".concat(this._n,"._notifyCachedGroupMessage groupID:").concat(e," groupType:").concat(t," count:").concat(o.length)),o.forEach(function(e){n.onNewMessage(e);}),this._deleteCachedGroupMessage(e);}},{key:"_cacheAndCompare",value:function(e){var t=e.groupID,n=e.event,o=e.item,e=e.groupType,n=(v.l("".concat(this._n,"._cacheAndCompare groupID:").concat(t," groupType:").concat(e)),this._cacheGroupMessage(t,{event:n,dataList:[o]}),{groupID:t,type:e});e===R.GRP_AVCHATROOM?this._grpM.hasLocalGroup(t)?this._notifyCachedGroupMessage(t,e):this._grpM.setUnjoinedAVChatRoom(t):(this._grpM.updateGroupMap([n]),this._notifyCachedGroupMessage(t,e)),this._checkCountMap.has(t)||this._checkCountMap.set(t,0);}},{key:"_handleGroupAtInfoWithoutTopic",value:function(e,t){var o=this;e&&0!==t.length&&t.forEach(function(e){var t=e.groupID,e=e.groupAtInfoList,n=[];A(e)||(e.forEach(function(e){n.push(y(y({},e),{},{groupID:t}));}),o._grpM.get(11).onNewGroupAtTips({dataList:n}));});}},{key:"setPagingGroupCount",value:function(e){A(e)||(this.PAGING_GRP_COUNT_LIMIT=parseInt(e,10));}},{key:"reset",value:function(){this.PAGING_GRP_COUNT_LIMIT=200,this._cachedGroupMessageMap.clear(),this._checkCountMap.clear(),this._pagingStatus=Nn,this._pagingGetCostList=[];}}]),ta),mi=(e(ea,[{key:"_onCloudConfig",value:function(){var e=this._grpM.getCloudConfig("grp_attr_cache_time");A(e)||(this.CACHE_EXPIRE_TIME=Number(e));}},{key:"updateLocalMainSequenceOnReconnected",value:function(){this._groupAttributesMap.forEach(function(e){e.localMainSequence=0;});}},{key:"isGroupAttributesUpdatedNotice",value:function(e){var t=e.to,e=e.elements.newGroupProfile,n=!A(e)&&!Je(e.groupAttributeOption);return n&&this._onGroupAttributesUpdated({groupID:t,groupAttributeOption:e.groupAttributeOption}),n}},{key:"_onGroupAttributesUpdated",value:function(e){var t=this,n=e.groupID,e=e.groupAttributeOption,o=e.mainSequence,i=e.isWithChangedAttributeInfo,a=e.groupAttributeList,a=void 0===a?[]:a,e=e.operationType;if(v.l("".concat(this._n,".onGroupAttributesUpdated. ")+"groupID:".concat(n," isWithChangedAttributeInfo:").concat(i," operationType:").concat(e)),!A(e)){this._groupAttributesCopy=this._getCachedAttributes({groupID:n});var s=o-this._getLocalGroupAttributes(n).localMainSequence;if(0!=s){if(1===i&&1==s)return this._refreshCachedGroupAttributes({groupID:n,remoteMainSequence:o,groupAttributeList:a,operationType:e}),void this._emitGroupAttributesUpdated(n);this._hasLocalGroupAttributes(n)&&(i=this._getLocalGroupAttributes(n).avChatRoomKey,this._getGroupAttributes({groupID:n,avChatRoomKey:i}).then(function(){t._emitGroupAttributesUpdated(n);}));}}}},{key:"initGroupAttributesCache",value:function(e){var t=e.groupID,e=e.avChatRoomKey,e=void 0===e?void 0:e;this._groupAttributesMap.set(t,{lastUpdateTime:0,localMainSequence:0,remoteMainSequence:0,attributes:new Map,avChatRoomKey:e}),v.l("".concat(this._n,".initGroupAttributesCache groupID:").concat(t," avChatRoomKey:").concat(e));}},{key:"initGroupAttributes",value:function(e){var n=this,o=e.groupID,i=e.groupAttributes,e=this._getLocalGroupAttributes(o),t=e.remoteMainSequence,e=e.avChatRoomKey,a=new M("initGroupAttributes");return a.setMessage("groupID:".concat(o," avChatRoomKey:").concat(e," mainSequence:").concat(t)),this._grpM.req({P:I.SET_GRP_ATTR,data:{groupID:o,avChatRoomKey:e,mainSequence:t,groupAttributeList:this._transformGroupAttributes(i)}}).then(function(e){v.l("".concat(n._n,".").concat("initGroupAttributes"," ok. groupID:").concat(o));var e=e.data,t=e.mainSequence,e=D(e.groupAttributeList);return e.forEach(function(e){e.value=i[e.key];}),n._groupAttributesCopy=n._getCachedAttributes({groupID:o}),n._refreshCachedGroupAttributes({groupID:o,remoteMainSequence:t,groupAttributeList:e,operationType:1}),n._emitGroupAttributesUpdated(o),a.end(),Ln({groupAttributes:i})}).catch(function(e){return a.setError(e).end(),C(e)})}},{key:"setGroupAttributes",value:function(e){var n=this,o="".concat(this._n,".").concat("setGroupAttributes"),i=e.groupID,a=e.groupAttributes,e=this._getLocalGroupAttributes(i),t=e.remoteMainSequence,s=e.avChatRoomKey,r=e.attributes,e=this._transformGroupAttributes(a),c=(e.forEach(function(e){var t=e.key;e.sequence=0,r.has(t)&&(e.sequence=r.get(t).sequence);}),new M("setGroupAttributes"));return c.setMessage("groupID:".concat(i," groupAttributes:").concat(JSON.stringify(a))),v.l("".concat(o,". groupID:").concat(i," mainSequence:").concat(t)),this._grpM.req({P:I.MODIFY_GRP_ATTR,data:{groupID:i,avChatRoomKey:s,mainSequence:t,groupAttributeList:e}}).then(function(e){v.l("".concat(o," ok."));var e=e.data,t=e.mainSequence,e=D(e.groupAttributeList);return e.forEach(function(e){e.value=a[e.key];}),n._groupAttributesCopy=n._getCachedAttributes({groupID:i}),n._refreshCachedGroupAttributes({groupID:i,remoteMainSequence:t,groupAttributeList:e,operationType:2}),n._emitGroupAttributesUpdated(i),c.end(),Ln({groupAttributes:a})}).catch(function(e){return c.setError(e).end(),C(e)})}},{key:"deleteGroupAttributes",value:function(e){var t=this,n=e.groupID,e=e.keyList,e=void 0===e?[]:e,o=this._getLocalGroupAttributes(n),i=o.remoteMainSequence,a=o.avChatRoomKey,s=o.attributes,r=D(s.keys()),o=I.CLEAR_GRP_ATTR,l=3,a={groupID:n,avChatRoomKey:a,mainSequence:i},c=[],u=(0<e.length&&(r=[],o=I.DEL_GRP_ATTR,l=4,e.forEach(function(e){var t=0;s.has(e)&&(t=s.get(e).sequence,r.push(e)),c.push({key:e,sequence:t});}),a.groupAttributeList=c),new M("deleteGroupAttributes"));return u.setMessage("groupID:".concat(n," mainSequence:").concat(i," keyList:").concat(e," proto:").concat(o)),this._grpM.req({P:o,data:a}).then(function(e){v.l("".concat(t._n,".").concat("deleteGroupAttributes"," ok. groupID:").concat(n));e=e.data.mainSequence;return t._groupAttributesCopy=t._getCachedAttributes({groupID:n}),t._refreshCachedGroupAttributes({groupID:n,remoteMainSequence:e,groupAttributeList:c,operationType:l}),t._emitGroupAttributesUpdated(n),u.end(),Ln({keyList:r})}).catch(function(e){return u.setError(e).end(),C(e)})}},{key:"getGroupAttributes",value:function(t){var n=this,o="".concat(this._n,".").concat("getGroupAttributes"),i=t.groupID,e=this._getLocalGroupAttributes(i),a=e.avChatRoomKey,s=e.lastUpdateTime,r=e.localMainSequence,e=e.remoteMainSequence,c=new M("getGroupAttributes");if(c.setMessage("groupID:".concat(i," localMainSequence:").concat(r," remoteMainSequence:").concat(e," keyList:").concat(t.keyList)),Date.now()-s>=this.CACHE_EXPIRE_TIME||r<e)return this._getGroupAttributes({groupID:i,avChatRoomKey:a}).then(function(e){c.setMoreMessage("get attributes from remote. count:".concat(e.length)).end(),v.l("".concat(o," from remote. groupID:").concat(i));e=n._getCachedAttributes(t);return Ln({groupAttributes:e})}).catch(function(e){return c.setError(e).end(),C(e)});c.setMoreMessage("get attributes from cache").end(),v.l("".concat(o," from cache. groupID:").concat(i));s=this._getCachedAttributes(t);return Sn({groupAttributes:s})}},{key:"_getGroupAttributes",value:function(o){var i=this,e=0;return A(o.avChatRoomKey)||(e=1),this._grpM.req({P:I.GET_GRP_ATTR,data:y(y({},o),{},{groupType:e})}).then(function(e){v.l("".concat(i._n,"._getGroupAttributes ok. groupID:").concat(o.groupID));var e=e.data,t=e.mainSequence,e=e.groupAttributeList,n=D(e);return A(t)||i._refreshCachedGroupAttributes({groupID:o.groupID,remoteMainSequence:t,groupAttributeList:n,operationType:5}),e}).catch(function(e){return C(e)})}},{key:"_refreshCachedGroupAttributes",value:function(e){var t=e.groupID,n=e.remoteMainSequence,o=e.groupAttributeList,e=e.operationType;if(this._hasLocalGroupAttributes(t)){var i=this._getLocalGroupAttributes(t),a=i.localMainSequence;if(5===e||n-a==1)i.remoteMainSequence=n,i.localMainSequence=n,i.lastUpdateTime=Date.now(),this._updateCachedAttributes({groupAttributes:i,groupAttributeList:o,operationType:e});else {if(a===n)return;i.remoteMainSequence=n;}this._groupAttributesMap.set(t,i);o="operationType:".concat(e," localMainSequence:").concat(a," remoteMainSequence:").concat(n);v.l("".concat(this._n,"._refreshCachedGroupAttributes. ").concat(o));}}},{key:"_getCachedAttributes",value:function(e){var t=e.groupID,e=e.keyList,e=void 0===e?[]:e,n={};if(this._hasLocalGroupAttributes(t)){var o=this._getLocalGroupAttributes(t).attributes;if(0<e.length)e.forEach(function(e){o.has(e)&&(n[e]=o.get(e).value);});else {var i,a=N(o.keys());try{for(a.s();!(i=a.n()).done;){var s=i.value;n[s]=o.get(s).value;}}catch(e){a.e(e);}finally{a.f();}}}return n}},{key:"_updateCachedAttributes",value:function(e){var o=e.groupAttributes,t=e.groupAttributeList,e=e.operationType;3!==e?4!==e?(1===e&&o.attributes.clear(),t.forEach(function(e){var t=e.key,n=e.value,e=e.sequence;o.attributes.set(t,{value:n,sequence:e});})):t.forEach(function(e){o.attributes.delete(e.key);}):o.attributes.clear();}},{key:"_hasLocalGroupAttributes",value:function(e){return this._groupAttributesMap.has(e)}},{key:"_getLocalGroupAttributes",value:function(e){return this._hasLocalGroupAttributes(e)||this.initGroupAttributesCache({groupID:e}),this._groupAttributesMap.get(e)}},{key:"_transformGroupAttributes",value:function(t){var n=[];return Object.keys(t).forEach(function(e){n.push({key:e,value:t[e]});}),n}},{key:"_emitGroupAttributesUpdated",value:function(e){var t=this._getCachedAttributes({groupID:e}),n=this._computeAttrChangedInfo(t),o=n.updatedKeyList,n=n.deletedKeyList;v.l("".concat(this._n,"._emitGroupAttributesUpdated update:").concat(o.length,", delete:").concat(n.length)),0===o.length&&0===n.length||this._grpM.emitOEvt(G.GROUP_ATTRIBUTES_UPDATED,{groupID:e,groupAttributes:t,updatedKeyList:o,deletedKeyList:n});}},{key:"_computeAttrChangedInfo",value:function(t){var n=this,o=[],i=[];return Object.keys(t).forEach(function(e){t[e]!==n._groupAttributesCopy[e]&&o.push(e);}),Object.keys(this._groupAttributesCopy).forEach(function(e){A(t[e])&&i.push(e);}),this._groupAttributesCopy={},{updatedKeyList:o,deletedKeyList:i}}},{key:"deleteLocalGroupAttributes",value:function(e){this._hasLocalGroupAttributes(e)&&this._groupAttributesMap.delete(e);}},{key:"reset",value:function(){this._groupAttributesMap.clear(),this._groupAttributesCopy={},this.CACHE_EXPIRE_TIME=3e4;}}]),ea),vi=(e($i,[{key:"_onCloudConfig",value:function(){var e=this._grpM.getCloudConfig("grp_counter_expire_time");A(e)||(this.EXPIRE_TIME=Number(e));}},{key:"isGroupCountersNotice",value:function(e){var t=e.to,e=e.elements.groupCounterInfo,n=!1;return Je(e)||(this._onGroupCountersUpdated({groupID:t,groupCounterInfo:e}),n=!0),n}},{key:"_onGroupCountersUpdated",value:function(e){var o=this,i=e.groupID;e.groupCounterInfo.forEach(function(e){var t=e.type,n=e.groupCounterSeq,e=e.counterList,e=void 0===e?[]:e;0!==t&&2!==t||(o._updateLocalGroupCounters({groupID:i,groupCounterSeq:n,counterList:e}),e.forEach(function(e){o._grpM.emitOEvt(G.GROUP_COUNTER_UPDATED,{groupID:i,key:e.key,value:e.value});})),1===t&&o._deleteLocalGroupCounters({groupID:i,groupCounterSeq:n,counterList:e});}),v.l("".concat(this._n,"._onGroupCountersUpdated groupID:").concat(i));}},{key:"initGroupCountersCache",value:function(e){var t=e.groupID,e=e.avChatRoomKey;this._groupCountersMap.set(t,{lastUpdateTime:0,groupCounterSeq:0,counters:new Map,avChatRoomKey:e}),v.l("".concat(this._n,".initGroupCountersCache groupID:").concat(t," avChatRoomKey:").concat(e));}},{key:"setGroupCounters",value:function(e){if(!this._grpM.canIUse(H.GRP_COUNTER))return this._grpM.noUse("setGroupCounters");var t="".concat(this._n,".").concat("setGroupCounters"),n=e.groupID,e=e.counters,e=this._convertObjectToList(e),o=this._getLocalGroupCounters(n).avChatRoomKey,i="groupID:".concat(n," count:").concat(e.length),a=new M("setGroupCounters");return a.setMessage("".concat(i)),v.l("".concat(t,". ").concat(i)),this._updateGroupCounters({groupID:n,counterList:e,avChatRoomKey:o,mode:"Set"}).then(function(e){return a.end(),v.l("".concat(t," ok.")),Ln({counters:e})}).catch(function(e){return a.setError(e).end(),v.e("".concat(t," failed. error:"),e),C(e)})}},{key:"increaseGroupCounter",value:function(e){var t="increaseGroupCounter";if(!this._grpM.canIUse(H.GRP_COUNTER))return this._grpM.noUse(t);var n="".concat(this._n,".").concat(t),o=e.groupID,i=e.key,e=e.value,a=this._getLocalGroupCounters(o).avChatRoomKey,s="groupID:".concat(o," key:").concat(i," value:").concat(e),r=new M(t);return r.setMessage("".concat(s)),v.l("".concat(n,". ").concat(s)),this._updateGroupCounters({groupID:o,counterList:[{key:i,value:e}],avChatRoomKey:a,mode:"Increase"}).then(function(e){return r.end(),v.l("".concat(n," ok.")),Ln({counters:e})}).catch(function(e){return r.setError(e).end(),v.e("".concat(n," failed. error:"),e),C(e)})}},{key:"decreaseGroupCounter",value:function(e){var t="decreaseGroupCounter";if(!this._grpM.canIUse(H.GRP_COUNTER))return this._grpM.noUse(t);var n="".concat(this._n,".").concat(t),o=e.groupID,i=e.key,e=e.value,a=this._getLocalGroupCounters(o).avChatRoomKey,s="groupID:".concat(o," key:").concat(i," value:").concat(e),r=new M(t);return r.setMessage("".concat(s)),v.l("".concat(n,". ").concat(s)),this._updateGroupCounters({groupID:o,counterList:[{key:i,value:e}],avChatRoomKey:a,mode:"Decrease"}).then(function(e){return r.end(),v.l("".concat(n," ok.")),Ln({counters:e})}).catch(function(e){return r.setError(e).end(),v.e("".concat(n," failed. error:"),e),C(e)})}},{key:"getGroupCounters",value:function(e){var t=this;if(!this._grpM.canIUse(H.GRP_COUNTER))return this._grpM.noUse("getGroupCounters");var n="".concat(this._n,".").concat("getGroupCounters"),o=e.groupID,e=e.keyList,i=void 0===e?[]:e,e=this._getLocalGroupCounters(o),a=e.avChatRoomKey,e=e.lastUpdateTime,s=new M("getGroupCounters");if(s.setMessage("groupID:".concat(o)),Date.now()-e>=this.EXPIRE_TIME)return this._getRemoteGroupCounters({groupID:o,avChatRoomKey:a}).then(function(e){s.setMoreMessage("from remote. count:".concat(e.length)).end(),v.l("".concat(n," from remote. groupID:").concat(o));e=t._getLocalCounters(o,i);return Ln({counters:e})}).catch(function(e){return s.setError(e).end(),C(e)});s.setMoreMessage("from cache").end(),v.l("".concat(n," from cache. groupID:").concat(o));e=this._getLocalCounters(o,i);return Sn({counters:e})}},{key:"_getRemoteGroupCounters",value:function(n){var o=this;return this._grpM.req({P:I.GET_GRP_COUNTER,data:y({},n)}).then(function(e){var e=e.data,t=e.counterList,t=void 0===t?[]:t,e=e.groupCounterSeq;return o._updateLocalGroupCounters({groupID:n.groupID,counterList:t,groupCounterSeq:e}),v.l("".concat(o._n,"._getRemoteGroupCounters ok. groupID:").concat(n.groupID)),t}).catch(function(e){return C(e)})}},{key:"_convertObjectToList",value:function(t){var n=[];return Object.keys(t).forEach(function(e){n.push({key:e,value:t[e]});}),n}},{key:"_updateGroupCounters",value:function(e){var t="".concat(this._n,"._updateGroupCounters"),n=e.groupID,o=e.avChatRoomKey,i=e.mode;return v.l("".concat(t,". groupID:").concat(n," avChatRoomKey:").concat(o," mode:").concat(i)),this._grpM.req({P:I.UPDATE_GRP_COUNTER,data:y({},e)}).then(function(e){v.l("".concat(t," ok."));var e=e.data.counterList,n={};return (void 0===e?[]:e).forEach(function(e){var t=e.key,e=e.value;n[t]=e;}),n}).catch(function(e){return C(e)})}},{key:"_hasLocalGroupCounters",value:function(e){return this._groupCountersMap.has(e)}},{key:"_getLocalGroupCounters",value:function(e){return this._hasLocalGroupCounters(e)||this.initGroupCountersCache({groupID:e}),this._groupCountersMap.get(e)}},{key:"_updateLocalGroupCounters",value:function(e){var n,t,o,i=e.groupID,a=e.counterList,a=void 0===a?[]:a,e=e.groupCounterSeq;this._hasLocalGroupCounters(i)&&(o=this._getLocalGroupCounters(i),n=o.counters,t=o.avChatRoomKey,o=o.groupCounterSeq,0<e&&e<o||(a.forEach(function(e){var t=e.key,e=e.value;n.set(t,e);}),this._groupCountersMap.set(i,{lastUpdateTime:Date.now(),groupCounterSeq:e,counters:n,avChatRoomKey:t})));}},{key:"_deleteLocalGroupCounters",value:function(e){var t,n,o=e.groupID,i=e.counterList,i=void 0===i?[]:i,e=e.groupCounterSeq;this._hasLocalGroupCounters(o)&&(n=this._getLocalGroupCounters(o),t=n.counters,n=n.avChatRoomKey,i.forEach(function(e){t.delete(e.key);}),this._groupCountersMap.set(o,{lastUpdateTime:Date.now(),groupCounterSeq:e,counters:t,avChatRoomKey:n}));}},{key:"_getLocalCounters",value:function(e,t){var n={};if(!this._hasLocalGroupCounters(e))return n;var o=this._getLocalGroupCounters(e).counters;if(0<t.length)t.forEach(function(e){o.has(e)&&(n[e]=o.get(e));});else {var i,a=N(o.keys());try{for(a.s();!(i=a.n()).done;){var s=i.value;n[s]=o.get(s);}}catch(e){a.e(e);}finally{a.f();}}return n}},{key:"reset",value:function(){this._groupCountersMap.clear(),this.EXPIRE_TIME=3e4;}}]),$i),Ii=(e(Qi,[{key:"start",value:function(){var e=this._grpM.isLoggedIn();e||(this._proto=I.AV_NOAUTH_POLLING),v.l("".concat(this._n,".start pollingInterval:").concat(this._manager.getPollingInterval()," isLoggedIn:").concat(e)),this._isRunning=!0,this._request();}},{key:"isRunning",value:function(){return this._isRunning}},{key:"_request",value:function(){var t=this,e=this._onInit(this._groupID);this._grpM.req({P:this._proto,data:e}).then(function(e){t._onSuccess(t._groupID,e),t.isRunning()&&(-1<t._timeoutID&&clearTimeout(t._timeoutID),t._timeoutID=setTimeout(t._request.bind(t),t._manager.getPollingInterval()));}).catch(function(e){t._onFail(t._groupID,e),t.isRunning()&&(-1<t._timeoutID&&clearTimeout(t._timeoutID),t._timeoutID=setTimeout(t._request.bind(t),t._manager.MAX_POLLING_INTERVAL));});}},{key:"stop",value:function(){v.l("".concat(this._n,".stop")),-1<this._timeoutID&&(clearTimeout(this._timeoutID),this._timeoutID=-1),this._isRunning=!1;}},{key:"getPollingTimerID",value:function(){return this._timeoutID}}]),Qi),Mi={3:!0,4:!0,5:!0,6:!0,17:!0,20:!0,21:!0,100:!0},yi=(e(Zi,[{key:"hasJoinedAVChatRoom",value:function(){var e=[];return 0<(e=0<this._joinedGroupMap.size?D(this._joinedGroupMap.values()).filter(function(e){return e.type===R.GRP_AVCHATROOM}):e).length}},{key:"getJoinedLiveList",value:function(){var e=[];return e=0<this._joinedGroupMap.size?D(this._joinedGroupMap.values()).filter(function(e){return e.type===R.GRP_LIVE}):e}},{key:"checkJoinedAVChatRoomByID",value:function(e){return this._joinedGroupMap.has(e)}},{key:"getJoinedAVChatRoom",value:function(){return 0<this._joinedGroupMap.size?D(this._joinedGroupMap.keys()):[]}},{key:"_updatedata",value:function(e){var t=this._pollingRequestInfoMap.get(e);return e===D(this._pollingInstanceMap.keys())[0]?y(y({},t),{},{startBroadcastSeq:this._startBroadcastSeq,simplifiedMessage:this.DEFAULT_POLLING_SIMPLIFIED_MSG}):y(y({},t),{},{simplifiedMessage:this.DEFAULT_POLLING_SIMPLIFIED_MSG})}},{key:"_handleSuccess",value:function(e,t){var n,o=t.data,i=o.key,a=o.nextSeq,s=o.rspMsgList,r=o.errorCode,c=o.nextBroadcastSeq,o=o.broadcastMessageList;0!==r?(r=this._pollingRequestInfoMap.get(e),n=new M("longPollingAVError"),r=r?"".concat(r.key,"-").concat(r.startSeq):"requestInfo is undefined",n.setMessage("".concat(e,"-").concat(r,"-").concat(t.errorInfo)).setCode(t.errorCode).end(!0)):this.checkJoinedAVChatRoomByID(e)&&(ft(i)&&Qe(a)&&this._pollingRequestInfoMap.set(e,{key:i,startSeq:a}),Qe(c)&&c>this._startBroadcastSeq&&(this._startBroadcastSeq=c),nt(s)&&0<s.length?(s.forEach(function(e){e.to=e.groupID;}),this.onMessage(s,e)):(this._pollingNoMessageCount+=1,this._pollingNoMessageCount===this.DEFAULT_POLLING_NO_MESSAGE_COUNT&&(this._pollingInterval=this.DEFAULT_POLLING_INTERVAL+this.DEFAULT_POLLING_INTERVAL_PLUS)),this._onBroadcastMessage(o));}},{key:"_handleFailure",value:function(e,t){}},{key:"onMessage",value:function(e,t){if(nt(e)&&0!==e.length){var n="".concat(this._n,".onMessage"),o=(t&&(n+=" groupID:".concat(t)),0!==this._pollingNoMessageCount&&(this._pollingNoMessageCount=0,this._pollingInterval=this.DEFAULT_POLLING_INTERVAL),null),i=[],l=this._get(11),a=this._get(26),d=e.length,p=(1<d&&e.sort(function(e,t){return e.sequence-t.sequence}),this._get(12).isUnlimitedAVChatRoom()),s=!1;v.getLevel()<=0&&(t=e.map(function(e){return e.sequence}),v.l("".concat(n," count:").concat(t.length," sequenceList:").concat(t)),t.length=0);for(var _=0;_<d;_++){var r=this.restoreMessageFromSimplified(e[_]);if(Mi[r.event]){if(6===r.event){if(this._grpM.isGroupAttributesUpdatedNotice(r))continue;if(this._grpM.isGroupCountersNotice(r))continue}if(20!==r.event)if(21!==r.event)if(100!==r.event){var o=this.packMessage(r,r.event),c=1===r.isModified,s=1===r.isHistoryMessage;if(!p){if(this._seqSll.has(o.sequence))continue;this._seqSll.set(o.sequence);}var u=this._IDSll.has(o.ID);u?v.w("".concat(n," ID:").concat(o.ID," has:").concat(u)):(this._IDSll.set(o.ID),u=!1,!s&&this._isMessageSentByCurrentInstance(o)?c&&(u=!0,o.isModified=c,l.updateMsgIsModifiedProp(o)):u=!0,u&&(o.conversationType===R.CONV_SYSTEM&&5===o.payload.operationType&&this._onGroupDismissed(o.payload.groupProfile.groupID),s||o.conversationType===R.CONV_SYSTEM||(c=o.conversationID.replace(R.CONV_GROUP,""),this._pollingInstanceMap.has(c)?this._grpM.isLoggedIn()&&a.addMessageSequence({key:$n,message:o}):(o.type!==R.MSG_GRP_TIP&&0<o.clientTime&&a.addMessageDelay(o.clientTime),a.addMessageSequence({key:Qn,message:o}))),i.push(o)));}else this.onRoomCustomData(r);else this._get(34).onMessageReactionNotify({event:21,dataList:r.elements.messageReactionNotifyList});else this.handleMessageRevokedNotice(r);}else v.w("".concat(n,". unknown event:").concat(r.event));}0!==i.length&&(0<(t=Dt(i)).length&&this._grpM.emitOEvt(G.MESSAGE_MODIFIED,t),s||0<(t=this.packConversationOption(i)).length&&l.onNewMessage({conversationOptionsList:t,isInstantMessage:!0}),this._checkMessageStacked(i),0<(t=Et(i)).length&&this._grpM.emitOEvt(G.MESSAGE_RECEIVED,t),i.length=0);}}},{key:"handleMessageRevokedNotice",value:function(e){var t=this,i=e.groupID,n=e.elements.revokeMsgList,a=e.revokerInfo,s=[];n.forEach(function(e){var t=e.tinyID,n=e.clientTime,o=e.random,e=e.sequence,t={conversationID:"".concat(R.CONV_GROUP).concat(i),ID:"".concat(t,"-").concat(n,"-").concat(o),revoker:a.revoker,revokeReason:a.reason||"",revokerInfo:{userID:a.revoker,nick:"",avatar:""},sequence:e};s.push(t);}),0!==s.length&&this._get(11).updateRevokerInfo(s).then(function(e){t._grpM.emitOEvt(G.MESSAGE_REVOKED,e);});}},{key:"isBroadcastOrNormal",value:function(e){return 3===e||17===e}},{key:"isGroupTip",value:function(e){return 4===e||6===e}},{key:"isGroupSystemNotice",value:function(e){return 5===e}},{key:"restoreGroupTipElements",value:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},t=e.operatorInfo,t=void 0===t?{}:t,n=e.operatorID,o=e.userIDList,o=void 0===o?[]:o,i=e.operationType,i=(Qe(e.groupJoinType)||1!==i&&2!==i||(e.groupJoinType=2===i?0:1),t.userID),a=t.avatar,t=t.nick,n=(e.operatorInfo={userID:void 0===i?n:i,avatar:void 0===a?"":a,nick:void 0===t?"":t},o.map(function(e){return {userID:e}}));return e.memberInfoList=e.memberInfoList||n,e}},{key:"restoreMessageFromSimplified",value:function(n){var e,t,o,i=n.event;return this.isBroadcastOrNormal(i)&&(n.cloudCustomData=n.cloudCustomData||"",n.elements=n.elements.map(function(e){var t;return e.type===R.MSG_CUSTOM&&(t=e.content,e.content=y({data:"",description:"",extension:""},void 0===t?{}:t)),e})),(this.isGroupTip(i)||this.isGroupSystemNotice(i))&&(n.from=n.from||"@TIM#SYSTEM"),this.isGroupTip(i)&&(n.elements=this.restoreGroupTipElements(n.elements),t=(o=void 0===(o=n.elements)?{}:o).operationType,e=o.operatorInfo,1===t&&(t=[{userID:(void 0===e?{}:e).userID}],o.memberInfoList=o.memberInfoList||t)),this.isGroupSystemNotice(i)&&(o=(e=n.elements).memberInfoList,t=e.operatorInfo,n.elements.memberInfoList=y({userID:n.elements.operatorID,avatar:"",nick:""},o=o||(void 0===t?{}:t)),n.elements=y({authentication:"",remarkInfo:"",messageKey:1e3*n.time},n.elements),i=Object.keys(n.elements).filter(function(e){return "operatorInfo"!==e}).reduce(function(e,t){return y(y({},e),{},c({},t,n.elements[t]))},{}),n.elements=i),n}},{key:"_onGroupDismissed",value:function(e){v.l("".concat(this._n,"._onGroupDismissed groupID:").concat(e)),this._grpM.deleteLocalGroupAndConversation(e),this.reset(e);}},{key:"_checkMessageStacked",value:function(e){var t="MessageStacked",e=e.length;100<=e&&(this._grpM.warn(t,e),this._reportMessageStackedCount<5&&(new M(t).setMessage("count:".concat(e," groupID:").concat(D(this._joinedGroupMap.keys()))).setLevel("warning").end(),this._reportMessageStackedCount+=1));}},{key:"_isMessageSentByCurrentInstance",value:function(e){return !!this._get(11).isMessageSentByCurrentInstance(e)}},{key:"packMessage",value:function(e,t){e.currentUser=this._grpM.getMyUserID(),e.conversationType=5===t?R.CONV_SYSTEM:R.CONV_GROUP,e.isSystemMessage=!!e.isSystemMessage;var n=new ko(e),e=this.packElements(e,t),t=this._grpM.getFileDownloadProxy(),o=this._grpM.getDowloadFileAuthKey(),i=this._get(17).getFileDNList();return n.setElement(e,t,o,i),n}},{key:"packElements",value:function(e,t){return 4===t||6===t?(this._updateMemberCountByGroupTips(e),{type:R.MSG_GRP_TIP,content:y(y({},e.elements),{},{groupProfile:e.groupProfile})}):5===t?{type:R.MSG_GRP_SYS_NOTICE,content:y(y({},e.elements),{},{groupProfile:y(y({},e.groupProfile),{},{groupID:e.groupID})})}:e.elements}},{key:"packConversationOption",value:function(e){for(var t=new Map,n=0;n<e.length;n++){var o,i=e[n],a=i.conversationID;t.has(a)?"in"===((o=t.get(a)).lastMessage=i).flow&&o.unreadCount++:t.set(a,{conversationID:i.conversationID,unreadCount:"out"===i.flow?0:1,type:i.conversationType,subType:i.conversationSubType,lastMessage:i});}return D(t.values())}},{key:"_updateMemberCountByGroupTips",value:function(e){var t,n,o,i=e.groupProfile.groupID,e=e.elements.onlineMemberInfo,e=void 0===e?void 0:e;Je(e)||(t=void 0===(t=e.onlineMemberNum)?0:t,e=void 0===(e=e.expireTime)?this.DEFAULT_EXPIRE_TIME:e,n=this._onlineMemberCountMap.get(i)||{},o=Date.now(),Je(n)?Object.assign(n,{lastReqTime:0,lastSyncTime:0,latestUpdateTime:o,memberCount:t,expireTime:e}):(n.latestUpdateTime=o,n.memberCount=t),this._onlineMemberCountMap.set(i,n));}},{key:"_onBroadcastMessage",value:function(e){if(!Je(e)){for(var t=[],n=e.length,o=null,i=0;i<n;i++){var a=this.restoreMessageFromSimplified(e[i]);Mi[a.event]?((o=this.packMessage(a,a.event)).isBroadcastMessage=!0,this._broadcastMessageIDMap.has(o.ID)||(t.push(o),this._broadcastMessageIDMap.set(o.ID,1))):v.w("".concat(this._n,"._onBroadcastMessage unknown event:").concat(a.event));}0<t.length&&this._grpM.emitOEvt(G.MESSAGE_RECEIVED,t);}}},{key:"start",value:function(e){var t;this._pollingInstanceMap.has(e)?(t=this._pollingInstanceMap.get(e)).isRunning()||t.start():((t=new Ii({manager:this,groupID:e,onInit:this._updatedata.bind(this),onSuccess:this._handleSuccess.bind(this),onFail:this._handleFailure.bind(this)})).start(),this._pollingInstanceMap.set(e,t),v.l("".concat(this._n,".start groupID:").concat(e)));}},{key:"handleJoinResult",value:function(o){var i=this;return this._preCheck(o.group).then(function(){var e=o.longPollingKey,t=o.group,n=t.groupID;return i._joinedGroupMap.set(n,t),i._grpM.updateGroupMap([t]),i._grpM.deleteUnjoinedAVChatRoom(n),i._grpM.emitGroupListUpdate(!0,!1),A(e)?Sn({status:Ke,group:t}):Promise.resolve()})}},{key:"startRunLoop",value:function(i){var a=this;return this.handleJoinResult(i).then(function(){var e=i.longPollingKey,t=i.group,n=i.startSeq,o=t.groupID;return a._pollingRequestInfoMap.set(o,{key:e,startSeq:void 0===n?0:n}),a.start(o),a._grpM.isLoggedIn()?Sn({status:Ke,group:t}):Sn({status:Ke})})}},{key:"_preCheck",value:function(e){if(this._get(12).isUnlimitedAVChatRoom())return Promise.resolve();if(!this.hasJoinedAVChatRoom())return Promise.resolve();if(e.type===R.GRP_LIVE)return Promise.resolve();var e=m(this._joinedGroupMap.entries().next().value,2),t=e[0],e=e[1];if(this._grpM.isLoggedIn()){if(e.selfInfo.role!==R.GRP_MBR_ROLE_OWNER&&e.ownerID!==this._grpM.getMyUserID())return this._grpM.quitGroup(t);this._grpM.deleteLocalGroupAndConversation(t);}else this._grpM.deleteLocalGroupAndConversation(t);return this.reset(t),Promise.resolve()}},{key:"joinWithoutAuth",value:function(e){var n=this,o=e.groupID,i="".concat(this._n,".").concat("joinWithoutAuth"),a=new M("joinWithoutAuth");return this._grpM.req({P:I.APPLY_JOIN_GRP_NOAUTH,data:e}).then(function(e){e=e.data.longPollingKey;if(a.setMessage("groupID:".concat(o," longPollingKey:").concat(e)).end(!0),A(e))return C({code:T.CANNOT_JOIN_NON_AV_WITHOUT_LOGIN});v.l("".concat(i," ok. groupID:").concat(o)),n._get(11).setCompleted("".concat(R.CONV_GROUP).concat(o));var t=new ui({groupID:o});return n.startRunLoop({group:t,longPollingKey:e}),Ln({status:Ke})}).catch(function(e){return v.e("".concat(i," failed. groupID:").concat(o," error:"),e),a.setError(e).setMessage("groupID:".concat(o)).end(!0),C(e)}).finally(function(){n._grpM.get(14).reportAtOnce();})}},{key:"getGroupOnlineMemberCount",value:function(e){var t=this._onlineMemberCountMap.get(e)||{},n=Date.now();return Je(t)||n-t.lastSyncTime>1e3*t.expireTime&&1e4<n-t.latestUpdateTime&&3e3<n-t.lastReqTime?(t.lastReqTime=n,this._onlineMemberCountMap.set(e,t),this._getGroupOnlineMemberCount(e).then(function(e){return Ln({memberCount:e.memberCount})}).catch(function(e){return C(e)})):Sn({memberCount:t.memberCount})}},{key:"_getGroupOnlineMemberCount",value:function(i){var a=this,s="".concat(this._n,".").concat("_getGroupOnlineMemberCount"),t=new M("_getGroupOnlineMemberCount");return this._grpM.requestOnlineCount(i).then(function(e){var t=a._onlineMemberCountMap.get(i)||{},e=e.data,n=e.memberCount,n=void 0===n?0:n,e=e.expireTime,e=void 0===e?a.DEFAULT_EXPIRE_TIME:e,o=(v.l("".concat(s," ok. groupID:").concat(i," memberCount:").concat(n," expireTime:").concat(e)),Date.now());return Je(t)&&(t.lastReqTime=o),a._onlineMemberCountMap.set(i,Object.assign(t,{lastSyncTime:o,latestUpdateTime:o,memberCount:n,expireTime:e})),{memberCount:n}}).catch(function(e){return v.w("".concat(s," failed. error:"),e),t.setCode(e.code).setMessage("groupID:".concat(i," error:").concat(JSON.stringify(e))).end(),Promise.reject(e)})}},{key:"_get",value:function(e){return this._grpM.get(e)}},{key:"setPollingInterval",value:function(e){A(e)||(Qe(e)?this._pollingInterval=this.DEFAULT_POLLING_INTERVAL=e:this._pollingInterval=this.DEFAULT_POLLING_INTERVAL=parseInt(e,10));}},{key:"setPollingIntervalPlus",value:function(e){A(e)||(Qe(e)?this.DEFAULT_POLLING_INTERVAL_PLUS=e:this.DEFAULT_POLLING_INTERVAL_PLUS=parseInt(e,10));}},{key:"setPollingNoMessageCount",value:function(e){A(e)||(Qe(e)?this.DEFAULT_POLLING_NO_MESSAGE_COUNT=e:this.DEFAULT_POLLING_NO_MESSAGE_COUNT=parseInt(e,10));}},{key:"setPollingSimplifiedMessage",value:function(e){A(e)||"0"!==e&&"1"!==e||(this.DEFAULT_POLLING_SIMPLIFIED_MSG=parseInt(e,10));}},{key:"getPollingInterval",value:function(){return this._pollingInterval}},{key:"onAVChatRoomMemberBanned",value:function(e){e=e.payload.groupProfile.groupID;v.l("".concat(this._n,".onAVChatRoomMemberBanned groupID:").concat(e)),this._grpM.deleteLocalGroupAndConversation(e),this.reset(e);}},{key:"restartPolling",value:function(){v.l("".concat(this._n,".restartPolling count:").concat(this._pollingInstanceMap.size));var e,t=N(this._pollingInstanceMap.values());try{for(t.s();!(e=t.n()).done;){var n=e.value;n.stop(),n.start();}}catch(e){t.e(e);}finally{t.f();}}},{key:"getPollingTimerID",value:function(e){if(!this._pollingInstanceMap.has(e))return -1;var t=this._pollingInstanceMap.get(e).getPollingTimerID();return v.l("".concat(this._n,".getPollingTimerID groupID:").concat(e," timerID:").concat(t)),t}},{key:"hasPollingInstance",value:function(e){return this._pollingInstanceMap.has(e)}},{key:"onRoomCustomData",value:function(e){var t=e.groupID,n=e.sequence,o=e.time,e=e.elements,e=e&&e.content;this._get(30).onRoomCustomDataReceived(e),v.l("".concat(this._n,".onRoomCustomData groupID:").concat(t," sequence:").concat(n," time:").concat(o," data:").concat(e));}},{key:"reset",value:function(e){if(e){v.l("".concat(this._n,".reset groupID:").concat(e));var t=this._pollingInstanceMap.get(e);t&&t.stop(),this._pollingInstanceMap.delete(e),this._joinedGroupMap.delete(e),this._pollingRequestInfoMap.delete(e),this._onlineMemberCountMap.delete(e);}else {v.l("".concat(this._n,".reset all"));var n,o=N(this._pollingInstanceMap.values());try{for(o.s();!(n=o.n()).done;)n.value.stop();}catch(e){o.e(e);}finally{o.f();}this._pollingInstanceMap.clear(),this._joinedGroupMap.clear(),this._pollingRequestInfoMap.clear(),this._onlineMemberCountMap.clear(),this._broadcastMessageIDMap.clear();}this._seqSll.reset(),this._IDSll.reset(),this._reportMessageStackedCount=0,this._pollingInterval=this.DEFAULT_POLLING_INTERVAL=300,this.DEFAULT_POLLING_NO_MESSAGE_COUNT=20,this.DEFAULT_POLLING_INTERVAL_PLUS=2e3,this._pollingNoMessageCount=0;}}]),Zi),Ci=(e(Xi,[{key:"updateMember",value:function(e){A(e.onlineStatus)||(this.isOnline="Online"===e.onlineStatus);var t=[null,void 0,"",0,NaN];e.memberCustomField&&Tt(this.memberCustomField,e.memberCustomField),rt(this,e,["memberCustomField","marks","onlineStatus"],t);}},{key:"updateRole",value:function(e){["Owner","Admin","Member"].indexOf(e)<0||(this.role=e);}},{key:"updateMuteUntil",value:function(e){A(e)||(this.muteUntil=Math.floor((Date.now()+1e3*e)/1e3));}},{key:"updateNameCard",value:function(e){A(e)||(this.nameCard=e);}},{key:"updateMemberCustomField",value:function(e){e&&Tt(this.memberCustomField,e);}}]),Xi),Ti=(e(zi,[{key:"_onProfileUpdated",value:function(e){for(var n=this,o=e.data,t=0;t<o.length;t++)!function(e){var t=o[e];n.groupMemberListMap.forEach(function(e){e.has(t.userID)&&e.get(t.userID).updateMember({nick:t.nick,avatar:t.avatar});});}(t);}},{key:"deleteGroupMemberList",value:function(e){this.groupMemberListMap.delete(e);}},{key:"getGroupMemberList",value:function(e){var t,o=this,i=e.groupID,n=e.role,n=void 0===n?void 0:n,a=e.offset,s=void 0===a?0:a,a=e.count,r=void 0===a?15:a,a=e.filter,e=void 0===a?void 0:a,c="".concat(this._n,".").concat("getGroupMemberList"),a=this._grpM.hasLocalGroup(i);if(v.l("".concat(c," groupID:").concat(i," role:").concat(n," offset:").concat(s," count:").concat(r," hasLocalGroup:").concat(a)),!a)return Sn({memberList:[],offset:0});if(this._grpM.getLocalGroupProfile(i).type===R.GRP_AVCHATROOM){if(this._grpM.canIUse(H.AV_MBR_LIST))return this._getAVChatRoomMemberList({groupID:i,offset:s,filter:e});this._grpM.warn("LiveOnlineMember");}n!==R.GRP_MBR_ROLE_ADMIN&&n!==R.GRP_MBR_ROLE_OWNER&&n!==R.GRP_MBR_ROLE_MEMBER||(t=n);var l=new M("getGroupMemberList"),u=0,a={groupID:i,limit:100<r?100:r,memberRoleFilter:t?[t]:void 0,memberInfoFilter:this.DEFAULT_MEMBER_INFO_FILTER},d=(St({groupID:i})?a.next="".concat(s):(a.offset=s,u=s+r),[]);return this._grpM.req({P:I.GET_GRP_MBR_LIST,data:a}).then(function(e){var e=e.data,t=e.members,n=e.memberNum,e=e.next,e=void 0===e?void 0:e;return A(e)||(u=Je(e)?0:e),nt(t)&&0!==t.length?(o._grpM.hasLocalGroup(i)&&(o._grpM.getLocalGroupProfile(i).memberNum=n),d=o._updateLocalGroupMemberMap(i,t),o._grpM.get(4).getUserProfile({userIDList:t.map(function(e){return e.userID}),tagList:[qe.NICK,qe.AVATAR]})):(u=0,Promise.resolve([]))}).then(function(e){e=e.data;if(!nt(e)||0===e.length)return Sn({memberList:[],offset:u});e=e.map(function(e){return {userID:e.userID,nick:e.nick,avatar:e.avatar}});return o._updateLocalGroupMemberMap(i,e),d.length<r&&(u=0),l.setMessage("groupID:".concat(i," offset:").concat(s," count:").concat(r)).end(),v.l("".concat(c," ok.")),Ln({memberList:d,offset:u})}).catch(function(e){return l.setError(e).end(),v.e("".concat(c," failed. error:"),e),C(e)})}},{key:"_getAVChatRoomMemberList",value:function(e){var n=this,o=e.groupID,t=e.offset,e=e.filter,i="".concat(this._n,".").concat("_getAVChatRoomMemberList"),a=new M("_getAVChatRoomMemberList");return a.setMessage("groupID:".concat(o," offset:").concat(t," filter:").concat(e)),this._grpM.req({P:I.GET_AV_MBR_LIST,data:{groupID:o,offset:t,filter:e}}).then(function(e){var e=e.data,t=e.memberList,t=void 0===t?[]:t,e=e.offset,e=void 0===e?0:e,t=(a.end(),v.l("".concat(i," ok. member count:").concat(t.length,", next request timestamp:").concat(e)),t.map(function(e){return y(y({},e),{},{onlineStatus:"Online"})})),t=n._updateLocalGroupMemberMap(o,t);return Ln({memberList:t,offset:e})}).catch(function(e){return a.setError(e).end(),v.e("".concat(i," failed. error:"),e),C(e)})}},{key:"getGroupMemberProfile",value:function(e){var t=this,n="getGroupMemberProfile",o="".concat(this._n,".").concat(n),i="groupID:".concat(e.groupID),a=(5<e.userIDList.length?i+=" userIDList.length:".concat(e.userIDList.length):i+=" userIDList:".concat(e.userIDList),v.l("".concat(o," ").concat(i)),50<e.userIDList.length&&(e.userIDList=e.userIDList.slice(0,50)),e.groupID),s=e.userIDList,o=this._grpM.getLocalGroupProfile(a);if(o&&Lt(o.type))return C({code:o=T.OPERATION_NOT_SUPPORTED_IN_AV,message:this._grpM.getErrMsg(o,n)});var r=new M(n);return r.setMessage(i),this._getGroupMemberProfileAdvance(y(y({},e),{},{userIDList:s})).then(function(e){e=e.data.members;return nt(e)&&0!==e.length?(t._updateLocalGroupMemberMap(a,e),t._grpM.get(4).getUserProfile({userIDList:e.map(function(e){return e.userID}),tagList:[qe.NICK,qe.AVATAR]})):Sn([])}).then(function(e){e=e.data.map(function(e){return {userID:e.userID,nick:e.nick,avatar:e.avatar}}),t._updateLocalGroupMemberMap(a,e),e=s.filter(function(e){return t.hasLocalGroupMember(a,e)}).map(function(e){return t.getLocalGroupMemberInfo(a,e)});return r.end(),Ln({memberList:e})})}},{key:"addGroupMember",value:function(a){var s=this,r="".concat(this._n,".").concat("addGroupMember"),e=a.groupID,c=this._grpM.getLocalGroupProfile(e),t=c.type,u=new M("addGroupMember");return u.setMessage("groupID:".concat(e," groupType:").concat(t)),Lt(t)?(t=new Hn({code:T.CANNOT_ADD_MEMBER_IN_AV}),u.setError(t).end(),C(t)):(a.userIDList=a.userIDList.map(function(e){return {userID:e}}),v.l("".concat(r," groupID:").concat(e)),this._grpM.req({P:I.ADD_GRP_MBR,data:a}).then(function(e){var e=e.data.members,t=(v.l("".concat(r," ok")),e.filter(function(e){return 1===e.result}).map(function(e){return e.userID})),n=e.filter(function(e){return 0===e.result}).map(function(e){return e.userID}),o=e.filter(function(e){return 2===e.result}).map(function(e){return e.userID}),e=e.filter(function(e){return 4===e.result}).map(function(e){return e.userID}),i="groupID:".concat(a.groupID,", ")+"successUserIDList:".concat(t,", ")+"failureUserIDList:".concat(n,", ")+"existedUserIDList:".concat(o,", ")+"overLimitUserIDList:".concat(e);return u.setMoreMessage(i).end(),0===t.length?Ln({successUserIDList:t,failureUserIDList:n,existedUserIDList:o,overLimitUserIDList:e}):(s._updateConvGroupProfile(c),Ln({successUserIDList:t,failureUserIDList:n,existedUserIDList:o,overLimitUserIDList:e,group:c}))}).catch(function(e){return u.setError(e).end(),v.e("".concat(r," failed. error:"),e),C(e)}))}},{key:"deleteGroupMember",value:function(e){var t=this,n="".concat(this._n,".").concat("deleteGroupMember"),o=e.groupID,i=e.userIDList,a=this._grpM.getLocalGroupProfile(o);if(A(a))return C({code:T.CANNOT_FIND_GRP});if(Lt(a.type))return this._grpM.canIUse(H.AV_BAN_MBR)?this._banAVChatRoomMember(e):this._grpM.noUse("deleteGroupMember");var s="groupID:".concat(o," ").concat(5<i.length?"userIDList.length:".concat(i.length):"userIDList:".concat(i)),r=(v.l("".concat(n," groupID:").concat(o," userIDList:"),i),new M("deleteGroupMember"));return r.setMessage(s),this._grpM.req({P:I.DEL_GRP_MBR,data:e}).then(function(){return r.end(),v.l("".concat(n," ok")),t._updateConvGroupProfile(a),t.deleteLocalGroupMembers(o,i),Ln({group:a,userIDList:i})}).catch(function(e){return r.setError(e).end(),v.e("".concat(n," failed. error:"),e),C(e)})}},{key:"_updateConvGroupProfile",value:function(e){this._grpM.get(11).updateConvGroupProfile([e]);}},{key:"_banAVChatRoomMember",value:function(e){var t=this,n="".concat(this._n,".").concat("_banAVChatRoomMember"),o=e.groupID,i=e.userIDList,a="groupID:".concat(o," ").concat(5<i.length?"userIDList.length:".concat(i.length):"userIDList:".concat(i)),s=new M("_banAVChatRoomMember"),r=(s.setMessage(a),v.l("".concat(n," groupID:").concat(o," userIDList:"),i),this._grpM.getLocalGroupProfile(o));return A(e.duration)||0===e.duration?C({code:T.BAN_DURATION_INVALID}):this._grpM.req({P:I.BAN_AV_MBR,data:e}).then(function(){return s.end(),v.l("".concat(n," ok")),t.deleteLocalGroupMembers(o,i),Ln({group:r,userIDList:i})}).catch(function(e){return s.setError(e).end(),v.e("".concat(n," failed. error:"),e),C(e)})}},{key:"setGroupMemberMuteTime",value:function(e){var n=this,o=e.groupID,t=e.userID,e=e.muteTime,i="".concat(this._n,".").concat("setGroupMemberMuteTime");if(t===this._grpM.getMyUserID())return C({code:T.CANNOT_MUTE_SELF});var a="groupID:".concat(o," userID:").concat(t," muteTime:").concat(e),s=(v.l("".concat(i," ").concat(a)),new M("setGroupMemberMuteTime"));return s.setMessage(a),this.modifyGroupMemberInfo({groupID:o,userID:t,muteTime:e}).then(function(e){s.end(),v.l("".concat(i," ok"));var t=n._grpM.getLocalGroupProfile(o);return Ln({group:t,member:e})}).catch(function(e){return s.setError(e).end(),v.e("".concat(i," failed. error:"),e),C(e)})}},{key:"setGroupMemberRole",value:function(e){var t="".concat(this._n,".").concat("setGroupMemberRole"),n=e.groupID,o=e.userID,e=e.role,i="groupID:".concat(n," userID:").concat(o," role:").concat(e),a=this._grpM.getLocalGroupProfile(n);if(a&&a.selfInfo.role!==R.GRP_MBR_ROLE_OWNER)return C({code:T.NOT_OWNER});var s=[R.GRP_MBR_ROLE_ADMIN,R.GRP_MBR_ROLE_MEMBER];if(St({groupID:n})&&s.push(R.GRP_MBR_ROLE_CUSTOM),s.indexOf(e)<0)return C({code:T.INVALID_MEMBER_ROLE});if(o===this._grpM.getMyUserID())return C({code:T.CANNOT_SET_SELF_MEMBER_ROLE});var r=new M("setGroupMemberRole");return r.setMessage(i),v.l("".concat(t," ").concat(i)),this.modifyGroupMemberInfo({groupID:n,userID:o,role:e}).then(function(e){return r.end(),v.l("".concat(t," ok")),Ln({group:a,member:e})}).catch(function(e){return r.setError(e).end(),v.e("".concat(t," failed. error:"),e),C(e)})}},{key:"_filterProfanity",value:function(e,t){var n=this._grpM.get(29);if(!n)return !0;var n=n.filterText(t[e],"group_member_profile"),o=n.isAllowedToSend,n=n.modifiedText;return !0===o&&(t[e]=n,!0)}},{key:"setGroupMemberNameCard",value:function(e){var n=this,t="setGroupMemberNameCard",o="".concat(this._n,".").concat(t);if(e.nameCard&&!1===this._filterProfanity("nameCard",e))return C({code:T.PROFANITY_FOUND});var i=e.groupID,a=e.userID,s=void 0===a?this._grpM.getMyUserID():a,r=e.nameCard,a="groupID:".concat(i," userID:").concat(s," nameCard:").concat(r),e=(v.l("".concat(o," ").concat(a)),this._grpM.getLocalGroupProfile(i));if(e&&Lt(e.type))return C({code:e=T.OPERATION_NOT_SUPPORTED_IN_AV,message:this._grpM.getErrMsg(e,t)});var c=new M(t);return c.setMessage(a),this.modifyGroupMemberInfo({groupID:i,userID:s,nameCard:r}).then(function(e){v.l("".concat(o," ok")),c.end();var t=n._grpM.getLocalGroupProfile(i);return s===n._grpM.getMyUserID()&&t&&t.setSelfNameCard(r),Ln({group:t,member:e})}).catch(function(e){return c.setError(e).end(),v.e("".concat(o," failed. error:"),e),C(e)})}},{key:"setGroupMemberCustomField",value:function(e){var n=this,t="setGroupMemberCustomField",o="".concat(this._n,".").concat(t),i=e.groupID,a=e.userID,a=void 0===a?this._grpM.getMyUserID():a,e=e.memberCustomField,s="groupID:".concat(i," userID:").concat(a," memberCustomField:").concat(JSON.stringify(e)),r=(v.l("".concat(o," ").concat(s)),this._grpM.getLocalGroupProfile(i));if(r&&Lt(r.type))return C({code:r=T.OPERATION_NOT_SUPPORTED_IN_AV,message:this._grpM.getErrMsg(r,t)});var c=new M(t);return c.setMessage(s),this.modifyGroupMemberInfo({groupID:i,userID:a,memberCustomField:e}).then(function(e){c.end(),v.l("".concat(o," ok"));var t=n._grpM.getLocalGroupProfile(i);return Ln({group:t,member:e})}).catch(function(e){return c.setError(e).end(),v.e("".concat(o," failed. error:"),e),C(e)})}},{key:"modifyGroupMemberInfo",value:function(t){var n=this,o=t.groupID,i=t.userID,e=void 0;return kt(o)&&(o=Bt(e=o)),this._grpM.req({P:I.MODIFY_GRP_MBR_INFO,data:y(y({},t),{},{groupID:o,topicID:e})}).then(function(){if(n.hasLocalGroupMember(o,i))return e=n.getLocalGroupMemberInfo(o,i),A(t.muteTime)||e.updateMuteUntil(t.muteTime),A(t.role)||e.updateRole(t.role),A(t.nameCard)||e.updateNameCard(t.nameCard),A(t.memberCustomField)||e.updateMemberCustomField(t.memberCustomField),e;var e=n._grpM.getLocalGroupProfile(o);return e&&!Lt(e.type)?n.getGroupMemberProfile({groupID:o,userIDList:[i]}).then(function(e){return m(e.data.memberList,1)[0]}):void 0})}},{key:"markGroupMemberList",value:function(e){var o="".concat(this._n,".").concat("markGroupMemberList"),t=e.groupID,n=e.markType,i=e.enableMark,e=e.userIDList,a=void 0===e?[]:e,e="groupID:".concat(t," markType:").concat(n," enableMark:").concat(i," userIDList count:").concat(a.length),s=(v.l("".concat(o," ").concat(e)),2),r=[],i=(!0===i&&(s=1),D(a)),c=(500<a.length&&(i=a.slice(0,500),v.w("".concat(o," ").concat(Jt(500)))),i.forEach(function(e){r.push({userID:e,markType:[n]});}),i=null,new M("markGroupMemberList"));return c.setMessage(e),this._grpM.req({P:I.MARK_AV_MBR_INFO,data:{groupID:t,operationType:s,memberList:r}}).then(function(e){var e=e.data.memberList,e=void 0===e?[]:e,t=[],n=[],e=(e.length===a.length?t.push.apply(t,D(a)):(e.forEach(function(e){t.push(e.userID);}),a.forEach(function(e){t.includes(e)||n.push(e);})),"success count:".concat(t.length," fail count:").concat(n.length));return c.setMessage(e).end(),v.l("".concat(o," ok. ").concat(e)),Ln({successUserIDList:t,failureUserIDList:n})}).catch(function(e){return c.setError(e).end(),v.e("".concat(o," failed. error:"),e),C(e)})}},{key:"_getGroupMemberProfileAdvance",value:function(e){return this._grpM.req({P:I.GET_GRP_MBR_PROFILE,data:y(y({},e),{},{memberInfoFilter:e.memberInfoFilter||this.DEFAULT_MEMBER_INFO_FILTER})})}},{key:"_updateLocalGroupMemberMap",value:function(t,e){var n=this;return nt(e)&&0!==e.length?e.map(function(e){return n.hasLocalGroupMember(t,e.userID)?n.getLocalGroupMemberInfo(t,e.userID).updateMember(e):n.setLocalGroupMember(t,new Ci(e)),n.getLocalGroupMemberInfo(t,e.userID)}):[]}},{key:"deleteLocalGroupMembers",value:function(e,t){var n=this.groupMemberListMap.get(e);n&&t.forEach(function(e){n.delete(e);});}},{key:"getLocalGroupMemberInfo",value:function(e,t){return this.groupMemberListMap.has(e)?this.groupMemberListMap.get(e).get(t):null}},{key:"setLocalGroupMember",value:function(e,t){this.groupMemberListMap.has(e)?this.groupMemberListMap.get(e).set(t.userID,t):(t=(new Map).set(t.userID,t),this.groupMemberListMap.set(e,t));}},{key:"getLocalGroupMemberList",value:function(e){return this.groupMemberListMap.get(e)}},{key:"hasLocalGroupMember",value:function(e,t){return this.groupMemberListMap.has(e)&&this.groupMemberListMap.get(e).has(t)}},{key:"hasLocalGroupMemberMap",value:function(e){return this.groupMemberListMap.has(e)}},{key:"reset",value:function(){this.groupMemberListMap.clear();}}]),zi),Di=[17,18,20],Ei=(e(Ji,[{key:"onNewGroupSystemNotice",value:function(e){var t=e.dataList,n=e.isSyncingEnded,e=e.isInstantMessage,t=(v.d("".concat(this._n,".onReceiveSystemNotice count:").concat(t.length)),this._assembly({notifiesList:t,isInstantMessage:e})),o=t.eventDataList,t=t.result;0<o.length&&(this._grpM.get(11).onNewMessage({conversationOptionsList:o,isInstantMessage:e}),this._onReceivedGroupSystemNotice({result:t,isInstantMessage:e})),e?0<t.length&&this._grpM.emitOEvt(G.MESSAGE_RECEIVED,t):!0===n&&this._clearGroupSystemNotice();}},{key:"_assembly",value:function(e){for(var t=e.notifiesList,l=e.isInstantMessage,n=null,d=t.length,o=0,i=[],a={conversationID:R.CONV_SYSTEM,unreadCount:0,type:R.CONV_SYSTEM,subType:null,lastMessage:null},o=0;o<d;o++){var s=t[o],r=s.groupProfile,p=r.communityType,r=r.topicID,r=void 0===r?void 0:r,c=s.elements,u=c.topicIDList,u=void 0===u?void 0:u,c=c.operationType;if(!(2!==(void 0===p?0:p)||Je(r)&&Je(u))){if(Di.includes(c)){this._handleTopicSystemNotice(s);continue}Je(r)||(s.to=r);}15!==s.elements.operationType&&(s.currentUser=this._grpM.getMyUserID(),s.conversationType=R.CONV_SYSTEM,s.conversationID=R.CONV_SYSTEM,(n=new ko(s)).setElement({type:R.MSG_GRP_SYS_NOTICE,content:y(y({},s.elements),{},{groupProfile:y({},s.groupProfile)})}),n.isSystemMessage=!0,(1===n.sequence&&1===n.random||2===n.sequence&&2===n.random)&&(n.sequence=lt(),n.random=lt(),n.generateMessageID(),v.l("".concat(this._n,"._assembly regenerate ID:").concat(n.ID))),this._grpM.get(11).pushIntoNoticeResult(i,n)&&(l?a.unreadCount++:n.setIsRead(!0),a.subType=n.conversationSubType));}return a.lastMessage=i[i.length-1],{eventDataList:0<i.length?[a]:[],result:i}}},{key:"_clearGroupSystemNotice",value:function(){var a=this;this._getPendencyList().then(function(e){e.forEach(function(e){a.pendencyMap.set("".concat(e.from,"_").concat(e.groupID,"_").concat(e.to),e);});var e=a._grpM.get(11).getLocalMessageList(R.CONV_SYSTEM),i=[];e.forEach(function(e){var t=e.payload,n=t.operatorID,o=t.operationType,t=t.groupProfile;1===o&&(o="".concat(n,"_").concat(t.groupID,"_").concat(t.to),(n=a.pendencyMap.get(o))&&Qe(n.handled)&&0!==n.handled&&i.push(e));}),a.deleteGroupSystemNotice({messageList:i});});}},{key:"deleteGroupSystemNotice",value:function(e){var n=this,o="".concat(this._n,".deleteGroupSystemNotice");return nt(e.messageList)&&0!==e.messageList.length?(v.l("".concat(o," ")+e.messageList.map(function(e){return e.ID})),this._grpM.req({P:I.DEL_GRP_SYSTEM_NOTICE,data:{messageListToDelete:e.messageList.map(function(e){return {from:R.CONV_SYSTEM,messageSeq:e.clientSequence,messageRandom:e.random}})}}).then(function(){v.l("".concat(o," ok"));var t=n._grpM.get(11);return e.messageList.forEach(function(e){t.deleteLocalMessage(e);}),Ln()}).catch(function(e){return v.e("".concat(o," error:"),e),C(e)})):Sn()}},{key:"_getPendencyList",value:function(){var n=this,e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},t=e.type,o=e.startTime,e=e.limit;return this._grpM.req({P:I.GET_GRP_PENDENCY,data:{type:void 0===t?void 0:t,startTime:void 0===o?0:o,limit:void 0===e?20:e,handleAccount:this._grpM.getMyUserID()}}).then(function(e){var t=e.data.pendencyList;return 0!==e.data.nextStartTime?n._getPendencyList({startTime:e.data.nextStartTime}).then(function(e){return [].concat(D(t),D(e))}):t})}},{key:"getGroupApplicationList",value:function(){var n=this;return this._getPendencyList().then(function(t){return n._getPendencyList({type:R.GRP_COMMUNITY}).then(function(e){return t.push.apply(t,D(e)),n._handlePendencyResult(t)}).catch(function(e){return n._handlePendencyResult(t)})})}},{key:"_handlePendencyResult",value:function(e){var t=this,n=[];return e.forEach(function(e){t.pendencyMap.set("".concat(e.from,"_").concat(e.groupID,"_").concat(e.to),e),0===e.handled&&n.push({applicant:e.from,applicantNick:e.fromUserNickName,groupName:e.groupName,groupID:e.groupID,authentication:e.authentication,messageKey:e.time,applicationType:e.applicationType,userID:e.userID,note:e.note});}),Sn({applicationList:n})}},{key:"_onReceivedGroupSystemNotice",value:function(e){var t=this,n=e.result;e.isInstantMessage&&n.forEach(function(e){switch(e.payload.operationType){case 1:break;case 2:t._onApplyJoinGroup(e);break;case 3:break;case 4:t._onMemberKicked(e);break;case 5:t._onGroupDismissed(e);break;case 6:break;case 7:t._onInviteGroup(e);break;case 8:t._onQuitGroup(e);break;case 9:t._onSetManager(e);break;case 10:t._onDeleteManager(e);break;case 11:case 12:case 15:break;case 20:t._onMessageRemindTypeSynced(e);break;case 21:t._grpM.onAVChatRoomMemberBanned(e);}});}},{key:"_onApplyJoinGroup",value:function(e){var t=this,e=e.payload.groupProfile,n=e.groupID,e=e.groupType,o=this._grpM.hasLocalGroup(n);v.l("".concat(this._n,"._onApplyJoinGroup groupID:").concat(n," groupType:").concat(e," hasGroup:").concat(o)),o||Lt(e)||this._grpM.getGroupProfile({groupID:n}).then(function(e){var e=e.data.group;e&&(t._grpM.updateGroupMap([e]),e=!e.isSupportTopic,t._grpM.emitGroupListUpdate(!0,e));});}},{key:"_onMemberKicked",value:function(e){e=e.payload.groupProfile.groupID;this._grpM.hasLocalGroup(e)&&this._grpM.deleteLocalGroupAndConversation(e);}},{key:"_onGroupDismissed",value:function(e){var e=e.payload.groupProfile.groupID,t=(this._grpM.hasLocalGroup(e)&&this._grpM.deleteLocalGroupAndConversation(e),this._grpM._AVChatRoomHandler);t&&t.checkJoinedAVChatRoomByID(e)&&t.reset(e);}},{key:"_onInviteGroup",value:function(e){var t=this,n=e.payload.groupProfile.groupID,e=this._grpM.hasLocalGroup(n);v.l("".concat(this._n,"._onInviteGroup groupID:").concat(n," hasGroup:").concat(e)),this._grpM.getGroupProfile({groupID:n}).then(function(){t._grpM.emitGroupListUpdate(),t._grpM.get(11).pullMsgOnInvite("".concat(R.CONV_GROUP).concat(n));});}},{key:"_onQuitGroup",value:function(e){var e=e.payload.groupProfile,t=e.groupID,e=e.groupType,n=this._grpM.hasLocalGroup(t);v.l("".concat(this._n,"._onQuitGroup groupID:").concat(t," groupType:").concat(e," hasGroup:").concat(n)),n&&this._grpM.deleteLocalGroupAndConversation(t);}},{key:"_onSetManager",value:function(e){var e=e.payload.groupProfile,t=e.to,e=e.groupID,e=this._grpM.getGroupMemberHandler().getLocalGroupMemberInfo(e,t);e&&e.updateRole(R.GRP_MBR_ROLE_ADMIN);}},{key:"_onDeleteManager",value:function(e){var e=e.payload.groupProfile,t=e.to,e=e.groupID,e=this._grpM.getGroupMemberHandler().getLocalGroupMemberInfo(e,t);e&&e.updateRole(R.GRP_MBR_ROLE_MEMBER);}},{key:"_onMessageRemindTypeSynced",value:function(e){var t=e.payload.groupProfile.groupID,e=e.payload.messageRemindType;this._grpM.get(11).onGroupMsgRemindTypeUpdated({groupID:t,messageRemindType:e});}},{key:"_handleTopicSystemNotice",value:function(e){var t=e.groupProfile,n=t.groupID,t=t.topicID,e=e.elements,o=e.operationType,i=e.topicIDList,e=e.messageRemindType,a=this._grpM.get(10);17===o?a.onTopicCreated({groupID:n,topicID:t}):18===o?a.onTopicDeleted({groupID:n,topicIDList:i}):20===o&&a.onMessageRemindTypeUpdated({groupID:n,topicID:t,messageRemindType:e});}},{key:"reset",value:function(){this.pendencyMap.clear();}}]),Ji),Li=["relayFlag"],Si=(t(ji,wn),ni=f(ji),e(ji,[{key:"_onCloudConfig",value:function(){var e=this.getCloudConfig("polling_interval"),t=this.getCloudConfig("polling_interval_plus"),n=this.getCloudConfig("polling_no_msg_count"),o=this.getCloudConfig("polling_simplified_msg"),i=this.getCloudConfig("paging_grp_count");v.l("".concat(this._n,"._onCloudConfig pollingInterval:").concat(e)+" pollingIntervalPlus:".concat(t," pollingNoMessageCount:").concat(n)+" pollingSimplifiedMessage:".concat(o," pagingGroupCount:").concat(i)),this._AVChatRoomHandler.setPollingInterval(e),this._AVChatRoomHandler.setPollingIntervalPlus(t),this._AVChatRoomHandler.setPollingNoMessageCount(n),this._AVChatRoomHandler.setPollingSimplifiedMessage(o),this._commonGroupHandler.setPagingGroupCount(i);}},{key:"onCheckTimer",value:function(e){this.isLoggedIn()&&(this._commonGroupHandler.onCheckTimer(e),this._groupTipsHandler.onCheckTimer(e));}},{key:"guardForAVChatRoom",value:function(t){var n,o=this;return t.conversationType===R.CONV_GROUP?(n=kt(t.to)?Bt(t.to):t.to,this.hasLocalGroup(n)?Sn():this.getGroupProfile({groupID:n}).then(function(e){var e=e.data.group.type;return v.l("".concat(o._n,".guardForAVChatRoom. groupID:").concat(n," type:").concat(e)),e===R.GRP_AVCHATROOM?C(new Hn({code:e=T.MSG_SEND_FAIL_NOT_IN_AV,message:o.getErrMsg(e,t.from,n),data:{message:t}})):Sn()})):Sn()}},{key:"checkJoinedAVChatRoomByID",value:function(e){return this._AVChatRoomHandler.checkJoinedAVChatRoomByID(e)}},{key:"onNewMessage",value:function(e){this._commonGroupHandler.onNewMessage(e);}},{key:"updateNextMessageSeq",value:function(e){var n,o=this;nt(e)&&(n=this.get(10),e.forEach(function(e){var t=e.conversationID.replace(R.CONV_GROUP,"");kt(t)&&n.updateUnreadCountAndLastMsg(t,e.lastMessage),o.groupMap.has(t)&&(o.groupMap.get(t).nextMessageSeq=e.lastMessage.sequence+1);}));}},{key:"onNewGroupTips",value:function(e){this._groupTipsHandler.onNewGroupTips(e);}},{key:"onMsgRevoked",value:function(e){this._commonGroupHandler.onMsgRevoked(e,!(1<arguments.length&&void 0!==arguments[1])||arguments[1]);}},{key:"onNewGroupSystemNotice",value:function(e){this._groupSystemNoticeHandler.onNewGroupSystemNotice(e);}},{key:"onMsgReadNotice",value:function(e){var a=this;e.dataList.forEach(function(e){var i,e=e.elements.groupMessageReadNotice;A(e)||(i=a.get(11),e.forEach(function(e){var t=e.groupID,n=e.topicID,n=void 0===n?void 0:n,e=e.lastMessageSeq,t=(v.l("".concat(a._n,".onMsgReadNotice groupID:").concat(t," lastMessageSeq:").concat(e)),"".concat(R.CONV_GROUP).concat(t)),o=!0;Je(n)||(t="".concat(R.CONV_GROUP).concat(n),o=!1),i.updateIsReadAfterReadReport({conversationID:t,lastMessageSeq:e}),i.updateUnreadCount(t,o),i.clearGroupAtInfoList(t,o);}));});}},{key:"onReadReceiptList",value:function(e){var o=this;v.l("".concat(this._n,".onReadReceiptList options:"),e),e.dataList.forEach(function(e){var t=e.groupProfile,e=e.elements,t=t.groupID,n=o.get(11),e=e.readReceiptList;n.updateReadReceiptInfo({groupID:t,readReceiptList:e});});}},{key:"onMsgModified",value:function(e){v.l("".concat(this._n,".onMsgModified options:"),e);var t=this.get(11);e.dataList.forEach(function(e){t.onMessageModified(y(y({},e),{},{conversationType:R.CONV_GROUP,to:e.topicID||e.groupID}));});}},{key:"deleteGroupSystemNotice",value:function(e){this._groupSystemNoticeHandler.deleteGroupSystemNotice(e);}},{key:"initGroupMap",value:function(e){this.groupMap.set(e.groupID,new ui(e));}},{key:"clearGroupMap",value:function(){this.groupMap.clear();}},{key:"deleteGroup",value:function(e){this.groupMap.delete(e);}},{key:"updateGroupMap",value:function(e){var t,n=this,o=this.get(11);e.forEach(function(e){t=e.groupID,n.groupMap.has(t)?n.groupMap.get(t).updateGroup(e):(n.groupMap.set(t,new ui(e)),o.deleteGroupRoamingInfo(t));});var i,a=this.getMyUserID(),s=N(this.groupMap);try{for(s.s();!(i=s.n()).done;){var r=m(i.value,2)[1];r.selfInfo.userID=a,"Owner"===r.selfInfo.role&&(r.ownerID=a);}}catch(e){s.e(e);}finally{s.f();}}},{key:"getGroupMap",value:function(){return this.groupMap}},{key:"getLocalGroupList",value:function(){return D(this.groupMap.values()).filter(function(e){return e.type!==R.GRP_ROOM&&e.type!==R.GRP_LIVE})}},{key:"getLocalGroupProfile",value:function(e){return this.groupMap.get(e)}},{key:"sortLocalGroupList",value:function(){var e=D(this.groupMap).filter(function(e){e=m(e,2);return e[0],!Je(e[1].lastMessage)});e.sort(function(e,t){return t[1].lastMessage.lastTime-e[1].lastMessage.lastTime}),this.groupMap=new Map(D(e));}},{key:"updateGroupLastMessage",value:function(e){this._commonGroupHandler.updateLastMsg(e);}},{key:"emitGroupListUpdate",value:function(){var e=!(0<arguments.length&&void 0!==arguments[0])||arguments[0],t=!(1<arguments.length&&void 0!==arguments[1])||arguments[1],n=this.getLocalGroupList();e&&this.emitOEvt(G.GROUP_LIST_UPDATED),t&&(e=JSON.parse(JSON.stringify(n)),this.get(11).updateConvGroupProfile(e));}},{key:"getMyNameCardByGroupID",value:function(e){e=this.getLocalGroupProfile(e);return e?e.selfInfo.nameCard:""}},{key:"isPagingGetCompleted",value:function(){return this._commonGroupHandler.isPagingGetCompleted()}},{key:"getMsgRemindType",value:function(e){var n=this;if(!nt(e)||0===e.length)return Promise.resolve();e=e.filter(function(e){return !Lt(n.getLocalGroupProfile(e).type)});return 0===e.length?Promise.resolve():(v.l("".concat(this._n,".getMsgRemindType groupIDList:").concat(e)),this.getGroupProfileAdvance({groupIDList:e,responseFilter:{memberInfoFilter:["MsgFlag"]}}).then(function(e){var e=e.data.successGroupList,t=n.get(11);e.forEach(function(e){t.onGroupMsgRemindTypeUpdated({groupID:e.groupID,messageRemindType:nt(e.members)?e.members[0].messageRemindType:""});});}))}},{key:"getGroupList",value:function(){return this._commonGroupHandler.getGroupList()}},{key:"syncCommunityWithTopic",value:function(){return this._commonGroupHandler.syncGroupList(!0)}},{key:"getGroupProfile",value:function(t){var n=this,o="".concat(this._n,".").concat("getGroupProfile"),i=new M("getGroupProfile"),a=t.groupID,e=t.groupCustomFieldFilter,e=(v.l("".concat(o," groupID:").concat(a)),{groupIDList:[a],responseFilter:{groupBaseInfoFilter:D(K),groupCustomFieldFilter:e,memberInfoFilter:[].concat(D(Y),["NameCard"])}});return this.getGroupProfileAdvance(e).then(function(e){var e=e.data,t=e.successGroupList,e=e.failureGroupList;return v.l("".concat(o," ok")),0<e.length?C(e[0]):((e=Lt(t[0].type)&&!n.hasLocalGroup(a)?new ui(t[0]):(n.updateGroupMap(t),n.getLocalGroupProfile(a))).isSupportTopic||n.get(11).updateConvGroupProfile([e]),i.setMessage("groupID:".concat(a," type:").concat(e.type," muteAllMembers:").concat(e.muteAllMembers," ownerID:").concat(e.ownerID)).end(),Ln({group:e}))}).catch(function(e){return i.setError(e).setMessage("groupID:".concat(t.groupID)).end(),v.e("".concat(o," failed. error:"),e),C(e)})}},{key:"getGroupProfileAdvance",value:function(e){var t,n="".concat(this._n,".getGroupProfileAdvance"),o=e.groupIDList,i=(nt(o)&&50<o.length&&(this.warn("GetGroupProfileLimit"),o.length=50),[]),a=[],o=(o.forEach(function(e){(St({groupID:e})?a:i).push(e);}),[]);return 0<i.length&&(t=this._getGroupProfileAdvance(y(y({},e),{},{groupIDList:i})),o.push(t)),0<a.length&&(t=this._getGroupProfileAdvance(y(y({},e),{},{groupIDList:a,relayFlag:0<i.length})),o.push(t)),Promise.all(o).then(function(e){var t=[],n=[];return e.forEach(function(e){t.push.apply(t,D(e.successGroupList)),n.push.apply(n,D(e.failureGroupList));}),Ln({successGroupList:t,failureGroupList:n})}).catch(function(e){return v.e("".concat(n," failed. error:"),e),C(e)})}},{key:"_getGroupProfileAdvance",value:function(t){var n=this,e=t.relayFlag,o=void 0!==e&&e,i=g(t,Li);return this.req({P:I.GET_GRP_PROFILE,data:i}).then(function(e){v.l("".concat(n._n,"._getGroupProfileAdvance ok. options:"),i);e=e.data.groups;return {successGroupList:e.filter(function(e){return A(e.errorCode)||0===e.errorCode}),failureGroupList:e.filter(function(e){return e.errorCode&&0!==e.errorCode}).map(function(e){return new Hn({code:e.errorCode,message:e.errorInfo,data:{groupID:e.groupID}})})}}).catch(function(e){return o&&St({groupID:t.groupIDList[0]})?{successGroupList:[],failureGroupList:[]}:C(e)})}},{key:"createGroup",value:function(s){var r=this,e=[R.GRP_PUBLIC,R.GRP_WORK,R.GRP_MEETING,R.GRP_AVCHATROOM,R.GRP_COMMUNITY],c="".concat(this._n,".").concat("createGroup"),t=s.type,n=s.groupID;if(s.name&&!1===this._filterProfanity("name",s))return C({code:T.PROFANITY_FOUND});if(s.introduction&&!1===this._filterProfanity("introduction",s))return C({code:T.PROFANITY_FOUND});if(s.notification&&!1===this._filterProfanity("notification",s))return C({code:T.PROFANITY_FOUND});if(!e.includes(t))return C({code:T.ILLEGAL_GRP_TYPE});if(!St({type:t})){if(!Je(n)&&St({groupID:n}))return C({code:T.ILLEGAL_GRP_ID});s.isSupportTopic=void 0;}if(Lt(t)&&!A(s.memberList)&&0<s.memberList.length&&(s.memberList=void 0),this._canIUseJoinOption(t)||A(s.joinOption)||(s.joinOption=void 0),St({type:t})){if(!Je(n)&&!St({groupID:n}))return C({code:T.ILLEGAL_GRP_ID});s.isSupportTopic=!0===s.isSupportTopic?1:0;}var u=new M("createGroup"),l=(v.l("".concat(c," options:"),s),null),d=[];return this.req({P:I.CREATE_GRP,data:y(y({},s),{},{ownerID:this.getMyUserID(),webPushFlag:1})}).then(function(e){var e=e.data,t=e.groupID,e=e.overLimitUserIDList,n=void 0===e?[]:e,e=(l=t,d=n,"groupType:".concat(s.type," groupID:").concat(t," overLimitUserIDList:").concat(n));if(u.setMessage(e).end(),v.l("".concat(c," ok. ").concat(e)),s.type===R.GRP_AVCHATROOM)return r.getGroupProfile({groupID:t});if(s.type===R.GRP_COMMUNITY&&1===s.isSupportTopic)return r.getGroupProfile({groupID:t});Je(s.memberList)||Je(n)||(s.memberList=s.memberList.filter(function(e){return -1===n.indexOf(e.userID)})),r.updateGroupMap([y(y({},s),{},{groupID:t})]);var e=r.get(2),o="",i=0,a=(s.type===R.GRP_COMMUNITY?(o=r.isIntl()?"Create Community":"创建社群",i=1):o=r.isIntl()?"Create Group":"创建群组",r.get(4).getMyNick()),o=e.createCustomMessage({to:t,conversationType:R.CONV_GROUP,payload:{data:JSON.stringify({businessID:"group_create",content:o,cmd:i,opUser:a||r.getMyUserID(),version:4})}});return e.sendMessageInstance(o),r.emitGroupListUpdate(),r.getGroupProfile({groupID:t})}).then(function(e){var e=e.data.group,t=e.selfInfo,n=t.nameCard,t=t.joinTime;return e.updateSelfInfo({nameCard:n,joinTime:t,messageRemindType:R.MSG_REMIND_ACPT_AND_NOTE,role:R.GRP_MBR_ROLE_OWNER}),Ln({group:e,overLimitUserIDList:d})}).catch(function(e){var t;return u.setMessage("groupType:".concat(s.type)).setError(e).end(),10010===e.code||10007===e.code?(r._silentlyGetGroupProfile(e.code,l),r.updateGroupMap([y(y({},s),{},{groupID:l})]),(t=r.getLocalGroupProfile(l)).selfInfo.role=R.GRP_MBR_ROLE_OWNER,Ln({group:t,overLimitUserIDList:d})):(v.e("".concat(c," failed. error:"),e),C(e))})}},{key:"dismissGroup",value:function(e){var t=this,n="".concat(this._n,".").concat("dismissGroup"),o="groupID:".concat(e),i=new M("dismissGroup");return i.setMessage(o),v.l("".concat(n," ").concat(o)),this.req({P:I.DISMISS_GRP,data:{groupID:e}}).then(function(){return i.end(),v.l("".concat(n," ok")),t.deleteLocalGroupAndConversation(e),t.checkJoinedAVChatRoomByID(e)&&t._AVChatRoomHandler.reset(e),t._groupAttributesHandler.deleteLocalGroupAttributes(e),Ln({groupID:e})}).catch(function(e){return i.setError(e).end(),v.e("".concat(n," failed. error:"),e),C(e)})}},{key:"updateGroupProfile",value:function(e){var t,n=this,o="".concat(this._n,".").concat("updateGroupProfile");if(this.hasLocalGroup(e.groupID)&&(t=this.getLocalGroupProfile(e.groupID).type,this._canIUseJoinOption(t)||A(e.joinOption)||(v.w("".concat(o," joinOption is unavailable for Work/Meeting/AVChatRoom")),e.joinOption=void 0)),A(e.muteAllMembers)||(e.muteAllMembers?e.muteAllMembers="On":e.muteAllMembers="Off"),e.name&&!1===this._filterProfanity("name",e))return C({code:T.PROFANITY_FOUND});if(e.introduction&&!1===this._filterProfanity("introduction",e))return C({code:T.PROFANITY_FOUND});if(e.notification&&!1===this._filterProfanity("notification",e))return C({code:T.PROFANITY_FOUND});var i=new M("updateGroupProfile");return i.setMessage(JSON.stringify(e)),v.l("".concat(o," groupID:").concat(e.groupID)),this.req({P:I.UPDATE_GRP_PROFILE,data:e}).then(function(){return i.end(),v.l("".concat(o," ok")),n.hasLocalGroup(e.groupID)&&n.groupMap.get(e.groupID).updateGroup(e),Ln({group:n.groupMap.get(e.groupID)})}).catch(function(e){return i.setError(e).end(),v.l("".concat(o," failed. error:"),e),C(e)})}},{key:"_filterProfanity",value:function(e,t){var n=this.get(29);if(!n)return !0;var n=n.filterText(t[e],B),o=n.isAllowedToSend,n=n.modifiedText;return !0===o&&(t[e]=n,!0)}},{key:"joinGroup",value:function(t){var n=this,o=t.groupID,i="".concat(this._n,".joinGroup");if(this.deleteUnjoinedAVChatRoom(o),this.hasLocalGroup(o)){if(!this.isLoggedIn())return Sn({status:R.JOIN_STATUS_ALREADY_IN_GROUP});var a=new M("applyJoinGroup");return this.getGroupProfile({groupID:o}).then(function(){return a.setMessage("groupID:".concat(o," joinedStatus:").concat(R.JOIN_STATUS_ALREADY_IN_GROUP)).end(),Sn({status:R.JOIN_STATUS_ALREADY_IN_GROUP})}).catch(function(e){return a.setMessage("groupID:".concat(o," unjoined")).end(),v.w("".concat(i," ").concat(o," was unjoined, now join!")),n.groupMap.delete(o),n.applyJoinGroup(t)})}return v.l("".concat(i," groupID:").concat(o)),this.isLoggedIn()?this.applyJoinGroup(t):this._AVChatRoomHandler.joinWithoutAuth(t)}},{key:"applyJoinGroup",value:function(e){var c=this,u="".concat(this._n,".").concat("applyJoinGroup"),l=e.groupID;if(!Je(e.applyMessage)&&!1===this._filterProfanity("applyMessage",e))return C({code:T.PROFANITY_FOUND});var d=new M("applyJoinGroup"),e=y({},e),p=this.canIUse(H.AV_HISTORY_MSG);return p&&(e.historyMessageFlag=1),this.get(11).deleteTopicRoamingInfo(l),this.req({P:I.APPLY_JOIN_GRP,data:e}).then(function(e){var e=e.data,t=e.joinedStatus,n=e.longPollingKey,o=e.startSeq,i=e.avChatRoomFlag,a=e.avChatRoomKey,s=e.messageList,e="groupID:".concat(l," joinedStatus:").concat(t," longPollingKey:").concat(n," startSeq:").concat(o)+" avChatRoomFlag:".concat(i," canGetAVChatRoomHistoryMsg:").concat(p,",")+" historyMsgCount:".concat(Je(s)?0:s.length);switch(d.setMessage(e).end(),v.l("".concat(u," ok. ").concat(e)),t){case Ye:return Ln({status:Ye});case Ke:return c.getGroupProfile({groupID:l}).then(function(e){e=e.data.group;return c._handleJoinResult({group:e,avChatRoomFlag:i,longPollingKey:n,startSeq:o,avChatRoomKey:a,messageList:s})}).catch(function(e){var t;return 10010===e.code||10007===e.code?(c._silentlyGetGroupProfile(e.code,l),t=new ui({groupID:l}),c.updateGroupMap([t]),c._handleJoinResult({group:t,avChatRoomFlag:i,longPollingKey:n,startSeq:o,avChatRoomKey:a,messageList:s})):(v.e("".concat(u," failed. error:"),e),C(e))});default:var r=new Hn({code:T.JOIN_GRP_FAIL});return v.e("".concat(u," failed. error:"),r),C(r)}}).catch(function(e){return d.setMessage("groupID:".concat(l)).setError(e).end(),v.e("".concat(u," failed. error:"),e),C(e)})}},{key:"_handleJoinResult",value:function(e){var t=this,n=e.group,o=e.avChatRoomFlag,i=e.longPollingKey,a=e.startSeq,s=e.avChatRoomKey,r=e.messageList,c=n.groupID;return 1===o?(this.get(11).setCompleted("".concat(R.CONV_GROUP).concat(c)),this._groupAttributesHandler.initGroupAttributesCache({groupID:c,avChatRoomKey:s}),this._groupCountersHandler.initGroupCountersCache({groupID:c,avChatRoomKey:s}),(e=A(i)?this._AVChatRoomHandler.handleJoinResult({group:n}):this._AVChatRoomHandler.startRunLoop({group:n,longPollingKey:i,startSeq:a})).then(function(){t._onAVChatRoomHistoryMessage(r,c);}),e):(this.emitGroupListUpdate(!0,!1),Ln({status:Ke,group:n}))}},{key:"quitGroup",value:function(e){var t=this,n="".concat(this._n,".").concat("quitGroup"),o="groupID:".concat(e),i=(v.l("".concat(n," ").concat(o)),this.checkJoinedAVChatRoomByID(e));if(!i&&!this.hasLocalGroup(e))return C({code:T.MEMBER_NOT_IN_GRP});if(i&&!this.isLoggedIn())return v.l("".concat(n," anonymously ok. ").concat(o)),this.deleteLocalGroupAndConversation(e),this._AVChatRoomHandler.reset(e),Sn({groupID:e});var a=new M("quitGroup");return a.setMessage(o),this.req({P:I.QUIT_GRP,data:{groupID:e}}).then(function(){return a.end(),v.l("".concat(n," ok")),t.deleteLocalGroupAndConversation(e),i&&t._AVChatRoomHandler.reset(e),t._groupAttributesHandler.deleteLocalGroupAttributes(e),Ln({groupID:e})}).catch(function(e){return a.setError(e).end(),v.e("".concat(n," failed. error:"),e),C(e)})}},{key:"searchGroupByID",value:function(e){var t="".concat(this._n,".").concat("searchGroupByID"),n={groupIDList:[e]},o=new M("searchGroupByID");return o.setMessage("groupID:".concat(e)),v.l("".concat(t," groupID:").concat(e)),this.req({P:I.SEARCH_GRP,data:n}).then(function(e){e=e.data.groupProfile;if(0!==e[0].errorCode)throw new Hn({code:e[0].errorCode,message:e[0].errorInfo});return o.end(),v.l("".concat(t," ok")),Ln({group:new ui(e[0])})}).catch(function(e){return o.setError(e).end(),v.w("".concat(t," failed. error:"),e),C(e)})}},{key:"changeGroupOwner",value:function(i){var a=this,s="".concat(this._n,".").concat("changeGroupOwner");if(this.hasLocalGroup(i.groupID)&&this.getLocalGroupProfile(i.groupID).type===R.GRP_AVCHATROOM)return C({code:T.CANNOT_CHANGE_OWNER_IN_AV});if(i.newOwnerID===this.getMyUserID())return C({code:T.CANNOT_CHANGE_OWNER_TO_SELF});var r=new M("changeGroupOwner");return r.setMessage("groupID:".concat(i.groupID," newOwnerID:").concat(i.newOwnerID)),v.l("".concat(s," groupID:").concat(i.groupID)),this.req({P:I.CHANGE_GRP_OWNER,data:i}).then(function(){r.end(),v.l("".concat(s," ok"));var e,t=i.groupID,n=i.newOwnerID,o=(a.groupMap.get(t).ownerID=n,a._groupMemberHandler.getLocalGroupMemberList(t));return o instanceof Map&&(e=o.get(a.getMyUserID()),A(e)||(e.updateRole("Member"),a.groupMap.get(t).selfInfo.role="Member"),e=o.get(n),A(e)||e.updateRole("Owner")),a.emitGroupListUpdate(!0,!1),Ln({group:a.groupMap.get(t)})}).catch(function(e){return r.setError(e).end(),v.e("".concat(s," failed. error:"),e),C(e)})}},{key:"getGroupApplicationList",value:function(){return this._groupSystemNoticeHandler.getGroupApplicationList()}},{key:"handleGroupApplication",value:function(e){var t,n,o,i,a,l=this,s="".concat(this._n,".").concat("handleGroupApplication"),d=e.handleAction,p=e.handleMessage,r=e.message,c=e.application,_=(r?(t=r.payload.operatorID,n=r.payload.groupProfile.groupID,o=r.payload.authentication,i=r.payload.messageKey):c&&(t=c.applicant,n=c.groupID,o=c.authentication,i=c.messageKey),I.HANDLE_GRP_APPLICATION),u=(c&&2===c.applicationType&&(_=I.HANDLE_INVITE_JOIN_GRP,a=c.userID),new M("handleGroupApplication"));return u.setMessage("groupID:".concat(n)),v.l("".concat(s," groupID:").concat(n)),this.req({P:_,data:{handleAction:d,handleMessage:p,applicant:t,invitee:a,groupID:n,authentication:o,messageKey:i}}).then(function(){return u.end(),v.l("".concat(s," ok")),r&&l._groupSystemNoticeHandler.deleteGroupSystemNotice({messageList:[e.message]}),Ln({group:l.getLocalGroupProfile(n)})}).catch(function(e){return u.setError(e).end(),v.e("".concat(s," failed. error"),e),C(e)})}},{key:"handleGroupInvitation",value:function(e){var t=this,n="".concat(this._n,".").concat("handleGroupInvitation"),o=e.message.payload,i=o.groupProfile.groupID,a=o.authentication,s=o.messageKey,o=o.operatorID,r=e.handleAction,c=new M("handleGroupInvitation");return c.setMessage("groupID:".concat(i," inviter:").concat(o," handleAction:").concat(r)),v.l("".concat(n," groupID:").concat(i," inviter:").concat(o," handleAction:").concat(r)),this.req({P:I.HANDLE_GRP_INVITATION,data:y(y({},e),{},{inviter:o,groupID:i,authentication:a,messageKey:s})}).then(function(){return c.end(),v.l("".concat(n," ok")),t._groupSystemNoticeHandler.deleteGroupSystemNotice({messageList:[e.message]}),Ln({group:t.getLocalGroupProfile(i)})}).catch(function(e){return c.setError(e).end(),v.e("".concat(n," failed. error"),e),C(e)})}},{key:"getGroupOnlineMemberCount",value:function(t){var n=this,o="".concat(this._n,".getGroupOnlineMemberCount"),e=this._AVChatRoomHandler.checkJoinedAVChatRoomByID(t),i=this.hasLocalGroup(t);if(v.l("".concat(o," groupID:").concat(t," isAVChatRoom:").concat(e," has:").concat(i)),e)return this._AVChatRoomHandler.getGroupOnlineMemberCount(t);if(!i)return Sn({memberCount:0});e=Date.now();if(this._onlineMemberCountMap.has(t)){i=this._onlineMemberCountMap.get(t);if(e-i.lastReqTime<=6e4)return Sn({memberCount:i.memberCount});i.lastReqTime=e;}return this.requestOnlineCount(t).then(function(e){e=e.data.memberCount,e=void 0===e?0:e;return n._onlineMemberCountMap.set(t,{lastReqTime:Date.now(),memberCount:e}),v.l("".concat(o," ok. groupID:").concat(t," memberCount:").concat(e)),Sn({memberCount:e})}).catch(function(e){return v.w("".concat(o," failed. error:"),e),Promise.reject(e)})}},{key:"requestOnlineCount",value:function(e){return this.req({P:I.GET_ONLINE_MBR_NUM,data:{groupID:e}})}},{key:"hasLocalGroup",value:function(e){return this.groupMap.has(e)}},{key:"deleteLocalGroupAndConversation",value:function(e){var t,n=this.checkJoinedAVChatRoomByID(e),o=(v.l("".concat(this._n,".deleteLocalGroupAndConversation groupID:").concat(e," isJoinedAVChatRoom:").concat(n)),this.get(11)),i="".concat(R.CONV_GROUP).concat(e);n&&(this.stopMessageLongPolling({groupID:e}),o.deleteLocalConv(i)),St({groupID:e})&&(t=this.getLocalGroupProfile(e))&&!0===t.isSupportTopic&&this.get(10).deleteTopicListInCommunity(e),o.clearUnreadCount(i),o.setCompleted(i),this._deleteLocalGroup(e),this._onlineMemberCountMap.delete(e),this.emitGroupListUpdate(!0,!1);}},{key:"_deleteLocalGroup",value:function(e){this.groupMap.delete(e),this._groupMemberHandler.deleteGroupMemberList(e);}},{key:"sendMessage",value:function(e,t){if(nt(e._receiverList)&&0<e._receiverList.length&&!this.canIUse(H.MSG_TO_SPECIFIED_GRP_MBR))return this.noUse("Targeted Group Message");e=this.createGroupMessagePack(e,t);return this.req(e)}},{key:"createGroupMessagePack",value:function(e,t){var n=null,o=(t&&t.offlinePushInfo&&(n=t.offlinePushInfo),""),i=(ft(e.cloudCustomData)&&0<e.cloudCustomData.length&&(o=e.cloudCustomData),[]),a=(et(t)&&et(t.messageControlInfo)&&(a=(r=t.messageControlInfo).excludedFromUnreadCount,s=r.excludedFromLastMessage,r=r.excludedFromContentModeration,!0===a&&i.push("NoUnread"),!0===s&&i.push("NoLastMsg"),!0===r&&i.push("NoMsgCheck")),void 0),s=(nt(e._receiverList)&&0<e._receiverList.length&&(a=e._receiverList,50<e._receiverList.length&&(a=e._receiverList.slice(0,50),this.warn("ReceiverListLimit"))),this.isOnlineMessage(e,t)?1:0),r=JSON.parse(JSON.stringify(e.getElements())),t=this.get(17).getFileDNList(),c=e.getGroupAtInfoList(),r={fromAccount:this.getMyUserID(),groupID:e.to,msgBody:lo(e.type,r,t),cloudCustomData:o,random:e.random,priority:e.priority,clientSequence:e.clientSequence,groupAtInfo:e.type!==R.MSG_TEXT||Je(c)?void 0:c,onlineOnlyFlag:s,clientTime:e.clientTime,offlinePushInfo:Ho(n),messageControlInfo:0==s?i:void 0,needReadReceipt:!0!==e.needReadReceipt||this.isMessageFromOrToAVChatroom(e.to)?0:1,receiverList:a,isSupportExtension:!0===e.isSupportExtension?1:0,isRelayMessage:!0===e._relayFlag?1:0,cmConfigID:e._cmConfigID};return kt(e.to)&&(r.groupID=Bt(e.to),r.topicID=e.to),{P:I.SEND_GRP_MSG,data:r}}},{key:"revokeMessage",value:function(e){var t={groupID:e.to,msgSeqList:[{msgSeq:e.sequence}]};return kt(e.to)&&(t.groupID=Bt(e.to),t.topicID=e.to),this.req({P:I.REVOKE_GRP_MSG,data:t})}},{key:"deleteMessage",value:function(e){var t=e.to,e=e.keyList,e=(v.l("".concat(this._n,".deleteMessage groupID:").concat(t," count:").concat(e.length)),{groupID:t,deleter:this.getMyUserID(),keyList:e});return kt(t)&&(e.groupID=Bt(t),e.topicID=t),this.req({P:I.DEL_GRP_MSG,data:e})}},{key:"modifyRemoteMessage",value:function(e){var t=e.to,n=e.sequence,o=e.payload,i=e.type,a=e.version,a=void 0===a?0:a,s=e.cloudCustomData,e=e._elements,r=t,c=void 0,t=(kt(t)&&(r=Bt(t),c=t),void 0);return Yt(i)&&(1<e.length&&e.splice(0,1,{type:i,content:o}),t=e),this.req({P:I.MODIFY_GRP_MSG,data:{groupID:r,topicID:c,sequence:n,version:a,elements:t,cloudCustomData:s}})}},{key:"getRoamingMessage",value:function(e){var r=this,c="".concat(this._n,".").concat("getRoamingMessage"),u=e.conversationID,l=e.groupID,e=e.sequence,d=new M("getRoamingMessage"),p=0,_=void 0;return kt(l)&&(l=Bt(_=l)),this._computeLastSequence({groupID:l,topicID:_,sequence:e}).then(function(e){return p=e,v.l("".concat(c," groupID:").concat(l," startSequence:").concat(p)),r.req({P:I.GET_GRP_ROAMING_MSG,data:{groupID:l,count:21,sequence:p,topicID:_}})}).then(function(e){var t=e.data,n=t.messageList,o=t.complete,t=t.invisibleSequenceList,t=void 0===t?[]:t,e=e.data.nextSequence,e=void 0===e?0:e,i=(A(n)?v.l("".concat(c," ok. complete:").concat(o," nextSequence:").concat(e," but messageList is undefined!")):v.l("".concat(c," ok. complete:").concat(o," nextSequence:").concat(e," count:").concat(n.length)),d.setMessage("groupID:".concat(l," topicID:").concat(_," startSequence:").concat(p," complete:").concat(o," nextSequence:").concat(e)).end(),r.get(11)),a=[],s=[],n=(Je(n)||(a=i.onRoamingMessage(n,u,!0,s),i.updateIsRead(u),i.patchConvLastMessage(u)),2===o||e<1);return n&&(i.setCompleted(u),e=""),v.l("".concat(c," isPullingCompleted:").concat(n," nextReqID:").concat(e," storedMsgCount:").concat(a.length)+" invisibleSeqCount:".concat(t.length)),{nextReqID:e+"",storedMessageList:a,assembledMessageList:s,isPullingCompleted:n}}).catch(function(e){return d.setError(e).setMessage("groupID:".concat(l," topicID:").concat(_," startSequence:").concat(p)).end(),v.w("".concat(c," failed. error:"),e),C(e)})}},{key:"_getGroupIDOfMessage",value:function(e){return e.conversationID.replace(R.CONV_GROUP,"")}},{key:"getReadReceiptList",value:function(n){var t="".concat(this._n,".").concat("getReadReceiptList"),e=this._getGroupIDOfMessage(n[0]),o=this.getMyUserID(),i=n.filter(function(e){return e.from===o&&!0===e.needReadReceipt}).map(function(e){return {sequence:e.sequence}});if(v.l("".concat(t," groupID:").concat(e," sequenceList:").concat(JSON.stringify(i))),0===i.length)return Sn({messageList:n});var a=new M("getReadReceiptList");return a.setMessage("groupID:".concat(e)),this.req({P:I.GET_READ_RECEIPT,data:{groupID:e,sequenceList:i}}).then(function(e){a.end(),v.l("".concat(t," ok"));e=e.data.readReceiptList;return nt(e)&&e.forEach(function(t){n.forEach(function(e){0===t.code&&t.sequence===e.sequence&&(e.readReceiptInfo.readCount=t.readCount,e.readReceiptInfo.unreadCount=t.unreadCount);});}),Ln({messageList:n})}).catch(function(e){return a.setError(e).end(),v.w("".concat(t," failed. error:"),e),C(e)})}},{key:"sendReadReceipt",value:function(e){var t="".concat(this._n,".").concat("sendReadReceipt"),n=this._getGroupIDOfMessage(e[0]),o=new M("sendReadReceipt"),i=(o.setMessage("groupID:".concat(n)),this.getMyUserID()),e=e.filter(function(e){return e.from!==i&&!0===e.needReadReceipt}).map(function(e){return {sequence:e.sequence}});return 0===e.length?C({code:T.READ_RECEIPT_MSG_LIST_EMPTY}):(v.l("".concat(t,". sequenceList:").concat(JSON.stringify(e))),this.req({P:I.SEND_READ_RECEIPT,data:{groupID:n,sequenceList:e}}).then(function(e){return o.end(),v.l("".concat(t," ok")),Ln()}).catch(function(e){return o.setError(e).end(),v.w("".concat(t," failed. error:"),e),C(e)}))}},{key:"getReadReceiptDetail",value:function(e){var l=this,t=e.message,n=e.filter,o=e.cursor,e=e.count,i=this._getGroupIDOfMessage(t),a=t.ID,t=t.sequence,s="".concat(this._n,".").concat("getReadReceiptDetail"),d=this._receiptDetailCompleteMap.get(a)||!1,r=0!==n&&1!==n?0:n,n=ft(o)?o:"",o=!Qe(e)||e<=0||100<=e?100:e,e="groupID:".concat(i," sequence:").concat(t," cursor:").concat(n," filter:").concat(r," completeFlag:").concat(d),c=(v.l("".concat(s," ").concat(e)),{cursor:"",isCompleted:!1,messageID:a,unreadUserIDList:[],readUserIDList:[]}),u=new M("getReadReceiptDetail");return u.setMessage(e),this.req({P:I.GET_READ_RECEIPT_DETAIL,data:{groupID:i,sequence:t,flag:r,cursor:n,count:o}}).then(function(e){u.end();var e=e.data,t=e.cursor,n=e.isCompleted,o=e.unreadUserIDList,e=e.readUserIDList;return c.cursor=t,1===n&&(c.isCompleted=!0,l._receiptDetailCompleteMap.set(a,!0)),0===r?c.readUserIDList=e.map(function(e){return e.userID}):1===r&&(c.unreadUserIDList=o.map(function(e){return e.userID})),v.l("".concat(s," ok")),Ln(c)}).catch(function(e){return u.setError(e).end(),v.w("".concat(s," failed. error:"),e),C(e)})}},{key:"getRoamingMessagesHopping",value:function(c){var u=this,l="".concat(this._n,".").concat("getRoamingMessagesHopping"),t=c.groupID,n=c.count,d=c.sequence,p=c.direction,o=void 0;return A(d)&&1===p?Sn({messageList:[],isCompleted:!0,nextMessageSeq:""}):(kt(t)&&(t=Bt(o=t)),this._computeReqSeqHopping({groupID:t,topicID:o,sequence:d}).then(function(e){A(d)||1!==p||(e=d+n-1);var s="".concat(o?"topicID:".concat(o):"groupID:".concat(t)," sequence:").concat(d," reqSeq:").concat(e," direction:").concat(p),r=(v.l("".concat(l," ").concat(s)),new M("getRoamingMessagesHopping"));return u.req({P:I.GET_GRP_ROAMING_MSG,data:{groupID:t,topicID:o,count:n,sequence:e}}).then(function(e){var e=e.data,t=e.messageList,t=void 0===t?[]:t,n=e.complete,o=e.nextSequence,o=void 0===o?0:o,e=e.invisibleSequenceList,e=void 0===e?[]:e,i="complete:".concat(n," nextSequence:").concat(o," remoteMsgCount:").concat(t.length," invisibleSequenceList:").concat(e),i=(r.setMessage("".concat(s," ").concat(i)).end(),v.l("".concat(l," ok. ").concat(i)),"".concat(R.CONV_GROUP).concat(c.groupID)),a=u.get(11),i=a.onRoamingMessage(t,i,!1),t=u._computeResult({groupID:c.groupID,direction:p,sequence:d,remoteMessageList:t,processedMessageList:i,complete:n,nextSequence:o,invisibleSequenceList:e});return a.storeHoppingMessageList(t.messageList),Ln(t)}).catch(function(e){return r.setError(e).setMessage("groupID:".concat(t," sequence:").concat(d," count:").concat(n)).end(),v.w("".concat(l," failed. error:"),e),C(e)})}))}},{key:"_computeReqSeqHopping",value:function(e){var n=this,o=e.groupID,t=e.topicID,t=void 0===t?void 0:t,e=e.sequence,e=void 0===e?void 0:e;return 0<e?Promise.resolve(e):A(t)?this.getGroupProfileAdvance({groupIDList:[o],responseFilter:{groupBaseInfoFilter:["NextMsgSeq"]}}).then(function(e){var e=e.data.successGroupList,t=0;return Je(e)||(t=e[0].nextMessageSeq-1),v.l("".concat(n._n,"._computeReqSeqHopping groupID:").concat(o," lastSequence:").concat(t," from remote")),t}).catch(function(e){return C(e)}):Promise.resolve(0)}},{key:"_computeResult",value:function(e){var t={messageList:[],isCompleted:!1,nextMessageSeq:""},n=e.groupID,o=e.direction,i=e.sequence,a=e.remoteMessageList,a=void 0===a?[]:a,s=e.processedMessageList,s=void 0===s?[]:s,r=e.complete,c=e.nextSequence,e=e.invisibleSequenceList;if(0===o)return t.nextMessageSeq=c,(2===r||c<1)&&(t.isCompleted=!0,t.nextMessageSeq=""),t.messageList=s,t;if(1===o){if(Je(a)){if(Je(e))return t.isCompleted=!0,t.nextMessageSeq="",t;t.nextMessageSeq=e[0]+1;}else {r=a[0].sequence,c=e[0]||0;t.nextMessageSeq=c<r?r+1:c+1;}return s.forEach(function(e){e.sequence>=i&&t.messageList.push(e);}),(St({groupID:n})||kt(n))&&0===t.messageList.length&&a[0].sequence<i&&(t.isCompleted=!0,t.nextMessageSeq=""),t}}},{key:"setMessageRead",value:function(e){var o=this,i=e.conversationID,a=e.lastMessageSeq,s="".concat(this._n,".").concat("setMessageRead"),e="convID:".concat(i," lastMessageSeq:").concat(a),r=(v.l("".concat(s," ").concat(e)),Qe(a)||this.warn("DoNotModifyLastSeq"),new M("setMessageRead")),c=(r.setMessage(e),i.replace(R.CONV_GROUP,"")),u=void 0;return kt(c)&&(c=Bt(u=c)),this.req({P:I.SET_GRP_MSG_READ,data:{groupID:c,topicID:u,messageReadSeq:a}}).then(function(){r.end(),v.l("".concat(s," ok"));var e,t=o.get(11),n=(t.updateIsReadAfterReadReport({conversationID:i,lastMessageSeq:a}),!0);return A(u)||(n=!1,(e=o.get(10).getLocalTopic(c,u))&&e.updateSelfInfo({readedSequence:a})),t.updateUnreadCount(i,n),Ln()}).catch(function(e){return r.setError(e).end(),v.l("".concat(s," failed. error:"),e),C(e)})}},{key:"_computeLastSequence",value:function(e){var t=e.groupID,n=e.topicID,n=void 0===n?void 0:n,e=e.sequence;return 0<e?Promise.resolve(e):A(n)?this.getGroupLastSequence(t):Promise.resolve(0)}},{key:"getGroupLastSequence",value:function(e){var t="".concat(this._n,".").concat("getGroupLastSequence"),n=new M("getGroupLastSequence"),o=0,i="",a="groupID:".concat(e);if(this.hasLocalGroup(e)){var s=this.getLocalGroupProfile(e),r=s.lastMessage;if(0<r.lastSequence&&!1===r.onlineOnlyFlag)return o=r.lastSequence,i="".concat(a,", ").concat(o," from group.lastMessage.lastSequence"),v.l("".concat(t," ").concat(i)),n.setMessage(i).end(),Promise.resolve(o);if(1<s.nextMessageSeq)return o=s.nextMessageSeq-1,i="".concat(a,", ").concat(o," from group.nextMessageSeq"),v.l("".concat(t," ").concat(i)),n.setMessage(i).end(),Promise.resolve(o)}r=this.get(11).getLocalConversation("GROUP".concat(e));return r&&r.lastMessage.lastSequence&&!1===r.lastMessage.onlineOnlyFlag?(o=r.lastMessage.lastSequence,i="".concat(a,", ").concat(o," from conversation.lastMessage.lastSequence"),v.l("".concat(t," ").concat(i)),n.setMessage(i).end(),Promise.resolve(o)):this.getGroupProfileAdvance({groupIDList:[e],responseFilter:{groupBaseInfoFilter:["NextMsgSeq"]}}).then(function(e){e=e.data.successGroupList;return Je(e)?v.w("".concat(t," ").concat(a,", empty successGroupList")):(o=e[0].nextMessageSeq-1,i="".concat(a,", ").concat(o," from remote"),v.l("".concat(t," ").concat(i))),n.setMessage(i).end(),o}).catch(function(e){return n.setError(e).setMessage(a).end(),v.w("".concat(t," failed. error:"),e),C(e)})}},{key:"isMessageFromOrToAVChatroom",value:function(e){return this._AVChatRoomHandler.checkJoinedAVChatRoomByID(e)}},{key:"hasJoinedAVChatRoom",value:function(){return this._AVChatRoomHandler.hasJoinedAVChatRoom()}},{key:"getJoinedAVChatRoom",value:function(){return this._AVChatRoomHandler.getJoinedAVChatRoom()}},{key:"getGroupRemoteLastSeq",value:function(e){e=this.getLocalGroupProfile(e);return e?e.nextMessageSeq-1:1}},{key:"isOnlineMessage",value:function(e,t){return !(!this._canIUseOnlineOnlyFlag(e)||!t||!0!==t.onlineUserOnly)}},{key:"_canIUseOnlineOnlyFlag",value:function(e){var t=this.getJoinedAVChatRoom();return !t||!t.includes(e.to)||e.conversationType!==R.CONV_GROUP}},{key:"_onAVChatRoomHistoryMessage",value:function(e,t){var n;Je(e)||(v.l("".concat(this._n,"._onAVChatRoomHistoryMessage groupID:").concat(t," count:").concat(e.length)),n=[],e.forEach(function(e){n.push(y(y({},e),{},{isHistoryMessage:1}));}),this.onAVChatRoomMessage(n,t));}},{key:"onAVChatRoomMessage",value:function(e){this._AVChatRoomHandler.onMessage(e,1<arguments.length&&void 0!==arguments[1]?arguments[1]:"");}},{key:"onAVChatRoomMemberBanned",value:function(e){this._AVChatRoomHandler.onAVChatRoomMemberBanned(e);}},{key:"setUnjoinedAVChatRoom",value:function(e){this._unjoinedAVChatRoomList.set(e,1);}},{key:"deleteUnjoinedAVChatRoom",value:function(e){this._unjoinedAVChatRoomList.has(e)&&this._unjoinedAVChatRoomList.delete(e);}},{key:"isUnjoinedAVChatRoom",value:function(e){return this._unjoinedAVChatRoomList.has(e)}},{key:"isGroupAttributesUpdatedNotice",value:function(e){return this._groupAttributesHandler.isGroupAttributesUpdatedNotice(e)}},{key:"updateLocalMainSequenceOnReconnected",value:function(){this._groupAttributesHandler.updateLocalMainSequenceOnReconnected();}},{key:"initGroupAttributes",value:function(e){return this._groupAttributesHandler.initGroupAttributes(e)}},{key:"setGroupAttributes",value:function(e){return this._groupAttributesHandler.setGroupAttributes(e)}},{key:"deleteGroupAttributes",value:function(e){return this._groupAttributesHandler.deleteGroupAttributes(e)}},{key:"getGroupAttributes",value:function(e){return this._groupAttributesHandler.getGroupAttributes(e)}},{key:"isMessageFromTopic",value:function(e,t){return 2===e&&!Je(t)}},{key:"isMessageFromCommunityOfTopic",value:function(e,t){return 2===e&&Je(t)}},{key:"getMessageExtensions",value:function(e,t){return v.l("".concat(this._n,".getMessageExtensions startSequence:").concat(t)),this.req({P:I.GET_GRP_MSG_EXT,data:{groupID:e.to,messageSequence:e.sequence,startSequence:t}})}},{key:"modifyMsgExts",value:function(e,t){var n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:1;return v.l("".concat(this._n,".modifyMsgExts operateType:").concat(n)),this.req({P:I.MODIFY_GRP_MSG_EXT,data:{groupID:e.to,messageSequence:e.sequence,extensionList:t,operateType:n}})}},{key:"_genNotifyReqList",value:function(e){for(var t,n,o,i,a=[],s=0,r=e.length;s<r;s++)t=e[s],i=this.getLocalGroupProfile(t).type,n=this._getGroupLastRevokedTime(t),o=1e3*Pe(),i={notifyType:1,limit:20,type:St({type:i,groupID:t})?R.GRP_COMMUNITY:void 0,groupID:t,beginTime:n,endTime:o},a.push(i);return a}},{key:"getNotice",value:function(e){var r=this,t="".concat(this._n,".getNotice"),e=e.filter(function(e){if(!r.hasLocalGroup(e))return !1;var e=r.getLocalGroupProfile(e),t=e.type,e=e.isSupportTopic;return !Lt(t)&&!e});0!==e.length&&(v.l("".concat(t," list:").concat(e)),this.req({P:I.GET_GRP_NOTIFY,data:{notifyReqList:this._genNotifyReqList(e)}}).then(function(e){var i,a,e=e.data.notifyRspList,s=[];nt(e)&&(i={dataList:[]},a="".concat(t," ok."),e.forEach(function(e){var t=e.nextRevokedTime,n=e.groupID,o=e.notifyList;a+=" groupID:".concat(n," nextRevokedTime:").concat(t," count:").concat(o.length,"\n"),i.dataList.push({elements:{revokedInfos:r._genRevokedInfos(e)}}),0!==t?(r._setGroupLastRevokedTime(n,t),s.push(n)):r._setGroupLastRevokedTime(n,1e3*Pe());}),v.l(a),r.onMsgRevoked(i,!1)),0<s.length&&r.getNotice(s);}).catch(function(e){v.e("".concat(t," failed. error:"),e);}));}},{key:"_genRevokedInfos",value:function(e){var t=e.notifyList,n=e.groupID,o=[];return nt(t)&&t.forEach(function(e){o.push({groupID:n,sequence:e.sequence,random:e.random,revokerInfo:y({},e.revokerInfo)});}),o}},{key:"_getGroupLastRevokedTime",value:function(e){return this.hasLocalGroup(e)?this.getLocalGroupProfile(e)._lastRevokedTime:0}},{key:"_setGroupLastRevokedTime",value:function(e,t){this.hasLocalGroup(e)&&(this.getLocalGroupProfile(e)._lastRevokedTime=t);}},{key:"isGroupCountersNotice",value:function(e){return this._groupCountersHandler.isGroupCountersNotice(e)}},{key:"setGroupCounters",value:function(e){return this._groupCountersHandler.setGroupCounters(e)}},{key:"increaseGroupCounter",value:function(e){return this._groupCountersHandler.increaseGroupCounter(e)}},{key:"decreaseGroupCounter",value:function(e){return this._groupCountersHandler.decreaseGroupCounter(e)}},{key:"getGroupCounters",value:function(e){return this._groupCountersHandler.getGroupCounters(e)}},{key:"getGroupMemberHandler",value:function(){return this._groupMemberHandler}},{key:"getGroupMemberList",value:function(e){return this._groupMemberHandler.getGroupMemberList(e)}},{key:"getGroupMemberProfile",value:function(e){return this._groupMemberHandler.getGroupMemberProfile(e)}},{key:"addGroupMember",value:function(e){return this._groupMemberHandler.addGroupMember(e)}},{key:"deleteGroupMember",value:function(e){return this._groupMemberHandler.deleteGroupMember(e)}},{key:"setGroupMemberMuteTime",value:function(e){return this._groupMemberHandler.setGroupMemberMuteTime(e)}},{key:"setGroupMemberRole",value:function(e){return this._groupMemberHandler.setGroupMemberRole(e)}},{key:"setGroupMemberNameCard",value:function(e){return this._groupMemberHandler.setGroupMemberNameCard(e)}},{key:"setGroupMemberCustomField",value:function(e){return this._groupMemberHandler.setGroupMemberCustomField(e)}},{key:"markGroupMemberList",value:function(e){return this._groupMemberHandler.markGroupMemberList(e)}},{key:"modifyGroupMemberInfo",value:function(e){return this._groupMemberHandler.modifyGroupMemberInfo(e)}},{key:"restartPolling",value:function(){this._AVChatRoomHandler.restartPolling();}},{key:"getPollingTimerID",value:function(e){if(!e)return -1;var t=this.getLocalGroupProfile(e);return t&&Lt(t.type)?this._AVChatRoomHandler.getPollingTimerID(e):-1}},{key:"_canIUseJoinOption",value:function(e){return e===R.GRP_PUBLIC||St({type:e})}},{key:"_silentlyGetGroupProfile",value:function(e,t){var n=setTimeout(this.getGroupProfile.bind(this,{groupID:t}),3e3);this._timeoutIDs.push(n),v.l("".concat(this._n,"._silentlyGetGroupProfile errorCode:").concat(e," groupID:").concat(t," timeoutIDs:").concat(this._timeoutIDs));}},{key:"_clearTimeoutIDs",value:function(){this._timeoutIDs.forEach(function(e){e&&clearTimeout(e);}),this._timeoutIDs=[];}},{key:"startMessageLongPolling",value:function(e){var t=e.groupID,n=e.longPollingKey,e=e.longPollingSequence,e=void 0===e?1:e,o=this.get(12).isUnlimitedAVChatRoom(),i=(this._AVChatRoomHandler.hasPollingInstance(t)&&this.stopMessageLongPolling({groupID:t}),this._AVChatRoomHandler.getJoinedLiveList()),o=(!o&&0<i.length&&this.stopMessageLongPolling({groupID:i[0]}),new ui({groupID:t,type:R.GRP_LIVE}));return v.l("".concat(this._n,".startMessageLongPolling groupID:").concat(t," longPollingKey:").concat(n," longPollingSequence:").concat(e)),this._AVChatRoomHandler.startRunLoop({group:o,longPollingKey:n,startSeq:e})}},{key:"stopMessageLongPolling",value:function(e){var e=e.groupID,t=this.get(11);return this._AVChatRoomHandler.reset(e),this._deleteLocalGroup(e),t.deleteLocalConv("".concat(R.CONV_GROUP).concat(e)),v.l("".concat(this._n,".stopMessageLongPolling ok, groupID:").concat(e)),Sn({groupID:e})}},{key:"reset",value:function(){this.groupMap.clear(),this._unjoinedAVChatRoomList.clear(),this._receiptDetailCompleteMap.clear(),this._onlineMemberCountMap.clear(),this._commonGroupHandler.reset(),this._groupSystemNoticeHandler.reset(),this._groupTipsHandler.reset(),this._groupAttributesHandler.reset(),this._groupCountersHandler.reset(),this._AVChatRoomHandler.reset(),this._groupMemberHandler.reset(),this._clearTimeoutIDs();}}]),ji),ki=["topicID","topicName","avatar","introduction","notification","unreadCount","muteAllMembers","customData","groupAtInfoList","nextMessageSeq","selfInfo"],Ri=(e(Wi,[{key:"_initTopic",value:function(e){for(var t in e)ki.indexOf(t)<0||("selfInfo"===t?this.updateSelfInfo(e[t]):this[t]="muteAllMembers"===t?1===e[t]:e[t]);}},{key:"updateUnreadCount",value:function(){this.unreadCount=0<arguments.length&&void 0!==arguments[0]?arguments[0]:0;}},{key:"updateNextMessageSeq",value:function(e){this.nextMessageSeq=e;}},{key:"updateLastMessage",value:function(e){this.lastMessage=Zo(e);}},{key:"updateGroupAtInfoList",value:function(e){this.groupAtInfoList=JSON.parse(JSON.stringify(e));}},{key:"updateTopic",value:function(e){A(e.selfInfo)||this.updateSelfInfo(e.selfInfo),A(e.muteAllMembers)||(this.muteAllMembers=1===e.muteAllMembers),rt(this,e,["groupID","lastMessageTime","selfInfo","muteAllMembers","lastMsg"]);}},{key:"updateSelfInfo",value:function(e){return 0===rt(this.selfInfo,e,[],[""])}},{key:"reduceUnreadCount",value:function(){return 1<=this.unreadCount&&(--this.unreadCount,!0)}},{key:"isLastMessageRevoked",value:function(e){return e.sequence===this.lastMessage.lastSequence}},{key:"setLastMessageRevoked",value:function(e){this.lastMessage.isRevoked=e;}},{key:"setLastMessageRevoker",value:function(e){this.lastMessage.revoker=e;}}]),Wi),Ai=(t(Yi,wn),ti=f(Yi),e(Yi,[{key:"_onCloudConfig",value:function(){var e=this.getCloudConfig("topic_cache_time"),t=this.getCloudConfig("topic_last_active_time");A(e)||(this.TOPIC_CACHE_TIME=Number(e)),A(t)||(this.TOPIC_LAST_ACTIVE_TIME=Number(t));}},{key:"onTopicCreated",value:function(e){var t=e.groupID;this.resetGetTopicTime(t),this.emitOEvt(G.TOPIC_CREATED,e);}},{key:"onTopicDeleted",value:function(e){var t=this,n=e.groupID,o=e.topicIDList;(void 0===o?[]:o).forEach(function(e){t._deleteLocalTopic(n,e);}),this.emitOEvt(G.TOPIC_DELETED,e);}},{key:"onTopicProfileUpdated",value:function(e){var t=e.groupID,n=e.topicID,n=this.getLocalTopic(t,n);n&&(n.updateTopic(e),this.emitOEvt(G.TOPIC_UPDATED,{groupID:t,topic:n}));}},{key:"onTopicLatestMsg",value:function(e){var t,n,e=e||{},o=e.topicLatestMessage,e=e.excludedUnreadSequenceList;Je(o)||(t=o.groupProfile.topicID,o.conversationType=R.CONV_GROUP,o.to=t,(n=new ko(o)).setElement(o.elements),this.updateUnreadCountAndLastMsg(t,n,e));}},{key:"onMessageRemindTypeUpdated",value:function(e){var t,n=e.groupID,o=e.topicID,e=e.messageRemindType,i=this.getLocalTopic(n,o);i&&((t=i.updateSelfInfo({messageRemindType:e}))&&this.emitOEvt(G.TOPIC_UPDATED,{groupID:n,topic:i}),v.l("".concat(this._n,".onMessageRemindTypeUpdated topicID:").concat(o," messageRemindType:").concat(e," isUpdated:").concat(t)));}},{key:"onAtInfoUpdated",value:function(e){var t=e.topicID,e=e.groupAtInfoList,n=Bt(t),t=this.getLocalTopic(n,t);t&&!A(e)&&(t.updateGroupAtInfoList(e),this.emitOEvt(G.TOPIC_UPDATED,{groupID:n,topic:t}));}},{key:"onUnreadCountUpdatedFromConv",value:function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:0,n=Bt(e),e=this.getLocalTopic(n,e);e&&e.unreadCount!==t&&(e.updateUnreadCount(t),0===t&&e.updateSelfInfo({readedSequence:e.lastMessage.lastSequence}),this.emitOEvt(G.TOPIC_UPDATED,{groupID:n,topic:e}));}},{key:"onMessageSent",value:function(e){var t,n,o=e.groupID,i=e.topicID,e=e.lastMessage,i=this.getLocalTopic(o,i);!i||(n=(t=void 0===(t=e.sequence)?0:t)+1)>i.nextMessageSeq&&(i.updateNextMessageSeq(n),i.updateLastMessage(e),i.updateSelfInfo({readedSequence:t}),i.updateUnreadCount(0),this.emitOEvt(G.TOPIC_UPDATED,{groupID:o,topic:i}));}},{key:"onMessageModified",value:function(e){var t,n=e.to,o=e.time,i=e.sequence,a=e.elements,s=e.cloudCustomData,r=e.messageVersion,c=Bt(n),u=this.getLocalTopic(c,n);u&&(t=u.lastMessage,v.d("".concat(this._n,".onMessageModified topicID:").concat(n," lastMessage:"),JSON.stringify(t),"options:",JSON.stringify(e)),t&&(null===t.payload||t.lastTime===o&&t.lastSequence===i&&t.version!==r)&&(t.type=a[0].type,t.payload=a[0].content,t.messageForShow=Kt(t.type,t.payload,this.isIntl()),t.cloudCustomData=s,t.version=r,t.lastSequence=i,t.lastTime=o,this.emitOEvt(G.TOPIC_UPDATED,{groupID:c,topic:u})));}},{key:"onMessageRevoked",value:function(e){var n,o,i,a=this;0!==e.length&&(o=n=null,i=!1,e.forEach(function(e){var t=e.to;o=Bt(t),(n=a.getLocalTopic(o,t))&&(n.reduceUnreadCount()&&(i=!0),n.isLastMessageRevoked(e)&&(n.setLastMessageRevoked(!0),n.setLastMessageRevoker(e.revoker),i=!0),(t=n.selfInfo.excludedUnreadSequenceList||[]).push(e.sequence),n.updateSelfInfo({excludedUnreadSequenceList:t}));}),i&&this.emitOEvt(G.TOPIC_UPDATED,{groupID:o,topic:n}));}},{key:"isLastMessageRevoked",value:function(e){var t=e.topicID,e=e.sequence,n=Bt(t),n=this.getLocalTopic(n,t),t=!1;return t=n?n.isLastMessageRevoked({sequence:e}):t}},{key:"updateUnreadCountAndLastMsg",value:function(e,t,n){var o,i=Bt(e),a=this.getLocalTopic(i,e);a&&(o=a.selfInfo.excludedUnreadSequenceList||[],A(n)||(o=n),t._isExcludedFromUnreadCount&&o.push(t.sequence),a.updateSelfInfo({excludedUnreadSequenceList:o}),v.l("".concat(this._n,".updateUnreadCountAndLastMsg seq:").concat(t.sequence," lastSeq:").concat(a.lastMessage.lastSequence)),t.sequence>a.lastMessage.lastSequence&&(a.updateLastMessage(t),n=t.sequence+1,a.updateNextMessageSeq(n),o=this._computeUnreadCount(a),a.updateUnreadCount(o),(t=this.get(11).getLocalConversation("".concat(R.CONV_GROUP).concat(e)))&&t.updateUnreadCount({nextUnreadCount:o,isFromGetConversations:!0}),this.emitOEvt(G.TOPIC_UPDATED,{groupID:i,topic:a})));}},{key:"getJoinedCommunityList",value:function(){return this.get(7).syncCommunityWithTopic()}},{key:"createTopicInCommunity",value:function(t){var n=this,o="".concat(this._n,".").concat("createTopicInCommunity"),e=t.topicID;if(!A(e)&&!kt(e))return C({code:T.ILLEGAL_TOPIC_ID});if(t.topicName&&!1===this._filterProfanity("topicName",t))return C({code:T.PROFANITY_FOUND});if(t.introduction&&!1===this._filterProfanity("introduction",t))return C({code:T.PROFANITY_FOUND});if(t.notification&&!1===this._filterProfanity("notification",t))return C({code:T.PROFANITY_FOUND});var i=new M("createTopicInCommunity");return this.req({P:I.CREATE_TOPIC,data:y({},t)}).then(function(e){e=e.data.topicID;return i.setMessage("topicID:".concat(e)).end(),v.l("".concat(o," ok. topicID:").concat(e)),n._updateTopicMap([y(y({},t),{},{topicID:e})]),Ln({topicID:e})}).catch(function(e){return i.setError(e).end(),v.e("".concat(o," failed. error:"),e),C(e)})}},{key:"deleteTopicFromCommunity",value:function(e){var t=this,n="".concat(this._n,".").concat("deleteTopicFromCommunity"),a=e.groupID,e=e.topicIDList,e=void 0===e?[]:e,s=new M("deleteTopicFromCommunity");return s.setMessage("groupID:".concat(a," topicIDList:").concat(e)),this.req({P:I.DEL_TOPIC,data:{groupID:a,topicIDList:e}}).then(function(e){var e=e.data.resultList,o=[],i=[],e=((void 0===e?[]:e).forEach(function(e){var t=e.topicID,n=e.errorCode,e=e.errorInfo;0===n?o.push({topicID:t}):i.push({topicID:t,code:n,message:e});}),"success count:".concat(o.length,", fail count:").concat(i.length));return s.setMoreMessage(e).end(),v.l("".concat(n," ok. ").concat(e)),o.forEach(function(e){t._deleteLocalTopic(a,e.topicID);}),Ln({successTopicList:o,failureTopicList:i})}).catch(function(e){return s.setError(e).end(),v.e("".concat(n," failed. error:"),e),C(e)})}},{key:"updateTopicProfile",value:function(e){var t=this,n="".concat(this._n,".").concat("updateTopicProfile");if(v.l("".concat(n," options:"),e),e.topicName&&!1===this._filterProfanity("topicName",e))return C({code:T.PROFANITY_FOUND});if(e.introduction&&!1===this._filterProfanity("introduction",e))return C({code:T.PROFANITY_FOUND});if(e.notification&&!1===this._filterProfanity("notification",e))return C({code:T.PROFANITY_FOUND});var o=new M("updateTopicProfile");return o.setMessage("groupID:".concat(e.groupID," topicID:").concat(e.topicID)),A(e.muteAllMembers)||(e.muteAllMembers=!0===e.muteAllMembers?"On":"Off"),this.req({P:I.UPDATE_TOPIC_PROFILE,data:y({},e)}).then(function(){return o.end(),v.l("".concat(n," ok")),t._updateTopicMap([e]),Ln({topic:t.getLocalTopic(e.groupID,e.topicID)})}).catch(function(e){return o.setError(e).end(),v.e("".concat(n," failed. error:"),e),C(e)})}},{key:"getTopicList",value:function(e){var t=this,n="".concat(this._n,".").concat("getTopicList"),o=e.groupID,e=e.topicIDList,e=void 0===e?[]:e,i=0===e.length,c=new M("getTopicList");if(c.setMessage("groupID:".concat(o)),this._getTopicTimeMap.has(o)){var a=this._getTopicTimeMap.get(o),s=a.isGetAll,a=a.time;if((s||!s&&!i)&&Date.now()-a<1e3*this.TOPIC_CACHE_TIME){s=this._getLocalTopicList(o,e);if(i||s.length===e.length)return c.setMoreMessage("from cache, topic count:".concat(s.length)).end(),v.l("".concat(n," groupID:").concat(o," from cache, topic count:").concat(s.length)),Sn({successTopicList:s,failureTopicList:[]})}}return this.req({P:I.GET_TOPIC_LIST,data:{groupID:o,topicIDList:e}}).then(function(e){var e=e.data.topicInfoList,a=[],s=[],r=[],e=((void 0===e?[]:e).forEach(function(e){var t=e.topic,n=e.selfInfo,o=e.errorCode,e=e.errorInfo,i=t.topicID;0===o?(a.push(y(y({},t),{},{selfInfo:n})),s.push(i)):r.push({topicID:i,code:o,message:e});}),t._updateTopicMap(a),t._handleTopicAtInfo(a),"success count:".concat(s.length,", fail count:").concat(r.length)),e=(c.setMoreMessage(e).end(),v.l("".concat(n," groupID:").concat(o," from remote, ").concat(e)),[]);return Je(s)||(t._getTopicTimeMap.set(o,{time:Date.now(),isGetAll:i}),e=t._getLocalTopicList(o,s)),Ln({successTopicList:e,failureTopicList:r})}).catch(function(e){return c.setError(e).end(),v.e("".concat(n," failed. error:"),e),C(e)})}},{key:"hasLocalTopic",value:function(e,t){return !!this._topicMap.has(e)&&this._topicMap.get(e).has(t)}},{key:"getLocalTopic",value:function(e,t){var n=null;return n=this._topicMap.has(e)?this._topicMap.get(e).get(t):n}},{key:"_getLocalTopicList",value:function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:[],e=this._topicMap.get(e),n=[];return e&&(n=D(e.values())),0===t.length?n:n.filter(function(e){return t.includes(e.topicID)})}},{key:"_deleteLocalTopic",value:function(e,t){this._topicMap.has(e)&&this._topicMap.get(e).has(t)&&(this._topicMap.get(e).delete(t),v.l("".concat(this._n,"._deleteLocalTopic groupID:").concat(e," topicID:").concat(t)));}},{key:"_updateTopicMap",value:function(e){var i=this,a=[];e.forEach(function(e){var t=e.groupID,n=e.topicID,o=null,e=(i._topicMap.has(t)||i._topicMap.set(t,new Map),i._topicMap.get(t).has(n)?(o=i._topicMap.get(t).get(n)).updateTopic(e):(i._getTopicLastMessage(e),o=new Ri(e,i.isIntl()),i._topicMap.get(t).set(n,o)),i._computeUnreadCount(o));o.updateUnreadCount(e),a.push({conversationID:"".concat(R.CONV_GROUP).concat(n),type:R.CONV_TOPIC,unreadCount:e});}),0<a.length&&this.get(11).updateTopicConversation(a);}},{key:"resetGetTopicTime",value:function(e){var t=this;A(e)?D(this._getTopicTimeMap.keys()).forEach(function(e){t._getTopicTimeMap.set(e,0);}):this._getTopicTimeMap.set(e,0);}},{key:"getTopicListOnReconnected",value:function(){var o=this,e=D(this._topicMap.keys()),i=[],a=this.get(11);e.forEach(function(e){var n=[],t=o._getLocalTopicList(e);a.deleteTopicRoamingInfo(e),t.forEach(function(e){var t=e.lastMessage.lastTime,t=void 0===t?0:t;Date.now()-1e3*t<1e3*o.TOPIC_LAST_ACTIVE_TIME&&n.push(e.topicID);}),0<n.length&&i.push({groupID:e,topicIDList:n});}),v.l("".concat(this._n,".getTopicListOnReconnected. active community count:").concat(i.length)),this._relayGetTopicList(i);}},{key:"_relayGetTopicList",value:function(t){var e,n,o,i=this;0!==t.length&&(n=5<(e=t.shift()).topicIDList.length?"topicIDList.length:".concat(e.topicIDList.length):"topicIDList:".concat(e.topicIDList),(o=new M("relayGetTopicList")).setMessage(n),v.l("".concat(this._n,"._relayGetTopicList. ").concat(n)),this.getTopicList(e).then(function(){o.end(),i._relayGetTopicList(t);}).catch(function(e){o.setError(e).end(),i._relayGetTopicList(t);}));}},{key:"_handleTopicAtInfo",value:function(e){var i=this;0!==e.length&&e.forEach(function(e){var t=e.groupID,n=e.topicID,e=e.groupAtInfoList,o=[];A(e)||(e.forEach(function(e){o.push(y(y({},e),{},{groupID:t,topicID:n}));}),i.get(11).onNewGroupAtTips({dataList:o}));});}},{key:"_getTopicLastMessage",value:function(e){var t;A(e.lastMsg)||(t={time:e.lastMsg.time,sequence:e.lastMsg.sequence,from:e.lastMsg.from,payload:e.lastMsg.elements[0]?e.lastMsg.elements[0].content:null,type:e.lastMsg.elements[0]?e.lastMsg.elements[0].type:"",nick:e.lastMsg.nick,avatar:e.lastMsg.avatar,version:e.lastMsg.messageVersion,cloudCustomData:e.lastMsg.cloudCustomData,isRevoked:2===e.lastMsg.isPlaceMessage,revoker:Je(e.lastMsg.revokerInfo)?null:e.lastMsg.revokerInfo.revoker},e.lastMessage=t);}},{key:"deleteTopicListInCommunity",value:function(t){var n=this,e=this._getLocalTopicList(t),o=this.get(11);e.forEach(function(e){e=e.topicID;n._deleteLocalTopic(t,e),n._getTopicTimeMap.delete(t),o.deleteLocalConv("".concat(R.CONV_GROUP).concat(e));});}},{key:"_computeUnreadCount",value:function(t){var n,e=t.selfInfo,o=e.excludedUnreadSequenceList,i=e.readedSequence,e=t.nextMessageSeq-t.selfInfo.readedSequence-1;return nt(o)&&(n=0,o.forEach(function(e){i<e&&e<=t.nextMessageSeq-1&&(n+=1);}),1<=n&&(e-=n)),e<0?0:e}},{key:"_filterProfanity",value:function(e,t){var n=this.get(29);if(!n)return !0;var n=n.filterText(t[e],B),o=n.isAllowedToSend,n=n.modifiedText;return !0===o&&(t[e]=n,!0)}},{key:"getMessageExtensions",value:function(e,t){v.l("".concat(this._n,".getMessageExtensions startSequence:").concat(t));var n=Bt(e.to);return this.req({P:I.GET_GRP_MSG_EXT,data:{groupID:n,topicID:e.to,messageSequence:e.sequence,startSequence:t}})}},{key:"modifyMsgExts",value:function(e,t){var n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:1,o=(v.l("".concat(this._n,".modifyMsgExts operateType:").concat(n)),Bt(e.to));return this.req({P:I.MODIFY_GRP_MSG_EXT,data:{groupID:o,topicID:e.to,messageSequence:e.sequence,extensionList:t,operateType:n}})}},{key:"reset",value:function(){v.l("".concat(this._n,".reset")),this._topicMap.clear(),this._getTopicTimeMap.clear(),this.TOPIC_CACHE_TIME=300,this.TOPIC_LAST_ACTIVE_TIME=3600;}}]),Yi),Oi=(e(Ki,[{key:"setExpirationTime",value:function(e){this.expirationTime=e;}},{key:"getUserProfile",value:function(e){var t=this,n="".concat(this._n,".").concat("getUserProfile"),o=e.userIDList;e.fromAccount=this._userM.getMyAccount(),100<o.length&&(v.w("".concat(n," ").concat(Jt(100))),o.length=100);for(var i,a=[],s=[],r=0,l=o.length;r<l;r++)i=o[r],this._userM.isMyFriend(i)&&this._contains(i)?s.push(this._getProfileFromMap(i)):a.push(i);if(0===a.length)return Sn(s);e.toAccount=a;var d=e.bFromGetMyProfile||!1,c=[],u=(e.toAccount.forEach(function(e){c.push({toAccount:e,standardSequence:0,customSequence:0});}),e.userItem=c,new M("getUserProfile"));return u.setMessage(5<o.length?"userIDList.length:".concat(o.length):"userIDList:".concat(o)),this._userM.req({P:I.GET_USER_PROFILE,data:e}).then(function(e){u.end(),v.i("".concat(n," ok"));e=t._handleResponse(e).concat(s);return Ln(d?e[0]:e)}).catch(function(e){return u.setError(e).end(),v.e("".concat(n," failed. error:"),e),C(e)})}},{key:"getMyProfile",value:function(){var e,t=this._userM.getMyAccount(),n="".concat(this._n,".getMyProfile");return v.l("".concat(n," myAccount:").concat(t)),this._fill(),this._contains(t)?(e=this._getProfileFromMap(t),v.d("".concat(n," from cache, myProfile:").concat(JSON.stringify(e))),Sn(e)):this.getUserProfile({fromAccount:t,userIDList:[t],bFromGetMyProfile:!0})}},{key:"_handleResponse",value:function(e){var t=e.data.userProfileItem;if(!nt(t))return [];for(var n=[],e=Date.now(),o=0,i=t.length;o<i;o++){var a=t[o],s=a.to,a=a.profileItem;"@TLS#NOT_FOUND"!==s&&""!==s&&(s=this._update(s,this._getLatestProfileFromResponse(s,a)).latestProfile,n.push(s));}return v.l("".concat(this._n,"._handleResponse cost:").concat(Zt(e))),n}},{key:"_getLatestProfileFromResponse",value:function(e,t){var n={userID:e,profileCustomField:[]};if(!Je(t))for(var o=0,i=t.length;o<i;o++)if(-1<t[o].tag.indexOf("Tag_Profile_Custom"))n.profileCustomField.push({key:t[o].tag,value:t[o].value});else switch(t[o].tag){case qe.NICK:n.nick=t[o].value;break;case qe.GENDER:n.gender=t[o].value;break;case qe.BIRTHDAY:n.birthday=t[o].value;break;case qe.LOCATION:n.location=t[o].value;break;case qe.SELFSIGNATURE:n.selfSignature=t[o].value;break;case qe.ALLOWTYPE:n.allowType=t[o].value;break;case qe.LANGUAGE:n.language=t[o].value;break;case qe.AVATAR:n.avatar=t[o].value;break;case qe.MESSAGESETTINGS:n.messageSettings=t[o].value;break;case qe.ADMINFORBIDTYPE:n.adminForbidType=t[o].value;break;case qe.LEVEL:n.level=t[o].value;break;case qe.ROLE:n.role=t[o].value;break;default:v.w("".concat(this._n,"._getLatestProfileFromResponse unknown tag:"),t[o].tag,t[o].value);}return n}},{key:"updateMyProfile",value:function(o){var i=this,a="".concat(this._n,".").concat("updateMyProfile");if(o.nick&&!1===this._userM.filterProfanity("nick",o))return C({code:T.PROFANITY_FOUND});if(o.selfSignature&&!1===this._userM.filterProfanity("selfSignature",o))return C({code:T.PROFANITY_FOUND});var s=new M("updateMyProfile"),e=(s.setMessage(JSON.stringify(o)),(new si).validate(o));if(!e.valid)return s.setCode(T.UPDATE_PROFILE_INVALID_PARAM).setMoreMessage("info:".concat(e.tips)).end(),v.e("".concat(a," info:").concat(e.tips)),C({code:T.UPDATE_PROFILE_INVALID_PARAM});var t,n=[];for(t in o)Object.prototype.hasOwnProperty.call(o,t)&&("profileCustomField"===t?o.profileCustomField.forEach(function(e){n.push({tag:e.key,value:e.value});}):n.push({tag:qe[t.toUpperCase()],value:o[t]}));if(0===n.length)return e=new Hn({code:T.UPDATE_PROFILE_NO_KEY}),s.setError(e).end(),v.e("".concat(a," failed. error:"),e),C(e);var r=this._userM.getMyAccount();return this._userM.req({P:I.UPDATE_MY_PROFILE,data:{fromAccount:r,profileItem:n}}).then(function(e){s.end(),v.i("".concat(a," ok"));var t=i._update(r,o),n=t.isProfileUpdated,t=t.latestProfile;return !0===n&&i._userM.emitOEvt(G.PROFILE_UPDATED,[t]),Sn(t)}).catch(function(e){return s.setError(e).end(),v.e("".concat(a," failed. error:"),e),C(e)})}},{key:"onProfileModified",value:function(e){var t=e.dataList;if(!Je(t)){var n=t.length;v.d("".concat(this._n,".onProfileModified count:").concat(n," dataList:"),e.dataList);for(var o=[],i=0;i<n;i++){var a=t[i].userID,a=this._update(a,this._getLatestProfileFromResponse(a,t[i].profileList)),s=a.isProfileUpdated,a=a.latestProfile;!0===s&&o.push(a);}0<o.length&&(this._userM.emitIEvt(Yo.PROFILE_UPDATED,o),this._userM.emitOEvt(G.PROFILE_UPDATED,o));}}},{key:"_fill",value:function(){if(0===this.accountProfileMap.size){for(var e=this._getCachedProfiles(),t=Date.now(),n=0,o=e.length;n<o;n++)t-e[n].lastUpdatedTime<this.expirationTime&&this.accountProfileMap.set(e[n].userID,e[n]);v.l("".concat(this._n,"._fill from cache, size:").concat(this.accountProfileMap.size));}}},{key:"_update",value:function(e,t){var n,o=!1,i=Date.now();return this._contains(e)?(n=this._getProfileFromMap(e),t.profileCustomField&&!0===Tt(n.profileCustomField,t.profileCustomField)&&(n.lastUpdatedTime=i,o=!0),0<rt(n,t,["profileCustomField"])&&(n.lastUpdatedTime=i,o=!0)):(n=new si(t),!this._userM.isMyFriend(e)&&e!==this._userM.getMyAccount()||(n.lastUpdatedTime=i,o=!0,this.accountProfileMap.set(e,n))),this._flush(e===this._userM.getMyAccount()),!0===o&&v.l("".concat(this._n,"._update account:").concat(e," isUpdated:").concat(o)),{isProfileUpdated:o,latestProfile:n}}},{key:"_flush",value:function(e){var t=D(this.accountProfileMap.values()),n=this._userM.getStorageModule();v.d("".concat(this._n,"._flush length:").concat(t.length," flushAtOnce:").concat(e)),n.setItem(this.TAG,t,e);}},{key:"_contains",value:function(e){return this.accountProfileMap.has(e)}},{key:"_getProfileFromMap",value:function(e){return this.accountProfileMap.get(e)}},{key:"_getCachedProfiles",value:function(){var e=this._userM.getStorageModule().getItem(this.TAG);return Je(e)?[]:e}},{key:"onConvProfileUpdated",value:function(e){for(var t,n,o,i=[],a=0,s=e.length;a<s;a++)n=(t=e[a]).userID,this._userM.isMyFriend(n)&&(this._contains(n)?(o=this._getProfileFromMap(n),0<rt(o,t)&&i.push(n)):i.push(t.userID));0!==i.length&&(v.l("".concat(this._n,".onConvProfileUpdated toAccountList:").concat(i)),this.getUserProfile({userIDList:i}));}},{key:"getNickAndAvatarByUserID",value:function(e){return this._contains(e)?{nick:(e=this._getProfileFromMap(e)).nick,avatar:e.avatar}:{nick:"",avatar:""}}},{key:"getUserNickAndAvatar",value:function(e){var t=this,n=D(new Set(e)),o=(v.l("".concat(this._n,".getUserNickAndAvatar userIDList.length:").concat(e.length," uniqueUserIDList.length:").concat(n.length)),[]);if(0===e.length)return Promise.resolve(o);var e=this._createUserIDListGroup(n),i=[];return e.forEach(function(e){i.push(t.getUserProfile({userIDList:e}));}),Promise.all(i).then(function(e){return e.forEach(function(e){e=e.data.map(function(e){return {userID:e.userID,nick:e.nick,avatar:e.avatar}});o.push.apply(o,D(e));}),o})}},{key:"_createUserIDListGroup",value:function(e){for(var t=[],n=0;n<e.length;)t.push(e.slice(n,n+=100));return t}},{key:"reset",value:function(){this._flush(!0),this.accountProfileMap.clear();}}]),Ki),Ni=e(function e(t){d(this,e);}),Gi=(e(Bi,[{key:"getLocalBlacklist",value:function(){return D(this._blacklistMap.keys())}},{key:"getBlacklist",value:function(){var o=this,i="".concat(this._n,".getBlacklist"),e={fromAccount:this._userM.getMyAccount(),maxLimited:100,startIndex:this._startIndex},a=new M("getBlacklist");return this._userM.req({P:I.GET_BL,data:e}).then(function(e){var e=e.data,t=e.blackListItem,e=e.startIndex,n=Je(t)?0:t.length;a.setMessage("count:".concat(n)).end(),v.i("".concat(i," ok")),o._startIndex=e,o._handleResponse(t,!0),o._userM.emitOEvt(G.BLACKLIST_UPDATED,D(o._blacklistMap.keys())),0!==o._startIndex&&o.getBlacklist();}).catch(function(e){return a.setError(e).end(),v.e("".concat(i," failed. error:"),e),C(e)})}},{key:"addBlacklist",value:function(t){var e,n,o=this,i=new M("addToBlacklist"),a="".concat(this._n,".addBlacklist"),s=this._userM.getMyAccount();return 1===t.userIDList.length&&t.userIDList[0]===s?(n=this._userM.getErrMsg(e=T.CANNOT_ADD_SELF_TO_BLACKLIST),i.setCode(e).setMessage(n).end(),n=new Hn({code:e}),v.e("".concat(a," failed. error:"),n),C(n)):(t.userIDList.includes(s)&&(t.userIDList=t.userIDList.filter(function(e){return e!==s})),t.fromAccount=this._userM.getMyAccount(),t.toAccount=t.userIDList,this._userM.req({P:I.ADD_TO_BL,data:t}).then(function(e){return i.setMessage(5<t.userIDList.length?"userIDList.length:".concat(t.userIDList.length):"userIDList:".concat(t.userIDList)).end(),v.i("".concat(a," ok")),o._handleResponse(e.resultItem,!0),Ln(D(o._blacklistMap.keys()))}).catch(function(e){return i.setError(e).end(),v.e("".concat(a," failed. error:"),e),C(e)}))}},{key:"_handleResponse",value:function(e,t){if(!Je(e))for(var n,o,i,a=0,s=e.length;a<s;a++)o=e[a].to,i=e[a].resultCode,!A(i)&&0!==i||(t?((n=this._blacklistMap.has(o)?this._blacklistMap.get(o):new Ni).userID=o,Je(e[a].addBlackTimeStamp)||(n.timeStamp=e[a].addBlackTimeStamp),this._blacklistMap.set(o,n)):this._blacklistMap.has(o)&&(n=this._blacklistMap.get(o),this._blacklistMap.delete(o)));v.l("".concat(this._n,"._handleResponse total:").concat(this._blacklistMap.size," bAdd:").concat(t));}},{key:"deleteBlacklist",value:function(t){var n=this,o="".concat(this._n,".deleteBlacklist"),i=new M("removeFromBlacklist");return t.fromAccount=this._userM.getMyAccount(),t.toAccount=t.userIDList,this._userM.req({P:I.RM_FROM_BL,data:t}).then(function(e){return i.setMessage(5<t.userIDList.length?"userIDList.length:".concat(t.userIDList.length):"userIDList:".concat(t.userIDList)).end(),v.i("".concat(o," ok")),n._handleResponse(e.data.resultItem,!1),Ln(D(n._blacklistMap.keys()))}).catch(function(e){return i.setError(e).end(),v.e("".concat(o," failed. error:"),e),C(e)})}},{key:"onAccountDeleted",value:function(e){for(var t=0,n=e.length;t<n;t++){var o=e[t];this._blacklistMap.has(o)&&this._blacklistMap.delete(o);}var i=e.length;0<i&&(v.l("".concat(this._n,".onAccountDeleted count:").concat(i," ").concat(i<30?"userIDList:".concat(e):"")),this._userM.emitOEvt(G.BLACKLIST_UPDATED,D(this._blacklistMap.keys())));}},{key:"onAccountAdded",value:function(e){for(var t,n=[],o=0,i=e.length;o<i;o++)t=e[o],this._blacklistMap.has(t)||(this._blacklistMap.set(t,new Ni({userID:t})),n.push(t));0<n.length&&(v.l("".concat(this._n,".onAccountAdded count:").concat(n.length," userIDList:"),n),this._userM.emitOEvt(G.BLACKLIST_UPDATED,D(this._blacklistMap.keys())));}},{key:"reset",value:function(){this._blacklistMap.clear(),this._startIndex=0;}}]),Bi),Pi=(e(Hi,[{key:"_onCloudConfig",value:function(){var e=this._userM.getCloudConfig("status_query_count"),t=this._userM.getCloudConfig("status_sub_count"),n=this._userM.getCloudConfig("status_unsub_count");v.l("".concat(this._n,"._onCloudConfig statusQueryCount:").concat(e," statusSubscribeCount:").concat(t)+" statusUnsubscribeCount:".concat(n)),A(e)||(this.MAX_QUERY_USER_COUNT=parseInt(e,10)),A(e)||(this.MAX_SUBSCRIBE_USER_COUNT=parseInt(t,10)),A(e)||(this.MAX_UNSUBSCRIBE_USER_COUNT=parseInt(n,10));}},{key:"onUserStatusUpdated",value:function(e){var e=e.dataList,o=this._userM.getMyUserID(),i=this._userM.get(12),e=e.map(function(e){var t=e.to,n=e.statusType,e=e.customStatus,e=Qo(e);return t===o&&i.setCustomStatus(e),{userID:t,statusType:n,customStatus:e}});v.l("".concat(this._n,".onUserStatusUpdated list:").concat(JSON.stringify(e))),this._userM.emitOEvt(G.USER_STATUS_UPDATED,e);}},{key:"setSelfStatus",value:function(e){var t=this,n="".concat(this._n,".setSelfStatus");if(!1===this._userM.filterProfanity("customStatus",e))return C({code:T.PROFANITY_FOUND});var o=new M("setSelfStatus"),i=e.customStatus;return this._userM.req({P:I.SET_SELF_STATUS,data:{customStatus:i}}).then(function(e){return o.setMessage("customStatus:".concat(i)).end(),v.l("".concat(n," ok. customStatus:").concat(i)),t._userM.get(12).setCustomStatus(i),Ln({userID:t._userM.getMyUserID(),statusType:1,customStatus:i})}).catch(function(e){return o.setError(e).end(),v.e("".concat(n," failed. error:"),e),C(e)})}},{key:"getUserStatus",value:function(e){var o="".concat(this._n,".").concat("getUserStatus"),e=e.userIDList,i=void 0===e?[]:e,e=this._userM.getMyUserID(),t=D(i),a=void 0,n=t.indexOf(e);if(-1<n&&(t.splice(n,1),a={userID:e,statusType:1,customStatus:this._userM.get(12).getCustomStatus()}),0===t.length)return Sn({successUserList:[a],failureUserList:[]});if(!this._userM.canIUse(H.USER_STATUS))return this._userM.noUse("getUserStatus");t.length>this.MAX_QUERY_USER_COUNT&&(v.w("".concat(o," ").concat(Jt(this.MAX_QUERY_USER_COUNT))),t=i.slice(0,this.MAX_QUERY_USER_COUNT));var s=new M("getUserStatus");return this._userM.req({P:I.GET_USER_STATUS,data:{userIDList:t}}).then(function(e){var e=e.data,t=e.successUserList,t=void 0===t?[]:t,e=e.failureUserList,e=void 0===e?[]:e,t=t.map(function(e){var t=e.userID,n=e.statusType,e=e.customStatus;return {userID:t,statusType:n,customStatus:Qo(e)}}),e=e.map(function(e){var t=e.userID,n=e.invalidUserID,o=e.errorCode,e=e.errorInfo;return {userID:Je(n)?t:n,code:o,message:e}}),n=(A(a)||t.unshift(a),"userID count:".concat(i.length,", success count:").concat(t.length,", fail count:").concat(e.length));return s.setMessage("".concat(n)).end(),v.l("".concat(o," ok. ").concat(n,".")),Ln({successUserList:t,failureUserList:e})}).catch(function(e){return s.setMessage("userID count:".concat(i.length)).setError(e).end(),v.e("".concat(o," failed. error:"),e),C(e)})}},{key:"subscribeUserStatus",value:function(e){var t="subscribeUserStatus";if(!this._userM.canIUse(H.USER_STATUS))return this._userM.noUse(t);var n="".concat(this._n,".").concat(t),e=e.userIDList,e=void 0===e?[]:e,o=D(e),i=(o.length>this.MAX_SUBSCRIBE_USER_COUNT&&(v.w("".concat(n," ").concat(Jt(this.MAX_SUBSCRIBE_USER_COUNT))),o=e.slice(0,this.MAX_SUBSCRIBE_USER_COUNT)),new M(t)),a="userID count:".concat(e.length);return v.l("".concat(n," ").concat(a)),this._userM.req({P:I.SUB_USER_STATUS,data:{userIDList:o}}).then(function(e){e=e.data.failureUserList,e=(void 0===e?[]:e).map(function(e){var t=e.userID,n=e.invalidUserID,o=e.errorCode,e=e.errorInfo;return {userID:Je(n)?t:n,code:o,message:e}});return i.setMessage("".concat(a," fail count:").concat(e.length)).end(),v.l("".concat(n," ok. fail count:").concat(e.length,".")),Ln({failureUserList:e})}).catch(function(e){return i.setMessage(a).setError(e).end(),v.e("".concat(n," failed. error:"),e),C(e)})}},{key:"unsubscribeUserStatus",value:function(e){var t="unsubscribeUserStatus";if(!this._userM.canIUse(H.USER_STATUS))return this._userM.noUse(t);var n="".concat(this._n,".").concat(t),e=(e||{}).userIDList,e=void 0===e?[]:e,o=D(e),i=(e.length>this.MAX_UNSUBSCRIBE_USER_COUNT&&(v.w("".concat(n," ").concat(Jt(this.MAX_UNSUBSCRIBE_USER_COUNT))),o=e.slice(0,this.MAX_UNSUBSCRIBE_USER_COUNT)),new M(t)),a="userID count:".concat(e.length),t=(v.l("".concat(n," ").concat(a)),{userIDList:o});return 0===o.length&&(t.userIDList=void 0,t.unsubscribeAll=1),this._userM.req({P:I.UNSUB_USER_STATUS,data:t}).then(function(e){e=e.data.failureUserList,e=(void 0===e?[]:e).map(function(e){var t=e.userID,n=e.invalidUserID,o=e.errorCode,e=e.errorInfo;return {userID:Je(n)?t:n,code:o,message:e}});return i.setMessage("".concat(a," fail count:").concat(e.length)).end(),v.l("".concat(n," ok. fail count:").concat(e.length,".")),Ln({failureUserList:e})}).catch(function(e){return i.setMessage("".concat(a)).setError(e).end(),v.e("".concat(n," failed. error:"),e),C(e)})}},{key:"reset",value:function(){this.MAX_QUERY_USER_COUNT=500,this.MAX_SUBSCRIBE_USER_COUNT=100,this.MAX_UNSUBSCRIBE_USER_COUNT=100;}}]),Hi),Ui=(t(Vi,wn),ei=f(Vi),e(Vi,[{key:"onContextUpdated",value:function(e){this._profileHandler.getMyProfile(),this._blacklistHandler.getBlacklist();}},{key:"mockOnNickAvatarModified",value:function(e,t){v.l("".concat(this._n,"._mockOnNickAvatarModified nick:").concat(e," avatar:").concat(t)),this.onProfileModified({dataList:[{pushType:1,userID:this.getMyUserID(),profileList:[{tag:qe.NICK,value:e},{tag:qe.AVATAR,value:t}]}]});}},{key:"onProfileModified",value:function(e){this._profileHandler.onProfileModified(e);}},{key:"onRelationChainModified",value:function(e){var t,n,e=e.dataList;Je(e)||(t=[],e.forEach(function(e){e.blackListDelAccount&&t.push.apply(t,D(e.blackListDelAccount));}),0<t.length&&this._blacklistHandler.onAccountDeleted(t),n=[],e.forEach(function(e){e.blackListAddAccount&&n.push.apply(n,D(e.blackListAddAccount));}),0<n.length&&this._blacklistHandler.onAccountAdded(n));}},{key:"onConvProfileUpdated",value:function(e){this._profileHandler.onConvProfileUpdated(e);}},{key:"getMyAccount",value:function(){return this.getMyUserID()}},{key:"getMyNick",value:function(){return this._profileHandler.getNickAndAvatarByUserID(this.getMyUserID()).nick}},{key:"getMyProfile",value:function(){return this._profileHandler.getMyProfile()}},{key:"getStorageModule",value:function(){return this.get(13)}},{key:"filterProfanity",value:function(e,t){var n=this.get(29);if(!n)return !0;var n=n.filterText(t[e],"user_profile"),o=n.isAllowedToSend,n=n.modifiedText;return !0===o&&(t[e]=n,!0)}},{key:"isMyFriend",value:function(e){var t=this.get(8);return !!t&&t.isMyFriend(e)}},{key:"getUserProfile",value:function(e){return this._profileHandler.getUserProfile(e)}},{key:"updateMyProfile",value:function(e){return this._profileHandler.updateMyProfile(e)}},{key:"getNickAndAvatarByUserID",value:function(e){return this._profileHandler.getNickAndAvatarByUserID(e)}},{key:"getUserNickAndAvatar",value:function(e){return this._profileHandler.getUserNickAndAvatar(e)}},{key:"getLocalBlacklist",value:function(){var e=this._blacklistHandler.getLocalBlacklist();return Sn(e)}},{key:"addBlacklist",value:function(e){return this._blacklistHandler.addBlacklist(e)}},{key:"deleteBlacklist",value:function(e){return this._blacklistHandler.deleteBlacklist(e)}},{key:"onUserStatusUpdated",value:function(e){this._userStatusHandler.onUserStatusUpdated(e);}},{key:"setSelfStatus",value:function(e){return this._userStatusHandler.setSelfStatus(e)}},{key:"getUserStatus",value:function(e){return this._userStatusHandler.getUserStatus(e)}},{key:"subscribeUserStatus",value:function(e){return this._userStatusHandler.subscribeUserStatus(e)}},{key:"unsubscribeUserStatus",value:function(e){return this._userStatusHandler.unsubscribeUserStatus(e)}},{key:"reset",value:function(){v.l("".concat(this._n,".reset")),this._profileHandler.reset(),this._blacklistHandler.reset(),this._userStatusHandler.reset();}}]),Vi),bi=(e(xi,[{key:"isLoggedIn",value:function(){return this._isLoggedIn}},{key:"isOversea",value:function(){return this._oversea}},{key:"isPrivateNetWork",value:function(){return this._proxyServer}},{key:"isDevMode",value:function(){return this._isDevMode}},{key:"isTestEnv",value:function(){return this._isTestEnv}},{key:"isPartialUpdatedConvs",value:function(){return this._isPartialUpdatedConvs}},{key:"isIndependentDomainDisabled",value:function(){return this._isIndependentDomainDisabled}},{key:"isSingaporeSite",value:function(){return 2e7<=this._SDKAppID&&this._SDKAppID<3e7||172e7<=this._SDKAppID&&this._SDKAppID<173e7}},{key:"isKoreaSite",value:function(){return 3e7<=this._SDKAppID&&this._SDKAppID<4e7||173e7<=this._SDKAppID&&this._SDKAppID<174e7}},{key:"isGermanySite",value:function(){return 4e7<=this._SDKAppID&&this._SDKAppID<5e7||174e7<=this._SDKAppID&&this._SDKAppID<175e7}},{key:"isIndiaSite",value:function(){return 5e7<=this._SDKAppID&&this._SDKAppID<6e7||175e7<=this._SDKAppID&&this._SDKAppID<176e7}},{key:"isJapanSite",value:function(){return 6e7<=this._SDKAppID&&this._SDKAppID<7e7||176e7<=this._SDKAppID&&this._SDKAppID<177e7}},{key:"isUSASite",value:function(){return 7e7<=this._SDKAppID&&this._SDKAppID<8e7||177e7<=this._SDKAppID&&this._SDKAppID<178e7}},{key:"isIndonesiaSite",value:function(){return 8e7<=this._SDKAppID&&this._SDKAppID<9e7||178e7<=this._SDKAppID&&this._SDKAppID<179e7}},{key:"isIntl",value:function(){return 0===(e=this._SDKAppID)||2e7<=e&&e<9e7||172e7<=e&&e<179e7;var e;}},{key:"isUnlimitedAVChatRoom",value:function(){return this._unlimitedAVChatRoom}},{key:"isUsingChatCore",value:function(){return this._isUsingChatCore}},{key:"setUsingChatCore",value:function(e){this._isUsingChatCore=e;}},{key:"getUIPlatform",value:function(){return this._uiPlatform}},{key:"setUIPlatform",value:function(e){this._uiPlatform=e;}},{key:"setUserID",value:function(e){this._userID=e;}},{key:"getUserID",value:function(){return this._userID}},{key:"setUserSig",value:function(e){this._userSig=e;}},{key:"getUserSig",value:function(){return this._userSig}},{key:"getSDKAppID",value:function(){return this._SDKAppID}},{key:"setTinyID",value:function(e){this._tinyID=e,this._isLoggedIn=!0;}},{key:"getTinyID",value:function(){return this._tinyID}},{key:"setCustomStatus",value:function(e){this._customStatus=e;}},{key:"getCustomStatus",value:function(){return this._customStatus}},{key:"getScene",value:function(){return Te?window.tencent_cloud_im_csig_flutter_for_web_25F_cy:this._isTUIKit()?"tuikit":this._scene}},{key:"getInstanceID",value:function(){return this._instanceID}},{key:"getStatusInstanceID",value:function(){return this._statusInstanceID}},{key:"setStatusInstanceID",value:function(e){this._statusInstanceID=e;}},{key:"getVersion",value:function(){return this._version}},{key:"getA2Key",value:function(){return this._a2Key}},{key:"setA2Key",value:function(e){this._a2Key=e;}},{key:"getContentType",value:function(){return this._contentType}},{key:"getProxyServer",value:function(){return this._proxyServer}},{key:"getFileUploadProxy",value:function(){return this._fileUploadProxy}},{key:"getFileDownloadProxy",value:function(){return this._fileDownloadProxy}},{key:"setApplicationID",value:function(e){this._applicationID=e;}},{key:"getApplicationID",value:function(){return this._applicationID}},{key:"setDowloadFileAuthKey",value:function(e){this._authKey=e;}},{key:"getDowloadFileAuthKey",value:function(){return this._authKey}},{key:"setCustomLoginInfo",value:function(e){this._customLoginInfo=e;}},{key:"getCustomLoginInfo",value:function(){return this._customLoginInfo}},{key:"_isTUIKit",value:function(){var e=!1,t=!1,n=!1,o=!1,i=[];ae&&(i=Object.keys(ue));for(var a=0,s=(i=ce?ie?Object.keys(uni):Object.keys(window):i).length;a<s;a++)if(i[a].toLowerCase().includes("uikit")){e=!0;break}var r,i=null,c=(ae&&!it(ue.createGamePortal)&&it(getApp)&&!A(getApp())&&(r=getApp().globalData,et(r)&&!0===r.isTUIKit&&(t=!0)),!0===this._m.get(13).getStorageSync("TIM_".concat(this._SDKAppID,"_isTUIKit"))&&(n=!0),null);if(z&&!Q&&"undefined"==typeof uni&&__wxConfig&&(c=__wxConfig.pages),Z&&"undefined"==typeof uni&&__qqConfig&&(c=__qqConfig.pages),nt(c)&&0<c.length){for(var u=0,l=c.length;u<l;u++)if(c[u].toLowerCase().includes("tui")){o=!0;break}c=null;}return e||t||n||o}},{key:"reset",value:function(){this._isLoggedIn=!1,this._userSig="",this._a2Key="",this._tinyID="",this._customStatus="",this._statusInstanceID=0;}}]),xi),wi={"k-vue2-pc":1,"k-vue2-h5":2,"k-vue2-h5-uni":3,"k-vue2-app-uni":4,"k-vue2-mp-uni":5,"k-vue2-pc-uni":6,"k-vue3-pc":7,"k-vue3-h5":8,"k-vue3-h5-uni":9,"k-vue3-app-uni":10,"k-vue3-mp-uni":11,"k-vue3-pc-uni":12,"k-rn":13},Fi=(t(qi,wn),$o=f(qi),e(qi,[{key:"onCheckTimer",value:function(e){this.isLoggedIn()&&e%this._helloInterval==0&&this._hello();}},{key:"getPushModule",value:function(){var e=void 0,t=this.get(36),n=this.get(28);return t.canIUseTIMPush()?e=t:n.canIUseOfflinePush()&&(e=n),e}},{key:"login",value:function(e){if(this.isLoggedIn())return t=this.getMyUserID(),(t=this.getErrMsg("RepeatLogin",t))&&v.w(t),Sn({actionStatus:"OK",errorCode:0,errorInfo:t,repeatLogin:!0});if(Date.now()-this._lastLoginTs<=15e3)return this.warn("LoggingIn",e.userID),C({code:T.REPEAT_LOGIN});v.l("".concat(this._n,".login userID:").concat(e.userID));var t=this._checkLoginInfo(e);if(0!==t.code)return C(t);var t=this.get(12),n=e.userID,e=e.userSig;return t.setUserID(n),t.setUserSig(e),this.get(20).updateProtocolConfig(),this._login()}},{key:"_login",value:function(){var _=this,h=this.get(12),g=h.getScene(),e=0,t=g,f=(g&&g.startsWith("k-")&&(t=wi[g],g="tuikit"),new M("login")),n=(f.setMessage("".concat(t)).setMoreMessage("identifier:".concat(this.getMyUserID())),"tuikit"===g),o=0,n=(ie?o=n?3===t||4===t||5===t||6===t?31:9===t||10===t||11===t||12===t?32:4:3:ae?o=X?36:"tuikit"===g?12:11:ce?o=Te?"flutter_web_uikit"===g?21:20:this._isReactUIKit()?Ce?25:24:n?1===t||2===t?29:7===t||8===t?30:Ce?17:14:Ce?16:13:13===t&&(o=38),f.setUIPlatform(o),h.setUIPlatform(o),this.getPushModule()),m=(n&&(this._isWebUniapp=n.getUniAppPlatform(),t=this._getStatusInstanceID(),h.setStatusInstanceID(t),this.get(20).updateProtocolConfig(),e=n.getDeviceBrand()),"".concat(this._n,"._login"));return this._lastLoginTs=Date.now(),this.req({P:I.LOGIN,data:{deviceBrand:e,isWebUniapp:this._isWebUniapp,customInfo:h.getCustomLoginInfo()}}).then(function(e){_._lastLoginTs=0;var t=Date.now(),n=null,o=e.data,i=o.a2Key,l=o.tinyID,d=o.helloInterval,a=o.instanceID,s=o.timeStamp,r=o.customStatus,r=void 0===r?"":r,p=o.purchaseBits,o=o.authKey,o=void 0===o?"":o,c=1e3*s,u=t-f.getStartTs(),u=c+parseInt(u/2)-t,t=f.getStartTs()+u;if(f.start(t),t=c,Ge=u,(c=new Date).setTime(t),v.i("baseTime from server:".concat(c," offset:").concat(Ge)),!l)throw n=new Hn({code:T.NO_TINYID}),f.setError(n).end(),n;if(!i)throw n=new Hn({code:T.NO_A2KEY}),f.setError(n).end(),n;t=_.get(21).getSocketID(),c=Qo(r),n="socketID:".concat(t," scene:").concat(g," helloInterval:").concat(d," instanceID:").concat(a," timeStamp:").concat(s)+" offset:".concat(u," customStatus:").concat(c," isWebUniapp:").concat(_._isWebUniapp),v.l("".concat(m," ok. ").concat(n)),r="",t="",z&&it(ue.getAccountInfoSync)&&((s=ue.getAccountInfoSync().miniProgram)&&(r=s.appId,t=s.envVersion)),f.setMoreMessage("".concat(n," href:").concat(ce?window.location.href:""," mpAppId:").concat(r," envVersion:").concat(t," authKey:").concat(o)).end(),h.setA2Key(i),h.setTinyID(l),h.setStatusInstanceID(a),h.setCustomStatus(c),h.setDowloadFileAuthKey(o),p&&_.get(27).onPushedConfig({errorCode:0,expiredTime:0,purchaseBits:p}),_.get(20).updateProtocolConfig(),_.emitIEvt(Yo.A2KEY_AND_TINYID_UPDATED),_._helloInterval=d,_.triggerReady(),u=_.getPushModule();return u&&(uni.setStorageSync("timUniAppInstanceID",a),u.init()),_._fetchCloudControlConfig(),_.get(29).init(),e}).catch(function(e){return f.setError(e).end(!0),_._m.setNotReadyReason(T.LOGIN_FAILED),v.e("".concat(m," failed. error:"),e),_._lastLoginTs=0,_._m.onLoginFailed(),C(e)})}},{key:"logout",value:function(){var t=this,e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:0,n="".concat(this._n,".logout"),o=this.isLoggedIn();return v.i("".concat(n," type:").concat(e," isLoggedIn:").concat(o," isWebUniapp:").concat(this._isWebUniapp)),o?(new M("logout").setMessage("identifier:".concat(this.getMyUserID())).end(!0),0===e&&this._m.setNotReadyReason(T.LOGGED_OUT),this.req({P:I.LOGOUT,data:{type:e,isWebUniapp:this._isWebUniapp}}).then(function(){return t.resetReady(),Sn({})}).catch(function(e){return v.e("".concat(n," error:"),e),t.resetReady(),Sn({})})):C({code:T.USER_NOT_LOGGED_IN})}},{key:"getLoginUser",value:function(){return this.isLoggedIn()?this.getMyUserID():""}},{key:"_fetchCloudControlConfig",value:function(){this.get(23).fetchConfig();}},{key:"_getStatusInstanceID",value:function(){return uni.getStorageSync("timUniAppInstanceID")||0}},{key:"_hello",value:function(){var t=this;this._lastWsHelloTs=Date.now(),this.req({P:I.HELLO,data:{isWebUniapp:this._isWebUniapp}}).catch(function(e){v.w("".concat(t._n,"._hello error:"),e);});}},{key:"getLastWsHelloTs",value:function(){return this._lastWsHelloTs}},{key:"_checkLoginInfo",value:function(e){var t=0;return Je(this.get(12).getSDKAppID())?t=T.NO_SDKAPPID:Je(e.userID)?t=T.NO_IDENTIFIER:Je(e.userSig)&&(t=T.NO_USERSIG),{code:t}}},{key:"_isReactUIKit",value:function(){return ce&&void 0!==window.tencent_cloud_im_csig_react_uikit_23F_xa}},{key:"onMultipleAccountKickedOut",value:function(e){var t=this;new M("kickedOut").setMessage("type:".concat(R.KICKED_OUT_MULT_ACCOUNT," newInstanceInfo:").concat(JSON.stringify(e))).end(!0),v.w("".concat(this._n,".onMultipleAccountKickedOut userID:").concat(this.getMyUserID()," newInstanceInfo:"),e),this.logout(1).then(function(){t.emitOEvt(G.KICKED_OUT,{type:R.KICKED_OUT_MULT_ACCOUNT}),t._m.setNotReadyReason(T.KICKED_OUT_MULT_ACCOUNT),t._m.reset();});}},{key:"onMultipleDeviceKickedOut",value:function(e){var t=this;new M("kickedOut").setMessage("type:".concat(R.KICKED_OUT_MULT_DEVICE," newInstanceInfo:").concat(JSON.stringify(e))).end(!0),v.w("".concat(this._n,".onMultipleDeviceKickedOut userID:").concat(this.getMyUserID()," newInstanceInfo:"),e),this.logout(1).then(function(){t.emitOEvt(G.KICKED_OUT,{type:R.KICKED_OUT_MULT_DEVICE}),t._m.setNotReadyReason(T.KICKED_OUT_MULT_DEVICE),t._m.reset();});}},{key:"onUserSigExpired",value:function(){new M("kickedOut").setMessage(R.KICKED_OUT_USERSIG_EXPIRED).end(!0),v.w("".concat(this._n,".onUserSigExpired userID:").concat(this.getMyUserID())),0!==this.get(12).getStatusInstanceID()&&(this.emitOEvt(G.KICKED_OUT,{type:R.KICKED_OUT_USERSIG_EXPIRED}),this._m.setNotReadyReason(T.KICKED_OUT_USERSIG_EXPIRED),this._m.reset());}},{key:"onRestApiKickedOut",value:function(e){new M("kickedOut").setMessage("type:".concat(R.KICKED_OUT_REST_API," newInstanceInfo:").concat(JSON.stringify(e))).end(!0),v.w("".concat(this._n,".onRestApiKickedOut userID:").concat(this.getMyUserID()," newInstanceInfo:"),e),0!==this.get(12).getStatusInstanceID()&&(this.emitOEvt(G.KICKED_OUT,{type:R.KICKED_OUT_REST_API}),this._m.setNotReadyReason(T.KICKED_OUT_REST_API),this._m.reset(),this.get(21).onRestApiKickedOut());}},{key:"reset",value:function(){v.l("".concat(this._n,".reset")),this.resetReady(),this._helloInterval=120,this._lastLoginTs=0,this._lastWsHelloTs=0,this._isWebUniapp=0;}}]),qi);function qi(e){return d(this,qi),(e=$o.call(this,e))._n="SignModule",e._helloInterval=120,e._lastLoginTs=0,e._lastWsHelloTs=0,e._isWebUniapp=0,zo.mixin(h(e)),e}function xi(e,t){d(this,xi),this._m=e,this._isLoggedIn=!1,this._SDKAppID=t.SDKAppID,this._userID=t.userID||"",this._userSig=t.userSig||"",this._version="3.5.0",this._a2Key="",this._tinyID="",this._customStatus="",this._contentType="json",this._unlimitedAVChatRoom=t.unlimitedAVChatRoom,this._scene=t.scene||"",this._oversea=t.oversea,this._instanceID=t.instanceID,this._statusInstanceID=0,this._isDevMode=t.devMode,this._isTestEnv=t.testEnv,this._proxyServer=t.proxyServer,this._fileUploadProxy=t.fileUploadProxy,this._fileDownloadProxy=t.fileDownloadProxy,this._applicationID=0,this._isPartialUpdatedConvs=t.partialUpdatedConversations,this._isIndependentDomainDisabled=t.disableIndependentDomain,this._isUsingChatCore=!1,this._uiPlatform=0,this._authKey="",this._customLoginInfo="";}function Vi(e){return d(this,Vi),(e=ei.call(this,e))._n="UserModule",e._profileHandler=new Oi(h(e)),e._blacklistHandler=new Gi(h(e)),e._userStatusHandler=new Pi(h(e)),e.getIEmitInst().on(Yo.A2KEY_AND_TINYID_UPDATED,e.onContextUpdated,h(e)),e}function Hi(e){d(this,Hi),this._userM=e,this._n="UserStatusHandler",this.MAX_QUERY_USER_COUNT=500,this.MAX_SUBSCRIBE_USER_COUNT=100,this.MAX_UNSUBSCRIBE_USER_COUNT=100,this._userM.getIEmitInst().on(Yo.CLOUD_CONFIG,this._onCloudConfig,this);}function Bi(e){d(this,Bi),this._userM=e,this._n="BlacklistHandler",this._blacklistMap=new Map,this._startIndex=0;}function Ki(e){d(this,Ki),this._userM=e,this._n="ProfileHandler",this.TAG="profile",this.accountProfileMap=new Map,this.expirationTime=864e5;}function Yi(e){return d(this,Yi),(e=ti.call(this,e))._n="TopicModule",e._topicMap=new Map,e._getTopicTimeMap=new Map,e.TOPIC_CACHE_TIME=300,e.TOPIC_LAST_ACTIVE_TIME=3600,e.getIEmitInst().on(Yo.CLOUD_CONFIG,e._onCloudConfig,h(e)),e}function Wi(e,t){d(this,Wi),this.topicID="",this.topicName="",this.avatar="",this.introduction="",this.notification="",this.unreadCount=0,this.muteAllMembers=!1,this.customData="",this.groupAtInfoList=[],this.nextMessageSeq=0,this.lastMessage=Zo(e.lastMessage,t),this.selfInfo={muteTime:0,readedSequence:0,messageRemindType:"",excludedUnreadSequenceList:void 0},this._initTopic(e);}function ji(e){return d(this,ji),(e=ni.call(this,e))._n="GroupModule",e._commonGroupHandler=new fi(h(e)),e._groupAttributesHandler=new mi(h(e)),e._groupCountersHandler=new vi(h(e)),e._AVChatRoomHandler=new yi(h(e)),e._groupTipsHandler=new gi(h(e)),e._groupSystemNoticeHandler=new Ei(h(e)),e._groupMemberHandler=new Ti(h(e)),e.groupMap=new Map,e._unjoinedAVChatRoomList=new Map,e._receiptDetailCompleteMap=new Map,e._onlineMemberCountMap=new Map,e._timeoutIDs=[],e.getIEmitInst().on(Yo.CLOUD_CONFIG,e._onCloudConfig,h(e)),e}function Ji(e){d(this,Ji),this._grpM=e,this._n="GroupSystemNoticeHandler",this.pendencyMap=new Map;}function zi(e){d(this,zi),this._grpM=e,this._n="GroupMemberHandler",this.groupMemberListMap=new Map,this.DEFAULT_MEMBER_INFO_FILTER=["Role","JoinTime","NameCard","ShutUpUntil","OnlineStatus"],this._grpM.getIEmitInst().on(Yo.PROFILE_UPDATED,this._onProfileUpdated,this);}function Xi(e){d(this,Xi),this.userID="",this.avatar="",this.nick="",this.role="",this.joinTime="",this.lastSendMsgTime="",this.nameCard="",this.muteUntil=0,this.memberCustomField=[],this.isOnline=!1,this.updateMember(e);}function Zi(e){d(this,Zi),this._grpM=e,this._n="AVChatRoomHandler",this._joinedGroupMap=new Map,this._pollingRequestInfoMap=new Map,this._pollingInstanceMap=new Map,this._seqSll=new ri(200),this._IDSll=new ri(100),this._reportMessageStackedCount=0,this._onlineMemberCountMap=new Map,this.DEFAULT_EXPIRE_TIME=60,this.DEFAULT_POLLING_INTERVAL=300,this.MAX_POLLING_INTERVAL=2e3,this._pollingInterval=this.DEFAULT_POLLING_INTERVAL,this.DEFAULT_POLLING_NO_MESSAGE_COUNT=20,this.DEFAULT_POLLING_INTERVAL_PLUS=2e3,this._pollingNoMessageCount=0,this._startBroadcastSeq=1,this._broadcastMessageIDMap=new Map,this.DEFAULT_POLLING_SIMPLIFIED_MSG=0;}function Qi(e){d(this,Qi);var t=e.manager,n=e.groupID,o=e.onInit,i=e.onSuccess,e=e.onFail;this._n="Polling",this._manager=t,this._grpM=t._grpM,this._onInit=o,this._onSuccess=i,this._onFail=e,this._groupID=n,this._timeoutID=-1,this._isRunning=!1,this._proto=I.AV_POLLING;}function $i(e){d(this,$i),this._grpM=e,this._n="GroupCountersHandler",this._groupCountersMap=new Map,this.EXPIRE_TIME=3e4,this._grpM.getIEmitInst().on(Yo.CLOUD_CONFIG,this._onCloudConfig,this);}function ea(e){d(this,ea),this._grpM=e,this._n="GroupAttributesHandler",this._groupAttributesMap=new Map,this._groupAttributesCopy={},this.CACHE_EXPIRE_TIME=3e4,this._grpM.getIEmitInst().on(Yo.CLOUD_CONFIG,this._onCloudConfig,this);}function ta(e){d(this,ta),this._grpM=e,this._n="CommonGroupHandler",this.tempConversationList=null,this._cachedGroupMessageMap=new Map,this._checkCountMap=new Map,this.MAX_CHECK_COUNT=4,this.PAGING_GRP_COUNT_LIMIT=200,this._pagingStatus=Nn,this._pagingGetCostList=[],e.getIEmitInst().on(Yo.A2KEY_AND_TINYID_UPDATED,this.syncGroupList,this);}function na(e){d(this,na),this._grpM=e,this._n="GroupTipsHandler",this._cachedGroupTipsMap=new Map,this._checkCountMap=new Map,this.MAX_CHECK_COUNT=4;}function oa(e){return d(this,oa),(e=oi.call(this,e))._n="ConvModule",zo.mixin(h(e)),e._msgListHandler=new Wo(h(e)),e._msgRemindHandler=new pi(h(e)),e._convGroupHandler=new _i(h(e)),e._sll=new ri(100),e._pagingStatus=Nn,e._pagingTs=0,e._pagingStartIdx=0,e._pagingPinnedTs=0,e._pagingPinnedStartIdx=0,e._pagingConvIDMap=new Map,e._convIDFromUnreadDBMap=new Map,e._convMap=new Map,e._tmpGroupList=[],e._tmpGroupAtTipsList=[],e._peerReadTimeMap=new Map,e._completedMap=new Map,e._roamingMsgKeyAndTimeMap=new Map,e._remoteGroupReadSeqMap=new Map,e._convTotalUnreadCount=0,e._pagingGetCostList=[],e._convMapForDiff=new Map,e._partialUpdatedConvMap=new Map,e._everClearedMap=new Map,e._bPullOnInvite=!0,e._initListeners(),e}function ia(e){d(this,ia),this._convM=e,this._n="ConvGroupHandler",this._convGroupMap=new Map,this._startIndex=0,this._pagingStatus=Nn;}function aa(e){d(this,aa),this._convM=e,this._n="MsgRemindHandler";}function sa(e,t){var n=2<arguments.length&&void 0!==arguments[2]&&arguments[2];d(this,sa),this.conversationID=e.conversationID||"",this.unreadCount=e.unreadCount||0,this.type=e.type||"",this.lastMessage=Xo(e.lastMessage,t,n),e.lastMsgTime&&(this.lastMessage.lastTime=e.lastMsgTime),this._isInfoCompleted=!1,this.peerReadTime=e.peerReadTime||0,this.groupAtInfoList=[],this.remark="",this.isPinned=e.isPinned||!1,this.messageRemindType=e.messageRemindType,this.markList=e.markList||[],this.customData=e.customData||"",this.conversationGroupList=e.conversationGroupList||[],this.draftText=e.draftText||"",this._initProfile(e),this.subType=this.groupProfile?this.groupProfile.type:"";}function ra(e){d(this,ra),this.groupID="",this.name="",this.avatar="",this.type="",this.introduction="",this.notification="",this.ownerID="",this.createTime="",this.infoSequence="",this.lastInfoTime="",this.selfInfo={messageRemindType:"",joinTime:"",nameCard:"",role:"",userID:"",memberCustomField:void 0,readedSequence:0,excludedUnreadSequenceList:void 0},this.lastMessage={lastTime:"",lastSequence:"",fromAccount:"",messageForShow:""},this.nextMessageSeq="",this.memberNum="",this.memberCount="",this.maxMemberNum="",this.maxMemberCount="",this.joinOption="",this.inviteOption="",this.groupCustomField=[],this.muteAllMembers=!1,this.isSupportTopic=!1,this._lastRevokedTime=0,this._initGroup(e);}function ca(e){d(this,ca),this.MAX_LENGTH=e,this.map=new Map;}function ua(e){var t=this;d(this,ua),Je(e)||(this.userID=e.userID||"",this.nick=e.nick||"",this.gender=e.gender||"",this.birthday=e.birthday||0,this.location=e.location||"",this.selfSignature=e.selfSignature||"",this.allowType=e.allowType||R.ALLOW_TYPE_ALLOW_ANY,this.language=e.language||0,this.avatar=e.avatar||"",this.messageSettings=e.messageSettings||0,this.adminForbidType=e.adminForbidType||R.FORBID_TYPE_NONE,this.level=e.level||0,this.role=e.role||0,this.lastUpdatedTime=0,this.profileCustomField=[],Je(e.profileCustomField)||e.profileCustomField.forEach(function(e){t.profileCustomField.push({key:e.key,value:e.value});}));}function la(){return null}function da(e){var t=e.get(12);return {SDKType:10,SDKAppID:t.getSDKAppID(),SDKVersion:t.getVersion(),tinyID:Number(t.getTinyID()),userID:t.getUserID(),platform:e.getPlatform(),instanceID:t.getInstanceID(),traceID:Pe()}}e(Ca,[{key:"_errorTolerantHandle",value:function(){ae||"undefined"!=typeof window&&this._canIUseCookies()||(this.getItem=la,this.setItem=la,this.removeItem=la,this.clear=la);}},{key:"onCheckTimer",value:function(e){e%20==0&&0!==this._storageQueue.size&&this._doFlush();}},{key:"_doFlush",value:function(){try{var e,t=N(this._storageQueue);try{for(t.s();!(e=t.n()).done;){var n=m(e.value,2),o=n[0],i=n[1];this._setStorageSync(this._getKey(o),i);}}catch(e){t.e(e);}finally{t.f();}this._storageQueue.clear();}catch(e){v.w("".concat(this._n,"._doFlush error:"),e);}}},{key:"_getPrefix",value:function(){var e=this._m.get(12);return "TIM_".concat(e.getSDKAppID(),"_").concat(e.getUserID(),"_")}},{key:"_getKey",value:function(e){return "".concat(this._getPrefix()).concat(e)}},{key:"getItem",value:function(e){var t=!(1<arguments.length&&void 0!==arguments[1])||arguments[1];try{var n=t?this._getKey(e):e;return this.getStorageSync(n)}catch(e){return v.w("".concat(this._n,".getItem error:"),e),{}}}},{key:"setItem",value:function(e,t){var n;2<arguments.length&&void 0!==arguments[2]&&arguments[2]?(n=!(3<arguments.length&&void 0!==arguments[3])||arguments[3]?this._getKey(e):e,this._setStorageSync(n,t)):this._storageQueue.set(e,t);}},{key:"clear",value:function(){try{ae?ue.clearStorageSync():this._canIUseCookies()&&localStorage.clear();}catch(e){v.w("".concat(this._n,".clear error:"),e);}}},{key:"removeItem",value:function(e){var t=!(1<arguments.length&&void 0!==arguments[1])||arguments[1];try{var n=t?this._getKey(e):e;this._removeStorageSync(n);}catch(e){v.w("".concat(this._n,".removeItem error:"),e);}}},{key:"getSize",value:function(e){var t=this,n=1<arguments.length&&void 0!==arguments[1]?arguments[1]:"b";try{var o={size:0,limitSize:5242880,unit:n};if(Object.defineProperty(o,"leftSize",{enumerable:!0,get:function(){return o.limitSize-o.size}}),ae&&(o.limitSize=1024*ue.getStorageInfoSync().limitSize),e)o.size=JSON.stringify(this.getItem(e)).length+this._getKey(e).length;else if(ae)ue.getStorageInfoSync().keys.forEach(function(e){o.size+=JSON.stringify(t.getStorageSync(e)).length+t._getKey(e).length;});else if(this._canIUseCookies())for(var i in localStorage)localStorage.hasOwnProperty(i)&&(o.size+=localStorage.getItem(i).length+i.length);return this._convertUnit(o)}catch(e){v.w("".concat(this._n," error:"),e);}}},{key:"_convertUnit",value:function(e){var t,n={},o=e.unit;for(t in n.unit=o,e)"number"==typeof e[t]&&("kb"===o.toLowerCase()?n[t]=Math.round(e[t]/1024):"mb"===o.toLowerCase()?n[t]=Math.round(e[t]/1024/1024):n[t]=e[t]);return n}},{key:"_setStorageSync",value:function(e,t){ae?ee?my.setStorageSync({key:e,data:t}):ue.setStorageSync(e,t):this._canIUseCookies()&&localStorage.setItem(e,JSON.stringify(t));}},{key:"getStorageSync",value:function(e){return ae?ee?my.getStorageSync({key:e}).data:ue.getStorageSync(e):this._canIUseCookies()?JSON.parse(localStorage.getItem(e)):{}}},{key:"_removeStorageSync",value:function(e){ae?ee?my.removeStorageSync({key:e}):ue.removeStorageSync(e):this._canIUseCookies()&&localStorage.removeItem(e);}},{key:"_canIUseCookies",value:function(){return "undefined"!=typeof window&&navigator&&navigator.cookieEnabled&&localStorage}},{key:"reset",value:function(){v.l("".concat(this._n,".reset")),this._doFlush();}}]);var pa,_a=Ca,ha=(e(ya,[{key:"pushIn",value:function(e){v.d("".concat(this._n,".pushIn"),this._report.length,e),this._report.push(e);}},{key:"backfill",value:function(e){var t;nt(e)&&0!==e.length&&(v.d("".concat(this._n,".backfill"),this._report.length,e.length),(t=this._report).unshift.apply(t,D(e)));}},{key:"getLogsNumInMemory",value:function(){return this._report.length}},{key:"isEmpty",value:function(){return 0===this._report.length}},{key:"_reset",value:function(){this._report.length=0,this._report=[];}},{key:"getLogsInMemory",value:function(){var e=this._report.slice();return this._reset(),e}}]),ya),ga=(t(Ma,wn),pa=f(Ma),e(Ma,[{key:"reportAtOnce",value:function(){this._report();}},{key:"_onLoginSuccess",value:function(){var t=this,e=this.get(13),n=e.getItem(this.TAG,!1);!Je(n)&&it(n.forEach)&&(v.l("".concat(this._n,"._onLoginSuccess. logs count:").concat(n.length)),n.forEach(function(e){t._reportBody.pushIn(e);}),e.removeItem(this.TAG,!1));}},{key:"_onCloudConfig",value:function(){var e=this.getCloudConfig("evt_rpt_threshold"),t=this.getCloudConfig("evt_rpt_waiting"),n=this.getCloudConfig("evt_rpt_level"),o=this.getCloudConfig("evt_rpt_sdkappid_bl"),i=this.getCloudConfig("evt_rpt_tinyid_wl");A(e)||(this.MIN_THRESHOLD=Number(e)),A(t)||(this.WAITING_TIME=Number(t)),A(n)||(this.REPORT_LEVEL=n.split(",").map(function(e){return Number(e)})),A(o)||(this.REPORT_SDKAPPID_BLACKLIST=o.split(",").map(function(e){return Number(e)})),A(i)||(this.REPORT_TINYID_WHITELIST=i.split(","));}},{key:"pushIn",value:function(e){e instanceof M&&(e.updateTimeStamp(),this._reportBody.pushIn(e),this._reportBody.getLogsNumInMemory()>=this.MIN_THRESHOLD&&this._report());}},{key:"onCheckTimer",value:function(){Date.now()<this._lastReportTime+this.WAITING_TIME||this._reportBody.isEmpty()||this._report();}},{key:"_filterLogs",value:function(e){var t=this,n=this.get(12),o=n.getSDKAppID(),n=n.getTinyID();return Vt(this.REPORT_SDKAPPID_BLACKLIST,o)&&!Ht(this.REPORT_TINYID_WHITELIST,n)?[]:e.filter(function(e){return t.REPORT_LEVEL.includes(e.level)})}},{key:"_report",value:function(){var t,e,n=this;this._reportBody.isEmpty()||(t=this._reportBody.getLogsInMemory(),0!==(e=this._filterLogs(t)).length?(e={header:da(this),event:e},this.req({P:I.SSO_STAT,data:y({},e)}).then(function(){n._lastReportTime=Date.now();}).catch(function(e){v.w("".concat(n._n,"._report failed. error:"),e),n._lastReportTime=Date.now(),n._reportBody.backfill(t),n._reportBody.getLogsNumInMemory()>n.MAX_THRESHOLD&&n._flushAtOnce();})):this._lastReportTime=Date.now());}},{key:"_flushAtOnce",value:function(){var e=this.get(13),t=e.getItem(this.TAG,!1),n=this._reportBody.getLogsInMemory(),o="".concat(this._n,"._flushAtOnce");Je(t)?(v.l("".concat(o," count:").concat(n.length)),e.setItem(this.TAG,n,!0,!1)):((n=n.concat(t)).length>this.MAX_THRESHOLD&&(n=n.slice(0,this.MAX_THRESHOLD)),v.l("".concat(o," count:").concat(n.length)),e.setItem(this.TAG,n,!0,!1));}},{key:"reset",value:function(){v.l("".concat(this._n,".reset")),this._lastReportTime=0,this._report(),this.REPORT_SDKAPPID_BLACKLIST=[],this.REPORT_TINYID_WHITELIST=[];}}]),Ma),fa="none",ma="online",va=(e(Ia,[{key:"_startRN",value:function(){var e,n=this;!re||(e=this._m.get(18).getPlugin("chat-network-monitor"))&&(this._removeListener=e.addEventListener(function(e){var t=e.isConnected,e=e.type;n._networkType!==e&&n._onNetworkStatusChange({isConnected:void 0!==t&&t,networkType:e});}));}},{key:"start",value:function(){var t=this,n="".concat(this._n,".start");ae?(ue.getNetworkType({success:function(e){t._networkType=e.networkType||e.subtype||"",e.networkType===fa?v.w("".concat(n," no network, please check!")):v.i("".concat(n," networkType:").concat(e.networkType));}}),this._mpNetworkStatusCallback=this._onNetworkStatusChange.bind(this),ue.onNetworkStatusChange(this._mpNetworkStatusCallback)):ce&&(this._networkType=ma,this._webOnlineCallback=this._onWebOnline.bind(this),this._webOfflineCallback=this._onWebOffline.bind(this),window.addEventListener("online",this._webOnlineCallback),window.addEventListener("offline",this._webOfflineCallback));}},{key:"_onWebOnline",value:function(){this._onNetworkStatusChange({isConnected:!0,networkType:ma});}},{key:"_onWebOffline",value:function(){this._onNetworkStatusChange({isConnected:!1,networkType:fa});}},{key:"_onNetworkStatusChange",value:function(e){var t=e.isConnected,e=e.networkType,n="".concat(this._n,"._onNetworkStatusChange"),o=!1,i="previous:".concat(this._networkType," current:").concat(e);t?(v.i("".concat(n," ").concat(i)),this._networkType!==e&&(o=!0,this._networkType=e,this._m.get(21).reConnect(!0))):this._networkType!==e&&(o=!0,this._networkType=e,v.w("".concat(n," no network, please check!")),this._m.get(21).offline()),o&&new M("networkChange").setMessage("isConnected:".concat(t," ").concat(i)).end();}},{key:"isOnline",value:function(){return this._networkType!==fa}},{key:"getNetworkType",value:function(){return this._networkType}},{key:"reset",value:function(){v.l("".concat(this._n,".reset")),ae?null!==this._mpNetworkStatusCallback&&(ue.offNetworkStatusChange&&ue.offNetworkStatusChange(this._mpNetworkStatusCallback),this._mpNetworkStatusCallback=null):ce?(null!==this._webOnlineCallback&&(window.removeEventListener("online",this._webOnlineCallback),this._webOnlineCallback=null),null!==this._onWebOffline&&(window.removeEventListener("offline",this._webOfflineCallback),this._webOfflineCallback=null)):re&&this._removeListener&&(this._removeListener(),this._removeListener=null);}}]),Ia);function Ia(e){d(this,Ia),this._m=e,this._networkType=ma,this._n="NetMonitorModule",this._mpNetworkStatusCallback=null,this._webOnlineCallback=null,this._webOfflineCallback=null,this._removeListener=null,this._m.getIEmitInst().on(Yo.A2KEY_AND_TINYID_UPDATED,this._startRN,this);}function Ma(e){d(this,Ma),(e=pa.call(this,e))._n="EventStatModule",e.TAG="im-ssolog-event",e._reportBody=new ha,e.MIN_THRESHOLD=20,e.MAX_THRESHOLD=100,e.WAITING_TIME=6e4,e.REPORT_LEVEL=[4,5,6],e.REPORT_SDKAPPID_BLACKLIST=[],e.REPORT_TINYID_WHITELIST=[],e._lastReportTime=Date.now();var t=e.getIEmitInst();return t.on(Yo.A2KEY_AND_TINYID_UPDATED,e._onLoginSuccess,h(e)),t.on(Yo.CLOUD_CONFIG,e._onCloudConfig,h(e)),e}function ya(e){d(this,ya),this._n="SSOLogBody",this._report=[];}function Ca(e){d(this,Ca),this._m=e,this._n="StorageModule",this._storageQueue=new Map,this._errorTolerantHandle();}function Ta(e,t){return e(t={exports:{}},t.exports),t.exports}var Da,Ea=Ta(function(e){var o=Object.prototype.hasOwnProperty,_="~";function n(){}function a(e,t,n){this.fn=e,this.context=t,this.once=n||!1;}function i(e,t,n,o,i){if("function"!=typeof n)throw new TypeError("The listener must be a function");n=new a(n,o||e,i),o=_?_+t:t;return e._events[o]?e._events[o].fn?e._events[o]=[e._events[o],n]:e._events[o].push(n):(e._events[o]=n,e._eventsCount++),e}function c(e,t){0==--e._eventsCount?e._events=new n:delete e._events[t];}function t(){this._events=new n,this._eventsCount=0;}Object.create&&(n.prototype=Object.create(null),(new n).__proto__||(_=!1)),t.prototype.eventNames=function(){var e,t,n=[];if(0===this._eventsCount)return n;for(t in e=this._events)o.call(e,t)&&n.push(_?t.slice(1):t);return Object.getOwnPropertySymbols?n.concat(Object.getOwnPropertySymbols(e)):n},t.prototype.listeners=function(e){var e=_?_+e:e,t=this._events[e];if(!t)return [];if(t.fn)return [t.fn];for(var n=0,o=t.length,i=new Array(o);n<o;n++)i[n]=t[n].fn;return i},t.prototype.listenerCount=function(e){e=_?_+e:e,e=this._events[e];return e?e.fn?1:e.length:0},t.prototype.emit=function(e,t,n,o,u,l){var d=_?_+e:e;if(!this._events[d])return !1;var i,a=this._events[d],s=arguments.length;if(a.fn){switch(a.once&&this.removeListener(e,a.fn,void 0,!0),s){case 1:return a.fn.call(a.context),!0;case 2:return a.fn.call(a.context,t),!0;case 3:return a.fn.call(a.context,t,n),!0;case 4:return a.fn.call(a.context,t,n,o),!0;case 5:return a.fn.call(a.context,t,n,o,u),!0;case 6:return a.fn.call(a.context,t,n,o,u,l),!0}for(c=1,i=new Array(s-1);c<s;c++)i[c-1]=arguments[c];a.fn.apply(a.context,i);}else for(var r,p=a.length,c=0;c<p;c++)switch(a[c].once&&this.removeListener(e,a[c].fn,void 0,!0),s){case 1:a[c].fn.call(a[c].context);break;case 2:a[c].fn.call(a[c].context,t);break;case 3:a[c].fn.call(a[c].context,t,n);break;case 4:a[c].fn.call(a[c].context,t,n,o);break;default:if(!i)for(r=1,i=new Array(s-1);r<s;r++)i[r-1]=arguments[r];a[c].fn.apply(a[c].context,i);}return !0},t.prototype.on=function(e,t,n){return i(this,e,t,n,!1)},t.prototype.once=function(e,t,n){return i(this,e,t,n,!0)},t.prototype.removeListener=function(e,t,n,o){e=_?_+e:e;if(!this._events[e])return this;if(!t)return c(this,e),this;var i=this._events[e];if(i.fn)i.fn!==t||o&&!i.once||n&&i.context!==n||c(this,e);else {for(var a=0,s=[],r=i.length;a<r;a++)(i[a].fn!==t||o&&!i[a].once||n&&i[a].context!==n)&&s.push(i[a]);s.length?this._events[e]=1===s.length?s[0]:s:c(this,e);}return this},t.prototype.removeAllListeners=function(e){return e?(e=_?_+e:e,this._events[e]&&c(this,e)):(this._events=new n,this._eventsCount=0),this},t.prototype.off=t.prototype.removeListener,t.prototype.addListener=t.prototype.on,t.prefixed=_,e.exports=t.EventEmitter=t;}),La=["rich.my-imcloud.com","imrich.qcloud.com"],Sa=["requestSnapshotUrl"],ka=(t(Pa,wn),Da=f(Pa),e(Pa,[{key:"_init",value:function(){this._fileDownloadProxy=this.getFileDownloadProxy(),this._authKey=this.getDowloadFileAuthKey();var e=this.get(18);this.TIMUploadPlugin=e.getPlugin("tim-upload-plugin"),this.TIMUploadPlugin?this._initUploaderMethod():(this.COSSDK=e.getPlugin(e=ae?"cos-wx-sdk":"cos-js-sdk"),this.COSSDK?(this._getAuthorizationKey(),this.warn("CosReplacement",e)):this.warn("PluginUndetected"));}},{key:"_onCloudConfig",value:function(){var t=this,e="".concat(this._n,"._onCloudConfig"),n=this.getCloudConfig("upload_size_limit"),o=this.getCloudConfig("simple_cos"),i=this.getCloudConfig("file_dn_list");if(v.l("".concat(e," uploadSizeLimit:").concat(n," simpleCos:").concat(o)),!A(n))try{var a=JSON.parse(n);this.UPLOAD_SIZE_LIMIT={A:a.a?1048576*parseInt(a.a):this.UPLOAD_SIZE_LIMIT.A,F:a.f?1048576*parseInt(a.f):this.UPLOAD_SIZE_LIMIT.F,I:a.i?1048576*parseInt(a.i):this.UPLOAD_SIZE_LIMIT.I,V:a.v?1048576*parseInt(a.v):this.UPLOAD_SIZE_LIMIT.V};}catch(e){}if(A(o)||(this.isSimpleCos="1"===o),!A(i))try{JSON.parse(i).forEach(function(e){t._fileDNList.includes(e)||t._fileDNList.push(e);});}catch(e){}}},{key:"_getAuthorizationKey",value:function(){var n=this,o="".concat(this._n,".").concat("_getAuthorizationKey"),i=new M("_getAuthorizationKey"),a=Math.ceil(Date.now()/1e3);this.req({P:I.COS_SIGN,data:{duration:this.expiredTimeLimit}}).then(function(e){var e=e.data,t=(v.l("".concat(o," ok. data:"),e),e.expiredTime-a);i.setMessage("requestId:".concat(e.requestId," requestTime:").concat(a," expiredTime:").concat(e.expiredTime," diff:").concat(t,"s")).end(),!ae&&e.region&&(n.region=e.region),n.appid=e.appid,n.bucketName=e.bucketName,n.ciUrl=e.ciUrl,n.directory=e.directory,n.downloadUrl=e.downloadUrl,n.uploadUrl=e.uploadUrl,n.cosOptions={secretId:e.secretId,secretKey:e.secretKey,sessionToken:e.sessionToken,expiredTime:e.expiredTime},v.l("".concat(o," ok. region:").concat(n.region," bucketName:").concat(n.bucketName)),n._initUploaderMethod();}).catch(function(e){i.setError(e).end(),v.w("".concat(o," failed. error:"),e);});}},{key:"_getCosPreSigUrl",value:function(t){var i=this,a="".concat(this._n,".").concat("_getCosPreSigUrl"),s=Math.ceil(Date.now()/1e3),r=new M("_getCosPreSigUrl"),e={uploadMethod:t.uploadMethod,platform:this.getPlatform(),SDKAppID:this.getSDKAppID(),userID:t.userID,conversationType:t.conversationType,uploadConfig:[{fileID:1,fileType:t.fileType,fileName:t.fileName}]},n=I.SIMPLE_COS_PRE_SIG;return this.isSimpleCos||(e={fileType:t.fileType,fileName:t.fileName,uploadMethod:t.uploadMethod,duration:t.duration},n=I.COS_PRE_SIG),this.req({P:n,data:e}).then(function(e){i.tryCount=0;var t,n,e=e.data||{},o=(v.l("".concat(a," ok. isSimpleCos:").concat(i.isSimpleCos," data:"),e),"");return o=i.isSimpleCos?(t=(n=e.preSig[0]).uploadUrl,n=n.fileKey,"uploadIP:".concat(e.uploadIP," uploadUrl:").concat(t," fileKey:").concat(n," cost:").concat(Zt(s))):"requestId:".concat(e.requestId," expiredTime:").concat(e.expiredTime," diff:").concat(e.expiredTime-s,"s"),r.setMessage(o).end(),e}).catch(function(e){return -1===e.code&&(e.code=T.COS_GET_SIG_FAIL),r.setError(e).end(),v.w("".concat(a," failed. error:"),e),i.tryCount<1?(i.tryCount++,i._getCosPreSigUrl(t)):(i.tryCount=0,C({code:T.COS_GET_SIG_FAIL}))})}},{key:"_initUploaderMethod",value:function(){var n=this;if(this.TIMUploadPlugin)return this.timUploadPlugin=new this.TIMUploadPlugin,void(this._cosUploadMethod=function(e,t){n.timUploadPlugin.uploadFile(e,t);});this.appid&&(this.cos=ae?new this.COSSDK({ForcePathStyle:!0,getAuthorization:this._getAuthorization.bind(this)}):new this.COSSDK({getAuthorization:this._getAuthorization.bind(this)}),this._cosUploadMethod=ae?function(e,t){n.cos.postObject(e,t);}:function(e,t){n.cos.uploadFiles(e,t);});}},{key:"onCheckTimer",value:function(e){this.COSSDK&&(this.TIMUploadPlugin||this.isLoggedIn()&&e%60==0&&Math.ceil(Date.now()/1e3)>=this.cosOptions.expiredTime-120&&this._getAuthorizationKey());}},{key:"getFileDNList",value:function(){return this._fileDNList}},{key:"_getAuthorization",value:function(e,t){t({TmpSecretId:this.cosOptions.secretId,TmpSecretKey:this.cosOptions.secretKey,XCosSecurityToken:this.cosOptions.sessionToken,ExpiredTime:this.cosOptions.expiredTime});}},{key:"upload",value:function(e){if(!0===e._relayFlag)return Promise.resolve();var t=this.get(26);switch(e.type){case R.MSG_IMAGE:return t.addTotalCount(Xn),this._uploadImage(e);case R.MSG_FILE:return t.addTotalCount(Xn),this._uploadFile(e);case R.MSG_AUDIO:return t.addTotalCount(Xn),this._uploadAudio(e);case R.MSG_VIDEO:return t.addTotalCount(Xn),this._uploadVideo(e);default:return Promise.resolve()}}},{key:"_uploadImage",value:function(v){var I=this,e=this.get(2),M=v.getElements()[0],t=e.getMessageOption(v.clientSequence);return this.doUploadImage({file:t.payload.file,to:t.to,message:v,onProgress:function(e){if(M.updatePercent(e),it(t.onProgress))try{t.onProgress(e);}catch(e){return C({code:T.MSG_ONPROGRESS_ERR})}}}).then(function(e){var t=e.location,l=e.fileType,d=e.fileSize,n=e.width,o=e.height,p=e.smallImageUrl,_=e.smallImageWidth,h=e.smallImageHeight,g=e.largeImageUrl,f=e.largeImageWidth,m=e.largeImageHeight,i=e.imageInfoArray,e=I.isPrivateNetWork()?t:_t(t);M.updateImageFormat(l);var a,s,r={size:d,url:e,width:n,height:o};if(i&&0<i.length)for(var c=0;c<i.length;c++){var u=i[c];1===u.type?a=u:2===u.type?s=u:r=y(y({},r),u);}else s=p&&g?(a={url:p,width:_,height:h},{url:g,width:f,height:m}):(a=wt({originUrl:e,originWidth:n,originHeight:o,min:198}),wt({originUrl:e,originWidth:n,originHeight:o,min:720}));return M.updateImageInfoArray([y({},r),y({},s),y({},a)]),v})}},{key:"_uploadFile",value:function(n){var o=this,e=this.get(2),i=n.getElements()[0],t=e.getMessageOption(n.clientSequence);return this.doUploadFile({file:t.payload.file,to:t.to,message:n,onProgress:function(e){if(i.updatePercent(e),it(t.onProgress))try{t.onProgress(e);}catch(e){return C({code:T.MSG_ONPROGRESS_ERR})}}}).then(function(e){var e=e.location,t=e;return o.isPrivateNetWork()||(t=uo(t=_t(e),o._fileDownloadProxy,o._authKey,o._fileDNList)),i.updateFileUrl(t),n})}},{key:"_uploadAudio",value:function(t){var n=this,e=this.get(2),o=t.getElements()[0],i=e.getMessageOption(t.clientSequence);return this.doUploadAudio({file:i.payload.file,to:i.to,message:t,onProgress:function(e){if(o.updatePercent(e),it(i.onProgress))try{i.onProgress(e);}catch(e){return C({code:T.MSG_ONPROGRESS_ERR})}}}).then(function(e){e=e.location,e=n.isPrivateNetWork()?e:_t(e);return o.updateAudioUrl(e),t})}},{key:"_uploadVideo",value:function(n){var o=this,e=this.get(2),i=n.getElements()[0],t=e.getMessageOption(n.clientSequence);return this.doUploadVideo({file:t.payload.file,to:t.to,message:n,onProgress:function(e){if(i.updatePercent(e),it(t.onProgress))try{t.onProgress(e);}catch(e){return C({code:T.MSG_ONPROGRESS_ERR})}}}).then(function(e){var t=e.location,e=e.snapshotInfo,t=o.isPrivateNetWork()?t:_t(t);return i.updateVideoUrl(t),Je(e)||i.updateSnapshotInfo(e),n})}},{key:"_checkSizeError",value:function(e){var t="";return "A"===e?t="audio":"I"===e?t="image":"V"===e?t="video":"F"===e&&(t="file"),C({code:T["MSG_".concat(e,"_SIZE_LIMIT")],message:this.getErrMsg("UploadSizeLimit",t,"".concat(this.UPLOAD_SIZE_LIMIT[e]/1048576,"MB"))})}},{key:"doUploadImage",value:function(o){var i=this;if(!o.file||this._isEmptyFileList(o.file.files))return C({code:T.MSG_I_SELECT_F_FIRST});var e=this._checkImageType(o.file);if(!0!==e)return e;e=this._checkImageSize(o.file);if(!0!==e)return e;var a=null;return this._setUploadFileType(1),this.uploadByCOS(o).then(function(e){if(a=e,i.isPrivateNetWork())return Gt(n);if(nt(a.imageInfoArray)){var t=a.imageInfoArray.find(function(e){return 3===e.type});if(t)return t}if(re)return {width:o.file.width,height:o.file.height};var n=_t(e.location);return i.COSSDK?Gt(n):Gt(n=uo(n,i._fileDownloadProxy,i._authKey,i._fileDNList))}).then(function(e){return a.width=e.width,a.height=e.height,Promise.resolve(a)})}},{key:"_checkImageType",value:function(e){var t="",t=ae?e.url.slice(e.url.lastIndexOf(".")+1):re?e.type.split("/")[1]:e.files[0].name.slice(e.files[0].name.lastIndexOf(".")+1);return 0<=ii.indexOf(t.toLowerCase())||C({code:T.MSG_I_TYPES_LIMIT})}},{key:"_checkImageSize",value:function(e){return 0===(e=(ae||re?e:e.files[0]).size)?C({code:T.MSG_F_IS_EMPTY}):e<this.UPLOAD_SIZE_LIMIT.I||this._checkSizeError("I")}},{key:"doUploadFile",value:function(e){return !e.file||this._isEmptyFileList(e.file.files)?C({code:T.MSG_F_SELECT_F_FIRST}):e.file.files[0].size>this.UPLOAD_SIZE_LIMIT.F?this._checkSizeError("F"):0===e.file.files[0].size?C({code:T.MSG_F_IS_EMPTY}):(this._setUploadFileType(255),this.uploadByCOS(e))}},{key:"doUploadVideo",value:function(e){return e.file.videoFile.size>this.UPLOAD_SIZE_LIMIT.V?this._checkSizeError("V"):0===e.file.videoFile.size?C({code:T.MSG_F_IS_EMPTY}):-1===ai.indexOf(e.file.videoFile.type)?C({code:T.MSG_V_TYPES_LIMIT}):(this._setUploadFileType(2),ae||re?this.handleVideoUpload(y(y({},e),{},{file:e.file.videoFile})):ce?this.handleVideoUpload(e):void 0)}},{key:"handleVideoUpload",value:function(n){var o=this;return new Promise(function(t,e){o.uploadByCOS(n).then(function(e){t(e);}).catch(function(){o.uploadByCOS(n).then(function(e){t(e);}).catch(function(){e(new Hn({code:T.MSG_V_UPLOAD_FAIL}));});});})}},{key:"doUploadAudio",value:function(e){return e.file?e.file.size>this.UPLOAD_SIZE_LIMIT.A?this._checkSizeError("A"):0===e.file.size?C({code:T.MSG_F_IS_EMPTY}):(this._setUploadFileType(3),this.uploadByCOS(e)):C({code:T.MSG_A_UPLOAD_FAIL})}},{key:"uploadByCOS",value:function(t){var c=this;if(!it(this._cosUploadMethod))return this.warn("PluginUndetected"),C({code:T.COS_UNDETECTED});if(this.timUploadPlugin)return this._uploadWithPreSigUrl(t);var u=new M("upload"),l="".concat(this._n,".uploadByCOS"),d=Date.now(),p=this._getFile(t);return new Promise(function(a,s){var e=ae?c._createCosOptionsWXMiniApp(t):c._createCosOptionsWeb(t),r=c;c._cosUploadMethod(e,function(e,t){var n=Object.create(null);if(t){if(e||nt(t.files)&&t.files[0].error)return o=new Hn({code:T.MSG_F_UPLOAD_FAIL}),u.setError(o).end(),v.l("".concat(l," failed. error:"),t.files[0].error),403===t.files[0].error.statusCode&&c._getAuthorizationKey(),void s(o);n.fileName=p.name,n.fileSize=p.size,n.fileType=p.type.slice(p.type.indexOf("/")+1).toLowerCase(),n.location=(ae?t:t.files[0].data).Location;var o=Date.now()-d,t=r._formatFileSize(p.size),i=r._formatSpeed(1e3*p.size/o),t="size:".concat(t," time:").concat(o,"ms speed:").concat(i),i=(v.l("".concat(l," success. name:").concat(p.name," ").concat(t)),a(n),c.get(26));return i.addCost(Xn,o),i.addFileSize(Xn,p.size),void u.setMessage(t).end()}n=new Hn({code:T.MSG_F_UPLOAD_FAIL});u.setError(n).end(),v.w("".concat(l," failed. error:"),e),403===e.statusCode&&c._getAuthorizationKey(),s(n);});})}},{key:"_uploadWithPreSigUrl",value:function(e){var p=this,_="".concat(this._n,"._uploadWithPreSigUrl"),h=this._getFile(e);return this._createCosOptionsPreSigUrl(e).then(function(d){return new Promise(function(a,s){var r=new M("upload"),e=d.requestSnapshotUrl,c=void 0===e?void 0:e,u=g(d,Sa),l=Date.now();p._cosUploadMethod(u,function(e,t){var n,o,i;return e||403===t.statusCode?(r.setError(new Hn(e)).end(),o={HttpStatusCode:9999,CostTime:Zt(l,!1),error:e,url:d.url},t.data&&t.data.uploadIP&&(o.uploadIP=t.data.uploadIP),p._uploadSSOLog(o),v.l("".concat(_," failed, error:"),e),void s(new Hn({code:T.MSG_F_UPLOAD_FAIL}))):(n=Object.create(null),o=t.data.location||"",p.isPrivateNetWork()||0!==o.indexOf("https://")&&0!==o.indexOf("http://")||(o=o.split("//")[1]),n.fileName=h.name,n.fileSize=h.size,n.fileType=h.type.slice(h.type.indexOf("/")+1).toLowerCase(),n.location=o,e=Zt(l,!1),o=p._formatFileSize(h.size),i=p._formatSpeed(1e3*h.size/e),o="size:".concat(o," time:").concat(e,"ms speed:").concat(i," res:").concat(JSON.stringify(t.data)),v.l("".concat(_," ok. name:").concat(h.name," ").concat(o)),r.setMessage(o).end(),i={HttpStatusCode:t.statusCode,FileSize:h.size,CostTime:e,url:d.url},t.data&&t.data.uploadIP&&(i.uploadIP=t.data.uploadIP),p._uploadSSOLog(i),(o=p.get(26)).addCost(Xn,e),o.addFileSize(Xn,h.size),i=[],u.thumbUrl&&u.largeUrl&&i.push.apply(i,[p._getSmallImageInfoByUrl(u.thumbUrl,n),p._getLargeImageInfoByUrl(u.largeUrl,n)]),1===p.uploadFileType&&p.isSimpleCos&&!p.isPrivateNetWork()&&(i.push(p._getImageInfoArray(u.downloadUrl,n)),t.data.uploadIP&&i.push(p._getDownloadIP(u.downloadUrl.split("//")[1].split("/")[0],n))),c&&i.push(p._getSnapshotInfoByUrl(c,n)),0<i.length?Promise.all(i).then(function(){a(n);}):void a(n))});})})}},{key:"_getDownloadIP",value:function(e,n){var o="".concat(this._n,"._getDownloadIP"),i=Date.now();return this.req({P:I.GET_IP,data:{domainName:e}}).then(function(e){var t;e.data&&e.data.ip&&(v.l("".concat(o," ok. downloadIP:").concat(e.data.ip," cost:").concat(Zt(i))),(t=n.location.split("/"))[0]=e.data.ip,n.location=t.join("/"));}).catch(function(e){})}},{key:"_getImageInfoArray",value:function(t,n){var o=this,i="".concat(this._n,"._getImageInfoArray"),a=Date.now();return this.req({P:I.GET_IMAGE_INFO,data:{imageUrl:t}}).then(function(e){e=e.data||{};return v.l("".concat(i," ok. data: ").concat(JSON.stringify(e)," cost:").concat(Zt(a))),n.imageInfoArray=e.imageInfoArray,e}).catch(function(e){n.imageInfoArray=void 0,o._uploadSSOLog({HttpStatusCode:1e4,CostTime:Zt(a,!1),url:t});})}},{key:"_uploadSSOLog",value:function(e){var t,n;this.isSimpleCos&&((t=new M).setEventType(18),e.error&&t.setError(new Hn(e.error)),n="HttpStatusCode:".concat(e.HttpStatusCode,"|CosRequestId:").concat(e.CosRequestId||"","|")+"FileAlreadyExist:".concat(e.FileAlreadyExist||0,"|FileSize:").concat(e.FileSize||0,"|CostTime:").concat(e.CostTime),e.uploadIP&&(n+="|FinalIP:".concat(e.uploadIP)),t.setMessage("OK").setMoreMessage(e.url).setExtension(n).end());}},{key:"_getRawOrUploadProxyUrl",value:function(e){var t=this.get(12).getFileUploadProxy(),n=e;return n=t?e.replace(/^https:\/\/[^/]+/,t):n}},{key:"_getFile",value:function(e){return nt(e.file.files)||at(e.file.files)?e.file.files[0]:e.file}},{key:"_formatFileSize",value:function(e){return e<1024?e+"B":e<1048576?Math.floor(e/1024)+"KB":Math.floor(e/1048576)+"MB"}},{key:"_formatSpeed",value:function(e){return e<=1048576?xt(e/1024,1)+"KB/s":xt(e/1048576,1)+"MB/s"}},{key:"_createCosOptionsWeb",value:function(t){var e=this._getFile(t),n=e.name,n=n.slice(n.lastIndexOf(".")),n=this._genFileName("".concat(lt(999999)).concat(n));return {files:[{Bucket:"".concat(this.bucketName,"-").concat(this.appid),Region:this.region,Key:"".concat(this.directory,"/").concat(n),Body:e}],SliceSize:1048576,onProgress:function(e){if("function"==typeof t.onProgress)try{t.onProgress(e.percent);}catch(e){v.w("onProgress callback error:",e);}},onFileFinish:function(e,t,n){}}}},{key:"_createCosOptionsWXMiniApp",value:function(t){var e=this._getFile(t),n=this._genFileName(e.name),e=e.url;return {Bucket:"".concat(this.bucketName,"-").concat(this.appid),Region:this.region,Key:"".concat(this.directory,"/").concat(n),FilePath:e,onProgress:function(e){if(v.l(JSON.stringify(e)),"function"==typeof t.onProgress)try{t.onProgress(e.percent);}catch(e){v.w("onProgress callback error:",e);}}}}},{key:"_createCosOptionsPreSigUrl",value:function(r){var e,c=this,u="",l="",t=0,n=this._getFile(r),t=ae||re?(u=r.message.type===R.MSG_FILE?(e=(e=n.name).slice(e.lastIndexOf(".")),this._genFileName("".concat(lt(999999)).concat(e))):this._genFileName(n.name),l=n.url,1):(e=(e=n.name).slice(e.lastIndexOf(".")),u=this._genFileName("".concat(lt(999999)).concat(e)),l=n,0);return this._getCosPreSigUrl({fileType:this.uploadFileType,fileName:u,uploadMethod:t,duration:this.duration,userID:r.message.from,conversationType:Rt(r.message.conversationID)?1:2}).then(function(e){var t=c.isSimpleCos?e.preSig[0]:e,n=t.uploadUrl,o=t.downloadUrl,i=t.requestSnapshotUrl,i=void 0===i?void 0:i,a=t.thumbUrl,s=t.largeUrl,t=t.fileKey,e=e.uploadIP,e=void 0===e?"":e;return {url:c._getRawOrUploadProxyUrl(n),fileType:c.uploadFileType,fileName:u,resources:l,downloadUrl:o,requestSnapshotUrl:i,thumbUrl:a,largeUrl:s,fileKey:t,uploadIP:!c.isPrivateNetWork()&&e,onProgress:function(e){if("function"==typeof r.onProgress)try{r.onProgress(e.percent);}catch(e){v.w("onProgress callback error:",e),v.e(e);}}}})}},{key:"_genFileName",value:function(e){return "".concat(Pt(),"-").concat(e)}},{key:"_setUploadFileType",value:function(e){this.uploadFileType=e;}},{key:"_getSnapshotInfoByUrl",value:function(e,n){var o=this,i="_getSnapshotInfoByUrl",a=new M(i);return this.req({P:I.VIDEO_COVER,data:{platform:this.getPlatform(),coverName:this._genFileName(lt(99999)),requestSnapshotUrl:e}}).then(function(e){e=(e.data||{}).snapshotUrl;if(v.l("".concat(o._n,".").concat(i," ok. snapshotUrl:").concat(e)),a.setMessage("snapshotUrl:".concat(e)).end(),Je(e))return {};var t=uo(e,o._fileDownloadProxy,o._authKey,o._fileDNList);return Gt(t).then(function(e){n.snapshotInfo={snapshotUrl:t,snapshotWidth:e.width,snapshotHeight:e.height};})}).catch(function(e){return v.w("".concat(o._n,".").concat(i," failed. error:"),e),a.setCode(e.errorCode).setMessage(e.errorInfo).end(),{}})}},{key:"_getSmallImageInfoByUrl",value:function(t,n){return Gt(uo(t,this._fileDownloadProxy,this._authKey,this._fileDNList)).then(function(e){n.smallImageUrl=t,n.smallImageWidth=e.width,n.smallImageHeight=e.height;})}},{key:"_getLargeImageInfoByUrl",value:function(t,n){return Gt(uo(t,this._fileDownloadProxy,this._authKey,this._fileDNList)).then(function(e){n.largeImageUrl=t,n.largeImageWidth=e.width,n.largeImageHeight=e.height;})}},{key:"_isEmptyFileList",value:function(e){return !(!at(e)||0!==e.length)}},{key:"reset",value:function(){v.l("".concat(this._n,".reset"));}}]),Pa),Ra=["downloadKey","pbDownloadKey","messageList"],Aa=(e(Ga,[{key:"uploadMergerMessage",value:function(e,n){var o="".concat(this._n,".").concat("uploadMergerMessage"),e=(v.d("".concat(o," message:"),e,"messageBytes:".concat(n)),JSON.parse(JSON.stringify(e.payload)).messageList),i=e.length,t=this._msgM.get(17).getFileDNList(),a=new M("uploadMergerMessage");return e.forEach(function(e){lo(e.messageBody[0].type,e.messageBody,t);}),this._msgM.req({P:I.UPLOAD_MERGER_MSG,data:{messageList:e}}).then(function(e){v.d("".concat(o," ok. response:"),e.data);var e=e.data,t=e.pbDownloadKey,e=e.downloadKey,t={pbDownloadKey:t,downloadKey:e,messageNumber:i};return a.setMessage("".concat(i,"-").concat(n,"-").concat(e)).end(),t}).catch(function(e){throw v.w("".concat(o," failed. error:"),e),a.setError(e).end(),e})}},{key:"downloadMergerMessage",value:function(i){var a=this,s="".concat(this._n,".").concat("downloadMergerMessage"),t=(v.d("".concat(s," message:"),i),i.payload.downloadKey),r=this._msgM.getFileDownloadProxy(),c=this._msgM.getDowloadFileAuthKey(),u=new M("downloadMergerMessage");return u.setMessage("downloadKey:".concat(t)),this._msgM.req({P:I.DOWNLOAD_MERGER_MSG,data:{downloadKey:t}}).then(function(e){v.d("".concat(s," ok. response:"),e.data);var t,n,o=a._msgM.get(17).getFileDNList();return it(i.clearElement)?((t=i.payload).downloadKey,t.pbDownloadKey,t.messageList,t=g(t,Ra),i.clearElement(),i.setElement({type:i.type,content:y({messageList:e.data.messageList},t)},r,c,o)):(n=[],e.data.messageList.forEach(function(e){Je(e)||(e=new Eo(e,r,c,o),n.push(e));}),i.payload.messageList=n,i.payload.downloadKey="",i.payload.pbDownloadKey=""),u.end(),i}).catch(function(e){throw v.w("".concat(s," failed. key:").concat(t," error:"),e),u.setError(e).end(),e})}},{key:"createMergerMessagePack",value:function(e,t,n){return e.conversationType===R.CONV_C2C?this._createC2CMergerMessagePack(e,t,n):this._createGroupMergerMessagePack(e,t,n)}},{key:"_createC2CMergerMessagePack",value:function(e,t,n){var o=null,i=(t&&(t.offlinePushInfo&&(o=t.offlinePushInfo),!0===t.onlineUserOnly&&(o?o.disablePush=!0:o={disablePush:!0})),[]),a=(et(t)&&et(t.messageControlInfo)&&(a=(r=t.messageControlInfo).excludedFromUnreadCount,s=r.excludedFromLastMessage,r=r.excludedFromContentModeration,!0===a&&i.push("NoUnread"),!0===s&&i.push("NoLastMsg"),!0===r&&i.push("NoMsgCheck")),""),s=(ft(e.cloudCustomData)&&0<e.cloudCustomData.length&&(a=e.cloudCustomData),n.pbDownloadKey),r=n.downloadKey,n=n.messageNumber,c=e.payload,l=c.title,d=c.abstractList,c=c.compatibleText,u=this._msgM.get(6),u=u&&u.isOnlineMessage(e,t)?0:void 0;return {P:I.SEND_C2C_MSG,data:{fromAccount:this._msgM.getMyUserID(),toAccount:e.to,msgBody:[{msgType:e.type,msgContent:{pbDownloadKey:s,downloadKey:r,title:l,abstractList:d,compatibleText:c,messageNumber:n}}],cloudCustomData:a,clientTime:e.clientTime,msgSeq:e.sequence,msgRandom:e.random,msgLifeTime:u,offlinePushInfo:Ho(o),messageControlInfo:0!==u?i:void 0,isSupportExtension:!0===e.isSupportExtension?1:0,isRelayMessage:!0===e._relayFlag?1:0}}}},{key:"_createGroupMergerMessagePack",value:function(e,t,n){var o=null,i=(t&&t.offlinePushInfo&&(o=t.offlinePushInfo),[]),a=(et(t)&&et(t.messageControlInfo)&&(a=(r=t.messageControlInfo).excludedFromUnreadCount,s=r.excludedFromLastMessage,r=r.excludedFromContentModeration,!0===a&&i.push("NoUnread"),!0===s&&i.push("NoLastMsg"),!0===r&&i.push("NoMsgCheck")),""),s=(ft(e.cloudCustomData)&&0<e.cloudCustomData.length&&(a=e.cloudCustomData),n.pbDownloadKey),r=n.downloadKey,n=n.messageNumber,c=e.payload,l=c.title,d=c.abstractList,c=c.compatibleText,u=this._msgM.get(7),t=u&&u.isOnlineMessage(e,t)?1:0;return {P:I.SEND_GRP_MSG,data:{fromAccount:this._msgM.getMyUserID(),groupID:e.to,msgBody:[{msgType:e.type,msgContent:{pbDownloadKey:s,downloadKey:r,title:l,abstractList:d,compatibleText:c,messageNumber:n}}],random:e.random,priority:e.priority,clientSequence:e.clientSequence,groupAtInfo:void 0,cloudCustomData:a,onlineOnlyFlag:t,offlinePushInfo:Ho(o),clientTime:e.clientTime,needReadReceipt:!0!==e.needReadReceipt||u.isMessageFromOrToAVChatroom(e.to)?0:1,messageControlInfo:0==t?i:void 0,isSupportExtension:!0===e.isSupportExtension?1:0,isRelayMessage:!0===e._relayFlag?1:0}}}}]),Ga),Oa={ERR_SVR_COMM_SENSITIVE_TEXT:80001,ERR_SVR_COMM_BODY_SIZE_LIMIT:80002,OPEN_SERVICE_OVERLOAD_ERROR:60022,ERR_SVR_MSG_PKG_PARSE_FAILED:20001,ERR_SVR_MSG_INTERNAL_AUTH_FAILED:20002,ERR_SVR_MSG_INVALID_ID:20003,ERR_SVR_MSG_PUSH_DENY:20006,ERR_SVR_MSG_IN_PEER_BLACKLIST:20007,ERR_SVR_MSG_BOTH_NOT_FRIEND:20009,ERR_SVR_MSG_NOT_PEER_FRIEND:20010,ERR_SVR_MSG_NOT_SELF_FRIEND:20011,ERR_SVR_MSG_SHUTUP_DENY:20012,ERR_SVR_GROUP_INVALID_PARAMETERS:10004,ERR_SVR_GROUP_PERMISSION_DENY:10007,ERR_SVR_GROUP_NOT_FOUND:10010,ERR_SVR_GROUP_INVALID_GROUPID:10015,ERR_SVR_GROUP_REJECT_FROM_THIRDPARTY:10016,ERR_SVR_GROUP_SHUTUP_DENY:10017,MSG_SEND_FAIL:2100,OVER_FREQUENCY_LIMIT:2996},Na=[T.MSG_ONPROGRESS_ERR,T.MSG_I_SELECT_F_FIRST,T.MSG_I_TYPES_LIMIT,T.MSG_F_IS_EMPTY,T.MSG_I_SIZE_LIMIT,T.MSG_F_SELECT_F_FIRST,T.MSG_F_SIZE_LIMIT,T.MSG_V_SIZE_LIMIT,T.MSG_V_TYPES_LIMIT,T.MSG_A_UPLOAD_FAIL,T.MSG_A_SIZE_LIMIT,T.COS_UNDETECTED];function Ga(e){d(this,Ga),this._n="MergerMessageHandler",this._msgM=e;}function Pa(e){d(this,Pa),(e=Da.call(this,e))._n="UploadModule",e.TIMUploadPlugin=null,e.timUploadPlugin=null,e.COSSDK=null,e._cosUploadMethod=null,e.expiredTimeLimit=600,e.appid=0,e.bucketName="",e.ciUrl="",e.directory="",e.downloadUrl="",e.uploadUrl="",e.region="ap-shanghai",e.cos=null,e.cosOptions={secretId:"",secretKey:"",sessionToken:"",expiredTime:0},e.uploadFileType="",e.duration=900,e.tryCount=0,e.UPLOAD_SIZE_LIMIT={A:20971520,F:104857600,I:20971520,V:104857600},e.isSimpleCos=!1,e._fileDownloadProxy="",e._authKey="",e._fileDNList=La;var t=e.getIEmitInst();return t.on(Yo.A2KEY_AND_TINYID_UPDATED,e._init,h(e)),t.on(Yo.CLOUD_CONFIG,e._onCloudConfig,h(e)),e}function Ua(e){var t=!1;return Object.values(Oa).includes(e)&&(t=!0),t=120001<=e&&e<=13e4||10100<=e&&e<=10200?!0:t}t(es,wn),Va=f(es),e(es,[{key:"createTextMessage",value:function(e){var t=this.getMyUserID(),n=(e.currentUser=t,e.senderTinyID=this.getMyTinyID(),new ko(e)),e=ft(e.payload)?e.payload:e.payload.text,e=new io({text:e}),t=this._getNickAndAvatarByUserID(t);return n.setElement(e),n.setNickAndAvatar(t),n.setNameCard(this._getNameCardByGroupID(n)),n}},{key:"createImageMessage",value:function(e){var t=this.getMyUserID(),n=(e.currentUser=t,e.senderTinyID=this.getMyTinyID(),new ko(e));if(ae){var o=e.payload.file;if(Ze(o))return void this.warn("FileUnsupportedInMP","createImageMessage");var i=o.tempFiles[0].path||o.tempFiles[0].tempFilePath,o={url:i,name:i.slice(i.lastIndexOf("/")+1),size:o.tempFiles&&o.tempFiles[0].size||1,type:i.slice(i.lastIndexOf(".")+1).toLowerCase()};e.payload.file=o;}else re?(o={url:(i=e.payload.file).uri,name:i.fileName,size:i.fileSize||1,type:i.type,width:i.width,height:i.height},e.payload.file=o):ce&&(Ze(e.payload.file)?(i=e.payload.file,e.payload.file={files:[i]}):et(e.payload.file)&&"undefined"!=typeof uni&&(o=e.payload.file.tempFiles[0],e.payload.file={files:[o]}));i=new ho({imageFormat:Fe.UNKNOWN,uuid:this._generateUUID(e.payload.file),file:e.payload.file}),o=this._getNickAndAvatarByUserID(t);return n.setElement(i),n.setNickAndAvatar(o),n.setNameCard(this._getNameCardByGroupID(n)),this._messageOptionsMap.set(n.clientSequence,e),n}},{key:"createAudioMessage",value:function(e){var t=e.payload.file,n=(ae&&(n={url:t.tempFilePath,name:t.tempFilePath.slice(t.tempFilePath.lastIndexOf("/")+1),size:t.fileSize,second:parseInt(t.duration)/1e3,type:t.tempFilePath.slice(t.tempFilePath.lastIndexOf(".")+1).toLowerCase()},e.payload.file=n),re&&(n={url:t.uri,name:t.uri.slice(t.uri.lastIndexOf("/")+1),size:t.fileSize||1,second:Math.floor(t.duration/1e3),type:t.uri.slice(t.uri.lastIndexOf(".")+1).toLowerCase()},e.payload.file=n),this.getMyUserID()),o=(e.currentUser=n,e.senderTinyID=this.getMyTinyID(),new ko(e)),t=new fo({second:Math.floor(t.duration/1e3),size:t.fileSize||t.size||1,url:t.tempFilePath,uuid:this._generateUUID(e.payload.file)}),n=this._getNickAndAvatarByUserID(n);return o.setElement(t),o.setNickAndAvatar(n),o.setNameCard(this._getNameCardByGroupID(o)),this._messageOptionsMap.set(o.clientSequence,e),o}},{key:"createVideoMessage",value:function(e){var t=this.getMyUserID(),n=(e.currentUser=t,e.senderTinyID=this.getMyTinyID(),e.payload.file.thumbUrl="",e.payload.file.thumbSize=0,{});if(ae){if(ee)return void this.warn("VideoUnsupportedInAlipay");if(Ze(e.payload.file))return void this.warn("FileUnsupportedInMP","createVideoMessage");var o=e.payload.file;nt(o.tempFiles)&&(o=o.tempFiles[0]),n.url=o.tempFilePath,n.name=o.tempFilePath.slice(o.tempFilePath.lastIndexOf("/")+1),n.size=o.size||1,n.second=o.duration||0,n.type=o.tempFilePath.slice(o.tempFilePath.lastIndexOf(".")+1).toLowerCase();}else re?(o=e.payload.file,n.url=o.uri,n.name=o.fileName,n.size=o.fileSize||1,n.second=o.duration||0,n.type=o.type.split("/")[1]):ce&&(Ze(e.payload.file)?(o=e.payload.file,e.payload.file.files=[o]):et(e.payload.file)&&"undefined"!=typeof uni&&(o=e.payload.file.tempFile,e.payload.file.files=[o]),o=e.payload.file,n.url=window.URL.createObjectURL(o.files[0]),n.name=o.files[0].name,n.size=o.files[0].size||1,n.second=o.files[0].duration||0,n.type=o.files[0].type.split("/")[1]);e.payload.file.videoFile=n;o=new ko(e),n=new To({videoFormat:n.type,videoSecond:xt(n.second,0),videoSize:n.size,remoteVideoUrl:"",videoUrl:n.url,videoUUID:this._generateUUID(e.payload.file.videoFile),thumbUUID:this._generateUUID(e.payload.file.videoFile),thumbWidth:e.payload.file.width||200,thumbHeight:e.payload.file.height||200,thumbUrl:e.payload.file.thumbUrl,thumbSize:e.payload.file.thumbSize,thumbFormat:e.payload.file.thumbUrl.slice(e.payload.file.thumbUrl.lastIndexOf(".")+1).toLowerCase()}),t=this._getNickAndAvatarByUserID(t);return o.setElement(n),o.setNickAndAvatar(t),o.setNameCard(this._getNameCardByGroupID(o)),this._messageOptionsMap.set(o.clientSequence,e),o}},{key:"createCustomMessage",value:function(e){var t=this.getMyUserID(),n=(e.currentUser=t,e.senderTinyID=this.getMyTinyID(),new ko(e)),e=new Co({data:e.payload.data,description:e.payload.description,extension:e.payload.extension}),t=this._getNickAndAvatarByUserID(t);return n.setElement(e),n.setNickAndAvatar(t),n.setNameCard(this._getNameCardByGroupID(n)),n}},{key:"createFaceMessage",value:function(e){var t=this.getMyUserID(),n=(e.currentUser=t,e.senderTinyID=this.getMyTinyID(),new ko(e)),e=new go(e.payload),t=this._getNickAndAvatarByUserID(t);return n.setElement(e),n.setNickAndAvatar(t),n.setNameCard(this._getNameCardByGroupID(n)),n}},{key:"createMergerMessage",value:function(e){var t=this.getMyUserID(),t=(e.currentUser=t,e.senderTinyID=this.getMyTinyID(),this._getNickAndAvatarByUserID(t)),n=new ko(e),e=new Lo(e.payload);return n.setElement(e),n.setNickAndAvatar(t),n.setNameCard(this._getNameCardByGroupID(n)),n.setRelayFlag(!0),n}},{key:"createForwardMessage",value:function(e){var t=e.to,n=e.conversationType,o=e.priority,i=e.payload,a=e.needReadReceipt,s=e.receiverList;if(!nt(i._elements))return C({code:T.MSG_FORWARD_INVALID_ELEMENTS});var r=this.getMyUserID(),c=this._getNickAndAvatarByUserID(r);if(i.type===R.MSG_GRP_TIP)return C({code:T.MSG_FORWARD_TYPE_INVALID});n={to:t,conversationType:n,conversationID:"".concat(n).concat(t),priority:o,isPlaceMessage:0,status:Rn,currentUser:r,senderTinyID:this.getMyTinyID(),cloudCustomData:e.cloudCustomData||i.cloudCustomData||"",needReadReceipt:a,receiverList:s,isSupportExtension:e.isSupportExtension||!1},t=new ko(n);return t.setElement(i._elements[0]),t.setNickAndAvatar(c),t.setNameCard(this._getNameCardByGroupID(i)),t.setRelayFlag(!0),t}},{key:"downloadMergerMessage",value:function(e){return this._mergerMessageHandler.downloadMergerMessage(e)}},{key:"createFileMessage",value:function(e){if(ae){if(!z&&!Z&&!ne)return;var t=ue.getSystemInfoSync().SDKVersion;if(z&&bt(t,"2.5.0")<0)return void this.warn("WXChooseMessageFile");if(Z&&bt(t,"1.18.0")<0)return void this.warn("QQChooseMessageFile")}ce||ne?Ze(e.payload.file)?(t=e.payload.file,e.payload.file={files:[t]}):et(e.payload.file)&&"undefined"!=typeof uni&&(o=(t=e.payload.file).tempFiles,t=t.files,n=null,nt(o)?n=o[0]:nt(t)&&(n=t[0]),e.payload.file={files:[n]}):z||Z?(t=y(y({},(o=e.payload.file.tempFiles)[0]),{},{url:o[0].path}),e.payload.file={files:[t]}):re&&(o=y(y({},n=e.payload.file),{},{url:n.uri}),e.payload.file={files:[o]});var t=this.getMyUserID(),n=(e.currentUser=t,e.senderTinyID=this.getMyTinyID(),new ko(e)),o=new yo({uuid:this._generateUUID(e.payload.file),file:e.payload.file}),t=this._getNickAndAvatarByUserID(t);return n.setElement(o),n.setNickAndAvatar(t),n.setNameCard(this._getNameCardByGroupID(n)),this._messageOptionsMap.set(n.clientSequence,e),n}},{key:"createLocationMessage",value:function(e){var t=this.getMyUserID(),n=(e.currentUser=t,e.senderTinyID=this.getMyTinyID(),new ko(e)),e=new Do(e.payload),t=this._getNickAndAvatarByUserID(t);return n.setElement(e),n.setNickAndAvatar(t),n.setNameCard(this._getNameCardByGroupID(n)),n}},{key:"_onNoModule",value:function(){return C({code:T.NO_MODULE})}},{key:"sendMessageInstance",value:function(a,s){var r=this;if(!1===this.get(29).filterMessage(a,s))return a.hasRiskContent=!0,this._onSendMessageFailed(a,new Hn({code:T.PROFANITY_FOUND}));var t=null;if(a.conversationType===R.CONV_C2C)t=this.get(6);else {if(a.conversationType!==R.CONV_GROUP)return C({code:T.MSG_INVALID_CONV_TYPE});t=this.get(7);}if(!t)return this._onNoModule();var c,u="".concat(this._n,".sendMessageInstance"),l=this.get(11),d=t.isOnlineMessage(a,s);return this.get(17).upload(a).then(function(){return r._getSendMessageSpecifiedKey(a)===zn&&r.get(26).addSuccessCount(Xn),r._guardForGroup(a).then(function(){if(!a.isSendable())return C({code:T.MSG_F_URL_IS_EMPTY});r._addSendMessageTotalCount(a),c=Date.now();var e=function(e){var t="utf-8";ce&&document&&(t=document.charset.toLowerCase());var n,o=0,i=e.length;if("utf-8"===t||"utf8"===t)for(var a=0;a<i;a++)(n=e.codePointAt(a))<=127?o+=1:n<=2047?o+=2:n<=65535?o+=3:(o+=4,a++);else if("utf-16"===t||"utf16"===t)for(var s=0;s<i;s++)(n=e.codePointAt(s))<=65535?o+=2:(o+=4,s++);else o=e.replace(/[^\x00-\xff]/g,"aa").length;return o}(JSON.stringify(a));return a.type===R.MSG_MERGER&&11264<e?r._mergerMessageHandler.uploadMergerMessage(a,e).then(function(e){e=r._mergerMessageHandler.createMergerMessagePack(a,s,e);return r.req(e)}):(l.setMessageRandom(a),t.sendMessage(a,s))}).then(function(e){var t,e=e.data,n=e.time,o=e.sequence,i=e.readReceiptCode,e=e.messageDropReason,i=(Qe(i)&&0!==i&&(new M("sendMessageWithReceipt").setMessage("from:".concat(a.from," to:").concat(a.to," sequence:").concat(o," readReceiptCode:").concat(i)).end(),v.w("".concat(u," readReceiptCode:").concat(i," message:").concat(r.getErrMsg(i)))),e&&(i=new M("messageDropReason"),e="from:".concat(a.from," to:").concat(a.to," sequence:").concat(o," messageDropReason:").concat(e),i.setMessage(e).end(),v.w("".concat(u," ").concat(e))),r._addSendMessageSuccessCount(a,c),r._messageOptionsMap.delete(a.clientSequence),!0===a.isResend&&(t=l.findMessage(a.ID))&&(v.l("".concat(u," resend ok. ID:").concat(t.ID)),l.deleteLocalMessage(t)),a.status=An,a.time=n,!1);return a.conversationType===R.CONV_GROUP?a.sequence=o:a.conversationType!==R.CONV_C2C||(e=l.getLatestMessageSentByMe(a.conversationID))&&(t=e.nick,n=e.avatar,t===a.nick&&n===a.avatar||(i=!0)),i&&l.modifyMessageSentByMe({conversationID:a.conversationID,latestNick:a.nick,latestAvatar:a.avatar}),!0===d?a._onlineOnlyFlag=!0:(l.appendToMessageList(a),o=a,et(s)&&et(s.messageControlInfo)&&(!0===s.messageControlInfo.excludedFromLastMessage&&(a._isExcludedFromLastMessage=!0,o=""),!0===s.messageControlInfo.excludedFromUnreadCount&&(a._isExcludedFromUnreadCount=!0)),e=a.conversationType,kt(a.to)&&(e=R.CONV_TOPIC,r.get(10).onMessageSent({groupID:Bt(a.to),topicID:a.to,lastMessage:o})),l.onMessageSent({conversationOptionsList:[{conversationID:a.conversationID,unreadCount:0,type:e,subType:a.conversationSubType,lastMessage:o}]})),a._relayFlag||"TIMImageElem"!==a.type||Ft(a.payload.imageInfoArray),Ln({message:a})})}).catch(function(e){return r._onSendMessageFailed(a,e,d)})}},{key:"_guardForGroup",value:function(e){if(e.conversationType!==R.CONV_GROUP)return Promise.resolve();var t=this.get(7);if(!t)return this._onNoModule();if(St({groupID:e.to})){var n=t.getLocalGroupProfile(e.to);if(n&&n.isSupportTopic)return C({code:T.MSG_SEND_GRP_WITH_TOPIC_FAIL})}return t.guardForAVChatRoom(e)}},{key:"_onSendMessageFailed",value:function(e,t){var n=2<arguments.length&&void 0!==arguments[2]&&arguments[2],o="".concat(this._n,"._onSendMessageFailed"),i=(e.status=On,80001!==t.code&&80004!==t.code||(e.hasRiskContent=!0),this.get(11)),a=(i.deleteMessageRandom(e),10100<=t.code&&t.code<=10200||120001<=t.code&&t.code<=13e4),n=(n||a||!0===i.appendToMessageList(e)&&v.l("".concat(o," message stored, ID:").concat(e.ID)),this._addSendMessageFailCountOnUser(e,t),new M("sendMessage")),a="head.seq:".concat(t.data.headSeq," type:").concat(e.type," from:").concat(e.from," to:").concat(e.to);return ce&&("connection"in navigator&&(i=navigator.connection,a+=" downlink:".concat(i.downlink," effectiveType:").concat(i.effectiveType," rtt:").concat(i.rtt)),"memory"in window.performance&&(i=window.performance.memory,a+=" usedJSHeapSize:".concat(i.usedJSHeapSize," totalJSHeapSize:").concat(i.totalJSHeapSize," jsHeapSizeLimit:").concat(i.jsHeapSizeLimit))),n.setMessage(a).setError(t).end(),v.e("".concat(o," ").concat(a," error:"),t),C(new Hn({code:t&&t.code?t.code:T.MSG_SEND_FAIL,message:t&&t.message?t.message:void 0,data:{message:e}}))}},{key:"_getSendMessageSpecifiedKey",value:function(e){if([R.MSG_IMAGE,R.MSG_AUDIO,R.MSG_VIDEO,R.MSG_FILE].includes(e.type))return zn;if(e.conversationType===R.CONV_C2C)return Wn;if(e.conversationType===R.CONV_GROUP){var t=this.get(7);if(t){t=t.getLocalGroupProfile(e.to);if(t)return e=t.type,Lt(e)?Jn:jn}}}},{key:"_addSendMessageTotalCount",value:function(e){e=this._getSendMessageSpecifiedKey(e);e&&this.get(26).addTotalCount(e);}},{key:"_addSendMessageSuccessCount",value:function(e,t){var n,e=this._getSendMessageSpecifiedKey(e);e&&((n=this.get(26)).addSuccessCount(e),n.addCost(e,Zt(t,!1)));}},{key:"_addSendMessageFailCountOnUser",value:function(e,t){var n,t=t.code,t=void 0===t?-1:t,o=this.get(26),e=this._getSendMessageSpecifiedKey(e);e===zn&&(n=!1,n=Na.includes(t)?!0:n)?o.addFailedCountOfUserSide(Xn):Ua(t)&&e&&o.addFailedCountOfUserSide(e);}},{key:"resendMessage",value:function(e,t){return e.isResend=!0,e.status=Rn,this.sendMessageInstance(e,t)}},{key:"revokeMessage",value:function(n){var t=this,e=null;if(n.conversationType===R.CONV_C2C?e=this.get(6):n.conversationType===R.CONV_GROUP&&(e=this.get(7)),!e)return this._onNoModule();var o=new M("revokeMessage"),i=(o.setMessage("type:".concat(n.type," from:").concat(n.from," to:").concat(n.to)),"".concat(this._n,".").concat("revokeMessage"));return e.revokeMessage(n).then(function(e){var e=e.data.recallRetList;return Je(e)||0===e[0].retCode?(v.i("".concat(i," ok. ID:").concat(n.ID)),n.isRevoked=!0,o.end(),t.get(11).onMessageRevoked([n]),Ln({message:n})):(e=new Hn({code:e[0].retCode,data:{message:n}}),o.setCode(e.code).setMoreMessage(e.message).end(),C(e))}).catch(function(e){o.setError(e).end();var t=new Hn({code:e&&e.code?e.code:T.MSG_REVOKE_FAIL,message:e&&e.message?e.message:void 0,data:{message:n}});return v.w("".concat(i," failed. error:"),e),C(t)})}},{key:"deleteMessage",value:function(e){var t=this,n=null,o=e[0],i=o.conversationID,a="",s=[],r=[];if(o.conversationType===R.CONV_C2C)n=this.get(6),a=i.replace(R.CONV_C2C,""),e.forEach(function(e){e&&e.status===An&&e.conversationID===i&&(e._onlineOnlyFlag||s.push("".concat(e.sequence,"_").concat(e.random,"_").concat(e.time)),r.push(e));});else if(o.conversationType===R.CONV_GROUP)n=this.get(7),a=i.replace(R.CONV_GROUP,""),e.forEach(function(e){e&&e.status===An&&e.conversationID===i&&(e._onlineOnlyFlag||s.push("".concat(e.sequence)),r.push(e));});else if(o.conversationType===R.CONV_SYSTEM)return C({code:T.CANNOT_DELETE_GRP_SYSTEM_NOTICE});if(!n)return this._onNoModule();if(0===s.length)return this._onMessageDeleted(r);30<s.length&&(s=s.slice(0,30),r=r.slice(0,30));var c=new M("deleteMessage"),u=(c.setMessage("to:".concat(a," count:").concat(s.length)),"".concat(this._n,".").concat("deleteMessage"));return n.deleteMessage({to:a,keyList:s}).then(function(e){return c.end(),v.i("".concat(u," ok")),t._onMessageDeleted(r)}).catch(function(e){c.setError(e).end(),v.w("".concat(u," failed. error:"),e);e=new Hn({code:e&&e.code?e.code:T.MSG_DELETE_FAIL,message:e&&e.message?e.message:void 0});return C(e)})}},{key:"_onMessageDeleted",value:function(e){return this.get(11).onMessageDeleted(e),Sn({messageList:e})}},{key:"translateText",value:function(e){var o="".concat(this._n,".").concat("translateText"),t=e.sourceTextList,n=e.sourceLanguage,e=e.targetLanguage,i=new M("translateText");return i.setMessage("sourceLanguage:".concat(n," targetLanguage:").concat(e)),this.req({P:I.TRANSLATE_TEXT,data:{sourceTextList:t,source:n||"auto",target:e,from:this.getMyTinyID(),SDKAppID:this.getSDKAppID()}}).then(function(e){var e=e.data,t=e.error,n=e.requestID,e=e.translatedTextList;if(0===t.code)return i.end(),v.i("".concat(o," ok. requestID:").concat(n)),Ln({translatedTextList:e});throw y(y({},t),{},{requestID:n})}).catch(function(e){return i.setCode(e.code).setMoreMessage(e.requestID).end(),v.w("".concat(o," failed. error:"),e),C({code:T.TRANSLATE_TEXT_FAIL})})}},{key:"convertVoiceToText",value:function(e){var t=e.message,e=e.language,n=t.payload.url,t=(t.from===this.getMyUserID()&&"out"===t.flow&&(n=t.payload.remoteAudioUrl),/\.(wav|pcm|ogg-opus|speex|silk|mp3|m4a|aac|amr)/);if(!t.test(n))return C({code:T.UNSUPPORTED_VOICE_FORMAT});var t=t.exec(n)[1]||"mp3",o="16k_zh-PY",e=(e?"zh (cmn-Hans-CN)"===e?o="16k_zh":"en-US"===e?o="16k_en":"yue-Hant-HK"===e?o="16k_yue":"ja-JP"===e&&(o="16k_ja"):o="16k_zh-PY","serviceType:".concat(o," url:").concat(n)),i="".concat(this._n,".").concat("convertVoiceToText"),a=(v.i("".concat(i," ").concat(e)),new M("convertVoiceToText"));return a.setMessage(e),this.req({P:I.VOICE_TO_TEXT,data:{url:n,language:o,SDKAppID:this.getSDKAppID(),format:t}}).then(function(e){var e=e.data,t=e.error,n=e.requestID,e=e.result;if(0===t.code)return a.end(),v.i("".concat(i," ok. requestID:").concat(n)),Ln({result:e});throw y(y({},t),{},{requestID:n})}).catch(function(e){return a.setCode(e.code).setMoreMessage(e.requestID||"").end(),v.w("".concat(i," failed. error:"),e),C({code:T.VOICE_TO_TEXT_FAIL})})}},{key:"modifyRemoteMessage",value:function(n){var o=this;if(!1===this.get(29).filterMessage(n))return n.hasRiskContent=!0,C({code:T.PROFANITY_FOUND,data:{message:n}});var e=null,t=n.conversationType,i=n.to;if(t===R.CONV_C2C)e=this.get(6);else if(t===R.CONV_GROUP){if(!(e=this.get(7)))return this._onNoModule();if(e.isMessageFromOrToAVChatroom(i))return C({code:T.MSG_MODIFY_DISABLED_IN_AV,data:{message:n}})}var a=new M("modifyMessage"),s=(a.setMessage("to:".concat(i)),"".concat(this._n,".modifyRemoteMessage"));return e.modifyRemoteMessage(n).then(function(e){a.end(),v.i("".concat(s," ok"));e=o._onModifyRemoteMessageResp(n,e.data);return Ln({message:e})}).catch(function(e){var t;return a.setCode(e.code).setMoreMessage(e.message).end(),v.w("".concat(s," failed. error:"),e),20027===e.code?(t=o._onModifyRemoteMessageResp(n,e.data),C({code:T.MSG_MODIFY_CONFLICT,data:{message:t}})):C({code:e.code,message:e.message,data:{message:n}})})}},{key:"_onModifyRemoteMessageResp",value:function(e,t){v.d("".concat(this._n,"._onModifyRemoteMessageResp options:"),t);var n=e.conversationType,o=e.from,i=e.to,a=e.random,s=e.sequence,e=e.time,r=t.elements,c=t.messageVersion,t=t.cloudCustomData,t=void 0===t?"":t;return this.get(11).onMessageModified({conversationType:n,from:o,to:i,time:e,random:a,sequence:s,elements:r,cloudCustomData:t,messageVersion:c})}},{key:"_generateUUID",value:function(e){var t=this.get(12),t="".concat(t.getSDKAppID(),"-").concat(t.getUserID(),"-").concat(dt()),e=e.name||e.value||e.url||e.tempFilePath,e=e&&e.slice(e.lastIndexOf(".")+1);return t=e?"".concat(t,".").concat(e):t}},{key:"getMessageOption",value:function(e){return this._messageOptionsMap.get(e)}},{key:"_getNickAndAvatarByUserID",value:function(e){return this.get(4).getNickAndAvatarByUserID(e)}},{key:"_getNameCardByGroupID",value:function(e){if(e.conversationType===R.CONV_GROUP){var t=this.get(7);if(t)return t.getMyNameCardByGroupID(e.to)}return ""}},{key:"reset",value:function(){v.l("".concat(this._n,".reset")),this._messageOptionsMap.clear();}}]);var ba,wa,Fa,qa,xa,Va,Ha=es,Ba=(t($a,wn),xa=f($a),e($a,[{key:"onMsgExtNotify",value:function(e){var o=this,e=e.dataList,t=e.messageInfo,i=e.operateType,n=e.operateResultList,l=e.tinyID,e=e.globalSequence,d=t.clientTime,t=t.random,a="".concat(l,"-").concat(d,"-").concat(t),s=[],r=[],c=(v.l("".concat(this._n,".onMsgExtNotify messageID:").concat(a," operateType:").concat(i," globalSequence:").concat(e)),this._updateGlobalSeq(a,e),!1),u=!1;n.forEach(function(e){var t=e.extensions,t=void 0===t?[]:t,n=e.clearSequence;1===i?(c=!0,t.forEach(function(e){s.push({key:e.key,value:e.value});}),o._updateLocalExt(a,t)):2===i?(u=!0,t.forEach(function(e){r.push(e.key);}),o._updateLocalExt(a,t)):3===i&&(u=!0,o._hasLocalExt(a)&&o._getLocalExt(a).forEach(function(e,t){e.seq<=n&&!Je(e.value)&&r.push(t);}),o._clearLocalExt(a,n));}),c&&this.emitOEvt(G.MESSAGE_EXTENSIONS_UPDATED,{messageID:a,extensions:s}),u&&this.emitOEvt(G.MESSAGE_EXTENSIONS_DELETED,{messageID:a,keyList:r});}},{key:"setMessageExtensions",value:function(e,t){var n="setMessageExtensions";if(!this.canIUse(H.MSG_EXT))return this.noUse(n);var o="".concat(this._n,".").concat(n),i=e.ID,a=e.conversationID,s=e.sequence,r=e.time,c=D(t),t=(20<t.length&&(c=t.slice(0,20),v.w("".concat(o,". the length of extensions cannot exceed 20."))),"convID:".concat(a," messageID:").concat(i," sequence:").concat(s," time:").concat(r," count:").concat(c.length)),u=new M(n);return u.setMessage(t),v.l("".concat(o," ").concat(t)),this._modifyMsgExts(e,c).then(function(e){var t=e.resultList,n=e.successCount,e=e.failureCount,n="successCount:".concat(n," failCount:").concat(e);return u.setMoreMessage(n).end(),v.l("".concat(o," ok. ").concat(n)),Ln({extensions:t})}).catch(function(e){return u.setError(e).end(),v.e("".concat(o," failed. error:"),e),C(e)})}},{key:"getMessageExtensions",value:function(e){var t=this,n="getMessageExtensions";if(!this.canIUse(H.MSG_EXT))return this.noUse(n);var o="".concat(this._n,".").concat(n),i=e.ID,a=e.conversationID,s=e.sequence,r=e.time,a="convID:".concat(a," messageID:").concat(i," sequence:").concat(s," time:").concat(r),c=new M(n),u=(c.setMessage(a),v.l("".concat(o," ").concat(a)),void 0);return this.getMsgExtsMap.has(i)&&(u=this._getGlobalSeq(i)),this._getMsgExts(e,u).then(function(e){return c.end(),v.l("".concat(o," ok. extCount:").concat(e.length)),A(u)&&0<e.length&&t.getMsgExtsMap.set(i,1),Ln({extensions:e})}).catch(function(e){return c.setError(e).end(),v.e("".concat(o," failed. error:"),e),C(e)})}},{key:"deleteMessageExtensions",value:function(e,t){var n="deleteMessageExtensions";if(!this.canIUse(H.MSG_EXT))return this.noUse(n);var i="".concat(this._n,".").concat(n),o=[],a=3,t=(Je(t)||(a=2,t.forEach(function(e){o.push({key:e,value:"",seq:0});})),e.ID),s=e.conversationID,r=e.sequence,c=e.time,s="convID:".concat(s," messageID:").concat(t," sequence:").concat(r," time:").concat(c," operateType:").concat(a),u=new M(n);return u.setMessage(s),v.l("".concat(i," ").concat(s)),this._modifyMsgExts(e,o,a).then(function(e){var t=e.resultList,n=e.successCount,e=e.failureCount,o="";return 2===a&&(o="success count:".concat(n," fail count:").concat(e)),u.setMoreMessage("".concat(o)).end(),v.l("".concat(i," ok. ").concat(o)),Ln({extensions:t})}).catch(function(e){return u.setError(e).end(),v.e("".concat(i," failed. error:"),e),C(e)})}},{key:"_modifyMsgExts",value:function(n,e){var o=this,t=2<arguments.length&&void 0!==arguments[2]?arguments[2]:1,i=kt(n.to)?R.CONV_TOPIC:n.conversationType,a=void 0,s=(3!==t&&(a=this._getReqExts(n,e)),null);switch(i){case R.CONV_C2C:s=this.get(6);break;case R.CONV_GROUP:s=this.get(7);break;case R.CONV_TOPIC:s=this.get(10);break;default:return C({code:T.NO_MODULE})}return s.modifyMsgExts(n,a,t).then(function(e){var e=e.data,t=e.extensions,e=e.seq,i=[],a=0,s=0,r=[];return (t=Je(t)?[]:t).forEach(function(e){var t=e.errorCode,e=e.extension,n=e.key,o=e.value,e=e.seq;i.push({code:t,key:n,value:o}),0===t?a++:s++,r.push({key:n,value:o,seq:e});}),o._updateGlobalSeq(n.ID,e),0<r.length&&(o._updateLocalExt(n.ID,r),r=null),{resultList:i,successCount:a,failureCount:s}}).catch(function(e){return C(e)})}},{key:"_getReqExts",value:function(e,t){var o,i=[];return this._hasLocalExt(e.ID)?(o=this._getLocalExt(e.ID),t.forEach(function(e){var t=e.key,e=e.value,n=0;o.has(t)&&(n=o.get(t).seq),i.push({key:t,value:e,seq:n});})):t.forEach(function(e){var t=e.key,e=e.value;i.push({key:t,value:e,seq:0});}),i}},{key:"_getMsgExts",value:function(i,e){var a=this,s="".concat(this._n,"._getMsgExts"),r=i.ID,t=i.to,n=null;switch(kt(t)?R.CONV_TOPIC:i.conversationType){case R.CONV_C2C:n=this.get(6);break;case R.CONV_GROUP:n=this.get(7);break;case R.CONV_TOPIC:n=this.get(10);break;default:return C({code:T.NO_MODULE})}return n.getMessageExtensions(i,e).then(function(e){var e=e.data,t=e.extensions,n=e.completeFlag,o=e.globalSequence,e=e.clearSequence,t=Je(t)?[]:t;return v.l("".concat(s," ok. completeFlag:").concat(n," globalSequence:").concat(o," clearSequence:").concat(e," count:").concat(t.length)),a._updateLocalExt(r,t),a._clearLocalExt(r,e),a._updateGlobalSeq(r,o),1!==n?(e=t.slice(-1)[0].seq+1,a._getMsgExts(i,e)):a._getLocalExtList(r)}).catch(function(e){return C(e)})}},{key:"_hasLocalExt",value:function(e){return this.msgExtMap.has(e)}},{key:"_getLocalExt",value:function(e){return this.msgExtMap.get(e)}},{key:"_updateLocalExt",value:function(e,t){this._hasLocalExt(e)||this.msgExtMap.set(e,new Map);var o=this._getLocalExt(e);t.forEach(function(e){var t=e.key,n=e.value,e=e.seq;o.set(t,{value:void 0===n?"":n,seq:e});});}},{key:"_clearLocalExt",value:function(e,n){var o;n<=0||!this._hasLocalExt(e)||(o=this._getLocalExt(e)).forEach(function(e,t){e.seq<=n&&o.delete(t);});}},{key:"_getLocalExtList",value:function(e){var n=[];return this._hasLocalExt(e)&&this._getLocalExt(e).forEach(function(e,t){e=e.value;Je(e)||n.push({key:t,value:e});}),n}},{key:"_getGlobalSeq",value:function(e){return this.globalSeqMap.get(e)}},{key:"_updateGlobalSeq",value:function(e,t){this.globalSeqMap.set(e,t);}},{key:"reset",value:function(){v.l("".concat(this._n,".reset")),this.msgExtMap.clear(),this.globalSeqMap.clear(),this.getMsgExtsMap.clear();}}]),$a),Ka=(t(Qa,wn),qa=f(Qa),e(Qa,[{key:"onReactionNotifyList",value:function(e){var a=this,e=(e||{}).dataList;(void 0===e?[]:e).forEach(function(e){var t=e.C2CMessageInfo,n=e.groupMessageInfo,n=void 0===n?{}:n,e=e.reactionList,e=void 0===e?[]:e,t=y(y({},void 0===t?{}:t),n),n=t.tinyID,o=t.clientTime,t=t.random,n="".concat(n,"-").concat(o,"-").concat(t),i=[];e.forEach(function(e){A(e.userIDList)&&(e.userIDList=[],e.count=0),i.push.apply(i,D(e.userIDList));}),v.l("".concat(a._n,".onReactionNotifyList messageID:").concat(n," reactionList:").concat(e.length)),a._handleReactionSummary([{messageID:n,reactionList:e}],i).then(function(e){a.emitOEvt(G.MESSAGE_REACTIONS_UPDATED,y({},e[0]));});});}},{key:"onReactionNotify",value:function(e){var e=e.dataList||{},t=e.C2CMessageInfo,n=e.groupMessageInfo,n=void 0===n?{}:n,o=e.reactionID,e=e.operateType,t=y(y({},void 0===t?{}:t),n),n=t.tinyID,i=t.clientTime,t=t.random,n="".concat(n,"-").concat(i,"-").concat(t),i=(v.l("".concat(this._n,".onReactionNotify messageID:").concat(n," reactionID:").concat(o," operateType:").concat(e)),1===e?this._addReactedByMyselfMap(n,o):this._removeReactedByMyselfMap(n,o),"".concat(n,"-").concat(o));this._reactionInfoMap.has(i)&&((t=this._reactionInfoMap.get(i)).reactedByMyself=1===e,this.emitOEvt(G.MESSAGE_REACTIONS_UPDATED,{messageID:n,reactionList:[t]}));}},{key:"addMessageReaction",value:function(t,n){var o=this,e="addMessageReaction";if(!this.canIUse(H.MSG_REACTION))return this.noUse(e);var i="".concat(this._n,".").concat(e),a=t.ID,s=t.conversationID,s="convID:".concat(s," messageID:").concat(a," reactionID:").concat(n),r=new M(e),a=(r.setMessage(s),v.l("".concat(i," ").concat(s)),this._createReactionOperationPack(t,n,1));return this._addReactedByMyselfMap(t.ID,n),this.req(a).then(function(){return r.end(),v.l("".concat(i," ok.")),Ln()}).catch(function(e){return o._removeReactedByMyselfMap(t.ID,n),r.setError(e).end(),v.e("".concat(i," failed. error:"),e),C(e)})}},{key:"removeMessageReaction",value:function(e,t){var n="removeMessageReaction";if(!this.canIUse(H.MSG_REACTION))return this.noUse(n);var o="".concat(this._n,".").concat(n),i=e.ID,a=e.conversationID,a="convID:".concat(a," messageID:").concat(i," reactionID:").concat(t),s=new M(n),i=(s.setMessage(a),v.l("".concat(o," ").concat(a)),this._createReactionOperationPack(e,t,2));return this._removeReactedByMyselfMap(e.ID,t),this.req(i).then(function(){return s.end(),v.l("".concat(o," ok.")),Ln()}).catch(function(e){return s.setError(e).end(),v.e("".concat(o," failed. error:"),e),C(e)})}},{key:"getMessageReactions",value:function(e){var t=this,n="getMessageReactions";if(!this.canIUse(H.MSG_REACTION))return this.noUse(n);var o="".concat(this._n,".").concat(n),i=e.messageList,a=e.maxUserCountPerReaction,s=i[0].conversationID,s="convID:".concat(s," maxUserCountPerReaction:").concat(a," msgCount:").concat(i.length),r=new M(n),c=(r.setMessage(s),v.l("".concat(o," ").concat(s)),new Map),a=this._createReactionSummaryPack(y(y({},e),{},{messageIDMap:c}));return this.req(a).then(function(e){var e=e.data.resultList,o=[],i=[];return (void 0===e?[]:e).forEach(function(e){var t=e.messageKey,t=void 0===t?void 0:t,n=e.messageSequence,n=void 0===n?void 0:n,e=e.reactionList,e=void 0===e?[]:e,n=A(t)?c.get(n):c.get(t);o.push({messageID:n,reactionList:e}),e.forEach(function(e){i.push.apply(i,D(e.userIDList));});}),t._handleReactionSummary(o,i)}).then(function(e){return r.end(),v.l("".concat(o," ok.")),c.clear(),Ln({resultList:e})}).catch(function(e){return r.setError(e).end(),v.e("".concat(o," failed. error:"),e),C(e)})}},{key:"getAllUserListOfMessageReaction",value:function(e){var n=this,t="getAllUserListOfMessageReaction";if(!this.canIUse(H.MSG_REACTION))return this.noUse(t);var o="".concat(this._n,".").concat(t),i=e.message,a=e.reactionID,s=e.nextSeq,l=e.count,r=i.ID,i=i.conversationID,i="convID:".concat(i," messageID:").concat(r," reactionID:").concat(a," nextSeq:").concat(s," count:").concat(l),c=new M(t),u=(c.setMessage(i),v.l("".concat(o," ").concat(i)),{userList:[],nextSeq:0,isCompleted:!1}),r=this._createReactionUserListPack(e);return this.req(r).then(function(e){var e=e.data,t=e.userIDList,t=void 0===t?[]:t,e=e.nextSeq,e=void 0===e?0:e;return u.nextSeq=e,u.isCompleted=0===e,n.get(4).getUserNickAndAvatar(t)}).then(function(e){return u.userList=e,c.end(),v.l("".concat(o," ok.")),Ln(u)}).catch(function(e){return c.setError(e).end(),v.e("".concat(o," failed. error:"),e),C(e)})}},{key:"_createReactionOperationPack",value:function(e,t,n){var o,i,a=void 0,t={reactionID:t,userIDList:[this.getMyUserID()]};return e.conversationType===R.CONV_C2C&&(o=this.get(6),a=1===n?I.ADD_C2C_MSG_REACTION:I.RM_C2C_MSG_REACTION,t.from=e.from,t.to=e.to,t.messageKey=o.getMessageKey(e)),e.conversationType===R.CONV_GROUP&&(o=void 0,i=e.to,kt(e.to)&&(i=Bt(o=e.to)),a=1===n?I.ADD_GRP_MSG_REACTION:I.RM_GRP_MSG_REACTION,t.groupID=i,t.topicID=o,t.messageSequence=e.sequence),{P:a,data:t}}},{key:"_createReactionSummaryPack",value:function(e){var n,t,o,i=e.messageList,a=e.maxUserCountPerReaction,a=void 0===a?10:a,s=e.messageIDMap,e=i[0],r=void 0,c=void 0;return e.conversationType===R.CONV_C2C&&(n=this.get(6),t=i.map(function(e){var t=n.getMessageKey(e);return s.set(t,e.ID),t}),r=I.GET_C2C_MSG_REACTIONS,c={from:e.from,to:e.to,messageKeyList:t,count:a}),e.conversationType===R.CONV_GROUP&&(t=void 0,o=e.to,kt(e.to)&&(o=Bt(t=e.to)),e=i.map(function(e){return s.set(e.sequence,e.ID),e.sequence}),r=I.GET_GRP_MSG_REACTIONS,c={groupID:o,topicID:t,messageSequenceList:e,count:a}),{P:r,data:c}}},{key:"_createReactionUserListPack",value:function(e){var t=e.message,n=e.reactionID,o=e.nextSeq,e=e.count,e=void 0===e?100:e,i=void 0,n={reactionID:n,nextSeq:void 0===o?0:o,count:100<e?100:e};return t.conversationType===R.CONV_C2C&&(o=this.get(6),i=I.GET_C2C_MSG_REACTION_USER_LIST,n.from=t.from,n.to=t.to,n.messageKey=o.getMessageKey(t)),t.conversationType===R.CONV_GROUP&&(e=void 0,o=t.to,kt(t.to)&&(o=Bt(e=t.to)),i=I.GET_GRP_MSG_REACTION_USER_LIST,n.groupID=o,n.topicID=e,n.messageSequence=t.sequence),{P:i,data:n}}},{key:"_handleReactionSummary",value:function(t,e){var c=this;return this.get(4).getUserNickAndAvatar(e).then(function(r){var e=[];return t.forEach(function(a){var s=[];a.reactionList.forEach(function(e){var t=e.reactionID,n=e.count,o=e.userIDList,e=e.reactedByMyself,e=void 0===e?void 0:e,i=[],o=(o.forEach(function(t){r.forEach(function(e){t===e.userID&&i.push(e);});}),{reactionID:t,totalUserCount:n,partialUserList:i,reactedByMyself:c._computeReactedByMyself({reactedByMyself:e,messageID:a.messageID,reactionID:t})});s.push(o),A(e)&&!c._reactedByMyselfMap.has(a.messageID)&&(n="".concat(a.messageID,"-").concat(t),c._reactionInfoMap.set(n,o));}),e.push({messageID:a.messageID,reactionList:s});}),e})}},{key:"_addReactedByMyselfMap",value:function(e,t){this._reactedByMyselfMap.has(e)||this._reactedByMyselfMap.set(e,[]);e=this._reactedByMyselfMap.get(e);-1===e.indexOf(t)&&e.push(t);}},{key:"_removeReactedByMyselfMap",value:function(e,t){!this._reactedByMyselfMap.has(e)||-1<(t=(e=this._reactedByMyselfMap.get(e)).indexOf(t))&&e.splice(t,1);}},{key:"_computeReactedByMyself",value:function(e){var t=e.reactedByMyself,n=e.messageID,e=e.reactionID;return A(t)?!!this._reactedByMyselfMap.has(n)&&this._reactedByMyselfMap.get(n).includes(e):1===t}},{key:"reset",value:function(){v.l("".concat(this._n,".reset")),this._reactedByMyselfMap.clear(),this._reactionInfoMap.clear();}}]),Qa),Ya=(t(Za,wn),Fa=f(Za),e(Za,[{key:"sendMessage",value:function(e){var o=this,i=this._createMsg(e);if(null===i)return C({code:T.MSG_SEND_FAIL});this._addSendMessageTotalCount(i);var a=Date.now();return this.get(11).setMessageRandom(i),this._sendComboMessage(i,e).then(function(e){var e=e.data,t=e.time,n=e.sequence,e=e.readReceiptCode,e=(Qe(e)&&0!==e&&(new M("sendMessageWithReceipt").setMessage("from:".concat(i.from," to:").concat(i.to," sequence:").concat(n," readReceiptCode:").concat(e)).end(),v.w("".concat(o._n,".sendMessage readReceiptCode:").concat(e," message:").concat(o.getErrMsg(e)))),o._addSendMessageSuccessCount(i,a),o.get(11)),t=(i.status=An,i.time=t,i.conversationType===R.CONV_GROUP&&(i.sequence=n),e.appendToMessageList(i),i);return !0===i._isExcludedFromLastMessage&&(t=""),e.onMessageSent({conversationOptionsList:[{conversationID:i.conversationID,unreadCount:0,type:i.conversationType,subType:i.conversationSubType,lastMessage:t}]}),Ln({message:i})}).catch(function(e){return o._onSendMessageFailed(i,e)})}},{key:"_sendComboMessage",value:function(e,t){var n=this._m.get(20),o="";return e.conversationType===R.CONV_C2C&&(o="".concat(a.NAME.OPEN_IM,".").concat(I.SEND_C2C_MSG)),e.conversationType===R.CONV_GROUP&&(o="".concat(a.NAME.GRP,".").concat(I.SEND_GRP_MSG)),n.sendComboMessage({servcmd:o,data:t})}},{key:"_createMsg",value:function(e){var t="".concat(this._n,"._createMsg"),n=null;try{var o,i=this.getMyUserID(),a={};a.senderTinyID=this.getMyTinyID(),a.currentUser=i,a.from=e.From_Account||i,e.GroupId?(a.conversationID="".concat(R.CONV_GROUP).concat(e.GroupId),a.conversationType=R.CONV_GROUP,a.to=e.GroupId):e.To_Account&&(a.conversationID="".concat(R.CONV_C2C).concat(e.To_Account),a.conversationType=R.CONV_C2C,a.to=e.To_Account),a.time=e.MsgTimeStamp||0,a.random=e.Random||e.MsgRandom||0,a.priority=e.MsgPriority,ft(e.CloudCustomData)&&0<e.CloudCustomData.length&&(a.cloudCustomData=e.CloudCustomData),nt(e.SendMsgControl)&&(a.messageControlInfo={},e.SendMsgControl.includes("NoUnread")&&(a.messageControlInfo.excludedFromUnreadCount=1),e.SendMsgControl.includes("NoLastMsg")&&(a.messageControlInfo.excludedFromLastMessage=1)),a.conversationType===R.CONV_GROUP&&nt(e.To_Account)&&0<e.To_Account.length&&(o=e.To_Account,50<e.To_Account.length&&(o=e.To_Account.slice(0,50),v.w("".concat(t," To_Account must be less than or equal to 50."))),a.receiverList=D(o),e.To_Account=D(o)),1!==e.IsNeedReadReceipt&&1!==e.NeedReadReceipt||(a.needReadReceipt=!0),1===e.SupportMessageExtension&&(a.isSupportExtension=!0),(n=new ko(a)).status=Rn,e.MsgClientTime=n.clientTime,n.conversationType===R.CONV_C2C&&(e.MsgSeq=n.sequence);for(var s,r=e.MsgBody.length,c=0;c<r;c++)"TIMTextElem"===(s=e.MsgBody[c]).MsgType?n.setTextElement(s.MsgContent.Text):"TIMCustomElem"===s.MsgType?n.setCustomElement({data:s.MsgContent.Data||"",description:s.MsgContent.Desc||"",extension:s.MsgContent.Ext||""}):"TIMFaceElem"===s.MsgType&&n.setFaceElement({index:s.MsgContent.Index,data:s.MsgContent.Data});var u=n.getElements();n.payload=u[0].content,n.type=u[0].type;}catch(e){n=null,v.e("".concat(t," failed. error:"),e);}return n}},{key:"_onSendMessageFailed",value:function(e,t){e.status=On,this.get(11).deleteMessageRandom(e),this._addSendMessageFailCountOnUser(e,t);var n=new M("sendMessage"),o="head.seq:".concat(t.data.headSeq,"  type:").concat(e.type," from:").concat(e.from," to:").concat(e.to);return n.setMessage(o).setError(t).end(),v.e("".concat(this._n,"._onSendMessageFailed ").concat(o," error:"),t),C(new Hn({code:t&&t.code?t.code:T.MSG_SEND_FAIL,message:t&&t.message?t.message:void 0,data:{message:e}}))}},{key:"_getSendMessageSpecifiedKey",value:function(e){if(e.conversationType===R.CONV_C2C)return Wn;if(e.conversationType===R.CONV_GROUP){var e=this.get(7).getLocalGroupProfile(e.to);if(e)return e=e.type,Lt(e)?Jn:jn}}},{key:"_addSendMessageTotalCount",value:function(e){e=this._getSendMessageSpecifiedKey(e);e&&this.get(26).addTotalCount(e);}},{key:"_addSendMessageSuccessCount",value:function(e,t){var n,e=this._getSendMessageSpecifiedKey(e);e&&((n=this.get(26)).addSuccessCount(e),n.addCost(e,Zt(t,!1)));}},{key:"_addSendMessageFailCountOnUser",value:function(e,t){var t=t.code,t=void 0===t?-1:t,n=this.get(26),e=this._getSendMessageSpecifiedKey(e);Ua(t)&&e&&n.addFailedCountOfUserSide(e);}}]),Za),Wa=(t(Xa,wn),wa=f(Xa),e(Xa,[{key:"registerPlugin",value:function(t){var n=this,o="0";Object.keys(t).forEach(function(e){n.plugins[e]=t[e],"tim-upload-plugin"===e&&"function"==typeof t[e].getVersion&&(o=t[e].getVersion());}),new M("registerPlugin").setMessage("".concat(Object.keys(t))).setMoreMessage("version:".concat(o)).end();}},{key:"getPlugin",value:function(e){return this.plugins[e]}},{key:"reset",value:function(){}}]),Xa),ja=(t(za,wn),ba=f(za),e(za,[{key:"_init",value:function(){this._startSync({cookie:this._cookie,syncFlag:0,isOnlineSync:0});}},{key:"_startSync",value:function(e){var i=this,t=e.cookie,n=e.syncFlag,o=e.isOnlineSync,a="".concat(this._n,"._startSync"),s=(v.l("".concat(a," options:"),e),new M("syncUnread"));s.setMessage(JSON.stringify(e)),this.req({P:I.SYNC_UNREAD_MSG,data:{cookie:t,syncFlag:n,isOnlineSync:o}}).then(function(e){var t=e.data,n=t.cookie,t=t.syncFlag,o="$cookie:".concat(n," syncFlag:").concat(t);v.l("".concat(a," ok. ").concat(o)),i._cookie=n,s.setMoreMessage(o).end(),Je(n)||(0===t||1===t?(i._dispatch(y(y({},e.data),{},{isSyncingEnded:!1})),i._startSync({cookie:n,syncFlag:t,isOnlineSync:0})):2===t&&i._dispatch(y(y({},e.data),{},{isSyncingEnded:!0})));}).catch(function(e){s.setError(e).end(),v.e("".concat(a," failed. error:"),e);});}},{key:"_dispatch",value:function(e){e.eventArray&&this.get(20).onMessage({head:{},body:{eventArray:e.eventArray,isInstantMessage:this._onlineSyncFlag,isSyncingEnded:e.isSyncingEnded}}),this.get(6).onNewMessage({dataList:e.messageList,isInstantMessage:!!e.isSyncingEnded&&this._onlineSyncFlag,C2CRemainingUnreadList:e.C2CRemainingUnreadList,C2CPairUnreadList:e.C2CPairUnreadList,isSyncingEnded:e.isSyncingEnded});}},{key:"syncOnNeed",value:function(){v.l("".concat(this._n,".syncOnNeed cookie:").concat(this._cookie)),this._onlineSyncFlag=!0,this._startSync({cookie:this._cookie,syncFlag:0,isOnlineSync:1});}},{key:"syncOnReconnected",value:function(){v.l("".concat(this._n,".syncOnReconnected cookie:").concat(this._cookie)),this._onlineSyncFlag=!0,this._startSync({cookie:this._cookie,syncFlag:0,isOnlineSync:0});}},{key:"reset",value:function(){v.l("".concat(this._n,".reset")),this._onlineSyncFlag=!1,this._cookie="";}}]),za),Ja={req:{toAccount:"To_Account",fromAccount:"From_Account",to:"To_Account",from:"From_Account",groupID:"GroupId",groupAtUserID:"GroupAt_Account",extension:"Ext",data:"Data",description:"Desc",elements:"MsgBody",sizeType:"Type",downloadFlag:"Download_Flag",thumbUUID:"ThumbUUID",videoUUID:"VideoUUID",remoteAudioUrl:"Url",remoteVideoUrl:"VideoUrl",videoUrl:"",imageUrl:"URL",fileUrl:"Url",uuid:"UUID",priority:"MsgPriority",receiverUserID:"To_Account",receiverGroupID:"GroupId",messageSender:"SenderId",messageReceiver:"ReceiverId",nick:"From_AccountNick",avatar:"From_AccountHeadurl",messageNumber:"MsgNum",pbDownloadKey:"PbMsgKey",downloadKey:"JsonMsgKey",applicationType:"PendencyType",userIDList:"To_Account",groupNameList:"GroupName",userID:"To_Account",groupAttributeList:"GroupAttr",mainSequence:"AttrMainSeq",avChatRoomKey:"BytesKey",attributeControl:"AttrControl",sequence:"seq",messageControlInfo:"SendMsgControl",updateSequence:"UpdateSeq",clientTime:"MsgClientTime",sequenceList:"MsgSeqList",topicID:"TopicId",customData:"CustomString",isSupportTopic:"SupportTopic",isWebUniapp:"is_web_uniapp",isSupportExtension:"SupportMessageExtension",messageSequence:"MsgSeq",messageKey:"MsgKey",startSequence:"startSeq",simplifiedMessage:"DownsizeFlag",isRelayMessage:"IsRelayMsg",reactionID:"Reaction",messageSequenceList:"MsgSeqList",messageKeyList:"MsgKeyList",cmConfigID:"CustomModerationConfigID"},res:{MsgPriority:"priority",ThumbUUID:"thumbUUID",VideoUUID:"videoUUID",Download_Flag:"downloadFlag",GroupId:"groupID",Member_Account:"userID",MsgList:"messageList",SyncFlag:"syncFlag",To_Account:"to",From_Account:"from",MsgSeq:"sequence",MsgRandom:"random",MsgTime:"time",MsgTimeStamp:"time",MsgContent:"content",MsgBody:"elements",From_AccountNick:"nick",From_AccountHeadurl:"avatar",GroupWithdrawInfoArray:"revokedInfos",GroupReadInfoArray:"groupMessageReadNotice",LastReadMsgSeq:"lastMessageSeq",WithdrawC2cMsgNotify:"c2cMessageRevokedNotify",C2cWithdrawInfoArray:"revokedInfos",C2cReadedReceipt:"c2cMessageReadReceipt",ReadC2cMsgNotify:"c2cMessageReadNotice",LastReadTime:"peerReadTime",MsgRand:"random",MsgType:"type",MsgShow:"messageShow",NextMsgSeq:"nextMessageSeq",FaceUrl:"avatar",ProfileDataMod:"profileModify",Profile_Account:"userID",ValueBytes:"value",ValueNum:"value",NoticeSeq:"noticeSequence",NotifySeq:"notifySequence",MsgFrom_AccountExtraInfo:"messageFromAccountExtraInformation",Operator_Account:"operatorID",OpType:"operationType",ReportType:"operationType",UserId:"userID",User_Account:"userID",List_Account:"userIDList",MsgOperatorMemberExtraInfo:"operatorInfo",MsgMemberExtraInfo:"memberInfoList",ImageUrl:"avatar",NickName:"nick",MsgGroupNewInfo:"newGroupProfile",MsgAppDefinedData:"groupCustomField",Owner_Account:"ownerID",GroupFaceUrl:"avatar",GroupIntroduction:"introduction",GroupNotification:"notification",GroupApplyJoinOption:"joinOption",MsgKey:"messageKey",GroupInfo:"groupProfile",ShutupTime:"muteTime",Desc:"description",Ext:"extension",GroupAt_Account:"groupAtUserID",MsgNum:"messageNumber",PbMsgKey:"pbDownloadKey",JsonMsgKey:"downloadKey",MsgModifiedFlag:"isModified",PendencyItem:"applicationItem",PendencyType:"applicationType",AddTime:"time",AddSource:"source",AddWording:"wording",ProfileImImage:"avatar",PendencyAdd:"friendApplicationAdded",FrienPencydDel_Account:"friendApplicationDeletedUserIDList",Peer_Account:"userID",GroupAttr:"groupAttributeList",GroupAttrAry:"groupAttributeList",AttrMainSeq:"mainSequence",seq:"sequence",GroupAttrOption:"groupAttributeOption",BytesChangedKeys:"changedKeyList",GroupAttrInfo:"groupAttributeList",GroupAttrSeq:"mainSequence",PushChangedAttrValFlag:"isWithChangedAttributeInfo",SubKeySeq:"sequence",Val:"value",MsgGroupFromCardName:"senderNameCard",MsgGroupFromNickName:"senderNick",C2cNick:"peerNick",C2cImage:"peerAvatar",SendMsgControl:"messageControlInfo",NoLastMsg:"excludedFromLastMessage",NoUnread:"excludedFromUnreadCount",UpdateSeq:"updateSequence",MuteNotifications:"muteFlag",MsgClientTime:"clientTime",TinyId:"tinyID",GroupMsgReceiptList:"readReceiptList",ReadNum:"readCount",UnreadNum:"unreadCount",TopicId:"topicID",MillionGroupFlag:"communityType",SupportTopic:"isSupportTopic",MsgTopicNewInfo:"newTopicInfo",ShutupAll:"muteAllMembers",CustomString:"customData",TopicFaceUrl:"avatar",TopicIntroduction:"introduction",TopicNotification:"notification",TopicIdArray:"topicIDList",MsgVersion:"messageVersion",C2cMsgModNotifys:"c2cMessageModified",GroupMsgModNotifys:"groupMessageModified",ApplyJoinOption:"joinOption",MsgFlag:"messageRemindType",AtInfoList:"groupAtInfoList",AtFlagList:"groupAtType",AtMsgSeq:"sequence",BanDuration:"duration",BanDescription:"reason",NotVisible:"invisible",BytesTag:"tag",BytesValue:"value",RptBytesValue:"value",LatestSeq:"globalSequence",ClearSeq:"clearSequence",SupportMessageExtension:"isSupportExtension",ExtensionList:"extensions",GroupCounter:"counterList",Revoker_Account:"revoker",MsgExtensionNotify:"messageExtensionNotify",ExtensionC2cMsgInfo:"messageInfo",ExtensionGroupMsgInfo:"messageInfo",MsgOptType:"operateType",SetKVInfo:"operateResultList",DeleteKVInfo:"operateResultList",ClearKVInfo:"operateResultList",MsgKeyValue:"extensions",ClearMsgSeq:"clearSequence",MsgLastSeq:"globalSequence",InviteJoinOption:"inviteOption",MemberList_Account:"inviteeList",MsgMemberExtraInfoList:"inviteeInfoList",E:"event",GInf:"groupProfile",MCT:"clientTime",MR:"random",MP:"priority",MTS:"time",GId:"groupID",MS:"sequence",CCD:"cloudCustomData",F_Account:"from",F_Hd:"avatar",F_NN:"nick",GN:"groupName",GT:"groupType",IsSys:"isSystemMessage",OpInf:"operatorInfo",Img:"avatar",NN:"nick",OnlineInf:"onlineMemberInfo",ET:"expireTime",Num:"onlineMemberNum",Opt:"operationType",O_Account:"operatorID",RT:"operationType",UDF:"userDefinedField",L_Account:"userIDList",IsPlaceMsg:"isPlaceMessage",MsgCheckResult:"checkResult",Results:"resultList",Reaction:"reactionID",Reaction_Account:"userIDList",MsgReactionNotifyList:"messageReactionNotifyList",MsgReactionNotify:"messageReactionNotify",MsgReactionSummary:"reactionList",C2CMsgInfo:"C2CMessageInfo",GroupMsgInfo:"groupMessageInfo",int32_err_code:"errorCode",str_err_msg:"errorMsg",MsgDropReason:"messageDropReason",ReactedByMe:"reactedByMyself",Level:"messageRemindType",PeerReadTime:"timestamp",NoUnreadSeqList:"excludedUnreadSequenceList",NewMsg:"topicLatestMessage"},ignoreKeyWord:["C2C","ID","USP"]};function za(e){return d(this,za),(e=ba.call(this,e))._n="SyncUnreadMsgModule",e._cookie="",e._onlineSyncFlag=!1,e.getIEmitInst().on(Yo.A2KEY_AND_TINYID_UPDATED,e._init,h(e)),e}function Xa(e){return d(this,Xa),(e=wa.call(this,e))._n="PluginModule",e.plugins={},e}function Za(e){return d(this,Za),(e=Fa.call(this,e))._n="ComboMsgModule",e}function Qa(e){return d(this,Qa),(e=qa.call(this,e))._n="MsgReactionModule",e._reactedByMyselfMap=new Map,e._reactionInfoMap=new Map,e}function $a(e){return d(this,$a),(e=xa.call(this,e))._n="MsgExtModule",e.msgExtMap=new Map,e.globalSeqMap=new Map,e.getMsgExtsMap=new Map,e}function es(e){return d(this,es),(e=Va.call(this,e))._n="MessageModule",e._messageOptionsMap=new Map,e._mergerMessageHandler=new Aa(h(e)),e}function ts(e,t){if("string"!=typeof e&&!Array.isArray(e))throw new TypeError("Expected the input to be `string | string[]`");return t=Object.assign({pascalCase:!1},t),0===(e=Array.isArray(e)?e.map(function(e){return e.trim()}).filter(function(e){return e.length}).join("-"):e.trim()).length?"":1===e.length?t.pascalCase?e.toUpperCase():e.toLowerCase():(e=e=(e=e!==e.toLowerCase()?ns(e):e).replace(/^[_.\- ]+/,"").toLowerCase().replace(/[_.\- ]+(\w|$)/g,function(e,t){return t.toUpperCase()}).replace(/\d+(\w|$)/g,function(e){return e.toUpperCase()}),t.pascalCase?e.charAt(0).toUpperCase()+e.slice(1):e)}var ns=function(e){for(var t=!1,n=!1,o=!1,i=0;i<e.length;i++){var a=e[i];t&&/[a-zA-Z]/.test(a)&&a.toUpperCase()===a?(e=e.slice(0,i)+"-"+e.slice(i),o=n,n=!(t=!1),i++):n&&o&&/[a-zA-Z]/.test(a)&&a.toLowerCase()===a?(e=e.slice(0,i-1)+"-"+e.slice(i-1),o=n,t=!(n=!1)):(t=a.toLowerCase()===a&&a.toUpperCase()!==a,o=n,n=a.toUpperCase()===a&&a.toLowerCase()!==a);}return e};function os(e,t){var r=0;return function n(e,i){return 100<++r?(r--,e):nt(e)?(t=e.map(function(e){return $e(e)?n(e,i):e}),r--,t):$e(e)?(o=e,a=function(e,t){if(!st(t))return !1;if(t!==ts(t))for(var n=0;n<Ja.ignoreKeyWord.length&&!t.includes(Ja.ignoreKeyWord[n]);n++);var o;return A(i[t])?(o=t)[0].toUpperCase()+ts(o).slice(1):i[t]},s=Object.create(null),Object.keys(o).forEach(function(e){var t=a(o[e],e);t&&(s[t]=o[e]);}),t=Nt(t=s,function(e,t){return nt(e)||$e(e)?n(e,i):e}),r--,t):void 0;var t,o,a,s;}(e,t)}for(var is,as=String.fromCharCode,ss=function(e){var t=0|e.charCodeAt(0);if(55296<=t)if(t<56320){e=0|e.charCodeAt(1);if(56320<=e&&e<=57343){if(65535<(t=(t<<10)+e-56613888|0))return as(240|t>>>18,128|t>>>12&63,128|t>>>6&63,128|63&t)}else t=65533;}else t<=57343&&(t=65533);return t<=2047?as(192|t>>>6,128|63&t):as(224|t>>>12,128|t>>>6&63,128|63&t)},rs=function(e){for(var t=void 0===e?"":(""+e).replace(/[\x80-\uD7ff\uDC00-\uFFFF]|[\uD800-\uDBFF][\uDC00-\uDFFF]?/g,ss),n=0|t.length,o=new Uint8Array(n),i=0;i<n;i=i+1|0)o[i]=0|t.charCodeAt(i);return o},cs=(e(Os,[{key:"getID",value:function(){return this._id}},{key:"_onOpen",value:function(e){this._handler.onOpen({id:this._id,res:JSON.stringify(e)});}},{key:"_onClose",value:function(e){this._handler.onClose({id:this._id,e:e});}},{key:"_onMessage",value:function(e){e=this._canIUseBinaryFrame?this._isAppCompressedData(e.data)?this._handler.inflate(e.data):function(e){for(var t=new Uint8Array(e),n="",o=0,i=t.length;o<i;){var a=t[o],s=0,r=0;if(a<=127?(s=0,r=255&a):a<=223?(s=1,r=31&a):a<=239?(s=2,r=15&a):a<=244&&(s=3,r=7&a),0<i-o-s)for(var c=0;c<s;)r=r<<6|63&(a=t[o+c+1]),c+=1;else r=65533,s=i-o;n+=String.fromCodePoint(r),o+=s+1;}return n}(e.data):e.data;this._handler.onMessage({data:e});}},{key:"_isAppCompressedData",value:function(e){e=new Uint8Array(e);return 67===e[0]&&79===e[1]&&77===e[2]&&80===e[3]}},{key:"_onError",value:function(e){this._handler.onError({id:this._id,e:e});}},{key:"setIsWorkerEnabled",value:function(e){this._isWorkerEnabled=!0;}},{key:"close",value:function(e){if(this._workerSocket&&(this._workerSocket.postMessage({cmd:"stop",code:e}),this._workerSocket.terminate(),this._workerSocket=null),ee)return ue.offSocketClose(),ue.offSocketMessage(),ue.offSocketOpen(),ue.offSocketError(),void ue.closeSocket();this._socket&&(ae?(this._socket.onClose(function(){}),this._socket.onOpen(function(){}),this._socket.onMessage(function(){}),this._socket.onError(function(){})):(this._socket.onopen=null,this._socket.onmessage=null,this._socket.onclose=null,this._socket.onerror=null),$?this._socket.close({code:e}):this._socket.close(e),this._socket=null);}},{key:"send",value:function(e){this._workerSocket?this._workerSocket.postMessage({cmd:"sendMessage",data:this._canIUseBinaryFrame?rs(e.data).buffer:e.data}):ee?ue.sendSocketMessage({data:e.data,fail:function(){e.fail&&e.requestID&&e.fail(e.requestID);}}):this._socket&&(ae?this._socket.send({data:this._canIUseBinaryFrame?rs(e.data).buffer:e.data,fail:function(){e.fail&&e.requestID&&e.fail(e.requestID);}}):this._socket.send(this._canIUseBinaryFrame?rs(e.data):e.data));}}]),Os),us=["keyMap"],ls=["keyMap"],ds="connected",ps="connecting",_s="disconnected",hs=(e(As,[{key:"_setWebsocketHost",value:function(){var e=this._chM.get(12);this._currentSite=V,this._chM.isOversea()&&(this._currentSite="OVERSEA"),e.isSingaporeSite()?this._currentSite="SINGAPORE":e.isKoreaSite()?this._currentSite="KOREA":e.isGermanySite()?this._currentSite="GERMANY":e.isIndiaSite()?this._currentSite="IND":e.isJapanSite()?this._currentSite="JPN":e.isUSASite()?this._currentSite="USA":e.isIndonesiaSite()&&(this._currentSite="INDONESIA"),a.HOST.setCurrent(this._currentSite);}},{key:"_initConnection",value:function(){var e=this._chM.get(12).getSDKAppID()+"",t=this._chM.get(12).isIndependentDomainDisabled(),t=(A(a.HOST.CURRENT.BACKUP)?this._url=a.HOST.CURRENT.DEFAULT:""===this._url?this._url=t?a.HOST.CURRENT.DEFAULT:a.HOST.CURRENT.DEFAULT0.replace("*",e):-1<this._url.indexOf(e)?this._url=a.HOST.CURRENT.DEFAULT:this._url===a.HOST.CURRENT.DEFAULT?this._url=a.HOST.CURRENT.IPV6||a.HOST.CURRENT.BACKUP:this._url===a.HOST.CURRENT.IPV6?this._url=a.HOST.CURRENT.BACKUP:this._url===a.HOST.CURRENT.BACKUP?this._url=this._canIUseAnyCast()?a.HOST.CURRENT.ANYCAST:a.HOST.CURRENT.DEFAULT:this._url===a.HOST.CURRENT.ANYCAST&&(a.HOST.CURRENT.ANYCAST="",this._url=a.HOST.CURRENT.DEFAULT),this._chM.get(12)),e=t.getProxyServer();Je(e)||(this._url=e),t.isTestEnv()&&(this._url=w.TEST[this._currentSite].DEFAULT),this._connect(),this._nextPingTs=0;}},{key:"_canIUseAnyCast",value:function(){return ce&&a.HOST.CURRENT.ANYCAST}},{key:"onCheckTimer",value:function(e){e%1==0&&(this._checkPromiseMap(),this._checkNativeAppWS());}},{key:"_checkPromiseMap",value:function(){var a=this;0!==this._promiseMap.size&&this._promiseMap.forEach(function(e,t){var n=e.reject,o=e.timestamp,e=e.headSeq,i=15e3;-1!==t.indexOf(I.LOGIN)?i=9e4:-1!==t.indexOf(I.PING)&&(i=3e3),Date.now()-o>=i&&(v.l("".concat(a._n,"._checkPromiseMap request timeout, delete requestID:").concat(t)),a._promiseMap.delete(t),n(new Hn({code:T.NETWORK_TIMEOUT,data:{headSeq:e}})),a._chM.onRequestTimeout());});}},{key:"_checkNativeAppWS",value:function(){ne&&!this.isConnected()&&this._reConnect();}},{key:"onOpen",value:function(e){var t,n;this._readyState!==_s&&(this._onOpenTs=Date.now(),n=e.id,e=e.res,this._socketID=n,t=Zt(this._startTs,!1),n="socketID:".concat(n," res:").concat(e),v.l("".concat(this._n,"._onOpen cost:").concat(t," ms. ").concat(n)),new M("wsOnOpen").setMessage(t).setCostTime(t).setMoreMessage(n).end(),this._readyState=ds,this._reConnectCount=0,this._resend(),!0===this._reConnectFlag&&(this._chM.onReconnected(),this._reConnectFlag=!1),this._chM.onOpen());}},{key:"onClose",value:function(e){var t=new M("wsOnClose"),n=e.id,e=e.e,o="sourceSocketID:".concat(n," currentSocketID:").concat(this._socketID," code:").concat(e.code," reason:").concat(e.reason),i=0;0!==this._onOpenTs&&(i=Date.now()-this._onOpenTs),t.setMessage(i).setCostTime(i).setMoreMessage(o).setCode(e.code).end(!0),v.l("".concat(this._n,"._onClose ").concat(o," onlineTime:").concat(i)),n===this._socketID&&(this._readyState=_s,i<1e3?this._chM.onReconnectFailed():this._chM.onClose());}},{key:"onError",value:function(e){var t=e.id,e=e.e,n="sourceSocketID:".concat(t," currentSocketID:").concat(this._socketID);new M("wsOnError").setMessage(e.errMsg||JSON.stringify(e,["message","code"])).setMoreMessage(n).setLevel("error").end(!0),v.w("".concat(this._n,"._onError"),e,n),t===this._socketID&&(this._readyState=_s,this._chM.onError());}},{key:"onMessage",value:function(t){var e;try{e=JSON.parse(t.data);}catch(e){new M("jsonParseError").setMessage(t.data).end();}if(e&&e.head){var n,o,i,a,t=this._getRequestIDFromHead(e.head),s=e.body;if(this._chM.get(30).isTRTCCommand(t)||(a=qt(e.head),s=function t(e,n){return nt(e)?e.map(function(e){return $e(e)?t(e,n):e}):$e(e)?(o=e,i=function(e,t){return A(n[t])?ts(t):n[t]},a={},Object.keys(o).forEach(function(e){a[i(o[e],e)]=o[e];}),Nt(a,function(e){return nt(e)||$e(e)?t(e,n):e})):void 0;var o,i,a;}(e.body,this._getResKeyMap(a))),v.d("".concat(this._n,".onMessage ret:").concat(JSON.stringify(s)," requestID:").concat(t," has:").concat(this._promiseMap.has(t))),this._setNextPingTs(),this._promiseMap.has(t))return n=(a=this._promiseMap.get(t)).resolve,o=a.reject,i=a.timestamp,a=a.headSeq,this._promiseMap.delete(t),this._calcRTT(i),void(s.errorCode&&0!==s.errorCode?(this._chM.onErrorCodeNotZero(s),o(new Hn({code:s.errorCode,message:s.errorInfo||"",data:t.includes(I.MODIFY_C2C_MSG)||t.includes(I.MODIFY_GRP_MSG)?{elements:s.elements,messageVersion:s.messageVersion,cloudCustomData:s.cloudCustomData,headSeq:a}:{headSeq:a}}))):n(Ln(s)));this._chM.onMessage({head:e.head,body:s});}}},{key:"_calcRTT",value:function(e){e=Date.now()-e;this._chM.get(26).addRTT(e);}},{key:"_connect",value:function(){this._readyState!==ps&&this._readyState!==ds&&(this._startTs=Date.now(),this._onOpenTs=0,this._readyState=ps,this._socket=new cs(this),this._socketID=this._socket.getID(),v.l("".concat(this._n,"._connect isWorkerEnabled:").concat(this.getIsWorkerEnabled()," socketID:").concat(this._socketID," url:").concat(this.getURL())),new M("wsConnect").setMessage("socketID:".concat(this._socketID," url:").concat(this.getURL())).end());}},{key:"getURL",value:function(){this._chM.isDevMode()&&(this._canIUseBinaryFrame=!1);var e=Ut(),t=((ee||z&&"windows"===e||ne)&&(this._canIUseBinaryFrame=!1),-1),n=("ios"===e?t=_e||-1:"android"===e&&(t=ge||-1),this._chM.get(12)),o=this._chM.getPlatform(),i=n.getSDKAppID(),n=n.getInstanceID(),i="sdkappid=".concat(i,"&instanceid=").concat(n,"&random=").concat(this._getRandom(),"&platform=").concat(o,"&host=").concat(e)+"&version=".concat(t,"&sdkversion=").concat("3.5.0");return X&&(i+="&isminigame=1"),this._chM.canIUseInflate()&&(i+="&compress=gzip"),(this._canIUseBinaryFrame?"".concat(this._url,"/binfo?"):"".concat(this._url,"/info?")).concat(i)}},{key:"_closeConnection",value:function(e){v.l("".concat(this._n,"._closeConnection socketID:").concat(this._socketID)),this._socket&&(this._socket.close(e),this._socketID=-1,this._socket=null,this._readyState=_s);}},{key:"_resend",value:function(){var i=this;if(v.l("".concat(this._n,"._resend reConnectFlag:").concat(this._reConnectFlag),"promiseMap.size:".concat(this._promiseMap.size," simpleRequestMap.size:").concat(this._simpleRequestMap.size)),0<this._promiseMap.size&&this._promiseMap.forEach(function(e,t){var n=e.uplinkData,o=e.resolve,e=e.reject;-1!==t.indexOf(I.AV_POLLING)?i._promiseMap.delete(t):(i._promiseMap.set(t,{resolve:o,reject:e,timestamp:Date.now(),uplinkData:n}),i._execute(t,n));}),0<this._simpleRequestMap.size){var e,t=N(this._simpleRequestMap);try{for(t.s();!(e=t.n()).done;){var n=m(e.value,2),o=n[0],a=n[1];this._execute(o,a);}}catch(e){t.e(e);}finally{t.f();}this._simpleRequestMap.clear();}}},{key:"send",value:function(n){var o=this,i=(n.head.seq=this._getSequence(),n.head.reqtime=Math.floor(Date.now()/1e3),n.head.cs=this._calcCheckSum(n.head.servcmd,n.body),n.keyMap,g(n,us)),a=this._getRequestIDFromHead(n.head),s=JSON.stringify(i);return new Promise(function(e,t){o._promiseMap.set(a,{resolve:e,reject:t,timestamp:Date.now(),uplinkData:s,headSeq:n.head.seq}),v.d("".concat(o._n,".send uplinkData:").concat(JSON.stringify(i)," requestID:").concat(a," readyState:").concat(o._readyState)),o._readyState!==ds?o._reConnect():(o._execute(a,s),o._chM.get(26).addRequestCount());})}},{key:"simplySend",value:function(e){e.head.seq=this._getSequence(),e.head.reqtime=Math.floor(Date.now()/1e3),e.keyMap;var t=g(e,ls),e=this._getRequestIDFromHead(e.head),t=JSON.stringify(t);this._readyState!==ds?(this._simpleRequestMap.size<this.MAX_SIZE?this._simpleRequestMap.set(e,t):v.l("".concat(this._n,".simplySend. simpleRequestMap is full, drop request!")),this._reConnect()):this._execute(e,t);}},{key:"_execute",value:function(e,t){this._socket.send({data:t,fail:ae?this._onSendFail.bind(this):void 0,requestID:e});}},{key:"_onSendFail",value:function(e){v.l("".concat(this._n,"._onSendFail requestID:").concat(e)),this._chM.onSendFail();}},{key:"_getSequence",value:function(){var e;if(this._startSequence<2415919103)return e=this._startSequence,this._startSequence+=1,2415919103===this._startSequence&&(this._startSequence=lt()),e}},{key:"_getRequestIDFromHead",value:function(e){return e.servcmd+e.seq}},{key:"_getResKeyMap",value:function(e){e=this._chM.getKeyMap(e);return y(y({},Ja.res),e.res)}},{key:"_reConnect",value:function(){this._readyState!==ds&&this._readyState!==ps&&this.forcedReconnect();}},{key:"forcedReconnect",value:function(){var e="".concat(this._n,".forcedReconnect");v.l("".concat(e," count:").concat(this._reConnectCount," readyState:").concat(this._readyState)),this._reConnectFlag=!0,this._resetRandom(),this._reConnectCount<this.MAX_RECONNECT_COUNT?(this._reConnectCount+=1,this._closeConnection(4001),this._initConnection()):(this._reConnectCount=0,this._chM.get(15).isOnline()?(v.w("".concat(e," disconnected from wsserver but network is ok, continue...")),this._closeConnection(4001),this._initConnection()):this._chM.onReconnectFailed());}},{key:"getReconnectFlag",value:function(){return this._reConnectFlag}},{key:"_setNextPingTs",value:function(){this._nextPingTs=ne?Date.now()+5e3:Date.now()+1e4;}},{key:"getNextPingTs",value:function(){return this._nextPingTs}},{key:"isConnected",value:function(){return this._readyState===ds}},{key:"canIUseBinaryFrame",value:function(){return this._canIUseBinaryFrame}},{key:"getSocketID",value:function(){return this._socketID}},{key:"inflate",value:function(e){if(this._chM.canIUseInflate())return this._chM.get(37).inflate(e)}},{key:"setIsWorkerEnabled",value:function(e){v.l("".concat(this._n,".setIsWorkerEnabled flag:").concat(e)),this._isWorkerEnabled=e;}},{key:"getIsWorkerEnabled",value:function(){return this._isWorkerEnabled&&ye}},{key:"_getRandom",value:function(){return 0===this._random&&(this._random=Math.random()),this._random}},{key:"_resetRandom",value:function(){this._random=0;}},{key:"_calcCheckSum",value:function(e,t){if(-1!==e.indexOf(I.PING)||-1!==e.indexOf(I.LOGIN)||-1!==e.indexOf(I.LOGOUT)||-1!==e.indexOf(I.AV_POLLING)||-1!==e.indexOf(I.AV_NOAUTH_POLLING))return 0;for(var n=rs(JSON.stringify(t)),o=4294967295,i=0,a=n.length;i<a;i++){o^=n[i];for(var s=0;s<8;s++)1==(1&o)?o=o>>>1^3988292384:o>>>=1;}return (4294967295^o)>>>0}},{key:"close",value:function(){v.l("".concat(this._n,".close")),this._closeConnection(4e3),this._promiseMap.clear(),this._startSequence=lt(),this._readyState=_s,this._simpleRequestMap.clear(),this._reConnectFlag=!1,this._reConnectCount=0,this._onOpenTs=0,this._url="",this._random=0,this._canIUseBinaryFrame=!0,this._isWorkerEnabled=!0;}}]),As),gs=function(a,s,r){return new Promise(function(t,e){var n,o,i="application/x-www-form-urlencoded;charset=UTF-8";ae?ue.request({url:s,data:r,method:a,timeout:3e3,header:{"content-type":i},success:function(e){e&&e.data&&e.data.NetCheckInfo&&v.l("".concat("getconninfo ok in"," miniapp. ret:"),e.data),t();},fail:function(){e(new Hn({code:T.NETWORK_ERROR}));}}):(n=new XMLHttpRequest,o=setTimeout(function(){n.abort(),e(new Hn({code:T.NETWORK_TIMEOUT}));},3e3),n.onreadystatechange=function(){4===n.readyState&&(o&&clearTimeout(o),200===n.status||304===n.status?(n.responseText&&-1<n.responseText.indexOf("NetCheckInfo")&&v.l("".concat("getconninfo ok in"," web. ret:"),JSON.parse(n.responseText)),t()):e(new Hn({code:T.NETWORK_ERROR})));},n.open(a,s,!0),n.setRequestHeader("Content-type",i),r?n.send(r):n.send());})},fs=(t(Rs,wn),is=f(Rs),e(Rs,[{key:"onCheckTimer",value:function(e){this._socketHandler&&(this.isLoggedIn()?(0<this._timerForNotLoggedIn&&(clearInterval(this._timerForNotLoggedIn),this._timerForNotLoggedIn=-1),this._socketHandler.onCheckTimer(e)):this._socketHandler.onCheckTimer(1),this._checkNextPing());}},{key:"onErrorCodeNotZero",value:function(e){this.get(20).onErrorCodeNotZero(e);}},{key:"onMessage",value:function(e){this.get(20).onMessage(e);}},{key:"send",value:function(e){return this._socketHandler?this._previousState!==R.NET_STATE_CONNECTED&&e.head.servcmd.includes(I.SSO_STAT)?(this.reConnect(),this.isPrivateNetWork()?Promise.resolve():this._sendLogViaHTTP(e)):this._socketHandler.send(e):Promise.reject()}},{key:"_sendLogViaHTTP",value:function(e){var t=a.HOST.CURRENT.STAT,t="".concat(t,"/v4/imopenstat/tim_web_report_v2?sdkappid=").concat(e.head.sdkappid,"&reqtime=").concat(Date.now()),e=JSON.stringify(e.body);return gs("POST",t,e)}},{key:"simplySend",value:function(e){return this._socketHandler?this._socketHandler.simplySend(e):Promise.reject()}},{key:"onOpen",value:function(){this._ping();}},{key:"onClose",value:function(){this._socketHandler&&this._socketHandler.getReconnectFlag()&&this._emitNetStateChangeEvent(R.NET_STATE_DISCONNECTED),this.reConnect();}},{key:"onError",value:function(){ae&&!ne&&this.warn("DomainNameInMP"),this._emitNetStateChangeEvent(R.NET_STATE_DISCONNECTED);}},{key:"getKeyMap",value:function(e){return this.get(20).getKeyMap(e)}},{key:"onRequestTimeout",value:function(){3e4<=Date.now()-this._lastDiagnoseTS&&this.diagnose();}},{key:"onSendFail",value:function(){this._emitNetStateChangeEvent(R.NET_STATE_DISCONNECTED);}},{key:"onReconnected",value:function(){v.l("".concat(this._n,".onReconnected cost:").concat(Zt(this._disconnectedTS,!0,!0))),this._m.restartTimer(),this.get(20).onReconnected(Zt(this._disconnectedTS,!1,!1)),this._disconnectedTS=0,this._emitNetStateChangeEvent(R.NET_STATE_CONNECTED);}},{key:"onReconnectFailed",value:function(){v.l("".concat(this._n,".onReconnectFailed")),this._emitNetStateChangeEvent(R.NET_STATE_DISCONNECTED);}},{key:"setIsWorkerEnabled",value:function(e){this._socketHandler&&this._socketHandler.setIsWorkerEnabled(!1);}},{key:"offline",value:function(){this._emitNetStateChangeEvent(R.NET_STATE_DISCONNECTED);}},{key:"reConnect",value:function(){var e=0<arguments.length&&void 0!==arguments[0]&&arguments[0],t=!1,n=(this._socketHandler&&(t=this._socketHandler.getReconnectFlag()),"forcedFlag:".concat(e," fatalErrorFlag:").concat(this._fatalErrorFlag," previousState:").concat(this._previousState," reconnectFlag:").concat(t));if(v.l("".concat(this._n,".reConnect ").concat(n)),!this._fatalErrorFlag&&this._socketHandler){if(!0===e)this._socketHandler.forcedReconnect();else {if(this._previousState===R.NET_STATE_CONNECTING&&t)return;this._socketHandler.forcedReconnect();}this._emitNetStateChangeEvent(R.NET_STATE_CONNECTING);}}},{key:"_emitNetStateChangeEvent",value:function(e){this._previousState!==e&&(v.l("".concat(this._n,"._emitNetStateChangeEvent from ").concat(this._previousState," to ").concat(e)),e===R.NET_STATE_DISCONNECTED&&0===this._disconnectedTS&&(this._disconnectedTS=Date.now(),this.diagnose()),this._previousState=e,this.emitOEvt(G.NET_STATE_CHANGE,{state:e}));}},{key:"_ping",value:function(){var e,n=this;!0!==this._probing&&(this._probing=!0,e=this.get(20).getProtocolData({P:I.PING}),this.send(e).then(function(){n._probing=!1;}).catch(function(e){n._probing=!1;var t=n.get(15).isOnline();if(v.w("".concat(n._n,"._ping failed. bOnline:").concat(t," error:"),e),e&&60002===e.code)return new M("error").setMessage("code:".concat(e.code," message:").concat(e.message)).end(),n._fatalErrorFlag=!0,void n._emitNetStateChangeEvent(R.NET_STATE_DISCONNECTED);t?n.reConnect():n._emitNetStateChangeEvent(R.NET_STATE_DISCONNECTED);}));}},{key:"_checkNextPing",value:function(){this._socketHandler&&this._socketHandler.isConnected()&&Date.now()>=this._socketHandler.getNextPingTs()&&this._ping();}},{key:"dealloc",value:function(){this._socketHandler&&(this._socketHandler.close(),this._socketHandler=null),-1<this._timerForNotLoggedIn&&clearInterval(this._timerForNotLoggedIn);}},{key:"onRestApiKickedOut",value:function(){this._socketHandler&&(this._socketHandler.close(),this.reConnect(!0));}},{key:"canIUseInflate",value:function(){return this._m.canIUseInflate()}},{key:"getSocketID",value:function(){if(this._socketHandler)return this._socketHandler.getSocketID()}},{key:"diagnose",value:function(){this.isPrivateNetWork()||(this._lastDiagnoseTS=Date.now(),this._diagnoseBySSO(),this._diagnoseByCDN());}},{key:"_diagnoseBySSO",value:function(){var t=this,e=this._socketHandler.getURL(),n=e.split("/")[2];n.startsWith("ws")&&(e=e.slice(e.indexOf("info?")+5),n="https://".concat(n,"/v3/netcheck/getconninfo?").concat(e,"&reqtime=").concat(Date.now()),gs("GET",n).catch(function(e){v.w("".concat(t._n,"._diagnoseBySSO failed. error:"),e);}));}},{key:"_diagnoseByCDN",value:function(){var t=this,e=this._socketHandler.getURL(),e=e.slice(e.indexOf("info?")+5),e="https://boce-cdn.my-imcloud.com/v3/netcheck/getconninfo?".concat(e,"&reqtime=").concat(Date.now());gs("GET",e).catch(function(e){v.w("".concat(t._n,"._diagnoseByCDN failed. error:"),e);});}},{key:"reset",value:function(){v.l("".concat(this._n,".reset")),this._previousState=R.NET_STATE_CONNECTED,this._probing=!1,this._fatalErrorFlag=!1,this._timerForNotLoggedIn=setInterval(this.onCheckTimer.bind(this),1e3),this._disconnectedTS=0,this._lastDiagnoseTS=0;}}]),Rs),ms=["a2","tinyid"],vs=["a2","tinyid"],Is=(e(ks,[{key:"_fillMap",value:function(){this._map.clear();var e=this._sessionM.genCommonHead(),t=this._sessionM.genCosSpecifiedHead(),n=this._sessionM.genSSOReportHead();this._map.set(I.LOGIN,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.IM_OPEN_STATUS,".").concat(I.LOGIN)}),body:{state:"Online",isWebUniapp:0,deviceBrand:0,customInfo:""},keyMap:{req:{deviceBrand:"InstType"},res:{InstId:"instanceID",HelloInterval:"helloInterval",RichMsgAuthKey:"authKey"}}}),this._map.set(I.LOGOUT,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.IM_OPEN_STATUS,".").concat(I.LOGOUT)}),body:{type:0,isWebUniapp:0},keyMap:{req:{type:"wslogout_type"}}}),this._map.set(I.HELLO,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.IM_OPEN_STATUS,".").concat(I.HELLO)}),body:{isWebUniapp:0},keyMap:{res:{NewInstInfo:"newInstanceInfo"}}}),this._map.set(I.KICK_OTHER,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.STAT_SERVICE,".").concat(I.KICK_OTHER)}),body:{}}),this._map.set(I.COS_SIGN,{head:y(y({},t),{},{servcmd:"".concat(a.NAME.IM_COS_SIGN,".").concat(I.COS_SIGN)}),body:{cmd:"open_im_cos_svc",subCmd:"get_cos_token",duration:300,version:2},keyMap:{req:{userSig:"usersig",subCmd:"sub_cmd",cmd:"cmd",duration:"duration",version:"version"},res:{expired_time:"expiredTime",bucket_name:"bucketName",session_token:"sessionToken",tmp_secret_id:"secretId",tmp_secret_key:"secretKey"}}}),this._map.set(I.COS_PRE_SIG,{head:y(y({},t),{},{servcmd:"".concat(a.NAME.CUSTOM_UPLOAD,".").concat(I.COS_PRE_SIG)}),body:{fileType:void 0,fileName:void 0,uploadMethod:0,duration:900},keyMap:{req:{userSig:"usersig",fileType:"file_type",fileName:"file_name",uploadMethod:"upload_method"},res:{expired_time:"expiredTime",request_id:"requestId",head_url:"headUrl",upload_url:"uploadUrl",download_url:"downloadUrl",ci_url:"ciUrl",snapshot_url:"requestSnapshotUrl"}}}),this._map.set(I.SIMPLE_COS_PRE_SIG,{head:y(y({},t),{},{servcmd:"".concat(a.NAME.CUSTOM_UPLOAD,".").concat(I.SIMPLE_COS_PRE_SIG)}),body:{uploadMethod:0,platform:2,SDKAppID:0,userID:"",conversationType:1,uploadConfig:[{fileID:1,fileType:1,fileName:""}]},keyMap:{req:{platform:"uint32_platform",SDKAppID:"uint32_sdkappid",userID:"str_user_id",uploadMethod:"uint32_upload_method",conversationType:"uint32_scene",uploadConfig:"rpt_upload_object",fileID:"uint32_file_id",fileType:"uint32_file_type",fileName:"str_file_name"},res:{str_final_ip:"uploadIP",rpt_pre_sig:"preSig",uint32_file_id:"fileID",uint32_exist_flag:"existFlag",str_download_url:"downloadUrl",str_upload_url:"uploadUrl",str_snapshot_url:"requestSnapshotUrl",str_file_key:"fileKey"}}}),this._map.set(I.GET_IMAGE_INFO,{head:y(y({},t),{},{servcmd:"".concat(a.NAME.CUSTOM_UPLOAD,".").concat(I.GET_IMAGE_INFO)}),body:{imageUrl:""},keyMap:{req:{imageUrl:"str_image_url"},res:{rpt_msg_image_info:"imageInfoArray",uint32_image_type:"type",str_url:"url",uint32_width:"width",uint32_height:"height",str_image_format:"imageFormat"}}}),this._map.set(I.GET_IP,{head:y(y({},t),{},{servcmd:"".concat(a.NAME.CUSTOM_UPLOAD,".").concat(I.GET_IP)}),body:{domainName:""},keyMap:{req:{domainName:"str_domain"},res:{str_final_ip:"ip"}}}),this._map.set(I.VIDEO_COVER,{head:y(y({},t),{},{servcmd:"".concat(a.NAME.CUSTOM_UPLOAD,".").concat(I.VIDEO_COVER)}),body:{version:1,platform:void 0,coverName:void 0,requestSnapshotUrl:void 0},keyMap:{req:{version:"version",platform:"platform",coverName:"cover_name",requestSnapshotUrl:"snapshot_url"},res:{error_code:"errorCode",error_msg:"errorInfo",download_url:"snapshotUrl"}}}),this._map.set(I.FETCH_COMMERCIAL_CONFIG,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.IM_CONFIG_MANAGER,".").concat(I.FETCH_COMMERCIAL_CONFIG)}),body:{SDKAppID:0},keyMap:{req:{SDKAppID:"uint32_sdkappid"},res:{int32_error_code:"errorCode",str_error_message:"errorMessage",str_purchase_bits:"purchaseBits",uint32_expired_time:"expiredTime"}}}),this._map.set(I.PUSHED_COMMERCIAL_CONFIG,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.IM_CONFIG_MANAGER,".").concat(I.PUSHED_COMMERCIAL_CONFIG)}),body:{},keyMap:{res:{int32_error_code:"errorCode",str_error_message:"errorMessage",str_purchase_bits:"purchaseBits",uint32_expired_time:"expiredTime"}}}),this._map.set(I.FETCH_CLOUD_CTRL_CONFIG,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.IM_CONFIG_MANAGER,".").concat(I.FETCH_CLOUD_CTRL_CONFIG)}),body:{SDKAppID:0,version:0},keyMap:{req:{SDKAppID:"uint32_sdkappid",version:"uint64_version"},res:{int32_error_code:"errorCode",str_error_message:"errorMessage",str_json_config:"cloudControlConfig",uint32_expired_time:"expiredTime",uint32_sdkappid:"SDKAppID",uint64_version:"version"}}}),this._map.set(I.PUSHED_CLOUD_CTRL_CONFIG,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.IM_CONFIG_MANAGER,".").concat(I.PUSHED_CLOUD_CTRL_CONFIG)}),body:{},keyMap:{res:{int32_error_code:"errorCode",str_error_message:"errorMessage",str_json_config:"cloudControlConfig",uint32_expired_time:"expiredTime",uint32_sdkappid:"SDKAppID",uint64_version:"version"}}}),this._map.set(I.OVERLOAD_NOTIFY,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.OVERLOAD_PUSH,".").concat(I.OVERLOAD_NOTIFY)}),body:{},keyMap:{res:{OverLoadServCmd:"overloadCommand",DelaySecs:"waitingTime"}}}),this._map.set(I.SYNC_UNREAD_MSG,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.OPEN_IM,".").concat(I.SYNC_UNREAD_MSG)}),body:{cookie:"",syncFlag:0,needAbstract:1,isOnlineSync:0,needSignaling:1,needCachedMsg:1},keyMap:{req:{fromAccount:"From_Account",toAccount:"To_Account",from:"From_Account",to:"To_Account",time:"MsgTimeStamp",sequence:"MsgSeq",random:"MsgRandom",elements:"MsgBody"},res:{MsgList:"messageList",SyncFlag:"syncFlag",To_Account:"to",From_Account:"from",ClientSeq:"clientSequence",MsgSeq:"sequence",NoticeSeq:"noticeSequence",NotifySeq:"notifySequence",MsgRandom:"random",MsgTimeStamp:"time",MsgContent:"content",ToGroupId:"to",MsgKey:"messageKey",GroupTips:"groupTips",MsgBody:"elements",MsgType:"type",C2CRemainingUnreadCount:"C2CRemainingUnreadList",C2CPairUnreadCount:"C2CPairUnreadList"}}}),this._map.set(I.GET_PROFANITY_LIST,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.IM_MSG_AUDIT_MGR,".").concat(I.GET_PROFANITY_LIST)}),body:{version:0,deviceID:"",startIndex:void 0},keyMap:{req:{version:"uint64_version",deviceID:"str_device_id",startIndex:"uint64_start_index"},res:{msg_cmd_error_code:"errorInfo",str_err_msg:"errorMessage",uint32_code:"errorCode",msg_scene_ctl_config:"filterConfig",uint64_c2c_custom_msg_flag:"c2c_custom_message",uint64_c2c_text_msg_flag:"c2c_text_message",uint64_group_custom_msg_flag:"group_custom_message",uint64_group_text_msg_flag:"group_text_message",uint64_group_info_flag:"group_profile",uint64_group_member_info_flag:"group_member_profile",uint64_relation_chain_flag:"sns",uint64_user_info_flag:"user_profile",rpt_msg_dirty_word:"lexicon",str_dirty_word:"profanity",str_replaced_content:"replacement",uint64_filter_type:"filterType",uint64_id:"id",uint64_word_type:"profanityType",uint64_complete_flag:"completeFlag",uint64_next_start_index:"nextStartIndex",uint64_version:"version",uint64_expired_time:"expiredTime"}}}),this._map.set(I.SEND_C2C_MSG,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.OPEN_IM,".").concat(I.SEND_C2C_MSG)}),body:{fromAccount:"",toAccount:"",msgSeq:0,msgRandom:0,msgBody:[],cloudCustomData:void 0,nick:"",avatar:"",msgLifeTime:void 0,offlinePushInfo:{pushFlag:0,title:"",desc:"",ext:"",apnsInfo:{sound:"",badgeMode:0,isVoipPush:void 0,image:""},androidInfo:{sound:"",XiaoMiChannelID:"",OPPOChannelID:"",GoogleChannelID:"",VIVOClassification:1,VIVOCategory:"",HuaWeiCategory:"",OPPOCategory:"",HuaWeiImage:"",HonorImage:"",GoogleImage:""}},messageControlInfo:void 0,clientTime:void 0,needReadReceipt:0,isSupportExtension:0,isRelayMessage:0,cmConfigID:void 0},keyMap:{req:{fromAccount:"From_Account",toAccount:"To_Account",msgTimeStamp:"MsgTimeStamp",msgSeq:"MsgSeq",msgRandom:"MsgRandom",msgBody:"MsgBody",count:"MaxCnt",lastMessageTime:"LastMsgTime",messageKey:"MsgKey",peerAccount:"Peer_Account",data:"Data",description:"Desc",extension:"Ext",type:"MsgType",content:"MsgContent",sizeType:"Type",uuid:"UUID",url:"",imageUrl:"URL",fileUrl:"Url",remoteAudioUrl:"Url",remoteVideoUrl:"VideoUrl",thumbUUID:"ThumbUUID",videoUUID:"VideoUUID",videoUrl:"",downloadFlag:"Download_Flag",nick:"From_AccountNick",avatar:"From_AccountHeadurl",from:"From_Account",time:"MsgTimeStamp",messageRandom:"MsgRandom",messageSequence:"MsgSeq",elements:"MsgBody",clientSequence:"ClientSeq",payload:"MsgContent",messageList:"MsgList",messageNumber:"MsgNum",abstractList:"AbstractList",messageBody:"MsgBody",needReadReceipt:"IsNeedReadReceipt",GoogleChannelID:"GoogleChannelID",XiaoMiChannelID:"XiaoMiChannelID",OPPOChannelID:"OPPOChannelID",OPPOCategory:"OPPOCategory",VIVOClassification:"VIVOClassification",VIVOCategory:"VIVOCategory"}}}),this._map.set(I.SEND_GRP_MSG,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.GRP,".").concat(I.SEND_GRP_MSG)}),body:{fromAccount:"",groupID:"",random:0,clientSequence:0,priority:"",msgBody:[],cloudCustomData:void 0,onlineOnlyFlag:0,offlinePushInfo:{pushFlag:0,title:"",desc:"",ext:"",apnsInfo:{sound:"",badgeMode:0,isVoipPush:void 0,image:""},androidInfo:{sound:"",XiaoMiChannelID:"",OPPOChannelID:"",GoogleChannelID:"",VIVOClassification:1,VIVOCategory:"",HuaWeiCategory:"",OPPOCategory:"",HuaWeiImage:"",HonorImage:"",GoogleImage:""}},groupAtInfo:[],messageControlInfo:void 0,clientTime:void 0,needReadReceipt:0,topicID:void 0,receiverList:void 0,isSupportExtension:0,isRelayMessage:0,cmConfigID:void 0},keyMap:{req:{to:"GroupId",extension:"Ext",data:"Data",description:"Desc",random:"Random",sequence:"ReqMsgSeq",count:"ReqMsgNumber",type:"MsgType",priority:"MsgPriority",content:"MsgContent",elements:"MsgBody",sizeType:"Type",uuid:"UUID",url:"",imageUrl:"URL",fileUrl:"Url",remoteAudioUrl:"Url",remoteVideoUrl:"VideoUrl",thumbUUID:"ThumbUUID",videoUUID:"VideoUUID",videoUrl:"",downloadFlag:"Download_Flag",clientSequence:"ClientSeq",from:"From_Account",time:"MsgTimeStamp",messageRandom:"MsgRandom",messageSequence:"MsgSeq",payload:"MsgContent",messageList:"MsgList",messageNumber:"MsgNum",abstractList:"AbstractList",messageBody:"MsgBody",needReadReceipt:"NeedReadReceipt",receiverList:"To_Account",GoogleChannelID:"GoogleChannelID",XiaoMiChannelID:"XiaoMiChannelID",OPPOChannelID:"OPPOChannelID",OPPOCategory:"OPPOCategory",VIVOClassification:"VIVOClassification",VIVOCategory:"VIVOCategory"},res:{MsgTime:"time",MsgSeq:"sequence"}}}),this._map.set(I.REVOKE_C2C_MSG,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.OPEN_IM,".").concat(I.REVOKE_C2C_MSG)}),body:{msgInfo:{fromAccount:"",toAccount:"",msgTimeStamp:0,msgSeq:0,msgRandom:0}},keyMap:{req:{msgInfo:"MsgInfo",msgTimeStamp:"MsgTimeStamp",msgSeq:"MsgSeq",msgRandom:"MsgRandom"}}}),this._map.set(I.REVOKE_GRP_MSG,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.GRP,".").concat(I.REVOKE_GRP_MSG)}),body:{groupID:"",msgSeqList:void 0,topicID:""},keyMap:{req:{msgSeqList:"MsgSeqList",msgSeq:"MsgSeq"}}}),this._map.set(I.GET_C2C_ROAMING_MSG,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.OPEN_IM,".").concat(I.GET_C2C_ROAMING_MSG)}),body:{peerAccount:"",count:15,lastMessageTime:0,messageKey:"",withRecalledMessage:1,direction:0},keyMap:{req:{messageKey:"MsgKey",peerAccount:"Peer_Account",count:"MaxCnt",lastMessageTime:"LastMsgTime",withRecalledMessage:"WithRecalledMsg",direction:"GetDirection"},res:{LastMsgTime:"lastMessageTime",IsNeedReadReceipt:"needReadReceipt",IsPeerRead:"readReceiptSentByPeer"}}}),this._map.set(I.MODIFY_C2C_MSG,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.OPEN_IM,".").concat(I.MODIFY_C2C_MSG)}),body:{from:"",to:"",sequence:0,random:0,time:0,version:0,elements:void 0,cloudCustomData:void 0},keyMap:{req:{sequence:"MsgSeq",random:"MsgRandom",time:"MsgTime",version:"MsgVersion",type:"MsgType",content:"MsgContent"}}}),this._map.set(I.GET_GRP_ROAMING_MSG,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.GRP,".").concat(I.GET_GRP_ROAMING_MSG)}),body:{withRecalledMsg:1,groupID:"",count:15,sequence:"",topicID:void 0},keyMap:{req:{sequence:"ReqMsgSeq",count:"ReqMsgNumber",withRecalledMessage:"WithRecalledMsg"},res:{Random:"random",MsgTime:"time",MsgSeq:"sequence",ReqMsgSeq:"sequence",RspMsgList:"messageList",IsSystemMsg:"isSystemMessage",ToGroupId:"to",EnumFrom_AccountType:"fromAccountType",EnumTo_AccountType:"toAccountType",GroupCode:"groupCode",MsgPriority:"priority",MsgBody:"elements",MsgType:"type",MsgContent:"content",IsFinished:"complete",Download_Flag:"downloadFlag",ClientSeq:"clientSequence",ThumbUUID:"thumbUUID",VideoUUID:"videoUUID",ToTopicId:"topicID",InvisibleMsgSeq:"invisibleSequenceList",NextReqMsgSeq:"nextSequence"}}}),this._map.set(I.SET_C2C_MSG_READ,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.OPEN_IM,".").concat(I.SET_C2C_MSG_READ)}),body:{C2CMsgReaded:void 0},keyMap:{req:{lastMessageTime:"LastedMsgTime"}}}),this._map.set(I.SET_C2C_PEER_MUTE_NOTIFICATIONS,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.OPEN_IM,".").concat(I.SET_C2C_PEER_MUTE_NOTIFICATIONS)}),body:{userIDList:void 0,muteFlag:0},keyMap:{req:{userIDList:"Peer_Account",muteFlag:"Mute_Notifications"}}}),this._map.set(I.GET_C2C_PEER_MUTE_NOTIFICATIONS,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.OPEN_IM,".").concat(I.GET_C2C_PEER_MUTE_NOTIFICATIONS)}),body:{toAccount:void 0,userIDList:void 0},keyMap:{req:{userIDList:"Peer_Account"},res:{MuteNotificationsList:"muteFlagList"}}}),this._map.set(I.SET_GRP_MSG_READ,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.GRP,".").concat(I.SET_GRP_MSG_READ)}),body:{groupID:void 0,messageReadSeq:void 0,topicID:void 0},keyMap:{req:{messageReadSeq:"MsgReadedSeq"}}}),this._map.set(I.SET_ALL_MSG_READ,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.OPEN_IM,".").concat(I.SET_ALL_MSG_READ)}),body:{readAllC2CMessage:0,groupMessageReadInfoList:[]},keyMap:{req:{readAllC2CMessage:"C2CReadAllMsg",groupMessageReadInfoList:"GroupReadInfo",messageSequence:"MsgSeq"},res:{C2CReadAllMsg:"readAllC2CMessage",GroupReadInfoArray:"groupMessageReadInfoList"}}}),this._map.set(I.DEL_C2C_MSG,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.OPEN_IM,".").concat(I.DEL_C2C_MSG)}),body:{fromAccount:"",to:"",keyList:void 0},keyMap:{req:{keyList:"MsgKeyList"}}}),this._map.set(I.DEL_GRP_MSG,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.GRP,".").concat(I.DEL_GRP_MSG)}),body:{groupID:"",deleter:"",keyList:void 0,topicID:void 0},keyMap:{req:{deleter:"Deleter_Account",keyList:"Seqs"}}}),this._map.set(I.TRANSLATE_TEXT,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.IM_OPEN_TRANSLATE,".").concat(I.TRANSLATE_TEXT)}),body:{sourceTextList:void 0,SDKAppID:0,from:0,source:"",target:""},keyMap:{req:{sourceTextList:"SourceText",SDKAppID:"SdkAppId",from:"FromAccount"},res:{TargetText:"translatedTextList",RequestId:"requestID",CmdErrorCode:"error",ErrorCode:"code",ErrorInfo:"message"}}}),this._map.set(I.VOICE_TO_TEXT,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.IM_OPEN_SPEECH,".").concat(I.VOICE_TO_TEXT)}),body:{url:"",SDKAppID:0,format:"",sourceType:0,language:""},keyMap:{req:{url:"BytesUrl",SDKAppID:"Uint32Sdkappid",format:"BytesVoiceFormat",sourceType:"Uint64SourceType",language:"BytesEngServiceType"},res:{BytesRequestid:"requestID",BytesResult:"result",CmdErrorCode:"error",ErrorCode:"code",ErrorInfo:"message"}}}),this._map.set(I.MODIFY_GRP_MSG,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.OPEN_IM,".").concat(I.MODIFY_GRP_MSG)}),body:{groupID:"",topicID:void 0,sequence:0,version:0,elements:void 0,cloudCustomData:void 0},keyMap:{req:{sequence:"MsgSeq",version:"MsgVersion",type:"MsgType",content:"MsgContent"}}}),this._map.set(I.GET_READ_RECEIPT,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.GRP,".").concat(I.GET_READ_RECEIPT)}),body:{groupID:"",sequenceList:void 0},keyMap:{req:{sequence:"MsgSeq"}}}),this._map.set(I.SEND_C2C_READ_RECEIPT,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.OPEN_IM,".").concat(I.SEND_C2C_READ_RECEIPT)}),body:{peerAccount:"",messageInfoList:void 0},keyMap:{req:{peerAccount:"Peer_Account",messageInfoList:"C2CMsgInfo",fromAccount:"From_Account",toAccount:"To_Account",sequence:"MsgSeq",random:"MsgRandom",time:"MsgTime",clientTime:"MsgClientTime"}}}),this._map.set(I.SEND_READ_RECEIPT,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.GRP,".").concat(I.SEND_READ_RECEIPT)}),body:{groupID:"",sequenceList:void 0},keyMap:{req:{sequenceList:"MsgSeqList",sequence:"MsgSeq"}}}),this._map.set(I.GET_READ_RECEIPT_DETAIL,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.GRP,".").concat(I.GET_READ_RECEIPT_DETAIL)}),body:{groupID:"",sequence:void 0,flag:0,cursor:0,count:0},keyMap:{req:{sequence:"MsgSeq",count:"Num"},res:{ReadList:"readUserIDList",Read_Account:"userID",UnreadList:"unreadUserIDList",Unread_Account:"userID",IsFinish:"isCompleted"}}}),this._map.set(I.MODIFY_C2C_MSG_EXT,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.OPEN_IM_MSG_EXT,".").concat(I.MODIFY_C2C_MSG_EXT)}),body:{from:void 0,to:void 0,messageKey:void 0,operateType:void 0,extensionList:void 0}}),this._map.set(I.GET_C2C_MSG_EXT,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.OPEN_IM_MSG_EXT,".").concat(I.GET_C2C_MSG_EXT)}),body:{from:void 0,to:void 0,messageKey:void 0,startSequence:void 0}}),this._map.set(I.MODIFY_GRP_MSG_EXT,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.OPEN_IM_MSG_EXT,".").concat(I.MODIFY_GRP_MSG_EXT)}),body:{groupID:void 0,topicID:void 0,messageSequence:void 0,operateType:void 0,extensionList:void 0}}),this._map.set(I.GET_GRP_MSG_EXT,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.OPEN_IM_MSG_EXT,".").concat(I.GET_GRP_MSG_EXT)}),body:{groupID:void 0,topicID:void 0,messageSequence:void 0,startSequence:void 0}}),this._map.set(I.ADD_C2C_MSG_REACTION,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.OPEN_IM_MSG_EXT,".").concat(I.ADD_C2C_MSG_REACTION)}),body:{from:void 0,to:void 0,reactionID:void 0,messageKey:void 0,userIDList:void 0},keyMap:{req:{userIDList:"Add_Account"}}}),this._map.set(I.RM_C2C_MSG_REACTION,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.OPEN_IM_MSG_EXT,".").concat(I.RM_C2C_MSG_REACTION)}),body:{from:void 0,to:void 0,reactionID:void 0,messageKey:void 0,userIDList:void 0},keyMap:{req:{userIDList:"Del_Account"}}}),this._map.set(I.GET_C2C_MSG_REACTIONS,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.OPEN_IM_MSG_EXT,".").concat(I.GET_C2C_MSG_REACTIONS)}),body:{from:void 0,to:void 0,messageKeyList:void 0,count:void 0}}),this._map.set(I.GET_C2C_MSG_REACTION_USER_LIST,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.OPEN_IM_MSG_EXT,".").concat(I.GET_C2C_MSG_REACTION_USER_LIST)}),body:{from:void 0,to:void 0,reactionID:void 0,messageKey:void 0,count:void 0}}),this._map.set(I.ADD_GRP_MSG_REACTION,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.OPEN_IM_MSG_EXT,".").concat(I.ADD_GRP_MSG_REACTION)}),body:{groupID:void 0,topicID:void 0,reactionID:void 0,messageSequence:void 0,userIDList:void 0},keyMap:{req:{userIDList:"Add_Account"}}}),this._map.set(I.RM_GRP_MSG_REACTION,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.OPEN_IM_MSG_EXT,".").concat(I.RM_GRP_MSG_REACTION)}),body:{groupID:void 0,topicID:void 0,reactionID:void 0,messageSequence:void 0,userIDList:void 0},keyMap:{req:{userIDList:"Del_Account"}}}),this._map.set(I.GET_GRP_MSG_REACTIONS,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.OPEN_IM_MSG_EXT,".").concat(I.GET_GRP_MSG_REACTIONS)}),body:{groupID:void 0,topicID:void 0,messageSequenceList:void 0,count:void 0},keyMap:{res:{MsgSeq:"messageSequence"}}}),this._map.set(I.GET_GRP_MSG_REACTION_USER_LIST,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.OPEN_IM_MSG_EXT,".").concat(I.GET_GRP_MSG_REACTION_USER_LIST)}),body:{groupID:void 0,topicID:void 0,reactionID:void 0,messageSequence:void 0,nextSeq:void 0,count:void 0}}),this._map.set(I.GET_C2C_PEER_READ_TIME,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.OPEN_IM,".").concat(I.GET_C2C_PEER_READ_TIME)}),body:{userIDList:void 0},keyMap:{req:{userIDList:"To_Account"},res:{ReadTime:"peerReadTimeList"}}}),this._map.set(I.PAGING_GET_CONV_LIST,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.RECENT_CONTACT,".").concat(I.PAGING_GET_CONV_LIST)}),body:{fromAccount:void 0,timeStamp:void 0,startIndex:void 0,pinnedTimeStamp:void 0,pinnedStartIndex:void 0,orderType:void 0,messageAssistFlag:15,assistFlag:31},keyMap:{req:{messageAssistFlag:"MsgAssistFlags",assistFlag:"AssistFlags",pinnedTimeStamp:"TopTimeStamp",pinnedStartIndex:"TopStartIndex"},res:{SessionItem:"conversations",ToAccount:"groupID",To_Account:"userID",UnreadMsgCount:"unreadCount",MsgGroupReadedSeq:"messageReadSeq",C2cPeerReadTime:"c2cPeerReadTime",LastMsgFlags:"lastMessageFlag",TopFlags:"isPinned",TopTimeStamp:"pinnedTimeStamp",TopStartIndex:"pinnedStartIndex",GroupId:"convGroupID",C2cRemark:"friendRemark",MsgRecvOption:"messageRemindType",GroupIgnoredUnreadSeqCount:"noUnreadCount",GroupNextMsgSeq:"nextMessageSeq"}}}),this._map.set(I.DEL_CONV,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.RECENT_CONTACT,".").concat(I.DEL_CONV)}),body:{fromAccount:"",conversationList:void 0,clearHistoryMessage:void 0},keyMap:{req:{toGroupID:"ToGroupid",clearHistoryMessage:"ClearRamble",conversationList:"ContactItem"},res:{ResultItem:"resultList",ToGroupid:"groupID",ResultCode:"code",ResultInfo:"info"}}}),this._map.set(I.CLEAR_HISTORY_MSG,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.RECENT_CONTACT,".").concat(I.CLEAR_HISTORY_MSG)}),body:{fromAccount:"",toAccount:void 0,type:1,toGroupID:void 0},keyMap:{req:{toGroupID:"ToGroupid"}}}),this._map.set(I.PIN_CONV,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.RECENT_CONTACT,".").concat(I.PIN_CONV)}),body:{fromAccount:"",operationType:1,itemList:void 0},keyMap:{req:{itemList:"RecentContactItem"}}}),this._map.set(I.DEL_GROUP_AT_TIPS,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.OPEN_IM,".").concat(I.DEL_GROUP_AT_TIPS)}),body:{messageListToDelete:void 0},keyMap:{req:{messageListToDelete:"DelMsgList",messageSeq:"MsgSeq",messageRandom:"MsgRandom"}}}),this._map.set(I.SET_CONV_CUSTOM_DATA,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.RECENT_CONTACT,".").concat(I.MARK_CONV)}),body:{fromAccount:"",itemList:void 0},keyMap:{req:{itemList:"MarkItem",operationType:"OptType",groupID:"ToGroupId"},res:{ToGroupId:"groupID",OptType:"operationType"}}}),this._map.set(I.MARK_CONV,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.RECENT_CONTACT,".").concat(I.MARK_CONV)}),body:{fromAccount:"",itemList:void 0},keyMap:{req:{itemList:"MarkItem",operationType:"OptType",groupID:"ToGroupId"},res:{ToGroupId:"groupID",OptType:"operationType"}}}),this._map.set(I.CREATE_CONV_GRP,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.RECENT_CONTACT,".").concat(I.CREATE_CONV_GRP)}),body:{fromAccount:"",itemList:void 0},keyMap:{req:{itemList:"GroupContactItem",groupID:"ToGroupId"},res:{GroupId:"convGroupID",ToGroupId:"groupID",OptType:"operationType"}}}),this._map.set(I.DEL_CONV_GRP,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.RECENT_CONTACT,".").concat(I.DEL_CONV_GRP)}),body:{fromAccount:"",groupName:void 0},keyMap:{res:{GroupId:"convGroupID"}}}),this._map.set(I.RENAME_CONV_GRP,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.RECENT_CONTACT,".").concat(I.RENAME_CONV_GRP)}),body:{fromAccount:"",updateType:void 0,updateGroup:void 0},keyMap:{req:{oldName:"OldGroupName",newName:"NewGroupName",groupID:"ToGroupId",operationType:"ContactOptType",groupName:"OldGroupName",updateItem:"ContactUpdateItem"},res:{ContactOptType:"operationType",ToGroupId:"groupID",GroupId:"convGroupID"}}}),this._map.set(I.ADD_CONV_TO_GRP,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.RECENT_CONTACT,".").concat(I.RENAME_CONV_GRP)}),body:{fromAccount:"",updateType:void 0,updateGroup:{groupName:void 0,updateGroupType:void 0,updateItem:void 0}}}),this._map.set(I.DEL_CONV_FROM_GRP,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.RECENT_CONTACT,".").concat(I.RENAME_CONV_GRP)}),body:{fromAccount:"",updateType:void 0,updateGroup:void 0}}),this._map.set(I.GET_CONV_GRP_LIST,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.RECENT_CONTACT,".").concat(I.GET_CONV_GRP_LIST)}),body:{fromAccount:"",startIndex:void 0},keyMap:{res:{GroupId:"convGroupID",ToGroupId:"groupID",OptType:"operationType",CustomMark:"customData",ContactGroupId:"convGroupIDList"}}}),this._map.set(I.SEARCH_CONV_GRP_MARK,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.RECENT_CONTACT,".").concat(I.SEARCH_CONV_GRP_MARK)}),body:{fromAccount:"",contactItem:void 0},keyMap:{req:{groupID:"ToGroupId"},res:{GroupId:"convGroupID",ToGroupId:"groupID",OptType:"operationType",CustomMark:"customData",ContactGroupId:"convGroupIDList",ContactResultItem:"contactItem"}}}),this._map.set(I.GET_USER_PROFILE,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.PROFILE,".").concat(I.GET_USER_PROFILE)}),body:{fromAccount:"",userItem:[]},keyMap:{req:{toAccount:"To_Account",standardSequence:"StandardSequence",customSequence:"CustomSequence"}}}),this._map.set(I.UPDATE_MY_PROFILE,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.PROFILE,".").concat(I.UPDATE_MY_PROFILE)}),body:{fromAccount:"",profileItem:[{tag:qe.NICK,value:""},{tag:qe.GENDER,value:""},{tag:qe.ALLOWTYPE,value:""},{tag:qe.AVATAR,value:""}]},keyMap:{req:{toAccount:"To_Account",standardSequence:"StandardSequence",customSequence:"CustomSequence"}}}),this._map.set(I.GET_BL,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.FD,".").concat(I.GET_BL)}),body:{fromAccount:"",startIndex:0,maxLimited:30}}),this._map.set(I.ADD_TO_BL,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.FD,".").concat(I.ADD_TO_BL)}),body:{fromAccount:"",toAccount:[]}}),this._map.set(I.RM_FROM_BL,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.FD,".").concat(I.RM_FROM_BL)}),body:{fromAccount:"",toAccount:[]}}),this._map.set(I.SET_SELF_STATUS,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.IM_OPEN_STATUS,".").concat(I.SET_SELF_STATUS)}),body:{customStatus:""}}),this._map.set(I.GET_USER_STATUS,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.IM_OPEN_STATUS,".").concat(I.GET_USER_STATUS)}),body:{userIDList:void 0},keyMap:{res:{UserStatusList:"successUserList",ErrorList:"failureUserList",To_Account:"userID",Invalid_Account:"invalidUserID",Status:"statusType"}}}),this._map.set(I.SUB_USER_STATUS,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.IM_OPEN_STATUS,".").concat(I.SUB_USER_STATUS)}),body:{userIDList:void 0},keyMap:{res:{ErrorList:"failureUserList",To_Account:"userID",Invalid_Account:"invalidUserID"}}}),this._map.set(I.UNSUB_USER_STATUS,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.IM_OPEN_STATUS,".").concat(I.UNSUB_USER_STATUS)}),body:{userIDList:void 0,unsubscribeAll:void 0},keyMap:{res:{ErrorList:"failureUserList",To_Account:"userID",Invalid_Account:"invalidUserID"}}}),this._map.set(I.GET_FD_LIST,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.FD,".").concat(I.GET_FD_LIST)}),body:{fromAccount:"",startIndex:0,standardSequence:0,customSequence:0},keyMap:{res:{FriendNum:"friendCount",UserDataItem:"resultList",ValueItem:"tagValueList"}}}),this._map.set(I.ADD_FD,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.FD,".").concat(I.ADD_FD)}),body:{fromAccount:"",addFriendItem:[],type:""},keyMap:{req:{source:"AddSource",wording:"AddWording",type:"AddType"},res:{ResultItem:"resultList"}}}),this._map.set(I.UPDATE_FD,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.FD,".").concat(I.UPDATE_FD)}),body:{fromAccount:"",updateItem:void 0},keyMap:{req:{snsItem:"SnsItem"},res:{ResultItem:"resultList"}}}),this._map.set(I.DEL_FD,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.FD,".").concat(I.DEL_FD)}),body:{fromAccount:"",userIDList:[],type:""},keyMap:{req:{type:"DeleteType"},res:{ResultItem:"resultList"}}}),this._map.set(I.GET_FD_PROFILE,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.FD,".").concat(I.GET_FD_PROFILE)}),body:{fromAccount:"",userIDList:void 0},keyMap:{res:{InfoItem:"resultList",SnsProfileItem:"tagValueList"}}}),this._map.set(I.CHECK_FD,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.FD,".").concat(I.CHECK_FD)}),body:{fromAccount:"",userIDList:[],type:""},keyMap:{req:{type:"CheckType"},res:{InfoItem:"resultList"}}}),this._map.set(I.GET_FD_APPLICATION_LIST,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.FD,".").concat(I.GET_FD_APPLICATION_LIST)}),body:{fromAccount:"",applicationType:"",startTime:0,maxLimited:0,lastSequence:0},keyMap:{res:{PendencyItem:"resultList",AddSource:"source",AddTime:"time",AddWording:"wording",Image:"avatar",UnreadPendencyCount:"unreadCount",To_Account:"userID",PendencyType:"type"}}}),this._map.set(I.RESPOND_FD_APPLICATION,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.FD,".").concat(I.RESPOND_FD_APPLICATION)}),body:{fromAccount:"",responseFriendItem:[]},keyMap:{req:{tag:"TagName",action:"ResponseAction"},res:{ResultItem:"resultList"}}}),this._map.set(I.DEL_FD_APPLICATION,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.FD,".").concat(I.DEL_FD_APPLICATION)}),body:{fromAccount:"",type:"",userIDList:void 0},keyMap:{req:{type:"PendencyType",userIDList:"To_Account"},res:{ResultItem:"resultList"}}}),this._map.set(I.REPORT_FD_APPLICATION,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.FD,".").concat(I.REPORT_FD_APPLICATION)}),body:{fromAccount:"",latestTimeStamp:""},keyMap:{req:{latestTimeStamp:"LatestPendencyTimeStamp"}}}),this._map.set(I.CREATE_FD_GRP,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.FD,".").concat(I.CREATE_FD_GRP)}),body:{fromAccount:"",groupName:void 0,userIDList:void 0},keyMap:{req:{groupName:"GroupName",userIDList:"To_Account"},res:{ResultItem:"resultList"}}}),this._map.set(I.DEL_FD_GRP,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.FD,".").concat(I.DEL_FD_GRP)}),body:{fromAccount:"",nameList:void 0},keyMap:{req:{nameList:"GroupName"}}}),this._map.set(I.GET_FD_GRP_LIST,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.FD,".").concat(I.GET_FD_GRP_LIST)}),body:{fromAccount:"",lastSequence:0,needFriend:"Need_Friend_Type_Yes"},keyMap:{res:{ResultItem:"resultList",GroupName:"name",FriendNumber:"friendCount",To_Account:"userIDList"}}}),this._map.set(I.UPDATE_FD_GRP,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.FD,".").concat(I.UPDATE_FD_GRP)}),body:{fromAccount:"",oldName:"",newName:void 0,updateGroupItem:void 0},keyMap:{req:{oldName:"GroupOldName",newName:"GroupNewName"},res:{UpdateType:"type",ResultItem:"resultList"}}}),this._map.set(I.GET_GRP_LIST,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.GRP,".").concat(I.GET_GRP_LIST)}),body:{memberAccount:"",limit:void 0,offset:void 0,groupType:void 0,responseFilter:{groupBaseInfoFilter:void 0,selfInfoFilter:void 0},isSupportTopic:0,needAppDefineData:1},keyMap:{req:{memberAccount:"Member_Account"},res:{GroupIdList:"groups",MsgSeq:"readedSequence",LastRecallTime:"_lastRevokedTime",AppDefinedData:"groupCustomField"}}}),this._map.set(I.GET_GRP_PROFILE,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.GRP,".").concat(I.GET_GRP_PROFILE)}),body:{groupIDList:void 0,responseFilter:{groupBaseInfoFilter:void 0,groupCustomFieldFilter:void 0,memberInfoFilter:void 0,memberCustomFieldFilter:void 0}},keyMap:{req:{groupIDList:"GroupIdList",groupCustomField:"AppDefinedData",memberCustomField:"AppMemberDefinedData",groupCustomFieldFilter:"AppDefinedDataFilter_Group",memberCustomFieldFilter:"AppDefinedDataFilter_GroupMember"},res:{GroupIdList:"groups",AppDefinedData:"groupCustomField",AppMemberDefinedData:"memberCustomField",AppDefinedDataFilter_Group:"groupCustomFieldFilter",AppDefinedDataFilter_GroupMember:"memberCustomFieldFilter",InfoSeq:"infoSequence",MemberList:"members",GroupInfo:"groups",ShutUpUntil:"muteUntil",ShutUpAllMember:"muteAllMembers"}}}),this._map.set(I.CREATE_GRP,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.GRP,".").concat(I.CREATE_GRP)}),body:{type:void 0,name:void 0,groupID:void 0,ownerID:void 0,introduction:void 0,notification:void 0,maxMemberNum:void 0,joinOption:void 0,memberList:void 0,groupCustomField:void 0,memberCustomField:void 0,webPushFlag:1,avatar:"",isSupportTopic:void 0,inviteOption:void 0},keyMap:{req:{ownerID:"Owner_Account",userID:"Member_Account",avatar:"FaceUrl",maxMemberNum:"MaxMemberCount",joinOption:"ApplyJoinOption",groupCustomField:"AppDefinedData",memberCustomField:"AppMemberDefinedData",inviteOption:"InviteJoinOption"},res:{HugeGroupFlag:"avChatRoomFlag",OverJoinedGroupLimit_Account:"overLimitUserIDList"}}}),this._map.set(I.DISMISS_GRP,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.GRP,".").concat(I.DISMISS_GRP)}),body:{groupID:void 0}}),this._map.set(I.UPDATE_GRP_PROFILE,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.GRP,".").concat(I.UPDATE_GRP_PROFILE)}),body:{groupID:void 0,name:void 0,introduction:void 0,notification:void 0,avatar:void 0,joinOption:void 0,groupCustomField:void 0,muteAllMembers:void 0,inviteOption:void 0},keyMap:{req:{groupCustomField:"AppDefinedData",muteAllMembers:"ShutUpAllMember",joinOption:"ApplyJoinOption",avatar:"FaceUrl",inviteOption:"InviteJoinOption"},res:{AppDefinedData:"groupCustomField",ShutUpAllMember:"muteAllMembers"}}}),this._map.set(I.APPLY_JOIN_GRP,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.GRP,".").concat(I.APPLY_JOIN_GRP)}),body:{groupID:void 0,applyMessage:void 0,userDefinedField:void 0,webPushFlag:1,historyMessageFlag:void 0},keyMap:{req:{applyMessage:"ApplyMsg",historyMessageFlag:"HugeGroupHistoryMsgFlag"},res:{HugeGroupFlag:"avChatRoomFlag",AVChatRoomKey:"avChatRoomKey",RspMsgList:"messageList",ToGroupId:"to"}}}),this._map.set(I.APPLY_JOIN_GRP_NOAUTH,(e.a2,e.tinyid,{head:y(y({},g(e,ms)),{},{servcmd:"".concat(a.NAME.BIG_GRP_NO_AUTH,".").concat(I.APPLY_JOIN_GRP)}),body:{groupID:void 0,applyMessage:void 0,userDefinedField:void 0,webPushFlag:1},keyMap:{req:{applyMessage:"ApplyMsg"},res:{HugeGroupFlag:"avChatRoomFlag"}}})),this._map.set(I.QUIT_GRP,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.GRP,".").concat(I.QUIT_GRP)}),body:{groupID:void 0}}),this._map.set(I.SEARCH_GRP,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.GRP,".").concat(I.SEARCH_GRP)}),body:{groupIDList:void 0,responseFilter:{groupBasePublicInfoFilter:["Type","Name","Introduction","Notification","FaceUrl","CreateTime","Owner_Account","LastInfoTime","LastMsgTime","NextMsgSeq","MemberNum","MaxMemberNum","ApplyJoinOption","InviteJoinOption"]}}}),this._map.set(I.CHANGE_GRP_OWNER,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.GRP,".").concat(I.CHANGE_GRP_OWNER)}),body:{groupID:void 0,newOwnerID:void 0},keyMap:{req:{newOwnerID:"NewOwner_Account"}}}),this._map.set(I.HANDLE_GRP_APPLICATION,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.GRP,".").concat(I.HANDLE_GRP_APPLICATION)}),body:{groupID:void 0,applicant:void 0,handleAction:void 0,handleMessage:void 0,authentication:void 0,messageKey:void 0,userDefinedField:void 0},keyMap:{req:{applicant:"Applicant_Account",handleAction:"HandleMsg",handleMessage:"ApprovalMsg",messageKey:"MsgKey"}}}),this._map.set(I.HANDLE_INVITE_JOIN_GRP,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.GRP,".").concat(I.HANDLE_INVITE_JOIN_GRP)}),body:{groupID:void 0,applicant:void 0,invitee:void 0,handleAction:void 0,handleMessage:void 0,authentication:void 0,userDefinedField:void 0},keyMap:{req:{applicant:"Applicant_Account",invitee:"Invited_Account",handleAction:"HandleMsg",handleMessage:"ApprovalMsg"}}}),this._map.set(I.HANDLE_GRP_INVITATION,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.GRP,".").concat(I.HANDLE_GRP_INVITATION)}),body:{groupID:void 0,inviter:void 0,handleAction:void 0,handleMessage:void 0,authentication:void 0,messageKey:void 0,userDefinedField:void 0},keyMap:{req:{inviter:"Inviter_Account",handleAction:"HandleMsg",handleMessage:"ApprovalMsg",messageKey:"MsgKey"}}}),this._map.set(I.GET_GRP_PENDENCY,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.GRP,".").concat(I.GET_GRP_PENDENCY)}),body:{startTime:void 0,limit:void 0,handleAccount:void 0},keyMap:{req:{handleAccount:"Handle_Account"},res:{To_Account:"userID",ApplyInviteMsg:"note"}}}),this._map.set(I.DEL_GRP_SYSTEM_NOTICE,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.OPEN_IM,".").concat(I.DEL_GRP_SYSTEM_NOTICE)}),body:{messageListToDelete:void 0},keyMap:{req:{messageListToDelete:"DelMsgList",messageSeq:"MsgSeq",messageRandom:"MsgRandom"}}}),this._map.set(I.AV_POLLING,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.BIG_GRP_POLLING,".").concat(I.AV_POLLING)}),body:{USP:1,startSeq:1,startBroadcastSeq:void 0,holdTime:90,key:void 0,simplifiedMessage:void 0},keyMap:{req:{USP:"USP"},res:{ToGroupId:"groupID",RspBroadcastMsgList:"broadcastMessageList",IsSystemMsg:"isSystemMessage"}}}),this._map.set(I.AV_NOAUTH_POLLING,(e.a2,e.tinyid,{head:y(y({},g(e,vs)),{},{servcmd:"".concat(a.NAME.BIG_GRP_POLLING_NO_AUTH,".").concat(I.AV_POLLING)}),body:{USP:1,startSeq:1,holdTime:90,key:void 0,simplifiedMessage:void 0},keyMap:{req:{USP:"USP"},res:{ToGroupId:"groupID",RspBroadcastMsgList:"broadcastMessageList",IsSystemMsg:"isSystemMessage"}}})),this._map.set(I.GET_ONLINE_MBR_NUM,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.GRP,".").concat(I.GET_ONLINE_MBR_NUM)}),body:{groupID:void 0},keyMap:{res:{OnlineMemberNum:"memberCount"}}}),this._map.set(I.SET_GRP_ATTR,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.GRP,".").concat(I.SET_GRP_ATTR)}),body:{groupID:void 0,groupAttributeList:void 0,mainSequence:void 0,avChatRoomKey:void 0,attributeControl:["RaceConflict"]},keyMap:{req:{key:"key",value:"value"}}}),this._map.set(I.MODIFY_GRP_ATTR,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.GRP,".").concat(I.MODIFY_GRP_ATTR)}),body:{groupID:void 0,groupAttributeList:void 0,mainSequence:void 0,avChatRoomKey:void 0,attributeControl:["RaceConflict"]},keyMap:{req:{key:"key",value:"value"}}}),this._map.set(I.DEL_GRP_ATTR,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.GRP,".").concat(I.DEL_GRP_ATTR)}),body:{groupID:void 0,groupAttributeList:void 0,mainSequence:void 0,avChatRoomKey:void 0,attributeControl:["RaceConflict"]},keyMap:{req:{key:"key"}}}),this._map.set(I.CLEAR_GRP_ATTR,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.GRP,".").concat(I.CLEAR_GRP_ATTR)}),body:{groupID:void 0,mainSequence:void 0,avChatRoomKey:void 0,attributeControl:["RaceConflict"]}}),this._map.set(I.GET_GRP_ATTR,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.GRP_ATTR,".").concat(I.GET_GRP_ATTR)}),body:{groupID:void 0,avChatRoomKey:void 0,groupType:1},keyMap:{req:{avChatRoomKey:"Key",groupType:"GroupType"}}}),this._map.set(I.GET_GRP_NOTIFY,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.GRP,".").concat(I.GET_GRP_NOTIFY)}),body:{notifyReqList:[]},keyMap:{req:{notifyReqList:"NotifyReqList"},res:{NextMsgTime:"nextRevokedTime",NotifyMsgList:"notifyList",NotifyRspList:"notifyRspList"}}}),this._map.set(I.UPDATE_GRP_COUNTER,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.GRP,".").concat(I.UPDATE_GRP_COUNTER)}),body:{groupID:void 0,counterList:void 0,avChatRoomKey:void 0,mode:void 0},keyMap:{req:{counterList:"GroupCounter"}}}),this._map.set(I.GET_GRP_COUNTER,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.GRP,".").concat(I.GET_GRP_COUNTER)}),body:{groupID:void 0,keyList:[],avChatRoomKey:void 0},keyMap:{req:{keyList:"GroupCounterKeys"}}}),this._map.set(I.CREATE_TOPIC,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.GRP_COMMUNITY,".").concat(I.CREATE_TOPIC)}),body:{groupID:void 0,topicName:void 0,avatar:void 0,customData:void 0,topicID:void 0,notification:void 0,introduction:void 0},keyMap:{req:{avatar:"FaceUrl"}}}),this._map.set(I.DEL_TOPIC,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.GRP_COMMUNITY,".").concat(I.DEL_TOPIC)}),body:{groupID:void 0,topicIDList:void 0},keyMap:{req:{topicIDList:"TopicIdList"},res:{DestroyResultItem:"resultList"}}}),this._map.set(I.UPDATE_TOPIC_PROFILE,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.GRP_COMMUNITY,".").concat(I.UPDATE_TOPIC_PROFILE)}),body:{groupID:void 0,topicID:void 0,avatar:void 0,customData:void 0,notification:void 0,introduction:void 0,muteAllMembers:void 0,topicName:void 0},keyMap:{req:{avatar:"FaceUrl",muteAllMembers:"ShutUpAllMember"}}}),this._map.set(I.GET_TOPIC_LIST,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.GRP_COMMUNITY,".").concat(I.GET_TOPIC_LIST)}),body:{groupID:void 0,topicIDList:void 0,MemberInfoFilter:["NoUnreadSeqList"]},keyMap:{req:{topicIDList:"TopicIdList"},res:{TopicAndSelfInfo:"topicInfoList",TopicInfo:"topic",GroupID:"groupID",ShutUpTime:"muteTime",ShutUpAllFlag:"muteAllMembers",LastMsgTime:"lastMessageTime",MsgSeq:"readedSequence",LastMsgSeq:"sequence"}}}),this._map.set(I.GET_GRP_MBR_LIST,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.GRP,".").concat(I.GET_GRP_MBR_LIST)}),body:{groupID:void 0,limit:0,offset:void 0,next:void 0,memberRoleFilter:void 0,memberInfoFilter:void 0,memberCustomFieldFilter:void 0},keyMap:{req:{memberCustomFieldFilter:"AppDefinedDataFilter_GroupMember"},res:{AppMemberDefinedData:"memberCustomField",AppDefinedDataFilter_GroupMember:"memberCustomFieldFilter",MemberList:"members",ShutUpUntil:"muteUntil"}}}),this._map.set(I.GET_AV_MBR_LIST,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.GRP_AV,".").concat(I.GET_AV_MBR_LIST)}),body:{groupID:void 0,offset:void 0,filter:void 0},keyMap:{req:{offset:"Timestamp",filter:"Mark"},res:{NextTimestamp:"offset"}}}),this._map.set(I.GET_GRP_MBR_PROFILE,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.GRP,".").concat(I.GET_GRP_MBR_PROFILE)}),body:{groupID:void 0,userIDList:void 0,memberInfoFilter:void 0,memberCustomFieldFilter:void 0},keyMap:{req:{userIDList:"Member_List_Account",memberCustomFieldFilter:"AppDefinedDataFilter_GroupMember"},res:{MemberList:"members",ShutUpUntil:"muteUntil",AppDefinedDataFilter_GroupMember:"memberCustomFieldFilter",AppMemberDefinedData:"memberCustomField"}}}),this._map.set(I.ADD_GRP_MBR,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.GRP,".").concat(I.ADD_GRP_MBR)}),body:{groupID:void 0,silence:void 0,userIDList:void 0},keyMap:{req:{userID:"Member_Account",userIDList:"MemberList"},res:{MemberList:"members"}}}),this._map.set(I.DEL_GRP_MBR,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.GRP,".").concat(I.DEL_GRP_MBR)}),body:{groupID:void 0,userIDList:void 0,reason:void 0},keyMap:{req:{userIDList:"MemberToDel_Account"}}}),this._map.set(I.BAN_AV_MBR,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.GRP,".").concat(I.BAN_AV_MBR)}),body:{groupID:void 0,userIDList:void 0,duration:void 0,reason:""},keyMap:{req:{userIDList:"Members_Account",duration:"Duration",reason:"Description"}}}),this._map.set(I.MODIFY_GRP_MBR_INFO,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.GRP,".").concat(I.MODIFY_GRP_MBR_INFO)}),body:{groupID:void 0,topicID:void 0,userID:void 0,messageRemindType:void 0,nameCard:void 0,role:void 0,memberCustomField:void 0,muteTime:void 0},keyMap:{req:{userID:"Member_Account",memberCustomField:"AppMemberDefinedData",muteTime:"ShutUpTime",messageRemindType:"MsgFlag"}}}),this._map.set(I.MARK_AV_MBR_INFO,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.GRP_AV,".").concat(I.MARK_AV_MBR_INFO)}),body:{groupID:void 0,operationType:1,memberList:[]},keyMap:{req:{operationType:"CommandType",memberList:"MemberList",markType:"Marks",userID:"Member_Account"},res:{CommandType:"operationType",Marks:"markType",Member_Account:"userID"}}}),this._map.set(I.CS,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.MSG_SEARCH,".").concat(I.CS)}),body:{keywordList:void 0,keywordListMatchType:"or",account:void 0,groupID:void 0,count:100,cursor:void 0,messageTypeList:void 0,senderUserIDList:void 0,startTime:void 0,endTime:void 0},keyMap:{req:{keywordListMatchType:"MatchType",account:"PeerAccount",groupID:"GroupID",messageTypeList:"MsgTypeList",senderUserIDList:"SendUserIDList",keywords:"Keywords",keywordMatchType:"KeywordMatchType",count:"Count",miniBirthday:"UserBirthStart",maxBirthday:"UserBirthEnd",gender:"UserGenderType",groupTypeList:"GroupType",groupIDList:"GroupIdList"},res:{GroupID:"groupID",UserID:"userID",ErrorCode:"code",ErrorInfo:"message",TotalCount:"totalCount",Count:"messageCount",LastMsgTime:"lastMessageTime",ConversationMsgs:"searchResult",IsNeedReadReceipt:"needReadReceipt",IsPeerRead:"readReceiptSentByPeer",MsgSeq:"sequence",ReqMsgSeq:"sequence",IsSystemMsg:"isSystemMessage",ToGroupId:"to",EnumFrom_AccountType:"fromAccountType",EnumTo_AccountType:"toAccountType",GroupCode:"groupCode",MsgContent:"content",ClientSeq:"clientSequence",ToTopicId:"topicID",InvisibleMsgSeq:"invisibleSequenceList",Users:"userList",ProfileItems:"profileItems",StrValue:"value",IntValue:"value",Groups:"groupList",GroupFaceUrl:"avatar",GroupIntroduction:"introduction",GroupOwnerUserID:"ownerID",GroupOwnerUserName:"ownerNick",GroupOwnerTinyID:"ownerTinyID",GroupMemberNum:"memberNum",GroupName:"name",GroupType:"type",GroupMembers:"groupMemberList",GroupMemberUserID:"userID",GroupMemberTinyID:"userTinyID",GroupMemberUserName:"nick",GroupMemberNameCard:"nameCard"}}}),this._map.set(I.USER_CS,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.USER_SEARCH,".").concat(I.CS)}),body:{keywords:void 0,keywordMatchType:0,miniBirthday:void 0,maxBirthday:void 0,gender:void 0,count:20,cursor:void 0}}),this._map.set(I.GRP_CS,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.GRP_SEARCH,".").concat(I.CS)}),body:{keywords:void 0,keywordMatchType:0,groupType:void 0,count:20,cursor:void 0}}),this._map.set(I.MBR_CS,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.GRP_MEMBER_SEARCH,".").concat(I.CS)}),body:{keywords:void 0,keywordMatchType:0,groupType:void 0,groupIDList:void 0,count:20,cursor:void 0}}),this._map.set(I.SSO_STAT,{head:y(y({},n),{},{servcmd:"".concat(a.NAME.IM_OPEN_STAT,".").concat(I.SSO_STAT)}),body:{header:{},event:[],quality:[]},keyMap:{req:{SDKType:"sdk_type",SDKVersion:"sdk_version",deviceType:"device_type",platform:"platform",instanceID:"instance_id",traceID:"trace_id",SDKAppID:"sdk_app_id",userID:"user_id",tinyID:"tiny_id",extension:"extension",timestamp:"timestamp",networkType:"network_type",eventType:"event_type",code:"error_code",message:"error_message",moreMessage:"more_message",duplicate:"duplicate",costTime:"cost_time",level:"level",qualityType:"quality_type",reportIndex:"report_index",wholePeriod:"whole_period",totalCount:"total_count",rttCount:"success_count_business",successRateOfRequest:"percent_business",countLessThan1Second:"success_count_business",percentOfCountLessThan1Second:"percent_business",countLessThan3Second:"success_count_platform",percentOfCountLessThan3Second:"percent_platform",successCountOfBusiness:"success_count_business",successRateOfBusiness:"percent_business",successCountOfPlatform:"success_count_platform",successRateOfPlatform:"percent_platform",successCountOfMessageReceived:"success_count_business",successRateOfMessageReceived:"percent_business",avgRTT:"average_value",avgDelay:"average_value",avgValue:"average_value",uiPlatform:"ui_platform"}}}),this._map.set(I.PING,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.HEARTBEAT,".").concat(I.PING)}),body:{}}),this._map.set(I.MSG_PUSH,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.IM_OPEN_PUSH,".").concat(I.MSG_PUSH)}),body:{},keyMap:{res:{C2cMsgArray:"C2CMessageArray",GroupMsgArray:"groupMessageArray",GroupTips:"groupTips",C2cNotifyMsgArray:"C2CNotifyMessageArray",C2cMsgInfo:"C2CReadReceiptArray",ClientSeq:"clientSequence",MsgPriority:"priority",NoticeSeq:"noticeSequence",MsgContent:"content",MsgType:"type",MsgBody:"elements",ToGroupId:"to",Desc:"description",Ext:"extension",IsSyncMsg:"isSyncMessage",Flag:"needSync",NeedAck:"needAck",PendencyAdd_Account:"userID",ProfileImNick:"nick",PendencyType:"applicationType",C2CReadAllMsg:"readAllC2CMessage",IsNeedReadReceipt:"needReadReceipt",Status:"statusType"}}}),this._map.set(I.MULTI_MSG_PUSH,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.IM_OPEN_PUSH,".").concat(I.MULTI_MSG_PUSH)}),body:{},keyMap:{res:{GroupMsgArray:"groupMessageArray",GroupTips:"groupTips",ClientSeq:"clientSequence",MsgPriority:"priority",NoticeSeq:"noticeSequence",MsgContent:"content",MsgType:"type",MsgBody:"elements",ToGroupId:"to",Desc:"description",Ext:"extension",IsSyncMsg:"isSyncMessage",Flag:"needSync",NeedAck:"needAck",PendencyType:"applicationType"}}}),this._map.set(I.MSG_PUSH_ACK,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.OPEN_IM,".").concat(I.MSG_PUSH_ACK)}),body:{sessionData:void 0},keyMap:{req:{sessionData:"SessionData"}}}),this._map.set(I.STATUS_FORCE_OFFLINE,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.IM_OPEN_STATUS,".").concat(I.STATUS_FORCE_OFFLINE)}),body:{},keyMap:{res:{C2cNotifyMsgArray:"C2CNotifyMessageArray",NoticeSeq:"noticeSequence",KickoutMsgNotify:"kickoutMsgNotify",NewInstInfo:"newInstanceInfo"}}}),this._map.set(I.DOWNLOAD_MERGER_MSG,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.IM_LONG_MSG,".").concat(I.DOWNLOAD_MERGER_MSG)}),body:{downloadKey:""},keyMap:{res:{Data:"data",Desc:"description",Ext:"extension",Download_Flag:"downloadFlag",ThumbUUID:"thumbUUID",VideoUUID:"videoUUID"}}}),this._map.set(I.UPLOAD_MERGER_MSG,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.IM_LONG_MSG,".").concat(I.UPLOAD_MERGER_MSG)}),body:{messageList:[]},keyMap:{req:{fromAccount:"From_Account",toAccount:"To_Account",msgTimeStamp:"MsgTimeStamp",msgSeq:"MsgSeq",msgRandom:"MsgRandom",msgBody:"MsgBody",type:"MsgType",content:"MsgContent",data:"Data",description:"Desc",extension:"Ext",sizeType:"Type",uuid:"UUID",url:"",imageUrl:"URL",fileUrl:"Url",remoteAudioUrl:"Url",remoteVideoUrl:"VideoUrl",thumbUUID:"ThumbUUID",videoUUID:"VideoUUID",videoUrl:"",downloadFlag:"Download_Flag",from:"From_Account",time:"MsgTimeStamp",messageRandom:"MsgRandom",messageSequence:"MsgSeq",elements:"MsgBody",clientSequence:"ClientSeq",payload:"MsgContent",messageList:"MsgList",messageNumber:"MsgNum",abstractList:"AbstractList",messageBody:"MsgBody"}}}),this._map.set(I.FOLLOW,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.FOLLOW,".").concat(I.FOLLOW)}),body:{fromAccount:"",userIDList:[]},keyMap:{req:{userIDList:"FollowItem"},res:{ResultItem:"resultList",To_Account:"userID"}}}),this._map.set(I.UNFOLLOW,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.FOLLOW,".").concat(I.UNFOLLOW)}),body:{fromAccount:"",userIDList:[]},keyMap:{req:{userIDList:"To_Account"},res:{ResultItem:"resultList",To_Account:"userID"}}}),this._map.set(I.GET_FOLLOW_INFO,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.FOLLOW,".").concat(I.GET_FOLLOW_INFO)}),body:{fromAccount:"",userIDList:[]},keyMap:{req:{userIDList:"To_Account"},res:{FollowInfo:"followInfoList",To_Account:"userID",FollowerCount:"followersCount",FollowingCount:"followingCount",MutualFollowingCount:"mutualFollowersCount"}}}),this._map.set(I.GET_FOLLOW,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.FOLLOW,".").concat(I.GET_FOLLOW)}),body:{fromAccount:"",type:1,nextCursor:"",count:500},keyMap:{req:{type:"FollowType",nextCursor:"StartCursor",count:"WantNum"},res:{FollowItem:"resultList",To_Account:"userID",ProfileItem:"profileList"}}}),this._map.set(I.CHECK_FOLLOW_TYPE,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.FOLLOW,".").concat(I.CHECK_FOLLOW_TYPE)}),body:{fromAccount:"",userIDList:[]},keyMap:{req:{userIDList:"To_Account"},res:{ResultItem:"resultList",To_Account:"userID"}}}),this._map.set(I.SET_TOKEN,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.IM_OPEN_STATUS,".").concat(I.SET_TOKEN)}),body:{tokenID:"",pushMsg:0,sdkAppID:0,businessID:"",deviceBrand:"",deviceToken:"",isTpns:0,isWebUniapp:0,notificationStatus:0,deviceModel:"",systemVersion:"",pushVersion:""},keyMap:{req:{tokenID:"TokenID",pushMsg:"PushMsg",sdkAppID:"EnterVersion",businessID:"BusiID",deviceBrand:"InstType",deviceToken:"VarToken",isTpns:"IsTpns",notificationStatus:"NotificationStatus",deviceModel:"DeviceModel",systemVersion:"SystemVersion",pushVersion:"PushPluginVersion"}}}),this._map.set(I.STAT_FOREGROUND,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.IM_OPEN_STATUS,".").concat(I.STAT_FOREGROUND)}),body:{isWebUniapp:0}}),this._map.set(I.STAT_BACKGROUND,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.IM_OPEN_STATUS,".").concat(I.STAT_BACKGROUND)}),body:{C2CUnread:0,GroupUnread:0,isWebUniapp:0},keyMap:{req:{c2cUnreadCount:"C2cUnread",groupUnreadCount:"GrpUnread"}}}),this._map.set(I.PUSH_REPORT,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.OFFLINE_PUSH_REPORT,".").concat(I.PUSH_REPORT)}),body:{eventList:[]},keyMap:{req:{eventList:"UinappPushEvents",type:"EventType",time:"EventTime",pushId:"ClickExt"}}}),this._map.set(I.SET_ALL_RECEIVE_MSG_OPT,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.IM_MSG_LOGIC,".").concat(I.SET_ALL_RECEIVE_MSG_OPT)}),body:{startTime:0,endTime:0,isRepeated:0,messageRemindType:0},keyMap:{req:{messageRemindType:"Level"}}}),this._map.set(I.GET_ALL_RECEIVE_MSG_OPT,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.IM_MSG_LOGIC,".").concat(I.GET_ALL_RECEIVE_MSG_OPT)}),body:{toAccount:void 0}});}},{key:"has",value:function(e){return this._map.has(e)}},{key:"get",value:function(e){return this._map.get(e)}},{key:"update",value:function(){this._fillMap();}},{key:"getKeyMap",value:function(e){return this.has(e)?this.get(e).keyMap||{}:(v.w("".concat(this._n,".getKeyMap unknown P:").concat(e)),{})}},{key:"getProtocolData",value:function(e){var t=e.P,n=e.data,e=this.get(t),t=null;if(n){var o,i=this._simpleDeepCopy(e),i=this._updateService(n,i),a=i.body,s=Object.create(null);for(o in a)if(Object.prototype.hasOwnProperty.call(a,o)){if(s[o]=a[o],void 0===n[o])continue;s[o]=n[o];}i.body=s,t=this._getUplinkData(i);}else t=this._getUplinkData(e);return t}},{key:"_getUplinkData",value:function(e){var e=this._dataCleaner(e),t=qt(e.head),t=os(e.body,this._getReqKeyMap(t));return e.body=t,e}},{key:"_updateService",value:function(e,t){var n,o,i=qt(t.head);return this._isFromGroupRequest(t)&&(n=e.type,o=e.groupID,e=void 0===(e=e.groupIDList)?[]:e,A(o=void 0===o?void 0:o)&&(o=e[0]||""),St({type:n,groupID:o})&&(t.head.servcmd="".concat(a.NAME.GRP_COMMUNITY,".").concat(i))),t}},{key:"_isFromGroupRequest",value:function(e){return e.head.servcmd.includes(a.NAME.GRP)||e.head.servcmd.includes(a.NAME.GRP_ATTR)}},{key:"_getReqKeyMap",value:function(e){e=this.getKeyMap(e);return y(y({},Ja.req),e.req)}},{key:"_dataCleaner",value:function(e){var t,n=Array.isArray(e)?[]:Object.create(null);for(t in e)Object.prototype.hasOwnProperty.call(e,t)&&st(t)&&null!==e[t]&&void 0!==e[t]&&("object"!==r(e[t])?n[t]=e[t]:n[t]=this._dataCleaner.bind(this)(e[t]));return n}},{key:"_simpleDeepCopy",value:function(e){for(var t,n=Object.keys(e),o={},i=0,a=n.length;i<a;i++)t=n[i],nt(e[t])?o[t]=Array.from(e[t]):$e(e[t])?o[t]=this._simpleDeepCopy(e[t]):o[t]=e[t];return o}}]),ks),Ms=[I.MSG_PUSH_ACK],ys=(e(Ss,[{key:"_onC2CMsgArray",value:function(e){var t=this._sessionM.get(6);e.dataList.forEach(function(e){var t;1===e.isSyncMessage&&(t=e.from,e.from=e.to,e.to=t);}),1===e.needSync&&this._sessionM.get(19).syncOnNeed(),t.onNewMessage({dataList:e.dataList,isInstantMessage:!0});}},{key:"_onC2CMsgModified",value:function(e){this._sessionM.get(6).onMsgModified(e);}},{key:"_onGroupMsgArray",value:function(e){var t=this._sessionM.get(7);t&&t.onNewMessage({event:e.event,dataList:e.dataList,isInstantMessage:!0});}},{key:"_onGroupMsgModified",value:function(e){var t=this._sessionM.get(7);t&&t.onMsgModified(e);}},{key:"_onGroupTips",value:function(e){var t=this._sessionM.get(7);if(t){var n=e.event,o=e.dataList,i=e.isInstantMessage,a=void 0===i||i,s=e.isSyncingEnded;switch(n){case 4:case 6:t.onNewGroupTips({event:n,dataList:o});break;case 5:for(var r=0;r<o.length;r++)if(nt(o[r].elements.revokedInfos))t.onMsgRevoked({dataList:o});else if(nt(o[r].elements.groupMessageReadNotice))t.onMsgReadNotice({dataList:o});else {if(!nt(o[r].elements.readReceiptList)){t.onNewGroupSystemNotice({dataList:o,isInstantMessage:a,isSyncingEnded:s});break}t.onReadReceiptList({dataList:o});}break;case 12:this._sessionM.get(11).onNewGroupAtTips({dataList:o});break;default:v.l("".concat(this._n,"._onGroupTips unknown event:").concat(n," dataList:"),o);}}}},{key:"_onC2CNotifyMsgArray",value:function(e){var o,i=this,a=e.dataList;nt(a)&&(o=this._sessionM.get(6),a.forEach(function(e){var t,n;et(e)&&(e.hasOwnProperty("kickoutMsgNotify")?(t=(n=e.kickoutMsgNotify).kickType,n=void 0===(n=n.newInstanceInfo)?{}:n,1===t?i._sessionM.onMultipleAccountKickedOut(n):2===t?i._sessionM.onMultipleDeviceKickedOut(n):3===t&&i._sessionM.onRestApiKickedOut(n)):e.hasOwnProperty("c2cMessageRevokedNotify")?o&&o.onMsgRevoked({dataList:a}):e.hasOwnProperty("c2cMessageReadReceipt")?o&&o.onMsgReadReceipt({dataList:a}):e.hasOwnProperty("c2cMessageReadNotice")?o&&o.onMsgReadNotice({dataList:a}):e.hasOwnProperty("muteNotificationsSync")&&i._sessionM.get(11).onC2CMsgRemindTypeSynced({dataList:a}));}));}},{key:"_onC2CReadReceiptArray",value:function(e){this._sessionM.get(6).onReadReceiptList(e);}},{key:"_onProfileModified",value:function(e){this._sessionM.get(4).onProfileModified({dataList:e.dataList});var t=this._sessionM.get(8);t&&t.onFriendProfileModified({dataList:e.dataList});}},{key:"_onRelationChainModified",value:function(e){this._sessionM.get(4).onRelationChainModified({dataList:e.dataList});var t=this._sessionM.get(8);t&&t.onRelationChainModified({dataList:e.dataList});}},{key:"_onRecentContact",value:function(e){var i,e=e.dataList;!nt(e)||(i=this._sessionM.get(11))&&e.forEach(function(e){var t,n,o=e.pushType;1===o?(t=e.recentContactDeleteItem,i.onConvDeleted(t.recentContactList)):2===o?(t=e.recentContactTopItem,i.onConvPinnedStatus(t.recentContactList,!0)):3===o?(t=e.recentContactTopItem,i.onConvPinnedStatus(t.recentContactList,!1)):4===o?(t=e.recentContactMarkContact,i.onConvMarkUpdated(t.recentContactMarkContactItem)):5===o?(t=e.recentContactCreateContactGroup,i.onConvGroupCreated(t.msgContactGroupContactItem)):6===o?(t=e.recentContactDelContactGroup,i.onConvGroupDeleted(t.msgGroupItem)):7===o&&(o=(t=e.recentContactUpdateContactGroup).updateType,e=t.msgUpdateGroup,t=t.msgUpdateContact,1===o?1===(n=e.updateGroupType)?i.onConvGroupNameUpdated(e):2===n&&i.onConvInGroupUpdated(e):2===o&&i.onConvAddedToOrDeletedFromGroup(t));});}},{key:"_onAllMsgRead",value:function(e){var e=e.dataList,t=this._sessionM.get(11);t&&t.onPushedAllMessageRead(e);}},{key:"_onUserStatusList",value:function(e){this._sessionM.get(4).onUserStatusUpdated(e);}},{key:"_onMsgExtNotify",value:function(e){this._sessionM.get(3).onMsgExtNotify(e);}},{key:"_onMsgReactionNotifyList",value:function(e){this._sessionM.get(34).onReactionNotifyList(e);}},{key:"_onMsgReactionNotify",value:function(e){this._sessionM.get(34).onReactionNotify(e);}},{key:"_onFollowNotify",value:function(e){this._sessionM.get(35).onFollowNotify(e);}},{key:"_onTopicLatestMsg",value:function(e){this._sessionM.get(10).onTopicLatestMsg(e);}},{key:"onMessage",value:function(e){var t=this,n=e.body;if(this._filterMsgFromIMOpenPush(e)){var o,i=n.eventArray,a=n.isInstantMessage,l=n.isSyncingEnded,d=n.needSync;if(nt(i))for(var s,r,c,u=0,p=i.length;u<p;u++)100!==(c=(s=i[u]).event)?24!==c?26!==c?(o=Object.keys(s).find(function(e){return -1!==t._keys.indexOf(e)}))?(r=14===c?{readAllC2CMessage:s[o],groupMessageReadInfoList:s.groupMessageReadNotice||[]}:16===c?{userID:s.userID,timestamp:s.timestamp,readReceiptList:s[o]}:s[o],this._eventHandlerMap.get(o)({event:c,dataList:r,isInstantMessage:a,isSyncingEnded:l,needSync:d})):v.l("".concat(this._n,".onMessage unknown eventItem:"),s):this._onTopicLatestMsg(s):this._onAllRcvMsgOptNotify(s):this._onRoomCustomData(s.content);}}},{key:"_onRoomCustomData",value:function(e){this._sessionM.get(30).onRoomCustomDataReceived(e),v.l("".concat(this._n,"._onRoomCustomData data:").concat(e));}},{key:"_onAllRcvMsgOptNotify",value:function(e){this._sessionM.get(11).onAllRcvMsgOptNotify(e);}},{key:"_filterMsgFromIMOpenPush",value:function(e){var t=e.head,e=e.body,t=t.servcmd,n=!1;return !(n=A(t)?n:t.includes(a.NAME.IM_CONFIG_MANAGER)||t.includes(a.NAME.OVERLOAD_PUSH)||t.includes(a.NAME.STAT_SERVICE))||(t.includes(I.PUSHED_CLOUD_CTRL_CONFIG)?this._sessionM.get(23).onPushedConfig(e):t.includes(I.PUSHED_COMMERCIAL_CONFIG)?this._sessionM.get(27).onPushedConfig(e):t.includes(I.OVERLOAD_NOTIFY)?this._sessionM.onPushedServerOverload(e):t.includes(I.KICK_OTHER)&&(n=Date.now(),this._sessionM.reLoginOnKickOther(),e=new M("kickOther"),n=n-(t=this._sessionM.get(1).getLastWsHelloTs()),e.setMessage("last wshello time:".concat(t," diff:").concat(n,"ms")).end()),!1)}}]),Ss),Cs=[{cmd:I.GET_GRP_PROFILE,interval:1,count:8},{cmd:I.UPDATE_GRP_PROFILE,interval:1,count:8},{cmd:I.GET_AV_MBR_LIST,interval:3,count:1},{cmd:I.GET_GRP_PENDENCY,interval:1,count:15},{cmd:I.GET_TOPIC_LIST,interval:1,count:10},{cmd:I.SET_GRP_ATTR,interval:5,count:10},{cmd:I.MODIFY_GRP_ATTR,interval:5,count:10},{cmd:I.DEL_GRP_ATTR,interval:5,count:10},{cmd:I.CLEAR_GRP_ATTR,interval:5,count:10},{cmd:I.GET_GRP_ATTR,interval:5,count:20},{cmd:I.UPDATE_GRP_COUNTER,interval:5,count:20},{cmd:I.GET_GRP_COUNTER,interval:5,count:20},{cmd:I.SET_ALL_MSG_READ,interval:1,count:1},{cmd:I.GET_USER_STATUS,interval:5,count:20},{cmd:I.SUB_USER_STATUS,interval:5,count:20},{cmd:I.UNSUB_USER_STATUS,interval:5,count:20},{cmd:I.CS,interval:5,count:20},{cmd:I.GRP_CS,interval:5,count:20},{cmd:I.MBR_CS,interval:5,count:20},{cmd:I.USER_CS,interval:5,count:20},{cmd:I.CHECK_FOLLOW_TYPE,interval:5,count:20},{cmd:I.GET_GRP_ROAMING_MSG,interval:1,count:20},{cmd:I.GET_C2C_ROAMING_MSG,interval:1,count:20}],Ts=new Map,Ds=["0","1","2","3","4","5","6","7","8","9","A","B","C","D","E","F"],Es=0,Ls=Ds.length;Es<Ls;Es++)Ts.set(Es,Ds[Es]);function Ss(e){d(this,Ss),this._sessionM=e,this._n="MsgDispatcher",this._eventHandlerMap=new Map,this._eventHandlerMap.set("C2CMessageArray",this._onC2CMsgArray.bind(this)),this._eventHandlerMap.set("groupMessageArray",this._onGroupMsgArray.bind(this)),this._eventHandlerMap.set("groupTips",this._onGroupTips.bind(this)),this._eventHandlerMap.set("C2CNotifyMessageArray",this._onC2CNotifyMsgArray.bind(this)),this._eventHandlerMap.set("C2CReadReceiptArray",this._onC2CReadReceiptArray.bind(this)),this._eventHandlerMap.set("profileModify",this._onProfileModified.bind(this)),this._eventHandlerMap.set("friendListMod",this._onRelationChainModified.bind(this)),this._eventHandlerMap.set("recentContactMod",this._onRecentContact.bind(this)),this._eventHandlerMap.set("readAllC2CMessage",this._onAllMsgRead.bind(this)),this._eventHandlerMap.set("c2cMessageModified",this._onC2CMsgModified.bind(this)),this._eventHandlerMap.set("groupMessageModified",this._onGroupMsgModified.bind(this)),this._eventHandlerMap.set("userStatusList",this._onUserStatusList.bind(this)),this._eventHandlerMap.set("messageExtensionNotify",this._onMsgExtNotify.bind(this)),this._eventHandlerMap.set("messageReactionNotifyList",this._onMsgReactionNotifyList.bind(this)),this._eventHandlerMap.set("messageReactionNotify",this._onMsgReactionNotify.bind(this)),this._eventHandlerMap.set("followChangeList",this._onFollowNotify.bind(this)),this._keys=D(this._eventHandlerMap.keys());}function ks(e){d(this,ks),this._n="PHandler",this._sessionM=e,this._map=new Map,this._fillMap();}function Rs(e){return d(this,Rs),(e=is.call(this,e))._n="ChannelModule",e._socketHandler=new hs(h(e)),e._probing=!1,e._isAppShowing=!0,e._previousState=R.NET_STATE_CONNECTED,e._timerForNotLoggedIn=-1,e._timerForNotLoggedIn=setInterval(e.onCheckTimer.bind(h(e)),1e3),e._fatalErrorFlag=!1,e._disconnectedTS=0,e._lastDiagnoseTS=0,e}function As(e){d(this,As),this._chM=e,this._n="SocketHandler",this._promiseMap=new Map,this._readyState=_s,this._simpleRequestMap=new Map,this.MAX_SIZE=100,this._startSequence=lt(),this._startTs=0,this._reConnectFlag=!1,this._nextPingTs=0,this._reConnectCount=0,this.MAX_RECONNECT_COUNT=3,this._socketID=-1,this._random=0,this._socket=null,this._url="",this._onOpenTs=0,this._canIUseBinaryFrame=!0,this._isWorkerEnabled=!0,this._currentSite=V,this._setWebsocketHost(),this._initConnection();}function Os(e){d(this,Os);var t,i,n=(this._handler=e).getURL();this._socket=null,this._workerSocket=null,this._id=lt(),this._handler.getIsWorkerEnabled()?(t=URL.createObjectURL(new Blob([';let _socket = null;onmessage = function(event) {  if (event.data.cmd === "start") {    const url = event.data.url;    _socket = new WebSocket(url);    _socket.binaryType = "arraybuffer";    _socket.onopen = function() {      postMessage({ callback: "onOpen", extensions: _socket.extensions });    };    _socket.onclose = function(e) {      postMessage({ callback: "onOpen", e: { code: e.code, reason: e.reason } });    };    _socket.onmessage = function(e) {      postMessage({ callback: "onMessage", data: e.data });    };    _socket.onerror = function(e) {      postMessage({ callback: "onError", e: { isTrusted: "true" } });    };  } else if (event.data.cmd === "sendMessage") {    if (_socket !== null) {      _socket.send(event.data.data);    }  } else if (event.data.cmd === "stop") {    if (_socket !== null) {      _socket.close(event.data.code);      _socket = null;    }  }};'],{type:"application/javascript; charset=utf-8"})),this._workerSocket=new Worker(t),(i=this)._workerSocket.onmessage=function(e){var t=e.data,n=t.callback,o=t.e,t=t.extensions;"onOpen"===n?i._onOpen(t):"onClose"===n?i._onClose(o):"onError"===n?i._onError(o):"onMessage"===n&&i._onMessage(e.data);},this._workerSocket.postMessage({cmd:"start",id:this._id,url:n})):ae?ee?(ue.connectSocket({url:n,header:{"content-type":"application/json"}}),ue.onSocketClose(this._onClose.bind(this)),ue.onSocketOpen(this._onOpen.bind(this)),ue.onSocketMessage(this._onMessage.bind(this)),ue.onSocketError(this._onError.bind(this))):(this._socket=ue.connectSocket({url:n,header:{"content-type":"application/json"},complete:function(){}}),this._socket.onClose(this._onClose.bind(this)),this._socket.onOpen(this._onOpen.bind(this)),this._socket.onMessage(this._onMessage.bind(this)),this._socket.onError(this._onError.bind(this))):(this._socket=new WebSocket(n),this._socket.binaryType="arraybuffer",this._socket.onopen=this._onOpen.bind(this,this._socket.extensions),this._socket.onmessage=this._onMessage.bind(this),this._socket.onclose=this._onClose.bind(this),this._socket.onerror=this._onError.bind(this)),this._canIUseBinaryFrame=e.canIUseBinaryFrame();}function Ns(e){for(var t,n,o=e,i="",a=0,s=(o=e.length%8!=0?"0".repeat(8-e.length%8)+e:o).length;a<s;a+=8)t=parseInt(o.slice(a,a+4),2),n=parseInt(o.slice(a+4,a+8),2),i+=Ts.get(t)+Ts.get(n);return i}function Gs(e){if(e<0||53<e)return NaN;var t=0|1073741824*Math.random();return 30<e?t+1073741824*(0|Math.random()*(1<<e-30)):t>>>30-e}function Ps(e,t){for(var n=e.toString(16),o=t-n.length,i="0";0<o;o>>>=1,i+=i)1&o&&(n=i+n);return n}t($r,wn),Ys=f($r),e($r,[{key:"_init",value:function(){this._updateCmdFreqLimitMap(Cs);}},{key:"_onCloudConfig",value:function(){var e=this.getCloudConfig("cmd_frequency_limit");A(e)||(e=JSON.parse(e),this._updateCmdFreqLimitMap(e));}},{key:"_updateCmdFreqLimitMap",value:function(e){var t=this;e.forEach(function(e){t._cmdFreqLimitMap.set(e.cmd,{interval:e.interval,count:e.count});});}},{key:"updateProtocolConfig",value:function(){this._pHandler.update();}},{key:"req",value:function(e){v.d("".concat(this._n,".req options:"),e);var t=e.P;if(!this._pHandler.has(t))return v.w("".concat(this._n,".req unknown P:").concat(t)),C({code:T.NO_PROTOCOL});var e=this.getProtocolData(e),n=e.head.servcmd;if(this._isFreqOverLimit(n))return C({code:o=T.OVER_FREQUENCY_LIMIT,message:this.getErrMsg(o,this._getCmd(n))});if(this._isServerOverload(n))return C({code:o=T.OPEN_SERVICE_OVERLOAD_ERROR,message:this.getErrMsg(o,this._getCmd(n))});var o=this.get(21);return Ms.includes(t)?o.simplySend(e):o.send(e)}},{key:"getKeyMap",value:function(e){return this._pHandler.getKeyMap(e)}},{key:"genCommonHead",value:function(){var e=this.get(12);return {ver:"v4",platform:this._platform,websdkappid:x,websdkversion:q,a2:e.getA2Key()||void 0,tinyid:e.getTinyID()||void 0,status_instid:e.getStatusInstanceID(),sdkappid:e.getSDKAppID(),contenttype:e.getContentType(),reqtime:0,identifier:e.getA2Key()?void 0:e.getUserID(),usersig:e.getA2Key()?void 0:e.getUserSig(),sdkability:12775283,sdkability_ext:Ns(""),cappid:e.getApplicationID(),cs:0}}},{key:"genCosSpecifiedHead",value:function(){var e=this.get(12);return {ver:"v4",platform:this._platform,websdkappid:x,websdkversion:q,sdkappid:e.getSDKAppID(),contenttype:e.getContentType(),reqtime:0,identifier:e.getUserID(),usersig:e.getUserSig(),status_instid:e.getStatusInstanceID(),sdkability:12775283,sdkability_ext:Ns(""),cappid:e.getApplicationID(),cs:0}}},{key:"genSSOReportHead",value:function(){var e=this.get(12);return {ver:"v4",platform:this._platform,websdkappid:x,websdkversion:q,sdkappid:e.getSDKAppID(),contenttype:"",reqtime:0,identifier:"",usersig:"",status_instid:e.getStatusInstanceID(),sdkability:12775283,sdkability_ext:Ns(""),cappid:e.getApplicationID(),cs:0}}},{key:"getProtocolData",value:function(e){return this._pHandler.getProtocolData(e)}},{key:"trans",value:function(e){var t=e.servcmd,e=e.data,t={head:y(y({},this.genCommonHead()),{},{servcmd:t}),body:e};return this.get(21).send(t)}},{key:"sendComboMessage",value:function(e){var t=e.servcmd,e=e.data,t={head:y(y({},this.genCommonHead()),{},{servcmd:t}),body:e};return this.get(21).send(t)}},{key:"onErrorCodeNotZero",value:function(e){var t,n=e.errorCode;n===T.HELLO_ANSWER_KICKED_OUT&&(t=e.kickType,e=void 0===(e=e.newInstanceInfo)?{}:e,1===t?this.onMultipleAccountKickedOut(e):2===t?this.onMultipleDeviceKickedOut(e):3===t&&this.onRestApiKickedOut(e)),n!==T.MSG_A2KEY_EXPIRED&&n!==T.ACCOUNT_A2KEY_EXPIRED||(this._onUserSigExpired(),this.get(21).reConnect());}},{key:"onMessage",value:function(e){var t=e.body,n=t.needAck,t=t.sessionData;1===(void 0===n?0:n)&&this._sendACK(t),this._msgDispatcher.onMessage(e);}},{key:"onReconnected",value:function(e){this._incrementalPullContactFlag=e<=300,this._reLoginOnReconnected();}},{key:"reLoginOnKickOther",value:function(){v.l("".concat(this._n,".reLoginOnKickOther")),this._reLogin();}},{key:"_reLoginOnReconnected",value:function(){v.l("".concat(this._n,"._reLoginOnReconnected")),this._reLogin();}},{key:"_reLogin",value:function(){var e,t,s,r=this,c="".concat(this._n,"._reLogin");this.isLoggedIn()&&(e=0,(t=this.get(1).getPushModule())&&(e=t.getUniAppPlatform()),s=new M("reLogin"),this.req({P:I.LOGIN,data:{isWebUniapp:e,customInfo:this.get(12).getCustomLoginInfo()}}).then(function(e){var e=e.data,t=e.instanceID,e=e.customStatus,n=r.get(12),o=Qo(e),i=(n.setStatusInstanceID(t),r.get(21)),a=i.getSocketID(),a="socketID:".concat(a," instanceID:").concat(t," customStatus:").concat(o),t=(s.setMessage(a).end(!0),v.l("".concat(c," ok. ").concat(a)),n.getCustomStatus()!==o&&r.get(4).onUserStatusUpdated({dataList:[{to:r.getMyUserID(),statusType:R.USER_STATUS_ONLINE,customStatus:e}]}),i.diagnose(),r.get(11).syncConvList(r._incrementalPullContactFlag).then(function(){v.l("".concat(c,", sync conv list ok.")),r.get(25).start();}),r.get(7)),a=(t&&t.updateLocalMainSequenceOnReconnected(),r.get(10)),n=(a.resetGetTopicTime(),a.getTopicListOnReconnected(),r.get(35));n&&n.clearCacheOnReconnected();}));}},{key:"onMultipleAccountKickedOut",value:function(e){this.get(1).onMultipleAccountKickedOut(e);}},{key:"onMultipleDeviceKickedOut",value:function(e){this.get(1).onMultipleDeviceKickedOut(e);}},{key:"_onUserSigExpired",value:function(){this.get(1).onUserSigExpired();}},{key:"onRestApiKickedOut",value:function(e){this.get(1).onRestApiKickedOut(e);}},{key:"_sendACK",value:function(e){this.req({P:I.MSG_PUSH_ACK,data:{sessionData:e}});}},{key:"_isFreqOverLimit",value:function(e){e=e.split(".")[1];if(!this._cmdFreqLimitMap.has(e))return !1;if(!this._cmdReqInfoMap.has(e))return this._cmdReqInfoMap.set(e,{startTime:Date.now(),requestCount:1}),!1;var t=this._cmdFreqLimitMap.get(e),n=t.count,t=t.interval,o=this._cmdReqInfoMap.get(e),i=o.startTime,o=o.requestCount;return Date.now()-i>1e3*t?(this._cmdReqInfoMap.set(e,{startTime:Date.now(),requestCount:1}),!1):(this._cmdReqInfoMap.set(e,{startTime:i,requestCount:o+=1}),n<o)}},{key:"_isServerOverload",value:function(e){if(!this._serverOverloadInfoMap.has(e))return !1;var t=this._serverOverloadInfoMap.get(e),n=t.overloadTime,t=t.waitingTime;return Date.now()-n<=1e3*t||(this._serverOverloadInfoMap.delete(e),!1)}},{key:"_getCmd",value:function(e){var t="";if(!e.includes("."))return t;var n,o=e.split(".")[1];for(n in I)if(I[n]===o){t=n;break}return t}},{key:"onPushedServerOverload",value:function(e){var t=e.overloadCommand,e=e.waitingTime;this._serverOverloadInfoMap.set(t,{overloadTime:Date.now(),waitingTime:e}),v.w("".concat(this._n,".onPushedServerOverload waitingTime:").concat(e,"s cmd:").concat(this._getCmd(t)));}},{key:"reset",value:function(){v.l("".concat(this._n,".reset")),this._updateCmdFreqLimitMap(Cs),this._cmdReqInfoMap.clear(),this._serverOverloadInfoMap.clear(),this._incrementalPullContactFlag=!0;}}]);var Us,bs,ws,Fs,qs,xs,Vs,Hs,Bs,Ks,Ys,Ws=$r,js=(t(Qr,wn),Ks=f(Qr),e(Qr,[{key:"getCloudConfig",value:function(e){return A(e)?this._cloudConfig:this._cloudConfig.has(e)?this._cloudConfig.get(e):void 0}},{key:"getServerConfig",value:function(e){var t={code:0,data:""};return !A(e)&&this._cloudConfig.has(e)&&(t.data=this._cloudConfig.get(e)),Promise.resolve(t)}},{key:"_canFetch",value:function(){return this.isLoggedIn()&&!this._isFetching&&Date.now()>=this._expiredTime}},{key:"fetchConfig",value:function(){var o,i=this,a="".concat(this._n,".fetchConfig"),e=this._canFetch();v.l("".concat(a," canFetch:").concat(e)),e&&(o=new M("fetchCloudCtrlConfig"),e=this.get(12).getSDKAppID(),this._isFetching=!0,this.req({P:I.FETCH_CLOUD_CTRL_CONFIG,data:{SDKAppID:e,version:this._version}}).then(function(e){i._isFetching=!1;var t=e.data,n=t.version,t=t.cloudControlConfig;o.setMessage("version:".concat(i._version," newVersion:").concat(n," config:").concat(t)).end(),v.l("".concat(a," ok")),i._parse(e.data);}).catch(function(e){i._isFetching=!1,o.setError(e).end(),v.l("".concat(a," failed. error:"),e),i._setExpiredTime(12e4);}));}},{key:"onPushedConfig",value:function(e){v.l("".concat(this._n,".onPushedConfig config:"),e),new M("pushedCloudCtrlConfig").setMessage("newVersion:".concat(e.version," config:").concat(e.cloudControlConfig)).end(),this._parse(e);}},{key:"onCheckTimer",value:function(e){this._canFetch()&&this.fetchConfig();}},{key:"_parse",value:function(e){var t=this,n="".concat(this._n,"._parse"),o=e.errorCode,i=e.errorMessage,a=e.cloudControlConfig,s=e.version,r=e.expiredTime;if(0===o){if(this._version!==s){var c=null;try{c=JSON.parse(a);}catch(e){this.isPrivateNetWork()||v.e("".concat(n," failed. config:"),a);}c&&(this._cloudConfig.clear(),Object.keys(c).forEach(function(e){t._cloudConfig.set(e,c[e]);}),this._version=s,this.emitIEvt(Yo.CLOUD_CONFIG));}this._setExpiredTime(1e3*r);}else A(o)?(v.l("".concat(n," failed. Invalid message format:"),e),this._setExpiredTime(36e5)):(v.e("".concat(n," errorCode:").concat(o," errorMessage:").concat(i)),this._setExpiredTime(12e4));}},{key:"_setExpiredTime",value:function(e){this._expiredTime=Date.now()+e;}},{key:"reset",value:function(){v.l("".concat(this._n,".reset")),this._cloudConfig.clear(),this._expiredTime=0,this._version=0,this._isFetching=!1;}}]),Qr),Js=(t(Zr,wn),Bs=f(Zr),e(Zr,[{key:"start",value:function(){this._recoverGroupChat(),this._recoverC2CChat();}},{key:"_recoverGroupChat",value:function(){var n,o,i,a,s=this,e=this._getLocalConvList().filter(function(e){return e.type===R.CONV_GROUP&&e.groupProfile.type!==R.GRP_AVCHATROOM}),r=this.get(11),c=[];e.forEach(function(e){var t=e.conversationID,e=e.lastMessage;n=t.replace(R.CONV_GROUP,""),o=r.getLocalLastMessage(t),e&&0!==e.lastSequence&&o?(i=e.lastSequence,o=o.sequence,a=i-o,0<o&&1<=a&&a<300?s._recoverGroupMsg({groupID:n,localLastMessageSequence:o,remoteLastMessageSequence:i}):c.push(n)):c.push(n);}),this._getGroupNotice(c);}},{key:"_recoverC2CChat",value:function(){var n,o,i,a=this,e=this._getLocalConvList().filter(function(e){return e.type===R.CONV_C2C}),s=this.get(11),r=[Promise.resolve()];e.forEach(function(e){var t=e.conversationID,e=e.lastMessage;n=s.getLocalLastMessage(t),e&&0!==e.lastTime&&n&&(o=e.lastTime,n=n.time,i=o-n,0<n&&1<=i&&i<=600&&r.push(a._recoverC2CMsg({conversationID:t,localLastMessageTime:n,remoteLastMessageTime:o})));}),Promise.all(r).then(function(){v.l("".concat(a._n,"._recoverC2CChat all done")),a.get(19).syncOnReconnected();});}},{key:"_getLocalConvList",value:function(){return this.get(11).getLocalConvList()}},{key:"_recoverGroupMsg",value:function(e){var d=this,p="".concat(this._n,".").concat("_recoverGroupMsg"),_=(v.l("".concat(p," options:"),e),e.groupID),h=e.localLastMessageSequence,g=e.remoteLastMessageSequence,f=JSON.stringify(e),m=new M("_recoverGroupMsg");m.setMessage(f),this._getGroupRoamingMsg({groupID:_,sequence:h}).then(function(e){var e=e.data,t=e.complete,n=e.messageList;if(!A(n)){var e=n[0].sequence,o=n.map(function(e){return e.sequence}),o="".concat(f," complete:").concat(t," sequenceList:").concat(o),i=(v.l("".concat(p," ").concat(o)),e!==h&&e<g&&2!==t&&d._recoverGroupMsg({groupID:_,localLastMessageSequence:e,remoteLastMessageSequence:g}),m.setMessage(o).end(),d.get(7));1<n.length&&n.sort(function(e,t){return e.sequence-t.sequence});for(var a=!1,s=0,r=n.length;s<r;s++)if(n[s].from===R.CONV_SYSTEM){a=!0;break}if(a)for(var c=0,l=n.length;c<l;c++){var u=n[c];u.from!==R.CONV_SYSTEM?i.onNewMessage({dataList:[u],isInstantMessage:!1,updateUnreadCount:!1}):i.onNewGroupTips({event:u.event,dataList:[u]});}else i.onNewMessage({dataList:n,isInstantMessage:!1,updateUnreadCount:!1});}}).catch(function(e){m.setError(e).end(),v.w("".concat(p," failed. error:"),e);});}},{key:"_getGroupNotice",value:function(e){var t=e.length;if(v.l("".concat(this._n,"._getGroupNotice length:").concat(t)),0!==t){var n=this.get(7);if(t<=10)n.getNotice(e);else {var o=Math.floor(t/10);5<=o&&(o=5);for(var i=0;i<=o;i++)n.getNotice(e.slice(10*i,10*(i+1)));}}}},{key:"_getGroupRoamingMsg",value:function(e){var t=e.groupID,e=e.sequence;return this.req({P:I.GET_GRP_ROAMING_MSG,data:{groupID:t,count:this.PULL_LIMIT_COUNT,sequence:e+this.PULL_LIMIT_COUNT-1}})}},{key:"_recoverC2CMsg",value:function(e){var o=this,i="".concat(this._n,".").concat("_recoverC2CMsg"),a=(v.l("".concat(i," options:"),e),e.conversationID),t=e.localLastMessageTime,s=e.remoteLastMessageTime,r=JSON.stringify(e),c=new M("_recoverC2CMsg");return c.setMessage(r),this._getC2CRoamingMsg({conversationID:a,time:t}).then(function(e){var e=e.data,t=e.complete,e=e.messageList;if(!A(e)){var n=e.length,n=(o.get(6).onNewMessage({dataList:e,isInstantMessage:!0}),e[n-1].time),e=e.map(function(e){return e.random}),e="".concat(r," complete:").concat(t," randomList:").concat(e);if(v.l("".concat(i," ").concat(e)),c.setMessage(e).end(),n<s&&1!==t)return o._recoverC2CMsg({conversationID:a,localLastMessageTime:n,remoteLastMessageTime:s})}}).catch(function(e){c.setError(e).end(),v.w("".concat(i," failed. error:"),e);})}},{key:"_getC2CRoamingMsg",value:function(e){var t=e.conversationID,e=e.time;return this.req({P:I.GET_C2C_ROAMING_MSG,data:{peerAccount:t.replace(R.CONV_C2C,""),count:this.PULL_LIMIT_COUNT+1,lastMessageTime:e,direction:1}})}},{key:"reset",value:function(){v.l("".concat(this._n,".reset"));}}]),Zr),zs=(e(Xr,[{key:"addMessageDelay",value:function(e){e=Oe()-e;0<=e&&this._e2eDelayArray.push(e);}},{key:"_calcAvg",value:function(e,t){if(0===t)return 0;var n=0;return e.forEach(function(e){n+=e;}),xt(n/t,1)}},{key:"_calcCountWithLimit",value:function(e){var t=e.e2eDelayArray,n=e.min,o=e.max;return t.filter(function(e){return n<=e&&e<o}).length}},{key:"_calcPercent",value:function(e,t){e=xt(e/t*100,2);return e=100<e?100:e}},{key:"_checkE2EDelayException",value:function(e,t){var n,o,i,a=e.filter(function(e){return t<e});0<a.length&&(n=a.length,o=Math.min.apply(Math,D(a)),i=Math.max.apply(Math,D(a)),a=this._calcAvg(a,n),50<(e=xt(n/e.length*100,2))&&new M("messageE2EDelayException").setMessage("count:".concat(n," min:").concat(o," max:").concat(i," avg:").concat(a," percent:").concat(e)).setLevel("warning").end());}},{key:"getStatResult",value:function(){var e=this._e2eDelayArray.length;if(0===e)return null;var t=D(this._e2eDelayArray),n=this._calcCountWithLimit({e2eDelayArray:t,min:0,max:1}),o=this._calcCountWithLimit({e2eDelayArray:t,min:1,max:3}),i=this._calcPercent(n,e),a=this._calcPercent(o,e),s=this._calcAvg(t,e);return this._checkE2EDelayException(t,3),t.length=0,this.reset(),{totalCount:e,countLessThan1Second:n,percentOfCountLessThan1Second:i,countLessThan3Second:o,percentOfCountLessThan3Second:a,avgDelay:s}}},{key:"reset",value:function(){this._e2eDelayArray.length=0;}}]),Xr),Xs=(e(zr,[{key:"addRequestCount",value:function(){this._requestCount+=1;}},{key:"addRTT",value:function(e){this._rttArray.push(e);}},{key:"_calcTotalCount",value:function(){return this._requestCount}},{key:"_calcRTTCount",value:function(e){return e.length}},{key:"_calcSuccessRateOfRequest",value:function(e,t){if(0===t)return 0;e=xt(e/t*100,2);return e=100<e?100:e}},{key:"_calcAvg",value:function(e,t){if(0===t)return 0;var n=0;return e.forEach(function(e){n+=e;}),parseInt(n/t)}},{key:"_calcMax",value:function(){return Math.max.apply(Math,D(this._rttArray))}},{key:"_calcMin",value:function(){return Math.min.apply(Math,D(this._rttArray))}},{key:"getStatResult",value:function(){var e=this._calcTotalCount(),t=D(this._rttArray);if(0===e)return null;var n=this._calcRTTCount(t),o=this._calcSuccessRateOfRequest(n,e),t=this._calcAvg(t,n);return v.l("".concat(this._n,".getStatResult max:").concat(this._calcMax()," min:").concat(this._calcMin()," avg:").concat(t)),this.reset(),{totalCount:e,rttCount:n,successRateOfRequest:o,avgRTT:t}}},{key:"reset",value:function(){this._requestCount=0,this._rttArray.length=0;}}]),zr),Zs=(e(Jr,[{key:"initMap",value:function(e){var t=this;e.forEach(function(e){t._map.set(e,{totalCount:0,successCount:0,failedCountOfUserSide:0,costArray:[],fileSizeArray:[]});});}},{key:"addTotalCount",value:function(e){return !(A(e)||!this._map.has(e)||(this._map.get(e).totalCount+=1,0))}},{key:"addSuccessCount",value:function(e){return !(A(e)||!this._map.has(e)||(this._map.get(e).successCount+=1,0))}},{key:"addFailedCountOfUserSide",value:function(e){return !(A(e)||!this._map.has(e)||(this._map.get(e).failedCountOfUserSide+=1,0))}},{key:"addCost",value:function(e,t){return !(A(e)||!this._map.has(e)||(this._map.get(e).costArray.push(t),0))}},{key:"addFileSize",value:function(e,t){return !(A(e)||!this._map.has(e)||(this._map.get(e).fileSizeArray.push(t),0))}},{key:"_calcSuccessRateOfBusiness",value:function(e){if(A(e)||!this._map.has(e))return -1;e=this._map.get(e),e=xt(e.successCount/e.totalCount*100,2);return e=100<e?100:e}},{key:"_calcSuccessRateOfPlatform",value:function(e){if(A(e)||!this._map.has(e))return -1;var t=this._map.get(e),e=this._calcSuccessCountOfPlatform(e)/t.totalCount*100;return e=100<(e=xt(e,2))?100:e}},{key:"_calcTotalCount",value:function(e){return A(e)||!this._map.has(e)?-1:this._map.get(e).totalCount}},{key:"_calcSuccessCountOfBusiness",value:function(e){return A(e)||!this._map.has(e)?-1:this._map.get(e).successCount}},{key:"_calcSuccessCountOfPlatform",value:function(e){if(A(e)||!this._map.has(e))return -1;e=this._map.get(e);return e.successCount+e.failedCountOfUserSide}},{key:"_calcAvg",value:function(e){return A(e)||!this._map.has(e)?-1:e===Xn?this._calcAvgSpeed(e):this._calcAvgCost(e)}},{key:"_calcAvgCost",value:function(e){var t=this._map.get(e).costArray.length;if(0===t)return 0;var n=0;return this._map.get(e).costArray.forEach(function(e){n+=e;}),parseInt(n/t)}},{key:"_calcAvgSpeed",value:function(e){var t=0,n=0;return this._map.get(e).costArray.forEach(function(e){t+=e;}),this._map.get(e).fileSizeArray.forEach(function(e){n+=e;}),parseInt(1e3*n/t)}},{key:"getStatResult",value:function(e){var t=this._calcTotalCount(e);if(0===t)return null;var n=this._calcSuccessCountOfBusiness(e),o=this._calcSuccessRateOfBusiness(e),i=this._calcSuccessCountOfPlatform(e),a=this._calcSuccessRateOfPlatform(e),s=this._calcAvg(e);return this.reset(e),{totalCount:t,successCountOfBusiness:n,successRateOfBusiness:o,successCountOfPlatform:i,successRateOfPlatform:a,avgValue:s}}},{key:"reset",value:function(e){A(e)?this._map.clear():this._map.set(e,{totalCount:0,successCount:0,failedCountOfUserSide:0,costArray:[],fileSizeArray:[]});}}]),Jr),Qs=(e(jr,[{key:"initMap",value:function(e){var t=this;e.forEach(function(e){t._lastMap.set(e,new Map),t._currentMap.set(e,new Map);});}},{key:"addMessageSequence",value:function(e){var t=e.key,n=e.message;if(A(t)||!this._lastMap.has(t)||!this._currentMap.has(t))return !1;var o,i,a=n.conversationID,n=n.sequence,a=a.replace(R.CONV_GROUP,"");return 0!==this._lastMap.get(t).size&&this._lastMap.get(t).has(a)?(i=(o=this._lastMap.get(t).get(a)).length-1,n>o[0]&&n<o[i]?(o.push(n),o.sort(),this._lastMap.get(t).set(a,o)):this._addCurrentMap(e)):this._addCurrentMap(e),!0}},{key:"_addCurrentMap",value:function(e){var t=e.key,e=e.message,n=e.conversationID,e=e.sequence,n=n.replace(R.CONV_GROUP,"");this._currentMap.get(t).has(n)||this._currentMap.get(t).set(n,[]),this._currentMap.get(t).get(n).push(e);}},{key:"_copyData",value:function(e){if(!A(e)){this._lastMap.set(e,new Map);var t,n=this._lastMap.get(e),o=N(this._currentMap.get(e));try{for(o.s();!(t=o.n()).done;){var i=m(t.value,2),a=i[0],s=i[1];n.set(a,s);}}catch(e){o.e(e);}finally{o.f();}n=null,this._currentMap.set(e,new Map);}}},{key:"getStatResult",value:function(e){if(A(this._currentMap.get(e))||A(this._lastMap.get(e)))return null;if(0===this._lastMap.get(e).size)return this._copyData(e),null;var o=0,i=0;if(this._lastMap.get(e).forEach(function(e,t){var e=D(e.values()),n=e.length,e=e[n-1]-e[0]+1;o+=e,i+=n;}),0===o)return null;var t=xt(i/o*100,2);return 100<t&&(t=100),this._copyData(e),{totalCount:o,successCountOfMessageReceived:i,successRateOfMessageReceived:t}}},{key:"reset",value:function(){this._currentMap.clear(),this._lastMap.clear();}}]),jr),$s=(t(Wr,wn),Hs=f(Wr),e(Wr,[{key:"_onLoginSuccess",value:function(){var t=this,e=(this._rateMessageSent.initMap(this._messageSentItems),this._rateMessageReceived.initMap(this._messageReceivedItems),this.get(13)),n=e.getItem(this.TAG,!1);!Je(n)&&it(n.forEach)&&(v.l("".concat(this._n,"._onLoginSuccess. logs count:").concat(n.length)),n.forEach(function(e){t._statInfoArr.push(e);}),e.removeItem(this.TAG,!1));}},{key:"_onCloudConfig",value:function(){var e=this.getCloudConfig("q_rpt_interval"),t=this.getCloudConfig("q_rpt_sdkappid_bl"),n=this.getCloudConfig("q_rpt_tinyid_wl");A(e)||(this.REPORT_INTERVAL=Number(e)),A(t)||(this.REPORT_SDKAPPID_BLACKLIST=t.split(",").map(function(e){return Number(e)})),A(n)||(this.REPORT_TINYID_WHITELIST=n.split(","));}},{key:"onCheckTimer",value:function(e){this.isLoggedIn()&&e%this.REPORT_INTERVAL==0&&(this.wholePeriod=!0,this._report());}},{key:"addRequestCount",value:function(){this._avgRTT.addRequestCount();}},{key:"addRTT",value:function(e){this._avgRTT.addRTT(e);}},{key:"addMessageDelay",value:function(e){this._avgE2EDelay.addMessageDelay(e);}},{key:"addTotalCount",value:function(e){this._rateMessageSent.addTotalCount(e)||v.w("".concat(this._n,".addTotalCount invalid key:"),e);}},{key:"addSuccessCount",value:function(e){this._rateMessageSent.addSuccessCount(e)||v.w("".concat(this._n,".addSuccessCount invalid key:"),e);}},{key:"addFailedCountOfUserSide",value:function(e){this._rateMessageSent.addFailedCountOfUserSide(e)||v.w("".concat(this._n,".addFailedCountOfUserSide invalid key:"),e);}},{key:"addCost",value:function(e,t){this._rateMessageSent.addCost(e,t)||v.w("".concat(this._n,".addCost invalid key or cost:"),e,t);}},{key:"addFileSize",value:function(e,t){this._rateMessageSent.addFileSize(e,t)||v.w("".concat(this._n,".addFileSize invalid key or size:"),e,t);}},{key:"addMessageSequence",value:function(e){this._rateMessageReceived.addMessageSequence(e)||v.w("".concat(this._n,".addMessageSequence invalid key:"),e.key);}},{key:"_getQualityItem",value:function(e){var t={},n=no[this.get(15).getNetworkType()],n=(A(n)&&(n=8),{qualityType:eo[e],timestamp:Pe(),networkType:n,extension:""});switch(e){case Kn:t=this._avgRTT.getStatResult();break;case Yn:t=this._avgE2EDelay.getStatResult();break;case Wn:case jn:case Jn:case zn:case Xn:t=this._rateMessageSent.getStatResult(e);break;case Zn:case Qn:case $n:t=this._rateMessageReceived.getStatResult(e);}return null===t?null:y(y({},n),t)}},{key:"_report",value:function(e){var t=this,n=[],o=null,e=(A(e)?this._qualityItems.forEach(function(e){null!==(o=t._getQualityItem(e))&&(o.reportIndex=t.reportIndex,o.wholePeriod=t.wholePeriod,n.push(o));}):null!==(o=this._getQualityItem(e))&&(o.reportIndex=this.reportIndex,o.wholePeriod=this.wholePeriod,n.push(o)),v.d("".concat(this._n,"._report"),n),0<this._statInfoArr.length&&(n=n.concat(this._statInfoArr),this._statInfoArr=[]),this.get(12)),i=e.getSDKAppID(),e=e.getTinyID();0<(n=Vt(this.REPORT_SDKAPPID_BLACKLIST,i)&&!Ht(this.REPORT_TINYID_WHITELIST,e)?[]:n).length&&this._doReport(n);}},{key:"_doReport",value:function(t){var n=this,e={header:da(this),quality:t};this.req({P:I.SSO_STAT,data:y({},e)}).then(function(){n.reportIndex++,n.wholePeriod=!1;}).catch(function(e){v.w("".concat(n._n,"._doReport failed. error:"),e),n._statInfoArr=n._statInfoArr.concat(t),n._flushAtOnce();});}},{key:"_flushAtOnce",value:function(){var e=this.get(13),t=e.getItem(this.TAG,!1),n=this._statInfoArr,o="".concat(this._n,"._flushAtOnce");Je(t)?(v.l("".concat(o," count:").concat(n.length)),e.setItem(this.TAG,n,!0,!1)):(10<(n=n.concat(t)).length&&(n=n.slice(0,10)),v.l("".concat(o," count:").concat(n.length)),e.setItem(this.TAG,n,!0,!1)),this._statInfoArr=[];}},{key:"reset",value:function(){v.l("".concat(this._n,".reset")),this._report(),this.reportIndex=0,this.wholePeriod=!1,this.REPORT_SDKAPPID_BLACKLIST=[],this.REPORT_TINYID_WHITELIST=[],this._avgRTT.reset(),this._avgE2EDelay.reset(),this._rateMessageSent.reset(),this._rateMessageReceived.reset();}}]),Wr),er=e(function e(t){d(this,e),Je(t)||(this.userID=t.userID||"",this.nick=t.nick||"",this.avatar=t.avatar||"",this.time=t.time||0,this.source=t.source||"",this.wording=t.wording||"",this.type=t.type||"");}),tr=(e(Yr,[{key:"getLocalApplicationList",value:function(){return {friendApplicationList:D(this._map.values()),unreadCount:this._unreadCount}}},{key:"_onApplicationListUpdated",value:function(){this._snsM.emitOEvt(G.FRIEND_APPLICATION_LIST_UPDATED,{friendApplicationList:D(this._map.values()),unreadCount:this._unreadCount});}},{key:"onApplicationRead",value:function(){this._unreadCount=0,this._onApplicationListUpdated();}},{key:"onApplicationAdded",value:function(e,t){var n,o,i=this;Je(e)||(n="",n=t===this._snsM.getMyUserID()?R.SNS_APPLICATION_SENT_BY_ME:R.SNS_APPLICATION_SENT_TO_ME,o=!1,e.forEach(function(e){var t="".concat(e.userID,"_").concat(n);n!==R.SNS_APPLICATION_SENT_TO_ME||i._map.has(t)||(i._unreadCount+=1),i._map.set(t,new er(y(y({},e),{},{type:n}))),o=!0;}),o&&this._onApplicationListUpdated());}},{key:"onApplicationDeleted",value:function(e){Je(e)||(this._startTime=0,this._currentSeq=0,this.getApplicationList());}},{key:"getApplicationList",value:function(){var a=this,s="".concat(this._n,".").concat("getApplicationList"),r=new M("getApplicationList");return this._snsM.req({P:I.GET_FD_APPLICATION_LIST,data:{applicationType:R.SNS_APPLICATION_TYPE_BOTH,fromAccount:this._snsM.getMyUserID(),maxLimited:this._maxLimited,startTime:this._startTime,lastSequence:this._currentSeq}}).then(function(e){var e=e.data,t=e.resultList,n=e.unreadCount,o=e.startTime,e=e.currentSequence,i=(a._startTime=o,a._currentSeq=e,a._unreadCount=n,nt(t)?t.length:0),i="applicationCount:".concat(i," unreadCount:").concat(n," startTime:").concat(o," currentSequence:").concat(e);r.setMessage(i).end(),v.i("".concat(s," ok. ").concat(i)),a._map.clear(),nt(t)&&t.forEach(function(e){var t=e.userID,n=e.type,e=new er(e);a._map.set("".concat(t,"_").concat(n),e);}),a._onApplicationListUpdated();}).catch(function(e){return r.setError(e).end(),v.w("".concat(s," failed. error:"),e),C(e)})}},{key:"deleteApplication",value:function(e){var i="".concat(this._n,".").concat("deleteApplication"),a=e.userID,s=e.type;if(s&&(s===R.SNS_APPLICATION_SENT_BY_ME||s===R.SNS_APPLICATION_SENT_TO_ME)||(s=R.SNS_APPLICATION_SENT_TO_ME),!this._map.has("".concat(a,"_").concat(s)))return C({code:T.FRIEND_APPLICATION_NOT_EXIST});var r=new M("deleteApplication");return r.setMessage("userID:".concat(a," type:").concat(s)),this._snsM.req({P:I.DEL_FD_APPLICATION,data:{fromAccount:this._snsM.getMyUserID(),userIDList:[a],type:s}}).then(function(e){var e=e.data.resultList,t=e[0],n=t.to,o=t.resultCode,t=t.resultInfo;return r.setMoreMessage("resultList:".concat(JSON.stringify(e))).end(),v.i("".concat(i," ok. userID:").concat(a," type:").concat(s)),0===o?Ln():C({userID:n,code:o,message:t})}).catch(function(e){return r.setError(e).end(),v.w("".concat(i," failed. error:"),e),C(e)})}},{key:"acceptApplication",value:function(e){var n="".concat(this._n,".").concat("acceptApplication"),o=e.userID,t=e.remark,i=e.tag,a=e.type,s=(a&&(a===R.SNS_APPLICATION_AGREE||a===R.SNS_APPLICATION_AGREE_AND_ADD)||(a=R.SNS_APPLICATION_AGREE_AND_ADD),new M("acceptApplication"));return s.setMessage("userID:".concat(o," type:").concat(a)),this._snsM.req({P:I.RESPOND_FD_APPLICATION,data:{fromAccount:this._snsM.getMyUserID(),responseFriendItem:[{userID:o,remark:t,tag:i,action:a}]}}).then(function(e){s.end();var e=e.data.resultList[0],t=e.resultCode,e=e.resultInfo;if(0!==t)return C({code:t,message:e});v.i("".concat(n," ok. userID:").concat(o," type:").concat(a));}).catch(function(e){return s.setError(e).end(),v.w("".concat(n," failed. error:"),e),C(e)})}},{key:"refuseApplication",value:function(e){var n="".concat(this._n,".").concat("refuseApplication"),o=e.userID,i=new M("refuseApplication");return i.setMessage("userID:".concat(o)),this._snsM.req({P:I.RESPOND_FD_APPLICATION,data:{fromAccount:this._snsM.getMyUserID(),responseFriendItem:[{userID:o,action:"Response_Action_Reject"}]}}).then(function(e){i.end();var e=e.data.resultList[0],t=e.resultCode,e=e.resultInfo;if(0!==t)return C({code:t,message:e});v.i("".concat(n," ok. userID:").concat(o));}).catch(function(e){return i.setError(e).end(),v.w("".concat(n," failed. error:"),e),C(e)})}},{key:"setApplicationRead",value:function(){var t=this,n="".concat(this._n,".").concat("setApplicationRead"),o=new M("setApplicationRead");return this._snsM.req({P:I.REPORT_FD_APPLICATION,data:{fromAccount:this._snsM.getMyUserID(),latestTimeStamp:xt(Pe()/1e3,0)}}).then(function(e){o.end(),v.i("".concat(n," ok")),t._unreadCount=0;}).catch(function(e){return o.setError(e).end(),v.w("".concat(n," failed. error:"),e),C(e)})}},{key:"reset",value:function(){this._maxLimited=100,this._currentSeq=0,this._unreadCount=0,this._map.clear();}}]),Yr),nr=(e(Kr,[{key:"validate",value:function(e){var t,n=!0,o="";if(Je(e))return {valid:!1,tips:"empty options"};if(e.profileCustomField)for(var i=e.profileCustomField.length,a=null,s=0;s<i;s++){if(a=e.profileCustomField[s],!ft(a.key)||-1===a.key.indexOf("Tag_Profile_Custom"))return {valid:!1,tips:"The prefix of keys of the custom profile key-value pairs (which is profileCustomField) must be Tag_Profile_Custom"};if(!ft(a.value))return {valid:!1,tips:"The type of values of the custom profile key-value pairs (which is profileCustomField) must be String"}}for(t in e)if(Object.prototype.hasOwnProperty.call(e,t)){if("profileCustomField"===t)continue;if(Je(e[t])&&!ft(e[t])&&!Qe(e[t])){o="key:"+t+", invalid value:"+e[t],n=!1;continue}switch(t){case"nick":ft(e[t])||(n=!(o="nick must be a string")),500<ut(e[t])&&(o="nick name limited: must less than or equal to ".concat(500," bytes, current size: ").concat(ut(e[t])," bytes"),n=!1);break;case"gender":pt(Ve,e.gender)||(o="key:gender, invalid value:"+e.gender,n=!1);break;case"birthday":Qe(e.birthday)||(n=!(o="birthday must be a number"));break;case"location":ft(e.location)||(n=!(o="location must be a string"));break;case"selfSignature":ft(e.selfSignature)||(n=!(o="selfSignature must be a string"));break;case"allowType":pt(Be,e.allowType)||(o="key:allowType, invalid value:"+e.allowType,n=!1);break;case"language":Qe(e.language)||(n=!(o="language must be a number"));break;case"avatar":ft(e.avatar)||(n=!(o="avatar must be a string"));break;case"messageSettings":0!==e.messageSettings&&1!==e.messageSettings&&(n=!(o="messageSettings must be 0 or 1"));break;case"adminForbidType":pt(He,e.adminForbidType)||(o="key:adminForbidType, invalid value:"+e.adminForbidType,n=!1);break;case"level":Qe(e.level)||(n=!(o="level must be a number"));break;case"role":Qe(e.role)||(n=!(o="role must be a number"));break;default:o="unknown key:"+t+"  "+e[t],n=!1;}}return {valid:n,tips:o}}},{key:"update",value:function(e){var t,n="",o=[];this.friendCustomField.forEach(function(e){o.push(e.key);});for(var i=0,a=e.length;i<a;i++)if(n=e[i].tag,t=e[i].value,-1<n.indexOf("Tag_SNS_Custom"))-1<o.indexOf(n)?this.friendCustomField.forEach(function(e){e.key===n&&(e.value=t);}):this.friendCustomField.push({key:n,value:t});else if(-1<n.indexOf("Tag_Profile_Custom")){var s=!1;this.profile.profileCustomField.forEach(function(e){e.key===n&&(e.value=t,s=!0);}),s||this.profile.profileCustomField.push({key:n,value:t});}else switch(n){case qe.NICK:this.profile.nick=t;break;case qe.GENDER:this.profile.gender=t;break;case qe.BIRTHDAY:this.profile.birthday=t;break;case qe.LOCATION:this.profile.location=t;break;case qe.SELFSIGNATURE:this.profile.selfSignature=t;break;case qe.ALLOWTYPE:this.profile.allowType=t;break;case qe.LANGUAGE:this.profile.language=t;break;case qe.AVATAR:this.profile.avatar=t;break;case qe.MESSAGESETTINGS:this.profile.messageSettings=t;break;case qe.ADMINFORBIDTYPE:this.profile.adminForbidType=t;break;case qe.LEVEL:this.profile.level=t;break;case qe.ROLE:this.profile.role=t;break;case xe.REMARK:this.remark=t;break;case xe.ADDTIME:this.addTime=t;break;case xe.GROUP:this.groupList=JSON.parse(JSON.stringify(t));break;case xe.ADDSOURCE:this.source=t;break;case xe.ADDWORDING:break;default:v.d("snsProfileItem unkown tag->",e[i].tag);}this.timestamp=Date.now(),o.length=0;}},{key:"updateProfile",value:function(e){this.profile=JSON.parse(JSON.stringify(e)),this.timestamp=Date.now();}},{key:"addToGroupList",value:function(e){-1===this.groupList.indexOf(e)&&(this.groupList.push(e),this.count=this.groupList.length);}},{key:"removeFromGroupList",value:function(e){e=this.groupList.indexOf(e);-1<e&&(this.groupList.splice(e,1),this.count=this.groupList.length);}}]),Kr),or=(e(Br,[{key:"getLocalFriendList",value:function(){return D(this._map.values())}},{key:"getFriendRemark",value:function(e){return this._map.has(e)?this._map.get(e).remark:""}},{key:"onFriendProfileModified",value:function(e){var o,i=this,e=e.dataList;Je(e)||(o=this._snsM.get(11),e.forEach(function(e){var t,n=e.userID,e=e.profileList;i.isMyFriend(n)&&(v.l("".concat(i._n,".onFriendProfileModified. friend account:").concat(n,", profileList:").concat(JSON.stringify(e))),(t=i._map.get(n)).update(e),o.modifyMessageSentByPeer({conversationID:"".concat(R.CONV_C2C).concat(n),latestNick:t.profile.nick,latestAvatar:t.profile.avatar}));}),this._onFriendListUpdated());}},{key:"onFriendAdded",value:function(t){var n=this;0!==t.length&&(v.l("".concat(this._n,".onFriendAdded userIDList:").concat(t)),t.forEach(function(e){n._map.set(e,new nr(e));}),this.getFriendProfile({userIDList:t}).then(function(e){t.forEach(function(e){var t=n._map.get(e);0<t.groupList.length&&n._snsM.updateWhenFriendAdded({nameList:t.groupList,userID:e});}),n._onFriendListUpdated();}));}},{key:"onFriendDeleted",value:function(e){var n=this;0!==e.length&&(v.l("".concat(this._n,".onFriendDeleted userIDList:").concat(e)),e.forEach(function(e){var t=n._map.get(e);0<t.groupList.length&&n._snsM.updateWhenFriendDeleted({nameList:t.groupList,userID:e}),n._map.delete(e);}),this._onFriendListUpdated());}},{key:"_onFriendListUpdated",value:function(){this._snsM.emitOEvt(G.FRIEND_LIST_UPDATED),this._snsM.get(11).checkAndPatchRemark();}},{key:"getFriendProfile",value:function(e){var a=this,t="".concat(this._n,".").concat("getFriendProfile"),e=e.userIDList,s=[],r=[],n=[];if(e.forEach(function(e){var t;a._map.has(e)?(t=a._map.get(e),Date.now()-t.timestamp<a._expirationTime?r.push(t):n.push(e)):s.push({userID:e,code:T.NOT_MY_FRIEND,message:a._snsM.getErrMsg(T.NOT_MY_FRIEND)});}),0===n.length)return v.i("".concat(t," newUserIDList is empty")),Sn({friendList:r,failureUserIDList:s});var o=new M("getFriendProfile");return o.setMessage("userIDList:".concat(n)),v.i("".concat(t," userIDList:").concat(n)),this._snsM.req({P:I.GET_FD_PROFILE,data:{fromAccount:this._snsM.getMyUserID(),userIDList:n}}).then(function(e){return o.end(),v.i("".concat(t," ok")),e.data.resultList.forEach(function(e){var t,n=e.to,o=e.resultCode,i=e.resultInfo,e=e.tagValueList;A(o)||0===o?(a._map.has(n)?(t=a._map.get(n)).update(e):(t=new nr(n,e),a._map.set(n,t)),r.push(t)):s.push({userID:n,code:o,message:i});}),Ln({friendList:r,failureUserIDList:s})}).catch(function(e){return o.setError(e).end(),v.w("".concat(t," failed. error:"),e),C(e)})}},{key:"isMyFriend",value:function(e){return this._map.has(e)}},{key:"pagingGetFriendList",value:function(){var s=this,r="".concat(this._n,".").concat("getFriendList"),c=new M("getFriendList"),u=Date.now();this._snsM.req({P:I.GET_FD_LIST,data:{fromAccount:this._snsM.getMyUserID(),startIndex:this._startIdx,standardSequence:this._standardSeq,customSequence:this._customSeq}}).then(function(e){var e=e.data,t=e.friendCount,n=e.resultList,o=e.nextStartIndex,i=e.standardSequence,a=e.customSequence,e=e.completeFlag,t=(s._startIdx=o,s._standardSeq=i,s._customSeq=a,"friendCount:".concat(t," nextStartIndex:").concat(o," standardSequence:").concat(i," ")+"customSequence:".concat(a," completeFlag:").concat(e," cost:").concat(Zt(u)));c.setMessage(t).end(),v.i("".concat(r," ok."),t),Je(n)||n.forEach(function(e){var t=e.to,e=e.tagValueList;s._map.set(t,new nr(t,e));}),0===e?s.pagingGetFriendList():(s._snsM.emitOEvt(G.FRIEND_LIST_UPDATED),s._pagingGetFriendProfile());}).catch(function(e){return c.setError(e).end(),v.w("".concat(r," failed. error:"),e),C(e)});}},{key:"_pagingGetFriendProfile",value:function(){var n=this,e=D(this._map.keys()),t=this._snsM.get(4),o=e.length,i=o<=100?1:Math.ceil(o/100);v.l("".concat(this._n,"._pagingGetFriendProfile friendCount:").concat(o," pageCount:").concat(i));for(var a=0;a<i;a++)t.getUserProfile({userIDList:e.slice(100*a,100*(a+1))}).then(function(e){e.data.forEach(function(e){var t=n._map.get(e.userID);t&&t.updateProfile(e);}),n._onFriendListUpdated();});}},{key:"addFriend",value:function(e){var o=this,i="".concat(this._n,".").concat("addFriend");if(this._map.has(e.to))return C({code:T.ALREADY_MY_FRIEND});if(e.wording&&!1===this._snsM.filterProfanity("wording",e))return C({code:T.PROFANITY_FOUND});var t=e.to,n=e.source,a=e.type,s=e.wording,r=e.remark,e=e.groupName,c=a,u=(c&&(c===R.SNS_ADD_TYPE_SINGLE||c===R.SNS_ADD_TYPE_BOTH)||(c=R.SNS_ADD_TYPE_BOTH),new M("addFriend"));return u.setMessage("to:".concat(t," source:").concat(n," type:").concat(c)),this._snsM.req({P:I.ADD_FD,data:{fromAccount:this._snsM.getMyUserID(),addFriendItem:[{to:t,source:n,wording:s,remark:r,groupName:e}],type:c}}).then(function(e){var e=e.data.resultList,e=(u.setMoreMessage("resultList:".concat(JSON.stringify(e))).end(),e[0]),t=e.to,n=e.resultCode,e=e.resultInfo;return v.i("".concat(i," ok. to:").concat(t," type:").concat(c," code:").concat(n)),A(n)||0===n?Ln({userID:t,code:0}):30539===n?Ln({userID:t,code:n,message:o._snsM.getErrMsg(n)}):C({userID:t,code:n,message:o._snsM.getErrMsg(n)||e})}).catch(function(e){return u.setError(e).end(),v.w("".concat(i," failed. error:"),e),C(e)})}},{key:"deleteFriend",value:function(e){var t=this,n="".concat(this._n,".").concat("deleteFriend"),o=e.userIDList,e=e.type,i=(1e3<o.length&&(v.w("".concat(n," ").concat(Jt(1e3))),o.length=1e3),[]),a=[],s=[];if(o.forEach(function(e){t._map.has(e)?s.push(e):i.push({userID:e,code:T.NOT_MY_FRIEND,message:t._snsM.getErrMsg(T.NOT_MY_FRIEND)});}),0===s.length)return Sn({successUserIDList:a,failureUserIDList:i});var o=e,r=(o&&(o===R.SNS_DELETE_TYPE_SINGLE||o===R.SNS_DELETE_TYPE_BOTH)||(o=R.SNS_DELETE_TYPE_BOTH),new M("deleteFriend"));return r.setMessage("userIDList:".concat(s," type:").concat(o)),this._snsM.req({P:I.DEL_FD,data:{fromAccount:this._snsM.getMyUserID(),userIDList:s,type:o}}).then(function(e){r.end(),v.i("".concat(n," ok"));e=e.data.resultList;return Je(e)||e.forEach(function(e){var t=e.to,n=e.resultCode,e=e.resultInfo;A(n)||0===n?a.push({userID:t}):i.push({userID:t,code:n,message:e});}),Ln({successUserIDList:a,failureUserIDList:i})}).catch(function(e){return r.setError(e).end(),v.w("".concat(n," error:"),e),C(e)})}},{key:"updateFriend",value:function(e){var o=this,t=e.userID,i=e.remark,a=e.friendCustomField;if(!this._map.has(t))return C({code:T.NOT_MY_FRIEND});var s="".concat(this._n,".").concat("updateFriend"),r=new M("updateFriend"),n=(r.setMessage("userID:".concat(t," remark:").concat(i," friendCustomField:").concat(a)),[]);return A(i)||n.push({tag:xe.REMARK,value:i}),nt(a)&&0<a.length&&a.forEach(function(e){n.push({tag:e.key,value:e.value});}),this._snsM.req({P:I.UPDATE_FD,data:{fromAccount:this._snsM.getMyUserID(),updateItem:[{to:t,snsItem:n}]}}).then(function(e){r.end(),v.i("".concat(s," ok"));var e=e.data.resultList[0],t=e.to,n=e.resultCode,e=e.resultInfo;return A(n)||0===n?((t=o._map.get(t))&&(A(i)||(t.remark=i),nt(a)&&0<a.length&&Tt(t.friendCustomField,a),o._onFriendListUpdated()),Ln(t)):C({code:n,message:e})}).catch(function(e){return r.setError(e).end(),v.w("".concat(s," failed. error:"),e),C(e)})}},{key:"checkFriend",value:function(e){var t="".concat(this._n,".").concat("checkFriend"),n=e.userIDList,o=e.type,s=(o&&(o===R.SNS_CHECK_TYPE_SINGLE||o===R.SNS_CHECK_TYPE_BOTH)||(o=R.SNS_CHECK_TYPE_BOTH),new M("checkFriend"));return s.setMessage("userIDList:".concat(n," type:").concat(o)),this._snsM.req({P:I.CHECK_FD,data:{fromAccount:this._snsM.getMyUserID(),userIDList:n,type:o}}).then(function(e){s.end(),v.i("".concat(t," ok. userIDList:").concat(n," type:").concat(o));var i=[],a=[],e=e.data.resultList;return nt(e)&&e.forEach(function(e){var t=e.to,n=e.relation,o=e.resultCode,e=e.resultInfo;A(o)||0===o?i.push({userID:t,code:0,relation:n}):a.push({userID:t,code:o,message:e});}),Ln({successUserIDList:i,failureUserIDList:a})}).catch(function(e){return s.setError(e).end(),v.w("".concat(t," failed. error:"),e),C(e)})}},{key:"onAddedToFriendGroup",value:function(e){var t=this,n=e.name,e=e.userIDList;v.l("".concat(this._n,".onAddedToFriendGroup groupName:").concat(n," userIDList:").concat(e)),n&&!Je(e)&&e.forEach(function(e){t._map.has(e)&&t._map.get(e).addToGroupList(n);});}},{key:"onRemovedFromFriendGroup",value:function(e){var t=this,n=e.name,e=e.userIDList;v.l("".concat(this._n,".onRemovedFromFriendGroup groupName:").concat(n," userIDList:").concat(e)),n&&!Je(e)&&e.forEach(function(e){t._map.has(e)&&t._map.get(e).removeFromGroupList(n);});}},{key:"reset",value:function(){this._map.clear(),this._startIdx=0,this._standardSeq=0,this._customSeq=0;}}]),Br),ir=(e(Hr,[{key:"addToUserIDList",value:function(e){-1===this.userIDList.indexOf(e)&&(this.userIDList.push(e),this.count=this.userIDList.length);}},{key:"removeFromUserIDList",value:function(e){e=this.userIDList.indexOf(e);-1<e&&(this.userIDList.splice(e,1),this.count=this.userIDList.length);}}]),Hr),ar=(e(Vr,[{key:"getLocalGroupList",value:function(){return D(this._map.values())}},{key:"_onGroupListUpdated",value:function(){var e=D(this._map.values());this._snsM.emitOEvt(G.FRIEND_GROUP_LIST_UPDATED,e);}},{key:"getGroupList",value:function(){var n=this,t="".concat(this._n,".").concat("getGroupList"),o=new M("getGroupList");return this._snsM.req({P:I.GET_FD_GRP_LIST,data:{fromAccount:this._snsM.getMyUserID()}}).then(function(e){o.end();e=e.data.resultList;Je(e)?v.i("".concat(t," ok. count:0")):(v.i("".concat(t," ok. count:").concat(e.length)),n._map.clear(),e.forEach(function(e){var t=new ir(e);n._map.set(e.name,t);}),n._onGroupListUpdated());}).catch(function(e){return o.setError(e).end(),v.w("".concat(t," error:"),e),C(e)})}},{key:"createGroup",value:function(e){var t=this,n="".concat(this._n,".").concat("createGroup"),o=e.name,e=e.userIDList;if(this._map.has(o))return C({code:T.FRIEND_GRP_EXISTED});var s="name:".concat(o," userIDList:").concat(e),r=new M("createGroup");return r.setMessage(s),this._snsM.req({P:I.CREATE_FD_GRP,data:{fromAccount:this._snsM.getMyUserID(),groupName:[o],userIDList:nt(e)?e:void 0}}).then(function(e){r.end(),v.l("".concat(n," ok. ").concat(s));var e=e.data.resultList,i=[],a=[],e=(e&&e.forEach(function(e){var t=e.to,n=e.resultCode,o=e.resultInfo;A(n)||0===n?i.push(t):(t={userID:e.to,code:n,message:o},a.push(t));}),new ir({name:o,userIDList:i}));return t._map.set(o,e),t._snsM.onAddedToFriendGroup({name:o,userIDList:i}),t._onGroupListUpdated(),Ln({friendGroup:e,failureUserIDList:a})}).catch(function(e){return r.setError(e).end(),v.w("".concat(n," failed. error:"),e),C(e)})}},{key:"deleteGroup",value:function(e){var n=this,o="".concat(this._n,".").concat("deleteGroup"),i=e.name;if(!this._map.has(i))return this._onGroupNotExist();var a="name:".concat(i),s=new M("deleteGroup");return s.setMessage(a),this._snsM.req({P:I.DEL_FD_GRP,data:{fromAccount:this._snsM.getMyUserID(),nameList:[i]}}).then(function(e){s.end(),v.l("".concat(o," ok. ").concat(a));var t=n._map.get(i);return t&&(n._snsM.onRemovedFromFriendGroup({name:i,userIDList:t.userIDList}),n._map.delete(i),t.userIDList.length=0),n._onGroupListUpdated(),Ln(t)}).catch(function(e){return s.setError(e).end(),v.w("".concat(o," failed. error:"),e),C(e)})}},{key:"renameGroup",value:function(e){var t=this,n="".concat(this._n,".").concat("renameGroup"),o=e.oldName,i=e.newName;if(!this._map.has(o))return this._onGroupNotExist();var a="oldName:".concat(o," newName:").concat(i),s=new M("renameGroup");return s.setMessage(a),this._snsM.req({P:I.UPDATE_FD_GRP,data:{fromAccount:this._snsM.getMyUserID(),oldName:o,newName:i}}).then(function(){var e;return s.end(),v.l("".concat(n," ok. ").concat(a)),t._map.has(o)?((e=t._map.get(o)).name=i,t._map.delete(o),t._map.set(i,e),t._snsM.onRemovedFromFriendGroup({name:o,userIDList:e.userIDList}),t._snsM.onAddedToFriendGroup({name:i,userIDList:e.userIDList}),t._onGroupListUpdated(),Ln(e)):Ln()}).catch(function(e){return s.setError(e).end(),v.w("".concat(n," failed. error:"),e),C(e)})}},{key:"addToGroup",value:function(e){var t=this,n="".concat(this._n,".").concat("addToGroup"),o=e.name,e=e.userIDList;if(!this._map.has(o))return this._onGroupNotExist();var i="name:".concat(o," userIDList:").concat(e),a=new M("addToGroup");return a.setMessage(i),this._snsM.req({P:I.UPDATE_FD_GRP,data:{fromAccount:this._snsM.getMyUserID(),oldName:o,updateGroupItem:e.filter(function(e){return t._snsM.isMyFriend(e)}).map(function(e){return {to:e,updateType:"Update_Type_Add"}})}}).then(function(e){return a.end(),v.l("".concat(n," ok. ").concat(i)),t._onGroupUpdated(o,e)}).catch(function(e){return a.setError(e).end(),v.w("".concat(n," failed. error:"),e),C(e)})}},{key:"removeFromGroup",value:function(e){var t=this,n="".concat(this._n,".").concat("removeFromGroup"),o=e.name,e=e.userIDList;if(!this._map.has(o))return this._onGroupNotExist();var i="name:".concat(o," userIDList:").concat(e),a=new M("removeFromGroup");return a.setMessage(i),this._snsM.req({P:I.UPDATE_FD_GRP,data:{fromAccount:this._snsM.getMyUserID(),oldName:o,updateGroupItem:e.filter(function(e){return t._snsM.isMyFriend(e)}).map(function(e){return {to:e,updateType:"Update_Type_Delete"}})}}).then(function(e){return a.end(),v.l("".concat(n," ok. ").concat(i)),t._onGroupUpdated(o,e)}).catch(function(e){return a.setError(e).end(),v.w("".concat(n," failed. error:"),e),C(e)})}},{key:"_onGroupUpdated",value:function(e,t){var t=t.data.resultList,a=this._map.get(e),s=[],r=[],c=[];return nt(t)&&t.forEach(function(e){var t=e.to,n=e.resultCode,o=e.resultInfo,i=e.type;0===n?"Update_Type_Add"===i?a&&(a.addToUserIDList(t),r.push(t)):"Update_Type_Delete"===i&&a&&(a.removeFromUserIDList(t),c.push(t)):s.push({to:e.to,code:n,message:o});}),v.l("".concat(this._n,"._onGroupUpdated name:").concat(e," userIDList:").concat(a.userIDList)),0<r.length&&this._snsM.onAddedToFriendGroup({name:e,userIDList:r}),0<c.length&&this._snsM.onRemovedFromFriendGroup({name:e,userIDList:c}),Ln({friendGroup:a,failureUserIDList:s})}},{key:"updateWhenFriendAdded",value:function(e){var t=this,n=e.nameList,o=e.userID;v.l("".concat(this._n,".updateWhenFriendAdded userID:").concat(o," nameList:").concat(n)),Je(n)||n.forEach(function(e){t._map.has(e)&&t._map.get(e).addToUserIDList(o);});}},{key:"updateWhenFriendDeleted",value:function(e){var t=this,n=e.nameList,o=e.userID;v.l("".concat(this._n,".updateWhenFriendDeleted userID:").concat(o," nameList:").concat(n)),Je(n)||n.forEach(function(e){t._map.has(e)&&t._map.get(e).removeFromUserIDList(o);});}},{key:"_onGroupNotExist",value:function(e){return C({code:T.FRIEND_GRP_NOT_EXIST})}},{key:"reset",value:function(){this._map.clear();}}]),Vr),sr=(t(xr,wn),Vs=f(xr),e(xr,[{key:"onContextUpdated",value:function(e){this._friendHandler.pagingGetFriendList(),this._friendGroupHandler.getGroupList(),this._friendApplicationHandler.getApplicationList();}},{key:"onRelationChainModified",value:function(e){var n,o,i,a,s,r,c=this,e=e.dataList;Je(e)||(n=[],o=[],i=[],s=!(a=[]),r="",e.forEach(function(e){var t;3!==e.pushType&&4!==e.pushType||!e.from||(r=e.from),e.friendAddAccount&&(n.push.apply(n,D(e.friendAddAccount)),a.push.apply(a,D(e.friendAddAccount))),e.friendDelAccount&&o.push.apply(o,D(e.friendDelAccount)),e.friendApplicationAdded&&i.push.apply(i,D(e.friendApplicationAdded)),e.friendApplicationDeletedUserIDList&&a.push.apply(a,D(e.friendApplicationDeletedUserIDList)),e.reportTime&&7===e.pushType&&(s=!0),e.friendUpInfo&&(t={dataList:[]},e.friendUpInfo.forEach(function(e){t.dataList.push({userID:e.friendAccount,profileList:D(e.sns)});}),c.onFriendProfileModified(t));}),s&&this._friendApplicationHandler.onApplicationRead(),this._friendApplicationHandler.onApplicationAdded(i,r),this._friendApplicationHandler.onApplicationDeleted(a),this._friendHandler.onFriendAdded(n),this._friendHandler.onFriendDeleted(o));}},{key:"isMyFriend",value:function(e){return this._friendHandler.isMyFriend(e)}},{key:"filterProfanity",value:function(e,t){var n=this.get(29);if(!n)return !0;var n=n.filterText(t[e],"sns"),o=n.isAllowedToSend,n=n.modifiedText;return !0===o&&(t[e]=n,!0)}},{key:"onFriendProfileModified",value:function(e){this._friendHandler.onFriendProfileModified(e);}},{key:"getLocalFriendList",value:function(){var e=!(0<arguments.length&&void 0!==arguments[0])||arguments[0],t=this._friendHandler.getLocalFriendList();return e?Sn(t):t}},{key:"getFriendRemark",value:function(e){return this._friendHandler.getFriendRemark(e)}},{key:"getFriendList",value:function(){return this._friendHandler.pagingGetFriendList()}},{key:"addFriend",value:function(e){return this._friendHandler.addFriend(e)}},{key:"deleteFriend",value:function(e){return this._friendHandler.deleteFriend(e)}},{key:"checkFriend",value:function(e){return this._friendHandler.checkFriend(e)}},{key:"getFriendProfile",value:function(e){return this._friendHandler.getFriendProfile(e)}},{key:"updateFriend",value:function(e){return this._friendHandler.updateFriend(e)}},{key:"onAddedToFriendGroup",value:function(e){this._friendHandler.onAddedToFriendGroup(e);}},{key:"onRemovedFromFriendGroup",value:function(e){this._friendHandler.onRemovedFromFriendGroup(e);}},{key:"getLocalFriendApplicationList",value:function(){var e=this._friendApplicationHandler.getLocalApplicationList();return Sn(e)}},{key:"deleteFriendApplication",value:function(e){return this._friendApplicationHandler.deleteApplication(e)}},{key:"refuseFriendApplication",value:function(e){return this._friendApplicationHandler.refuseApplication(e)}},{key:"acceptFriendApplication",value:function(e){return this._friendApplicationHandler.acceptApplication(e)}},{key:"setFriendApplicationRead",value:function(e){return this._friendApplicationHandler.setApplicationRead(e)}},{key:"getLocalFriendGroupList",value:function(){var e=this._friendGroupHandler.getLocalGroupList();return Sn(e)}},{key:"createFriendGroup",value:function(e){return this._friendGroupHandler.createGroup(e)}},{key:"deleteFriendGroup",value:function(e){return this._friendGroupHandler.deleteGroup(e)}},{key:"addToFriendGroup",value:function(e){return this._friendGroupHandler.addToGroup(e)}},{key:"removeFromFriendGroup",value:function(e){return this._friendGroupHandler.removeFromGroup(e)}},{key:"renameFriendGroup",value:function(e){return this._friendGroupHandler.renameGroup(e)}},{key:"updateWhenFriendAdded",value:function(e){this._friendGroupHandler.updateWhenFriendAdded(e);}},{key:"updateWhenFriendDeleted",value:function(e){this._friendGroupHandler.updateWhenFriendDeleted(e);}},{key:"reset",value:function(){v.l("".concat(this._n,".reset")),this._friendHandler.reset(),this._friendGroupHandler.reset(),this._friendApplicationHandler.reset();}}]),xr),rr=(t(qr,wn),xs=f(qr),e(qr,[{key:"isWorkerEnabled",value:function(){return this._isWorkerEnabled&&ye}},{key:"startWorkerTimer",value:function(){v.l("".concat(this._n,".startWorkerTimer")),this._workerTimer&&this._workerTimer.postMessage("start");}},{key:"stopWorkerTimer",value:function(){v.l("".concat(this._n,".stopWorkerTimer")),this._workerTimer&&this._workerTimer.postMessage("stop");}},{key:"_init",value:function(){var e,t;ye&&(e=URL.createObjectURL(new Blob(['let interval = -1;onmessage = function(event) {  if (event.data === "start") {    if (interval > 0) {      clearInterval(interval);    }    interval = setInterval(() => {      postMessage("");    }, 1000);    postMessage(interval);  } else if (event.data === "stop") {    clearInterval(interval);    interval = -1;  }};'],{type:"application/javascript; charset=utf-8"})),this._workerTimer=new Worker(e),(t=this)._workerTimer.onmessage=function(e){e.data?(t._timerID=e.data,v.l("".concat(t._n,"._init seed:").concat(t._timerID))):t._m.onCheckTimer();});}},{key:"_onCloudConfig",value:function(){var e=this.getCloudConfig("enable_worker");v.l("".concat(this._n,"._onCloudConfig enableWorker:").concat(e)),A(e)||"1"===e?!this._isWorkerEnabled&&ye&&(this._isWorkerEnabled=!0,this.startWorkerTimer(),this._m.onWorkerTimerEnabled()):this._isWorkerEnabled&&ye&&(this._isWorkerEnabled=!1,this.stopWorkerTimer(),this._m.onWorkerTimerDisabled());}},{key:"terminate",value:function(){v.l("".concat(this._n,".terminate")),this._workerTimer&&(this._workerTimer.terminate(),this._workerTimer=null,this._timerID=-1);}},{key:"getTimerID",value:function(){return this._timerID}},{key:"reset",value:function(){v.l("".concat(this._n,".reset"));}}]),qr),cr=(e(Fr,[{key:"isValidPurchaseBits",value:function(e){return e&&"string"==typeof e&&1<=e.length&&e.length<=64&&/[01]{1,64}/.test(e)}},{key:"parsePurchaseBits",value:function(e){if(this.isValidPurchaseBits(e)){this._featureMap.clear();for(var t,n=e.length-1,o=0;0<=n;n--,o++)t=(o<32?new b(0,Math.pow(2,o)):new b(Math.pow(2,o-32),0)).toString(),"1"===e[n]?this._featureMap.set(t,!0):this._featureMap.set(t,!1);}else v.w("".concat(this._n,".parsePurchaseBits invalid purchasebits:").concat(e));}},{key:"hasPurchasedFeature",value:function(e){return !!this._featureMap.get(e)}},{key:"isFeatureEnabled",value:function(e){for(var t=parseInt(e).toString(2),n=void 0,o=!0,i=t.length-1,a=0;0<=i;i--,a++)if("1"===t.charAt(i)&&(n=(a<32?new b(0,Math.pow(2,a)):new b(Math.pow(2,a-32),0)).toString(),!this._featureMap.get(n))){o=!1;break}return v.l("".concat(this._n,".isFeatureEnabled decimalNumber:").concat(e," key:").concat(n," ret:").concat(o)),Sn({enabled:o})}},{key:"isFeatureEnabledForStat",value:function(e){for(var t=parseInt(e).toString(2),n=t.length-1,o=0;0<=n;n--,o++)if("1"===t.charAt(n)){if(i=(o<32?new b(0,Math.pow(2,o)):new b(Math.pow(2,o-32),0)).toString(),!this._featureMap.get(i))break;var i,a="",s=0;i===H.PLUGIN_TRANSLATE?(a="plugin_translate",s=16):i===H.PLUGIN_VOICE_TO_TEXT?(a="plugin_voice_to_text",s=17):i===H.PLUGIN_CS?(a="plugin_cs",s=14):i===H.PLUGIN_PUSH?(a="plugin_push",s=13):i===H.PLUGIN_BOT?(a="plugin_bot",s=15):i===H.MSG_REACTION&&(a="plugin_emoji_reaction",s=18),""!==a&&(i=this._commercialConfigM.get(12).getUIPlatform(),new M(a).setCode(s).setUIPlatform(i).end(),v.l("".concat(this._n,".isFeatureEnabledForStat ").concat(a," code:").concat(s," uiPlatform:").concat(i)));}}},{key:"isCSPluginEnabled",value:function(){var e;this._isCSPluginReported||(e=this._commercialConfigM.get(12).getUIPlatform(),new M("plugin_search").setCode(6).setUIPlatform(e).end(),this._isCSPluginReported=!0);}},{key:"clear",value:function(){this._featureMap.clear(),this._isCSPluginReported=!1;}}]),Fr),ur=(e(wr,[{key:"_canFetch",value:function(){return this.get(12).isLoggedIn()?!this._isFetching&&Date.now()>=this._expiredTime:(this._expiredTime=Date.now()+2e3,!1)}},{key:"onCheckTimer",value:function(e){this._canFetch()&&this.fetchConfig();}},{key:"fetchConfig",value:function(){var t,e,n=this,o=this._canFetch(),i="".concat(this._n,".fetchConfig");v.l("".concat(i," canFetch:").concat(o)),o&&(t=new M("fetchCommercialConfig"),o=this.get(12).getSDKAppID(),e=this.get(20),this._isFetching=!0,e.req({P:I.FETCH_COMMERCIAL_CONFIG,data:{SDKAppID:o}}).then(function(e){t.setMessage("purchaseBits:".concat(e.data.purchaseBits)).end(),v.l("".concat(i," ok.")),n._parseConfig(e.data),n._isFetching=!1;}).catch(function(e){t.setError(e).end(),n._isFetching=!1;}));}},{key:"onPushedConfig",value:function(e){var t="".concat(this._n,".onPushedConfig data:").concat(JSON.stringify(e));v.l("".concat(t)),new M("pushedCommercialConfig").setMessage("purchaseBits:".concat(e.purchaseBits)).end(),this._parseConfig(e);}},{key:"_parseConfig",value:function(e){var t="".concat(this._n,"._parseConfig"),n=e.errorCode,o=e.errorMessage,i=e.purchaseBits,a=e.expiredTime;0===n?(this._purchasedFeatureHandler.parsePurchaseBits(i),this._expiredTime=Date.now()+1e3*a):A(n)?(v.l("".concat(t," failed. Invalid message format:"),e),this._setExpiredTimeOnResponseError(36e5)):(v.e("".concat(t," errorCode:").concat(n," errorMessage:").concat(o)),this._setExpiredTimeOnResponseError(12e4));}},{key:"_setExpiredTimeOnResponseError",value:function(e){this._expiredTime=Date.now()+e;}},{key:"canIUse",value:function(e){return this._purchasedFeatureHandler.hasPurchasedFeature(e)}},{key:"isFeatureEnabled",value:function(e){return this._purchasedFeatureHandler.isFeatureEnabled(e)}},{key:"isFeatureEnabledForStat",value:function(e){this._purchasedFeatureHandler.isFeatureEnabledForStat(e);}},{key:"isCSPluginEnabled",value:function(){this._purchasedFeatureHandler.isCSPluginEnabled();}},{key:"get",value:function(e){return this._m.get(e)}},{key:"reset",value:function(){v.l("".concat(this._n,".reset")),this._expiredTime=0,this._isFetching=!1,this._purchasedFeatureHandler.clear();}}]),wr),lr=(t(br,wn),qs=f(br),e(br,[{key:"registerPlugin",value:function(e){var t,n,o,i,a,s,r,c,l,d,p,_,u;ne?(this._offlinePushPlugin=e["tim-offline-push-plugin"],t=(u=e.offlinePushConfig||{}).huaweiBusinessID,n=u.xiaomiBusinessID,o=u.xiaomiAppID,i=u.xiaomiAppKey,a=u.meizuBusinessID,s=u.meizuAppID,r=u.meizuAppKey,c=u.vivoBusinessID,l=u.oppoBusinessID,d=u.oppoAppKey,p=u.oppoAppSecret,_=u.honorBusinessID,u=u.iosBusinessID,this._androidPushConfig.huaweiPushBussinessId=t,this._androidPushConfig.xiaomiPushBussinessId=n,this._androidPushConfig.xiaomiPushAppId=o,this._androidPushConfig.xiaomiPushAppKey=i,this._androidPushConfig.meizuPushBussinessId=a,this._androidPushConfig.meizuPushAppId=s,this._androidPushConfig.meizuPushAppKey=r,this._androidPushConfig.vivoPushBussinessId=c,this._androidPushConfig.oppoPushBussinessId=l,this._androidPushConfig.oppoPushAppKey=d,this._androidPushConfig.oppoPushAppSecret=p,this._androidPushConfig.honorPushBussinessId=_,new M("registerPlugin").setMessage("tim-offline-push-plugin").setMoreMessage("isExist:".concat(!A(this._offlinePushPlugin))).end(!0),v.l("".concat(this._n,".").concat("registerPlugin"," ok. offlinePushConfig:").concat(JSON.stringify(e.offlinePushConfig))),this._iosBusinessID=u,this._setAppShowListener()):this.warn("OfflinePushInUniapp");}},{key:"init",value:function(){this._isWebUniapp=this.getUniAppPlatform(),this._getDeviceToken();}},{key:"_getDeviceToken",value:function(){var c,u=this,l="".concat(this._n,".").concat("_getDeviceToken");it(this._offlinePushPlugin.getDeviceToken)?(c="androidPushConfig:".concat(JSON.stringify(this._androidPushConfig),", iosBusinessID:").concat(this._iosBusinessID),v.l("".concat(l," start. ").concat(c)),new M("_getDeviceToken").setMessage("".concat(c)).end(!0),this._offlinePushPlugin.getDeviceToken(this._androidPushConfig,function(e){var t,n,o,i,a=new M("getDeviceTokenRes"),s=e.code,r=e.msg;0===s?(t=(i=e.data).deviceToken,n=i.deviceBrand,o=i.deviceType,i=i.bussinessId,u._deviceToken=t,u._businessID=i||u._iosBusinessID,c="deviceToken:".concat(t,", deviceBrand:").concat(n||o,", businessID:").concat(u._businessID),v.l("".concat(l," ok. ").concat(c)),a.setMessage(c).end(!0),u._setToken()):(a.setMessage("code:".concat(s,", msg:").concat(r)).end(!0),v.e("".concat(l," failed. error:"),e));})):v.e("".concat(l," getDeviceToken is not a function"));}},{key:"canIUseOfflinePush",value:function(){return ne&&!A(this._offlinePushPlugin)}},{key:"_setAppShowListener",value:function(){var t=this,n="".concat(this._n,".").concat("_setAppShowListener");A(this._offlinePushPlugin)?v.e("".concat(n," offlinePushPlugin is undefined")):it(this._offlinePushPlugin.setAppShowListener)?(new M("_setAppShowListener").end(!0),v.l("".concat(n," start")),this._offlinePushPlugin.setAppShowListener(function(e){e=(e||{}).appShow;new M("setAppShowListenerRes").setMessage("appShow:".concat(e)).end(!0),v.l("".concat(n," ok. appShow:").concat(e)),t._m.isReady()&&(0===e?(t._getConvUnreadCount(),t._onBackground()):1===e&&t._onForeground());})):v.e("".concat(n," setAppShowListener is not a function"));}},{key:"getDeviceBrand",value:function(){var e;if(!A(this._offlinePushPlugin)&&it(this._offlinePushPlugin.getDeviceType))return e=(this._offlinePushPlugin.getDeviceType()||{}).deviceType,v.l("".concat(this._n,".getDeviceBrand ok. deviceType:").concat(e)),e}},{key:"_setToken",value:function(){var t="".concat(this._n,"._setToken"),e=this.get(12),n=1,o="",i="",a=(Je(this._deviceToken)&&(n=0),this.getUniAppPlatform()),s=this.getDeviceBrand(),r=(a===F.IOS||a===F.IPAD||a===F.MAC?i=this._deviceToken:a===F.ANDROID&&(o=this._deviceToken),new M("offlinePushSetToken")),a="deviceToken:".concat(i||o,", businessID:").concat(this._businessID,", ")+"deviceBrand:".concat(s,", isWebUniapp:").concat(this._isWebUniapp,", pushMsg:").concat(n,", platform:").concat(a);return r.setMessage("".concat(a)),v.l("".concat(t," ").concat(a)),this.req({P:I.SET_TOKEN,data:{tokenID:o,pushMsg:n,sdkAppID:e.getSDKAppID(),businessID:parseInt(this._businessID),deviceBrand:s,deviceToken:i,isWebUniapp:this._isWebUniapp}}).then(function(e){return r.end(),v.l("".concat(t," ok")),e}).catch(function(e){return r.setError(e).end(),v.e("".concat(t," failed. error:"),e),C(e)})}},{key:"_getConvUnreadCount",value:function(){var t=this;this._c2cUnreadCount=0,this._groupUnreadCount=0,this.get(11).getLocalConvList().forEach(function(e){e.type===R.CONV_C2C&&(t._c2cUnreadCount+=e.unreadCount),e.type===R.CONV_GROUP&&(t._groupUnreadCount+=e.unreadCount);});}},{key:"_onBackground",value:function(){var t=this,n="".concat(this._n,".").concat("_onBackground"),o=new M("_onBackground");this.req({P:I.STAT_BACKGROUND,data:{c2cUnreadCount:this._c2cUnreadCount,groupUnreadCount:this._groupUnreadCount,isWebUniapp:this._isWebUniapp}}).then(function(e){return o.setMessage("c2cUnreadCount: ".concat(t._c2cUnreadCount,", groupUnreadCount: ").concat(t._groupUnreadCount)).end(),v.l("".concat(n," ok")),e}).catch(function(e){o.setError(e).end(),v.e("".concat(n," failed. error:"),e);});}},{key:"_onForeground",value:function(){var t="".concat(this._n,".").concat("_onForeground"),n=new M("_onForeground");this.req({P:I.STAT_FOREGROUND,data:{isWebUniapp:this._isWebUniapp}}).then(function(e){return n.end(),v.l("".concat(t," ok")),e}).catch(function(e){n.setError(e).end(),v.e("".concat(t," failed. error:"),e);});}},{key:"getUniAppPlatform",value:function(){var e=uni.getSystemInfoSync().platform,t=this.getDeviceBrand();return "ios"===e?F.IOS:"android"===e?F.ANDROID:1002===t?F.IPAD:1001===t?F.MAC:void 0}},{key:"reset",value:function(){this._deviceToken="",this._businessID=0,this._c2cUnreadCount=0,this._groupUnreadCount=0,this._isWebUniapp=0,v.l("".concat(this._n,".reset"));}}]),br),dr=(t(Ur,wn),Fs=f(Ur),e(Ur,[{key:"registerPlugin",value:function(e){var t,n,o;ne?(t="".concat(this._n,".").concat("registerPlugin"),this._pushPlugin=e["tim-push"],this._getDeviceInfo(),n=(o=e.pushConfig||{}).androidConfig,o=o.iOSConfig,$e(n)&&(this._androidPushConfig=n[this._deviceInfo.packageName]),n=(o||{}).iOSBusinessID,this._iOSBusinessID=n,o=!A(this._pushPlugin),new M("registerPlugin").setMessage(this._pluginName).setMoreMessage("isExisted:".concat(o)).end(!0),v.l("".concat(t," ok. pushConfig:").concat(JSON.stringify(e.pushConfig))),o?(this._setAppShowListener(),this._setPushEventReportListener()):v.e("".concat(t," ").concat(this._pluginName," is undefined"))):this.warn("TIMPushInUniapp");}},{key:"init",value:function(){this._isWebUniapp=this.getUniAppPlatform(),this._reportEventCacheList(),this._getDeviceToken(),this.get(27).isFeatureEnabledForStat(Math.pow(2,41));}},{key:"_reportEventCacheList",value:function(){var a=this,s="".concat(this._n,".").concat("_reportEventCacheList");it(this._pushPlugin.getPushEventCacheList)?(new M("_reportEventCacheList").end(!0),this._pushPlugin.getPushEventCacheList(function(e){var t=e.code,n=e.data.eventList,o=new M("getPushEventCacheListRes");if(o.setCode(t),0!==t)o.setMessage("res:".concat(JSON.stringify(e))).end(!0),v.e("".concat(s," failed. error:").concat(JSON.stringify(e)));else {t=n.length<10?"eventList:".concat(JSON.stringify(n)):"eventList.length:".concat(n.length);v.l("".concat(s," ok. ").concat(t)),o.setMessage(t).end(!0);for(var i=y(y({},e.data),{},{eventList:[]});0<n.length;)i.eventList=n.splice(0,40),a._pushReport(i);}})):v.e("".concat(this._pluginName,".getPushEventCacheList is not a function"));}},{key:"_getDeviceToken",value:function(){var r,c=this,u="".concat(this._n,".").concat("_getDeviceToken");it(this._pushPlugin.getDeviceToken)?(r="androidPushConfig:".concat(JSON.stringify(this._androidPushConfig)," iOSBusinessID:").concat(this._iOSBusinessID),v.l("".concat(u," start. ").concat(r)),new M("_getDeviceToken").setMessage("".concat(r)).end(!0),this._pushPlugin.getDeviceToken(this._androidPushConfig,function(e){var t,n,o,i=e.code,a=e.msg,s=new M("getDeviceTokenRes");if(s.setCode(i),0===i)return t=(i=e.data).deviceToken,n=i.deviceBrand,o=i.deviceType,i=i.bussinessId,c._deviceToken=t,c._businessID=i||c._iOSBusinessID,r="deviceToken:".concat(t," deviceBrand:").concat(n||o," businessID:").concat(c._businessID),v.l("".concat(u," ok. ").concat(r)),s.setMessage(r).end(!0),void c._setToken();s.setMessage(a).end(!0),v.e("".concat(u," failed. error:").concat(JSON.stringify(e)));})):v.e("".concat(this._pluginName,".getDeviceToken is not a function"));}},{key:"_getDeviceInfo",value:function(){var e="".concat(this._n,".").concat("_getDeviceInfo");if(it(this._pushPlugin.getDeviceInfo)){var t=this._pushPlugin.getDeviceInfo(),n=t.code,o=t.data,i=new M("_getDeviceInfo");if(i.setCode(n),0===n)return this._deviceInfo=y(y({},this._deviceInfo),o),this._deviceInfo.pushVersion||(this._deviceInfo.pushVersion="1.0.1"),n="deviceInfo:".concat(JSON.stringify(this._deviceInfo)),v.l("".concat(e," ok. ").concat(n)),void i.setMessage(n).end(!0);i.setMessage("deviceInfoRes:".concat(JSON.stringify(t))).end(!0),v.e("".concat(e," failed. error:").concat(JSON.stringify(t)));}else v.e("".concat(this._pluginName,".getDeviceInfo is not a function"));}},{key:"canIUseTIMPush",value:function(){return ne&&!A(this._pushPlugin)}},{key:"_setAppShowListener",value:function(){var t=this,n="".concat(this._n,".").concat("_setAppShowListener");it(this._pushPlugin.setAppShowListener)?(new M("_setAppShowListener").end(!0),v.l("".concat(n," start")),this._pushPlugin.setAppShowListener(function(e){e=(e||{}).appShow;new M("setAppShowListenerRes").setMessage("appShow:".concat(e)).end(!0),v.l("".concat(n," ok. appShow:").concat(e)),t._m.isReady()&&(0===e?(t._getConvUnreadCount(),t._onBackground()):1===e&&t._onForeground());})):v.e("".concat(this._pluginName,".setAppShowListener is not a function"));}},{key:"_setPushEventReportListener",value:function(){var a=this,s="".concat(this._n,".").concat("_setPushEventReportListener");it(this._pushPlugin.setPushEventReportListener)?(new M("_setPushEventReportListener").end(!0),this._pushPlugin.setPushEventReportListener(function(e){var t=e.code,n=e.data,o=n.eventList,i=new M("setPushEventReportListenerRes");if(i.setCode(t),0===t)return t="eventList:".concat(JSON.stringify(o)),v.l("".concat(s," ok. ").concat(t)),i.setMessage(t).end(!0),void(a._m.isReady()&&nt(o)&&0<o.length&&a._pushReport(n));i.setMessage("res:".concat(JSON.stringify(e))).end(!0),v.e("".concat(s," failed. error:").concat(JSON.stringify(e)));})):v.e("".concat(this._pluginName,".setPushEventReportListener is not a function"));}},{key:"getDeviceBrand",value:function(){var e;if(!A(this._pushPlugin)&&it(this._pushPlugin.getDeviceType))return e=(this._pushPlugin.getDeviceType()||{}).deviceType,v.l("".concat(this._n,".getDeviceBrand ok. deviceType:").concat(e)),e}},{key:"_setToken",value:function(){var t="".concat(this._n,".").concat("_setToken"),e=this.get(12),n=1,o="",i="",a=(Je(this._deviceToken)&&(n=0),this.getUniAppPlatform()),s=this.getDeviceBrand(),a=(a===F.IOS||a===F.IPAD||a===F.MAC?i=this._deviceToken:a===F.ANDROID&&(o=this._deviceToken),y({tokenID:o,pushMsg:n,sdkAppID:e.getSDKAppID(),businessID:parseInt(this._businessID),deviceBrand:s,deviceToken:i,isWebUniapp:this._isWebUniapp},this._deviceInfo)),r=new M("_setToken"),o="data:".concat(JSON.stringify(a));r.setMessage("".concat(o)),v.l("".concat(t," ").concat(o)),this.req({P:I.SET_TOKEN,data:a}).then(function(){r.end(),v.w("".concat(t," ok"));}).catch(function(e){r.setError(e).end(),v.e("".concat(t," failed. error:"),e),C(e);});}},{key:"_getConvUnreadCount",value:function(){var t=this;this._c2cUnreadCount=0,this._groupUnreadCount=0,this.get(11).getLocalConvList().forEach(function(e){e.type===R.CONV_C2C&&(t._c2cUnreadCount+=e.unreadCount),e.type===R.CONV_GROUP&&(t._groupUnreadCount+=e.unreadCount);});}},{key:"_onBackground",value:function(){var e=this,t="".concat(this._n,".").concat("_onBackground"),n=new M("_onBackground");this.req({P:I.STAT_BACKGROUND,data:{c2cUnreadCount:this._c2cUnreadCount,groupUnreadCount:this._groupUnreadCount,isWebUniapp:this._isWebUniapp}}).then(function(){n.setMessage("c2cUnreadCount:".concat(e._c2cUnreadCount," groupUnreadCount:").concat(e._groupUnreadCount)).end(),v.l("".concat(t," ok"));}).catch(function(e){n.setError(e).end(),v.e("".concat(t," failed. error:"),e);});}},{key:"_onForeground",value:function(){var t="".concat(this._n,".").concat("_onForeground"),n=new M("_onForeground");this.req({P:I.STAT_FOREGROUND,data:{isWebUniapp:this._isWebUniapp}}).then(function(){n.end(),v.l("".concat(t," ok"));}).catch(function(e){n.setError(e).end(),v.e("".concat(t," failed. error:"),e);});}},{key:"_pushReport",value:function(e){var t=this,n="".concat(this._n,".").concat("_pushReport"),o=new M("_pushReport");this.req({P:I.PUSH_REPORT,data:{eventList:e.eventList}}).then(function(){o.end(),t._notifyReportSuccess(e);}).catch(function(e){o.setError(e).end(),v.e("".concat(n," failed. error:"),e);});}},{key:"_notifyReportSuccess",value:function(e){!A(this._pushPlugin)&&it(this._pushPlugin.notifyReportSuccess)&&(this._pushPlugin.notifyReportSuccess(e),v.l("".concat(this._n,"._notifyReportSuccess ok")));}},{key:"getUniAppPlatform",value:function(){var e=uni.getSystemInfoSync().platform,t=this.getDeviceBrand();return "ios"===e?F.IOS:"android"===e?F.ANDROID:1002===t?F.IPAD:1001===t?F.MAC:void 0}},{key:"reset",value:function(){this._deviceToken="",this._businessID=0,this._c2cUnreadCount=0,this._groupUnreadCount=0,this._isWebUniapp=0,v.l("".concat(this._n,".reset"));}}]),Ur),pr=(t(Pr,wn),ws=f(Pr),e(Pr,[{key:"init",value:function(){var e=this.get(18).getPlugin("tim-profanity-filter-plugin");e&&(this._plugin=new e({logger:v,isArray:nt,isMap:ze,isDevMode:this.isDevMode()}),this._getLexicon());}},{key:"onCheckTimer",value:function(){this._plugin&&this._canIUseLexicon&&this.isLoggedIn()&&!this._isFetching&&Date.now()>=this._expiredTime&&this._getLexicon();}},{key:"filterMessage",value:function(e,t){var n=!0;if(!this._plugin||!this._canIUseLexicon)return n;if(t&&t.messageControlInfo&&!0===t.messageControlInfo.excludedFromContentModeration)return n;var t=e.type,o=e.conversationType;if(t!==R.MSG_TEXT&&t!==R.MSG_CUSTOM)return n;var i,a="".concat(this._n,".filterMessage");if(v.l("".concat(a)),t===R.MSG_TEXT){if(o===R.CONV_C2C?i="c2c_text_message":o===R.CONV_GROUP&&(i="group_text_message"),!this._isConfigOn(i))return n;var s=this._plugin.filter(e.payload.text),r=s.type,s=s.modifiedText;1===r?n=!1:2===r&&(e.payload.text=s);}else if(t===R.MSG_CUSTOM){if(o===R.CONV_C2C?i="c2c_custom_message":o===R.CONV_GROUP&&(i="group_custom_message"),!this._isConfigOn(i))return n;r=this._plugin.filter(e.payload.data),s=this._plugin.filter(e.payload.description),t=this._plugin.filter(e.payload.extension);1===r.type||1===s.type||1===t.type?n=!1:(2===r.type&&(e.payload.data=r.modifiedText),2===s.type&&(e.payload.description=s.modifiedText),2===t.type&&(e.payload.extension=t.modifiedText));}return v.l("".concat(a," done. isAllowedToSend:").concat(n)),n}},{key:"filterText",value:function(e,t){var n="".concat(this._n,".filterText"),o={isAllowedToSend:!0,modifiedText:e};if(!this._plugin||!this._canIUseLexicon)return o;if(!this._isConfigOn(t))return o;v.l("".concat(n));t=this._plugin.filter(e),e=t.type,t=t.modifiedText;return 1===e?o.isAllowedToSend=!1:2===e&&(o.modifiedText=t),v.l("".concat(n," done. ret:"),o),o}},{key:"_getLexicon",value:function(){var l=this,d=new M("profanityFilter"),p="".concat(this._n,"._getLexicon");this._isFetching=!0,this.req({P:I.GET_PROFANITY_LIST,data:{startIndex:this._startIndex,version:this._version}}).then(function(e){var e=e.data,t=e.errorInfo,n=e.filterConfig,o=e.lexicon,i=e.strToken,a=e.completeFlag,s=e.nextStartIndex,r=e.version,e=e.expiredTime,c=t.errorCode,u=t.errorMessage;return 0!==c?(l._isFetching=!1,v.w("".concat(p," failed. error:"),t),void d.setCode(c).setMessage(u).end()):(l._onFilterConfig(n),l._getToken(i),1===a?(v.l("".concat(p," done. version:").concat(r," expiredTime:").concat(e)),l._version=r,l._canIUseLexicon=!0,l._isFetching=!1,l._expiredTime=Date.now()+1e3*e,void l._plugin.onLexiconCompleted(o)):(l._startIndex=s,l._plugin.onLexiconSliced(o),void l._getLexicon()))}).catch(function(e){d.setError(e).end(),l._isFetching=!1,v.l("".concat(p," failed. error:"),e);});}},{key:"_onFilterConfig",value:function(t){var n=this;Je(t)||(this._filterConfigMap.clear(),Object.keys(t).forEach(function(e){n._filterConfigMap.set(e,t[e]);}),v.l("".concat(this._n,"._onFilterConfig. keys:").concat(Array.from(this._filterConfigMap.keys())," values:").concat(Array.from(this._filterConfigMap.values()))));}},{key:"_isConfigOn",value:function(e){return 1===this._filterConfigMap.get(e)}},{key:"_getToken",value:function(e){if(ft(e)){var t=e.length,n="";if(t%2==0)for(var o=0;o<=t-1;o+=2)n=(n+=e[o+1])+e[o];else {for(var i=0;i<t-1;i+=2)n=(n+=e[i+1])+e[i];n+=e[t-1];}this._plugin.onToken(n);}}},{key:"reset",value:function(){v.l("".concat(this._n,".reset")),this._plugin&&(this._plugin.reset(),this._plugin=null),this._filterConfigMap.clear(),this._startIndex=0,this._version=0,this._canIUseLexicon=!1,this._isFetching=!1,this._expiredTime=0;}}]),Pr),_r=(e(Gr,[{key:"_onCloudConfig",value:function(){var t=this,e=this._m.get(23).getCloudConfig("rtc_cmd");A(e)||((e=JSON.parse(e)).forEach(function(e){t._TRTCCommandList.includes(e)||t._TRTCCommandList.push(e);}),this._setTRTCCommandMap());}},{key:"_setTRTCCommandMap",value:function(){for(var e,t=0,n=this._TRTCCommandList.length;t<n;t++)e=this._TRTCCommandList[t].split(".")[0],this._TRTCCommandMap.set(e,1);}},{key:"onRoomCustomDataReceived",value:function(e){this._m.getOEmitInst().emit(G.ROOM_CUSTOM_DATA_RECEIVED,e);}},{key:"sendTRTCCustomData",value:function(e){var t=e.serviceCommand,e=e.data,n="".concat(a.NAME.TUIROOM_SVR,".*");return A(t)||(n=t),this._isValidServiceCommand(n)?this._trans({servcmd:n,data:e}):C({code:T.INVALID_TRTC_CMD})}},{key:"_trans",value:function(e){v.d("".concat(this._n,"._trans. options:").concat(JSON.stringify(e)));var t=e.servcmd,e=e.data;return this._m.get(20).trans({servcmd:t,data:ft(e)?JSON.parse(e):e})}},{key:"_isValidServiceCommand",value:function(e){if(e.endsWith(".*"))return this._TRTCCommandList.includes(e);e=e.split(".")[0];return this._TRTCCommandMap.has(e)}},{key:"isTRTCCommand",value:function(e){e=e.split(".")[0];return this._TRTCCommandMap.has(e)}},{key:"reset",value:function(){v.l("".concat(this._n,".reset"));}}]),Gr),hr=(e(Nr,[{key:"_init",value:function(){var e,t=this._getStorageModule().getItem(this.TIM_ERROR_ASSISTANCE,!1);if(t){try{e=JSON.parse(t);}catch(e){this._getStorageModule().removeItem(this.TIM_ERROR_ASSISTANCE,!1),v.w("".concat(this._n,"._init error:"),e);}e&&(this._needToUpdate(e)?this._fetch():this._fillMap(e.message));}else this._fetch();}},{key:"_needToUpdate",value:function(e){var t=e.localSavedTime,e=e.localSavedVersion,t=t&&(new Date).getTime()-t>=this.STORAGE_EXPIRES_TIME,e=!e||"3.5.0"!==e;return v.l("".concat(this._n,"._needToUpdate isTimeout:").concat(t," isDifferentVersion:").concat(e)),t||e}},{key:"_fetch",value:function(){var e,t,n,o,i,a;this._m.get(12).isPrivateNetWork()||(e="https://web.sdk.qcloud.com/im/download/error-message/v3/0.0.7/tim-error-message.txt",t="application/x-www-form-urlencoded;charset=UTF-8",n="".concat(this._n,"._fetch ok in"),o=this,ae?ue.request({url:e,method:"GET",timeout:3e3,header:{"content-type":t},dataType:"text",success:function(e){o._fillAndSave(e.data),v.l("".concat(n," mini program"));},fail:function(){}}):(i=new XMLHttpRequest,a=setTimeout(function(){i.abort();},3e3),i.onreadystatechange=function(){4===i.readyState&&(a&&clearTimeout(a),200!==i.status&&304!==i.status||(v.l("".concat(n," browser")),o._fillAndSave(i.responseText)));},i.open("GET",e,!0),i.setRequestHeader("Content-type",t),i.send()));}},{key:"_fillAndSave",value:function(e){this._fillMap(e),this._getStorageModule().setItem(this.TIM_ERROR_ASSISTANCE,JSON.stringify({message:e,localSavedTime:(new Date).getTime(),localSavedVersion:"3.5.0"}),!0,!1);}},{key:"_getStorageModule",value:function(){return this._m.get(13)}},{key:"_fillMap",value:function(e){this._map.clear();for(var t,n,o=e.split(";\n"),i=o.length,a=new RegExp(/'/g),s=0;s<i;s++)if(n=o[s].indexOf(":"),t=o[s].slice(0,n),n=o[s].slice(n+1,o[s].length),!t.startsWith("//")){if(A(n))continue;this._map.set(t,n.replace(a,""));}}},{key:"get",value:function(e){var t=e.isIntl,n=e.key,o=e.replacement1,e=e.replacement2,t="".concat(n,t?"_en":"_cn"),n=(!this._map.has(t)&&this._map.has(n)&&(t=n),"");return this._map.has(t)&&(n=this._map.get(t),A(o)||(n=n.replace("$replacement1",o)),A(e)||(n=n.replace("$replacement2",e))),n}},{key:"reset",value:function(){v.l("".concat(this._n,".reset"));}}]),Nr),gr=(e(Or,[{key:"onNewMessageList",value:function(e){var n=this;e.forEach(function(e){var t=n.getPayloadData(e);t&&n._handleActionType(t,e);});}},{key:"onMessageModified",value:function(e){var n=this;e.forEach(function(e){var t=n.getPayloadData(e);t&&n._onInvitationModified(t,e);});}},{key:"getPayloadData",value:function(t){var n="".concat(this._n,".getPayloadData"),t=t.payload.data;try{return JSON.parse(t)}catch(e){return v.e("".concat(n," JSON parse error. signalingData:").concat(t)),null}}},{key:"_handleActionType",value:function(e,t){switch(e.actionType){case P.ACTION_TYPE_INVITE:this._onNewInvitationReceived(e,t);break;case P.ACTION_TYPE_REJECT_INVITE:this._onInviteeRejected(e);break;case P.ACTION_TYPE_ACCEPT_INVITE:this._onInviteeAccepted(e);break;case P.ACTION_TYPE_CANCEL_INVITE:this._onInvitationCancelled(e);break;case P.ACTION_TYPE_INVITE_TIMEOUT:this._onInvitationTimeout(e);}}},{key:"_genBaseEmitData",value:function(e){return {inviteID:e.inviteID,inviter:e.inviter,groupID:e.groupID,data:e.data||""}}},{key:"_onNewInvitationReceived",value:function(e,t){var n="".concat(this._n,"._onNewInvitationReceived"),o=e.inviteID,i=e.inviteeList,a=e.groupID,l=e.inviter,s=this._sigM.getMyUserID(),r=i.includes(s),c=e.timeout,u=(Re().getTime()-1e3*t.time)/1e3,n=(0<c&&0<u&&u<c&&(c-=u),"".concat(n," myselfIncluded:").concat(r," groupID:").concat(a," signalObj:").concat(JSON.stringify(e)));v.l("".concat(n," timeout:").concat(c,"s delta:").concat(u,"s")),(a&&r||!a)&&((n=this._sigM.getInviteInfo(o))&&n===e||(n||this._sigM.setInviteInfo(o,y(y({},e),{},{message:t})),this._sigM.emitEvent(P.NEW_INVITATION_RECEIVED,y(y({},this._genBaseEmitData(e)),{},{inviteeList:i})),l!==s&&this._sigM.startTimer(y(y({},e),{},{timeout:c}))));}},{key:"_onInviteeRejected",value:function(e){var t="".concat(this._n,"._onInviteeRejected"),n=e.inviteID,o=e.inviter,i=e.groupID,a=this._sigM.hasInviteInfo(n);v.l("".concat(t," inviteID:").concat(n," hasInviteID:").concat(a," inviter:").concat(o," groupID:").concat(i)),a&&(this._sigM.updateInviteInfo(e),this._sigM.emitEvent(P.INVITEE_REJECTED,y(y({},this._genBaseEmitData(e)),{},{invitee:e.inviteeList[0]})));}},{key:"_onInviteeAccepted",value:function(e){var t="".concat(this._n,"._onInviteeAccepted"),n=e.inviteID,o=e.inviter,i=e.groupID,a=this._sigM.hasInviteInfo(n);v.l("".concat(t," inviteID:").concat(n," hasInviteID:").concat(a," inviter:").concat(o," groupID:").concat(i)),a&&(this._sigM.updateInviteInfo(e),this._sigM.emitEvent(P.INVITEE_ACCEPTED,y(y({},this._genBaseEmitData(e)),{},{invitee:e.inviteeList[0]})));}},{key:"_onInvitationCancelled",value:function(e){var t="".concat(this._n,"._onInvitationCancelled"),n=e.inviteID,o=e.inviter,i=e.groupID,a=this._sigM.hasInviteInfo(n);v.l("".concat(t," inviteID:").concat(n," hasInviteID:").concat(a," inviter:").concat(o," groupID:").concat(i)),a&&(this._sigM.deleteInviteInfo(n),this._sigM.emitEvent(P.INVITATION_CANCELLED,this._genBaseEmitData(e)));}},{key:"_onInvitationTimeout",value:function(e){var t="".concat(this._n,"._onInvitationTimeout"),n=e.inviteID,o=e.inviter,i=e.groupID,a=e.inviteeList,s=this._sigM.hasInviteInfo(n);v.l("".concat(t," inviteID:").concat(n," hasInviteID:").concat(s," inviter:").concat(o," groupID:").concat(i,"  data:").concat(e.data)),s&&(this._sigM.updateInviteInfo(e),this._sigM.emitEvent(P.INVITATION_TIMEOUT,y(y({},this._genBaseEmitData(e)),{},{inviteeList:a,isSelfTimeout:!1})));}},{key:"_onInvitationModified",value:function(e,t){var n="".concat(this._n,"._onInvitationModified"),o=e.inviteID,i=e.data;v.l("".concat(n," inviteID:").concat(o," data:").concat(i)),this._sigM.setInviteInfo(o,y(y({},e),{},{message:t})),this._sigM.emitEvent(P.INVITATION_MODIFIED,{inviteID:o,data:i});}}]),Or),fr=(e(Ar,[{key:"generateInviteID",value:function(){var e,t=(t=Ps)((e=Gs)(32),8)+"-"+t(e(16),4)+"-"+t(16384|e(12),4)+"-"+t(32768|e(14),4)+"-"+t(e(48),12);return v.l("".concat(this._n,".generateInviteID inviteID:").concat(t)),t}},{key:"createInviteInfo",value:function(e){var t=this.generateInviteID(),e=this.createInviteCustomData(y(y({},e),{},{inviteID:t})),n=e.groupID,o=e.inviteeList,n=n||o[0];return {customData:e,message:this._sigM.createSignaling(e,n),inviteID:t}}},{key:"_genBaseCustomData",value:function(e){var t=e.data,n=e.inviteID,e=e.groupID;return {businessID:1,timeout:0,data:void 0===t?"":t,inviteID:void 0===n?"":n,groupID:void 0===e?"":e}}},{key:"createInviteCustomData",value:function(e){var t=e.userID,n=e.timeout,n=void 0===n?0:n,o=e.groupID,o=void 0===o?"":o,i=this._sigM.getMyUserID(),i=y(y({},this._genBaseCustomData(e)),{},{actionType:P.ACTION_TYPE_INVITE,inviter:i,inviteeList:o?e.inviteeList:[t],timeout:n});return v.l("".concat(this._n,".createInviteCustomData customData:"),i),i}},{key:"createCancelCustomData",value:function(e){var t,n="".concat(this._n,".createCancelCustomData"),o=e.inviteID,i=this._sigM.getMyUserID(),o=this._sigM.getInviteInfo(o),a=o.inviteeList,s=o.groupID,o=o.inviter;return o===i?t=y(y({},this._genBaseCustomData(e)),{},{actionType:P.ACTION_TYPE_CANCEL_INVITE,groupID:s,inviter:i,inviteeList:a}):v.e("".concat(n," unmatched inviter:").concat(o," and my userID:").concat(i)),v.l("".concat(n," customData:"),t),t}},{key:"createAcceptCustomData",value:function(e){var t,n="".concat(this._n,".createAcceptCustomData"),o=e.inviteID,i=this._sigM.getMyUserID(),a=this._sigM.getInviteInfo(o),s=a.inviter,r=a.groupID;return a.inviteeList.includes(i)?t=y(y({},this._genBaseCustomData(e)),{},{actionType:P.ACTION_TYPE_ACCEPT_INVITE,groupID:r,inviter:s,inviteeList:[i]}):v.e("".concat(n," userID:").concat(i," not in inviteeList. inviteID:").concat(o," groupID:").concat(r)),v.l("".concat(n," customData:"),t),t}},{key:"createRejectCustomData",value:function(e){var t,n="".concat(this._n,".createRejectCustomData"),o=e.inviteID,i=this._sigM.getMyUserID(),a=this._sigM.getInviteInfo(o),s=a.inviter,r=a.groupID;return a.inviteeList.includes(i)?t=y(y({},this._genBaseCustomData(e)),{},{actionType:P.ACTION_TYPE_REJECT_INVITE,groupID:r,inviter:s,inviteeList:[i]}):v.e("".concat(n," userID:").concat(i," not in inviteeList. inviteID:").concat(o," groupID:").concat(r)),v.l("".concat(n," customData:"),t),t}},{key:"createTimeoutCustomData",value:function(e){var t="".concat(this._n,".createTimeoutCustomData"),n=e.inviteeList,o=e.inviter,i=e.isInviter,i=void 0!==i&&i,a=this._sigM.getMyUserID(),e=y(y({},this._genBaseCustomData(e)),{},{actionType:P.ACTION_TYPE_INVITE_TIMEOUT,inviter:o,inviteeList:i?n:[a]});return v.l("".concat(t," customData:"),e),e}}]),Ar),mr=(e(Rr,[{key:"setCloudConfig",value:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:20,t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:300;this.COUNT=e,this.EXPIRED_TIME=t,v.l("".concat(this._n,".setCloudConfig count:").concat(e,", time:").concat(t));}},{key:"getHistorySignaling",value:function(){var t=this,e=this._sigM.get(11).getLocalConvList();Je(e)||(this._getC2CSignalingList(),e=this._getValidGroupConvList(e),this._getGroupSignalingList(e).then(function(e){t._handleSignalingList(e);}));}},{key:"_getC2CSignalingList",value:function(){var e=this._sigM.get(6).getMessageListFromUnreadDB(),e=this._sigM.filterMessageList(e);this._getRelatedToMeMap(e);}},{key:"_getGroupSignalingList",value:function(e){var n=this,e=this._createPromiseList(e);return 0===e.length?Promise.resolve(this._sortSignaling(this._relatedToMeMap)):this._concurrentGetMessageList(e).then(function(e){var t=new Map;return e.forEach(function(e){e=e.list,e=n._getRelatedToMeMap(e);t=new Map([].concat(D(t),D(e)));}),n._sortSignaling(t)})}},{key:"_handleSignalingList",value:function(e){Je(e)||this._sigM.onNewMessageList(e);}},{key:"_getValidGroupConvList",value:function(e){for(var t=[],n=0,o=e.length;n<o;n++){var i=e[n],a=i.type,s=i.unreadCount,i=i.lastMessage,a=a===R.CONV_GROUP,i=this._isNotExpired(i);a&&s&&i&&t.push(e[n]);}return t}},{key:"_isNotExpired",value:function(e){return !(!e||!e.lastTime)&&e.lastTime>Oe()-this.EXPIRED_TIME}},{key:"_createPromiseList",value:function(e){for(var t=[],n=0;n<e.length;n++){var o=e[n],i=o.conversationID,o=o.unreadCount,o=o<this.COUNT?o:this.COUNT,o=(this._map.set(i,{msgCount:o,list:[]}),this._sigM.get(11).getMessageList({conversationID:i}));t.push(o);}return t}},{key:"_concurrentGetMessageList",value:function(e){var i=this,a=[];return Promise.all(e).then(function(e){for(var t=0;t<e.length;t++){var n=e[t],o=n.code,n=n.data;0===o&&0!==n.messageList.length&&(i._handleMessageList(n.messageList),(o=i._relayGetMessageList(n))&&a.push(o));}return 0<a.length?i._concurrentGetMessageList(a):i._map})}},{key:"_relayGetMessageList",value:function(e){var t=e.messageList,n=e.nextReqMessageID,e=e.isCompleted;if(0===t.length)return null;var t=t[0].conversationID,o=this._map.get(t).msgCount;return 0===o||e?null:this._sigM.get(11).getMessageList({conversationID:t,nextReqMessageID:n,count:o})}},{key:"_handleMessageList",value:function(e){var t=e.length,n=e[0].conversationID,o=this._map.get(n),i=o.msgCount,o=o.list;this._map.set(n,{msgCount:0<i-t?i-t:0,list:o.concat(this._sigM.filterMessageList(e))});}},{key:"_getRelatedToMeMap",value:function(e){for(var t=0;t<e.length;t++){var n=e[t];this._saveRelatedToMe(n);}return this._relatedToMeMap}},{key:"_saveRelatedToMe",value:function(e){var t=this._sigM.getPayloadData(e)||{},n=t.actionType,t=t.inviteID,o=void 0===t?"":t;switch(void 0===n?"":n){case P.ACTION_TYPE_INVITE:this._setHistoryInvite(e);break;case P.ACTION_TYPE_REJECT_INVITE:case P.ACTION_TYPE_ACCEPT_INVITE:this._updateHistoryInvite(e);break;case P.ACTION_TYPE_CANCEL_INVITE:this._delHistoryInvite(o);break;case P.ACTION_TYPE_INVITE_TIMEOUT:this._updateHistoryInvite(e);}}},{key:"_setHistoryInvite",value:function(e){var t=this._sigM.getPayloadData(e)||{},n=t.inviteID,n=void 0===n?"":n,o=t.inviteeList,o=void 0===o?[]:o,i=t.timeout,i=void 0===i?0:i,a=this._sigM.getMyUserID();o.includes(a)&&(o=Oe()-e.time,0<i&&i<o&&0!==i||this._relatedToMeMap.set(n,y(y({},t),{},{messageList:[e]})));}},{key:"_delHistoryInvite",value:function(e){this._relatedToMeMap.has(e)&&this._relatedToMeMap.delete(e);}},{key:"_updateHistoryInvite",value:function(e){var t=this._sigM.getPayloadData(e)||{},n=t.inviteID,n=void 0===n?"":n,t=t.inviteeList,o=void 0===t?[]:t;if(this._relatedToMeMap.has(n)){for(var t=this._relatedToMeMap.get(n),i=t.inviteeList,t=t.messageList,a=0;a<o.length;a++){var s=o[a];i.includes(s)&&i.splice(i.indexOf(s),1);}0===i.length?this._delHistoryInvite(n):t.push(e);}else this._delHistoryInvite(n);}},{key:"_sortSignaling",value:function(e){var t=[];return e.forEach(function(e){t=[].concat(D(t),D(e.messageList));}),t.sort(function(e,t){return e.time-t.time})}},{key:"reset",value:function(){this._map.clear(),this._relatedToMeMap.clear();}}]),Rr),vr=e(function e(t,n){d(this,e),this.businessID=t.businessID||1,this.inviteID=t.inviteID,this.groupID=t.groupID||"",this.inviter=t.inviter||"",this.inviteeList=t.inviteeList||[],this.data=t.data||"",this.actionType=t.actionType||P.ACTION_TYPE_INVITE,this.timeout=t.timeout||0;}),Ir=["message"],Mr=["message"],yr=(t(kr,wn),bs=f(kr),e(kr,[{key:"onC2CUnreadHandleCompleted",value:function(){this._isC2CUnreadHandleCompleted=!0,this._isCloudConfigCompleted&&this._isConvSyncCompleted&&!this._isSyncCompleted&&this.onReady();}},{key:"onConvSyncCompleted",value:function(){this._isConvSyncCompleted=!0,this._isC2CUnreadHandleCompleted&&this._isCloudConfigCompleted&&!this._isSyncCompleted&&this.onReady();}},{key:"onCloudConfig",value:function(){this._isCloudConfigCompleted=!0;var e=this.getCloudConfig("history_s_count"),t=this.getCloudConfig("history_s_time");A(e)||(e=Number(e)),A(t)||(t=Number(t)),this._historySignalingHandler.setCloudConfig(e,t),this._isC2CUnreadHandleCompleted&&this._isConvSyncCompleted&&!this._isSyncCompleted&&this.onReady();}},{key:"_isListenerExisted",value:function(){return -1<this._m.getOEmitInst().eventNames().indexOf(P.NEW_INVITATION_RECEIVED)}},{key:"onReady",value:function(){this._isSyncCompleted=!0;var e=this._isListenerExisted();v.l("".concat(this._n,".onReady. isListenerExisted: ").concat(e)),e&&this._historySignalingHandler.getHistorySignaling();}},{key:"onNewMessageList",value:function(e){e=this.filterMessageList(e);if(0<e.length)return this._remoteSignalingHandler.onNewMessageList(e)}},{key:"onMessageModified",value:function(e){e=this.filterMessageList(e);if(0<e.length)return this._remoteSignalingHandler.onMessageModified(e)}},{key:"hasInviteInfo",value:function(e){return this._inviteInfoMap.has(e)}},{key:"getInviteInfo",value:function(e){return this._inviteInfoMap.get(e)}},{key:"setInviteInfo",value:function(e,t){var n=t.message,t=g(t,Ir);v.l("".concat(this._n,".setInviteInfo inviteID:").concat(e," data:"),t),this._inviteInfoMap.set(e,y(y({},t),{},{message:n}));}},{key:"deleteInviteInfo",value:function(e){this.hasInviteInfo(e)&&(v.l("".concat(this._n,".deleteInviteInfo inviteID:").concat(e,".")),this._inviteInfoMap.delete(e));}},{key:"updateInviteInfo",value:function(e){var t="".concat(this._n,".updateInviteInfo"),n=e.inviteID,o=e.inviter,i=e.inviteeList,e=e.groupID;v.l("".concat(t," inviteID:").concat(n," inviter:").concat(o," groupID:").concat(e)),e&&this.hasInviteInfo(n)?(o=i[0],(e=this.getInviteInfo(n).inviteeList).includes(o)&&(e.splice(e.indexOf(o),1),v.l("".concat(t," remove ").concat(o,". localInviteeList.length:").concat(e.length))),0===e.length&&this.deleteInviteInfo(n)):this.deleteInviteInfo(n);}},{key:"canIUseSignaling",value:function(){return this._canIUseSignaling}},{key:"emitEvent",value:function(e,t){this.emitOEvt(e,t);}},{key:"addSignalingListener",value:function(e,t,n){this._canIUseSignaling||(this._canIUseSignaling=!0),this._m.getOEmitInst().on(e,t,n);}},{key:"removeSignalingListener",value:function(e,t,n){this._m.getOEmitInst().off(e,t,n),this._isListenerExisted()||(this._canIUseSignaling=!1);}},{key:"invite",value:function(e){var t=this,n="".concat(this._n,".").concat("invite"),o=this._localSignalingHandler.createInviteInfo(e),i=o.message,a=o.customData,s=o.inviteID;return v.l("".concat(n," options:").concat(JSON.stringify(e)," inviteID:").concat(s)),this.sendSignaling(i,e).then(function(e){return e&&0===e.code?(t.setInviteInfo(s,y(y({},a),{},{message:i})),t.startTimer(y(y({},a),{},{inviteID:s})),y(y({},e),{},{inviteID:s})):e}).catch(function(e){return C(e)})}},{key:"inviteSync",value:function(e,t,n){var o=this,i="".concat(this._n,".").concat("inviteSync"),a=this._localSignalingHandler.createInviteInfo(e),s=a.message,r=a.customData,c=a.inviteID;return v.l("".concat(i," options:").concat(JSON.stringify(e)," inviteID:").concat(c)),this.sendSignaling(s,e).then(function(e){if(e&&0===e.code)return o.setInviteInfo(c,y(y({},r),{},{message:s})),o.startTimer(y(y({},r),{},{inviteID:c})),t&&t({inviteID:c}),{inviteID:c};n&&n(0===e.code,e.message||"");}).catch(function(e){return n&&n(e.code,e.message),C(e)}),c}},{key:"_handleImResponse",value:function(e,t,n){t&&0===t.code&&(this._isHandling=!1,n?this.deleteInviteInfo(e.inviteID):this.updateInviteInfo(e));}},{key:"cancel",value:function(t){var n=this,e="".concat(this._n,".").concat("cancel");if(v.l("".concat(e," options:").concat(JSON.stringify(t))),!this.hasInviteInfo(t.inviteID)||this._isHandling)return C({code:T.INVALID_CANCEL_MESSAGE});this._isHandling=!0;var o=this._localSignalingHandler.createCancelCustomData(t);if(!o)return this._isHandling=!1,C({code:T.SIGNALING_NO_PERMISSION});var e=o.groupID,i=o.inviteeList,e=e||i[0],i=this.createSignaling(o,e);return this.sendSignaling(i,t).then(function(e){return n._handleImResponse(o,e,!0),0===e.code?y(y({},e),{},{inviteID:t.inviteID}):e}).catch(function(e){return C(e)})}},{key:"accept",value:function(t){var n=this,e="".concat(this._n,".").concat("accept");if(v.l("".concat(e," options:").concat(JSON.stringify(t))),!this.hasInviteInfo(t.inviteID)||this._isHandling)return C({code:T.SIGNALING_INVALID_INVITE_ID});this._isHandling=!0;var o=this._localSignalingHandler.createAcceptCustomData(t);if(!o)return this._isHandling=!1,C({code:T.SIGNALING_NO_PERMISSION});e=this.createSignaling(o);return this.sendSignaling(e,t).then(function(e){return n._handleImResponse(o,e),0===e.code?y(y({},e),{},{inviteID:t.inviteID}):e}).catch(function(e){return C(e)})}},{key:"reject",value:function(t){var n=this,e="".concat(this._n,".").concat("reject");if(v.l("".concat(e," options:").concat(JSON.stringify(t))),!this.hasInviteInfo(t.inviteID)||this._isHandling)return C({code:T.SIGNALING_INVALID_INVITE_ID});this._isHandling=!0;var o=this._localSignalingHandler.createRejectCustomData(t);if(!o)return this._isHandling=!1,C({code:T.SIGNALING_NO_PERMISSION});e=this.createSignaling(o);return this.sendSignaling(e,t).then(function(e){return n._handleImResponse(o,e,!0),0===e.code?y(y({},e),{},{inviteID:t.inviteID}):e}).catch(function(e){return C(e)})}},{key:"getSignalingInfo",value:function(e){var t="".concat(this._n,".getSignalingInfo"),n=e.ID,o=e.from,i=e.to,a=this._filterSignaling(e),s=null,e=(a&&(e=this.getPayloadData(e),s=new vr(e)),a?"actionType:".concat(s.actionType):"");return v.l("".concat(t," messageID:").concat(n," from:").concat(o," to:").concat(i," ")+"".concat(e," isSignaling:").concat(a)),s}},{key:"modifyInvitation",value:function(e){var t=this,n=e.inviteID,o=e.data;if(!this.hasInviteInfo(e.inviteID)||this._isHandling)return C({code:T.SIGNALING_INVALID_INVITE_ID});this._isHandling=!0;var e=this.getInviteInfo(n),i=e.message,a=g(e,Mr),s=i.payload.data;return a.data=o,i.payload.data=JSON.stringify(a),this.get(2).modifyRemoteMessage(i).then(function(e){return t.setInviteInfo(n,y(y({},a),{},{message:i})),t._isHandling=!1,e}).catch(function(e){return t._isHandling=!1,i.payload.data=s,C(e)})}},{key:"_genMsgCtrlInfo",value:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},t=e.data,t=void 0===t?"":t,n=e.onlineUserOnly,o=e.inviteID,o=void 0===o?"":o,i=e.offlinePushInfo,e=e.actionType,a={_onlineOnlyFlag:!1},o={onlineUserOnly:(a=o&&this.getInviteInfo(o)?this.getInviteInfo(o).message:a)._onlineOnlyFlag||n||!1,offlinePushInfo:i,messageControlInfo:{excludedFromContentModeration:!0,excludedFromUnreadCount:!1,excludedFromLastMessage:!1}};if(e===P.ACTION_TYPE_INVITE_TIMEOUT)return a=!!t.match(/excludeTimeoutSignalingFromHistoryMessage/),o.messageControlInfo.excludedFromUnreadCount=a,o.messageControlInfo.excludedFromLastMessage=a,o;n=!!t.match(/excludeFromHistoryMessage/),i=!!t.match(/excludeOriginalSignalingFromHistoryMessage/);return o.messageControlInfo.excludedFromUnreadCount=n||i,o.messageControlInfo.excludedFromLastMessage=n||i,o}},{key:"sendSignaling",value:function(e,t){var n=this;return this.get(2).sendMessageInstance(e,this._genMsgCtrlInfo(t)).catch(function(e){return n._isHandling=!1,C(e)})}},{key:"filterMessageList",value:function(e){var t=this;return e.filter(function(e){return t._filterSignaling(e)})}},{key:"getPayloadData",value:function(e){return this._remoteSignalingHandler.getPayloadData(e)}},{key:"createSignaling",value:function(e,t){var n=e.groupID,o=e.inviter,t={to:t||n||o,conversationType:n?R.CONV_GROUP:R.CONV_C2C,priority:R.MSG_PRIORITY_HIGH,payload:{data:JSON.stringify(e)}},o=this.get(2).createCustomMessage(t);return v.l("".concat(this._n,".createSignaling. message:"),o),o}},{key:"_filterSignaling",value:function(e){var t,n,o=!1;return e.type&&e.type===R.MSG_CUSTOM&&(t=e.cloudCustomData,e=void 0===(e=e.payload.data)?"":e,t=(void 0===t?"":t).match(/"type":"tsignaling"/),n=e.match(/inviteID/),e=e.match(/actionType/),o=t||n&&e),!!o}},{key:"startTimer",value:function(t){var n,o,i,a=this,s="".concat(this._n,".startTimer"),e=t.timeout,r=t.inviteID,c=t.inviter,l=t.groupID,u=c===this.getMyUserID();v.l("".concat(s," timeout:").concat(e," isInviter:").concat(u," groupID:").concat(l)),e<=0||(n=u?e+5:e,o=1,i=setInterval(function(){var e=a._hasLocalInviteInfo(t,u);o<n&&e?++o:(e&&a._sendTimeoutNotice(r,u),v.l("".concat(s," end.")),clearInterval(i));},1e3));}},{key:"_hasLocalInviteInfo",value:function(e,t){var n=e.inviteID,e=e.groupID;if(!this.hasInviteInfo(n))return !1;var o="".concat(this._n,"._hasLocalInviteInfo"),i=this.getInviteInfo(n).inviteeList;return v.l("".concat(o," inviteID:").concat(n," inviteeList:").concat(i," groupID:").concat(e)),!e||(t?0<i.length:0<i.length&&i.includes(this.getMyUserID()))}},{key:"_getReceiver",value:function(e,t){var n=t.groupID,o=t.inviteeList,t=t.inviter;return e?n||o[0]:n||t}},{key:"_sendTimeoutNotice",value:function(i,a){var s=this,e=this.getInviteInfo(i),t=this._getReceiver(a,e),r=(v.l("".concat(this._n,"._sendTimeoutNotice inviteID:").concat(i," to:").concat(t," isInviter:").concat(a)),this._localSignalingHandler.createTimeoutCustomData(y(y({},e),{},{isInviter:a}))),c=this.createSignaling(r,t);return this.sendSignaling(c,r).then(function(e){var t,n,o;e&&0===e.code&&(e=r.data,t=r.groupID,n=r.inviteeList,o=r.inviter,s.emitEvent(P.INVITATION_TIMEOUT,{data:e,groupID:t,inviteID:i,inviteeList:n,inviter:o,isSelfTimeout:!0,message:c}),a?s.deleteInviteInfo(i):s.updateInviteInfo(r));})}},{key:"reset",value:function(){v.l("".concat(this._n,".reset")),this._inviteInfoMap.clear(),this._canIUseSignaling=!1,this._isHandling=!1,this._historySignalingHandler.reset(),this._isC2CUnreadHandleCompleted=!1,this._isConvSyncCompleted=!1,this._isSyncCompleted=!1,this._isCloudConfigCompleted=!1;}}]),kr),Cr=["followDiffList"],Tr=["from"],Dr={NONE:0,FOLLOWERS:1,FOLLOWING:2,MUTUAL:3},Er=(t(Sr,wn),Us=f(Sr),e(Sr,[{key:"_onCloudConfig",value:function(){var e=this.getCloudConfig("follow_req_count");A(e)||(e=Number(e),this.DEFAULT_COUNT=e>this.MAX_COUNT?this.MAX_COUNT:e,this._clearFollowList());}},{key:"clearCacheOnReconnected",value:function(){this._clearFollowList();}},{key:"onFollowNotify",value:function(e){var a=this,e=e.dataList||[];v.l("".concat(this._n,".onFollowNotify followChangeList:").concat(e.length)),e.forEach(function(e){var t=e.followDiffList,t=void 0===t?[]:t,e=g(e,Cr),o=e.from,i=g(e,Tr);t.forEach(function(e){var t=e.isAdd,e=e.followType,e=void 0===e?0:e,n=a._initFollowInfo();1===t?(i.userID=o,n[e].userInfoList.push(i),n[e].isAdd=!0):(n[e].userInfoList.push(o),n[e].isAdd=!1),a._emitEvent(n);});});}},{key:"_initFollowInfo",value:function(){var t={};return Object.values(Dr).forEach(function(e){e!==Dr.NONE&&(t[e]={userInfoList:[],isAdd:!1});}),t}},{key:"_emitEvent",value:function(n){var o=this;Object.keys(n).forEach(function(e){var e=Number(e),t=n[e];0<t.userInfoList.length&&(e===Dr.FOLLOWERS&&(o._clearFollowList(Dr.FOLLOWERS),o.emitOEvt(G.MY_FOLLOWERS_LIST_UPDATED,t)),e===Dr.FOLLOWING&&(o._clearFollowList(Dr.FOLLOWING),o.emitOEvt(G.MY_FOLLOWING_LIST_UPDATED,t)),e===Dr.MUTUAL&&(o._clearFollowList(Dr.MUTUAL),o.emitOEvt(G.MUTUAL_FOLLOWERS_LIST_UPDATED,t)));});}},{key:"followUser",value:function(e){if(!this.canIUse(H.FOLLOW))return this.noUse("followUser");var t="".concat(this._n,".").concat("followUser"),n="userIDList:".concat(e.length),o=new M("followUser");return o.setMessage(n),v.l("".concat(t," ").concat(n)),this.req({P:I.FOLLOW,data:{fromAccount:this.getMyUserID(),userIDList:e.map(function(e){return {userID:e}})}}).then(function(e){return o.end(),v.l("".concat(t," ok.")),Ln(e.data.resultList)}).catch(function(e){return o.setError(e).end(),v.e("".concat(t," failed. error:"),e),C(e)})}},{key:"unfollowUser",value:function(e){if(!this.canIUse(H.FOLLOW))return this.noUse("unfollowUser");var t="".concat(this._n,".").concat("unfollowUser"),n="userIDList:".concat(e.length),o=new M("unfollowUser");return o.setMessage(n),v.l("".concat(t," ").concat(n)),this.req({P:I.UNFOLLOW,data:{fromAccount:this.getMyUserID(),userIDList:e}}).then(function(e){return o.end(),v.l("".concat(t," ok.")),Ln(e.data.resultList)}).catch(function(e){return o.setError(e).end(),v.e("".concat(t," failed. error:"),e),C(e)})}},{key:"getMyFollowersList",value:function(){var t=this,n=0<arguments.length&&void 0!==arguments[0]?arguments[0]:"",o="getMyFollowersList";if(!this.canIUse(H.FOLLOW))return this.noUse(o);var i=n||this.FIRST_PAGE_INDEX;if(this._myFollowersList.has(i)){var e=this._myFollowersList.get(i),a=e.resultList,s=e.nextCursor,e=e.lastUpdateTime;if(Date.now()-e<this.MAX_CATCH_TIME&&0<a.length)return v.l("".concat(this._n,".").concat(o," nextCursor:").concat(n," from local.")),Sn({resultList:a,nextCursor:s})}return this._getFollowList(n,Dr.FOLLOWERS).then(function(e){return t._myFollowersList.set(i,y(y({},e),{},{lastUpdateTime:Date.now()})),v.l("".concat(t._n,".").concat(o," nextCursor:").concat(n," from remote.")),Ln(e)})}},{key:"getMyFollowingList",value:function(){var t=this,n=0<arguments.length&&void 0!==arguments[0]?arguments[0]:"",o="getMyFollowingList";if(!this.canIUse(H.FOLLOW))return this.noUse(o);var i=n||this.FIRST_PAGE_INDEX;if(this._myFollowingList.has(i)){var e=this._myFollowingList.get(i),a=e.resultList,s=e.nextCursor,e=e.lastUpdateTime;if(Date.now()-e<this.MAX_CATCH_TIME&&0<a.length)return v.l("".concat(this._n,".").concat(o," nextCursor:").concat(n," from local.")),Sn({resultList:a,nextCursor:s})}return this._getFollowList(n,Dr.FOLLOWING).then(function(e){return t._myFollowingList.set(i,y(y({},e),{},{lastUpdateTime:Date.now()})),v.l("".concat(t._n,".").concat(o," nextCursor:").concat(n," from remote.")),Ln(e)})}},{key:"getMutualFollowersList",value:function(){var t=this,n=0<arguments.length&&void 0!==arguments[0]?arguments[0]:"",o="getMutualFollowersList";if(!this.canIUse(H.FOLLOW))return this.noUse(o);var i=n||this.FIRST_PAGE_INDEX;if(this._myMutualFollowersList.has(i)){var e=this._myMutualFollowersList.get(i),a=e.resultList,s=e.nextCursor,e=e.lastUpdateTime;if(Date.now()-e<this.MAX_CATCH_TIME&&0<a.length)return v.l("".concat(this._n,".").concat(o," nextCursor:").concat(n," from local.")),Sn({resultList:a,nextCursor:s})}return this._getFollowList(n,Dr.MUTUAL).then(function(e){return t._myMutualFollowersList.set(i,y(y({},e),{},{lastUpdateTime:Date.now()})),v.l("".concat(t._n,".").concat(o," nextCursor:").concat(n," from remote.")),Ln(e)})}},{key:"_getFollowList",value:function(e,t){var i=this,n=new M("_getFollowList");return n.setMessage("nextCursor:".concat(e," type:").concat(t)),this.req({P:I.GET_FOLLOW,data:{fromAccount:this.getMyUserID(),count:this.DEFAULT_COUNT,nextCursor:e,type:t}}).then(function(e){n.end();var e=e.data,t=e.resultList,t=void 0===t?[]:t,e=e.nextCursor,e=void 0===e?"":e,o=[];return t.forEach(function(e){var t=e.userID,n=e.followTime,e=e.profileList;o.push(y({userID:t,followTime:n},i._handleProfileItem(void 0===e?[]:e)));}),{resultList:o,nextCursor:e}}).catch(function(e){return n.setError(e).end(),v.e("".concat(i._n,"._getFollowList failed. error:"),e),C(e)})}},{key:"_handleProfileItem",value:function(e){var t={};return e.forEach(function(e){switch(e.tag){case qe.NICK:t.nick=e.value;break;case qe.GENDER:t.gender=e.value;break;case qe.BIRTHDAY:t.birthday=e.value;break;case qe.LOCATION:t.location=e.value;break;case qe.SELFSIGNATURE:t.selfSignature=e.value;break;case qe.ALLOWTYPE:t.allowType=e.value;break;case qe.LANGUAGE:t.language=e.value;break;case qe.AVATAR:t.avatar=e.value;break;case qe.MESSAGESETTINGS:t.messageSettings=e.value;break;case qe.ADMINFORBIDTYPE:t.adminForbidType=e.value;break;case qe.LEVEL:t.level=e.value;break;case qe.ROLE:t.role=e.value;break;default:t[e.tag]=e.value;}}),t}},{key:"getUserFollowInfo",value:function(e){if(!this.canIUse(H.FOLLOW))return this.noUse("getUserFollowInfo");var t=e,n=!1,i=(A(e)&&(t=[this.getMyUserID()],n=!0),"".concat(this._n,".").concat("getUserFollowInfo")),e="userIDList:".concat(t.length," isGetMyFollowInfo:").concat(n),a=new M("getUserFollowInfo");return a.setMessage(e),v.l("".concat(i," ").concat(e)),this.req({P:I.GET_FOLLOW_INFO,data:{fromAccount:this.getMyUserID(),userIDList:t}}).then(function(e){a.end(),v.l("".concat(i," ok."));var e=e.data.followInfoList,o=[];return (void 0===e?[]:e).forEach(function(e){var t=e.followersCount,n=e.followingCount,e=e.mutualFollowersCount;o.push({followersCount:t,followingCount:n,mutualFollowersCount:e});}),Ln(o)}).catch(function(e){return a.setError(e).end(),v.e("".concat(i," failed. error:"),e),C(e)})}},{key:"checkFollowType",value:function(e){if(!this.canIUse(H.FOLLOW))return this.noUse("checkFollowType");100<e.length&&(e=e.slice(0,100),v.w("".concat(t," ").concat(Jt(100))));var t="".concat(this._n,".").concat("checkFollowType"),n="userIDList length:".concat(e.length," "),o=new M("checkFollowType");return o.setMessage(n),v.l("".concat(t," ").concat(n)),this.req({P:I.CHECK_FOLLOW_TYPE,data:{fromAccount:this.getMyUserID(),userIDList:e}}).then(function(e){o.end(),v.l("".concat(t," ok."));var e=e.data.resultList,n=[];return (void 0===e?[]:e).forEach(function(e){var t=e.userID,e=e.followType;n.push({userID:t,followType:e});}),Ln(n)}).catch(function(e){return o.setError(e).end(),v.e("".concat(t," failed. error:"),e),C(e)})}},{key:"_clearFollowList",value:function(e){if(A(e))return this._myFollowersList.clear(),this._myFollowingList.clear(),void this._myMutualFollowersList.clear();e!==Dr.FOLLOWERS?e!==Dr.FOLLOWING?e!==Dr.MUTUAL||this._myMutualFollowersList.clear():this._myFollowingList.clear():this._myFollowersList.clear();}},{key:"reset",value:function(){v.l("".concat(this._n,".reset")),this._clearFollowList();}}]),Sr),Lr=Ta(function(e,t){var n="undefined"!=typeof Uint8Array&&"undefined"!=typeof Uint16Array&&"undefined"!=typeof Int32Array;t.assign=function(e){for(var t,n,o=Array.prototype.slice.call(arguments,1);o.length;){var i=o.shift();if(i){if("object"!==r(i))throw new TypeError(i+"must be non-object");for(var a in i)t=i,n=a,Object.prototype.hasOwnProperty.call(t,n)&&(e[a]=i[a]);}}return e},t.shrinkBuf=function(e,t){return e.length===t?e:e.subarray?e.subarray(0,t):(e.length=t,e)};var o={arraySet:function(e,t,n,o,i){if(t.subarray&&e.subarray)e.set(t.subarray(n,n+o),i);else for(var a=0;a<o;a++)e[i+a]=t[n+a];},flattenChunks:function(e){for(var t,n,o,i=0,a=0,s=e.length;a<s;a++)i+=e[a].length;for(o=new Uint8Array(i),a=t=0,s=e.length;a<s;a++)n=e[a],o.set(n,t),t+=n.length;return o}},i={arraySet:function(e,t,n,o,i){for(var a=0;a<o;a++)e[i+a]=t[n+a];},flattenChunks:function(e){return [].concat.apply([],e)}};t.setTyped=function(e){e?(t.Buf8=Uint8Array,t.Buf16=Uint16Array,t.Buf32=Int32Array,t.assign(t,o)):(t.Buf8=Array,t.Buf16=Array,t.Buf32=Array,t.assign(t,i));},t.setTyped(n);});function Sr(e){return d(this,Sr),(e=Us.call(this,e))._n="FollowModule",e._myFollowersList=new Map,e._myFollowingList=new Map,e._myMutualFollowersList=new Map,e.MAX_CATCH_TIME=6e5,e.FIRST_PAGE_INDEX=dt(),e.DEFAULT_COUNT=500,e.MAX_COUNT=1e3,e.getIEmitInst().on(Yo.CLOUD_CONFIG,e._onCloudConfig,h(e)),e}function kr(e){d(this,kr),(e=bs.call(this,e))._n="SignalingModule",e._inviteInfoMap=new Map,e._canIUseSignaling=!1,e._isHandling=!1,e._remoteSignalingHandler=new gr(h(e)),e._localSignalingHandler=new fr(h(e)),e._historySignalingHandler=new mr(h(e)),e._isC2CUnreadHandleCompleted=!1,e._isConvSyncCompleted=!1,e._isSyncCompleted=!1,e._isCloudConfigCompleted=!1;var t=e.getIEmitInst();return t.on(Yo.C2C_UNREAD_HANDLE_COMPLETED,e.onC2CUnreadHandleCompleted,h(e)),t.on(Yo.CONV_SYNC_COMPLETED,e.onConvSyncCompleted,h(e)),t.on(Yo.CLOUD_CONFIG,e.onCloudConfig,h(e)),e}function Rr(e){d(this,Rr),this._n="HistorySignalingHandler",this._sigM=e,this.COUNT=20,this.EXPIRED_TIME=300,this._map=new Map,this._relatedToMeMap=new Map;}function Ar(e){d(this,Ar),this._n="LocalSignalingHandler",this._sigM=e;}function Or(e){d(this,Or),this._n="RemoteSignalingHandler",this._sigM=e;}function Nr(e){d(this,Nr),this._m=e,this._n="ErrMsgModule",this.TIM_ERROR_ASSISTANCE="tim_error_assistance",this.STORAGE_EXPIRES_TIME=6048e5,this._map=new Map,this._init();}function Gr(e){d(this,Gr),this._m=e,this._n="TransCmdModule",this._TRTCCommandList=["tui_room_svr.*","callkit_records_svr.*","room_engine_srv.*","room_engine_http_srv.*","room_engine_mic.*","live_engine_srv.*","live_engine_http_srv.*","live_engine_pk.*","trtc_ai_service.*","call_engine_srv.*"],this._TRTCCommandMap=new Map,this._setTRTCCommandMap(),this._m.getIEmitInst().on(Yo.CLOUD_CONFIG,this._onCloudConfig,this);}function Pr(e){return d(this,Pr),(e=ws.call(this,e))._n="ProfanityFilterModule",e._plugin=null,e._filterConfigMap=new Map,e._startIndex=0,e._version=0,e._canIUseLexicon=!1,e._isFetching=!1,e._expiredTime=0,e}function Ur(e){var t;return d(this,Ur),(t=Fs.call(this,e))._m=e,t._n="TIMPushModule",t._pluginName="TIMPush",t._pushPlugin=void 0,t._androidPushConfig={},t._deviceToken="",t._businessID=0,t._iOSBusinessID=0,t._c2cUnreadCount=0,t._groupUnreadCount=0,t._isWebUniapp=0,t._deviceInfo={notificationStatus:0,deviceModel:"",systemVersion:"",pushVersion:"1.0.1",packageName:""},t}function br(e){var t;return d(this,br),(t=qs.call(this,e))._m=e,t._n="OfflinePushModule",t._offlinePushPlugin=void 0,t._androidPushConfig={huaweiPushBussinessId:"",xiaomiPushBussinessId:"",xiaomiPushAppId:"",xiaomiPushAppKey:"",meizuPushBussinessId:"",meizuPushAppId:"",meizuPushAppKey:"",vivoPushBussinessId:"",fcmPushBussinessId:"",oppoPushBussinessId:"",oppoPushAppKey:"",oppoPushAppSecret:"",honorPushBussinessId:""},t._deviceToken="",t._businessID=0,t._iosBusinessID=0,t._c2cUnreadCount=0,t._groupUnreadCount=0,t._isWebUniapp=0,t}function wr(e){d(this,wr),this._m=e,this._n="CommercialConfigModule",this._expiredTime=0,this._isFetching=!1,this._purchasedFeatureHandler=new cr(this);}function Fr(e){d(this,Fr),this._commercialConfigM=e,this._n="PurchasedFeatureHandler",this._isCSPluginReported=!1,this._featureMap=new Map;}function qr(e){return d(this,qr),(e=xs.call(this,e))._n="WorkerTimerModule",e._isWorkerEnabled=!0,e._workerTimer=null,e._timerID=-1,e._init(),e.getIEmitInst().on(Yo.CLOUD_CONFIG,e._onCloudConfig,h(e)),e}function xr(e){return d(this,xr),(e=Vs.call(this,e))._n="SnsModule",e._friendHandler=new or(h(e)),e._friendApplicationHandler=new tr(h(e)),e._friendGroupHandler=new ar(h(e)),e.getIEmitInst().on(Yo.A2KEY_AND_TINYID_UPDATED,e.onContextUpdated,h(e)),e}function Vr(e){d(this,Vr),this._snsM=e,this._n="FriendGroupHandler",this._map=new Map;}function Hr(e){d(this,Hr),Je(e)||(this.name=e.name||"",this.userIDList=e.userIDList||[],this.count=this.userIDList.length||0);}function Br(e){d(this,Br),this._snsM=e,this._n="FriendHandler",this._map=new Map,this._startIdx=0,this._standardSeq=0,this._customSeq=0,this._expirationTime=18e4;}function Kr(e,t){d(this,Kr),this.userID=e,this.remark="",this.groupList=[],this.source="",this.addTime=0,this.friendCustomField=[],this.timestamp=0;var n={},o=[];if(n.userID=e,!Je(t))for(var i,a="",s=0,r=t.length;s<r;s++)if(a=t[s].tag,i=t[s].value,-1<a.indexOf("Tag_SNS_Custom"))this.friendCustomField.push({key:a,value:i});else if(-1<a.indexOf("Tag_Profile_Custom"))o.push({key:a,value:i});else switch(a){case qe.NICK:n.nick=i;break;case qe.GENDER:n.gender=i;break;case qe.BIRTHDAY:n.birthday=i;break;case qe.LOCATION:n.location=i;break;case qe.SELFSIGNATURE:n.selfSignature=i;break;case qe.ALLOWTYPE:n.allowType=i;break;case qe.LANGUAGE:n.language=i;break;case qe.AVATAR:n.avatar=i;break;case qe.MESSAGESETTINGS:n.messageSettings=i;break;case qe.ADMINFORBIDTYPE:n.adminForbidType=i;break;case qe.LEVEL:n.level=i;break;case qe.ROLE:n.role=i;break;case xe.REMARK:this.remark=i;break;case xe.ADDTIME:this.addTime=i;break;case xe.GROUP:this.groupList=JSON.parse(JSON.stringify(i));break;case xe.ADDSOURCE:this.source=i;break;case xe.ADDWORDING:break;default:v.l("snsProfileItem unknown tag->",t[s].tag);}this.profile=new si(y(y({},n),{},{profileCustomField:o}));}function Yr(e){d(this,Yr),this._snsM=e,this._n="FriendApplicationHandler",this._startTime=0,this._maxLimited=100,this._currentSeq=0,this._map=new Map,this._unreadCount=0;}function Wr(e){d(this,Wr),(e=Hs.call(this,e))._n="QualityStatModule",e.TAG="im-ssolog-quality-stat",e.reportIndex=0,e.wholePeriod=!1,e._qualityItems=[Kn,Yn,Wn,jn,Jn,zn,Xn,Zn,Qn,$n],e._messageSentItems=[Wn,jn,Jn,zn,Xn],e._messageReceivedItems=[Zn,Qn,$n],e.REPORT_INTERVAL=120,e.REPORT_SDKAPPID_BLACKLIST=[],e.REPORT_TINYID_WHITELIST=[],e._statInfoArr=[],e._avgRTT=new Xs,e._avgE2EDelay=new zs,e._rateMessageSent=new Zs,e._rateMessageReceived=new Qs;var t=e.getIEmitInst();return t.on(Yo.A2KEY_AND_TINYID_UPDATED,e._onLoginSuccess,h(e)),t.on(Yo.CLOUD_CONFIG,e._onCloudConfig,h(e)),e}function jr(){d(this,jr),this._lastMap=new Map,this._currentMap=new Map;}function Jr(){d(this,Jr),this._map=new Map;}function zr(){d(this,zr),this._n="AvgRTT",this._requestCount=0,this._rttArray=[];}function Xr(){d(this,Xr),this._n="AvgE2EDelay",this._e2eDelayArray=[];}function Zr(e){return d(this,Zr),(e=Bs.call(this,e))._n="RecoverMsgModule",e.PULL_LIMIT_COUNT=15,e}function Qr(e){return d(this,Qr),(e=Ks.call(this,e))._n="CloudControlModule",e._cloudConfig=new Map,e._expiredTime=0,e._version=0,e._isFetching=!1,e}function $r(e){return d(this,$r),(e=Ys.call(this,e))._n="SessionModule",e._platform=e.getPlatform(),e._pHandler=new Is(h(e)),e._msgDispatcher=new ys(h(e)),e._cmdFreqLimitMap=new Map,e._cmdReqInfoMap=new Map,e._serverOverloadInfoMap=new Map,e._incrementalPullContactFlag=!0,e._init(),e.getIEmitInst().on(Yo.CLOUD_CONFIG,e._onCloudConfig,h(e)),e}Lr.assign,Lr.shrinkBuf,Lr.setTyped,Lr.Buf8,Lr.Buf16,Lr.Buf32;function ec(e,t,n,o){for(var i=65535&e|0,a=e>>>16&65535|0,s=0;0!==n;){for(n-=s=2e3<n?2e3:n;a=a+(i=i+t[o++]|0)|0,--s;);i%=65521,a%=65521;}return i|a<<16|0}function tc(e,t,n,o){var i=oc,a=o+n;e^=-1;for(var s=o;s<a;s++)e=e>>>8^i[255&(e^t[s])];return -1^e}function nc(l,d,p,_,h,g,e,f){for(var t,m,v,I,M,y,C,T,D,E=f.bits,n=0,o=0,i=0,a=0,s=0,r=0,c=0,L=0,S=0,u=0,k=null,R=0,A=new Lr.Buf16(16),O=new Lr.Buf16(16),N=null,G=0,n=0;n<=15;n++)A[n]=0;for(o=0;o<_;o++)A[d[p+o]]++;for(s=E,a=15;1<=a&&0===A[a];a--);if(a<s&&(s=a),0===a)return h[g++]=20971520,h[g++]=20971520,f.bits=1,0;for(i=1;i<a&&0===A[i];i++);for(s<i&&(s=i),n=L=1;n<=15;n++)if((L=(L<<1)-A[n])<0)return -1;if(0<L&&(0===l||1!==a))return -1;for(O[1]=0,n=1;n<15;n++)O[n+1]=O[n]+A[n];for(o=0;o<_;o++)0!==d[p+o]&&(e[O[d[p+o]]++]=o);if(y=0===l?(k=N=e,19):1===l?(k=ic,R-=257,N=ac,G-=257,256):(k=sc,N=rc,-1),n=i,M=g,c=o=u=0,v=-1,I=(S=1<<(r=s))-1,1===l&&852<S||2===l&&592<S)return 1;for(;;){for(D=e[o]<y?(T=0,e[o]):e[o]>y?(T=N[G+e[o]],k[R+e[o]]):(T=96,0),t=1<<(C=n-c),i=m=1<<r;h[M+(u>>c)+(m-=t)]=C<<24|T<<16|D|0,0!==m;);for(t=1<<n-1;u&t;)t>>=1;if(0!==t?u=(u&t-1)+t:u=0,o++,0==--A[n]){if(n===a)break;n=d[p+e[o]];}if(s<n&&(u&I)!==v){for(M+=i,L=1<<(r=n-(c=0===c?s:c));r+c<a&&!((L-=A[r+c])<=0);)r++,L<<=1;if(S+=1<<r,1===l&&852<S||2===l&&592<S)return 1;h[v=u&I]=s<<24|r<<16|M-g|0;}}return 0!==u&&(h[M+u]=n-c<<24|64<<16|0),f.bits=s,0}var oc=function(){for(var e=[],t=0;t<256;t++){for(var n=t,o=0;o<8;o++)n=1&n?3988292384^n>>>1:n>>>1;e[t]=n;}return e}(),ic=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0],ac=[16,16,16,16,16,16,16,16,17,17,17,17,18,18,18,18,19,19,19,19,20,20,20,20,21,21,21,21,16,72,78],sc=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577,0,0],rc=[16,16,16,16,17,17,18,18,19,19,20,20,21,21,22,22,23,23,24,24,25,25,26,26,27,27,28,28,29,29,64,64];function cc(e){return (e>>>24&255)+(e>>>8&65280)+((65280&e)<<8)+((255&e)<<24)}function uc(){this.mode=0,this.last=!1,this.wrap=0,this.havedict=!1,this.flags=0,this.dmax=0,this.check=0,this.total=0,this.head=null,this.wbits=0,this.wsize=0,this.whave=0,this.wnext=0,this.window=null,this.hold=0,this.bits=0,this.length=0,this.offset=0,this.extra=0,this.lencode=null,this.distcode=null,this.lenbits=0,this.distbits=0,this.ncode=0,this.nlen=0,this.ndist=0,this.have=0,this.next=null,this.lens=new Lr.Buf16(320),this.work=new Lr.Buf16(288),this.lendyn=null,this.distdyn=null,this.sane=0,this.back=0,this.was=0;}function lc(e){var t;return e&&e.state?(t=e.state,e.total_in=e.total_out=t.total=0,e.msg="",t.wrap&&(e.adler=1&t.wrap),t.mode=1,t.last=0,t.havedict=0,t.dmax=32768,t.head=null,t.hold=0,t.bits=0,t.lencode=t.lendyn=new Lr.Buf32(852),t.distcode=t.distdyn=new Lr.Buf32(592),t.sane=1,t.back=-1,0):-2}function dc(e){var t;return e&&e.state?((t=e.state).wsize=0,t.whave=0,t.wnext=0,lc(e)):-2}function pc(e,t){var n,o;return e&&e.state?(o=e.state,t<0?(n=0,t=-t):(n=1+(t>>4),t<48&&(t&=15)),t&&(t<8||15<t)?-2:(null!==o.window&&o.wbits!==t&&(o.window=null),o.wrap=n,o.wbits=t,dc(e))):-2}function _c(e,t){var n;return e?(n=new uc,(e.state=n).window=null,0!==(n=pc(e,t))&&(e.state=null),n):-2}var hc,gc,fc=!0;function mc(e,t,n,o){var i,e=e.state;return null===e.window&&(e.wsize=1<<e.wbits,e.wnext=0,e.whave=0,e.window=new Lr.Buf8(e.wsize)),o>=e.wsize?(Lr.arraySet(e.window,t,n-e.wsize,e.wsize,0),e.wnext=0,e.whave=e.wsize):((i=e.wsize-e.wnext)>o&&(i=o),Lr.arraySet(e.window,t,n-o,i,e.wnext),(o-=i)?(Lr.arraySet(e.window,t,n-o,o,0),e.wnext=o,e.whave=e.wsize):(e.wnext+=i,e.wnext===e.wsize&&(e.wnext=0),e.whave<e.wsize&&(e.whave+=i))),0}var vc={inflateReset:dc,inflateReset2:pc,inflateResetKeep:lc,inflateInit:function(e){return _c(e,15)},inflateInit2:_c,inflate:function(e,l){var t,n,d,o,p,i,_,a,s,h,g,r,f,m,v,I,M,y,C,T,D,E,L,S,k=0,R=new Lr.Buf8(4),A=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15];if(!e||!e.state||!e.output||!e.input&&0!==e.avail_in)return -2;12===(t=e.state).mode&&(t.mode=13),p=e.next_out,d=e.output,_=e.avail_out,o=e.next_in,n=e.input,i=e.avail_in,a=t.hold,s=t.bits,h=i,g=_,E=0;e:for(;;)switch(t.mode){case 1:if(0===t.wrap){t.mode=13;break}for(;s<16;){if(0===i)break e;i--,a+=n[o++]<<s,s+=8;}if(2&t.wrap&&35615===a){R[t.check=0]=255&a,R[1]=a>>>8&255,t.check=tc(t.check,R,2,0),s=a=0,t.mode=2;break}if(t.flags=0,t.head&&(t.head.done=!1),!(1&t.wrap)||(((255&a)<<8)+(a>>8))%31){e.msg="incorrect header check",t.mode=30;break}if(8!=(15&a)){e.msg="unknown compression method",t.mode=30;break}if(s-=4,D=8+(15&(a>>>=4)),0===t.wbits)t.wbits=D;else if(D>t.wbits){e.msg="invalid window size",t.mode=30;break}t.dmax=1<<D,e.adler=t.check=1,t.mode=512&a?10:12,s=a=0;break;case 2:for(;s<16;){if(0===i)break e;i--,a+=n[o++]<<s,s+=8;}if(t.flags=a,8!=(255&t.flags)){e.msg="unknown compression method",t.mode=30;break}if(57344&t.flags){e.msg="unknown header flags set",t.mode=30;break}t.head&&(t.head.text=a>>8&1),512&t.flags&&(R[0]=255&a,R[1]=a>>>8&255,t.check=tc(t.check,R,2,0)),s=a=0,t.mode=3;case 3:for(;s<32;){if(0===i)break e;i--,a+=n[o++]<<s,s+=8;}t.head&&(t.head.time=a),512&t.flags&&(R[0]=255&a,R[1]=a>>>8&255,R[2]=a>>>16&255,R[3]=a>>>24&255,t.check=tc(t.check,R,4,0)),s=a=0,t.mode=4;case 4:for(;s<16;){if(0===i)break e;i--,a+=n[o++]<<s,s+=8;}t.head&&(t.head.xflags=255&a,t.head.os=a>>8),512&t.flags&&(R[0]=255&a,R[1]=a>>>8&255,t.check=tc(t.check,R,2,0)),s=a=0,t.mode=5;case 5:if(1024&t.flags){for(;s<16;){if(0===i)break e;i--,a+=n[o++]<<s,s+=8;}t.length=a,t.head&&(t.head.extra_len=a),512&t.flags&&(R[0]=255&a,R[1]=a>>>8&255,t.check=tc(t.check,R,2,0)),s=a=0;}else t.head&&(t.head.extra=null);t.mode=6;case 6:if(1024&t.flags&&((r=(r=t.length)>i?i:r)&&(t.head&&(D=t.head.extra_len-t.length,t.head.extra||(t.head.extra=new Array(t.head.extra_len)),Lr.arraySet(t.head.extra,n,o,r,D)),512&t.flags&&(t.check=tc(t.check,n,r,o)),i-=r,o+=r,t.length-=r),t.length))break e;t.length=0,t.mode=7;case 7:if(2048&t.flags){if(0===i)break e;for(r=0;D=n[o+r++],t.head&&D&&t.length<65536&&(t.head.name+=String.fromCharCode(D)),D&&r<i;);if(512&t.flags&&(t.check=tc(t.check,n,r,o)),i-=r,o+=r,D)break e}else t.head&&(t.head.name=null);t.length=0,t.mode=8;case 8:if(4096&t.flags){if(0===i)break e;for(r=0;D=n[o+r++],t.head&&D&&t.length<65536&&(t.head.comment+=String.fromCharCode(D)),D&&r<i;);if(512&t.flags&&(t.check=tc(t.check,n,r,o)),i-=r,o+=r,D)break e}else t.head&&(t.head.comment=null);t.mode=9;case 9:if(512&t.flags){for(;s<16;){if(0===i)break e;i--,a+=n[o++]<<s,s+=8;}if(a!==(65535&t.check)){e.msg="header crc mismatch",t.mode=30;break}s=a=0;}t.head&&(t.head.hcrc=t.flags>>9&1,t.head.done=!0),e.adler=t.check=0,t.mode=12;break;case 10:for(;s<32;){if(0===i)break e;i--,a+=n[o++]<<s,s+=8;}e.adler=t.check=cc(a),s=a=0,t.mode=11;case 11:if(0===t.havedict)return e.next_out=p,e.avail_out=_,e.next_in=o,e.avail_in=i,t.hold=a,t.bits=s,2;e.adler=t.check=1,t.mode=12;case 12:if(5===l||6===l)break e;case 13:if(t.last){a>>>=7&s,s-=7&s,t.mode=27;break}for(;s<3;){if(0===i)break e;i--,a+=n[o++]<<s,s+=8;}switch(t.last=1&a,--s,3&(a>>>=1)){case 0:t.mode=14;break;case 1:O=N=void 0;var O,N=t;if(fc){for(hc=new Lr.Buf32(512),gc=new Lr.Buf32(32),O=0;O<144;)N.lens[O++]=8;for(;O<256;)N.lens[O++]=9;for(;O<280;)N.lens[O++]=7;for(;O<288;)N.lens[O++]=8;for(nc(1,N.lens,0,288,hc,0,N.work,{bits:9}),O=0;O<32;)N.lens[O++]=5;nc(2,N.lens,0,32,gc,0,N.work,{bits:5}),fc=!1;}if(N.lencode=hc,N.lenbits=9,N.distcode=gc,N.distbits=5,t.mode=20,6!==l)break;a>>>=2,s-=2;break e;case 2:t.mode=17;break;case 3:e.msg="invalid block type",t.mode=30;}a>>>=2,s-=2;break;case 14:for(a>>>=7&s,s-=7&s;s<32;){if(0===i)break e;i--,a+=n[o++]<<s,s+=8;}if((65535&a)!=(a>>>16^65535)){e.msg="invalid stored block lengths",t.mode=30;break}if(t.length=65535&a,s=a=0,t.mode=15,6===l)break e;case 15:t.mode=16;case 16:if(r=t.length){if(0===(r=_<(r=i<r?i:r)?_:r))break e;Lr.arraySet(d,n,o,r,p),i-=r,o+=r,_-=r,p+=r,t.length-=r;break}t.mode=12;break;case 17:for(;s<14;){if(0===i)break e;i--,a+=n[o++]<<s,s+=8;}if(t.nlen=257+(31&a),a>>>=5,s-=5,t.ndist=1+(31&a),a>>>=5,s-=5,t.ncode=4+(15&a),a>>>=4,s-=4,286<t.nlen||30<t.ndist){e.msg="too many length or distance symbols",t.mode=30;break}t.have=0,t.mode=18;case 18:for(;t.have<t.ncode;){for(;s<3;){if(0===i)break e;i--,a+=n[o++]<<s,s+=8;}t.lens[A[t.have++]]=7&a,a>>>=3,s-=3;}for(;t.have<19;)t.lens[A[t.have++]]=0;if(t.lencode=t.lendyn,t.lenbits=7,L={bits:t.lenbits},E=nc(0,t.lens,0,19,t.lencode,0,t.work,L),t.lenbits=L.bits,E){e.msg="invalid code lengths set",t.mode=30;break}t.have=0,t.mode=19;case 19:for(;t.have<t.nlen+t.ndist;){for(;I=(k=t.lencode[a&(1<<t.lenbits)-1])>>>16&255,M=65535&k,!((v=k>>>24)<=s);){if(0===i)break e;i--,a+=n[o++]<<s,s+=8;}if(M<16)a>>>=v,s-=v,t.lens[t.have++]=M;else {if(16===M){for(S=v+2;s<S;){if(0===i)break e;i--,a+=n[o++]<<s,s+=8;}if(a>>>=v,s-=v,0===t.have){e.msg="invalid bit length repeat",t.mode=30;break}D=t.lens[t.have-1],r=3+(3&a),a>>>=2,s-=2;}else if(17===M){for(S=v+3;s<S;){if(0===i)break e;i--,a+=n[o++]<<s,s+=8;}D=0,r=3+(7&(a>>>=v)),a>>>=3,s=s-v-3;}else {for(S=v+7;s<S;){if(0===i)break e;i--,a+=n[o++]<<s,s+=8;}D=0,r=11+(127&(a>>>=v)),a>>>=7,s=s-v-7;}if(t.have+r>t.nlen+t.ndist){e.msg="invalid bit length repeat",t.mode=30;break}for(;r--;)t.lens[t.have++]=D;}}if(30===t.mode)break;if(0===t.lens[256]){e.msg="invalid code -- missing end-of-block",t.mode=30;break}if(t.lenbits=9,L={bits:t.lenbits},E=nc(1,t.lens,0,t.nlen,t.lencode,0,t.work,L),t.lenbits=L.bits,E){e.msg="invalid literal/lengths set",t.mode=30;break}if(t.distbits=6,t.distcode=t.distdyn,L={bits:t.distbits},E=nc(2,t.lens,t.nlen,t.ndist,t.distcode,0,t.work,L),t.distbits=L.bits,E){e.msg="invalid distances set",t.mode=30;break}if(t.mode=20,6===l)break e;case 20:t.mode=21;case 21:if(6<=i&&258<=_){e.next_out=p,e.avail_out=_,e.next_in=o,e.avail_in=i,t.hold=a,t.bits=s,K=H=w=b=U=P=c=G=oe=ne=te=ee=$=Q=Z=X=z=J=j=W=Y=u=B=V=x=void 0;var G,c,P,U,b,w,F=e,q=g,x=F.state,V=F.next_in,H=F.input,B=V+(F.avail_in-5),u=F.next_out,K=F.output,Y=u-(q-F.avail_out),W=u+(F.avail_out-257),j=x.dmax,J=x.wsize,z=x.whave,X=x.wnext,Z=x.window,Q=x.hold,$=x.bits,ee=x.lencode,te=x.distcode,ne=(1<<x.lenbits)-1,oe=(1<<x.distbits)-1;t:do{for($<15&&(Q+=H[V++]<<$,$+=8,Q+=H[V++]<<$,$+=8),G=ee[Q&ne];;){if(Q>>>=c=G>>>24,$-=c,0==(c=G>>>16&255))K[u++]=65535&G;else {if(!(16&c)){if(0==(64&c)){G=ee[(65535&G)+(Q&(1<<c)-1)];continue}if(32&c){x.mode=12;break t}F.msg="invalid literal/length code",x.mode=30;break t}for(P=65535&G,(c&=15)&&($<c&&(Q+=H[V++]<<$,$+=8),P+=Q&(1<<c)-1,Q>>>=c,$-=c),$<15&&(Q+=H[V++]<<$,$+=8,Q+=H[V++]<<$,$+=8),G=te[Q&oe];;){if(Q>>>=c=G>>>24,$-=c,!(16&(c=G>>>16&255))){if(0==(64&c)){G=te[(65535&G)+(Q&(1<<c)-1)];continue}F.msg="invalid distance code",x.mode=30;break t}if(U=65535&G,$<(c&=15)&&(Q+=H[V++]<<$,($+=8)<c&&(Q+=H[V++]<<$,$+=8)),(U+=Q&(1<<c)-1)>j){F.msg="invalid distance too far back",x.mode=30;break t}if(Q>>>=c,$-=c,U>(c=u-Y)){if((c=U-c)>z&&x.sane){F.msg="invalid distance too far back",x.mode=30;break t}if(w=Z,(b=0)===X){if(b+=J-c,c<P){for(P-=c;K[u++]=Z[b++],--c;);b=u-U,w=K;}}else if(X<c){if(b+=J+X-c,(c-=X)<P){for(P-=c;K[u++]=Z[b++],--c;);if(b=0,X<P){for(P-=c=X;K[u++]=Z[b++],--c;);b=u-U,w=K;}}}else if(b+=X-c,c<P){for(P-=c;K[u++]=Z[b++],--c;);b=u-U,w=K;}for(;2<P;)K[u++]=w[b++],K[u++]=w[b++],K[u++]=w[b++],P-=3;P&&(K[u++]=w[b++],1<P&&(K[u++]=w[b++]));}else {for(b=u-U;K[u++]=K[b++],K[u++]=K[b++],K[u++]=K[b++],2<(P-=3););P&&(K[u++]=K[b++],1<P&&(K[u++]=K[b++]));}break}}break}}while(V<B&&u<W);V-=P=$>>3,Q&=(1<<($-=P<<3))-1,F.next_in=V,F.next_out=u,F.avail_in=V<B?B-V+5:5-(V-B),F.avail_out=u<W?W-u+257:257-(u-W),x.hold=Q,x.bits=$,p=e.next_out,d=e.output,_=e.avail_out,o=e.next_in,n=e.input,i=e.avail_in,a=t.hold,s=t.bits,12===t.mode&&(t.back=-1);break}for(t.back=0;I=(k=t.lencode[a&(1<<t.lenbits)-1])>>>16&255,M=65535&k,!((v=k>>>24)<=s);){if(0===i)break e;i--,a+=n[o++]<<s,s+=8;}if(I&&0==(240&I)){for(y=v,C=I,T=M;I=(k=t.lencode[T+((a&(1<<y+C)-1)>>y)])>>>16&255,M=65535&k,!(y+(v=k>>>24)<=s);){if(0===i)break e;i--,a+=n[o++]<<s,s+=8;}a>>>=y,s-=y,t.back+=y;}if(a>>>=v,s-=v,t.back+=v,t.length=M,0===I){t.mode=26;break}if(32&I){t.back=-1,t.mode=12;break}if(64&I){e.msg="invalid literal/length code",t.mode=30;break}t.extra=15&I,t.mode=22;case 22:if(t.extra){for(S=t.extra;s<S;){if(0===i)break e;i--,a+=n[o++]<<s,s+=8;}t.length+=a&(1<<t.extra)-1,a>>>=t.extra,s-=t.extra,t.back+=t.extra;}t.was=t.length,t.mode=23;case 23:for(;I=(k=t.distcode[a&(1<<t.distbits)-1])>>>16&255,M=65535&k,!((v=k>>>24)<=s);){if(0===i)break e;i--,a+=n[o++]<<s,s+=8;}if(0==(240&I)){for(y=v,C=I,T=M;I=(k=t.distcode[T+((a&(1<<y+C)-1)>>y)])>>>16&255,M=65535&k,!(y+(v=k>>>24)<=s);){if(0===i)break e;i--,a+=n[o++]<<s,s+=8;}a>>>=y,s-=y,t.back+=y;}if(a>>>=v,s-=v,t.back+=v,64&I){e.msg="invalid distance code",t.mode=30;break}t.offset=M,t.extra=15&I,t.mode=24;case 24:if(t.extra){for(S=t.extra;s<S;){if(0===i)break e;i--,a+=n[o++]<<s,s+=8;}t.offset+=a&(1<<t.extra)-1,a>>>=t.extra,s-=t.extra,t.back+=t.extra;}if(t.offset>t.dmax){e.msg="invalid distance too far back",t.mode=30;break}t.mode=25;case 25:if(0===_)break e;if(t.offset>(r=g-_)){if((r=t.offset-r)>t.whave&&t.sane){e.msg="invalid distance too far back",t.mode=30;break}f=r>t.wnext?(r-=t.wnext,t.wsize-r):t.wnext-r,r>t.length&&(r=t.length),m=t.window;}else m=d,f=p-t.offset,r=t.length;for(_-=r=_<r?_:r,t.length-=r;d[p++]=m[f++],--r;);0===t.length&&(t.mode=21);break;case 26:if(0===_)break e;d[p++]=t.length,_--,t.mode=21;break;case 27:if(t.wrap){for(;s<32;){if(0===i)break e;i--,a|=n[o++]<<s,s+=8;}if(g-=_,e.total_out+=g,t.total+=g,g&&(e.adler=t.check=(t.flags?tc:ec)(t.check,d,g,p-g)),g=_,(t.flags?a:cc(a))!==t.check){e.msg="incorrect data check",t.mode=30;break}s=a=0;}t.mode=28;case 28:if(t.wrap&&t.flags){for(;s<32;){if(0===i)break e;i--,a+=n[o++]<<s,s+=8;}if(a!==(4294967295&t.total)){e.msg="incorrect length check",t.mode=30;break}s=a=0;}t.mode=29;case 29:E=1;break e;case 30:E=-3;break e;case 31:return -4;default:return -2}return e.next_out=p,e.avail_out=_,e.next_in=o,e.avail_in=i,t.hold=a,t.bits=s,(t.wsize||g!==e.avail_out&&t.mode<30&&(t.mode<27||4!==l))&&mc(e,e.output,e.next_out,g-e.avail_out),h-=e.avail_in,g-=e.avail_out,e.total_in+=h,e.total_out+=g,t.total+=g,t.wrap&&g&&(e.adler=t.check=(t.flags?tc:ec)(t.check,d,g,e.next_out-g)),e.data_type=t.bits+(t.last?64:0)+(12===t.mode?128:0)+(20===t.mode||15===t.mode?256:0),E=(0==h&&0===g||4===l)&&0===E?-5:E},inflateEnd:function(e){if(!e||!e.state)return -2;var t=e.state;return t.window&&(t.window=null),e.state=null,0},inflateGetHeader:function(e,t){var n;return !e||!e.state||0==(2&(n=e.state).wrap)?-2:((n.head=t).done=!1,0)},inflateSetDictionary:function(e,t){var n,o=t.length;return !e||!e.state||0!==(n=e.state).wrap&&11!==n.mode?-2:11===n.mode&&ec(1,t,o,0)!==n.check?-3:mc(e,t,o,o)?(n.mode=31,-4):(n.havedict=1,0)},inflateInfo:"pako inflate (from Nodeca project)"},Ic=!0,Mc=!0;try{String.fromCharCode.apply(null,[0]);}catch(e){Ic=!1;}try{String.fromCharCode.apply(null,new Uint8Array(1));}catch(e){Mc=!1;}for(var yc=new Lr.Buf8(256),Cc=0;Cc<256;Cc++)yc[Cc]=252<=Cc?6:248<=Cc?5:240<=Cc?4:224<=Cc?3:192<=Cc?2:1;yc[254]=yc[254]=1;function Tc(e,l){for(var t,n,o=l||e.length,i=new Array(2*o),a=0,s=0;s<o;)if((t=e[s++])<128)i[a++]=t;else if(4<(n=yc[t]))i[a++]=65533,s+=n-1;else {for(t&=2===n?31:3===n?15:7;1<n&&s<o;)t=t<<6|63&e[s++],n--;1<n?i[a++]=65533:t<65536?i[a++]=t:(t-=65536,i[a++]=55296|t>>10&1023,i[a++]=56320|1023&t);}var r=i,c=a;if(c<65534&&(r.subarray&&Mc||!r.subarray&&Ic))return String.fromCharCode.apply(null,Lr.shrinkBuf(r,c));for(var d="",u=0;u<c;u++)d+=String.fromCharCode(r[u]);return d}function Dc(){this.input=null,this.next_in=0,this.avail_in=0,this.total_in=0,this.output=null,this.next_out=0,this.avail_out=0,this.total_out=0,this.msg="",this.state=null,this.data_type=2,this.adler=0;}function Ec(){this.text=0,this.time=0,this.xflags=0,this.os=0,this.extra=null,this.extra_len=0,this.name="",this.comment="",this.hcrc=0,this.done=!1;}var Lc={Z_NO_FLUSH:0,Z_PARTIAL_FLUSH:1,Z_SYNC_FLUSH:2,Z_FULL_FLUSH:3,Z_FINISH:4,Z_BLOCK:5,Z_TREES:6,Z_OK:0,Z_STREAM_END:1,Z_NEED_DICT:2,Z_ERRNO:-1,Z_STREAM_ERROR:-2,Z_DATA_ERROR:-3,Z_BUF_ERROR:-5,Z_NO_COMPRESSION:0,Z_BEST_SPEED:1,Z_BEST_COMPRESSION:9,Z_DEFAULT_COMPRESSION:-1,Z_FILTERED:1,Z_HUFFMAN_ONLY:2,Z_RLE:3,Z_FIXED:4,Z_DEFAULT_STRATEGY:0,Z_BINARY:0,Z_TEXT:1,Z_UNKNOWN:2,Z_DEFLATED:8},Sc={2:"need dictionary",1:"stream end",0:"","-1":"file error","-2":"stream error","-3":"data error","-4":"insufficient memory","-5":"buffer error","-6":"incompatible version"},kc=Object.prototype.toString;function Rc(e){if(!(this instanceof Rc))return new Rc(e);this.options=Lr.assign({chunkSize:16384,windowBits:0,to:""},e||{});var t=this.options,e=(t.raw&&0<=t.windowBits&&t.windowBits<16&&(t.windowBits=-t.windowBits,0===t.windowBits&&(t.windowBits=-15)),!(0<=t.windowBits&&t.windowBits<16)||e&&e.windowBits||(t.windowBits+=32),15<t.windowBits&&t.windowBits<48&&0==(15&t.windowBits)&&(t.windowBits|=15),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new Dc,this.strm.avail_out=0,vc.inflateInit2(this.strm,t.windowBits));if(e!==Lc.Z_OK)throw new Error(Sc[e]);if(this.header=new Ec,vc.inflateGetHeader(this.strm,this.header),t.dictionary&&("string"==typeof t.dictionary?t.dictionary=function(e){for(var t,n,o,i,a=e.length,s=0,r=0;r<a;r++)55296==(64512&(n=e.charCodeAt(r)))&&r+1<a&&56320==(64512&(o=e.charCodeAt(r+1)))&&(n=65536+(n-55296<<10)+(o-56320),r++),s+=n<128?1:n<2048?2:n<65536?3:4;for(t=new Lr.Buf8(s),r=i=0;i<s;r++)55296==(64512&(n=e.charCodeAt(r)))&&r+1<a&&56320==(64512&(o=e.charCodeAt(r+1)))&&(n=65536+(n-55296<<10)+(o-56320),r++),n<128?t[i++]=n:(n<2048?t[i++]=192|n>>>6:(n<65536?t[i++]=224|n>>>12:(t[i++]=240|n>>>18,t[i++]=128|n>>>12&63),t[i++]=128|n>>>6&63),t[i++]=128|63&n);return t}(t.dictionary):"[object ArrayBuffer]"===kc.call(t.dictionary)&&(t.dictionary=new Uint8Array(t.dictionary)),t.raw&&(e=vc.inflateSetDictionary(this.strm,t.dictionary))!==Lc.Z_OK))throw new Error(Sc[e])}function Ac(e,t){t=new Rc(t);if(t.push(e,!0),t.err)throw t.msg||Sc[t.err];return t.result}Rc.prototype.push=function(e,t){var n,o,i,a,s,r=this.strm,c=this.options.chunkSize,l=this.options.dictionary,u=!1;if(this.ended)return !1;o=t===~~t?t:!0===t?Lc.Z_FINISH:Lc.Z_NO_FLUSH,"string"==typeof e?r.input=function(e){for(var t=new Lr.Buf8(e.length),n=0,o=t.length;n<o;n++)t[n]=e.charCodeAt(n);return t}(e):"[object ArrayBuffer]"===kc.call(e)?r.input=new Uint8Array(e):r.input=e,r.next_in=0,r.avail_in=r.input.length;do{if(0===r.avail_out&&(r.output=new Lr.Buf8(c),r.next_out=0,r.avail_out=c),(n=(n=vc.inflate(r,Lc.Z_NO_FLUSH))===Lc.Z_NEED_DICT&&l?vc.inflateSetDictionary(this.strm,l):n)===Lc.Z_BUF_ERROR&&!0===u&&(n=Lc.Z_OK,u=!1),n!==Lc.Z_STREAM_END&&n!==Lc.Z_OK)return this.onEnd(n),!(this.ended=!0);r.next_out&&(0!==r.avail_out&&n!==Lc.Z_STREAM_END&&(0!==r.avail_in||o!==Lc.Z_FINISH&&o!==Lc.Z_SYNC_FLUSH)||("string"===this.options.to?(i=function(e,t){for(var n=(t=(t=t||e.length)>e.length?e.length:t)-1;0<=n&&128==(192&e[n]);)n--;return !(n<0||0===n)&&n+yc[e[n]]>t?n:t}(r.output,r.next_out),a=r.next_out-i,s=Tc(r.output,i),r.next_out=a,r.avail_out=c-a,a&&Lr.arraySet(r.output,r.output,i,a,0),this.onData(s)):this.onData(Lr.shrinkBuf(r.output,r.next_out)))),0===r.avail_in&&0===r.avail_out&&(u=!0);}while((0<r.avail_in||0===r.avail_out)&&n!==Lc.Z_STREAM_END);return (o=n===Lc.Z_STREAM_END?Lc.Z_FINISH:o)===Lc.Z_FINISH?(n=vc.inflateEnd(this.strm),this.onEnd(n),this.ended=!0,n===Lc.Z_OK):o!==Lc.Z_SYNC_FLUSH||(this.onEnd(Lc.Z_OK),!(r.avail_out=0))},Rc.prototype.onData=function(e){this.chunks.push(e);},Rc.prototype.onEnd=function(e){e===Lc.Z_OK&&("string"===this.options.to?this.result=this.chunks.join(""):this.result=Lr.flattenChunks(this.chunks)),this.chunks=[],this.err=e,this.msg=this.strm.msg;};se={};(0, Lr.assign)(se,{Inflate:Rc,inflate:Ac,inflateRaw:function(e,t){return (t=t||{}).raw=!0,Ac(e,t)},ungzip:Ac},Lc);var Oc,Nc=se,Gc=(e(Zc,[{key:"inflate",value:function(e){var t,e=new Uint8Array(e).slice(4),n=Date.now();try{t=Nc.inflate(e,{to:"string"}),this._bLogForInflateOK||(this._bLogForInflateOK=!0,new M("inflateOK").end());}catch(e){return this._bLogForInflateError?void 0:(this._bLogForInflateError=!0,void new M("inflateError").setMessage(e).end())}var e=e.length+4,o=t.length;return v.d("inflate ok. zipped:".concat(e," unzipped:").concat(o)+" compression ratio:".concat(Math.round(100*(o-e)/o),"% cost:").concat(Date.now()-n)),t}},{key:"reset",value:function(){v.l("".concat(this._n,".reset")),this._bLogForInflateOK=!1,this._bLogForInflateError=!1;}}]),Zc),Pc="Message",Uc="User",bc="Group",wc="GroupMember",Fc=["count"],qc=["conversationID","timePosition","timePeriod"],xc=["miniBirthday","maxBirthday"],Vc=(c(te={},Pc,I.CS),c(te,Uc,I.USER_CS),c(te,bc,I.GRP_CS),c(te,wc,I.MBR_CS),te),Hc=(t(Xc,wn),Oc=f(Xc),e(Xc,[{key:"search",value:function(i,a){var s=this,e="searchCloud".concat(i,"s"),r="".concat(this._n,".").concat(e);if(!a)return C({code:T.OPTIONS_IS_EMPTY,message:this.getErrMsg(T.OPTIONS_IS_EMPTY,e)});var t=a.keywordList,n=ot(t),o=a.count;if(a.count&&(o=parseInt(o)),i===Pc&&!n&&!ot(a.senderUserIDList)&&!ot(a.messageTypeList)||i!==Pc&&!n)throw v.e("[".concat(e,'] Missing required params: "keywordList".')),new Error("Params validate failed.");var l=Date.now(),c=new M(e),u="keywordList:".concat(t," keywordListMatchType:").concat(a.keywordListMatchType," cursor:").concat(a.cursor," count:").concat(o);return v.l("".concat(r," ").concat(u)),this.req({P:Vc[i],data:this._genParams(i,a)}).then(function(e){var t=e.data,n=t.code,t=t.message;if(0!==n)return 60020===(o=n)?o="SearchUnable":i!==Pc&&27003===n?o="SearchParamsError":i!==Pc&&60018===n&&(o="SearchOverLimit"),o=s.getErrMsg(o)||t,t=new Hn({code:n,message:o}),c.setMessage(u).setError(t).end(),C(t);s.get(27).isCSPluginEnabled();var n=e.data,o=n.cursor,t=void 0===o?"":o,o=n.totalCount,n="totalCount:".concat(o," cost:").concat(Zt(l)),n=(v.l("".concat(r," ok. cursor:").concat(t," ").concat(n)),c.setMessage("".concat(u," ").concat(n)).end(),s._genRes(i,a,e.data));return Ln({searchResultList:n,cursor:t,totalCount:o})}).catch(function(e){return c.setMessage(u).setError(e).end(),C(e)})}},{key:"_genParams",value:function(e,t){var n=t.count,o=g(t,Fc);if(n&&(o.count=parseInt(n)),e===Pc)return this._genMsgParams(o);n=t.keywordList,t=t.keywordListMatchType;return o.keywords=n,o.keywordMatchType="and"===t?1:0,e===Uc?this._genUserParams(o):o}},{key:"_genMsgParams",value:function(e){var t=e.conversationID,n=e.timePosition,o=e.timePeriod,e=g(e,qc);return A(t)||(Rt(t)&&(e.account=t.replace(R.CONV_C2C,"")),At(t)&&(e.groupID=t.replace(R.CONV_GROUP,""))),Qe(o)&&0<o&&(Qe(n)&&0<n?e.startTime=n-o:e.startTime=Oe()-o),e.startTime&&e.startTime<0&&(e.startTime=void 0),Qe(n)&&0<n&&(e.endTime=n),e}},{key:"_genUserParams",value:function(e){var t=e.miniBirthday,n=e.maxBirthday,e=g(e,xc);return Qe(t)&&(e.miniBirthday=parseInt(t),Qe(n)||(e.maxBirthday=4294967295)),Qe(n)&&(e.maxBirthday=parseInt(n)),e}},{key:"_genRes",value:function(e,t,n){switch(e){case Pc:return this._genMsgRes(n.searchResult,!t.conversationID);case Uc:return this._genUserRes(n.userList);case bc:return this._genGrpRes(n.groupList);case wc:return this._genMemberRes(n.groupMemberList);default:return []}}},{key:"_genMsgRes",value:function(e,a){var s=this.get(11);return nt(e)&&0!==e.length?e.map(function(e){var t=e.groupID,n=e.userID,o=e.messageCount,e=e.messageList,e=void 0===e?[]:e,n=t?"".concat(R.CONV_GROUP).concat(t):"".concat(R.CONV_C2C).concat(n),i={conversationID:n,messageCount:o,messageList:[]};if(a&&1<o)return i;o=e.filter(function(e){return !!e});return 0<o.length&&(e=s.onRoamingMessage(o,n,!1),t&&e.reverse(),i.messageList=e,i.messageCount=e.length),i}):[]}},{key:"_genUserRes",value:function(e){var t=this.get(4)._profileHandler;if(!nt(e))return [];for(var n=[],o=0,i=e.length;o<i;o++){var a=e[o],s=a.userID,a=a.profileItems;"@TLS#NOT_FOUND"!==s&&""!==s&&(s=t._update(s,t._getLatestProfileFromResponse(s,a)).latestProfile,n.push(s));}return n}},{key:"_genGrpRes",value:function(e){if(!nt(e))return [];for(var t=[],n=0,o=e.length;n<o;n++)e[n]&&e[n].groupID&&t.push(new ui(e[n]));return t}},{key:"_genMemberRes",value:function(e){if(!nt(e))return [];for(var t,n,o,i,a,s,r=new Map,c=0,u=e.length;c<u;c++)e[c]&&e[c].userID&&e[c].groupID&&(n=(t=e[c]).groupID,i=t.name,a=t.type,s=t.avatar,o=t.nick,i={groupID:n,name:i,type:a,avatar:s},a={userID:t.userID,nick:o,nameCard:t.nameCard},r.has(n)?((s=r.get(n)).memberList.push(a),r.set(n,s)):r.set(n,{groupInfo:i,memberList:[a]}));return D(r.values())}}]),Xc),Bc=(e(zc,[{key:"_startTimer",value:function(){var e=this._map.get(24),t=e.isWorkerEnabled();v.l("".concat(this._n,".startTimer isWorkerEnabled:").concat(t," seed:").concat(this._checkTimer)),t?e.startWorkerTimer():this._startMainThreadTimer();}},{key:"_startMainThreadTimer",value:function(){this._checkTimer<0&&(this._checkTimer=setInterval(this.onCheckTimer.bind(this),1e3)),v.l("".concat(this._n,"._startMainThreadTimer seed:").concat(this._checkTimer));}},{key:"stopTimer",value:function(){var e=this._map.get(24),t=e.isWorkerEnabled();v.l("".concat(this._n,".stopTimer isWorkerEnabled:").concat(t," seed:").concat(this._checkTimer)),t?e.stopWorkerTimer():this._stopMainThreadTimer();}},{key:"_stopMainThreadTimer",value:function(){v.l("".concat(this._n,"._stopMainThreadTimer")),0<this._checkTimer&&(clearInterval(this._checkTimer),this._checkTimer=-1,this._checkCount=0);}},{key:"_stopMainThreadSocket",value:function(){v.l("".concat(this._n,"._stopMainThreadSocket"));var e=this._map.get(21);e.setIsWorkerEnabled(!0),e.reConnect();}},{key:"_startMainThreadSocket",value:function(){v.l("".concat(this._n,"._startMainThreadSocket"));var e=this._map.get(21);e.setIsWorkerEnabled(!1),e.reConnect();}},{key:"onWorkerTimerEnabled",value:function(){v.l("".concat(this._n,".onWorkerTimerEnabled, disable main thread timer and socket")),this._stopMainThreadTimer(),this._stopMainThreadSocket();}},{key:"onWorkerTimerDisabled",value:function(){v.l("".concat(this._n,".onWorkerTimerDisabled, enable main thread timer and socket")),this._startMainThreadTimer(),this._startMainThreadSocket();}},{key:"onCheckTimer",value:function(){this._checkCount+=1;var e,t=N(this._map);try{for(t.s();!(e=t.n()).done;){var n=m(e.value,2)[1];n.onCheckTimer&&n.onCheckTimer(this._checkCount);}}catch(e){t.e(e);}finally{t.f();}}},{key:"_initReadyList",value:function(){var t=this;this._readyList=[this._map.get(1)],this._readyList.forEach(function(e){e.ready(function(){return t._onModuleReady()});});}},{key:"_onModuleReady",value:function(){var e,t,n=!0;this._readyList.forEach(function(e){e.isReady()||(n=!1);}),n&&!this._isReady&&(this._isReady=!0,this._oEmitter.emit(G.SDK_READY),e=Date.now()-this._startLoginTs,v.w("SDK is ready. cost ".concat(e," ms")),this._startLoginTs=Date.now(),t=this._ssoLogForReady.getStartTs()+Ge,this._ssoLogForReady.setMessage(e).start(t).end());}},{key:"login",value:function(){0===this._startLoginTs&&(Ae(),this._startLoginTs=Date.now(),this._startTimer(),this._map.get(15).start(),this._ssoLogForReady=new M("sdkReady"),this._reason=T.LOGGING_IN);}},{key:"onLoginFailed",value:function(){this._startLoginTs=0;}},{key:"getOEmitInst",value:function(){return null===this._oEmitter&&(this._oEmitter=new Ea,e=this._oEmitter,Bn=e,this._oEmitter._emit=this._oEmitter.emit,this._oEmitter.emit=function(e,t){var n,o,i=this;this._canIUseSignaling()&&(e===G.MESSAGE_RECEIVED&&this.get(33).onNewMessageList(t),e===G.MESSAGE_MODIFIED&&this.get(33).onMessageModified(t)),e===G.CONVERSATION_LIST_UPDATED||e===G.FRIEND_LIST_UPDATED||e===G.GROUP_LIST_UPDATED||e===G.TOTAL_UNREAD_MESSAGE_COUNT_UPDATED?!1!==this._eventThrottling?this._eventThrottleMap.has(e)?(n=Date.now())-(o=this._eventThrottleMap.get(e)).last<=1e3?(-1<o.timeoutID&&clearTimeout(o.timeoutID),o.timeoutID=setTimeout(function(){o.last=Date.now(),i._oEmitter._emit.apply(i._oEmitter,[e,{name:e,data:i._getEventData(e)}]);},1e3)):(o.last=n,this._oEmitter._emit.apply(this._oEmitter,[e,{name:e,data:this._getEventData(e)}])):(this._eventThrottleMap.set(e,{last:Date.now(),timeoutID:-1}),this._oEmitter._emit.apply(this._oEmitter,[e,{name:e,data:this._getEventData(e)}])):this._oEmitter._emit.apply(this._oEmitter,[e,{name:e,data:this._getEventData(e)}]):this._oEmitter._emit.apply(this._oEmitter,[e,{name:e,data:t}]);}.bind(this)),this._oEmitter;var e;}},{key:"_canIUseSignaling",value:function(){var e=this.get(33);return !!e&&e.canIUseSignaling()}},{key:"_getEventData",value:function(e){return e===G.CONVERSATION_LIST_UPDATED?this._map.get(12).isPartialUpdatedConvs()?this._map.get(11).getPartialUpdatedConvs():this._map.get(11).getLocalConvList():e===G.FRIEND_LIST_UPDATED?this._map.get(8).getLocalFriendList(!1):e===G.GROUP_LIST_UPDATED?this._map.get(7).getLocalGroupList():e===G.TOTAL_UNREAD_MESSAGE_COUNT_UPDATED?this._map.get(11).getTotalUnreadCount():e===G.CONVERSATION_ID_LIST_UPDATED?this._map.get(11).getUpdatedConvIDList():void 0}},{key:"getIEmitInst",value:function(){return null===this._iEmitter&&(this._iEmitter=new Ea,this._iEmitter._emit=this._iEmitter.emit,this._iEmitter.emit=function(e,t){e=et(t)&&t.data?[e,{name:e,data:t.data}]:[e,{name:e,data:t}];this._iEmitter._emit.apply(this._iEmitter,e);}.bind(this)),this._iEmitter}},{key:"hasModule",value:function(e){return this._map.has(e)}},{key:"get",value:function(e){return this._map.get(e)}},{key:"canIUseModule",value:function(e){return !this._map.get(12).isUsingChatCore()||this._optionalModuleMap.has(e)}},{key:"canIUseInflate",value:function(){return !!this._map.get(37)}},{key:"isReady",value:function(){return this._isReady}},{key:"isIntl",value:function(){return this.get(12).isIntl()}},{key:"getNotReadyReason",value:function(){return this._reason}},{key:"setNotReadyReason",value:function(e){this._reason=e;}},{key:"getErrMsg",value:function(e,t,n){return this._map.get(32).get({key:e,replacement1:t,replacement2:n,isIntl:this.isIntl()})}},{key:"warn",value:function(e,t,n){e=this.getErrMsg(e,t,n);e&&v.w(e);}},{key:"onError",value:function(e){var t="code:".concat(e.code," message:").concat(e.message);v.w("Oops! ".concat(t)),new M("error").setMessage(t).setLevel("error").end(),this.getOEmitInst().emit(G.ERROR,e);}},{key:"restartTimer",value:function(){v.l("".concat(this._n,".restartTimer")),this.stopTimer(),this._startTimer();var e=this.get(7);e&&e.restartPolling();}},{key:"getTimerID",value:function(){var e=this._map.get(24);return e.isWorkerEnabled()?e.getTimerID():this._checkTimer}},{key:"getPollingTimerID",value:function(e){return this._map.get(7).getPollingTimerID(e)}},{key:"statTUIKeyFeatures",value:function(e){var t=e.code,e=e.msg,e=void 0===e?"":e,n=t+e;this._codeMsgForTUIMap.has(n)||(this._codeMsgForTUIMap.set(n,1),n=this.get(12).getUIPlatform(),new M("tui_key_features").setCode(t).setMessage(e).setUIPlatform(n).end());}},{key:"reset",value:function(){v.l("".concat(this._n,".reset")),Ae();var e,t=N(this._map);try{for(t.s();!(e=t.n()).done;){var n=m(e.value,2)[1];n.reset&&n.reset();}}catch(e){t.e(e);}finally{t.f();}this._startLoginTs=0,this._initReadyList(),this._isReady=!1,this.stopTimer(),this._oEmitter.emit(G.SDK_NOT_READY);var o,i=N(this._eventThrottleMap);try{for(i.s();!(o=i.n()).done;){var a=m(o.value,2)[1];-1<a.timeoutID&&clearTimeout(a.timeoutID);}}catch(e){i.e(e);}finally{i.f();}this._eventThrottleMap.clear(),this._codeMsgForTUIMap.clear();}}]),zc),Kc=(e(Jc,[{key:"defense",value:function(e,t){var n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:void 0;if("string"!=typeof e)return null;if(0===e.length)return null;if("function"!=typeof t)return null;if(this._funcMap.has(e)&&this._funcMap.get(e).has(t))return this._funcMap.get(e).get(t);this._funcMap.has(e)||this._funcMap.set(e,new Map);var o=null;return this._funcMap.get(e).has(t)?o=this._funcMap.get(e).get(t):(o=this._pack(e,t,n),this._funcMap.get(e).set(t,o)),o}},{key:"defenseOnce",value:function(e,t){return "function"!=typeof t?null:this._pack(e,t,2<arguments.length&&void 0!==arguments[2]?arguments[2]:void 0)}},{key:"find",value:function(e,t){return "string"!=typeof e||0===e.length||"function"!=typeof t?null:this._funcMap.has(e)&&this._funcMap.get(e).has(t)?this._funcMap.get(e).get(t):(this._m.warn("ListenerFnNotFound",e),null)}},{key:"delete",value:function(e,t){return "function"==typeof t&&!!this._funcMap.has(e)&&!!this._funcMap.get(e).has(t)&&(this._funcMap.get(e).delete(t),0===this._funcMap.get(e).size&&this._funcMap.delete(e),!0)}},{key:"_pack",value:function(o,e,i){var a=this;return function(){try{e.apply(i,Array.from(arguments));}catch(e){var t=Object.values(G).indexOf(o),n="CallbackError";-1!==t&&(t=Object.keys(G)[t],a._m.warn(n,t,e)),a._reportCount<5&&(new M(n).setMessage("eventName:".concat(o)).setMoreMessage(e.message).end(),a._reportCount+=1);}}}},{key:"destroy",value:function(){this._funcMap.clear();}},{key:"reset",value:function(){v.l("".concat(this._n,".reset")),this._reportCount=0;}}]),Jc),Yc=(e(jc,[{key:"onError",value:function(e){this._m.onError(e);}},{key:"login",value:function(e){return this._m.login(),this._get(1).login(e)}},{key:"logout",value:function(){var t=this;return this._get(1).logout().then(function(e){return t._safetyCallbackFactory.reset(),t._m.reset(),e})}},{key:"getLoginUser",value:function(){return this._get(1).getLoginUser()}},{key:"getServerTime",value:function(){return Pe()}},{key:"isReady",value:function(){return this._m.isReady()}},{key:"isIntl",value:function(){return this._m.isIntl()}},{key:"getNotReadyReason",value:function(){return this._m.getNotReadyReason()}},{key:"getErrMsg",value:function(e,t,n){return this._m.getErrMsg(e,t,n)}},{key:"_get",value:function(e){return this._m.get(e)}},{key:"destroy",value:function(){var e=this,t=this._get(12),n=t.getSDKAppID();return v.w("destroy ".concat(n," ").concat(t.getInstanceID())),this.logout().finally(function(){e._safetyCallbackFactory.destroy(),e._m.stopTimer(),e._get(24).terminate(),e._get(21).dealloc(),e._m.getOEmitInst().emit(G.SDK_DESTROY,{SDKAppID:n});})}},{key:"on",value:function(e,t,n){v.d("on","eventName:".concat(e)),this._m.getOEmitInst().on(e,this._safetyCallbackFactory.defense(e,t,n),n);}},{key:"once",value:function(e,t,n){v.d("once","eventName:".concat(e)),this._m.getOEmitInst().once(e,this._safetyCallbackFactory.defenseOnce(e,t,n),n||this);}},{key:"off",value:function(e,t,n,o){v.d("off","eventName:".concat(e));var i=this._safetyCallbackFactory.find(e,t);null!==i&&(this._m.getOEmitInst().off(e,i,n,o),this._safetyCallbackFactory.delete(e,t));}},{key:"registerPlugin",value:function(e){(A(e["tim-push"])?A(e["tim-offline-push-plugin"])?this._get(18):this._get(28):this._get(36)).registerPlugin(e);}},{key:"setLogLevel",value:function(e){var t;e<=0&&((t=this.getErrMsg("TIM_ASCII_ART"))&&console.log(t),(t=this.getErrMsg("API_REFER"))&&(jt()?console.log("%c ".concat("IM SDK API ->"," %c"),"background:#ff9d00; padding:1px; border-radius:3px; color: #fff","background:transparent",t):console.log("IM SDK API ->",t)),(t=this.getErrMsg("DOCS_GUIDE"))&&console.log(t),t=this.getErrMsg("IOS_WEBVIEW_WARNING"),De&&t&&console.warn(t)),v.setLevel(e);}},{key:"createTextMessage",value:function(e){return this._get(2).createTextMessage(e)}},{key:"createTextAtMessage",value:function(e){return this._get(2).createTextMessage(e)}},{key:"createImageMessage",value:function(e){return this._get(2).createImageMessage(e)}},{key:"createAudioMessage",value:function(e){return this._get(2).createAudioMessage(e)}},{key:"createVideoMessage",value:function(e){return this._get(2).createVideoMessage(e)}},{key:"createCustomMessage",value:function(e){return this._get(2).createCustomMessage(e)}},{key:"createFaceMessage",value:function(e){return this._get(2).createFaceMessage(e)}},{key:"createFileMessage",value:function(e){return this._get(2).createFileMessage(e)}},{key:"createLocationMessage",value:function(e){return this._get(2).createLocationMessage(e)}},{key:"createMergerMessage",value:function(e){return this._get(2).createMergerMessage(e)}},{key:"downloadMergerMessage",value:function(e){return e.type!==R.MSG_MERGER?C({code:T.MSG_MERGER_TYPE_INVALID}):Je(e.payload.downloadKey)?C({code:T.MSG_MERGER_KEY_INVALID}):this._get(2).downloadMergerMessage(e).catch(function(e){return C({code:T.MSG_MERGER_DOWNLOAD_FAIL})})}},{key:"createForwardMessage",value:function(e){return this._get(2).createForwardMessage(e)}},{key:"sendMessage",value:function(e,t){return e instanceof ko?this._get(2).sendMessageInstance(e,t):C({code:T.MSG_INSTANCE_REQUIRED})}},{key:"callExperimentalAPI",value:function(e,t){return "sendComboMessage"===e?this._get(31).sendMessage(t):"handleGroupInvitation"===e?this._get(7).handleGroupInvitation(t):"isCommercialAbilityEnabled"===e?this._get(27).isFeatureEnabled(t):"isFeatureEnabledForStat"===e?this._get(27).isFeatureEnabledForStat(t):"isIntl"===e?this.isIntl():"sendTRTCCustomData"===e||"sendRoomCustomData"===e?this._get(30).sendTRTCCustomData(t):"getTimerID"===e?this._m.getTimerID():"getPollingTimerID"===e?this._m.getPollingTimerID(t):"setApplicationID"===e?(this._get(12).setApplicationID(t),void this._get(20).updateProtocolConfig()):"getServerConfig"===e?this._get(23).getServerConfig(t):"canIUseModule"===e?this._m.canIUseModule(t):"startMessageLongPolling"===e?this._get(7).startMessageLongPolling(t):"stopMessageLongPolling"===e?this._get(7).stopMessageLongPolling(t):"disableMessagePullOnInvite"===e?this._get(11).disableMsgPullOnInvite(t):"clearLocalMessage"===e?this._get(11).clearMemMsg(t,!1):"setCustomLoginInfo"===e?this._get(12).setCustomLoginInfo(t):"statTUIKeyFeatures"===e?this._m.statTUIKeyFeatures(t):C({code:T.INVALID_OPERATION})}},{key:"revokeMessage",value:function(e){return this._get(2).revokeMessage(e)}},{key:"resendMessage",value:function(e,t){return e instanceof ko?this._get(2).resendMessage(e,t):C({code:T.MSG_INSTANCE_REQUIRED})}},{key:"deleteMessage",value:function(e){return this._get(2).deleteMessage(e)}},{key:"translateText",value:function(e){return this._get(2).translateText(e)}},{key:"convertVoiceToText",value:function(e){return this._get(2).convertVoiceToText(e)}},{key:"setMessageExtensions",value:function(e,t){return this._get(3).setMessageExtensions(e,t)}},{key:"getMessageExtensions",value:function(e){return this._get(3).getMessageExtensions(e)}},{key:"deleteMessageExtensions",value:function(e,t){return this._get(3).deleteMessageExtensions(e,t)}},{key:"addMessageReaction",value:function(e,t){return this._get(34).addMessageReaction(e,t)}},{key:"removeMessageReaction",value:function(e,t){return this._get(34).removeMessageReaction(e,t)}},{key:"getMessageReactions",value:function(e){return this._get(34).getMessageReactions(e)}},{key:"getAllUserListOfMessageReaction",value:function(e){return this._get(34).getAllUserListOfMessageReaction(e)}},{key:"modifyMessage",value:function(e){return this._get(2).modifyRemoteMessage(e)}},{key:"getMessageList",value:function(e){return this._get(11).getMessageList(e)}},{key:"getMessageListHopping",value:function(e){return this._get(11).getMessageListHopping(e)}},{key:"sendMessageReadReceipt",value:function(e){return this._get(11).sendReadReceipt(e)}},{key:"getMessageReadReceiptList",value:function(e){return this._get(11).getReadReceiptList(e)}},{key:"getGroupMessageReadMemberList",value:function(e){var t=this._get(7);return t?t.getReadReceiptDetail(e):C({code:T.NO_MODULE})}},{key:"findMessage",value:function(e){return this._get(11).findMessage(e)}},{key:"setMessageRead",value:function(e){return this._get(11).setMessageRead(e)}},{key:"getConversationList",value:function(e){return this._get(11).getConvList(e)}},{key:"getConversationProfile",value:function(e){return this._get(11).getConversationProfile(e)}},{key:"deleteConversation",value:function(e){return this._get(11).deleteConversation(e)}},{key:"setConversationDraft",value:function(e){return this._get(11).setConvDraft(e)}},{key:"clearHistoryMessage",value:function(e){return this._get(11).clearHistoryMessage(e)}},{key:"pinConversation",value:function(e){return this._get(11).pinConversation(e)}},{key:"setAllMessageRead",value:function(e){return this._get(11).setAllMessageRead(e)}},{key:"setMessageRemindType",value:function(e){return this._get(11).setMessageRemindType(e)}},{key:"setAllReceiveMessageOpt",value:function(e){return this._get(11).setAllRcvMsgOpt(e)}},{key:"getAllReceiveMessageOpt",value:function(){return this._get(11).getAllRcvMsgOpt()}},{key:"getTotalUnreadMessageCount",value:function(){return this._get(11).getTotalUnreadCount()}},{key:"setConversationCustomData",value:function(e){return this._get(11).setConvCustomData(e)}},{key:"markConversation",value:function(e){return this._get(11).markConv(e)}},{key:"getConversationGroupList",value:function(){return this._get(11).getConvGroupList()}},{key:"createConversationGroup",value:function(e){return this._get(11).createConvGroup(e)}},{key:"deleteConversationGroup",value:function(e){return this._get(11).deleteConvGroup(e)}},{key:"renameConversationGroup",value:function(e){return this._get(11).renameConvGroup(e)}},{key:"addConversationsToGroup",value:function(e){return this._get(11).addConvsToGroup(e)}},{key:"deleteConversationsFromGroup",value:function(e){return this._get(11).deleteConvsFromGroup(e)}},{key:"searchCloudMessages",value:function(e){var t=this._get(38);return t?t.search(Pc,e):C({code:T.NO_MODULE})}},{key:"searchCloudUsers",value:function(e){var t=this._get(38);return t?t.search(Uc,e):C({code:T.NO_MODULE})}},{key:"searchCloudGroups",value:function(e){var t=this._get(38);return t?t.search(bc,e):C({code:T.NO_MODULE})}},{key:"searchCloudGroupMembers",value:function(e){var t=this._get(38);return t?t.search(wc,e):C({code:T.NO_MODULE})}},{key:"getMyProfile",value:function(){return this._get(4).getMyProfile()}},{key:"getUserProfile",value:function(e){return this._get(4).getUserProfile(e)}},{key:"updateMyProfile",value:function(e){return this._get(4).updateMyProfile(e)}},{key:"getBlacklist",value:function(){return this._get(4).getLocalBlacklist()}},{key:"addToBlacklist",value:function(e){return this._get(4).addBlacklist(e)}},{key:"removeFromBlacklist",value:function(e){return this._get(4).deleteBlacklist(e)}},{key:"setSelfStatus",value:function(e){return this._get(4).setSelfStatus(e)}},{key:"getUserStatus",value:function(e){return this._get(4).getUserStatus(e)}},{key:"subscribeUserStatus",value:function(e){return this._get(4).subscribeUserStatus(e)}},{key:"unsubscribeUserStatus",value:function(e){return this._get(4).unsubscribeUserStatus(e)}},{key:"getFriendList",value:function(){var e=this._get(8);return e?e.getLocalFriendList():C({code:T.NO_MODULE})}},{key:"addFriend",value:function(e){var t=this._get(8);return t?t.addFriend(e):C({code:T.NO_MODULE})}},{key:"deleteFriend",value:function(e){var t=this._get(8);return t?t.deleteFriend(e):C({code:T.NO_MODULE})}},{key:"checkFriend",value:function(e){var t=this._get(8);return t?t.checkFriend(e):C({code:T.NO_MODULE})}},{key:"getFriendProfile",value:function(e){var t=this._get(8);return t?t.getFriendProfile(e):C({code:T.NO_MODULE})}},{key:"updateFriend",value:function(e){var t=this._get(8);return t?t.updateFriend(e):C({code:T.NO_MODULE})}},{key:"getFriendApplicationList",value:function(){var e=this._get(8);return e?e.getLocalFriendApplicationList():C({code:T.NO_MODULE})}},{key:"acceptFriendApplication",value:function(e){var t=this._get(8);return t?t.acceptFriendApplication(e):C({code:T.NO_MODULE})}},{key:"refuseFriendApplication",value:function(e){var t=this._get(8);return t?t.refuseFriendApplication(e):C({code:T.NO_MODULE})}},{key:"deleteFriendApplication",value:function(e){var t=this._get(8);return t?t.deleteFriendApplication(e):C({code:T.NO_MODULE})}},{key:"setFriendApplicationRead",value:function(){var e=this._get(8);return e?e.setFriendApplicationRead():C({code:T.NO_MODULE})}},{key:"getFriendGroupList",value:function(){var e=this._get(8);return e?e.getLocalFriendGroupList():C({code:T.NO_MODULE})}},{key:"createFriendGroup",value:function(e){var t=this._get(8);return t?t.createFriendGroup(e):C({code:T.NO_MODULE})}},{key:"deleteFriendGroup",value:function(e){var t=this._get(8);return t?t.deleteFriendGroup(e):C({code:T.NO_MODULE})}},{key:"addToFriendGroup",value:function(e){var t=this._get(8);return t?t.addToFriendGroup(e):C({code:T.NO_MODULE})}},{key:"removeFromFriendGroup",value:function(e){var t=this._get(8);return t?t.removeFromFriendGroup(e):C({code:T.NO_MODULE})}},{key:"renameFriendGroup",value:function(e){var t=this._get(8);return t?t.renameFriendGroup(e):C({code:T.NO_MODULE})}},{key:"followUser",value:function(e){var t=this._get(35);return t?t.followUser(e):C({code:T.NO_MODULE})}},{key:"unfollowUser",value:function(e){var t=this._get(35);return t?t.unfollowUser(e):C({code:T.NO_MODULE})}},{key:"getMyFollowersList",value:function(e){var t=this._get(35);return t?t.getMyFollowersList(e):C({code:T.NO_MODULE})}},{key:"getMyFollowingList",value:function(e){var t=this._get(35);return t?t.getMyFollowingList(e):C({code:T.NO_MODULE})}},{key:"getMutualFollowersList",value:function(e){var t=this._get(35);return t?t.getMutualFollowersList(e):C({code:T.NO_MODULE})}},{key:"getUserFollowInfo",value:function(e){var t=this._get(35);return t?t.getUserFollowInfo(e):C({code:T.NO_MODULE})}},{key:"checkFollowType",value:function(e){var t=this._get(35);return t?t.checkFollowType(e):C({code:T.NO_MODULE})}},{key:"getGroupList",value:function(){var e=this._get(7);return e?e.getGroupList():C({code:T.NO_MODULE})}},{key:"getGroupProfile",value:function(e){var t=this._get(7);return t?t.getGroupProfile(e):C({code:T.NO_MODULE})}},{key:"createGroup",value:function(e){var t=this._get(7);return t?t.createGroup(e):C({code:T.NO_MODULE})}},{key:"dismissGroup",value:function(e){var t=this._get(7);return t?t.dismissGroup(e):C({code:T.NO_MODULE})}},{key:"updateGroupProfile",value:function(e){var t=this._get(7);return t?t.updateGroupProfile(e):C({code:T.NO_MODULE})}},{key:"joinGroup",value:function(e){var t=this._get(7);return t?t.joinGroup(e):C({code:T.NO_MODULE})}},{key:"quitGroup",value:function(e){var t=this._get(7);return t?t.quitGroup(e):C({code:T.NO_MODULE})}},{key:"searchGroupByID",value:function(e){var t=this._get(7);return t?t.searchGroupByID(e):C({code:T.NO_MODULE})}},{key:"getGroupOnlineMemberCount",value:function(e){var t=this._get(7);return t?t.getGroupOnlineMemberCount(e):C({code:T.NO_MODULE})}},{key:"changeGroupOwner",value:function(e){var t=this._get(7);return t?t.changeGroupOwner(e):C({code:T.NO_MODULE})}},{key:"getGroupApplicationList",value:function(){var e=this._get(7);return e?e.getGroupApplicationList():C({code:T.NO_MODULE})}},{key:"handleGroupApplication",value:function(e){var t=this._get(7);return t?t.handleGroupApplication(e):C({code:T.NO_MODULE})}},{key:"initGroupAttributes",value:function(e){var t=this._get(7);return t?t.initGroupAttributes(e):C({code:T.NO_MODULE})}},{key:"setGroupAttributes",value:function(e){var t=this._get(7);return t?t.setGroupAttributes(e):C({code:T.NO_MODULE})}},{key:"deleteGroupAttributes",value:function(e){var t=this._get(7);return t?t.deleteGroupAttributes(e):C({code:T.NO_MODULE})}},{key:"getGroupAttributes",value:function(e){var t=this._get(7);return t?t.getGroupAttributes(e):C({code:T.NO_MODULE})}},{key:"setGroupCounters",value:function(e){var t=this._get(7);return t?t.setGroupCounters(e):C({code:T.NO_MODULE})}},{key:"increaseGroupCounter",value:function(e){var t=this._get(7);return t?t.increaseGroupCounter(e):C({code:T.NO_MODULE})}},{key:"decreaseGroupCounter",value:function(e){var t=this._get(7);return t?t.decreaseGroupCounter(e):C({code:T.NO_MODULE})}},{key:"getGroupCounters",value:function(e){var t=this._get(7);return t?t.getGroupCounters(e):C({code:T.NO_MODULE})}},{key:"getGroupMemberList",value:function(e){var t=this._get(7);return t?t.getGroupMemberList(e):C({code:T.NO_MODULE})}},{key:"getGroupMemberProfile",value:function(e){var t=this._get(7);return t?t.getGroupMemberProfile(e):C({code:T.NO_MODULE})}},{key:"addGroupMember",value:function(e){var t=this._get(7);return t?t.addGroupMember(e):C({code:T.NO_MODULE})}},{key:"deleteGroupMember",value:function(e){var t=this._get(7);return t?t.deleteGroupMember(e):C({code:T.NO_MODULE})}},{key:"setGroupMemberMuteTime",value:function(e){var t=this._get(7);return t?t.setGroupMemberMuteTime(e):C({code:T.NO_MODULE})}},{key:"setGroupMemberRole",value:function(e){var t=this._get(7);return t?t.setGroupMemberRole(e):C({code:T.NO_MODULE})}},{key:"setGroupMemberNameCard",value:function(e){var t=this._get(7);return t?t.setGroupMemberNameCard(e):C({code:T.NO_MODULE})}},{key:"setGroupMemberCustomField",value:function(e){var t=this._get(7);return t?t.setGroupMemberCustomField(e):C({code:T.NO_MODULE})}},{key:"markGroupMemberList",value:function(e){var t=this._get(7);return t?t.markGroupMemberList(e):C({code:T.NO_MODULE})}},{key:"getJoinedCommunityList",value:function(){return this._get(10).getJoinedCommunityList()}},{key:"createTopicInCommunity",value:function(e){return this._get(10).createTopicInCommunity(e)}},{key:"deleteTopicFromCommunity",value:function(e){return this._get(10).deleteTopicFromCommunity(e)}},{key:"updateTopicProfile",value:function(e){return this._get(10).updateTopicProfile(e)}},{key:"getTopicList",value:function(e){return this._get(10).getTopicList(e)}},{key:"addSignalingListener",value:function(e,t,n){var o=this._get(33);o&&o.addSignalingListener(e,this._safetyCallbackFactory.defense(e,t,n),n);}},{key:"removeSignalingListener",value:function(e,t,n){var o,i=this._safetyCallbackFactory.find(e,t);null===i||(o=this._get(33))&&(o.removeSignalingListener(e,i,n),this._safetyCallbackFactory.delete(e,t));}},{key:"invite",value:function(e){var t=this._get(33);return t?t.invite(e):C({code:T.NO_MODULE})}},{key:"inviteSync",value:function(e,t,n){var o=this._get(33);return o?o.inviteSync(e,t,n):""}},{key:"inviteInGroup",value:function(e){var t=this._get(33);return t?t.invite(e):C({code:T.NO_MODULE})}},{key:"inviteInGroupSync",value:function(e,t,n){var o=this._get(33);return o?o.inviteSync(e,t,n):""}},{key:"cancel",value:function(e){var t=this._get(33);return t?t.cancel(e):C({code:T.NO_MODULE})}},{key:"accept",value:function(e){var t=this._get(33);return t?t.accept(e):C({code:T.NO_MODULE})}},{key:"reject",value:function(e){var t=this._get(33);return t?t.reject(e):C({code:T.NO_MODULE})}},{key:"getSignalingInfo",value:function(e){var t=this._get(33);return t?t.getSignalingInfo(e):null}},{key:"modifyInvitation",value:function(e){var t=this._get(33);return t?t.modifyInvitation(e):C({code:T.NO_MODULE})}}]),jc),Wc={login:1,logout:1,getLoginUser:1,destroy:1,on:1,off:1,ready:1,setLogLevel:1,joinGroup:1,quitGroup:1,registerPlugin:1,getGroupOnlineMemberCount:1,isReady:1,addSignalingListener:1,removeSignalingListener:1,callExperimentalAPI:1};function jc(e){d(this,jc);e={SDKAppID:e.SDKAppID,unlimitedAVChatRoom:e.unlimitedAVChatRoom||!1,scene:e.scene||"",oversea:e.oversea||!1,instanceID:Pt(),devMode:e.devMode||!1,testEnv:e.testEnv||!1,proxyServer:e.proxyServer||void 0,fileUploadProxy:e.fileUploadProxy||void 0,fileDownloadProxy:e.fileDownloadProxy||e.fileUploadProxy||void 0,eventThrottling:!1!==e.eventThrottling,partialUpdatedConversations:!0===e.partialUpdatedConversations,disableIndependentDomain:!0===e.disableIndependentDomain,modules:e.modules||void 0};this._m=new Bc(e),this._safetyCallbackFactory=new Kc(this._m);}function Jc(e){d(this,Jc),this._funcMap=new Map,this._m=e,this._n="SafetyCallback",this._reportCount=0;}function zc(t){var n=this;d(this,zc);var o,e=new M("sdkConstruct"),i=(this._n="ModuleManager",this._isReady=!1,this._reason=T.USER_NOT_LOGGED_IN,this._startLoginTs=0,this._map=new Map,this._optionalModuleMap=new Map,this._codeMsgForTUIMap=new Map,this._iEmitter=null,this._oEmitter=null,this._checkCount=0,this._checkTimer=-1,this._map.set(12,new bi(this,t)),this._map.set(37,new Gc(this)),this._map.set(15,new va(this)),this._map.set(27,new ur(this)),this._map.set(23,new js(this)),this._map.set(24,new rr(this)),this._map.set(26,new $s(this)),this._map.set(21,new fs(this)),this._map.set(20,new Ws(this)),this._map.set(1,new Fi(this)),this._map.set(2,new Ha(this)),this._map.set(3,new Ba(this)),this._map.set(34,new Ka(this)),this._map.set(31,new Ya(this)),this._map.set(4,new Ui(this)),this._map.set(6,new Ko(this)),this._map.set(11,new hi(this)),this._map.set(7,new Si(this)),this._map.set(10,new Ai(this)),this._map.set(13,new _a(this)),this._map.set(32,new hr(this)),this._map.set(14,new ga(this)),this._map.set(17,new ka(this)),this._map.set(18,new Wa(this)),this._map.set(19,new ja(this)),this._map.set(25,new Js(this)),this._map.set(8,new sr(this)),this._map.set(28,new lr(this)),this._map.set(36,new dr(this)),this._map.set(29,new pr(this)),this._map.set(30,new _r(this)),this._map.set(33,new yr(this)),this._map.set(35,new Er(this)),this._map.set(38,new Hc(this)),this._eventThrottleMap=new Map,this._eventThrottling=t.eventThrottling,this._map.get(12).isPartialUpdatedConvs()&&(this._eventThrottling=!1),et(t.modules)?(Object.keys(t.modules).forEach(function(e){o=t.modules[e],"group-module"===e?n._map.set(7,new o(n)):"relationship-module"===e?n._map.set(8,new o(n)):"signaling-module"===e?n._map.set(33,new o(n)):"follow-module"===e?n._map.set(35,new o(n)):"cloud-search-module"===e&&n._map.set(38,new o(n)),n._optionalModuleMap.set(e,1);}),this._map.get(12).setUsingChatCore(!0)):this._map.has(7)||this._map.get(12).setUsingChatCore(!0),t.instanceID),a=t.SDKAppID,s=this._map.get(12).isIntl(),r=this._map.get(12).isUsingChatCore(),i="instanceID:".concat(i," SDKAppID:").concat(a," isIntl:").concat(s," isUsingChatCore:").concat(r," host:").concat(Ut())+" isIOSWebView:".concat(De," platform:").concat(de," canIUseInflate:").concat(this.canIUseInflate())+" workerAvailable:".concat(ye," eventThrottling:").concat(this._eventThrottling," UserAgent:").concat(le);M.bindEventStatModule(this._map.get(14)),M.bindNetMonitorModule(this._map.get(15)),e.setMessage("".concat(i," ").concat(function(){var t="";if(ae)try{var e=ue.getSystemInfoSync(),n=e.model,o=e.version,i=e.system,a=e.platform,s=e.SDKVersion,t="model:".concat(n," version:").concat(o," system:").concat(i," platform:").concat(a," SDKVersion:").concat(s);}catch(e){t="";}return t}())).end(),v.i("SDK ".concat(i)),Hn.prototype._getErrMsg=this.getErrMsg.bind(this),this._readyList=void 0,this._ssoLogForReady=null,this._initReadyList();}function Xc(e){return d(this,Xc),(e=Oc.call(this,e))._n="CSModule",e}function Zc(e){d(this,Zc),this._m=e,this._n="InflateModule",this._bLogForInflateOK=!1,this._bLogForInflateError=!1;}var Qc={},oe={};return oe.create=function(e){var t="TencentCloudChat.create",n=0,o=e.SDKAppID;if(Qe(o))n=o;else if(n=parseInt(o),isNaN(o))return v.e("".concat(t," failed. Failed to parse the SDKAppID, please check the arguments")),null;if(n&&Qc[n])return Qc[n];v.l("".concat(t));var i,a,o=new Yc(y(y({},e),{},{SDKAppID:n})),e=(o.on(G.SDK_DESTROY,function(e){Qc[e.data.SDKAppID]=null,delete Qc[e.data.SDKAppID];}),i=o,a=Object.create(null),Object.keys(Vn).forEach(function(o){var t;i[o]&&(t=new U,a[o]=function(){var e=Array.from(arguments);return t.use(function(e,t){var n=function(e,t){if(e.isReady()||1===Wc[t])return !0;var n={code:n=e.getNotReadyReason(),message:"".concat(e.getErrMsg(n)," | ").concat(t," | ").concat(e.getErrMsg(T.SDK_IS_NOT_READY))};return e.onError(n),n}(i,o);return !0===n?t():C(n)}).use(function(e,t){if(!0===function(n,o,i){if(void 0===o)return !0;var a=!0;if(et(o))Object.keys(o).forEach(function(e){var t=1===n.length?n[0][e]:void 0;a=!!$t(t,o[e],i,e)&&a;});else if(nt(o))for(var e=0;e<o.length;e++)a=!!$t(n[e],o[e],i,o[e].name)&&a;if(a)return a;throw new Error("Params validate failed.")}(e,xn[o],o))return t()}).use(function(e,t){return i[o].apply(i,e)}),t.run(e)});}),a);return Qc[n]=e,xn.hookGetAPITips(o.getErrMsg.bind(o)),v.l("".concat(t," ok")),e},oe.TYPES=R,oe.EVENT=G,oe.TSignaling=P,oe.VERSION="3.5.0",v.l("TencentCloudChat.VERSION:".concat(oe.VERSION)),oe}); 
		} (chat$1, chat$1.exports));
		return chat$1.exports;
	}

	var chatExports = requireChat();
	var TencentCloudChat = /*@__PURE__*/getDefaultExportFromCjs(chatExports);

	function asyncGeneratorStep(n, t, e, r, o, a, c) {
	  try {
	    var i = n[a](c),
	      u = i.value;
	  } catch (n) {
	    return void e(n);
	  }
	  i.done ? t(u) : Promise.resolve(u).then(r, o);
	}
	function _asyncToGenerator(n) {
	  return function () {
	    var t = this,
	      e = arguments;
	    return new Promise(function (r, o) {
	      var a = n.apply(t, e);
	      function _next(n) {
	        asyncGeneratorStep(a, r, o, _next, _throw, "next", n);
	      }
	      function _throw(n) {
	        asyncGeneratorStep(a, r, o, _next, _throw, "throw", n);
	      }
	      _next(void 0);
	    });
	  };
	}
	function _classCallCheck(a, n) {
	  if (!(a instanceof n)) throw new TypeError("Cannot call a class as a function");
	}
	function _defineProperties(e, r) {
	  for (var t = 0; t < r.length; t++) {
	    var o = r[t];
	    o.enumerable = o.enumerable || !1, o.configurable = !0, "value" in o && (o.writable = !0), Object.defineProperty(e, _toPropertyKey(o.key), o);
	  }
	}
	function _createClass(e, r, t) {
	  return r && _defineProperties(e.prototype, r), t && _defineProperties(e, t), Object.defineProperty(e, "prototype", {
	    writable: !1
	  }), e;
	}
	function _regeneratorRuntime() {
	  _regeneratorRuntime = function () {
	    return e;
	  };
	  var t,
	    e = {},
	    r = Object.prototype,
	    n = r.hasOwnProperty,
	    o = Object.defineProperty || function (t, e, r) {
	      t[e] = r.value;
	    },
	    i = "function" == typeof Symbol ? Symbol : {},
	    a = i.iterator || "@@iterator",
	    c = i.asyncIterator || "@@asyncIterator",
	    u = i.toStringTag || "@@toStringTag";
	  function define(t, e, r) {
	    return Object.defineProperty(t, e, {
	      value: r,
	      enumerable: !0,
	      configurable: !0,
	      writable: !0
	    }), t[e];
	  }
	  try {
	    define({}, "");
	  } catch (t) {
	    define = function (t, e, r) {
	      return t[e] = r;
	    };
	  }
	  function wrap(t, e, r, n) {
	    var i = e && e.prototype instanceof Generator ? e : Generator,
	      a = Object.create(i.prototype),
	      c = new Context(n || []);
	    return o(a, "_invoke", {
	      value: makeInvokeMethod(t, r, c)
	    }), a;
	  }
	  function tryCatch(t, e, r) {
	    try {
	      return {
	        type: "normal",
	        arg: t.call(e, r)
	      };
	    } catch (t) {
	      return {
	        type: "throw",
	        arg: t
	      };
	    }
	  }
	  e.wrap = wrap;
	  var h = "suspendedStart",
	    l = "suspendedYield",
	    f = "executing",
	    s = "completed",
	    y = {};
	  function Generator() {}
	  function GeneratorFunction() {}
	  function GeneratorFunctionPrototype() {}
	  var p = {};
	  define(p, a, function () {
	    return this;
	  });
	  var d = Object.getPrototypeOf,
	    v = d && d(d(values([])));
	  v && v !== r && n.call(v, a) && (p = v);
	  var g = GeneratorFunctionPrototype.prototype = Generator.prototype = Object.create(p);
	  function defineIteratorMethods(t) {
	    ["next", "throw", "return"].forEach(function (e) {
	      define(t, e, function (t) {
	        return this._invoke(e, t);
	      });
	    });
	  }
	  function AsyncIterator(t, e) {
	    function invoke(r, o, i, a) {
	      var c = tryCatch(t[r], t, o);
	      if ("throw" !== c.type) {
	        var u = c.arg,
	          h = u.value;
	        return h && "object" == typeof h && n.call(h, "__await") ? e.resolve(h.__await).then(function (t) {
	          invoke("next", t, i, a);
	        }, function (t) {
	          invoke("throw", t, i, a);
	        }) : e.resolve(h).then(function (t) {
	          u.value = t, i(u);
	        }, function (t) {
	          return invoke("throw", t, i, a);
	        });
	      }
	      a(c.arg);
	    }
	    var r;
	    o(this, "_invoke", {
	      value: function (t, n) {
	        function callInvokeWithMethodAndArg() {
	          return new e(function (e, r) {
	            invoke(t, n, e, r);
	          });
	        }
	        return r = r ? r.then(callInvokeWithMethodAndArg, callInvokeWithMethodAndArg) : callInvokeWithMethodAndArg();
	      }
	    });
	  }
	  function makeInvokeMethod(e, r, n) {
	    var o = h;
	    return function (i, a) {
	      if (o === f) throw Error("Generator is already running");
	      if (o === s) {
	        if ("throw" === i) throw a;
	        return {
	          value: t,
	          done: !0
	        };
	      }
	      for (n.method = i, n.arg = a;;) {
	        var c = n.delegate;
	        if (c) {
	          var u = maybeInvokeDelegate(c, n);
	          if (u) {
	            if (u === y) continue;
	            return u;
	          }
	        }
	        if ("next" === n.method) n.sent = n._sent = n.arg;else if ("throw" === n.method) {
	          if (o === h) throw o = s, n.arg;
	          n.dispatchException(n.arg);
	        } else "return" === n.method && n.abrupt("return", n.arg);
	        o = f;
	        var p = tryCatch(e, r, n);
	        if ("normal" === p.type) {
	          if (o = n.done ? s : l, p.arg === y) continue;
	          return {
	            value: p.arg,
	            done: n.done
	          };
	        }
	        "throw" === p.type && (o = s, n.method = "throw", n.arg = p.arg);
	      }
	    };
	  }
	  function maybeInvokeDelegate(e, r) {
	    var n = r.method,
	      o = e.iterator[n];
	    if (o === t) return r.delegate = null, "throw" === n && e.iterator.return && (r.method = "return", r.arg = t, maybeInvokeDelegate(e, r), "throw" === r.method) || "return" !== n && (r.method = "throw", r.arg = new TypeError("The iterator does not provide a '" + n + "' method")), y;
	    var i = tryCatch(o, e.iterator, r.arg);
	    if ("throw" === i.type) return r.method = "throw", r.arg = i.arg, r.delegate = null, y;
	    var a = i.arg;
	    return a ? a.done ? (r[e.resultName] = a.value, r.next = e.nextLoc, "return" !== r.method && (r.method = "next", r.arg = t), r.delegate = null, y) : a : (r.method = "throw", r.arg = new TypeError("iterator result is not an object"), r.delegate = null, y);
	  }
	  function pushTryEntry(t) {
	    var e = {
	      tryLoc: t[0]
	    };
	    1 in t && (e.catchLoc = t[1]), 2 in t && (e.finallyLoc = t[2], e.afterLoc = t[3]), this.tryEntries.push(e);
	  }
	  function resetTryEntry(t) {
	    var e = t.completion || {};
	    e.type = "normal", delete e.arg, t.completion = e;
	  }
	  function Context(t) {
	    this.tryEntries = [{
	      tryLoc: "root"
	    }], t.forEach(pushTryEntry, this), this.reset(!0);
	  }
	  function values(e) {
	    if (e || "" === e) {
	      var r = e[a];
	      if (r) return r.call(e);
	      if ("function" == typeof e.next) return e;
	      if (!isNaN(e.length)) {
	        var o = -1,
	          i = function next() {
	            for (; ++o < e.length;) if (n.call(e, o)) return next.value = e[o], next.done = !1, next;
	            return next.value = t, next.done = !0, next;
	          };
	        return i.next = i;
	      }
	    }
	    throw new TypeError(typeof e + " is not iterable");
	  }
	  return GeneratorFunction.prototype = GeneratorFunctionPrototype, o(g, "constructor", {
	    value: GeneratorFunctionPrototype,
	    configurable: !0
	  }), o(GeneratorFunctionPrototype, "constructor", {
	    value: GeneratorFunction,
	    configurable: !0
	  }), GeneratorFunction.displayName = define(GeneratorFunctionPrototype, u, "GeneratorFunction"), e.isGeneratorFunction = function (t) {
	    var e = "function" == typeof t && t.constructor;
	    return !!e && (e === GeneratorFunction || "GeneratorFunction" === (e.displayName || e.name));
	  }, e.mark = function (t) {
	    return Object.setPrototypeOf ? Object.setPrototypeOf(t, GeneratorFunctionPrototype) : (t.__proto__ = GeneratorFunctionPrototype, define(t, u, "GeneratorFunction")), t.prototype = Object.create(g), t;
	  }, e.awrap = function (t) {
	    return {
	      __await: t
	    };
	  }, defineIteratorMethods(AsyncIterator.prototype), define(AsyncIterator.prototype, c, function () {
	    return this;
	  }), e.AsyncIterator = AsyncIterator, e.async = function (t, r, n, o, i) {
	    void 0 === i && (i = Promise);
	    var a = new AsyncIterator(wrap(t, r, n, o), i);
	    return e.isGeneratorFunction(r) ? a : a.next().then(function (t) {
	      return t.done ? t.value : a.next();
	    });
	  }, defineIteratorMethods(g), define(g, u, "Generator"), define(g, a, function () {
	    return this;
	  }), define(g, "toString", function () {
	    return "[object Generator]";
	  }), e.keys = function (t) {
	    var e = Object(t),
	      r = [];
	    for (var n in e) r.push(n);
	    return r.reverse(), function next() {
	      for (; r.length;) {
	        var t = r.pop();
	        if (t in e) return next.value = t, next.done = !1, next;
	      }
	      return next.done = !0, next;
	    };
	  }, e.values = values, Context.prototype = {
	    constructor: Context,
	    reset: function (e) {
	      if (this.prev = 0, this.next = 0, this.sent = this._sent = t, this.done = !1, this.delegate = null, this.method = "next", this.arg = t, this.tryEntries.forEach(resetTryEntry), !e) for (var r in this) "t" === r.charAt(0) && n.call(this, r) && !isNaN(+r.slice(1)) && (this[r] = t);
	    },
	    stop: function () {
	      this.done = !0;
	      var t = this.tryEntries[0].completion;
	      if ("throw" === t.type) throw t.arg;
	      return this.rval;
	    },
	    dispatchException: function (e) {
	      if (this.done) throw e;
	      var r = this;
	      function handle(n, o) {
	        return a.type = "throw", a.arg = e, r.next = n, o && (r.method = "next", r.arg = t), !!o;
	      }
	      for (var o = this.tryEntries.length - 1; o >= 0; --o) {
	        var i = this.tryEntries[o],
	          a = i.completion;
	        if ("root" === i.tryLoc) return handle("end");
	        if (i.tryLoc <= this.prev) {
	          var c = n.call(i, "catchLoc"),
	            u = n.call(i, "finallyLoc");
	          if (c && u) {
	            if (this.prev < i.catchLoc) return handle(i.catchLoc, !0);
	            if (this.prev < i.finallyLoc) return handle(i.finallyLoc);
	          } else if (c) {
	            if (this.prev < i.catchLoc) return handle(i.catchLoc, !0);
	          } else {
	            if (!u) throw Error("try statement without catch or finally");
	            if (this.prev < i.finallyLoc) return handle(i.finallyLoc);
	          }
	        }
	      }
	    },
	    abrupt: function (t, e) {
	      for (var r = this.tryEntries.length - 1; r >= 0; --r) {
	        var o = this.tryEntries[r];
	        if (o.tryLoc <= this.prev && n.call(o, "finallyLoc") && this.prev < o.finallyLoc) {
	          var i = o;
	          break;
	        }
	      }
	      i && ("break" === t || "continue" === t) && i.tryLoc <= e && e <= i.finallyLoc && (i = null);
	      var a = i ? i.completion : {};
	      return a.type = t, a.arg = e, i ? (this.method = "next", this.next = i.finallyLoc, y) : this.complete(a);
	    },
	    complete: function (t, e) {
	      if ("throw" === t.type) throw t.arg;
	      return "break" === t.type || "continue" === t.type ? this.next = t.arg : "return" === t.type ? (this.rval = this.arg = t.arg, this.method = "return", this.next = "end") : "normal" === t.type && e && (this.next = e), y;
	    },
	    finish: function (t) {
	      for (var e = this.tryEntries.length - 1; e >= 0; --e) {
	        var r = this.tryEntries[e];
	        if (r.finallyLoc === t) return this.complete(r.completion, r.afterLoc), resetTryEntry(r), y;
	      }
	    },
	    catch: function (t) {
	      for (var e = this.tryEntries.length - 1; e >= 0; --e) {
	        var r = this.tryEntries[e];
	        if (r.tryLoc === t) {
	          var n = r.completion;
	          if ("throw" === n.type) {
	            var o = n.arg;
	            resetTryEntry(r);
	          }
	          return o;
	        }
	      }
	      throw Error("illegal catch attempt");
	    },
	    delegateYield: function (e, r, n) {
	      return this.delegate = {
	        iterator: values(e),
	        resultName: r,
	        nextLoc: n
	      }, "next" === this.method && (this.arg = t), y;
	    }
	  }, e;
	}
	function _toPrimitive(t, r) {
	  if ("object" != typeof t || !t) return t;
	  var e = t[Symbol.toPrimitive];
	  if (void 0 !== e) {
	    var i = e.call(t, r || "default");
	    if ("object" != typeof i) return i;
	    throw new TypeError("@@toPrimitive must return a primitive value.");
	  }
	  return ("string" === r ? String : Number)(t);
	}
	function _toPropertyKey(t) {
	  var i = _toPrimitive(t, "string");
	  return "symbol" == typeof i ? i : i + "";
	}
	function _typeof(o) {
	  "@babel/helpers - typeof";

	  return _typeof = "function" == typeof Symbol && "symbol" == typeof Symbol.iterator ? function (o) {
	    return typeof o;
	  } : function (o) {
	    return o && "function" == typeof Symbol && o.constructor === Symbol && o !== Symbol.prototype ? "symbol" : typeof o;
	  }, _typeof(o);
	}

	var libGenerateTestUsersig_min$1 = {exports: {}};

	var libGenerateTestUsersig_min = libGenerateTestUsersig_min$1.exports;
	var hasRequiredLibGenerateTestUsersig_min;
	function requireLibGenerateTestUsersig_min() {
	  if (hasRequiredLibGenerateTestUsersig_min) return libGenerateTestUsersig_min$1.exports;
	  hasRequiredLibGenerateTestUsersig_min = 1;
	  (function (module, exports) {
	    !function (e, t) {
	      module.exports = t() ;
	    }(libGenerateTestUsersig_min, function () {

	      var e = 'undefined' != typeof commonjsGlobal ? commonjsGlobal : 'undefined' != typeof self ? self : 'undefined' != typeof window ? window : {},
	        t = [],
	        r = [],
	        n = 'undefined' != typeof Uint8Array ? Uint8Array : Array,
	        i = !1;
	      function o() {
	        i = !0;
	        for (var e = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/', n = 0, o = e.length; n < o; ++n) t[n] = e[n], r[e.charCodeAt(n)] = n;
	        r['-'.charCodeAt(0)] = 62, r['_'.charCodeAt(0)] = 63;
	      }
	      function a(e, r, n) {
	        for (var i, o, a = [], s = r; s < n; s += 3) i = (e[s] << 16) + (e[s + 1] << 8) + e[s + 2], a.push(t[(o = i) >> 18 & 63] + t[o >> 12 & 63] + t[o >> 6 & 63] + t[63 & o]);
	        return a.join('');
	      }
	      function s(e) {
	        var r;
	        i || o();
	        for (var n = e.length, s = n % 3, h = '', f = [], l = 0, c = n - s; l < c; l += 16383) f.push(a(e, l, l + 16383 > c ? c : l + 16383));
	        return 1 === s ? (r = e[n - 1], h += t[r >> 2], h += t[r << 4 & 63], h += '==') : 2 === s && (r = (e[n - 2] << 8) + e[n - 1], h += t[r >> 10], h += t[r >> 4 & 63], h += t[r << 2 & 63], h += '='), f.push(h), f.join('');
	      }
	      function h(e, t, r, n, i) {
	        var o,
	          a,
	          s = 8 * i - n - 1,
	          h = (1 << s) - 1,
	          f = h >> 1,
	          l = -7,
	          c = r ? i - 1 : 0,
	          u = r ? -1 : 1,
	          d = e[t + c];
	        for (c += u, o = d & (1 << -l) - 1, d >>= -l, l += s; l > 0; o = 256 * o + e[t + c], c += u, l -= 8);
	        for (a = o & (1 << -l) - 1, o >>= -l, l += n; l > 0; a = 256 * a + e[t + c], c += u, l -= 8);
	        if (0 === o) o = 1 - f;else {
	          if (o === h) return a ? NaN : 1 / 0 * (d ? -1 : 1);
	          a += Math.pow(2, n), o -= f;
	        }
	        return (d ? -1 : 1) * a * Math.pow(2, o - n);
	      }
	      function f(e, t, r, n, i, o) {
	        var a,
	          s,
	          h,
	          f = 8 * o - i - 1,
	          l = (1 << f) - 1,
	          c = l >> 1,
	          u = 23 === i ? Math.pow(2, -24) - Math.pow(2, -77) : 0,
	          d = n ? 0 : o - 1,
	          p = n ? 1 : -1,
	          _ = t < 0 || 0 === t && 1 / t < 0 ? 1 : 0;
	        for (t = Math.abs(t), isNaN(t) || t === 1 / 0 ? (s = isNaN(t) ? 1 : 0, a = l) : (a = Math.floor(Math.log(t) / Math.LN2), t * (h = Math.pow(2, -a)) < 1 && (a--, h *= 2), (t += a + c >= 1 ? u / h : u * Math.pow(2, 1 - c)) * h >= 2 && (a++, h /= 2), a + c >= l ? (s = 0, a = l) : a + c >= 1 ? (s = (t * h - 1) * Math.pow(2, i), a += c) : (s = t * Math.pow(2, c - 1) * Math.pow(2, i), a = 0)); i >= 8; e[r + d] = 255 & s, d += p, s /= 256, i -= 8);
	        for (a = a << i | s, f += i; f > 0; e[r + d] = 255 & a, d += p, a /= 256, f -= 8);
	        e[r + d - p] |= 128 * _;
	      }
	      var l = {}.toString,
	        c = Array.isArray || function (e) {
	          return '[object Array]' == l.call(e);
	        };
	      function u() {
	        return p.TYPED_ARRAY_SUPPORT ? 2147483647 : 1073741823;
	      }
	      function d(e, t) {
	        if (u() < t) throw new RangeError('Invalid typed array length');
	        return p.TYPED_ARRAY_SUPPORT ? (e = new Uint8Array(t)).__proto__ = p.prototype : (null === e && (e = new p(t)), e.length = t), e;
	      }
	      function p(e, t, r) {
	        if (!(p.TYPED_ARRAY_SUPPORT || this instanceof p)) return new p(e, t, r);
	        if ('number' == typeof e) {
	          if ('string' == typeof t) throw new Error('If encoding is specified then the first argument must be a string');
	          return v(this, e);
	        }
	        return _(this, e, t, r);
	      }
	      function _(e, t, r, n) {
	        if ('number' == typeof t) throw new TypeError('"value" argument must not be a number');
	        return 'undefined' != typeof ArrayBuffer && t instanceof ArrayBuffer ? function (e, t, r, n) {
	          if (t.byteLength, r < 0 || t.byteLength < r) throw new RangeError("'offset' is out of bounds");
	          if (t.byteLength < r + (n || 0)) throw new RangeError("'length' is out of bounds");
	          t = void 0 === r && void 0 === n ? new Uint8Array(t) : void 0 === n ? new Uint8Array(t, r) : new Uint8Array(t, r, n);
	          p.TYPED_ARRAY_SUPPORT ? (e = t).__proto__ = p.prototype : e = w(e, t);
	          return e;
	        }(e, t, r, n) : 'string' == typeof t ? function (e, t, r) {
	          'string' == typeof r && '' !== r || (r = 'utf8');
	          if (!p.isEncoding(r)) throw new TypeError('"encoding" must be a valid string encoding');
	          var n = 0 | m(t, r),
	            i = (e = d(e, n)).write(t, r);
	          i !== n && (e = e.slice(0, i));
	          return e;
	        }(e, t, r) : function (e, t) {
	          if (y(t)) {
	            var r = 0 | b(t.length);
	            return 0 === (e = d(e, r)).length ? e : (t.copy(e, 0, 0, r), e);
	          }
	          if (t) {
	            if ('undefined' != typeof ArrayBuffer && t.buffer instanceof ArrayBuffer || 'length' in t) return 'number' != typeof t.length || (n = t.length) != n ? d(e, 0) : w(e, t);
	            if ('Buffer' === t.type && c(t.data)) return w(e, t.data);
	          }
	          var n;
	          throw new TypeError('First argument must be a string, Buffer, ArrayBuffer, Array, or array-like object.');
	        }(e, t);
	      }
	      function g(e) {
	        if ('number' != typeof e) throw new TypeError('"size" argument must be a number');
	        if (e < 0) throw new RangeError('"size" argument must not be negative');
	      }
	      function v(e, t) {
	        if (g(t), e = d(e, t < 0 ? 0 : 0 | b(t)), !p.TYPED_ARRAY_SUPPORT) for (var r = 0; r < t; ++r) e[r] = 0;
	        return e;
	      }
	      function w(e, t) {
	        var r = t.length < 0 ? 0 : 0 | b(t.length);
	        e = d(e, r);
	        for (var n = 0; n < r; n += 1) e[n] = 255 & t[n];
	        return e;
	      }
	      function b(e) {
	        if (e >= u()) throw new RangeError('Attempt to allocate Buffer larger than maximum size: 0x' + u().toString(16) + ' bytes');
	        return 0 | e;
	      }
	      function y(e) {
	        return !(null == e || !e._isBuffer);
	      }
	      function m(e, t) {
	        if (y(e)) return e.length;
	        if ('undefined' != typeof ArrayBuffer && 'function' == typeof ArrayBuffer.isView && (ArrayBuffer.isView(e) || e instanceof ArrayBuffer)) return e.byteLength;
	        'string' != typeof e && (e = '' + e);
	        var r = e.length;
	        if (0 === r) return 0;
	        for (var n = !1;;) switch (t) {
	          case 'ascii':
	          case 'latin1':
	          case 'binary':
	            return r;
	          case 'utf8':
	          case 'utf-8':
	          case void 0:
	            return q(e).length;
	          case 'ucs2':
	          case 'ucs-2':
	          case 'utf16le':
	          case 'utf-16le':
	            return 2 * r;
	          case 'hex':
	            return r >>> 1;
	          case 'base64':
	            return V(e).length;
	          default:
	            if (n) return q(e).length;
	            t = ('' + t).toLowerCase(), n = !0;
	        }
	      }
	      function k(e, t, r) {
	        var n = !1;
	        if ((void 0 === t || t < 0) && (t = 0), t > this.length) return '';
	        if ((void 0 === r || r > this.length) && (r = this.length), r <= 0) return '';
	        if ((r >>>= 0) <= (t >>>= 0)) return '';
	        for (e || (e = 'utf8');;) switch (e) {
	          case 'hex':
	            return O(this, t, r);
	          case 'utf8':
	          case 'utf-8':
	            return C(this, t, r);
	          case 'ascii':
	            return I(this, t, r);
	          case 'latin1':
	          case 'binary':
	            return P(this, t, r);
	          case 'base64':
	            return M(this, t, r);
	          case 'ucs2':
	          case 'ucs-2':
	          case 'utf16le':
	          case 'utf-16le':
	            return U(this, t, r);
	          default:
	            if (n) throw new TypeError('Unknown encoding: ' + e);
	            e = (e + '').toLowerCase(), n = !0;
	        }
	      }
	      function E(e, t, r) {
	        var n = e[t];
	        e[t] = e[r], e[r] = n;
	      }
	      function S(e, t, r, n, i) {
	        if (0 === e.length) return -1;
	        if ('string' == typeof r ? (n = r, r = 0) : r > 2147483647 ? r = 2147483647 : r < -2147483648 && (r = -2147483648), r = +r, isNaN(r) && (r = i ? 0 : e.length - 1), r < 0 && (r = e.length + r), r >= e.length) {
	          if (i) return -1;
	          r = e.length - 1;
	        } else if (r < 0) {
	          if (!i) return -1;
	          r = 0;
	        }
	        if ('string' == typeof t && (t = p.from(t, n)), y(t)) return 0 === t.length ? -1 : x(e, t, r, n, i);
	        if ('number' == typeof t) return t &= 255, p.TYPED_ARRAY_SUPPORT && 'function' == typeof Uint8Array.prototype.indexOf ? i ? Uint8Array.prototype.indexOf.call(e, t, r) : Uint8Array.prototype.lastIndexOf.call(e, t, r) : x(e, [t], r, n, i);
	        throw new TypeError('val must be string, number or Buffer');
	      }
	      function x(e, t, r, n, i) {
	        var o,
	          a = 1,
	          s = e.length,
	          h = t.length;
	        if (void 0 !== n && ('ucs2' === (n = String(n).toLowerCase()) || 'ucs-2' === n || 'utf16le' === n || 'utf-16le' === n)) {
	          if (e.length < 2 || t.length < 2) return -1;
	          a = 2, s /= 2, h /= 2, r /= 2;
	        }
	        function f(e, t) {
	          return 1 === a ? e[t] : e.readUInt16BE(t * a);
	        }
	        if (i) {
	          var l = -1;
	          for (o = r; o < s; o++) if (f(e, o) === f(t, -1 === l ? 0 : o - l)) {
	            if (-1 === l && (l = o), o - l + 1 === h) return l * a;
	          } else -1 !== l && (o -= o - l), l = -1;
	        } else for (r + h > s && (r = s - h), o = r; o >= 0; o--) {
	          for (var c = !0, u = 0; u < h; u++) if (f(e, o + u) !== f(t, u)) {
	            c = !1;
	            break;
	          }
	          if (c) return o;
	        }
	        return -1;
	      }
	      function R(e, t, r, n) {
	        r = Number(r) || 0;
	        var i = e.length - r;
	        n ? (n = Number(n)) > i && (n = i) : n = i;
	        var o = t.length;
	        if (o % 2 != 0) throw new TypeError('Invalid hex string');
	        n > o / 2 && (n = o / 2);
	        for (var a = 0; a < n; ++a) {
	          var s = parseInt(t.substr(2 * a, 2), 16);
	          if (isNaN(s)) return a;
	          e[r + a] = s;
	        }
	        return a;
	      }
	      function A(e, t, r, n) {
	        return G(q(t, e.length - r), e, r, n);
	      }
	      function B(e, t, r, n) {
	        return G(function (e) {
	          for (var t = [], r = 0; r < e.length; ++r) t.push(255 & e.charCodeAt(r));
	          return t;
	        }(t), e, r, n);
	      }
	      function z(e, t, r, n) {
	        return B(e, t, r, n);
	      }
	      function L(e, t, r, n) {
	        return G(V(t), e, r, n);
	      }
	      function T(e, t, r, n) {
	        return G(function (e, t) {
	          for (var r, n, i, o = [], a = 0; a < e.length && !((t -= 2) < 0); ++a) r = e.charCodeAt(a), n = r >> 8, i = r % 256, o.push(i), o.push(n);
	          return o;
	        }(t, e.length - r), e, r, n);
	      }
	      function M(e, t, r) {
	        return 0 === t && r === e.length ? s(e) : s(e.slice(t, r));
	      }
	      function C(e, t, r) {
	        r = Math.min(e.length, r);
	        for (var n = [], i = t; i < r;) {
	          var o,
	            a,
	            s,
	            h,
	            f = e[i],
	            l = null,
	            c = f > 239 ? 4 : f > 223 ? 3 : f > 191 ? 2 : 1;
	          if (i + c <= r) switch (c) {
	            case 1:
	              f < 128 && (l = f);
	              break;
	            case 2:
	              128 == (192 & (o = e[i + 1])) && (h = (31 & f) << 6 | 63 & o) > 127 && (l = h);
	              break;
	            case 3:
	              o = e[i + 1], a = e[i + 2], 128 == (192 & o) && 128 == (192 & a) && (h = (15 & f) << 12 | (63 & o) << 6 | 63 & a) > 2047 && (h < 55296 || h > 57343) && (l = h);
	              break;
	            case 4:
	              o = e[i + 1], a = e[i + 2], s = e[i + 3], 128 == (192 & o) && 128 == (192 & a) && 128 == (192 & s) && (h = (15 & f) << 18 | (63 & o) << 12 | (63 & a) << 6 | 63 & s) > 65535 && h < 1114112 && (l = h);
	          }
	          null === l ? (l = 65533, c = 1) : l > 65535 && (l -= 65536, n.push(l >>> 10 & 1023 | 55296), l = 56320 | 1023 & l), n.push(l), i += c;
	        }
	        return function (e) {
	          var t = e.length;
	          if (t <= D) return String.fromCharCode.apply(String, e);
	          var r = '',
	            n = 0;
	          for (; n < t;) r += String.fromCharCode.apply(String, e.slice(n, n += D));
	          return r;
	        }(n);
	      }
	      p.TYPED_ARRAY_SUPPORT = void 0 === e.TYPED_ARRAY_SUPPORT || e.TYPED_ARRAY_SUPPORT, p.poolSize = 8192, p._augment = function (e) {
	        return e.__proto__ = p.prototype, e;
	      }, p.from = function (e, t, r) {
	        return _(null, e, t, r);
	      }, p.TYPED_ARRAY_SUPPORT && (p.prototype.__proto__ = Uint8Array.prototype, p.__proto__ = Uint8Array), p.alloc = function (e, t, r) {
	        return function (e, t, r, n) {
	          return g(t), t <= 0 ? d(e, t) : void 0 !== r ? 'string' == typeof n ? d(e, t).fill(r, n) : d(e, t).fill(r) : d(e, t);
	        }(null, e, t, r);
	      }, p.allocUnsafe = function (e) {
	        return v(null, e);
	      }, p.allocUnsafeSlow = function (e) {
	        return v(null, e);
	      }, p.isBuffer = $, p.compare = function (e, t) {
	        if (!y(e) || !y(t)) throw new TypeError('Arguments must be Buffers');
	        if (e === t) return 0;
	        for (var r = e.length, n = t.length, i = 0, o = Math.min(r, n); i < o; ++i) if (e[i] !== t[i]) {
	          r = e[i], n = t[i];
	          break;
	        }
	        return r < n ? -1 : n < r ? 1 : 0;
	      }, p.isEncoding = function (e) {
	        switch (String(e).toLowerCase()) {
	          case 'hex':
	          case 'utf8':
	          case 'utf-8':
	          case 'ascii':
	          case 'latin1':
	          case 'binary':
	          case 'base64':
	          case 'ucs2':
	          case 'ucs-2':
	          case 'utf16le':
	          case 'utf-16le':
	            return !0;
	          default:
	            return !1;
	        }
	      }, p.concat = function (e, t) {
	        if (!c(e)) throw new TypeError('"list" argument must be an Array of Buffers');
	        if (0 === e.length) return p.alloc(0);
	        var r;
	        if (void 0 === t) for (t = 0, r = 0; r < e.length; ++r) t += e[r].length;
	        var n = p.allocUnsafe(t),
	          i = 0;
	        for (r = 0; r < e.length; ++r) {
	          var o = e[r];
	          if (!y(o)) throw new TypeError('"list" argument must be an Array of Buffers');
	          o.copy(n, i), i += o.length;
	        }
	        return n;
	      }, p.byteLength = m, p.prototype._isBuffer = !0, p.prototype.swap16 = function () {
	        var e = this.length;
	        if (e % 2 != 0) throw new RangeError('Buffer size must be a multiple of 16-bits');
	        for (var t = 0; t < e; t += 2) E(this, t, t + 1);
	        return this;
	      }, p.prototype.swap32 = function () {
	        var e = this.length;
	        if (e % 4 != 0) throw new RangeError('Buffer size must be a multiple of 32-bits');
	        for (var t = 0; t < e; t += 4) E(this, t, t + 3), E(this, t + 1, t + 2);
	        return this;
	      }, p.prototype.swap64 = function () {
	        var e = this.length;
	        if (e % 8 != 0) throw new RangeError('Buffer size must be a multiple of 64-bits');
	        for (var t = 0; t < e; t += 8) E(this, t, t + 7), E(this, t + 1, t + 6), E(this, t + 2, t + 5), E(this, t + 3, t + 4);
	        return this;
	      }, p.prototype.toString = function () {
	        var e = 0 | this.length;
	        return 0 === e ? '' : 0 === arguments.length ? C(this, 0, e) : k.apply(this, arguments);
	      }, p.prototype.equals = function (e) {
	        if (!y(e)) throw new TypeError('Argument must be a Buffer');
	        return this === e || 0 === p.compare(this, e);
	      }, p.prototype.inspect = function () {
	        var e = '';
	        return this.length > 0 && (e = this.toString('hex', 0, 50).match(/.{2}/g).join(' '), this.length > 50 && (e += ' ... ')), '<Buffer ' + e + '>';
	      }, p.prototype.compare = function (e, t, r, n, i) {
	        if (!y(e)) throw new TypeError('Argument must be a Buffer');
	        if (void 0 === t && (t = 0), void 0 === r && (r = e ? e.length : 0), void 0 === n && (n = 0), void 0 === i && (i = this.length), t < 0 || r > e.length || n < 0 || i > this.length) throw new RangeError('out of range index');
	        if (n >= i && t >= r) return 0;
	        if (n >= i) return -1;
	        if (t >= r) return 1;
	        if (this === e) return 0;
	        for (var o = (i >>>= 0) - (n >>>= 0), a = (r >>>= 0) - (t >>>= 0), s = Math.min(o, a), h = this.slice(n, i), f = e.slice(t, r), l = 0; l < s; ++l) if (h[l] !== f[l]) {
	          o = h[l], a = f[l];
	          break;
	        }
	        return o < a ? -1 : a < o ? 1 : 0;
	      }, p.prototype.includes = function (e, t, r) {
	        return -1 !== this.indexOf(e, t, r);
	      }, p.prototype.indexOf = function (e, t, r) {
	        return S(this, e, t, r, !0);
	      }, p.prototype.lastIndexOf = function (e, t, r) {
	        return S(this, e, t, r, !1);
	      }, p.prototype.write = function (e, t, r, n) {
	        if (void 0 === t) n = 'utf8', r = this.length, t = 0;else if (void 0 === r && 'string' == typeof t) n = t, r = this.length, t = 0;else {
	          if (!isFinite(t)) throw new Error('Buffer.write(string, encoding, offset[, length]) is no longer supported');
	          t |= 0, isFinite(r) ? (r |= 0, void 0 === n && (n = 'utf8')) : (n = r, r = void 0);
	        }
	        var i = this.length - t;
	        if ((void 0 === r || r > i) && (r = i), e.length > 0 && (r < 0 || t < 0) || t > this.length) throw new RangeError('Attempt to write outside buffer bounds');
	        n || (n = 'utf8');
	        for (var o = !1;;) switch (n) {
	          case 'hex':
	            return R(this, e, t, r);
	          case 'utf8':
	          case 'utf-8':
	            return A(this, e, t, r);
	          case 'ascii':
	            return B(this, e, t, r);
	          case 'latin1':
	          case 'binary':
	            return z(this, e, t, r);
	          case 'base64':
	            return L(this, e, t, r);
	          case 'ucs2':
	          case 'ucs-2':
	          case 'utf16le':
	          case 'utf-16le':
	            return T(this, e, t, r);
	          default:
	            if (o) throw new TypeError('Unknown encoding: ' + n);
	            n = ('' + n).toLowerCase(), o = !0;
	        }
	      }, p.prototype.toJSON = function () {
	        return {
	          type: 'Buffer',
	          data: Array.prototype.slice.call(this._arr || this, 0)
	        };
	      };
	      var D = 4096;
	      function I(e, t, r) {
	        var n = '';
	        r = Math.min(e.length, r);
	        for (var i = t; i < r; ++i) n += String.fromCharCode(127 & e[i]);
	        return n;
	      }
	      function P(e, t, r) {
	        var n = '';
	        r = Math.min(e.length, r);
	        for (var i = t; i < r; ++i) n += String.fromCharCode(e[i]);
	        return n;
	      }
	      function O(e, t, r) {
	        var n = e.length;
	        (!t || t < 0) && (t = 0), (!r || r < 0 || r > n) && (r = n);
	        for (var i = '', o = t; o < r; ++o) i += X(e[o]);
	        return i;
	      }
	      function U(e, t, r) {
	        for (var n = e.slice(t, r), i = '', o = 0; o < n.length; o += 2) i += String.fromCharCode(n[o] + 256 * n[o + 1]);
	        return i;
	      }
	      function H(e, t, r) {
	        if (e % 1 != 0 || e < 0) throw new RangeError('offset is not uint');
	        if (e + t > r) throw new RangeError('Trying to access beyond buffer length');
	      }
	      function F(e, t, r, n, i, o) {
	        if (!y(e)) throw new TypeError('"buffer" argument must be a Buffer instance');
	        if (t > i || t < o) throw new RangeError('"value" argument is out of bounds');
	        if (r + n > e.length) throw new RangeError('Index out of range');
	      }
	      function N(e, t, r, n) {
	        t < 0 && (t = 65535 + t + 1);
	        for (var i = 0, o = Math.min(e.length - r, 2); i < o; ++i) e[r + i] = (t & 255 << 8 * (n ? i : 1 - i)) >>> 8 * (n ? i : 1 - i);
	      }
	      function Z(e, t, r, n) {
	        t < 0 && (t = 4294967295 + t + 1);
	        for (var i = 0, o = Math.min(e.length - r, 4); i < o; ++i) e[r + i] = t >>> 8 * (n ? i : 3 - i) & 255;
	      }
	      function j(e, t, r, n, i, o) {
	        if (r + n > e.length) throw new RangeError('Index out of range');
	        if (r < 0) throw new RangeError('Index out of range');
	      }
	      function W(e, t, r, n, i) {
	        return i || j(e, 0, r, 4), f(e, t, r, n, 23, 4), r + 4;
	      }
	      function Y(e, t, r, n, i) {
	        return i || j(e, 0, r, 8), f(e, t, r, n, 52, 8), r + 8;
	      }
	      p.prototype.slice = function (e, t) {
	        var r,
	          n = this.length;
	        if ((e = ~~e) < 0 ? (e += n) < 0 && (e = 0) : e > n && (e = n), (t = void 0 === t ? n : ~~t) < 0 ? (t += n) < 0 && (t = 0) : t > n && (t = n), t < e && (t = e), p.TYPED_ARRAY_SUPPORT) (r = this.subarray(e, t)).__proto__ = p.prototype;else {
	          var i = t - e;
	          r = new p(i, void 0);
	          for (var o = 0; o < i; ++o) r[o] = this[o + e];
	        }
	        return r;
	      }, p.prototype.readUIntLE = function (e, t, r) {
	        e |= 0, t |= 0, r || H(e, t, this.length);
	        for (var n = this[e], i = 1, o = 0; ++o < t && (i *= 256);) n += this[e + o] * i;
	        return n;
	      }, p.prototype.readUIntBE = function (e, t, r) {
	        e |= 0, t |= 0, r || H(e, t, this.length);
	        for (var n = this[e + --t], i = 1; t > 0 && (i *= 256);) n += this[e + --t] * i;
	        return n;
	      }, p.prototype.readUInt8 = function (e, t) {
	        return t || H(e, 1, this.length), this[e];
	      }, p.prototype.readUInt16LE = function (e, t) {
	        return t || H(e, 2, this.length), this[e] | this[e + 1] << 8;
	      }, p.prototype.readUInt16BE = function (e, t) {
	        return t || H(e, 2, this.length), this[e] << 8 | this[e + 1];
	      }, p.prototype.readUInt32LE = function (e, t) {
	        return t || H(e, 4, this.length), (this[e] | this[e + 1] << 8 | this[e + 2] << 16) + 16777216 * this[e + 3];
	      }, p.prototype.readUInt32BE = function (e, t) {
	        return t || H(e, 4, this.length), 16777216 * this[e] + (this[e + 1] << 16 | this[e + 2] << 8 | this[e + 3]);
	      }, p.prototype.readIntLE = function (e, t, r) {
	        e |= 0, t |= 0, r || H(e, t, this.length);
	        for (var n = this[e], i = 1, o = 0; ++o < t && (i *= 256);) n += this[e + o] * i;
	        return n >= (i *= 128) && (n -= Math.pow(2, 8 * t)), n;
	      }, p.prototype.readIntBE = function (e, t, r) {
	        e |= 0, t |= 0, r || H(e, t, this.length);
	        for (var n = t, i = 1, o = this[e + --n]; n > 0 && (i *= 256);) o += this[e + --n] * i;
	        return o >= (i *= 128) && (o -= Math.pow(2, 8 * t)), o;
	      }, p.prototype.readInt8 = function (e, t) {
	        return t || H(e, 1, this.length), 128 & this[e] ? -1 * (255 - this[e] + 1) : this[e];
	      }, p.prototype.readInt16LE = function (e, t) {
	        t || H(e, 2, this.length);
	        var r = this[e] | this[e + 1] << 8;
	        return 32768 & r ? 4294901760 | r : r;
	      }, p.prototype.readInt16BE = function (e, t) {
	        t || H(e, 2, this.length);
	        var r = this[e + 1] | this[e] << 8;
	        return 32768 & r ? 4294901760 | r : r;
	      }, p.prototype.readInt32LE = function (e, t) {
	        return t || H(e, 4, this.length), this[e] | this[e + 1] << 8 | this[e + 2] << 16 | this[e + 3] << 24;
	      }, p.prototype.readInt32BE = function (e, t) {
	        return t || H(e, 4, this.length), this[e] << 24 | this[e + 1] << 16 | this[e + 2] << 8 | this[e + 3];
	      }, p.prototype.readFloatLE = function (e, t) {
	        return t || H(e, 4, this.length), h(this, e, !0, 23, 4);
	      }, p.prototype.readFloatBE = function (e, t) {
	        return t || H(e, 4, this.length), h(this, e, !1, 23, 4);
	      }, p.prototype.readDoubleLE = function (e, t) {
	        return t || H(e, 8, this.length), h(this, e, !0, 52, 8);
	      }, p.prototype.readDoubleBE = function (e, t) {
	        return t || H(e, 8, this.length), h(this, e, !1, 52, 8);
	      }, p.prototype.writeUIntLE = function (e, t, r, n) {
	        (e = +e, t |= 0, r |= 0, n) || F(this, e, t, r, Math.pow(2, 8 * r) - 1, 0);
	        var i = 1,
	          o = 0;
	        for (this[t] = 255 & e; ++o < r && (i *= 256);) this[t + o] = e / i & 255;
	        return t + r;
	      }, p.prototype.writeUIntBE = function (e, t, r, n) {
	        (e = +e, t |= 0, r |= 0, n) || F(this, e, t, r, Math.pow(2, 8 * r) - 1, 0);
	        var i = r - 1,
	          o = 1;
	        for (this[t + i] = 255 & e; --i >= 0 && (o *= 256);) this[t + i] = e / o & 255;
	        return t + r;
	      }, p.prototype.writeUInt8 = function (e, t, r) {
	        return e = +e, t |= 0, r || F(this, e, t, 1, 255, 0), p.TYPED_ARRAY_SUPPORT || (e = Math.floor(e)), this[t] = 255 & e, t + 1;
	      }, p.prototype.writeUInt16LE = function (e, t, r) {
	        return e = +e, t |= 0, r || F(this, e, t, 2, 65535, 0), p.TYPED_ARRAY_SUPPORT ? (this[t] = 255 & e, this[t + 1] = e >>> 8) : N(this, e, t, !0), t + 2;
	      }, p.prototype.writeUInt16BE = function (e, t, r) {
	        return e = +e, t |= 0, r || F(this, e, t, 2, 65535, 0), p.TYPED_ARRAY_SUPPORT ? (this[t] = e >>> 8, this[t + 1] = 255 & e) : N(this, e, t, !1), t + 2;
	      }, p.prototype.writeUInt32LE = function (e, t, r) {
	        return e = +e, t |= 0, r || F(this, e, t, 4, 4294967295, 0), p.TYPED_ARRAY_SUPPORT ? (this[t + 3] = e >>> 24, this[t + 2] = e >>> 16, this[t + 1] = e >>> 8, this[t] = 255 & e) : Z(this, e, t, !0), t + 4;
	      }, p.prototype.writeUInt32BE = function (e, t, r) {
	        return e = +e, t |= 0, r || F(this, e, t, 4, 4294967295, 0), p.TYPED_ARRAY_SUPPORT ? (this[t] = e >>> 24, this[t + 1] = e >>> 16, this[t + 2] = e >>> 8, this[t + 3] = 255 & e) : Z(this, e, t, !1), t + 4;
	      }, p.prototype.writeIntLE = function (e, t, r, n) {
	        if (e = +e, t |= 0, !n) {
	          var i = Math.pow(2, 8 * r - 1);
	          F(this, e, t, r, i - 1, -i);
	        }
	        var o = 0,
	          a = 1,
	          s = 0;
	        for (this[t] = 255 & e; ++o < r && (a *= 256);) e < 0 && 0 === s && 0 !== this[t + o - 1] && (s = 1), this[t + o] = (e / a >> 0) - s & 255;
	        return t + r;
	      }, p.prototype.writeIntBE = function (e, t, r, n) {
	        if (e = +e, t |= 0, !n) {
	          var i = Math.pow(2, 8 * r - 1);
	          F(this, e, t, r, i - 1, -i);
	        }
	        var o = r - 1,
	          a = 1,
	          s = 0;
	        for (this[t + o] = 255 & e; --o >= 0 && (a *= 256);) e < 0 && 0 === s && 0 !== this[t + o + 1] && (s = 1), this[t + o] = (e / a >> 0) - s & 255;
	        return t + r;
	      }, p.prototype.writeInt8 = function (e, t, r) {
	        return e = +e, t |= 0, r || F(this, e, t, 1, 127, -128), p.TYPED_ARRAY_SUPPORT || (e = Math.floor(e)), e < 0 && (e = 255 + e + 1), this[t] = 255 & e, t + 1;
	      }, p.prototype.writeInt16LE = function (e, t, r) {
	        return e = +e, t |= 0, r || F(this, e, t, 2, 32767, -32768), p.TYPED_ARRAY_SUPPORT ? (this[t] = 255 & e, this[t + 1] = e >>> 8) : N(this, e, t, !0), t + 2;
	      }, p.prototype.writeInt16BE = function (e, t, r) {
	        return e = +e, t |= 0, r || F(this, e, t, 2, 32767, -32768), p.TYPED_ARRAY_SUPPORT ? (this[t] = e >>> 8, this[t + 1] = 255 & e) : N(this, e, t, !1), t + 2;
	      }, p.prototype.writeInt32LE = function (e, t, r) {
	        return e = +e, t |= 0, r || F(this, e, t, 4, 2147483647, -2147483648), p.TYPED_ARRAY_SUPPORT ? (this[t] = 255 & e, this[t + 1] = e >>> 8, this[t + 2] = e >>> 16, this[t + 3] = e >>> 24) : Z(this, e, t, !0), t + 4;
	      }, p.prototype.writeInt32BE = function (e, t, r) {
	        return e = +e, t |= 0, r || F(this, e, t, 4, 2147483647, -2147483648), e < 0 && (e = 4294967295 + e + 1), p.TYPED_ARRAY_SUPPORT ? (this[t] = e >>> 24, this[t + 1] = e >>> 16, this[t + 2] = e >>> 8, this[t + 3] = 255 & e) : Z(this, e, t, !1), t + 4;
	      }, p.prototype.writeFloatLE = function (e, t, r) {
	        return W(this, e, t, !0, r);
	      }, p.prototype.writeFloatBE = function (e, t, r) {
	        return W(this, e, t, !1, r);
	      }, p.prototype.writeDoubleLE = function (e, t, r) {
	        return Y(this, e, t, !0, r);
	      }, p.prototype.writeDoubleBE = function (e, t, r) {
	        return Y(this, e, t, !1, r);
	      }, p.prototype.copy = function (e, t, r, n) {
	        if (r || (r = 0), n || 0 === n || (n = this.length), t >= e.length && (t = e.length), t || (t = 0), n > 0 && n < r && (n = r), n === r) return 0;
	        if (0 === e.length || 0 === this.length) return 0;
	        if (t < 0) throw new RangeError('targetStart out of bounds');
	        if (r < 0 || r >= this.length) throw new RangeError('sourceStart out of bounds');
	        if (n < 0) throw new RangeError('sourceEnd out of bounds');
	        n > this.length && (n = this.length), e.length - t < n - r && (n = e.length - t + r);
	        var i,
	          o = n - r;
	        if (this === e && r < t && t < n) for (i = o - 1; i >= 0; --i) e[i + t] = this[i + r];else if (o < 1e3 || !p.TYPED_ARRAY_SUPPORT) for (i = 0; i < o; ++i) e[i + t] = this[i + r];else Uint8Array.prototype.set.call(e, this.subarray(r, r + o), t);
	        return o;
	      }, p.prototype.fill = function (e, t, r, n) {
	        if ('string' == typeof e) {
	          if ('string' == typeof t ? (n = t, t = 0, r = this.length) : 'string' == typeof r && (n = r, r = this.length), 1 === e.length) {
	            var i = e.charCodeAt(0);
	            i < 256 && (e = i);
	          }
	          if (void 0 !== n && 'string' != typeof n) throw new TypeError('encoding must be a string');
	          if ('string' == typeof n && !p.isEncoding(n)) throw new TypeError('Unknown encoding: ' + n);
	        } else 'number' == typeof e && (e &= 255);
	        if (t < 0 || this.length < t || this.length < r) throw new RangeError('Out of range index');
	        if (r <= t) return this;
	        var o;
	        if (t >>>= 0, r = void 0 === r ? this.length : r >>> 0, e || (e = 0), 'number' == typeof e) for (o = t; o < r; ++o) this[o] = e;else {
	          var a = y(e) ? e : q(new p(e, n).toString()),
	            s = a.length;
	          for (o = 0; o < r - t; ++o) this[o + t] = a[o % s];
	        }
	        return this;
	      };
	      var K = /[^+\/0-9A-Za-z-_]/g;
	      function X(e) {
	        return e < 16 ? '0' + e.toString(16) : e.toString(16);
	      }
	      function q(e, t) {
	        var r;
	        t = t || 1 / 0;
	        for (var n = e.length, i = null, o = [], a = 0; a < n; ++a) {
	          if ((r = e.charCodeAt(a)) > 55295 && r < 57344) {
	            if (!i) {
	              if (r > 56319) {
	                (t -= 3) > -1 && o.push(239, 191, 189);
	                continue;
	              }
	              if (a + 1 === n) {
	                (t -= 3) > -1 && o.push(239, 191, 189);
	                continue;
	              }
	              i = r;
	              continue;
	            }
	            if (r < 56320) {
	              (t -= 3) > -1 && o.push(239, 191, 189), i = r;
	              continue;
	            }
	            r = 65536 + (i - 55296 << 10 | r - 56320);
	          } else i && (t -= 3) > -1 && o.push(239, 191, 189);
	          if (i = null, r < 128) {
	            if ((t -= 1) < 0) break;
	            o.push(r);
	          } else if (r < 2048) {
	            if ((t -= 2) < 0) break;
	            o.push(r >> 6 | 192, 63 & r | 128);
	          } else if (r < 65536) {
	            if ((t -= 3) < 0) break;
	            o.push(r >> 12 | 224, r >> 6 & 63 | 128, 63 & r | 128);
	          } else {
	            if (!(r < 1114112)) throw new Error('Invalid code point');
	            if ((t -= 4) < 0) break;
	            o.push(r >> 18 | 240, r >> 12 & 63 | 128, r >> 6 & 63 | 128, 63 & r | 128);
	          }
	        }
	        return o;
	      }
	      function V(e) {
	        return function (e) {
	          var t, a, s, h, f, l;
	          i || o();
	          var c = e.length;
	          if (c % 4 > 0) throw new Error('Invalid string. Length must be a multiple of 4');
	          f = '=' === e[c - 2] ? 2 : '=' === e[c - 1] ? 1 : 0, l = new n(3 * c / 4 - f), s = f > 0 ? c - 4 : c;
	          var u = 0;
	          for (t = 0, a = 0; t < s; t += 4, a += 3) h = r[e.charCodeAt(t)] << 18 | r[e.charCodeAt(t + 1)] << 12 | r[e.charCodeAt(t + 2)] << 6 | r[e.charCodeAt(t + 3)], l[u++] = h >> 16 & 255, l[u++] = h >> 8 & 255, l[u++] = 255 & h;
	          return 2 === f ? (h = r[e.charCodeAt(t)] << 2 | r[e.charCodeAt(t + 1)] >> 4, l[u++] = 255 & h) : 1 === f && (h = r[e.charCodeAt(t)] << 10 | r[e.charCodeAt(t + 1)] << 4 | r[e.charCodeAt(t + 2)] >> 2, l[u++] = h >> 8 & 255, l[u++] = 255 & h), l;
	        }(function (e) {
	          if ((e = function (e) {
	            return e.trim ? e.trim() : e.replace(/^\s+|\s+$/g, '');
	          }(e).replace(K, '')).length < 2) return '';
	          for (; e.length % 4 != 0;) e += '=';
	          return e;
	        }(e));
	      }
	      function G(e, t, r, n) {
	        for (var i = 0; i < n && !(i + r >= t.length || i >= e.length); ++i) t[i + r] = e[i];
	        return i;
	      }
	      function $(e) {
	        return null != e && (!!e._isBuffer || J(e) || function (e) {
	          return 'function' == typeof e.readFloatLE && 'function' == typeof e.slice && J(e.slice(0, 0));
	        }(e));
	      }
	      function J(e) {
	        return !!e.constructor && 'function' == typeof e.constructor.isBuffer && e.constructor.isBuffer(e);
	      }
	      function Q(e, t) {
	        return e(t = {
	          exports: {}
	        }, t.exports), t.exports;
	      }
	      var ee = Q(function (e, t) {
	          var r;
	          e.exports = (r = r || function (e, t) {
	            var r = Object.create || function () {
	                function e() {}
	                return function (t) {
	                  var r;
	                  return e.prototype = t, r = new e(), e.prototype = null, r;
	                };
	              }(),
	              n = {},
	              i = n.lib = {},
	              o = i.Base = {
	                extend: function extend(e) {
	                  var t = r(this);
	                  return e && t.mixIn(e), t.hasOwnProperty('init') && this.init !== t.init || (t.init = function () {
	                    t.$super.init.apply(this, arguments);
	                  }), t.init.prototype = t, t.$super = this, t;
	                },
	                create: function create() {
	                  var e = this.extend();
	                  return e.init.apply(e, arguments), e;
	                },
	                init: function init() {},
	                mixIn: function mixIn(e) {
	                  for (var t in e) e.hasOwnProperty(t) && (this[t] = e[t]);
	                  e.hasOwnProperty('toString') && (this.toString = e.toString);
	                },
	                clone: function clone() {
	                  return this.init.prototype.extend(this);
	                }
	              },
	              a = i.WordArray = o.extend({
	                init: function init(e, t) {
	                  e = this.words = e || [], this.sigBytes = null != t ? t : 4 * e.length;
	                },
	                toString: function toString(e) {
	                  return (e || h).stringify(this);
	                },
	                concat: function concat(e) {
	                  var t = this.words,
	                    r = e.words,
	                    n = this.sigBytes,
	                    i = e.sigBytes;
	                  if (this.clamp(), n % 4) for (var o = 0; o < i; o++) {
	                    var a = r[o >>> 2] >>> 24 - o % 4 * 8 & 255;
	                    t[n + o >>> 2] |= a << 24 - (n + o) % 4 * 8;
	                  } else for (var o = 0; o < i; o += 4) t[n + o >>> 2] = r[o >>> 2];
	                  return this.sigBytes += i, this;
	                },
	                clamp: function clamp() {
	                  var t = this.words,
	                    r = this.sigBytes;
	                  t[r >>> 2] &= 4294967295 << 32 - r % 4 * 8, t.length = e.ceil(r / 4);
	                },
	                clone: function clone() {
	                  var e = o.clone.call(this);
	                  return e.words = this.words.slice(0), e;
	                },
	                random: function random(t) {
	                  for (var r, n = [], i = function i(t) {
	                      var t = t,
	                        r = 987654321,
	                        n = 4294967295;
	                      return function () {
	                        var i = ((r = 36969 * (65535 & r) + (r >> 16) & n) << 16) + (t = 18e3 * (65535 & t) + (t >> 16) & n) & n;
	                        return i /= 4294967296, (i += 0.5) * (e.random() > 0.5 ? 1 : -1);
	                      };
	                    }, o = 0; o < t; o += 4) {
	                    var s = i(4294967296 * (r || e.random()));
	                    r = 987654071 * s(), n.push(4294967296 * s() | 0);
	                  }
	                  return new a.init(n, t);
	                }
	              }),
	              s = n.enc = {},
	              h = s.Hex = {
	                stringify: function stringify(e) {
	                  for (var t = e.words, r = e.sigBytes, n = [], i = 0; i < r; i++) {
	                    var o = t[i >>> 2] >>> 24 - i % 4 * 8 & 255;
	                    n.push((o >>> 4).toString(16)), n.push((15 & o).toString(16));
	                  }
	                  return n.join('');
	                },
	                parse: function parse(e) {
	                  for (var t = e.length, r = [], n = 0; n < t; n += 2) r[n >>> 3] |= parseInt(e.substr(n, 2), 16) << 24 - n % 8 * 4;
	                  return new a.init(r, t / 2);
	                }
	              },
	              f = s.Latin1 = {
	                stringify: function stringify(e) {
	                  for (var t = e.words, r = e.sigBytes, n = [], i = 0; i < r; i++) {
	                    var o = t[i >>> 2] >>> 24 - i % 4 * 8 & 255;
	                    n.push(String.fromCharCode(o));
	                  }
	                  return n.join('');
	                },
	                parse: function parse(e) {
	                  for (var t = e.length, r = [], n = 0; n < t; n++) r[n >>> 2] |= (255 & e.charCodeAt(n)) << 24 - n % 4 * 8;
	                  return new a.init(r, t);
	                }
	              },
	              l = s.Utf8 = {
	                stringify: function stringify(e) {
	                  try {
	                    return decodeURIComponent(escape(f.stringify(e)));
	                  } catch (e) {
	                    throw new Error('Malformed UTF-8 data');
	                  }
	                },
	                parse: function parse(e) {
	                  return f.parse(unescape(encodeURIComponent(e)));
	                }
	              },
	              c = i.BufferedBlockAlgorithm = o.extend({
	                reset: function reset() {
	                  this._data = new a.init(), this._nDataBytes = 0;
	                },
	                _append: function _append(e) {
	                  'string' == typeof e && (e = l.parse(e)), this._data.concat(e), this._nDataBytes += e.sigBytes;
	                },
	                _process: function _process(t) {
	                  var r = this._data,
	                    n = r.words,
	                    i = r.sigBytes,
	                    o = this.blockSize,
	                    s = 4 * o,
	                    h = i / s,
	                    f = (h = t ? e.ceil(h) : e.max((0 | h) - this._minBufferSize, 0)) * o,
	                    l = e.min(4 * f, i);
	                  if (f) {
	                    for (var c = 0; c < f; c += o) this._doProcessBlock(n, c);
	                    var u = n.splice(0, f);
	                    r.sigBytes -= l;
	                  }
	                  return new a.init(u, l);
	                },
	                clone: function clone() {
	                  var e = o.clone.call(this);
	                  return e._data = this._data.clone(), e;
	                },
	                _minBufferSize: 0
	              }),
	              u = (i.Hasher = c.extend({
	                cfg: o.extend(),
	                init: function init(e) {
	                  this.cfg = this.cfg.extend(e), this.reset();
	                },
	                reset: function reset() {
	                  c.reset.call(this), this._doReset();
	                },
	                update: function update(e) {
	                  return this._append(e), this._process(), this;
	                },
	                finalize: function finalize(e) {
	                  e && this._append(e);
	                  var t = this._doFinalize();
	                  return t;
	                },
	                blockSize: 16,
	                _createHelper: function _createHelper(e) {
	                  return function (t, r) {
	                    return new e.init(r).finalize(t);
	                  };
	                },
	                _createHmacHelper: function _createHmacHelper(e) {
	                  return function (t, r) {
	                    return new u.HMAC.init(e, r).finalize(t);
	                  };
	                }
	              }), n.algo = {});
	            return n;
	          }(Math), r);
	        }),
	        te = (Q(function (e, t) {
	          var r, n, i, o, a, s;
	          e.exports = (i = (n = r = ee).lib, o = i.Base, a = i.WordArray, (s = n.x64 = {}).Word = o.extend({
	            init: function init(e, t) {
	              this.high = e, this.low = t;
	            }
	          }), s.WordArray = o.extend({
	            init: function init(e, t) {
	              e = this.words = e || [], this.sigBytes = null != t ? t : 8 * e.length;
	            },
	            toX32: function toX32() {
	              for (var e = this.words, t = e.length, r = [], n = 0; n < t; n++) {
	                var i = e[n];
	                r.push(i.high), r.push(i.low);
	              }
	              return a.create(r, this.sigBytes);
	            },
	            clone: function clone() {
	              for (var e = o.clone.call(this), t = e.words = this.words.slice(0), r = t.length, n = 0; n < r; n++) t[n] = t[n].clone();
	              return e;
	            }
	          }), r);
	        }), Q(function (e, t) {
	          var r;
	          e.exports = (r = ee, function () {
	            if ('function' == typeof ArrayBuffer) {
	              var e = r.lib.WordArray,
	                t = e.init;
	              (e.init = function (e) {
	                if (e instanceof ArrayBuffer && (e = new Uint8Array(e)), (e instanceof Int8Array || 'undefined' != typeof Uint8ClampedArray && e instanceof Uint8ClampedArray || e instanceof Int16Array || e instanceof Uint16Array || e instanceof Int32Array || e instanceof Uint32Array || e instanceof Float32Array || e instanceof Float64Array) && (e = new Uint8Array(e.buffer, e.byteOffset, e.byteLength)), e instanceof Uint8Array) {
	                  for (var r = e.byteLength, n = [], i = 0; i < r; i++) n[i >>> 2] |= e[i] << 24 - i % 4 * 8;
	                  t.call(this, n, r);
	                } else t.apply(this, arguments);
	              }).prototype = e;
	            }
	          }(), r.lib.WordArray);
	        }), Q(function (e, t) {
	          var r;
	          e.exports = (r = ee, function () {
	            var e = r,
	              t = e.lib.WordArray,
	              n = e.enc;
	            function i(e) {
	              return e << 8 & 4278255360 | e >>> 8 & 16711935;
	            }
	            n.Utf16 = n.Utf16BE = {
	              stringify: function stringify(e) {
	                for (var t = e.words, r = e.sigBytes, n = [], i = 0; i < r; i += 2) {
	                  var o = t[i >>> 2] >>> 16 - i % 4 * 8 & 65535;
	                  n.push(String.fromCharCode(o));
	                }
	                return n.join('');
	              },
	              parse: function parse(e) {
	                for (var r = e.length, n = [], i = 0; i < r; i++) n[i >>> 1] |= e.charCodeAt(i) << 16 - i % 2 * 16;
	                return t.create(n, 2 * r);
	              }
	            }, n.Utf16LE = {
	              stringify: function stringify(e) {
	                for (var t = e.words, r = e.sigBytes, n = [], o = 0; o < r; o += 2) {
	                  var a = i(t[o >>> 2] >>> 16 - o % 4 * 8 & 65535);
	                  n.push(String.fromCharCode(a));
	                }
	                return n.join('');
	              },
	              parse: function parse(e) {
	                for (var r = e.length, n = [], o = 0; o < r; o++) n[o >>> 1] |= i(e.charCodeAt(o) << 16 - o % 2 * 16);
	                return t.create(n, 2 * r);
	              }
	            };
	          }(), r.enc.Utf16);
	        }), Q(function (e, t) {
	          var r, n, i;
	          e.exports = (i = (n = r = ee).lib.WordArray, n.enc.Base64 = {
	            stringify: function stringify(e) {
	              var t = e.words,
	                r = e.sigBytes,
	                n = this._map;
	              e.clamp();
	              for (var i = [], o = 0; o < r; o += 3) for (var a = (t[o >>> 2] >>> 24 - o % 4 * 8 & 255) << 16 | (t[o + 1 >>> 2] >>> 24 - (o + 1) % 4 * 8 & 255) << 8 | t[o + 2 >>> 2] >>> 24 - (o + 2) % 4 * 8 & 255, s = 0; s < 4 && o + 0.75 * s < r; s++) i.push(n.charAt(a >>> 6 * (3 - s) & 63));
	              var h = n.charAt(64);
	              if (h) for (; i.length % 4;) i.push(h);
	              return i.join('');
	            },
	            parse: function parse(e) {
	              var t = e.length,
	                r = this._map,
	                n = this._reverseMap;
	              if (!n) {
	                n = this._reverseMap = [];
	                for (var o = 0; o < r.length; o++) n[r.charCodeAt(o)] = o;
	              }
	              var a = r.charAt(64);
	              if (a) {
	                var s = e.indexOf(a);
	                -1 !== s && (t = s);
	              }
	              return function (e, t, r) {
	                for (var n = [], o = 0, a = 0; a < t; a++) if (a % 4) {
	                  var s = r[e.charCodeAt(a - 1)] << a % 4 * 2,
	                    h = r[e.charCodeAt(a)] >>> 6 - a % 4 * 2;
	                  n[o >>> 2] |= (s | h) << 24 - o % 4 * 8, o++;
	                }
	                return i.create(n, o);
	              }(e, t, n);
	            },
	            _map: 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/='
	          }, r.enc.Base64);
	        }), Q(function (e, t) {
	          var r;
	          e.exports = (r = ee, function (e) {
	            var t = r,
	              n = t.lib,
	              i = n.WordArray,
	              o = n.Hasher,
	              a = t.algo,
	              s = [];
	            !function () {
	              for (var t = 0; t < 64; t++) s[t] = 4294967296 * e.abs(e.sin(t + 1)) | 0;
	            }();
	            var h = a.MD5 = o.extend({
	              _doReset: function _doReset() {
	                this._hash = new i.init([1732584193, 4023233417, 2562383102, 271733878]);
	              },
	              _doProcessBlock: function _doProcessBlock(e, t) {
	                for (var r = 0; r < 16; r++) {
	                  var n = t + r,
	                    i = e[n];
	                  e[n] = 16711935 & (i << 8 | i >>> 24) | 4278255360 & (i << 24 | i >>> 8);
	                }
	                var o = this._hash.words,
	                  a = e[t + 0],
	                  h = e[t + 1],
	                  d = e[t + 2],
	                  p = e[t + 3],
	                  _ = e[t + 4],
	                  g = e[t + 5],
	                  v = e[t + 6],
	                  w = e[t + 7],
	                  b = e[t + 8],
	                  y = e[t + 9],
	                  m = e[t + 10],
	                  k = e[t + 11],
	                  E = e[t + 12],
	                  S = e[t + 13],
	                  x = e[t + 14],
	                  R = e[t + 15],
	                  A = o[0],
	                  B = o[1],
	                  z = o[2],
	                  L = o[3];
	                A = f(A, B, z, L, a, 7, s[0]), L = f(L, A, B, z, h, 12, s[1]), z = f(z, L, A, B, d, 17, s[2]), B = f(B, z, L, A, p, 22, s[3]), A = f(A, B, z, L, _, 7, s[4]), L = f(L, A, B, z, g, 12, s[5]), z = f(z, L, A, B, v, 17, s[6]), B = f(B, z, L, A, w, 22, s[7]), A = f(A, B, z, L, b, 7, s[8]), L = f(L, A, B, z, y, 12, s[9]), z = f(z, L, A, B, m, 17, s[10]), B = f(B, z, L, A, k, 22, s[11]), A = f(A, B, z, L, E, 7, s[12]), L = f(L, A, B, z, S, 12, s[13]), z = f(z, L, A, B, x, 17, s[14]), A = l(A, B = f(B, z, L, A, R, 22, s[15]), z, L, h, 5, s[16]), L = l(L, A, B, z, v, 9, s[17]), z = l(z, L, A, B, k, 14, s[18]), B = l(B, z, L, A, a, 20, s[19]), A = l(A, B, z, L, g, 5, s[20]), L = l(L, A, B, z, m, 9, s[21]), z = l(z, L, A, B, R, 14, s[22]), B = l(B, z, L, A, _, 20, s[23]), A = l(A, B, z, L, y, 5, s[24]), L = l(L, A, B, z, x, 9, s[25]), z = l(z, L, A, B, p, 14, s[26]), B = l(B, z, L, A, b, 20, s[27]), A = l(A, B, z, L, S, 5, s[28]), L = l(L, A, B, z, d, 9, s[29]), z = l(z, L, A, B, w, 14, s[30]), A = c(A, B = l(B, z, L, A, E, 20, s[31]), z, L, g, 4, s[32]), L = c(L, A, B, z, b, 11, s[33]), z = c(z, L, A, B, k, 16, s[34]), B = c(B, z, L, A, x, 23, s[35]), A = c(A, B, z, L, h, 4, s[36]), L = c(L, A, B, z, _, 11, s[37]), z = c(z, L, A, B, w, 16, s[38]), B = c(B, z, L, A, m, 23, s[39]), A = c(A, B, z, L, S, 4, s[40]), L = c(L, A, B, z, a, 11, s[41]), z = c(z, L, A, B, p, 16, s[42]), B = c(B, z, L, A, v, 23, s[43]), A = c(A, B, z, L, y, 4, s[44]), L = c(L, A, B, z, E, 11, s[45]), z = c(z, L, A, B, R, 16, s[46]), A = u(A, B = c(B, z, L, A, d, 23, s[47]), z, L, a, 6, s[48]), L = u(L, A, B, z, w, 10, s[49]), z = u(z, L, A, B, x, 15, s[50]), B = u(B, z, L, A, g, 21, s[51]), A = u(A, B, z, L, E, 6, s[52]), L = u(L, A, B, z, p, 10, s[53]), z = u(z, L, A, B, m, 15, s[54]), B = u(B, z, L, A, h, 21, s[55]), A = u(A, B, z, L, b, 6, s[56]), L = u(L, A, B, z, R, 10, s[57]), z = u(z, L, A, B, v, 15, s[58]), B = u(B, z, L, A, S, 21, s[59]), A = u(A, B, z, L, _, 6, s[60]), L = u(L, A, B, z, k, 10, s[61]), z = u(z, L, A, B, d, 15, s[62]), B = u(B, z, L, A, y, 21, s[63]), o[0] = o[0] + A | 0, o[1] = o[1] + B | 0, o[2] = o[2] + z | 0, o[3] = o[3] + L | 0;
	              },
	              _doFinalize: function _doFinalize() {
	                var t = this._data,
	                  r = t.words,
	                  n = 8 * this._nDataBytes,
	                  i = 8 * t.sigBytes;
	                r[i >>> 5] |= 128 << 24 - i % 32;
	                var o = e.floor(n / 4294967296),
	                  a = n;
	                r[15 + (i + 64 >>> 9 << 4)] = 16711935 & (o << 8 | o >>> 24) | 4278255360 & (o << 24 | o >>> 8), r[14 + (i + 64 >>> 9 << 4)] = 16711935 & (a << 8 | a >>> 24) | 4278255360 & (a << 24 | a >>> 8), t.sigBytes = 4 * (r.length + 1), this._process();
	                for (var s = this._hash, h = s.words, f = 0; f < 4; f++) {
	                  var l = h[f];
	                  h[f] = 16711935 & (l << 8 | l >>> 24) | 4278255360 & (l << 24 | l >>> 8);
	                }
	                return s;
	              },
	              clone: function clone() {
	                var e = o.clone.call(this);
	                return e._hash = this._hash.clone(), e;
	              }
	            });
	            function f(e, t, r, n, i, o, a) {
	              var s = e + (t & r | ~t & n) + i + a;
	              return (s << o | s >>> 32 - o) + t;
	            }
	            function l(e, t, r, n, i, o, a) {
	              var s = e + (t & n | r & ~n) + i + a;
	              return (s << o | s >>> 32 - o) + t;
	            }
	            function c(e, t, r, n, i, o, a) {
	              var s = e + (t ^ r ^ n) + i + a;
	              return (s << o | s >>> 32 - o) + t;
	            }
	            function u(e, t, r, n, i, o, a) {
	              var s = e + (r ^ (t | ~n)) + i + a;
	              return (s << o | s >>> 32 - o) + t;
	            }
	            t.MD5 = o._createHelper(h), t.HmacMD5 = o._createHmacHelper(h);
	          }(Math), r.MD5);
	        }), Q(function (e, t) {
	          var r, n, i, o, a, s, h, f;
	          e.exports = (i = (n = r = ee).lib, o = i.WordArray, a = i.Hasher, s = n.algo, h = [], f = s.SHA1 = a.extend({
	            _doReset: function _doReset() {
	              this._hash = new o.init([1732584193, 4023233417, 2562383102, 271733878, 3285377520]);
	            },
	            _doProcessBlock: function _doProcessBlock(e, t) {
	              for (var r = this._hash.words, n = r[0], i = r[1], o = r[2], a = r[3], s = r[4], f = 0; f < 80; f++) {
	                if (f < 16) h[f] = 0 | e[t + f];else {
	                  var l = h[f - 3] ^ h[f - 8] ^ h[f - 14] ^ h[f - 16];
	                  h[f] = l << 1 | l >>> 31;
	                }
	                var c = (n << 5 | n >>> 27) + s + h[f];
	                c += f < 20 ? 1518500249 + (i & o | ~i & a) : f < 40 ? 1859775393 + (i ^ o ^ a) : f < 60 ? (i & o | i & a | o & a) - 1894007588 : (i ^ o ^ a) - 899497514, s = a, a = o, o = i << 30 | i >>> 2, i = n, n = c;
	              }
	              r[0] = r[0] + n | 0, r[1] = r[1] + i | 0, r[2] = r[2] + o | 0, r[3] = r[3] + a | 0, r[4] = r[4] + s | 0;
	            },
	            _doFinalize: function _doFinalize() {
	              var e = this._data,
	                t = e.words,
	                r = 8 * this._nDataBytes,
	                n = 8 * e.sigBytes;
	              return t[n >>> 5] |= 128 << 24 - n % 32, t[14 + (n + 64 >>> 9 << 4)] = Math.floor(r / 4294967296), t[15 + (n + 64 >>> 9 << 4)] = r, e.sigBytes = 4 * t.length, this._process(), this._hash;
	            },
	            clone: function clone() {
	              var e = a.clone.call(this);
	              return e._hash = this._hash.clone(), e;
	            }
	          }), n.SHA1 = a._createHelper(f), n.HmacSHA1 = a._createHmacHelper(f), r.SHA1);
	        }), Q(function (e, t) {
	          var r;
	          e.exports = (r = ee, function (e) {
	            var t = r,
	              n = t.lib,
	              i = n.WordArray,
	              o = n.Hasher,
	              a = t.algo,
	              s = [],
	              h = [];
	            !function () {
	              function t(t) {
	                for (var r = e.sqrt(t), n = 2; n <= r; n++) if (!(t % n)) return !1;
	                return !0;
	              }
	              function r(e) {
	                return 4294967296 * (e - (0 | e)) | 0;
	              }
	              for (var n = 2, i = 0; i < 64;) t(n) && (i < 8 && (s[i] = r(e.pow(n, 0.5))), h[i] = r(e.pow(n, 1 / 3)), i++), n++;
	            }();
	            var f = [],
	              l = a.SHA256 = o.extend({
	                _doReset: function _doReset() {
	                  this._hash = new i.init(s.slice(0));
	                },
	                _doProcessBlock: function _doProcessBlock(e, t) {
	                  for (var r = this._hash.words, n = r[0], i = r[1], o = r[2], a = r[3], s = r[4], l = r[5], c = r[6], u = r[7], d = 0; d < 64; d++) {
	                    if (d < 16) f[d] = 0 | e[t + d];else {
	                      var p = f[d - 15],
	                        _ = (p << 25 | p >>> 7) ^ (p << 14 | p >>> 18) ^ p >>> 3,
	                        g = f[d - 2],
	                        v = (g << 15 | g >>> 17) ^ (g << 13 | g >>> 19) ^ g >>> 10;
	                      f[d] = _ + f[d - 7] + v + f[d - 16];
	                    }
	                    var w = n & i ^ n & o ^ i & o,
	                      b = (n << 30 | n >>> 2) ^ (n << 19 | n >>> 13) ^ (n << 10 | n >>> 22),
	                      y = u + ((s << 26 | s >>> 6) ^ (s << 21 | s >>> 11) ^ (s << 7 | s >>> 25)) + (s & l ^ ~s & c) + h[d] + f[d];
	                    u = c, c = l, l = s, s = a + y | 0, a = o, o = i, i = n, n = y + (b + w) | 0;
	                  }
	                  r[0] = r[0] + n | 0, r[1] = r[1] + i | 0, r[2] = r[2] + o | 0, r[3] = r[3] + a | 0, r[4] = r[4] + s | 0, r[5] = r[5] + l | 0, r[6] = r[6] + c | 0, r[7] = r[7] + u | 0;
	                },
	                _doFinalize: function _doFinalize() {
	                  var t = this._data,
	                    r = t.words,
	                    n = 8 * this._nDataBytes,
	                    i = 8 * t.sigBytes;
	                  return r[i >>> 5] |= 128 << 24 - i % 32, r[14 + (i + 64 >>> 9 << 4)] = e.floor(n / 4294967296), r[15 + (i + 64 >>> 9 << 4)] = n, t.sigBytes = 4 * r.length, this._process(), this._hash;
	                },
	                clone: function clone() {
	                  var e = o.clone.call(this);
	                  return e._hash = this._hash.clone(), e;
	                }
	              });
	            t.SHA256 = o._createHelper(l), t.HmacSHA256 = o._createHmacHelper(l);
	          }(Math), r.SHA256);
	        }), Q(function (e, t) {
	          var r, n, i, o, a, s;
	          e.exports = (i = (n = r = ee).lib.WordArray, o = n.algo, a = o.SHA256, s = o.SHA224 = a.extend({
	            _doReset: function _doReset() {
	              this._hash = new i.init([3238371032, 914150663, 812702999, 4144912697, 4290775857, 1750603025, 1694076839, 3204075428]);
	            },
	            _doFinalize: function _doFinalize() {
	              var e = a._doFinalize.call(this);
	              return e.sigBytes -= 4, e;
	            }
	          }), n.SHA224 = a._createHelper(s), n.HmacSHA224 = a._createHmacHelper(s), r.SHA224);
	        }), Q(function (e, t) {
	          var r;
	          e.exports = (r = ee, function () {
	            var e = r,
	              t = e.lib.Hasher,
	              n = e.x64,
	              i = n.Word,
	              o = n.WordArray,
	              a = e.algo;
	            function s() {
	              return i.create.apply(i, arguments);
	            }
	            var h = [s(1116352408, 3609767458), s(1899447441, 602891725), s(3049323471, 3964484399), s(3921009573, 2173295548), s(961987163, 4081628472), s(1508970993, 3053834265), s(2453635748, 2937671579), s(2870763221, 3664609560), s(3624381080, 2734883394), s(310598401, 1164996542), s(607225278, 1323610764), s(1426881987, 3590304994), s(1925078388, 4068182383), s(2162078206, 991336113), s(2614888103, 633803317), s(3248222580, 3479774868), s(3835390401, 2666613458), s(4022224774, 944711139), s(264347078, 2341262773), s(604807628, 2007800933), s(770255983, 1495990901), s(1249150122, 1856431235), s(1555081692, 3175218132), s(1996064986, 2198950837), s(2554220882, 3999719339), s(2821834349, 766784016), s(2952996808, 2566594879), s(3210313671, 3203337956), s(3336571891, 1034457026), s(3584528711, 2466948901), s(113926993, 3758326383), s(338241895, 168717936), s(666307205, 1188179964), s(773529912, 1546045734), s(1294757372, 1522805485), s(1396182291, 2643833823), s(1695183700, 2343527390), s(1986661051, 1014477480), s(2177026350, 1206759142), s(2456956037, 344077627), s(2730485921, 1290863460), s(2820302411, 3158454273), s(3259730800, 3505952657), s(3345764771, 106217008), s(3516065817, 3606008344), s(3600352804, 1432725776), s(4094571909, 1467031594), s(275423344, 851169720), s(430227734, 3100823752), s(506948616, 1363258195), s(659060556, 3750685593), s(883997877, 3785050280), s(958139571, 3318307427), s(1322822218, 3812723403), s(1537002063, 2003034995), s(1747873779, 3602036899), s(1955562222, 1575990012), s(2024104815, 1125592928), s(2227730452, 2716904306), s(2361852424, 442776044), s(2428436474, 593698344), s(2756734187, 3733110249), s(3204031479, 2999351573), s(3329325298, 3815920427), s(3391569614, 3928383900), s(3515267271, 566280711), s(3940187606, 3454069534), s(4118630271, 4000239992), s(116418474, 1914138554), s(174292421, 2731055270), s(289380356, 3203993006), s(460393269, 320620315), s(685471733, 587496836), s(852142971, 1086792851), s(1017036298, 365543100), s(1126000580, 2618297676), s(1288033470, 3409855158), s(1501505948, 4234509866), s(1607167915, 987167468), s(1816402316, 1246189591)],
	              f = [];
	            !function () {
	              for (var e = 0; e < 80; e++) f[e] = s();
	            }();
	            var l = a.SHA512 = t.extend({
	              _doReset: function _doReset() {
	                this._hash = new o.init([new i.init(1779033703, 4089235720), new i.init(3144134277, 2227873595), new i.init(1013904242, 4271175723), new i.init(2773480762, 1595750129), new i.init(1359893119, 2917565137), new i.init(2600822924, 725511199), new i.init(528734635, 4215389547), new i.init(1541459225, 327033209)]);
	              },
	              _doProcessBlock: function _doProcessBlock(e, t) {
	                for (var r = this._hash.words, n = r[0], i = r[1], o = r[2], a = r[3], s = r[4], l = r[5], c = r[6], u = r[7], d = n.high, p = n.low, _ = i.high, g = i.low, v = o.high, w = o.low, b = a.high, y = a.low, m = s.high, k = s.low, E = l.high, S = l.low, x = c.high, R = c.low, A = u.high, B = u.low, z = d, L = p, T = _, M = g, C = v, D = w, I = b, P = y, O = m, U = k, H = E, F = S, N = x, Z = R, j = A, W = B, Y = 0; Y < 80; Y++) {
	                  var K = f[Y];
	                  if (Y < 16) var X = K.high = 0 | e[t + 2 * Y],
	                    q = K.low = 0 | e[t + 2 * Y + 1];else {
	                    var V = f[Y - 15],
	                      G = V.high,
	                      $ = V.low,
	                      J = (G >>> 1 | $ << 31) ^ (G >>> 8 | $ << 24) ^ G >>> 7,
	                      Q = ($ >>> 1 | G << 31) ^ ($ >>> 8 | G << 24) ^ ($ >>> 7 | G << 25),
	                      ee = f[Y - 2],
	                      te = ee.high,
	                      re = ee.low,
	                      ne = (te >>> 19 | re << 13) ^ (te << 3 | re >>> 29) ^ te >>> 6,
	                      ie = (re >>> 19 | te << 13) ^ (re << 3 | te >>> 29) ^ (re >>> 6 | te << 26),
	                      oe = f[Y - 7],
	                      ae = oe.high,
	                      se = oe.low,
	                      he = f[Y - 16],
	                      fe = he.high,
	                      le = he.low;
	                    X = (X = (X = J + ae + ((q = Q + se) >>> 0 < Q >>> 0 ? 1 : 0)) + ne + ((q += ie) >>> 0 < ie >>> 0 ? 1 : 0)) + fe + ((q += le) >>> 0 < le >>> 0 ? 1 : 0), K.high = X, K.low = q;
	                  }
	                  var ce,
	                    ue = O & H ^ ~O & N,
	                    de = U & F ^ ~U & Z,
	                    pe = z & T ^ z & C ^ T & C,
	                    _e = L & M ^ L & D ^ M & D,
	                    ge = (z >>> 28 | L << 4) ^ (z << 30 | L >>> 2) ^ (z << 25 | L >>> 7),
	                    ve = (L >>> 28 | z << 4) ^ (L << 30 | z >>> 2) ^ (L << 25 | z >>> 7),
	                    we = (O >>> 14 | U << 18) ^ (O >>> 18 | U << 14) ^ (O << 23 | U >>> 9),
	                    be = (U >>> 14 | O << 18) ^ (U >>> 18 | O << 14) ^ (U << 23 | O >>> 9),
	                    ye = h[Y],
	                    me = ye.high,
	                    ke = ye.low,
	                    Ee = j + we + ((ce = W + be) >>> 0 < W >>> 0 ? 1 : 0),
	                    Se = ve + _e;
	                  j = N, W = Z, N = H, Z = F, H = O, F = U, O = I + (Ee = (Ee = (Ee = Ee + ue + ((ce += de) >>> 0 < de >>> 0 ? 1 : 0)) + me + ((ce += ke) >>> 0 < ke >>> 0 ? 1 : 0)) + X + ((ce += q) >>> 0 < q >>> 0 ? 1 : 0)) + ((U = P + ce | 0) >>> 0 < P >>> 0 ? 1 : 0) | 0, I = C, P = D, C = T, D = M, T = z, M = L, z = Ee + (ge + pe + (Se >>> 0 < ve >>> 0 ? 1 : 0)) + ((L = ce + Se | 0) >>> 0 < ce >>> 0 ? 1 : 0) | 0;
	                }
	                p = n.low = p + L, n.high = d + z + (p >>> 0 < L >>> 0 ? 1 : 0), g = i.low = g + M, i.high = _ + T + (g >>> 0 < M >>> 0 ? 1 : 0), w = o.low = w + D, o.high = v + C + (w >>> 0 < D >>> 0 ? 1 : 0), y = a.low = y + P, a.high = b + I + (y >>> 0 < P >>> 0 ? 1 : 0), k = s.low = k + U, s.high = m + O + (k >>> 0 < U >>> 0 ? 1 : 0), S = l.low = S + F, l.high = E + H + (S >>> 0 < F >>> 0 ? 1 : 0), R = c.low = R + Z, c.high = x + N + (R >>> 0 < Z >>> 0 ? 1 : 0), B = u.low = B + W, u.high = A + j + (B >>> 0 < W >>> 0 ? 1 : 0);
	              },
	              _doFinalize: function _doFinalize() {
	                var e = this._data,
	                  t = e.words,
	                  r = 8 * this._nDataBytes,
	                  n = 8 * e.sigBytes;
	                return t[n >>> 5] |= 128 << 24 - n % 32, t[30 + (n + 128 >>> 10 << 5)] = Math.floor(r / 4294967296), t[31 + (n + 128 >>> 10 << 5)] = r, e.sigBytes = 4 * t.length, this._process(), this._hash.toX32();
	              },
	              clone: function clone() {
	                var e = t.clone.call(this);
	                return e._hash = this._hash.clone(), e;
	              },
	              blockSize: 32
	            });
	            e.SHA512 = t._createHelper(l), e.HmacSHA512 = t._createHmacHelper(l);
	          }(), r.SHA512);
	        }), Q(function (e, t) {
	          var r, n, i, o, a, s, h, f;
	          e.exports = (i = (n = r = ee).x64, o = i.Word, a = i.WordArray, s = n.algo, h = s.SHA512, f = s.SHA384 = h.extend({
	            _doReset: function _doReset() {
	              this._hash = new a.init([new o.init(3418070365, 3238371032), new o.init(1654270250, 914150663), new o.init(2438529370, 812702999), new o.init(355462360, 4144912697), new o.init(1731405415, 4290775857), new o.init(2394180231, 1750603025), new o.init(3675008525, 1694076839), new o.init(1203062813, 3204075428)]);
	            },
	            _doFinalize: function _doFinalize() {
	              var e = h._doFinalize.call(this);
	              return e.sigBytes -= 16, e;
	            }
	          }), n.SHA384 = h._createHelper(f), n.HmacSHA384 = h._createHmacHelper(f), r.SHA384);
	        }), Q(function (e, t) {
	          var r;
	          e.exports = (r = ee, function (e) {
	            var t = r,
	              n = t.lib,
	              i = n.WordArray,
	              o = n.Hasher,
	              a = t.x64.Word,
	              s = t.algo,
	              h = [],
	              f = [],
	              l = [];
	            !function () {
	              for (var e = 1, t = 0, r = 0; r < 24; r++) {
	                h[e + 5 * t] = (r + 1) * (r + 2) / 2 % 64;
	                var n = (2 * e + 3 * t) % 5;
	                e = t % 5, t = n;
	              }
	              for (e = 0; e < 5; e++) for (t = 0; t < 5; t++) f[e + 5 * t] = t + (2 * e + 3 * t) % 5 * 5;
	              for (var i = 1, o = 0; o < 24; o++) {
	                for (var s = 0, c = 0, u = 0; u < 7; u++) {
	                  if (1 & i) {
	                    var d = (1 << u) - 1;
	                    d < 32 ? c ^= 1 << d : s ^= 1 << d - 32;
	                  }
	                  128 & i ? i = i << 1 ^ 113 : i <<= 1;
	                }
	                l[o] = a.create(s, c);
	              }
	            }();
	            var c = [];
	            !function () {
	              for (var e = 0; e < 25; e++) c[e] = a.create();
	            }();
	            var u = s.SHA3 = o.extend({
	              cfg: o.cfg.extend({
	                outputLength: 512
	              }),
	              _doReset: function _doReset() {
	                for (var e = this._state = [], t = 0; t < 25; t++) e[t] = new a.init();
	                this.blockSize = (1600 - 2 * this.cfg.outputLength) / 32;
	              },
	              _doProcessBlock: function _doProcessBlock(e, t) {
	                for (var r = this._state, n = this.blockSize / 2, i = 0; i < n; i++) {
	                  var o = e[t + 2 * i],
	                    a = e[t + 2 * i + 1];
	                  o = 16711935 & (o << 8 | o >>> 24) | 4278255360 & (o << 24 | o >>> 8), a = 16711935 & (a << 8 | a >>> 24) | 4278255360 & (a << 24 | a >>> 8), (B = r[i]).high ^= a, B.low ^= o;
	                }
	                for (var s = 0; s < 24; s++) {
	                  for (var u = 0; u < 5; u++) {
	                    for (var d = 0, p = 0, _ = 0; _ < 5; _++) d ^= (B = r[u + 5 * _]).high, p ^= B.low;
	                    var g = c[u];
	                    g.high = d, g.low = p;
	                  }
	                  for (u = 0; u < 5; u++) {
	                    var v = c[(u + 4) % 5],
	                      w = c[(u + 1) % 5],
	                      b = w.high,
	                      y = w.low;
	                    for (d = v.high ^ (b << 1 | y >>> 31), p = v.low ^ (y << 1 | b >>> 31), _ = 0; _ < 5; _++) (B = r[u + 5 * _]).high ^= d, B.low ^= p;
	                  }
	                  for (var m = 1; m < 25; m++) {
	                    var k = (B = r[m]).high,
	                      E = B.low,
	                      S = h[m];
	                    S < 32 ? (d = k << S | E >>> 32 - S, p = E << S | k >>> 32 - S) : (d = E << S - 32 | k >>> 64 - S, p = k << S - 32 | E >>> 64 - S);
	                    var x = c[f[m]];
	                    x.high = d, x.low = p;
	                  }
	                  var R = c[0],
	                    A = r[0];
	                  for (R.high = A.high, R.low = A.low, u = 0; u < 5; u++) for (_ = 0; _ < 5; _++) {
	                    var B = r[m = u + 5 * _],
	                      z = c[m],
	                      L = c[(u + 1) % 5 + 5 * _],
	                      T = c[(u + 2) % 5 + 5 * _];
	                    B.high = z.high ^ ~L.high & T.high, B.low = z.low ^ ~L.low & T.low;
	                  }
	                  B = r[0];
	                  var M = l[s];
	                  B.high ^= M.high, B.low ^= M.low;
	                }
	              },
	              _doFinalize: function _doFinalize() {
	                var t = this._data,
	                  r = t.words,
	                  n = (this._nDataBytes, 8 * t.sigBytes),
	                  o = 32 * this.blockSize;
	                r[n >>> 5] |= 1 << 24 - n % 32, r[(e.ceil((n + 1) / o) * o >>> 5) - 1] |= 128, t.sigBytes = 4 * r.length, this._process();
	                for (var a = this._state, s = this.cfg.outputLength / 8, h = s / 8, f = [], l = 0; l < h; l++) {
	                  var c = a[l],
	                    u = c.high,
	                    d = c.low;
	                  u = 16711935 & (u << 8 | u >>> 24) | 4278255360 & (u << 24 | u >>> 8), d = 16711935 & (d << 8 | d >>> 24) | 4278255360 & (d << 24 | d >>> 8), f.push(d), f.push(u);
	                }
	                return new i.init(f, s);
	              },
	              clone: function clone() {
	                for (var e = o.clone.call(this), t = e._state = this._state.slice(0), r = 0; r < 25; r++) t[r] = t[r].clone();
	                return e;
	              }
	            });
	            t.SHA3 = o._createHelper(u), t.HmacSHA3 = o._createHmacHelper(u);
	          }(Math), r.SHA3);
	        }), Q(function (e, t) {
	          var r;
	          e.exports = (r = ee, function (e) {
	            var t = r,
	              n = t.lib,
	              i = n.WordArray,
	              o = n.Hasher,
	              a = t.algo,
	              s = i.create([0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 7, 4, 13, 1, 10, 6, 15, 3, 12, 0, 9, 5, 2, 14, 11, 8, 3, 10, 14, 4, 9, 15, 8, 1, 2, 7, 0, 6, 13, 11, 5, 12, 1, 9, 11, 10, 0, 8, 12, 4, 13, 3, 7, 15, 14, 5, 6, 2, 4, 0, 5, 9, 7, 12, 2, 10, 14, 1, 3, 8, 11, 6, 15, 13]),
	              h = i.create([5, 14, 7, 0, 9, 2, 11, 4, 13, 6, 15, 8, 1, 10, 3, 12, 6, 11, 3, 7, 0, 13, 5, 10, 14, 15, 8, 12, 4, 9, 1, 2, 15, 5, 1, 3, 7, 14, 6, 9, 11, 8, 12, 2, 10, 0, 4, 13, 8, 6, 4, 1, 3, 11, 15, 0, 5, 12, 2, 13, 9, 7, 10, 14, 12, 15, 10, 4, 1, 5, 8, 7, 6, 2, 13, 14, 0, 3, 9, 11]),
	              f = i.create([11, 14, 15, 12, 5, 8, 7, 9, 11, 13, 14, 15, 6, 7, 9, 8, 7, 6, 8, 13, 11, 9, 7, 15, 7, 12, 15, 9, 11, 7, 13, 12, 11, 13, 6, 7, 14, 9, 13, 15, 14, 8, 13, 6, 5, 12, 7, 5, 11, 12, 14, 15, 14, 15, 9, 8, 9, 14, 5, 6, 8, 6, 5, 12, 9, 15, 5, 11, 6, 8, 13, 12, 5, 12, 13, 14, 11, 8, 5, 6]),
	              l = i.create([8, 9, 9, 11, 13, 15, 15, 5, 7, 7, 8, 11, 14, 14, 12, 6, 9, 13, 15, 7, 12, 8, 9, 11, 7, 7, 12, 7, 6, 15, 13, 11, 9, 7, 15, 11, 8, 6, 6, 14, 12, 13, 5, 14, 13, 13, 7, 5, 15, 5, 8, 11, 14, 14, 6, 14, 6, 9, 12, 9, 12, 5, 15, 8, 8, 5, 12, 9, 12, 5, 14, 6, 8, 13, 6, 5, 15, 13, 11, 11]),
	              c = i.create([0, 1518500249, 1859775393, 2400959708, 2840853838]),
	              u = i.create([1352829926, 1548603684, 1836072691, 2053994217, 0]),
	              d = a.RIPEMD160 = o.extend({
	                _doReset: function _doReset() {
	                  this._hash = i.create([1732584193, 4023233417, 2562383102, 271733878, 3285377520]);
	                },
	                _doProcessBlock: function _doProcessBlock(e, t) {
	                  for (var r = 0; r < 16; r++) {
	                    var n = t + r,
	                      i = e[n];
	                    e[n] = 16711935 & (i << 8 | i >>> 24) | 4278255360 & (i << 24 | i >>> 8);
	                  }
	                  var o,
	                    a,
	                    d,
	                    y,
	                    m,
	                    k,
	                    E,
	                    S,
	                    x,
	                    R,
	                    A,
	                    B = this._hash.words,
	                    z = c.words,
	                    L = u.words,
	                    T = s.words,
	                    M = h.words,
	                    C = f.words,
	                    D = l.words;
	                  for (k = o = B[0], E = a = B[1], S = d = B[2], x = y = B[3], R = m = B[4], r = 0; r < 80; r += 1) A = o + e[t + T[r]] | 0, A += r < 16 ? p(a, d, y) + z[0] : r < 32 ? _(a, d, y) + z[1] : r < 48 ? g(a, d, y) + z[2] : r < 64 ? v(a, d, y) + z[3] : w(a, d, y) + z[4], A = (A = b(A |= 0, C[r])) + m | 0, o = m, m = y, y = b(d, 10), d = a, a = A, A = k + e[t + M[r]] | 0, A += r < 16 ? w(E, S, x) + L[0] : r < 32 ? v(E, S, x) + L[1] : r < 48 ? g(E, S, x) + L[2] : r < 64 ? _(E, S, x) + L[3] : p(E, S, x) + L[4], A = (A = b(A |= 0, D[r])) + R | 0, k = R, R = x, x = b(S, 10), S = E, E = A;
	                  A = B[1] + d + x | 0, B[1] = B[2] + y + R | 0, B[2] = B[3] + m + k | 0, B[3] = B[4] + o + E | 0, B[4] = B[0] + a + S | 0, B[0] = A;
	                },
	                _doFinalize: function _doFinalize() {
	                  var e = this._data,
	                    t = e.words,
	                    r = 8 * this._nDataBytes,
	                    n = 8 * e.sigBytes;
	                  t[n >>> 5] |= 128 << 24 - n % 32, t[14 + (n + 64 >>> 9 << 4)] = 16711935 & (r << 8 | r >>> 24) | 4278255360 & (r << 24 | r >>> 8), e.sigBytes = 4 * (t.length + 1), this._process();
	                  for (var i = this._hash, o = i.words, a = 0; a < 5; a++) {
	                    var s = o[a];
	                    o[a] = 16711935 & (s << 8 | s >>> 24) | 4278255360 & (s << 24 | s >>> 8);
	                  }
	                  return i;
	                },
	                clone: function clone() {
	                  var e = o.clone.call(this);
	                  return e._hash = this._hash.clone(), e;
	                }
	              });
	            function p(e, t, r) {
	              return e ^ t ^ r;
	            }
	            function _(e, t, r) {
	              return e & t | ~e & r;
	            }
	            function g(e, t, r) {
	              return (e | ~t) ^ r;
	            }
	            function v(e, t, r) {
	              return e & r | t & ~r;
	            }
	            function w(e, t, r) {
	              return e ^ (t | ~r);
	            }
	            function b(e, t) {
	              return e << t | e >>> 32 - t;
	            }
	            t.RIPEMD160 = o._createHelper(d), t.HmacRIPEMD160 = o._createHmacHelper(d);
	          }(), r.RIPEMD160);
	        }), Q(function (e, t) {
	          var r, n, i, o, a, s;
	          e.exports = (n = (r = ee).lib, i = n.Base, o = r.enc, a = o.Utf8, s = r.algo, void (s.HMAC = i.extend({
	            init: function init(e, t) {
	              e = this._hasher = new e.init(), 'string' == typeof t && (t = a.parse(t));
	              var r = e.blockSize,
	                n = 4 * r;
	              t.sigBytes > n && (t = e.finalize(t)), t.clamp();
	              for (var i = this._oKey = t.clone(), o = this._iKey = t.clone(), s = i.words, h = o.words, f = 0; f < r; f++) s[f] ^= 1549556828, h[f] ^= 909522486;
	              i.sigBytes = o.sigBytes = n, this.reset();
	            },
	            reset: function reset() {
	              var e = this._hasher;
	              e.reset(), e.update(this._iKey);
	            },
	            update: function update(e) {
	              return this._hasher.update(e), this;
	            },
	            finalize: function finalize(e) {
	              var t = this._hasher,
	                r = t.finalize(e);
	              t.reset();
	              var n = t.finalize(this._oKey.clone().concat(r));
	              return n;
	            }
	          })));
	        }), Q(function (e, t) {
	          var r, n, i, o, a, s, h, f, l;
	          e.exports = (i = (n = r = ee).lib, o = i.Base, a = i.WordArray, s = n.algo, h = s.SHA1, f = s.HMAC, l = s.PBKDF2 = o.extend({
	            cfg: o.extend({
	              keySize: 4,
	              hasher: h,
	              iterations: 1
	            }),
	            init: function init(e) {
	              this.cfg = this.cfg.extend(e);
	            },
	            compute: function compute(e, t) {
	              for (var r = this.cfg, n = f.create(r.hasher, e), i = a.create(), o = a.create([1]), s = i.words, h = o.words, l = r.keySize, c = r.iterations; s.length < l;) {
	                var u = n.update(t).finalize(o);
	                n.reset();
	                for (var d = u.words, p = d.length, _ = u, g = 1; g < c; g++) {
	                  _ = n.finalize(_), n.reset();
	                  for (var v = _.words, w = 0; w < p; w++) d[w] ^= v[w];
	                }
	                i.concat(u), h[0]++;
	              }
	              return i.sigBytes = 4 * l, i;
	            }
	          }), n.PBKDF2 = function (e, t, r) {
	            return l.create(r).compute(e, t);
	          }, r.PBKDF2);
	        }), Q(function (e, t) {
	          var r, n, i, o, a, s, h, f;
	          e.exports = (i = (n = r = ee).lib, o = i.Base, a = i.WordArray, s = n.algo, h = s.MD5, f = s.EvpKDF = o.extend({
	            cfg: o.extend({
	              keySize: 4,
	              hasher: h,
	              iterations: 1
	            }),
	            init: function init(e) {
	              this.cfg = this.cfg.extend(e);
	            },
	            compute: function compute(e, t) {
	              for (var r = this.cfg, n = r.hasher.create(), i = a.create(), o = i.words, s = r.keySize, h = r.iterations; o.length < s;) {
	                f && n.update(f);
	                var f = n.update(e).finalize(t);
	                n.reset();
	                for (var l = 1; l < h; l++) f = n.finalize(f), n.reset();
	                i.concat(f);
	              }
	              return i.sigBytes = 4 * s, i;
	            }
	          }), n.EvpKDF = function (e, t, r) {
	            return f.create(r).compute(e, t);
	          }, r.EvpKDF);
	        }), Q(function (e, t) {
	          var r, n, i, o, a, s, h, f, l, c, u, d, p, _, g, v, w, b, y, m, k, E, S, x;
	          e.exports = void ((r = ee).lib.Cipher || (i = r, o = i.lib, a = o.Base, s = o.WordArray, h = o.BufferedBlockAlgorithm, f = i.enc, f.Utf8, l = f.Base64, c = i.algo, u = c.EvpKDF, d = o.Cipher = h.extend({
	            cfg: a.extend(),
	            createEncryptor: function createEncryptor(e, t) {
	              return this.create(this._ENC_XFORM_MODE, e, t);
	            },
	            createDecryptor: function createDecryptor(e, t) {
	              return this.create(this._DEC_XFORM_MODE, e, t);
	            },
	            init: function init(e, t, r) {
	              this.cfg = this.cfg.extend(r), this._xformMode = e, this._key = t, this.reset();
	            },
	            reset: function reset() {
	              h.reset.call(this), this._doReset();
	            },
	            process: function process(e) {
	              return this._append(e), this._process();
	            },
	            finalize: function finalize(e) {
	              e && this._append(e);
	              var t = this._doFinalize();
	              return t;
	            },
	            keySize: 4,
	            ivSize: 4,
	            _ENC_XFORM_MODE: 1,
	            _DEC_XFORM_MODE: 2,
	            _createHelper: function () {
	              function e(e) {
	                return 'string' == typeof e ? x : k;
	              }
	              return function (t) {
	                return {
	                  encrypt: function encrypt(r, n, i) {
	                    return e(n).encrypt(t, r, n, i);
	                  },
	                  decrypt: function decrypt(r, n, i) {
	                    return e(n).decrypt(t, r, n, i);
	                  }
	                };
	              };
	            }()
	          }), o.StreamCipher = d.extend({
	            _doFinalize: function _doFinalize() {
	              var e = this._process(!0);
	              return e;
	            },
	            blockSize: 1
	          }), p = i.mode = {}, _ = o.BlockCipherMode = a.extend({
	            createEncryptor: function createEncryptor(e, t) {
	              return this.Encryptor.create(e, t);
	            },
	            createDecryptor: function createDecryptor(e, t) {
	              return this.Decryptor.create(e, t);
	            },
	            init: function init(e, t) {
	              this._cipher = e, this._iv = t;
	            }
	          }), g = p.CBC = function () {
	            var e = _.extend();
	            function t(e, t, r) {
	              var i = this._iv;
	              if (i) {
	                var o = i;
	                this._iv = n;
	              } else var o = this._prevBlock;
	              for (var a = 0; a < r; a++) e[t + a] ^= o[a];
	            }
	            return e.Encryptor = e.extend({
	              processBlock: function processBlock(e, r) {
	                var n = this._cipher,
	                  i = n.blockSize;
	                t.call(this, e, r, i), n.encryptBlock(e, r), this._prevBlock = e.slice(r, r + i);
	              }
	            }), e.Decryptor = e.extend({
	              processBlock: function processBlock(e, r) {
	                var n = this._cipher,
	                  i = n.blockSize,
	                  o = e.slice(r, r + i);
	                n.decryptBlock(e, r), t.call(this, e, r, i), this._prevBlock = o;
	              }
	            }), e;
	          }(), v = i.pad = {}, w = v.Pkcs7 = {
	            pad: function pad(e, t) {
	              for (var r = 4 * t, n = r - e.sigBytes % r, i = n << 24 | n << 16 | n << 8 | n, o = [], a = 0; a < n; a += 4) o.push(i);
	              var h = s.create(o, n);
	              e.concat(h);
	            },
	            unpad: function unpad(e) {
	              var t = 255 & e.words[e.sigBytes - 1 >>> 2];
	              e.sigBytes -= t;
	            }
	          }, o.BlockCipher = d.extend({
	            cfg: d.cfg.extend({
	              mode: g,
	              padding: w
	            }),
	            reset: function reset() {
	              d.reset.call(this);
	              var e = this.cfg,
	                t = e.iv,
	                r = e.mode;
	              if (this._xformMode == this._ENC_XFORM_MODE) var n = r.createEncryptor;else {
	                var n = r.createDecryptor;
	                this._minBufferSize = 1;
	              }
	              this._mode && this._mode.__creator == n ? this._mode.init(this, t && t.words) : (this._mode = n.call(r, this, t && t.words), this._mode.__creator = n);
	            },
	            _doProcessBlock: function _doProcessBlock(e, t) {
	              this._mode.processBlock(e, t);
	            },
	            _doFinalize: function _doFinalize() {
	              var e = this.cfg.padding;
	              if (this._xformMode == this._ENC_XFORM_MODE) {
	                e.pad(this._data, this.blockSize);
	                var t = this._process(!0);
	              } else {
	                var t = this._process(!0);
	                e.unpad(t);
	              }
	              return t;
	            },
	            blockSize: 4
	          }), b = o.CipherParams = a.extend({
	            init: function init(e) {
	              this.mixIn(e);
	            },
	            toString: function toString(e) {
	              return (e || this.formatter).stringify(this);
	            }
	          }), y = i.format = {}, m = y.OpenSSL = {
	            stringify: function stringify(e) {
	              var t = e.ciphertext,
	                r = e.salt;
	              if (r) var n = s.create([1398893684, 1701076831]).concat(r).concat(t);else var n = t;
	              return n.toString(l);
	            },
	            parse: function parse(e) {
	              var t = l.parse(e),
	                r = t.words;
	              if (1398893684 == r[0] && 1701076831 == r[1]) {
	                var n = s.create(r.slice(2, 4));
	                r.splice(0, 4), t.sigBytes -= 16;
	              }
	              return b.create({
	                ciphertext: t,
	                salt: n
	              });
	            }
	          }, k = o.SerializableCipher = a.extend({
	            cfg: a.extend({
	              format: m
	            }),
	            encrypt: function encrypt(e, t, r, n) {
	              n = this.cfg.extend(n);
	              var i = e.createEncryptor(r, n),
	                o = i.finalize(t),
	                a = i.cfg;
	              return b.create({
	                ciphertext: o,
	                key: r,
	                iv: a.iv,
	                algorithm: e,
	                mode: a.mode,
	                padding: a.padding,
	                blockSize: e.blockSize,
	                formatter: n.format
	              });
	            },
	            decrypt: function decrypt(e, t, r, n) {
	              n = this.cfg.extend(n), t = this._parse(t, n.format);
	              var i = e.createDecryptor(r, n).finalize(t.ciphertext);
	              return i;
	            },
	            _parse: function _parse(e, t) {
	              return 'string' == typeof e ? t.parse(e, this) : e;
	            }
	          }), E = i.kdf = {}, S = E.OpenSSL = {
	            execute: function execute(e, t, r, n) {
	              n || (n = s.random(8));
	              var i = u.create({
	                  keySize: t + r
	                }).compute(e, n),
	                o = s.create(i.words.slice(t), 4 * r);
	              return i.sigBytes = 4 * t, b.create({
	                key: i,
	                iv: o,
	                salt: n
	              });
	            }
	          }, x = o.PasswordBasedCipher = k.extend({
	            cfg: k.cfg.extend({
	              kdf: S
	            }),
	            encrypt: function encrypt(e, t, r, n) {
	              var i = (n = this.cfg.extend(n)).kdf.execute(r, e.keySize, e.ivSize);
	              n.iv = i.iv;
	              var o = k.encrypt.call(this, e, t, i.key, n);
	              return o.mixIn(i), o;
	            },
	            decrypt: function decrypt(e, t, r, n) {
	              n = this.cfg.extend(n), t = this._parse(t, n.format);
	              var i = n.kdf.execute(r, e.keySize, e.ivSize, t.salt);
	              n.iv = i.iv;
	              var o = k.decrypt.call(this, e, t, i.key, n);
	              return o;
	            }
	          })));
	        }), Q(function (e, t) {
	          var r;
	          e.exports = ((r = ee).mode.CFB = function () {
	            var e = r.lib.BlockCipherMode.extend();
	            function t(e, t, r, n) {
	              var i = this._iv;
	              if (i) {
	                var o = i.slice(0);
	                this._iv = void 0;
	              } else o = this._prevBlock;
	              n.encryptBlock(o, 0);
	              for (var a = 0; a < r; a++) e[t + a] ^= o[a];
	            }
	            return e.Encryptor = e.extend({
	              processBlock: function processBlock(e, r) {
	                var n = this._cipher,
	                  i = n.blockSize;
	                t.call(this, e, r, i, n), this._prevBlock = e.slice(r, r + i);
	              }
	            }), e.Decryptor = e.extend({
	              processBlock: function processBlock(e, r) {
	                var n = this._cipher,
	                  i = n.blockSize,
	                  o = e.slice(r, r + i);
	                t.call(this, e, r, i, n), this._prevBlock = o;
	              }
	            }), e;
	          }(), r.mode.CFB);
	        }), Q(function (e, t) {
	          var r, n, i;
	          e.exports = ((r = ee).mode.CTR = (n = r.lib.BlockCipherMode.extend(), i = n.Encryptor = n.extend({
	            processBlock: function processBlock(e, t) {
	              var r = this._cipher,
	                n = r.blockSize,
	                i = this._iv,
	                o = this._counter;
	              i && (o = this._counter = i.slice(0), this._iv = void 0);
	              var a = o.slice(0);
	              r.encryptBlock(a, 0), o[n - 1] = o[n - 1] + 1 | 0;
	              for (var s = 0; s < n; s++) e[t + s] ^= a[s];
	            }
	          }), n.Decryptor = i, n), r.mode.CTR);
	        }), Q(function (e, t) {
	          var r;
	          e.exports = ((r = ee).mode.CTRGladman = function () {
	            var e = r.lib.BlockCipherMode.extend();
	            function t(e) {
	              if (255 == (e >> 24 & 255)) {
	                var t = e >> 16 & 255,
	                  r = e >> 8 & 255,
	                  n = 255 & e;
	                255 === t ? (t = 0, 255 === r ? (r = 0, 255 === n ? n = 0 : ++n) : ++r) : ++t, e = 0, e += t << 16, e += r << 8, e += n;
	              } else e += 1 << 24;
	              return e;
	            }
	            var n = e.Encryptor = e.extend({
	              processBlock: function processBlock(e, r) {
	                var n = this._cipher,
	                  i = n.blockSize,
	                  o = this._iv,
	                  a = this._counter;
	                o && (a = this._counter = o.slice(0), this._iv = void 0), function (e) {
	                  0 === (e[0] = t(e[0])) && (e[1] = t(e[1]));
	                }(a);
	                var s = a.slice(0);
	                n.encryptBlock(s, 0);
	                for (var h = 0; h < i; h++) e[r + h] ^= s[h];
	              }
	            });
	            return e.Decryptor = n, e;
	          }(), r.mode.CTRGladman);
	        }), Q(function (e, t) {
	          var r, n, i;
	          e.exports = ((r = ee).mode.OFB = (n = r.lib.BlockCipherMode.extend(), i = n.Encryptor = n.extend({
	            processBlock: function processBlock(e, t) {
	              var r = this._cipher,
	                n = r.blockSize,
	                i = this._iv,
	                o = this._keystream;
	              i && (o = this._keystream = i.slice(0), this._iv = void 0), r.encryptBlock(o, 0);
	              for (var a = 0; a < n; a++) e[t + a] ^= o[a];
	            }
	          }), n.Decryptor = i, n), r.mode.OFB);
	        }), Q(function (e, t) {
	          var r, n;
	          e.exports = ((r = ee).mode.ECB = ((n = r.lib.BlockCipherMode.extend()).Encryptor = n.extend({
	            processBlock: function processBlock(e, t) {
	              this._cipher.encryptBlock(e, t);
	            }
	          }), n.Decryptor = n.extend({
	            processBlock: function processBlock(e, t) {
	              this._cipher.decryptBlock(e, t);
	            }
	          }), n), r.mode.ECB);
	        }), Q(function (e, t) {
	          var r;
	          e.exports = ((r = ee).pad.AnsiX923 = {
	            pad: function pad(e, t) {
	              var r = e.sigBytes,
	                n = 4 * t,
	                i = n - r % n,
	                o = r + i - 1;
	              e.clamp(), e.words[o >>> 2] |= i << 24 - o % 4 * 8, e.sigBytes += i;
	            },
	            unpad: function unpad(e) {
	              var t = 255 & e.words[e.sigBytes - 1 >>> 2];
	              e.sigBytes -= t;
	            }
	          }, r.pad.Ansix923);
	        }), Q(function (e, t) {
	          var r;
	          e.exports = ((r = ee).pad.Iso10126 = {
	            pad: function pad(e, t) {
	              var n = 4 * t,
	                i = n - e.sigBytes % n;
	              e.concat(r.lib.WordArray.random(i - 1)).concat(r.lib.WordArray.create([i << 24], 1));
	            },
	            unpad: function unpad(e) {
	              var t = 255 & e.words[e.sigBytes - 1 >>> 2];
	              e.sigBytes -= t;
	            }
	          }, r.pad.Iso10126);
	        }), Q(function (e, t) {
	          var r;
	          e.exports = ((r = ee).pad.Iso97971 = {
	            pad: function pad(e, t) {
	              e.concat(r.lib.WordArray.create([2147483648], 1)), r.pad.ZeroPadding.pad(e, t);
	            },
	            unpad: function unpad(e) {
	              r.pad.ZeroPadding.unpad(e), e.sigBytes--;
	            }
	          }, r.pad.Iso97971);
	        }), Q(function (e, t) {
	          var r;
	          e.exports = ((r = ee).pad.ZeroPadding = {
	            pad: function pad(e, t) {
	              var r = 4 * t;
	              e.clamp(), e.sigBytes += r - (e.sigBytes % r || r);
	            },
	            unpad: function unpad(e) {
	              for (var t = e.words, r = e.sigBytes - 1; !(t[r >>> 2] >>> 24 - r % 4 * 8 & 255);) r--;
	              e.sigBytes = r + 1;
	            }
	          }, r.pad.ZeroPadding);
	        }), Q(function (e, t) {
	          var r;
	          e.exports = ((r = ee).pad.NoPadding = {
	            pad: function pad() {},
	            unpad: function unpad() {}
	          }, r.pad.NoPadding);
	        }), Q(function (e, t) {
	          var r, n, i, o;
	          e.exports = (i = (n = r = ee).lib.CipherParams, o = n.enc.Hex, n.format.Hex = {
	            stringify: function stringify(e) {
	              return e.ciphertext.toString(o);
	            },
	            parse: function parse(e) {
	              var t = o.parse(e);
	              return i.create({
	                ciphertext: t
	              });
	            }
	          }, r.format.Hex);
	        }), Q(function (e, t) {
	          var r;
	          e.exports = (r = ee, function () {
	            var e = r,
	              t = e.lib.BlockCipher,
	              n = e.algo,
	              i = [],
	              o = [],
	              a = [],
	              s = [],
	              h = [],
	              f = [],
	              l = [],
	              c = [],
	              u = [],
	              d = [];
	            !function () {
	              for (var e = [], t = 0; t < 256; t++) e[t] = t < 128 ? t << 1 : t << 1 ^ 283;
	              var r = 0,
	                n = 0;
	              for (t = 0; t < 256; t++) {
	                var p = n ^ n << 1 ^ n << 2 ^ n << 3 ^ n << 4;
	                p = p >>> 8 ^ 255 & p ^ 99, i[r] = p, o[p] = r;
	                var _ = e[r],
	                  g = e[_],
	                  v = e[g],
	                  w = 257 * e[p] ^ 16843008 * p;
	                a[r] = w << 24 | w >>> 8, s[r] = w << 16 | w >>> 16, h[r] = w << 8 | w >>> 24, f[r] = w, w = 16843009 * v ^ 65537 * g ^ 257 * _ ^ 16843008 * r, l[p] = w << 24 | w >>> 8, c[p] = w << 16 | w >>> 16, u[p] = w << 8 | w >>> 24, d[p] = w, r ? (r = _ ^ e[e[e[v ^ _]]], n ^= e[e[n]]) : r = n = 1;
	              }
	            }();
	            var p = [0, 1, 2, 4, 8, 16, 32, 64, 128, 27, 54],
	              _ = n.AES = t.extend({
	                _doReset: function _doReset() {
	                  if (!this._nRounds || this._keyPriorReset !== this._key) {
	                    for (var e = this._keyPriorReset = this._key, t = e.words, r = e.sigBytes / 4, n = 4 * ((this._nRounds = r + 6) + 1), o = this._keySchedule = [], a = 0; a < n; a++) if (a < r) o[a] = t[a];else {
	                      var s = o[a - 1];
	                      a % r ? r > 6 && a % r == 4 && (s = i[s >>> 24] << 24 | i[s >>> 16 & 255] << 16 | i[s >>> 8 & 255] << 8 | i[255 & s]) : (s = i[(s = s << 8 | s >>> 24) >>> 24] << 24 | i[s >>> 16 & 255] << 16 | i[s >>> 8 & 255] << 8 | i[255 & s], s ^= p[a / r | 0] << 24), o[a] = o[a - r] ^ s;
	                    }
	                    for (var h = this._invKeySchedule = [], f = 0; f < n; f++) a = n - f, s = f % 4 ? o[a] : o[a - 4], h[f] = f < 4 || a <= 4 ? s : l[i[s >>> 24]] ^ c[i[s >>> 16 & 255]] ^ u[i[s >>> 8 & 255]] ^ d[i[255 & s]];
	                  }
	                },
	                encryptBlock: function encryptBlock(e, t) {
	                  this._doCryptBlock(e, t, this._keySchedule, a, s, h, f, i);
	                },
	                decryptBlock: function decryptBlock(e, t) {
	                  var r = e[t + 1];
	                  e[t + 1] = e[t + 3], e[t + 3] = r, this._doCryptBlock(e, t, this._invKeySchedule, l, c, u, d, o), r = e[t + 1], e[t + 1] = e[t + 3], e[t + 3] = r;
	                },
	                _doCryptBlock: function _doCryptBlock(e, t, r, n, i, o, a, s) {
	                  for (var h = this._nRounds, f = e[t] ^ r[0], l = e[t + 1] ^ r[1], c = e[t + 2] ^ r[2], u = e[t + 3] ^ r[3], d = 4, p = 1; p < h; p++) {
	                    var _ = n[f >>> 24] ^ i[l >>> 16 & 255] ^ o[c >>> 8 & 255] ^ a[255 & u] ^ r[d++],
	                      g = n[l >>> 24] ^ i[c >>> 16 & 255] ^ o[u >>> 8 & 255] ^ a[255 & f] ^ r[d++],
	                      v = n[c >>> 24] ^ i[u >>> 16 & 255] ^ o[f >>> 8 & 255] ^ a[255 & l] ^ r[d++],
	                      w = n[u >>> 24] ^ i[f >>> 16 & 255] ^ o[l >>> 8 & 255] ^ a[255 & c] ^ r[d++];
	                    f = _, l = g, c = v, u = w;
	                  }
	                  _ = (s[f >>> 24] << 24 | s[l >>> 16 & 255] << 16 | s[c >>> 8 & 255] << 8 | s[255 & u]) ^ r[d++], g = (s[l >>> 24] << 24 | s[c >>> 16 & 255] << 16 | s[u >>> 8 & 255] << 8 | s[255 & f]) ^ r[d++], v = (s[c >>> 24] << 24 | s[u >>> 16 & 255] << 16 | s[f >>> 8 & 255] << 8 | s[255 & l]) ^ r[d++], w = (s[u >>> 24] << 24 | s[f >>> 16 & 255] << 16 | s[l >>> 8 & 255] << 8 | s[255 & c]) ^ r[d++], e[t] = _, e[t + 1] = g, e[t + 2] = v, e[t + 3] = w;
	                },
	                keySize: 8
	              });
	            e.AES = t._createHelper(_);
	          }(), r.AES);
	        }), Q(function (e, t) {
	          var r;
	          e.exports = (r = ee, function () {
	            var e = r,
	              t = e.lib,
	              n = t.WordArray,
	              i = t.BlockCipher,
	              o = e.algo,
	              a = [57, 49, 41, 33, 25, 17, 9, 1, 58, 50, 42, 34, 26, 18, 10, 2, 59, 51, 43, 35, 27, 19, 11, 3, 60, 52, 44, 36, 63, 55, 47, 39, 31, 23, 15, 7, 62, 54, 46, 38, 30, 22, 14, 6, 61, 53, 45, 37, 29, 21, 13, 5, 28, 20, 12, 4],
	              s = [14, 17, 11, 24, 1, 5, 3, 28, 15, 6, 21, 10, 23, 19, 12, 4, 26, 8, 16, 7, 27, 20, 13, 2, 41, 52, 31, 37, 47, 55, 30, 40, 51, 45, 33, 48, 44, 49, 39, 56, 34, 53, 46, 42, 50, 36, 29, 32],
	              h = [1, 2, 4, 6, 8, 10, 12, 14, 15, 17, 19, 21, 23, 25, 27, 28],
	              f = [{
	                0: 8421888,
	                268435456: 32768,
	                536870912: 8421378,
	                805306368: 2,
	                1073741824: 512,
	                1342177280: 8421890,
	                1610612736: 8389122,
	                1879048192: 8388608,
	                2147483648: 514,
	                2415919104: 8389120,
	                2684354560: 33280,
	                2952790016: 8421376,
	                3221225472: 32770,
	                3489660928: 8388610,
	                3758096384: 0,
	                4026531840: 33282,
	                134217728: 0,
	                402653184: 8421890,
	                671088640: 33282,
	                939524096: 32768,
	                1207959552: 8421888,
	                1476395008: 512,
	                1744830464: 8421378,
	                2013265920: 2,
	                2281701376: 8389120,
	                2550136832: 33280,
	                2818572288: 8421376,
	                3087007744: 8389122,
	                3355443200: 8388610,
	                3623878656: 32770,
	                3892314112: 514,
	                4160749568: 8388608,
	                1: 32768,
	                268435457: 2,
	                536870913: 8421888,
	                805306369: 8388608,
	                1073741825: 8421378,
	                1342177281: 33280,
	                1610612737: 512,
	                1879048193: 8389122,
	                2147483649: 8421890,
	                2415919105: 8421376,
	                2684354561: 8388610,
	                2952790017: 33282,
	                3221225473: 514,
	                3489660929: 8389120,
	                3758096385: 32770,
	                4026531841: 0,
	                134217729: 8421890,
	                402653185: 8421376,
	                671088641: 8388608,
	                939524097: 512,
	                1207959553: 32768,
	                1476395009: 8388610,
	                1744830465: 2,
	                2013265921: 33282,
	                2281701377: 32770,
	                2550136833: 8389122,
	                2818572289: 514,
	                3087007745: 8421888,
	                3355443201: 8389120,
	                3623878657: 0,
	                3892314113: 33280,
	                4160749569: 8421378
	              }, {
	                0: 1074282512,
	                16777216: 16384,
	                33554432: 524288,
	                50331648: 1074266128,
	                67108864: 1073741840,
	                83886080: 1074282496,
	                100663296: 1073758208,
	                117440512: 16,
	                134217728: 540672,
	                150994944: 1073758224,
	                167772160: 1073741824,
	                184549376: 540688,
	                201326592: 524304,
	                218103808: 0,
	                234881024: 16400,
	                251658240: 1074266112,
	                8388608: 1073758208,
	                25165824: 540688,
	                41943040: 16,
	                58720256: 1073758224,
	                75497472: 1074282512,
	                92274688: 1073741824,
	                109051904: 524288,
	                125829120: 1074266128,
	                142606336: 524304,
	                159383552: 0,
	                176160768: 16384,
	                192937984: 1074266112,
	                209715200: 1073741840,
	                226492416: 540672,
	                243269632: 1074282496,
	                260046848: 16400,
	                268435456: 0,
	                285212672: 1074266128,
	                301989888: 1073758224,
	                318767104: 1074282496,
	                335544320: 1074266112,
	                352321536: 16,
	                369098752: 540688,
	                385875968: 16384,
	                402653184: 16400,
	                419430400: 524288,
	                436207616: 524304,
	                452984832: 1073741840,
	                469762048: 540672,
	                486539264: 1073758208,
	                503316480: 1073741824,
	                520093696: 1074282512,
	                276824064: 540688,
	                293601280: 524288,
	                310378496: 1074266112,
	                327155712: 16384,
	                343932928: 1073758208,
	                360710144: 1074282512,
	                377487360: 16,
	                394264576: 1073741824,
	                411041792: 1074282496,
	                427819008: 1073741840,
	                444596224: 1073758224,
	                461373440: 524304,
	                478150656: 0,
	                494927872: 16400,
	                511705088: 1074266128,
	                528482304: 540672
	              }, {
	                0: 260,
	                1048576: 0,
	                2097152: 67109120,
	                3145728: 65796,
	                4194304: 65540,
	                5242880: 67108868,
	                6291456: 67174660,
	                7340032: 67174400,
	                8388608: 67108864,
	                9437184: 67174656,
	                10485760: 65792,
	                11534336: 67174404,
	                12582912: 67109124,
	                13631488: 65536,
	                14680064: 4,
	                15728640: 256,
	                524288: 67174656,
	                1572864: 67174404,
	                2621440: 0,
	                3670016: 67109120,
	                4718592: 67108868,
	                5767168: 65536,
	                6815744: 65540,
	                7864320: 260,
	                8912896: 4,
	                9961472: 256,
	                11010048: 67174400,
	                12058624: 65796,
	                13107200: 65792,
	                14155776: 67109124,
	                15204352: 67174660,
	                16252928: 67108864,
	                16777216: 67174656,
	                17825792: 65540,
	                18874368: 65536,
	                19922944: 67109120,
	                20971520: 256,
	                22020096: 67174660,
	                23068672: 67108868,
	                24117248: 0,
	                25165824: 67109124,
	                26214400: 67108864,
	                27262976: 4,
	                28311552: 65792,
	                29360128: 67174400,
	                30408704: 260,
	                31457280: 65796,
	                32505856: 67174404,
	                17301504: 67108864,
	                18350080: 260,
	                19398656: 67174656,
	                20447232: 0,
	                21495808: 65540,
	                22544384: 67109120,
	                23592960: 256,
	                24641536: 67174404,
	                25690112: 65536,
	                26738688: 67174660,
	                27787264: 65796,
	                28835840: 67108868,
	                29884416: 67109124,
	                30932992: 67174400,
	                31981568: 4,
	                33030144: 65792
	              }, {
	                0: 2151682048,
	                65536: 2147487808,
	                131072: 4198464,
	                196608: 2151677952,
	                262144: 0,
	                327680: 4198400,
	                393216: 2147483712,
	                458752: 4194368,
	                524288: 2147483648,
	                589824: 4194304,
	                655360: 64,
	                720896: 2147487744,
	                786432: 2151678016,
	                851968: 4160,
	                917504: 4096,
	                983040: 2151682112,
	                32768: 2147487808,
	                98304: 64,
	                163840: 2151678016,
	                229376: 2147487744,
	                294912: 4198400,
	                360448: 2151682112,
	                425984: 0,
	                491520: 2151677952,
	                557056: 4096,
	                622592: 2151682048,
	                688128: 4194304,
	                753664: 4160,
	                819200: 2147483648,
	                884736: 4194368,
	                950272: 4198464,
	                1015808: 2147483712,
	                1048576: 4194368,
	                1114112: 4198400,
	                1179648: 2147483712,
	                1245184: 0,
	                1310720: 4160,
	                1376256: 2151678016,
	                1441792: 2151682048,
	                1507328: 2147487808,
	                1572864: 2151682112,
	                1638400: 2147483648,
	                1703936: 2151677952,
	                1769472: 4198464,
	                1835008: 2147487744,
	                1900544: 4194304,
	                1966080: 64,
	                2031616: 4096,
	                1081344: 2151677952,
	                1146880: 2151682112,
	                1212416: 0,
	                1277952: 4198400,
	                1343488: 4194368,
	                1409024: 2147483648,
	                1474560: 2147487808,
	                1540096: 64,
	                1605632: 2147483712,
	                1671168: 4096,
	                1736704: 2147487744,
	                1802240: 2151678016,
	                1867776: 4160,
	                1933312: 2151682048,
	                1998848: 4194304,
	                2064384: 4198464
	              }, {
	                0: 128,
	                4096: 17039360,
	                8192: 262144,
	                12288: 536870912,
	                16384: 537133184,
	                20480: 16777344,
	                24576: 553648256,
	                28672: 262272,
	                32768: 16777216,
	                36864: 537133056,
	                40960: 536871040,
	                45056: 553910400,
	                49152: 553910272,
	                53248: 0,
	                57344: 17039488,
	                61440: 553648128,
	                2048: 17039488,
	                6144: 553648256,
	                10240: 128,
	                14336: 17039360,
	                18432: 262144,
	                22528: 537133184,
	                26624: 553910272,
	                30720: 536870912,
	                34816: 537133056,
	                38912: 0,
	                43008: 553910400,
	                47104: 16777344,
	                51200: 536871040,
	                55296: 553648128,
	                59392: 16777216,
	                63488: 262272,
	                65536: 262144,
	                69632: 128,
	                73728: 536870912,
	                77824: 553648256,
	                81920: 16777344,
	                86016: 553910272,
	                90112: 537133184,
	                94208: 16777216,
	                98304: 553910400,
	                102400: 553648128,
	                106496: 17039360,
	                110592: 537133056,
	                114688: 262272,
	                118784: 536871040,
	                122880: 0,
	                126976: 17039488,
	                67584: 553648256,
	                71680: 16777216,
	                75776: 17039360,
	                79872: 537133184,
	                83968: 536870912,
	                88064: 17039488,
	                92160: 128,
	                96256: 553910272,
	                100352: 262272,
	                104448: 553910400,
	                108544: 0,
	                112640: 553648128,
	                116736: 16777344,
	                120832: 262144,
	                124928: 537133056,
	                129024: 536871040
	              }, {
	                0: 268435464,
	                256: 8192,
	                512: 270532608,
	                768: 270540808,
	                1024: 268443648,
	                1280: 2097152,
	                1536: 2097160,
	                1792: 268435456,
	                2048: 0,
	                2304: 268443656,
	                2560: 2105344,
	                2816: 8,
	                3072: 270532616,
	                3328: 2105352,
	                3584: 8200,
	                3840: 270540800,
	                128: 270532608,
	                384: 270540808,
	                640: 8,
	                896: 2097152,
	                1152: 2105352,
	                1408: 268435464,
	                1664: 268443648,
	                1920: 8200,
	                2176: 2097160,
	                2432: 8192,
	                2688: 268443656,
	                2944: 270532616,
	                3200: 0,
	                3456: 270540800,
	                3712: 2105344,
	                3968: 268435456,
	                4096: 268443648,
	                4352: 270532616,
	                4608: 270540808,
	                4864: 8200,
	                5120: 2097152,
	                5376: 268435456,
	                5632: 268435464,
	                5888: 2105344,
	                6144: 2105352,
	                6400: 0,
	                6656: 8,
	                6912: 270532608,
	                7168: 8192,
	                7424: 268443656,
	                7680: 270540800,
	                7936: 2097160,
	                4224: 8,
	                4480: 2105344,
	                4736: 2097152,
	                4992: 268435464,
	                5248: 268443648,
	                5504: 8200,
	                5760: 270540808,
	                6016: 270532608,
	                6272: 270540800,
	                6528: 270532616,
	                6784: 8192,
	                7040: 2105352,
	                7296: 2097160,
	                7552: 0,
	                7808: 268435456,
	                8064: 268443656
	              }, {
	                0: 1048576,
	                16: 33555457,
	                32: 1024,
	                48: 1049601,
	                64: 34604033,
	                80: 0,
	                96: 1,
	                112: 34603009,
	                128: 33555456,
	                144: 1048577,
	                160: 33554433,
	                176: 34604032,
	                192: 34603008,
	                208: 1025,
	                224: 1049600,
	                240: 33554432,
	                8: 34603009,
	                24: 0,
	                40: 33555457,
	                56: 34604032,
	                72: 1048576,
	                88: 33554433,
	                104: 33554432,
	                120: 1025,
	                136: 1049601,
	                152: 33555456,
	                168: 34603008,
	                184: 1048577,
	                200: 1024,
	                216: 34604033,
	                232: 1,
	                248: 1049600,
	                256: 33554432,
	                272: 1048576,
	                288: 33555457,
	                304: 34603009,
	                320: 1048577,
	                336: 33555456,
	                352: 34604032,
	                368: 1049601,
	                384: 1025,
	                400: 34604033,
	                416: 1049600,
	                432: 1,
	                448: 0,
	                464: 34603008,
	                480: 33554433,
	                496: 1024,
	                264: 1049600,
	                280: 33555457,
	                296: 34603009,
	                312: 1,
	                328: 33554432,
	                344: 1048576,
	                360: 1025,
	                376: 34604032,
	                392: 33554433,
	                408: 34603008,
	                424: 0,
	                440: 34604033,
	                456: 1049601,
	                472: 1024,
	                488: 33555456,
	                504: 1048577
	              }, {
	                0: 134219808,
	                1: 131072,
	                2: 134217728,
	                3: 32,
	                4: 131104,
	                5: 134350880,
	                6: 134350848,
	                7: 2048,
	                8: 134348800,
	                9: 134219776,
	                10: 133120,
	                11: 134348832,
	                12: 2080,
	                13: 0,
	                14: 134217760,
	                15: 133152,
	                2147483648: 2048,
	                2147483649: 134350880,
	                2147483650: 134219808,
	                2147483651: 134217728,
	                2147483652: 134348800,
	                2147483653: 133120,
	                2147483654: 133152,
	                2147483655: 32,
	                2147483656: 134217760,
	                2147483657: 2080,
	                2147483658: 131104,
	                2147483659: 134350848,
	                2147483660: 0,
	                2147483661: 134348832,
	                2147483662: 134219776,
	                2147483663: 131072,
	                16: 133152,
	                17: 134350848,
	                18: 32,
	                19: 2048,
	                20: 134219776,
	                21: 134217760,
	                22: 134348832,
	                23: 131072,
	                24: 0,
	                25: 131104,
	                26: 134348800,
	                27: 134219808,
	                28: 134350880,
	                29: 133120,
	                30: 2080,
	                31: 134217728,
	                2147483664: 131072,
	                2147483665: 2048,
	                2147483666: 134348832,
	                2147483667: 133152,
	                2147483668: 32,
	                2147483669: 134348800,
	                2147483670: 134217728,
	                2147483671: 134219808,
	                2147483672: 134350880,
	                2147483673: 134217760,
	                2147483674: 134219776,
	                2147483675: 0,
	                2147483676: 133120,
	                2147483677: 2080,
	                2147483678: 131104,
	                2147483679: 134350848
	              }],
	              l = [4160749569, 528482304, 33030144, 2064384, 129024, 8064, 504, 2147483679],
	              c = o.DES = i.extend({
	                _doReset: function _doReset() {
	                  for (var e = this._key.words, t = [], r = 0; r < 56; r++) {
	                    var n = a[r] - 1;
	                    t[r] = e[n >>> 5] >>> 31 - n % 32 & 1;
	                  }
	                  for (var i = this._subKeys = [], o = 0; o < 16; o++) {
	                    var f = i[o] = [],
	                      l = h[o];
	                    for (r = 0; r < 24; r++) f[r / 6 | 0] |= t[(s[r] - 1 + l) % 28] << 31 - r % 6, f[4 + (r / 6 | 0)] |= t[28 + (s[r + 24] - 1 + l) % 28] << 31 - r % 6;
	                    for (f[0] = f[0] << 1 | f[0] >>> 31, r = 1; r < 7; r++) f[r] = f[r] >>> 4 * (r - 1) + 3;
	                    f[7] = f[7] << 5 | f[7] >>> 27;
	                  }
	                  var c = this._invSubKeys = [];
	                  for (r = 0; r < 16; r++) c[r] = i[15 - r];
	                },
	                encryptBlock: function encryptBlock(e, t) {
	                  this._doCryptBlock(e, t, this._subKeys);
	                },
	                decryptBlock: function decryptBlock(e, t) {
	                  this._doCryptBlock(e, t, this._invSubKeys);
	                },
	                _doCryptBlock: function _doCryptBlock(e, t, r) {
	                  this._lBlock = e[t], this._rBlock = e[t + 1], u.call(this, 4, 252645135), u.call(this, 16, 65535), d.call(this, 2, 858993459), d.call(this, 8, 16711935), u.call(this, 1, 1431655765);
	                  for (var n = 0; n < 16; n++) {
	                    for (var i = r[n], o = this._lBlock, a = this._rBlock, s = 0, h = 0; h < 8; h++) s |= f[h][((a ^ i[h]) & l[h]) >>> 0];
	                    this._lBlock = a, this._rBlock = o ^ s;
	                  }
	                  var c = this._lBlock;
	                  this._lBlock = this._rBlock, this._rBlock = c, u.call(this, 1, 1431655765), d.call(this, 8, 16711935), d.call(this, 2, 858993459), u.call(this, 16, 65535), u.call(this, 4, 252645135), e[t] = this._lBlock, e[t + 1] = this._rBlock;
	                },
	                keySize: 2,
	                ivSize: 2,
	                blockSize: 2
	              });
	            function u(e, t) {
	              var r = (this._lBlock >>> e ^ this._rBlock) & t;
	              this._rBlock ^= r, this._lBlock ^= r << e;
	            }
	            function d(e, t) {
	              var r = (this._rBlock >>> e ^ this._lBlock) & t;
	              this._lBlock ^= r, this._rBlock ^= r << e;
	            }
	            e.DES = i._createHelper(c);
	            var p = o.TripleDES = i.extend({
	              _doReset: function _doReset() {
	                var e = this._key.words;
	                this._des1 = c.createEncryptor(n.create(e.slice(0, 2))), this._des2 = c.createEncryptor(n.create(e.slice(2, 4))), this._des3 = c.createEncryptor(n.create(e.slice(4, 6)));
	              },
	              encryptBlock: function encryptBlock(e, t) {
	                this._des1.encryptBlock(e, t), this._des2.decryptBlock(e, t), this._des3.encryptBlock(e, t);
	              },
	              decryptBlock: function decryptBlock(e, t) {
	                this._des3.decryptBlock(e, t), this._des2.encryptBlock(e, t), this._des1.decryptBlock(e, t);
	              },
	              keySize: 6,
	              ivSize: 2,
	              blockSize: 2
	            });
	            e.TripleDES = i._createHelper(p);
	          }(), r.TripleDES);
	        }), Q(function (e, t) {
	          var r;
	          e.exports = (r = ee, function () {
	            var e = r,
	              t = e.lib.StreamCipher,
	              n = e.algo,
	              i = n.RC4 = t.extend({
	                _doReset: function _doReset() {
	                  for (var e = this._key, t = e.words, r = e.sigBytes, n = this._S = [], i = 0; i < 256; i++) n[i] = i;
	                  i = 0;
	                  for (var o = 0; i < 256; i++) {
	                    var a = i % r,
	                      s = t[a >>> 2] >>> 24 - a % 4 * 8 & 255;
	                    o = (o + n[i] + s) % 256;
	                    var h = n[i];
	                    n[i] = n[o], n[o] = h;
	                  }
	                  this._i = this._j = 0;
	                },
	                _doProcessBlock: function _doProcessBlock(e, t) {
	                  e[t] ^= o.call(this);
	                },
	                keySize: 8,
	                ivSize: 0
	              });
	            function o() {
	              for (var e = this._S, t = this._i, r = this._j, n = 0, i = 0; i < 4; i++) {
	                r = (r + e[t = (t + 1) % 256]) % 256;
	                var o = e[t];
	                e[t] = e[r], e[r] = o, n |= e[(e[t] + e[r]) % 256] << 24 - 8 * i;
	              }
	              return this._i = t, this._j = r, n;
	            }
	            e.RC4 = t._createHelper(i);
	            var a = n.RC4Drop = i.extend({
	              cfg: i.cfg.extend({
	                drop: 192
	              }),
	              _doReset: function _doReset() {
	                i._doReset.call(this);
	                for (var e = this.cfg.drop; e > 0; e--) o.call(this);
	              }
	            });
	            e.RC4Drop = t._createHelper(a);
	          }(), r.RC4);
	        }), Q(function (e, t) {
	          var r;
	          e.exports = (r = ee, function () {
	            var e = r,
	              t = e.lib.StreamCipher,
	              n = e.algo,
	              i = [],
	              o = [],
	              a = [],
	              s = n.Rabbit = t.extend({
	                _doReset: function _doReset() {
	                  for (var e = this._key.words, t = this.cfg.iv, r = 0; r < 4; r++) e[r] = 16711935 & (e[r] << 8 | e[r] >>> 24) | 4278255360 & (e[r] << 24 | e[r] >>> 8);
	                  var n = this._X = [e[0], e[3] << 16 | e[2] >>> 16, e[1], e[0] << 16 | e[3] >>> 16, e[2], e[1] << 16 | e[0] >>> 16, e[3], e[2] << 16 | e[1] >>> 16],
	                    i = this._C = [e[2] << 16 | e[2] >>> 16, 4294901760 & e[0] | 65535 & e[1], e[3] << 16 | e[3] >>> 16, 4294901760 & e[1] | 65535 & e[2], e[0] << 16 | e[0] >>> 16, 4294901760 & e[2] | 65535 & e[3], e[1] << 16 | e[1] >>> 16, 4294901760 & e[3] | 65535 & e[0]];
	                  for (this._b = 0, r = 0; r < 4; r++) h.call(this);
	                  for (r = 0; r < 8; r++) i[r] ^= n[r + 4 & 7];
	                  if (t) {
	                    var o = t.words,
	                      a = o[0],
	                      s = o[1],
	                      f = 16711935 & (a << 8 | a >>> 24) | 4278255360 & (a << 24 | a >>> 8),
	                      l = 16711935 & (s << 8 | s >>> 24) | 4278255360 & (s << 24 | s >>> 8),
	                      c = f >>> 16 | 4294901760 & l,
	                      u = l << 16 | 65535 & f;
	                    for (i[0] ^= f, i[1] ^= c, i[2] ^= l, i[3] ^= u, i[4] ^= f, i[5] ^= c, i[6] ^= l, i[7] ^= u, r = 0; r < 4; r++) h.call(this);
	                  }
	                },
	                _doProcessBlock: function _doProcessBlock(e, t) {
	                  var r = this._X;
	                  h.call(this), i[0] = r[0] ^ r[5] >>> 16 ^ r[3] << 16, i[1] = r[2] ^ r[7] >>> 16 ^ r[5] << 16, i[2] = r[4] ^ r[1] >>> 16 ^ r[7] << 16, i[3] = r[6] ^ r[3] >>> 16 ^ r[1] << 16;
	                  for (var n = 0; n < 4; n++) i[n] = 16711935 & (i[n] << 8 | i[n] >>> 24) | 4278255360 & (i[n] << 24 | i[n] >>> 8), e[t + n] ^= i[n];
	                },
	                blockSize: 4,
	                ivSize: 2
	              });
	            function h() {
	              for (var e = this._X, t = this._C, r = 0; r < 8; r++) o[r] = t[r];
	              for (t[0] = t[0] + 1295307597 + this._b | 0, t[1] = t[1] + 3545052371 + (t[0] >>> 0 < o[0] >>> 0 ? 1 : 0) | 0, t[2] = t[2] + 886263092 + (t[1] >>> 0 < o[1] >>> 0 ? 1 : 0) | 0, t[3] = t[3] + 1295307597 + (t[2] >>> 0 < o[2] >>> 0 ? 1 : 0) | 0, t[4] = t[4] + 3545052371 + (t[3] >>> 0 < o[3] >>> 0 ? 1 : 0) | 0, t[5] = t[5] + 886263092 + (t[4] >>> 0 < o[4] >>> 0 ? 1 : 0) | 0, t[6] = t[6] + 1295307597 + (t[5] >>> 0 < o[5] >>> 0 ? 1 : 0) | 0, t[7] = t[7] + 3545052371 + (t[6] >>> 0 < o[6] >>> 0 ? 1 : 0) | 0, this._b = t[7] >>> 0 < o[7] >>> 0 ? 1 : 0, r = 0; r < 8; r++) {
	                var n = e[r] + t[r],
	                  i = 65535 & n,
	                  s = n >>> 16,
	                  h = ((i * i >>> 17) + i * s >>> 15) + s * s,
	                  f = ((4294901760 & n) * n | 0) + ((65535 & n) * n | 0);
	                a[r] = h ^ f;
	              }
	              e[0] = a[0] + (a[7] << 16 | a[7] >>> 16) + (a[6] << 16 | a[6] >>> 16) | 0, e[1] = a[1] + (a[0] << 8 | a[0] >>> 24) + a[7] | 0, e[2] = a[2] + (a[1] << 16 | a[1] >>> 16) + (a[0] << 16 | a[0] >>> 16) | 0, e[3] = a[3] + (a[2] << 8 | a[2] >>> 24) + a[1] | 0, e[4] = a[4] + (a[3] << 16 | a[3] >>> 16) + (a[2] << 16 | a[2] >>> 16) | 0, e[5] = a[5] + (a[4] << 8 | a[4] >>> 24) + a[3] | 0, e[6] = a[6] + (a[5] << 16 | a[5] >>> 16) + (a[4] << 16 | a[4] >>> 16) | 0, e[7] = a[7] + (a[6] << 8 | a[6] >>> 24) + a[5] | 0;
	            }
	            e.Rabbit = t._createHelper(s);
	          }(), r.Rabbit);
	        }), Q(function (e, t) {
	          var r;
	          e.exports = (r = ee, function () {
	            var e = r,
	              t = e.lib.StreamCipher,
	              n = e.algo,
	              i = [],
	              o = [],
	              a = [],
	              s = n.RabbitLegacy = t.extend({
	                _doReset: function _doReset() {
	                  var e = this._key.words,
	                    t = this.cfg.iv,
	                    r = this._X = [e[0], e[3] << 16 | e[2] >>> 16, e[1], e[0] << 16 | e[3] >>> 16, e[2], e[1] << 16 | e[0] >>> 16, e[3], e[2] << 16 | e[1] >>> 16],
	                    n = this._C = [e[2] << 16 | e[2] >>> 16, 4294901760 & e[0] | 65535 & e[1], e[3] << 16 | e[3] >>> 16, 4294901760 & e[1] | 65535 & e[2], e[0] << 16 | e[0] >>> 16, 4294901760 & e[2] | 65535 & e[3], e[1] << 16 | e[1] >>> 16, 4294901760 & e[3] | 65535 & e[0]];
	                  this._b = 0;
	                  for (var i = 0; i < 4; i++) h.call(this);
	                  for (i = 0; i < 8; i++) n[i] ^= r[i + 4 & 7];
	                  if (t) {
	                    var o = t.words,
	                      a = o[0],
	                      s = o[1],
	                      f = 16711935 & (a << 8 | a >>> 24) | 4278255360 & (a << 24 | a >>> 8),
	                      l = 16711935 & (s << 8 | s >>> 24) | 4278255360 & (s << 24 | s >>> 8),
	                      c = f >>> 16 | 4294901760 & l,
	                      u = l << 16 | 65535 & f;
	                    for (n[0] ^= f, n[1] ^= c, n[2] ^= l, n[3] ^= u, n[4] ^= f, n[5] ^= c, n[6] ^= l, n[7] ^= u, i = 0; i < 4; i++) h.call(this);
	                  }
	                },
	                _doProcessBlock: function _doProcessBlock(e, t) {
	                  var r = this._X;
	                  h.call(this), i[0] = r[0] ^ r[5] >>> 16 ^ r[3] << 16, i[1] = r[2] ^ r[7] >>> 16 ^ r[5] << 16, i[2] = r[4] ^ r[1] >>> 16 ^ r[7] << 16, i[3] = r[6] ^ r[3] >>> 16 ^ r[1] << 16;
	                  for (var n = 0; n < 4; n++) i[n] = 16711935 & (i[n] << 8 | i[n] >>> 24) | 4278255360 & (i[n] << 24 | i[n] >>> 8), e[t + n] ^= i[n];
	                },
	                blockSize: 4,
	                ivSize: 2
	              });
	            function h() {
	              for (var e = this._X, t = this._C, r = 0; r < 8; r++) o[r] = t[r];
	              for (t[0] = t[0] + 1295307597 + this._b | 0, t[1] = t[1] + 3545052371 + (t[0] >>> 0 < o[0] >>> 0 ? 1 : 0) | 0, t[2] = t[2] + 886263092 + (t[1] >>> 0 < o[1] >>> 0 ? 1 : 0) | 0, t[3] = t[3] + 1295307597 + (t[2] >>> 0 < o[2] >>> 0 ? 1 : 0) | 0, t[4] = t[4] + 3545052371 + (t[3] >>> 0 < o[3] >>> 0 ? 1 : 0) | 0, t[5] = t[5] + 886263092 + (t[4] >>> 0 < o[4] >>> 0 ? 1 : 0) | 0, t[6] = t[6] + 1295307597 + (t[5] >>> 0 < o[5] >>> 0 ? 1 : 0) | 0, t[7] = t[7] + 3545052371 + (t[6] >>> 0 < o[6] >>> 0 ? 1 : 0) | 0, this._b = t[7] >>> 0 < o[7] >>> 0 ? 1 : 0, r = 0; r < 8; r++) {
	                var n = e[r] + t[r],
	                  i = 65535 & n,
	                  s = n >>> 16,
	                  h = ((i * i >>> 17) + i * s >>> 15) + s * s,
	                  f = ((4294901760 & n) * n | 0) + ((65535 & n) * n | 0);
	                a[r] = h ^ f;
	              }
	              e[0] = a[0] + (a[7] << 16 | a[7] >>> 16) + (a[6] << 16 | a[6] >>> 16) | 0, e[1] = a[1] + (a[0] << 8 | a[0] >>> 24) + a[7] | 0, e[2] = a[2] + (a[1] << 16 | a[1] >>> 16) + (a[0] << 16 | a[0] >>> 16) | 0, e[3] = a[3] + (a[2] << 8 | a[2] >>> 24) + a[1] | 0, e[4] = a[4] + (a[3] << 16 | a[3] >>> 16) + (a[2] << 16 | a[2] >>> 16) | 0, e[5] = a[5] + (a[4] << 8 | a[4] >>> 24) + a[3] | 0, e[6] = a[6] + (a[5] << 16 | a[5] >>> 16) + (a[4] << 16 | a[4] >>> 16) | 0, e[7] = a[7] + (a[6] << 8 | a[6] >>> 24) + a[5] | 0;
	            }
	            e.RabbitLegacy = t._createHelper(s);
	          }(), r.RabbitLegacy);
	        }), Q(function (e, t) {
	          e.exports = ee;
	        }));
	      function re() {
	        throw new Error('setTimeout has not been defined');
	      }
	      function ne() {
	        throw new Error('clearTimeout has not been defined');
	      }
	      var ie = re,
	        oe = ne;
	      function ae(e) {
	        if (ie === setTimeout) return setTimeout(e, 0);
	        if ((ie === re || !ie) && setTimeout) return ie = setTimeout, setTimeout(e, 0);
	        try {
	          return ie(e, 0);
	        } catch (t) {
	          try {
	            return ie.call(null, e, 0);
	          } catch (t) {
	            return ie.call(this, e, 0);
	          }
	        }
	      }
	      'function' == typeof e.setTimeout && (ie = setTimeout), 'function' == typeof e.clearTimeout && (oe = clearTimeout);
	      var se,
	        he = [],
	        fe = !1,
	        le = -1;
	      function ce() {
	        fe && se && (fe = !1, se.length ? he = se.concat(he) : le = -1, he.length && ue());
	      }
	      function ue() {
	        if (!fe) {
	          var e = ae(ce);
	          fe = !0;
	          for (var t = he.length; t;) {
	            for (se = he, he = []; ++le < t;) se && se[le].run();
	            le = -1, t = he.length;
	          }
	          se = null, fe = !1, function (e) {
	            if (oe === clearTimeout) return clearTimeout(e);
	            if ((oe === ne || !oe) && clearTimeout) return oe = clearTimeout, clearTimeout(e);
	            try {
	              oe(e);
	            } catch (t) {
	              try {
	                return oe.call(null, e);
	              } catch (t) {
	                return oe.call(this, e);
	              }
	            }
	          }(e);
	        }
	      }
	      function de(e) {
	        var t = new Array(arguments.length - 1);
	        if (arguments.length > 1) for (var r = 1; r < arguments.length; r++) t[r - 1] = arguments[r];
	        he.push(new pe(e, t)), 1 !== he.length || fe || ae(ue);
	      }
	      function pe(e, t) {
	        this.fun = e, this.array = t;
	      }
	      pe.prototype.run = function () {
	        this.fun.apply(null, this.array);
	      };
	      var _e = e.performance || {};
	      _e.now || _e.mozNow || _e.msNow || _e.oNow || _e.webkitNow;
	      function ge() {}
	      function ve() {
	        ve.init.call(this);
	      }
	      function we(e) {
	        return void 0 === e._maxListeners ? ve.defaultMaxListeners : e._maxListeners;
	      }
	      function be(e, t, r) {
	        if (t) e.call(r);else for (var n = e.length, i = Ae(e, n), o = 0; o < n; ++o) i[o].call(r);
	      }
	      function ye(e, t, r, n) {
	        if (t) e.call(r, n);else for (var i = e.length, o = Ae(e, i), a = 0; a < i; ++a) o[a].call(r, n);
	      }
	      function me(e, t, r, n, i) {
	        if (t) e.call(r, n, i);else for (var o = e.length, a = Ae(e, o), s = 0; s < o; ++s) a[s].call(r, n, i);
	      }
	      function ke(e, t, r, n, i, o) {
	        if (t) e.call(r, n, i, o);else for (var a = e.length, s = Ae(e, a), h = 0; h < a; ++h) s[h].call(r, n, i, o);
	      }
	      function Ee(e, t, r, n) {
	        if (t) e.apply(r, n);else for (var i = e.length, o = Ae(e, i), a = 0; a < i; ++a) o[a].apply(r, n);
	      }
	      function Se(e, t, r, n) {
	        var i, o, a, s;
	        if ('function' != typeof r) throw new TypeError('"listener" argument must be a function');
	        if ((o = e._events) ? (o.newListener && (e.emit('newListener', t, r.listener ? r.listener : r), o = e._events), a = o[t]) : (o = e._events = new ge(), e._eventsCount = 0), a) {
	          if ('function' == typeof a ? a = o[t] = n ? [r, a] : [a, r] : n ? a.unshift(r) : a.push(r), !a.warned && (i = we(e)) && i > 0 && a.length > i) {
	            a.warned = !0;
	            var h = new Error('Possible EventEmitter memory leak detected. ' + a.length + ' ' + t + ' listeners added. Use emitter.setMaxListeners() to increase limit');
	            h.name = 'MaxListenersExceededWarning', h.emitter = e, h.type = t, h.count = a.length, s = h, 'function' == typeof console.warn ? console.warn(s) : console.log(s);
	          }
	        } else a = o[t] = r, ++e._eventsCount;
	        return e;
	      }
	      function xe(e, t, r) {
	        var n = !1;
	        function i() {
	          e.removeListener(t, i), n || (n = !0, r.apply(e, arguments));
	        }
	        return i.listener = r, i;
	      }
	      function Re(e) {
	        var t = this._events;
	        if (t) {
	          var r = t[e];
	          if ('function' == typeof r) return 1;
	          if (r) return r.length;
	        }
	        return 0;
	      }
	      function Ae(e, t) {
	        for (var r = new Array(t); t--;) r[t] = e[t];
	        return r;
	      }
	      ge.prototype = Object.create(null), ve.EventEmitter = ve, ve.usingDomains = !1, ve.prototype.domain = void 0, ve.prototype._events = void 0, ve.prototype._maxListeners = void 0, ve.defaultMaxListeners = 10, ve.init = function () {
	        this.domain = null, ve.usingDomains && (void 0).active && (void 0).Domain, this._events && this._events !== Object.getPrototypeOf(this)._events || (this._events = new ge(), this._eventsCount = 0), this._maxListeners = this._maxListeners || void 0;
	      }, ve.prototype.setMaxListeners = function (e) {
	        if ('number' != typeof e || e < 0 || isNaN(e)) throw new TypeError('"n" argument must be a positive number');
	        return this._maxListeners = e, this;
	      }, ve.prototype.getMaxListeners = function () {
	        return we(this);
	      }, ve.prototype.emit = function (e) {
	        var t,
	          r,
	          n,
	          i,
	          o,
	          a,
	          s,
	          h = 'error' === e;
	        if (a = this._events) h = h && null == a.error;else if (!h) return !1;
	        if (s = this.domain, h) {
	          if (t = arguments[1], !s) {
	            if (t instanceof Error) throw t;
	            var f = new Error('Uncaught, unspecified "error" event. (' + t + ')');
	            throw f.context = t, f;
	          }
	          return t || (t = new Error('Uncaught, unspecified "error" event')), t.domainEmitter = this, t.domain = s, t.domainThrown = !1, s.emit('error', t), !1;
	        }
	        if (!(r = a[e])) return !1;
	        var l = 'function' == typeof r;
	        switch (n = arguments.length) {
	          case 1:
	            be(r, l, this);
	            break;
	          case 2:
	            ye(r, l, this, arguments[1]);
	            break;
	          case 3:
	            me(r, l, this, arguments[1], arguments[2]);
	            break;
	          case 4:
	            ke(r, l, this, arguments[1], arguments[2], arguments[3]);
	            break;
	          default:
	            for (i = new Array(n - 1), o = 1; o < n; o++) i[o - 1] = arguments[o];
	            Ee(r, l, this, i);
	        }
	        return !0;
	      }, ve.prototype.addListener = function (e, t) {
	        return Se(this, e, t, !1);
	      }, ve.prototype.on = ve.prototype.addListener, ve.prototype.prependListener = function (e, t) {
	        return Se(this, e, t, !0);
	      }, ve.prototype.once = function (e, t) {
	        if ('function' != typeof t) throw new TypeError('"listener" argument must be a function');
	        return this.on(e, xe(this, e, t)), this;
	      }, ve.prototype.prependOnceListener = function (e, t) {
	        if ('function' != typeof t) throw new TypeError('"listener" argument must be a function');
	        return this.prependListener(e, xe(this, e, t)), this;
	      }, ve.prototype.removeListener = function (e, t) {
	        var r, n, i, o, a;
	        if ('function' != typeof t) throw new TypeError('"listener" argument must be a function');
	        if (!(n = this._events)) return this;
	        if (!(r = n[e])) return this;
	        if (r === t || r.listener && r.listener === t) 0 == --this._eventsCount ? this._events = new ge() : (delete n[e], n.removeListener && this.emit('removeListener', e, r.listener || t));else if ('function' != typeof r) {
	          for (i = -1, o = r.length; o-- > 0;) if (r[o] === t || r[o].listener && r[o].listener === t) {
	            a = r[o].listener, i = o;
	            break;
	          }
	          if (i < 0) return this;
	          if (1 === r.length) {
	            if (r[0] = void 0, 0 == --this._eventsCount) return this._events = new ge(), this;
	            delete n[e];
	          } else !function (e, t) {
	            for (var r = t, n = r + 1, i = e.length; n < i; r += 1, n += 1) e[r] = e[n];
	            e.pop();
	          }(r, i);
	          n.removeListener && this.emit('removeListener', e, a || t);
	        }
	        return this;
	      }, ve.prototype.removeAllListeners = function (e) {
	        var t, r;
	        if (!(r = this._events)) return this;
	        if (!r.removeListener) return 0 === arguments.length ? (this._events = new ge(), this._eventsCount = 0) : r[e] && (0 == --this._eventsCount ? this._events = new ge() : delete r[e]), this;
	        if (0 === arguments.length) {
	          for (var n, i = Object.keys(r), o = 0; o < i.length; ++o) 'removeListener' !== (n = i[o]) && this.removeAllListeners(n);
	          return this.removeAllListeners('removeListener'), this._events = new ge(), this._eventsCount = 0, this;
	        }
	        if ('function' == typeof (t = r[e])) this.removeListener(e, t);else if (t) do {
	          this.removeListener(e, t[t.length - 1]);
	        } while (t[0]);
	        return this;
	      }, ve.prototype.listeners = function (e) {
	        var t,
	          r = this._events;
	        return r && (t = r[e]) ? 'function' == typeof t ? [t.listener || t] : function (e) {
	          for (var t = new Array(e.length), r = 0; r < t.length; ++r) t[r] = e[r].listener || e[r];
	          return t;
	        }(t) : [];
	      }, ve.listenerCount = function (e, t) {
	        return 'function' == typeof e.listenerCount ? e.listenerCount(t) : Re.call(e, t);
	      }, ve.prototype.listenerCount = Re, ve.prototype.eventNames = function () {
	        return this._eventsCount > 0 ? Reflect.ownKeys(this._events) : [];
	      };
	      var Be = 'function' == typeof Object.create ? function (e, t) {
	          e.super_ = t, e.prototype = Object.create(t.prototype, {
	            constructor: {
	              value: e,
	              enumerable: !1,
	              writable: !0,
	              configurable: !0
	            }
	          });
	        } : function (e, t) {
	          e.super_ = t;
	          var r = function r() {};
	          r.prototype = t.prototype, e.prototype = new r(), e.prototype.constructor = e;
	        },
	        ze = /%[sdj%]/g;
	      function Le(e) {
	        if (!Ze(e)) {
	          for (var t = [], r = 0; r < arguments.length; r++) t.push(De(arguments[r]));
	          return t.join(' ');
	        }
	        r = 1;
	        for (var n = arguments, i = n.length, o = String(e).replace(ze, function (e) {
	            if ('%%' === e) return '%';
	            if (r >= i) return e;
	            switch (e) {
	              case '%s':
	                return String(n[r++]);
	              case '%d':
	                return Number(n[r++]);
	              case '%j':
	                try {
	                  return JSON.stringify(n[r++]);
	                } catch (e) {
	                  return '[Circular]';
	                }
	              default:
	                return e;
	            }
	          }), a = n[r]; r < i; a = n[++r]) Ne(a) || !Ye(a) ? o += ' ' + a : o += ' ' + De(a);
	        return o;
	      }
	      function Te(t, r) {
	        if (je(e.process)) return function () {
	          return Te(t, r).apply(this, arguments);
	        };
	        var n = !1;
	        return function () {
	          return n || (console.error(r), n = !0), t.apply(this, arguments);
	        };
	      }
	      var Me,
	        Ce = {};
	      function De(e, t) {
	        var r = {
	          seen: [],
	          stylize: Pe
	        };
	        return arguments.length >= 3 && (r.depth = arguments[2]), arguments.length >= 4 && (r.colors = arguments[3]), Fe(t) ? r.showHidden = t : t && function (e, t) {
	          if (!t || !Ye(t)) return e;
	          var r = Object.keys(t),
	            n = r.length;
	          for (; n--;) e[r[n]] = t[r[n]];
	        }(r, t), je(r.showHidden) && (r.showHidden = !1), je(r.depth) && (r.depth = 2), je(r.colors) && (r.colors = !1), je(r.customInspect) && (r.customInspect = !0), r.colors && (r.stylize = Ie), Oe(r, e, r.depth);
	      }
	      function Ie(e, t) {
	        var r = De.styles[t];
	        return r ? '[' + De.colors[r][0] + 'm' + e + '[' + De.colors[r][1] + 'm' : e;
	      }
	      function Pe(e, t) {
	        return e;
	      }
	      function Oe(e, t, r) {
	        if (e.customInspect && t && qe(t.inspect) && t.inspect !== De && (!t.constructor || t.constructor.prototype !== t)) {
	          var n = t.inspect(r, e);
	          return Ze(n) || (n = Oe(e, n, r)), n;
	        }
	        var i = function (e, t) {
	          if (je(t)) return e.stylize('undefined', 'undefined');
	          if (Ze(t)) {
	            var r = "'" + JSON.stringify(t).replace(/^"|"$/g, '').replace(/'/g, "\\'").replace(/\\"/g, '"') + "'";
	            return e.stylize(r, 'string');
	          }
	          if (n = t, 'number' == typeof n) return e.stylize('' + t, 'number');
	          var n;
	          if (Fe(t)) return e.stylize('' + t, 'boolean');
	          if (Ne(t)) return e.stylize('null', 'null');
	        }(e, t);
	        if (i) return i;
	        var o = Object.keys(t),
	          a = function (e) {
	            var t = {};
	            return e.forEach(function (e, r) {
	              t[e] = !0;
	            }), t;
	          }(o);
	        if (e.showHidden && (o = Object.getOwnPropertyNames(t)), Xe(t) && (o.indexOf('message') >= 0 || o.indexOf('description') >= 0)) return Ue(t);
	        if (0 === o.length) {
	          if (qe(t)) {
	            var s = t.name ? ': ' + t.name : '';
	            return e.stylize('[Function' + s + ']', 'special');
	          }
	          if (We(t)) return e.stylize(RegExp.prototype.toString.call(t), 'regexp');
	          if (Ke(t)) return e.stylize(Date.prototype.toString.call(t), 'date');
	          if (Xe(t)) return Ue(t);
	        }
	        var h,
	          f,
	          l = '',
	          c = !1,
	          u = ['{', '}'];
	        (h = t, Array.isArray(h) && (c = !0, u = ['[', ']']), qe(t)) && (l = ' [Function' + (t.name ? ': ' + t.name : '') + ']');
	        return We(t) && (l = ' ' + RegExp.prototype.toString.call(t)), Ke(t) && (l = ' ' + Date.prototype.toUTCString.call(t)), Xe(t) && (l = ' ' + Ue(t)), 0 !== o.length || c && 0 != t.length ? r < 0 ? We(t) ? e.stylize(RegExp.prototype.toString.call(t), 'regexp') : e.stylize('[Object]', 'special') : (e.seen.push(t), f = c ? function (e, t, r, n, i) {
	          for (var o = [], a = 0, s = t.length; a < s; ++a) Ge(t, String(a)) ? o.push(He(e, t, r, n, String(a), !0)) : o.push('');
	          return i.forEach(function (i) {
	            i.match(/^\d+$/) || o.push(He(e, t, r, n, i, !0));
	          }), o;
	        }(e, t, r, a, o) : o.map(function (n) {
	          return He(e, t, r, a, n, c);
	        }), e.seen.pop(), function (e, t, r) {
	          if (e.reduce(function (e, t) {
	            return t.indexOf('\n'), e + t.replace(/\u001b\[\d\d?m/g, '').length + 1;
	          }, 0) > 60) return r[0] + ('' === t ? '' : t + '\n ') + ' ' + e.join(',\n  ') + ' ' + r[1];
	          return r[0] + t + ' ' + e.join(', ') + ' ' + r[1];
	        }(f, l, u)) : u[0] + l + u[1];
	      }
	      function Ue(e) {
	        return '[' + Error.prototype.toString.call(e) + ']';
	      }
	      function He(e, t, r, n, i, o) {
	        var a, s, h;
	        if ((h = Object.getOwnPropertyDescriptor(t, i) || {
	          value: t[i]
	        }).get ? s = h.set ? e.stylize('[Getter/Setter]', 'special') : e.stylize('[Getter]', 'special') : h.set && (s = e.stylize('[Setter]', 'special')), Ge(n, i) || (a = '[' + i + ']'), s || (e.seen.indexOf(h.value) < 0 ? (s = Ne(r) ? Oe(e, h.value, null) : Oe(e, h.value, r - 1)).indexOf('\n') > -1 && (s = o ? s.split('\n').map(function (e) {
	          return '  ' + e;
	        }).join('\n').substr(2) : '\n' + s.split('\n').map(function (e) {
	          return '   ' + e;
	        }).join('\n')) : s = e.stylize('[Circular]', 'special')), je(a)) {
	          if (o && i.match(/^\d+$/)) return s;
	          (a = JSON.stringify('' + i)).match(/^"([a-zA-Z_][a-zA-Z_0-9]*)"$/) ? (a = a.substr(1, a.length - 2), a = e.stylize(a, 'name')) : (a = a.replace(/'/g, "\\'").replace(/\\"/g, '"').replace(/(^"|"$)/g, "'"), a = e.stylize(a, 'string'));
	        }
	        return a + ': ' + s;
	      }
	      function Fe(e) {
	        return 'boolean' == typeof e;
	      }
	      function Ne(e) {
	        return null === e;
	      }
	      function Ze(e) {
	        return 'string' == typeof e;
	      }
	      function je(e) {
	        return void 0 === e;
	      }
	      function We(e) {
	        return Ye(e) && '[object RegExp]' === Ve(e);
	      }
	      function Ye(e) {
	        return 'object' == _typeof(e) && null !== e;
	      }
	      function Ke(e) {
	        return Ye(e) && '[object Date]' === Ve(e);
	      }
	      function Xe(e) {
	        return Ye(e) && ('[object Error]' === Ve(e) || e instanceof Error);
	      }
	      function qe(e) {
	        return 'function' == typeof e;
	      }
	      function Ve(e) {
	        return Object.prototype.toString.call(e);
	      }
	      function Ge(e, t) {
	        return Object.prototype.hasOwnProperty.call(e, t);
	      }
	      function $e() {
	        this.head = null, this.tail = null, this.length = 0;
	      }
	      De.colors = {
	        bold: [1, 22],
	        italic: [3, 23],
	        underline: [4, 24],
	        inverse: [7, 27],
	        white: [37, 39],
	        grey: [90, 39],
	        black: [30, 39],
	        blue: [34, 39],
	        cyan: [36, 39],
	        green: [32, 39],
	        magenta: [35, 39],
	        red: [31, 39],
	        yellow: [33, 39]
	      }, De.styles = {
	        special: 'cyan',
	        number: 'yellow',
	        "boolean": 'yellow',
	        undefined: 'grey',
	        "null": 'bold',
	        string: 'green',
	        date: 'magenta',
	        regexp: 'red'
	      }, $e.prototype.push = function (e) {
	        var t = {
	          data: e,
	          next: null
	        };
	        this.length > 0 ? this.tail.next = t : this.head = t, this.tail = t, ++this.length;
	      }, $e.prototype.unshift = function (e) {
	        var t = {
	          data: e,
	          next: this.head
	        };
	        0 === this.length && (this.tail = t), this.head = t, ++this.length;
	      }, $e.prototype.shift = function () {
	        if (0 !== this.length) {
	          var e = this.head.data;
	          return 1 === this.length ? this.head = this.tail = null : this.head = this.head.next, --this.length, e;
	        }
	      }, $e.prototype.clear = function () {
	        this.head = this.tail = null, this.length = 0;
	      }, $e.prototype.join = function (e) {
	        if (0 === this.length) return '';
	        for (var t = this.head, r = '' + t.data; t = t.next;) r += e + t.data;
	        return r;
	      }, $e.prototype.concat = function (e) {
	        if (0 === this.length) return p.alloc(0);
	        if (1 === this.length) return this.head.data;
	        for (var t = p.allocUnsafe(e >>> 0), r = this.head, n = 0; r;) r.data.copy(t, n), n += r.data.length, r = r.next;
	        return t;
	      };
	      var Je = p.isEncoding || function (e) {
	        switch (e && e.toLowerCase()) {
	          case 'hex':
	          case 'utf8':
	          case 'utf-8':
	          case 'ascii':
	          case 'binary':
	          case 'base64':
	          case 'ucs2':
	          case 'ucs-2':
	          case 'utf16le':
	          case 'utf-16le':
	          case 'raw':
	            return !0;
	          default:
	            return !1;
	        }
	      };
	      function Qe(e) {
	        switch (this.encoding = (e || 'utf8').toLowerCase().replace(/[-_]/, ''), function (e) {
	          if (e && !Je(e)) throw new Error('Unknown encoding: ' + e);
	        }(e), this.encoding) {
	          case 'utf8':
	            this.surrogateSize = 3;
	            break;
	          case 'ucs2':
	          case 'utf16le':
	            this.surrogateSize = 2, this.detectIncompleteChar = tt;
	            break;
	          case 'base64':
	            this.surrogateSize = 3, this.detectIncompleteChar = rt;
	            break;
	          default:
	            return void (this.write = et);
	        }
	        this.charBuffer = new p(6), this.charReceived = 0, this.charLength = 0;
	      }
	      function et(e) {
	        return e.toString(this.encoding);
	      }
	      function tt(e) {
	        this.charReceived = e.length % 2, this.charLength = this.charReceived ? 2 : 0;
	      }
	      function rt(e) {
	        this.charReceived = e.length % 3, this.charLength = this.charReceived ? 3 : 0;
	      }
	      Qe.prototype.write = function (e) {
	        for (var t = ''; this.charLength;) {
	          var r = e.length >= this.charLength - this.charReceived ? this.charLength - this.charReceived : e.length;
	          if (e.copy(this.charBuffer, this.charReceived, 0, r), this.charReceived += r, this.charReceived < this.charLength) return '';
	          if (e = e.slice(r, e.length), !((i = (t = this.charBuffer.slice(0, this.charLength).toString(this.encoding)).charCodeAt(t.length - 1)) >= 55296 && i <= 56319)) {
	            if (this.charReceived = this.charLength = 0, 0 === e.length) return t;
	            break;
	          }
	          this.charLength += this.surrogateSize, t = '';
	        }
	        this.detectIncompleteChar(e);
	        var n = e.length;
	        this.charLength && (e.copy(this.charBuffer, 0, e.length - this.charReceived, n), n -= this.charReceived);
	        var i;
	        n = (t += e.toString(this.encoding, 0, n)).length - 1;
	        if ((i = t.charCodeAt(n)) >= 55296 && i <= 56319) {
	          var o = this.surrogateSize;
	          return this.charLength += o, this.charReceived += o, this.charBuffer.copy(this.charBuffer, o, 0, o), e.copy(this.charBuffer, 0, 0, o), t.substring(0, n);
	        }
	        return t;
	      }, Qe.prototype.detectIncompleteChar = function (e) {
	        for (var t = e.length >= 3 ? 3 : e.length; t > 0; t--) {
	          var r = e[e.length - t];
	          if (1 == t && r >> 5 == 6) {
	            this.charLength = 2;
	            break;
	          }
	          if (t <= 2 && r >> 4 == 14) {
	            this.charLength = 3;
	            break;
	          }
	          if (t <= 3 && r >> 3 == 30) {
	            this.charLength = 4;
	            break;
	          }
	        }
	        this.charReceived = t;
	      }, Qe.prototype.end = function (e) {
	        var t = '';
	        if (e && e.length && (t = this.write(e)), this.charReceived) {
	          var r = this.charReceived,
	            n = this.charBuffer,
	            i = this.encoding;
	          t += n.slice(0, r).toString(i);
	        }
	        return t;
	      }, ot.ReadableState = it;
	      var nt = function (e) {
	        je(Me) && (Me = ''), e = e.toUpperCase(), Ce[e] || (new RegExp('\\b' + e + '\\b', 'i').test(Me) ? Ce[e] = function () {
	          var t = Le.apply(null, arguments);
	          console.error('%s %d: %s', e, 0, t);
	        } : Ce[e] = function () {});
	        return Ce[e];
	      }('stream');
	      function it(e, t) {
	        e = e || {}, this.objectMode = !!e.objectMode, t instanceof Ct && (this.objectMode = this.objectMode || !!e.readableObjectMode);
	        var r = e.highWaterMark,
	          n = this.objectMode ? 16 : 16384;
	        this.highWaterMark = r || 0 === r ? r : n, this.highWaterMark = ~~this.highWaterMark, this.buffer = new $e(), this.length = 0, this.pipes = null, this.pipesCount = 0, this.flowing = null, this.ended = !1, this.endEmitted = !1, this.reading = !1, this.sync = !0, this.needReadable = !1, this.emittedReadable = !1, this.readableListening = !1, this.resumeScheduled = !1, this.defaultEncoding = e.defaultEncoding || 'utf8', this.ranOut = !1, this.awaitDrain = 0, this.readingMore = !1, this.decoder = null, this.encoding = null, e.encoding && (this.decoder = new Qe(e.encoding), this.encoding = e.encoding);
	      }
	      function ot(e) {
	        if (!(this instanceof ot)) return new ot(e);
	        this._readableState = new it(e, this), this.readable = !0, e && 'function' == typeof e.read && (this._read = e.read), ve.call(this);
	      }
	      function at(e, t, r, n, i) {
	        var o = function (e, t) {
	          var r = null;
	          $(t) || 'string' == typeof t || null == t || e.objectMode || (r = new TypeError('Invalid non-string/buffer chunk'));
	          return r;
	        }(t, r);
	        if (o) e.emit('error', o);else if (null === r) t.reading = !1, function (e, t) {
	          if (t.ended) return;
	          if (t.decoder) {
	            var r = t.decoder.end();
	            r && r.length && (t.buffer.push(r), t.length += t.objectMode ? 1 : r.length);
	          }
	          t.ended = !0, ft(e);
	        }(e, t);else if (t.objectMode || r && r.length > 0) {
	          if (t.ended && !i) {
	            var a = new Error('stream.push() after EOF');
	            e.emit('error', a);
	          } else if (t.endEmitted && i) {
	            var s = new Error('stream.unshift() after end event');
	            e.emit('error', s);
	          } else {
	            var h;
	            !t.decoder || i || n || (r = t.decoder.write(r), h = !t.objectMode && 0 === r.length), i || (t.reading = !1), h || (t.flowing && 0 === t.length && !t.sync ? (e.emit('data', r), e.read(0)) : (t.length += t.objectMode ? 1 : r.length, i ? t.buffer.unshift(r) : t.buffer.push(r), t.needReadable && ft(e))), function (e, t) {
	              t.readingMore || (t.readingMore = !0, de(ct, e, t));
	            }(e, t);
	          }
	        } else i || (t.reading = !1);
	        return function (e) {
	          return !e.ended && (e.needReadable || e.length < e.highWaterMark || 0 === e.length);
	        }(t);
	      }
	      Be(ot, ve), ot.prototype.push = function (e, t) {
	        var r = this._readableState;
	        return r.objectMode || 'string' != typeof e || (t = t || r.defaultEncoding) !== r.encoding && (e = p.from(e, t), t = ''), at(this, r, e, t, !1);
	      }, ot.prototype.unshift = function (e) {
	        return at(this, this._readableState, e, '', !0);
	      }, ot.prototype.isPaused = function () {
	        return !1 === this._readableState.flowing;
	      }, ot.prototype.setEncoding = function (e) {
	        return this._readableState.decoder = new Qe(e), this._readableState.encoding = e, this;
	      };
	      var st = 8388608;
	      function ht(e, t) {
	        return e <= 0 || 0 === t.length && t.ended ? 0 : t.objectMode ? 1 : e != e ? t.flowing && t.length ? t.buffer.head.data.length : t.length : (e > t.highWaterMark && (t.highWaterMark = function (e) {
	          return e >= st ? e = st : (e--, e |= e >>> 1, e |= e >>> 2, e |= e >>> 4, e |= e >>> 8, e |= e >>> 16, e++), e;
	        }(e)), e <= t.length ? e : t.ended ? t.length : (t.needReadable = !0, 0));
	      }
	      function ft(e) {
	        var t = e._readableState;
	        t.needReadable = !1, t.emittedReadable || (nt('emitReadable', t.flowing), t.emittedReadable = !0, t.sync ? de(lt, e) : lt(e));
	      }
	      function lt(e) {
	        nt('emit readable'), e.emit('readable'), pt(e);
	      }
	      function ct(e, t) {
	        for (var r = t.length; !t.reading && !t.flowing && !t.ended && t.length < t.highWaterMark && (nt('maybeReadMore read 0'), e.read(0), r !== t.length);) r = t.length;
	        t.readingMore = !1;
	      }
	      function ut(e) {
	        nt('readable nexttick read 0'), e.read(0);
	      }
	      function dt(e, t) {
	        t.reading || (nt('resume read 0'), e.read(0)), t.resumeScheduled = !1, t.awaitDrain = 0, e.emit('resume'), pt(e), t.flowing && !t.reading && e.read(0);
	      }
	      function pt(e) {
	        var t = e._readableState;
	        for (nt('flow', t.flowing); t.flowing && null !== e.read(););
	      }
	      function _t(e, t) {
	        return 0 === t.length ? null : (t.objectMode ? r = t.buffer.shift() : !e || e >= t.length ? (r = t.decoder ? t.buffer.join('') : 1 === t.buffer.length ? t.buffer.head.data : t.buffer.concat(t.length), t.buffer.clear()) : r = function (e, t, r) {
	          var n;
	          e < t.head.data.length ? (n = t.head.data.slice(0, e), t.head.data = t.head.data.slice(e)) : n = e === t.head.data.length ? t.shift() : r ? function (e, t) {
	            var r = t.head,
	              n = 1,
	              i = r.data;
	            e -= i.length;
	            for (; r = r.next;) {
	              var o = r.data,
	                a = e > o.length ? o.length : e;
	              if (a === o.length ? i += o : i += o.slice(0, e), 0 === (e -= a)) {
	                a === o.length ? (++n, r.next ? t.head = r.next : t.head = t.tail = null) : (t.head = r, r.data = o.slice(a));
	                break;
	              }
	              ++n;
	            }
	            return t.length -= n, i;
	          }(e, t) : function (e, t) {
	            var r = p.allocUnsafe(e),
	              n = t.head,
	              i = 1;
	            n.data.copy(r), e -= n.data.length;
	            for (; n = n.next;) {
	              var o = n.data,
	                a = e > o.length ? o.length : e;
	              if (o.copy(r, r.length - e, 0, a), 0 === (e -= a)) {
	                a === o.length ? (++i, n.next ? t.head = n.next : t.head = t.tail = null) : (t.head = n, n.data = o.slice(a));
	                break;
	              }
	              ++i;
	            }
	            return t.length -= i, r;
	          }(e, t);
	          return n;
	        }(e, t.buffer, t.decoder), r);
	        var r;
	      }
	      function gt(e) {
	        var t = e._readableState;
	        if (t.length > 0) throw new Error('"endReadable()" called on non-empty stream');
	        t.endEmitted || (t.ended = !0, de(vt, t, e));
	      }
	      function vt(e, t) {
	        e.endEmitted || 0 !== e.length || (e.endEmitted = !0, t.readable = !1, t.emit('end'));
	      }
	      function wt(e, t) {
	        for (var r = 0, n = e.length; r < n; r++) if (e[r] === t) return r;
	        return -1;
	      }
	      function bt() {}
	      function yt(e, t, r) {
	        this.chunk = e, this.encoding = t, this.callback = r, this.next = null;
	      }
	      function mt(e, t) {
	        Object.defineProperty(this, 'buffer', {
	          get: Te(function () {
	            return this.getBuffer();
	          }, '_writableState.buffer is deprecated. Use _writableState.getBuffer instead.')
	        }), e = e || {}, this.objectMode = !!e.objectMode, t instanceof Ct && (this.objectMode = this.objectMode || !!e.writableObjectMode);
	        var r = e.highWaterMark,
	          n = this.objectMode ? 16 : 16384;
	        this.highWaterMark = r || 0 === r ? r : n, this.highWaterMark = ~~this.highWaterMark, this.needDrain = !1, this.ending = !1, this.ended = !1, this.finished = !1;
	        var i = !1 === e.decodeStrings;
	        this.decodeStrings = !i, this.defaultEncoding = e.defaultEncoding || 'utf8', this.length = 0, this.writing = !1, this.corked = 0, this.sync = !0, this.bufferProcessing = !1, this.onwrite = function (e) {
	          !function (e, t) {
	            var r = e._writableState,
	              n = r.sync,
	              i = r.writecb;
	            if (function (e) {
	              e.writing = !1, e.writecb = null, e.length -= e.writelen, e.writelen = 0;
	            }(r), t) !function (e, t, r, n, i) {
	              --t.pendingcb, r ? de(i, n) : i(n);
	              e._writableState.errorEmitted = !0, e.emit('error', n);
	            }(e, r, n, t, i);else {
	              var o = Rt(r);
	              o || r.corked || r.bufferProcessing || !r.bufferedRequest || xt(e, r), n ? de(St, e, r, o, i) : St(e, r, o, i);
	            }
	          }(t, e);
	        }, this.writecb = null, this.writelen = 0, this.bufferedRequest = null, this.lastBufferedRequest = null, this.pendingcb = 0, this.prefinished = !1, this.errorEmitted = !1, this.bufferedRequestCount = 0, this.corkedRequestsFree = new zt(this);
	      }
	      function kt(e) {
	        if (!(this instanceof kt || this instanceof Ct)) return new kt(e);
	        this._writableState = new mt(e, this), this.writable = !0, e && ('function' == typeof e.write && (this._write = e.write), 'function' == typeof e.writev && (this._writev = e.writev)), ve.call(this);
	      }
	      function Et(e, t, r, n, i, o, a) {
	        t.writelen = n, t.writecb = a, t.writing = !0, t.sync = !0, r ? e._writev(i, t.onwrite) : e._write(i, o, t.onwrite), t.sync = !1;
	      }
	      function St(e, t, r, n) {
	        r || function (e, t) {
	          0 === t.length && t.needDrain && (t.needDrain = !1, e.emit('drain'));
	        }(e, t), t.pendingcb--, n(), Bt(e, t);
	      }
	      function xt(e, t) {
	        t.bufferProcessing = !0;
	        var r = t.bufferedRequest;
	        if (e._writev && r && r.next) {
	          var n = t.bufferedRequestCount,
	            i = new Array(n),
	            o = t.corkedRequestsFree;
	          o.entry = r;
	          for (var a = 0; r;) i[a] = r, r = r.next, a += 1;
	          Et(e, t, !0, t.length, i, '', o.finish), t.pendingcb++, t.lastBufferedRequest = null, o.next ? (t.corkedRequestsFree = o.next, o.next = null) : t.corkedRequestsFree = new zt(t);
	        } else {
	          for (; r;) {
	            var s = r.chunk,
	              h = r.encoding,
	              f = r.callback;
	            if (Et(e, t, !1, t.objectMode ? 1 : s.length, s, h, f), r = r.next, t.writing) break;
	          }
	          null === r && (t.lastBufferedRequest = null);
	        }
	        t.bufferedRequestCount = 0, t.bufferedRequest = r, t.bufferProcessing = !1;
	      }
	      function Rt(e) {
	        return e.ending && 0 === e.length && null === e.bufferedRequest && !e.finished && !e.writing;
	      }
	      function At(e, t) {
	        t.prefinished || (t.prefinished = !0, e.emit('prefinish'));
	      }
	      function Bt(e, t) {
	        var r = Rt(t);
	        return r && (0 === t.pendingcb ? (At(e, t), t.finished = !0, e.emit('finish')) : At(e, t)), r;
	      }
	      function zt(e) {
	        var t = this;
	        this.next = null, this.entry = null, this.finish = function (r) {
	          var n = t.entry;
	          for (t.entry = null; n;) {
	            var i = n.callback;
	            e.pendingcb--, i(r), n = n.next;
	          }
	          e.corkedRequestsFree ? e.corkedRequestsFree.next = t : e.corkedRequestsFree = t;
	        };
	      }
	      ot.prototype.read = function (e) {
	        nt('read', e), e = parseInt(e, 10);
	        var t = this._readableState,
	          r = e;
	        if (0 !== e && (t.emittedReadable = !1), 0 === e && t.needReadable && (t.length >= t.highWaterMark || t.ended)) return nt('read: emitReadable', t.length, t.ended), 0 === t.length && t.ended ? gt(this) : ft(this), null;
	        if (0 === (e = ht(e, t)) && t.ended) return 0 === t.length && gt(this), null;
	        var n,
	          i = t.needReadable;
	        return nt('need readable', i), (0 === t.length || t.length - e < t.highWaterMark) && nt('length less than watermark', i = !0), t.ended || t.reading ? nt('reading or ended', i = !1) : i && (nt('do read'), t.reading = !0, t.sync = !0, 0 === t.length && (t.needReadable = !0), this._read(t.highWaterMark), t.sync = !1, t.reading || (e = ht(r, t))), null === (n = e > 0 ? _t(e, t) : null) ? (t.needReadable = !0, e = 0) : t.length -= e, 0 === t.length && (t.ended || (t.needReadable = !0), r !== e && t.ended && gt(this)), null !== n && this.emit('data', n), n;
	      }, ot.prototype._read = function (e) {
	        this.emit('error', new Error('not implemented'));
	      }, ot.prototype.pipe = function (e, t) {
	        var r = this,
	          n = this._readableState;
	        switch (n.pipesCount) {
	          case 0:
	            n.pipes = e;
	            break;
	          case 1:
	            n.pipes = [n.pipes, e];
	            break;
	          default:
	            n.pipes.push(e);
	        }
	        n.pipesCount += 1, nt('pipe count=%d opts=%j', n.pipesCount, t);
	        var i = !t || !1 !== t.end ? a : f;
	        function o(e) {
	          nt('onunpipe'), e === r && f();
	        }
	        function a() {
	          nt('onend'), e.end();
	        }
	        n.endEmitted ? de(i) : r.once('end', i), e.on('unpipe', o);
	        var s = function (e) {
	          return function () {
	            var t = e._readableState;
	            nt('pipeOnDrain', t.awaitDrain), t.awaitDrain && t.awaitDrain--, 0 === t.awaitDrain && e.listeners('data').length && (t.flowing = !0, pt(e));
	          };
	        }(r);
	        e.on('drain', s);
	        var h = !1;
	        function f() {
	          nt('cleanup'), e.removeListener('close', d), e.removeListener('finish', p), e.removeListener('drain', s), e.removeListener('error', u), e.removeListener('unpipe', o), r.removeListener('end', a), r.removeListener('end', f), r.removeListener('data', c), h = !0, !n.awaitDrain || e._writableState && !e._writableState.needDrain || s();
	        }
	        var l = !1;
	        function c(t) {
	          nt('ondata'), l = !1, !1 !== e.write(t) || l || ((1 === n.pipesCount && n.pipes === e || n.pipesCount > 1 && -1 !== wt(n.pipes, e)) && !h && (nt('false write response, pause', r._readableState.awaitDrain), r._readableState.awaitDrain++, l = !0), r.pause());
	        }
	        function u(t) {
	          var r;
	          nt('onerror', t), _(), e.removeListener('error', u), 0 === (r = 'error', e.listeners(r).length) && e.emit('error', t);
	        }
	        function d() {
	          e.removeListener('finish', p), _();
	        }
	        function p() {
	          nt('onfinish'), e.removeListener('close', d), _();
	        }
	        function _() {
	          nt('unpipe'), r.unpipe(e);
	        }
	        return r.on('data', c), function (e, t, r) {
	          if ('function' == typeof e.prependListener) return e.prependListener(t, r);
	          e._events && e._events[t] ? Array.isArray(e._events[t]) ? e._events[t].unshift(r) : e._events[t] = [r, e._events[t]] : e.on(t, r);
	        }(e, 'error', u), e.once('close', d), e.once('finish', p), e.emit('pipe', r), n.flowing || (nt('pipe resume'), r.resume()), e;
	      }, ot.prototype.unpipe = function (e) {
	        var t = this._readableState;
	        if (0 === t.pipesCount) return this;
	        if (1 === t.pipesCount) return e && e !== t.pipes ? this : (e || (e = t.pipes), t.pipes = null, t.pipesCount = 0, t.flowing = !1, e && e.emit('unpipe', this), this);
	        if (!e) {
	          var r = t.pipes,
	            n = t.pipesCount;
	          t.pipes = null, t.pipesCount = 0, t.flowing = !1;
	          for (var i = 0; i < n; i++) r[i].emit('unpipe', this);
	          return this;
	        }
	        var o = wt(t.pipes, e);
	        return -1 === o ? this : (t.pipes.splice(o, 1), t.pipesCount -= 1, 1 === t.pipesCount && (t.pipes = t.pipes[0]), e.emit('unpipe', this), this);
	      }, ot.prototype.on = function (e, t) {
	        var r = ve.prototype.on.call(this, e, t);
	        if ('data' === e) !1 !== this._readableState.flowing && this.resume();else if ('readable' === e) {
	          var n = this._readableState;
	          n.endEmitted || n.readableListening || (n.readableListening = n.needReadable = !0, n.emittedReadable = !1, n.reading ? n.length && ft(this) : de(ut, this));
	        }
	        return r;
	      }, ot.prototype.addListener = ot.prototype.on, ot.prototype.resume = function () {
	        var e = this._readableState;
	        return e.flowing || (nt('resume'), e.flowing = !0, function (e, t) {
	          t.resumeScheduled || (t.resumeScheduled = !0, de(dt, e, t));
	        }(this, e)), this;
	      }, ot.prototype.pause = function () {
	        return nt('call pause flowing=%j', this._readableState.flowing), !1 !== this._readableState.flowing && (nt('pause'), this._readableState.flowing = !1, this.emit('pause')), this;
	      }, ot.prototype.wrap = function (e) {
	        var t = this._readableState,
	          r = !1,
	          n = this;
	        for (var i in e.on('end', function () {
	          if (nt('wrapped end'), t.decoder && !t.ended) {
	            var e = t.decoder.end();
	            e && e.length && n.push(e);
	          }
	          n.push(null);
	        }), e.on('data', function (i) {
	          (nt('wrapped data'), t.decoder && (i = t.decoder.write(i)), t.objectMode && null == i) || (t.objectMode || i && i.length) && (n.push(i) || (r = !0, e.pause()));
	        }), e) void 0 === this[i] && 'function' == typeof e[i] && (this[i] = function (t) {
	          return function () {
	            return e[t].apply(e, arguments);
	          };
	        }(i));
	        return function (e, t) {
	          for (var r = 0, n = e.length; r < n; r++) t(e[r], r);
	        }(['error', 'close', 'destroy', 'pause', 'resume'], function (t) {
	          e.on(t, n.emit.bind(n, t));
	        }), n._read = function (t) {
	          nt('wrapped _read', t), r && (r = !1, e.resume());
	        }, n;
	      }, ot._fromList = _t, kt.WritableState = mt, Be(kt, ve), mt.prototype.getBuffer = function () {
	        for (var e = this.bufferedRequest, t = []; e;) t.push(e), e = e.next;
	        return t;
	      }, kt.prototype.pipe = function () {
	        this.emit('error', new Error('Cannot pipe, not readable'));
	      }, kt.prototype.write = function (e, t, r) {
	        var n = this._writableState,
	          i = !1;
	        return 'function' == typeof t && (r = t, t = null), p.isBuffer(e) ? t = 'buffer' : t || (t = n.defaultEncoding), 'function' != typeof r && (r = bt), n.ended ? function (e, t) {
	          var r = new Error('write after end');
	          e.emit('error', r), de(t, r);
	        }(this, r) : function (e, t, r, n) {
	          var i = !0,
	            o = !1;
	          return null === r ? o = new TypeError('May not write null values to stream') : p.isBuffer(r) || 'string' == typeof r || void 0 === r || t.objectMode || (o = new TypeError('Invalid non-string/buffer chunk')), o && (e.emit('error', o), de(n, o), i = !1), i;
	        }(this, n, e, r) && (n.pendingcb++, i = function (e, t, r, n, i) {
	          r = function (e, t, r) {
	            return e.objectMode || !1 === e.decodeStrings || 'string' != typeof t || (t = p.from(t, r)), t;
	          }(t, r, n), p.isBuffer(r) && (n = 'buffer');
	          var o = t.objectMode ? 1 : r.length;
	          t.length += o;
	          var a = t.length < t.highWaterMark;
	          a || (t.needDrain = !0);
	          if (t.writing || t.corked) {
	            var s = t.lastBufferedRequest;
	            t.lastBufferedRequest = new yt(r, n, i), s ? s.next = t.lastBufferedRequest : t.bufferedRequest = t.lastBufferedRequest, t.bufferedRequestCount += 1;
	          } else Et(e, t, !1, o, r, n, i);
	          return a;
	        }(this, n, e, t, r)), i;
	      }, kt.prototype.cork = function () {
	        this._writableState.corked++;
	      }, kt.prototype.uncork = function () {
	        var e = this._writableState;
	        e.corked && (e.corked--, e.writing || e.corked || e.finished || e.bufferProcessing || !e.bufferedRequest || xt(this, e));
	      }, kt.prototype.setDefaultEncoding = function (e) {
	        if ('string' == typeof e && (e = e.toLowerCase()), !(['hex', 'utf8', 'utf-8', 'ascii', 'binary', 'base64', 'ucs2', 'ucs-2', 'utf16le', 'utf-16le', 'raw'].indexOf((e + '').toLowerCase()) > -1)) throw new TypeError('Unknown encoding: ' + e);
	        return this._writableState.defaultEncoding = e, this;
	      }, kt.prototype._write = function (e, t, r) {
	        r(new Error('not implemented'));
	      }, kt.prototype._writev = null, kt.prototype.end = function (e, t, r) {
	        var n = this._writableState;
	        'function' == typeof e ? (r = e, e = null, t = null) : 'function' == typeof t && (r = t, t = null), null != e && this.write(e, t), n.corked && (n.corked = 1, this.uncork()), n.ending || n.finished || function (e, t, r) {
	          t.ending = !0, Bt(e, t), r && (t.finished ? de(r) : e.once('finish', r));
	          t.ended = !0, e.writable = !1;
	        }(this, n, r);
	      }, Be(Ct, ot);
	      for (var Lt = Object.keys(kt.prototype), Tt = 0; Tt < Lt.length; Tt++) {
	        var Mt = Lt[Tt];
	        Ct.prototype[Mt] || (Ct.prototype[Mt] = kt.prototype[Mt]);
	      }
	      function Ct(e) {
	        if (!(this instanceof Ct)) return new Ct(e);
	        ot.call(this, e), kt.call(this, e), e && !1 === e.readable && (this.readable = !1), e && !1 === e.writable && (this.writable = !1), this.allowHalfOpen = !0, e && !1 === e.allowHalfOpen && (this.allowHalfOpen = !1), this.once('end', Dt);
	      }
	      function Dt() {
	        this.allowHalfOpen || this._writableState.ended || de(It, this);
	      }
	      function It(e) {
	        e.end();
	      }
	      function Pt(e) {
	        this.afterTransform = function (t, r) {
	          return function (e, t, r) {
	            var n = e._transformState;
	            n.transforming = !1;
	            var i = n.writecb;
	            if (!i) return e.emit('error', new Error('no writecb in Transform class'));
	            n.writechunk = null, n.writecb = null, null != r && e.push(r);
	            i(t);
	            var o = e._readableState;
	            o.reading = !1, (o.needReadable || o.length < o.highWaterMark) && e._read(o.highWaterMark);
	          }(e, t, r);
	        }, this.needTransform = !1, this.transforming = !1, this.writecb = null, this.writechunk = null, this.writeencoding = null;
	      }
	      function Ot(e) {
	        if (!(this instanceof Ot)) return new Ot(e);
	        Ct.call(this, e), this._transformState = new Pt(this);
	        var t = this;
	        this._readableState.needReadable = !0, this._readableState.sync = !1, e && ('function' == typeof e.transform && (this._transform = e.transform), 'function' == typeof e.flush && (this._flush = e.flush)), this.once('prefinish', function () {
	          'function' == typeof this._flush ? this._flush(function (e) {
	            Ut(t, e);
	          }) : Ut(t);
	        });
	      }
	      function Ut(e, t) {
	        if (t) return e.emit('error', t);
	        var r = e._writableState,
	          n = e._transformState;
	        if (r.length) throw new Error('Calling transform done when ws.length != 0');
	        if (n.transforming) throw new Error('Calling transform done when still transforming');
	        return e.push(null);
	      }
	      function Ht(e) {
	        if (!(this instanceof Ht)) return new Ht(e);
	        Ot.call(this, e);
	      }
	      function Ft() {
	        ve.call(this);
	      }
	      Be(Ot, Ct), Ot.prototype.push = function (e, t) {
	        return this._transformState.needTransform = !1, Ct.prototype.push.call(this, e, t);
	      }, Ot.prototype._transform = function (e, t, r) {
	        throw new Error('Not implemented');
	      }, Ot.prototype._write = function (e, t, r) {
	        var n = this._transformState;
	        if (n.writecb = r, n.writechunk = e, n.writeencoding = t, !n.transforming) {
	          var i = this._readableState;
	          (n.needTransform || i.needReadable || i.length < i.highWaterMark) && this._read(i.highWaterMark);
	        }
	      }, Ot.prototype._read = function (e) {
	        var t = this._transformState;
	        null !== t.writechunk && t.writecb && !t.transforming ? (t.transforming = !0, this._transform(t.writechunk, t.writeencoding, t.afterTransform)) : t.needTransform = !0;
	      }, Be(Ht, Ot), Ht.prototype._transform = function (e, t, r) {
	        r(null, e);
	      }, Be(Ft, ve), Ft.Readable = ot, Ft.Writable = kt, Ft.Duplex = Ct, Ft.Transform = Ot, Ft.PassThrough = Ht, Ft.Stream = Ft, Ft.prototype.pipe = function (e, t) {
	        var r = this;
	        function n(t) {
	          e.writable && !1 === e.write(t) && r.pause && r.pause();
	        }
	        function i() {
	          r.readable && r.resume && r.resume();
	        }
	        r.on('data', n), e.on('drain', i), e._isStdio || t && !1 === t.end || (r.on('end', a), r.on('close', s));
	        var o = !1;
	        function a() {
	          o || (o = !0, e.end());
	        }
	        function s() {
	          o || (o = !0, 'function' == typeof e.destroy && e.destroy());
	        }
	        function h(e) {
	          if (f(), 0 === ve.listenerCount(this, 'error')) throw e;
	        }
	        function f() {
	          r.removeListener('data', n), e.removeListener('drain', i), r.removeListener('end', a), r.removeListener('close', s), r.removeListener('error', h), e.removeListener('error', h), r.removeListener('end', f), r.removeListener('close', f), e.removeListener('close', f);
	        }
	        return r.on('error', h), e.on('error', h), r.on('end', f), r.on('close', f), e.on('close', f), e.emit('pipe', r), e;
	      };
	      var Nt = {
	        2: 'need dictionary',
	        1: 'stream end',
	        0: '',
	        '-1': 'file error',
	        '-2': 'stream error',
	        '-3': 'data error',
	        '-4': 'insufficient memory',
	        '-5': 'buffer error',
	        '-6': 'incompatible version'
	      };
	      function Zt() {
	        this.input = null, this.next_in = 0, this.avail_in = 0, this.total_in = 0, this.output = null, this.next_out = 0, this.avail_out = 0, this.total_out = 0, this.msg = '', this.state = null, this.data_type = 2, this.adler = 0;
	      }
	      function jt(e, t, r, n, i) {
	        if (t.subarray && e.subarray) e.set(t.subarray(r, r + n), i);else for (var o = 0; o < n; o++) e[i + o] = t[r + o];
	      }
	      var Wt = Uint8Array,
	        Yt = Uint16Array,
	        Kt = Int32Array,
	        Xt = 4,
	        qt = 0,
	        Vt = 1,
	        Gt = 2;
	      function $t(e) {
	        for (var t = e.length; --t >= 0;) e[t] = 0;
	      }
	      var Jt = 0,
	        Qt = 1,
	        er = 2,
	        tr = 29,
	        rr = 256,
	        nr = rr + 1 + tr,
	        ir = 30,
	        or = 19,
	        ar = 2 * nr + 1,
	        sr = 15,
	        hr = 16,
	        fr = 7,
	        lr = 256,
	        cr = 16,
	        ur = 17,
	        dr = 18,
	        pr = [0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 2, 2, 2, 2, 3, 3, 3, 3, 4, 4, 4, 4, 5, 5, 5, 5, 0],
	        _r = [0, 0, 0, 0, 1, 1, 2, 2, 3, 3, 4, 4, 5, 5, 6, 6, 7, 7, 8, 8, 9, 9, 10, 10, 11, 11, 12, 12, 13, 13],
	        gr = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 3, 7],
	        vr = [16, 17, 18, 0, 8, 7, 9, 6, 10, 5, 11, 4, 12, 3, 13, 2, 14, 1, 15],
	        wr = new Array(2 * (nr + 2));
	      $t(wr);
	      var br = new Array(2 * ir);
	      $t(br);
	      var yr = new Array(512);
	      $t(yr);
	      var mr = new Array(256);
	      $t(mr);
	      var kr = new Array(tr);
	      $t(kr);
	      var Er,
	        Sr,
	        xr,
	        Rr = new Array(ir);
	      function Ar(e, t, r, n, i) {
	        this.static_tree = e, this.extra_bits = t, this.extra_base = r, this.elems = n, this.max_length = i, this.has_stree = e && e.length;
	      }
	      function Br(e, t) {
	        this.dyn_tree = e, this.max_code = 0, this.stat_desc = t;
	      }
	      function zr(e) {
	        return e < 256 ? yr[e] : yr[256 + (e >>> 7)];
	      }
	      function Lr(e, t) {
	        e.pending_buf[e.pending++] = 255 & t, e.pending_buf[e.pending++] = t >>> 8 & 255;
	      }
	      function Tr(e, t, r) {
	        e.bi_valid > hr - r ? (e.bi_buf |= t << e.bi_valid & 65535, Lr(e, e.bi_buf), e.bi_buf = t >> hr - e.bi_valid, e.bi_valid += r - hr) : (e.bi_buf |= t << e.bi_valid & 65535, e.bi_valid += r);
	      }
	      function Mr(e, t, r) {
	        Tr(e, r[2 * t], r[2 * t + 1]);
	      }
	      function Cr(e, t) {
	        var r = 0;
	        do {
	          r |= 1 & e, e >>>= 1, r <<= 1;
	        } while (--t > 0);
	        return r >>> 1;
	      }
	      function Dr(e, t, r) {
	        var n,
	          i,
	          o = new Array(sr + 1),
	          a = 0;
	        for (n = 1; n <= sr; n++) o[n] = a = a + r[n - 1] << 1;
	        for (i = 0; i <= t; i++) {
	          var s = e[2 * i + 1];
	          0 !== s && (e[2 * i] = Cr(o[s]++, s));
	        }
	      }
	      function Ir(e) {
	        var t;
	        for (t = 0; t < nr; t++) e.dyn_ltree[2 * t] = 0;
	        for (t = 0; t < ir; t++) e.dyn_dtree[2 * t] = 0;
	        for (t = 0; t < or; t++) e.bl_tree[2 * t] = 0;
	        e.dyn_ltree[2 * lr] = 1, e.opt_len = e.static_len = 0, e.last_lit = e.matches = 0;
	      }
	      function Pr(e) {
	        e.bi_valid > 8 ? Lr(e, e.bi_buf) : e.bi_valid > 0 && (e.pending_buf[e.pending++] = e.bi_buf), e.bi_buf = 0, e.bi_valid = 0;
	      }
	      function Or(e, t, r, n) {
	        var i = 2 * t,
	          o = 2 * r;
	        return e[i] < e[o] || e[i] === e[o] && n[t] <= n[r];
	      }
	      function Ur(e, t, r) {
	        for (var n = e.heap[r], i = r << 1; i <= e.heap_len && (i < e.heap_len && Or(t, e.heap[i + 1], e.heap[i], e.depth) && i++, !Or(t, n, e.heap[i], e.depth));) e.heap[r] = e.heap[i], r = i, i <<= 1;
	        e.heap[r] = n;
	      }
	      function Hr(e, t, r) {
	        var n,
	          i,
	          o,
	          a,
	          s = 0;
	        if (0 !== e.last_lit) do {
	          n = e.pending_buf[e.d_buf + 2 * s] << 8 | e.pending_buf[e.d_buf + 2 * s + 1], i = e.pending_buf[e.l_buf + s], s++, 0 === n ? Mr(e, i, t) : (Mr(e, (o = mr[i]) + rr + 1, t), 0 !== (a = pr[o]) && Tr(e, i -= kr[o], a), Mr(e, o = zr(--n), r), 0 !== (a = _r[o]) && Tr(e, n -= Rr[o], a));
	        } while (s < e.last_lit);
	        Mr(e, lr, t);
	      }
	      function Fr(e, t) {
	        var r,
	          n,
	          i,
	          o = t.dyn_tree,
	          a = t.stat_desc.static_tree,
	          s = t.stat_desc.has_stree,
	          h = t.stat_desc.elems,
	          f = -1;
	        for (e.heap_len = 0, e.heap_max = ar, r = 0; r < h; r++) 0 !== o[2 * r] ? (e.heap[++e.heap_len] = f = r, e.depth[r] = 0) : o[2 * r + 1] = 0;
	        for (; e.heap_len < 2;) o[2 * (i = e.heap[++e.heap_len] = f < 2 ? ++f : 0)] = 1, e.depth[i] = 0, e.opt_len--, s && (e.static_len -= a[2 * i + 1]);
	        for (t.max_code = f, r = e.heap_len >> 1; r >= 1; r--) Ur(e, o, r);
	        i = h;
	        do {
	          r = e.heap[1], e.heap[1] = e.heap[e.heap_len--], Ur(e, o, 1), n = e.heap[1], e.heap[--e.heap_max] = r, e.heap[--e.heap_max] = n, o[2 * i] = o[2 * r] + o[2 * n], e.depth[i] = (e.depth[r] >= e.depth[n] ? e.depth[r] : e.depth[n]) + 1, o[2 * r + 1] = o[2 * n + 1] = i, e.heap[1] = i++, Ur(e, o, 1);
	        } while (e.heap_len >= 2);
	        e.heap[--e.heap_max] = e.heap[1], function (e, t) {
	          var r,
	            n,
	            i,
	            o,
	            a,
	            s,
	            h = t.dyn_tree,
	            f = t.max_code,
	            l = t.stat_desc.static_tree,
	            c = t.stat_desc.has_stree,
	            u = t.stat_desc.extra_bits,
	            d = t.stat_desc.extra_base,
	            p = t.stat_desc.max_length,
	            _ = 0;
	          for (o = 0; o <= sr; o++) e.bl_count[o] = 0;
	          for (h[2 * e.heap[e.heap_max] + 1] = 0, r = e.heap_max + 1; r < ar; r++) (o = h[2 * h[2 * (n = e.heap[r]) + 1] + 1] + 1) > p && (o = p, _++), h[2 * n + 1] = o, n > f || (e.bl_count[o]++, a = 0, n >= d && (a = u[n - d]), s = h[2 * n], e.opt_len += s * (o + a), c && (e.static_len += s * (l[2 * n + 1] + a)));
	          if (0 !== _) {
	            do {
	              for (o = p - 1; 0 === e.bl_count[o];) o--;
	              e.bl_count[o]--, e.bl_count[o + 1] += 2, e.bl_count[p]--, _ -= 2;
	            } while (_ > 0);
	            for (o = p; 0 !== o; o--) for (n = e.bl_count[o]; 0 !== n;) (i = e.heap[--r]) > f || (h[2 * i + 1] !== o && (e.opt_len += (o - h[2 * i + 1]) * h[2 * i], h[2 * i + 1] = o), n--);
	          }
	        }(e, t), Dr(o, f, e.bl_count);
	      }
	      function Nr(e, t, r) {
	        var n,
	          i,
	          o = -1,
	          a = t[1],
	          s = 0,
	          h = 7,
	          f = 4;
	        for (0 === a && (h = 138, f = 3), t[2 * (r + 1) + 1] = 65535, n = 0; n <= r; n++) i = a, a = t[2 * (n + 1) + 1], ++s < h && i === a || (s < f ? e.bl_tree[2 * i] += s : 0 !== i ? (i !== o && e.bl_tree[2 * i]++, e.bl_tree[2 * cr]++) : s <= 10 ? e.bl_tree[2 * ur]++ : e.bl_tree[2 * dr]++, s = 0, o = i, 0 === a ? (h = 138, f = 3) : i === a ? (h = 6, f = 3) : (h = 7, f = 4));
	      }
	      function Zr(e, t, r) {
	        var n,
	          i,
	          o = -1,
	          a = t[1],
	          s = 0,
	          h = 7,
	          f = 4;
	        for (0 === a && (h = 138, f = 3), n = 0; n <= r; n++) if (i = a, a = t[2 * (n + 1) + 1], !(++s < h && i === a)) {
	          if (s < f) do {
	            Mr(e, i, e.bl_tree);
	          } while (0 != --s);else 0 !== i ? (i !== o && (Mr(e, i, e.bl_tree), s--), Mr(e, cr, e.bl_tree), Tr(e, s - 3, 2)) : s <= 10 ? (Mr(e, ur, e.bl_tree), Tr(e, s - 3, 3)) : (Mr(e, dr, e.bl_tree), Tr(e, s - 11, 7));
	          s = 0, o = i, 0 === a ? (h = 138, f = 3) : i === a ? (h = 6, f = 3) : (h = 7, f = 4);
	        }
	      }
	      $t(Rr);
	      var jr = !1;
	      function Wr(e) {
	        jr || (!function () {
	          var e,
	            t,
	            r,
	            n,
	            i,
	            o = new Array(sr + 1);
	          for (r = 0, n = 0; n < tr - 1; n++) for (kr[n] = r, e = 0; e < 1 << pr[n]; e++) mr[r++] = n;
	          for (mr[r - 1] = n, i = 0, n = 0; n < 16; n++) for (Rr[n] = i, e = 0; e < 1 << _r[n]; e++) yr[i++] = n;
	          for (i >>= 7; n < ir; n++) for (Rr[n] = i << 7, e = 0; e < 1 << _r[n] - 7; e++) yr[256 + i++] = n;
	          for (t = 0; t <= sr; t++) o[t] = 0;
	          for (e = 0; e <= 143;) wr[2 * e + 1] = 8, e++, o[8]++;
	          for (; e <= 255;) wr[2 * e + 1] = 9, e++, o[9]++;
	          for (; e <= 279;) wr[2 * e + 1] = 7, e++, o[7]++;
	          for (; e <= 287;) wr[2 * e + 1] = 8, e++, o[8]++;
	          for (Dr(wr, nr + 1, o), e = 0; e < ir; e++) br[2 * e + 1] = 5, br[2 * e] = Cr(e, 5);
	          Er = new Ar(wr, pr, rr + 1, nr, sr), Sr = new Ar(br, _r, 0, ir, sr), xr = new Ar(new Array(0), gr, 0, or, fr);
	        }(), jr = !0), e.l_desc = new Br(e.dyn_ltree, Er), e.d_desc = new Br(e.dyn_dtree, Sr), e.bl_desc = new Br(e.bl_tree, xr), e.bi_buf = 0, e.bi_valid = 0, Ir(e);
	      }
	      function Yr(e, t, r, n) {
	        Tr(e, (Jt << 1) + (n ? 1 : 0), 3), function (e, t, r, n) {
	          Pr(e), n && (Lr(e, r), Lr(e, ~r)), jt(e.pending_buf, e.window, t, r, e.pending), e.pending += r;
	        }(e, t, r, !0);
	      }
	      function Kr(e) {
	        Tr(e, Qt << 1, 3), Mr(e, lr, wr), function (e) {
	          16 === e.bi_valid ? (Lr(e, e.bi_buf), e.bi_buf = 0, e.bi_valid = 0) : e.bi_valid >= 8 && (e.pending_buf[e.pending++] = 255 & e.bi_buf, e.bi_buf >>= 8, e.bi_valid -= 8);
	        }(e);
	      }
	      function Xr(e, t, r, n) {
	        var i,
	          o,
	          a = 0;
	        e.level > 0 ? (e.strm.data_type === Gt && (e.strm.data_type = function (e) {
	          var t,
	            r = 4093624447;
	          for (t = 0; t <= 31; t++, r >>>= 1) if (1 & r && 0 !== e.dyn_ltree[2 * t]) return qt;
	          if (0 !== e.dyn_ltree[18] || 0 !== e.dyn_ltree[20] || 0 !== e.dyn_ltree[26]) return Vt;
	          for (t = 32; t < rr; t++) if (0 !== e.dyn_ltree[2 * t]) return Vt;
	          return qt;
	        }(e)), Fr(e, e.l_desc), Fr(e, e.d_desc), a = function (e) {
	          var t;
	          for (Nr(e, e.dyn_ltree, e.l_desc.max_code), Nr(e, e.dyn_dtree, e.d_desc.max_code), Fr(e, e.bl_desc), t = or - 1; t >= 3 && 0 === e.bl_tree[2 * vr[t] + 1]; t--);
	          return e.opt_len += 3 * (t + 1) + 5 + 5 + 4, t;
	        }(e), i = e.opt_len + 3 + 7 >>> 3, (o = e.static_len + 3 + 7 >>> 3) <= i && (i = o)) : i = o = r + 5, r + 4 <= i && -1 !== t ? Yr(e, t, r, n) : e.strategy === Xt || o === i ? (Tr(e, (Qt << 1) + (n ? 1 : 0), 3), Hr(e, wr, br)) : (Tr(e, (er << 1) + (n ? 1 : 0), 3), function (e, t, r, n) {
	          var i;
	          for (Tr(e, t - 257, 5), Tr(e, r - 1, 5), Tr(e, n - 4, 4), i = 0; i < n; i++) Tr(e, e.bl_tree[2 * vr[i] + 1], 3);
	          Zr(e, e.dyn_ltree, t - 1), Zr(e, e.dyn_dtree, r - 1);
	        }(e, e.l_desc.max_code + 1, e.d_desc.max_code + 1, a + 1), Hr(e, e.dyn_ltree, e.dyn_dtree)), Ir(e), n && Pr(e);
	      }
	      function qr(e, t, r) {
	        return e.pending_buf[e.d_buf + 2 * e.last_lit] = t >>> 8 & 255, e.pending_buf[e.d_buf + 2 * e.last_lit + 1] = 255 & t, e.pending_buf[e.l_buf + e.last_lit] = 255 & r, e.last_lit++, 0 === t ? e.dyn_ltree[2 * r]++ : (e.matches++, t--, e.dyn_ltree[2 * (mr[r] + rr + 1)]++, e.dyn_dtree[2 * zr(t)]++), e.last_lit === e.lit_bufsize - 1;
	      }
	      function Vr(e, t, r, n) {
	        for (var i = 65535 & e | 0, o = e >>> 16 & 65535 | 0, a = 0; 0 !== r;) {
	          r -= a = r > 2e3 ? 2e3 : r;
	          do {
	            o = o + (i = i + t[n++] | 0) | 0;
	          } while (--a);
	          i %= 65521, o %= 65521;
	        }
	        return i | o << 16 | 0;
	      }
	      var Gr = function () {
	        for (var e, t = [], r = 0; r < 256; r++) {
	          e = r;
	          for (var n = 0; n < 8; n++) e = 1 & e ? 3988292384 ^ e >>> 1 : e >>> 1;
	          t[r] = e;
	        }
	        return t;
	      }();
	      function $r(e, t, r, n) {
	        var i = Gr,
	          o = n + r;
	        e ^= -1;
	        for (var a = n; a < o; a++) e = e >>> 8 ^ i[255 & (e ^ t[a])];
	        return -1 ^ e;
	      }
	      var Jr,
	        Qr = 0,
	        en = 1,
	        tn = 3,
	        rn = 4,
	        nn = 5,
	        on = 0,
	        an = 1,
	        sn = -2,
	        hn = -3,
	        fn = -5,
	        ln = -1,
	        cn = 1,
	        un = 2,
	        dn = 3,
	        pn = 4,
	        _n = 2,
	        gn = 8,
	        vn = 9,
	        wn = 286,
	        bn = 30,
	        yn = 19,
	        mn = 2 * wn + 1,
	        kn = 15,
	        En = 3,
	        Sn = 258,
	        xn = Sn + En + 1,
	        Rn = 32,
	        An = 42,
	        Bn = 69,
	        zn = 73,
	        Ln = 91,
	        Tn = 103,
	        Mn = 113,
	        Cn = 666,
	        Dn = 1,
	        In = 2,
	        Pn = 3,
	        On = 4,
	        Un = 3;
	      function Hn(e, t) {
	        return e.msg = Nt[t], t;
	      }
	      function Fn(e) {
	        return (e << 1) - (e > 4 ? 9 : 0);
	      }
	      function Nn(e) {
	        for (var t = e.length; --t >= 0;) e[t] = 0;
	      }
	      function Zn(e) {
	        var t = e.state,
	          r = t.pending;
	        r > e.avail_out && (r = e.avail_out), 0 !== r && (jt(e.output, t.pending_buf, t.pending_out, r, e.next_out), e.next_out += r, t.pending_out += r, e.total_out += r, e.avail_out -= r, t.pending -= r, 0 === t.pending && (t.pending_out = 0));
	      }
	      function jn(e, t) {
	        Xr(e, e.block_start >= 0 ? e.block_start : -1, e.strstart - e.block_start, t), e.block_start = e.strstart, Zn(e.strm);
	      }
	      function Wn(e, t) {
	        e.pending_buf[e.pending++] = t;
	      }
	      function Yn(e, t) {
	        e.pending_buf[e.pending++] = t >>> 8 & 255, e.pending_buf[e.pending++] = 255 & t;
	      }
	      function Kn(e, t) {
	        var r,
	          n,
	          i = e.max_chain_length,
	          o = e.strstart,
	          a = e.prev_length,
	          s = e.nice_match,
	          h = e.strstart > e.w_size - xn ? e.strstart - (e.w_size - xn) : 0,
	          f = e.window,
	          l = e.w_mask,
	          c = e.prev,
	          u = e.strstart + Sn,
	          d = f[o + a - 1],
	          p = f[o + a];
	        e.prev_length >= e.good_match && (i >>= 2), s > e.lookahead && (s = e.lookahead);
	        do {
	          if (f[(r = t) + a] === p && f[r + a - 1] === d && f[r] === f[o] && f[++r] === f[o + 1]) {
	            o += 2, r++;
	            do {} while (f[++o] === f[++r] && f[++o] === f[++r] && f[++o] === f[++r] && f[++o] === f[++r] && f[++o] === f[++r] && f[++o] === f[++r] && f[++o] === f[++r] && f[++o] === f[++r] && o < u);
	            if (n = Sn - (u - o), o = u - Sn, n > a) {
	              if (e.match_start = t, a = n, n >= s) break;
	              d = f[o + a - 1], p = f[o + a];
	            }
	          }
	        } while ((t = c[t & l]) > h && 0 != --i);
	        return a <= e.lookahead ? a : e.lookahead;
	      }
	      function Xn(e) {
	        var t,
	          r,
	          n,
	          i,
	          o,
	          a,
	          s,
	          h,
	          f,
	          l,
	          c = e.w_size;
	        do {
	          if (i = e.window_size - e.lookahead - e.strstart, e.strstart >= c + (c - xn)) {
	            jt(e.window, e.window, c, c, 0), e.match_start -= c, e.strstart -= c, e.block_start -= c, t = r = e.hash_size;
	            do {
	              n = e.head[--t], e.head[t] = n >= c ? n - c : 0;
	            } while (--r);
	            t = r = c;
	            do {
	              n = e.prev[--t], e.prev[t] = n >= c ? n - c : 0;
	            } while (--r);
	            i += c;
	          }
	          if (0 === e.strm.avail_in) break;
	          if (a = e.strm, s = e.window, h = e.strstart + e.lookahead, f = i, l = void 0, (l = a.avail_in) > f && (l = f), r = 0 === l ? 0 : (a.avail_in -= l, jt(s, a.input, a.next_in, l, h), 1 === a.state.wrap ? a.adler = Vr(a.adler, s, l, h) : 2 === a.state.wrap && (a.adler = $r(a.adler, s, l, h)), a.next_in += l, a.total_in += l, l), e.lookahead += r, e.lookahead + e.insert >= En) for (o = e.strstart - e.insert, e.ins_h = e.window[o], e.ins_h = (e.ins_h << e.hash_shift ^ e.window[o + 1]) & e.hash_mask; e.insert && (e.ins_h = (e.ins_h << e.hash_shift ^ e.window[o + En - 1]) & e.hash_mask, e.prev[o & e.w_mask] = e.head[e.ins_h], e.head[e.ins_h] = o, o++, e.insert--, !(e.lookahead + e.insert < En)););
	        } while (e.lookahead < xn && 0 !== e.strm.avail_in);
	      }
	      function qn(e, t) {
	        for (var r, n;;) {
	          if (e.lookahead < xn) {
	            if (Xn(e), e.lookahead < xn && t === Qr) return Dn;
	            if (0 === e.lookahead) break;
	          }
	          if (r = 0, e.lookahead >= En && (e.ins_h = (e.ins_h << e.hash_shift ^ e.window[e.strstart + En - 1]) & e.hash_mask, r = e.prev[e.strstart & e.w_mask] = e.head[e.ins_h], e.head[e.ins_h] = e.strstart), 0 !== r && e.strstart - r <= e.w_size - xn && (e.match_length = Kn(e, r)), e.match_length >= En) {
	            if (n = qr(e, e.strstart - e.match_start, e.match_length - En), e.lookahead -= e.match_length, e.match_length <= e.max_lazy_match && e.lookahead >= En) {
	              e.match_length--;
	              do {
	                e.strstart++, e.ins_h = (e.ins_h << e.hash_shift ^ e.window[e.strstart + En - 1]) & e.hash_mask, r = e.prev[e.strstart & e.w_mask] = e.head[e.ins_h], e.head[e.ins_h] = e.strstart;
	              } while (0 != --e.match_length);
	              e.strstart++;
	            } else e.strstart += e.match_length, e.match_length = 0, e.ins_h = e.window[e.strstart], e.ins_h = (e.ins_h << e.hash_shift ^ e.window[e.strstart + 1]) & e.hash_mask;
	          } else n = qr(e, 0, e.window[e.strstart]), e.lookahead--, e.strstart++;
	          if (n && (jn(e, !1), 0 === e.strm.avail_out)) return Dn;
	        }
	        return e.insert = e.strstart < En - 1 ? e.strstart : En - 1, t === rn ? (jn(e, !0), 0 === e.strm.avail_out ? Pn : On) : e.last_lit && (jn(e, !1), 0 === e.strm.avail_out) ? Dn : In;
	      }
	      function Vn(e, t) {
	        for (var r, n, i;;) {
	          if (e.lookahead < xn) {
	            if (Xn(e), e.lookahead < xn && t === Qr) return Dn;
	            if (0 === e.lookahead) break;
	          }
	          if (r = 0, e.lookahead >= En && (e.ins_h = (e.ins_h << e.hash_shift ^ e.window[e.strstart + En - 1]) & e.hash_mask, r = e.prev[e.strstart & e.w_mask] = e.head[e.ins_h], e.head[e.ins_h] = e.strstart), e.prev_length = e.match_length, e.prev_match = e.match_start, e.match_length = En - 1, 0 !== r && e.prev_length < e.max_lazy_match && e.strstart - r <= e.w_size - xn && (e.match_length = Kn(e, r), e.match_length <= 5 && (e.strategy === cn || e.match_length === En && e.strstart - e.match_start > 4096) && (e.match_length = En - 1)), e.prev_length >= En && e.match_length <= e.prev_length) {
	            i = e.strstart + e.lookahead - En, n = qr(e, e.strstart - 1 - e.prev_match, e.prev_length - En), e.lookahead -= e.prev_length - 1, e.prev_length -= 2;
	            do {
	              ++e.strstart <= i && (e.ins_h = (e.ins_h << e.hash_shift ^ e.window[e.strstart + En - 1]) & e.hash_mask, r = e.prev[e.strstart & e.w_mask] = e.head[e.ins_h], e.head[e.ins_h] = e.strstart);
	            } while (0 != --e.prev_length);
	            if (e.match_available = 0, e.match_length = En - 1, e.strstart++, n && (jn(e, !1), 0 === e.strm.avail_out)) return Dn;
	          } else if (e.match_available) {
	            if ((n = qr(e, 0, e.window[e.strstart - 1])) && jn(e, !1), e.strstart++, e.lookahead--, 0 === e.strm.avail_out) return Dn;
	          } else e.match_available = 1, e.strstart++, e.lookahead--;
	        }
	        return e.match_available && (n = qr(e, 0, e.window[e.strstart - 1]), e.match_available = 0), e.insert = e.strstart < En - 1 ? e.strstart : En - 1, t === rn ? (jn(e, !0), 0 === e.strm.avail_out ? Pn : On) : e.last_lit && (jn(e, !1), 0 === e.strm.avail_out) ? Dn : In;
	      }
	      function Gn(e, t, r, n, i) {
	        this.good_length = e, this.max_lazy = t, this.nice_length = r, this.max_chain = n, this.func = i;
	      }
	      function $n() {
	        this.strm = null, this.status = 0, this.pending_buf = null, this.pending_buf_size = 0, this.pending_out = 0, this.pending = 0, this.wrap = 0, this.gzhead = null, this.gzindex = 0, this.method = gn, this.last_flush = -1, this.w_size = 0, this.w_bits = 0, this.w_mask = 0, this.window = null, this.window_size = 0, this.prev = null, this.head = null, this.ins_h = 0, this.hash_size = 0, this.hash_bits = 0, this.hash_mask = 0, this.hash_shift = 0, this.block_start = 0, this.match_length = 0, this.prev_match = 0, this.match_available = 0, this.strstart = 0, this.match_start = 0, this.lookahead = 0, this.prev_length = 0, this.max_chain_length = 0, this.max_lazy_match = 0, this.level = 0, this.strategy = 0, this.good_match = 0, this.nice_match = 0, this.dyn_ltree = new Yt(2 * mn), this.dyn_dtree = new Yt(2 * (2 * bn + 1)), this.bl_tree = new Yt(2 * (2 * yn + 1)), Nn(this.dyn_ltree), Nn(this.dyn_dtree), Nn(this.bl_tree), this.l_desc = null, this.d_desc = null, this.bl_desc = null, this.bl_count = new Yt(kn + 1), this.heap = new Yt(2 * wn + 1), Nn(this.heap), this.heap_len = 0, this.heap_max = 0, this.depth = new Yt(2 * wn + 1), Nn(this.depth), this.l_buf = 0, this.lit_bufsize = 0, this.last_lit = 0, this.d_buf = 0, this.opt_len = 0, this.static_len = 0, this.matches = 0, this.insert = 0, this.bi_buf = 0, this.bi_valid = 0;
	      }
	      function Jn(e) {
	        var t,
	          r = function (e) {
	            var t;
	            return e && e.state ? (e.total_in = e.total_out = 0, e.data_type = _n, (t = e.state).pending = 0, t.pending_out = 0, t.wrap < 0 && (t.wrap = -t.wrap), t.status = t.wrap ? An : Mn, e.adler = 2 === t.wrap ? 0 : 1, t.last_flush = Qr, Wr(t), on) : Hn(e, sn);
	          }(e);
	        return r === on && ((t = e.state).window_size = 2 * t.w_size, Nn(t.head), t.max_lazy_match = Jr[t.level].max_lazy, t.good_match = Jr[t.level].good_length, t.nice_match = Jr[t.level].nice_length, t.max_chain_length = Jr[t.level].max_chain, t.strstart = 0, t.block_start = 0, t.lookahead = 0, t.insert = 0, t.match_length = t.prev_length = En - 1, t.match_available = 0, t.ins_h = 0), r;
	      }
	      function Qn(e, t) {
	        var r, n, i, o;
	        if (!e || !e.state || t > nn || t < 0) return e ? Hn(e, sn) : sn;
	        if (n = e.state, !e.output || !e.input && 0 !== e.avail_in || n.status === Cn && t !== rn) return Hn(e, 0 === e.avail_out ? fn : sn);
	        if (n.strm = e, r = n.last_flush, n.last_flush = t, n.status === An) if (2 === n.wrap) e.adler = 0, Wn(n, 31), Wn(n, 139), Wn(n, 8), n.gzhead ? (Wn(n, (n.gzhead.text ? 1 : 0) + (n.gzhead.hcrc ? 2 : 0) + (n.gzhead.extra ? 4 : 0) + (n.gzhead.name ? 8 : 0) + (n.gzhead.comment ? 16 : 0)), Wn(n, 255 & n.gzhead.time), Wn(n, n.gzhead.time >> 8 & 255), Wn(n, n.gzhead.time >> 16 & 255), Wn(n, n.gzhead.time >> 24 & 255), Wn(n, 9 === n.level ? 2 : n.strategy >= un || n.level < 2 ? 4 : 0), Wn(n, 255 & n.gzhead.os), n.gzhead.extra && n.gzhead.extra.length && (Wn(n, 255 & n.gzhead.extra.length), Wn(n, n.gzhead.extra.length >> 8 & 255)), n.gzhead.hcrc && (e.adler = $r(e.adler, n.pending_buf, n.pending, 0)), n.gzindex = 0, n.status = Bn) : (Wn(n, 0), Wn(n, 0), Wn(n, 0), Wn(n, 0), Wn(n, 0), Wn(n, 9 === n.level ? 2 : n.strategy >= un || n.level < 2 ? 4 : 0), Wn(n, Un), n.status = Mn);else {
	          var a = gn + (n.w_bits - 8 << 4) << 8;
	          a |= (n.strategy >= un || n.level < 2 ? 0 : n.level < 6 ? 1 : 6 === n.level ? 2 : 3) << 6, 0 !== n.strstart && (a |= Rn), a += 31 - a % 31, n.status = Mn, Yn(n, a), 0 !== n.strstart && (Yn(n, e.adler >>> 16), Yn(n, 65535 & e.adler)), e.adler = 1;
	        }
	        if (n.status === Bn) if (n.gzhead.extra) {
	          for (i = n.pending; n.gzindex < (65535 & n.gzhead.extra.length) && (n.pending !== n.pending_buf_size || (n.gzhead.hcrc && n.pending > i && (e.adler = $r(e.adler, n.pending_buf, n.pending - i, i)), Zn(e), i = n.pending, n.pending !== n.pending_buf_size));) Wn(n, 255 & n.gzhead.extra[n.gzindex]), n.gzindex++;
	          n.gzhead.hcrc && n.pending > i && (e.adler = $r(e.adler, n.pending_buf, n.pending - i, i)), n.gzindex === n.gzhead.extra.length && (n.gzindex = 0, n.status = zn);
	        } else n.status = zn;
	        if (n.status === zn) if (n.gzhead.name) {
	          i = n.pending;
	          do {
	            if (n.pending === n.pending_buf_size && (n.gzhead.hcrc && n.pending > i && (e.adler = $r(e.adler, n.pending_buf, n.pending - i, i)), Zn(e), i = n.pending, n.pending === n.pending_buf_size)) {
	              o = 1;
	              break;
	            }
	            o = n.gzindex < n.gzhead.name.length ? 255 & n.gzhead.name.charCodeAt(n.gzindex++) : 0, Wn(n, o);
	          } while (0 !== o);
	          n.gzhead.hcrc && n.pending > i && (e.adler = $r(e.adler, n.pending_buf, n.pending - i, i)), 0 === o && (n.gzindex = 0, n.status = Ln);
	        } else n.status = Ln;
	        if (n.status === Ln) if (n.gzhead.comment) {
	          i = n.pending;
	          do {
	            if (n.pending === n.pending_buf_size && (n.gzhead.hcrc && n.pending > i && (e.adler = $r(e.adler, n.pending_buf, n.pending - i, i)), Zn(e), i = n.pending, n.pending === n.pending_buf_size)) {
	              o = 1;
	              break;
	            }
	            o = n.gzindex < n.gzhead.comment.length ? 255 & n.gzhead.comment.charCodeAt(n.gzindex++) : 0, Wn(n, o);
	          } while (0 !== o);
	          n.gzhead.hcrc && n.pending > i && (e.adler = $r(e.adler, n.pending_buf, n.pending - i, i)), 0 === o && (n.status = Tn);
	        } else n.status = Tn;
	        if (n.status === Tn && (n.gzhead.hcrc ? (n.pending + 2 > n.pending_buf_size && Zn(e), n.pending + 2 <= n.pending_buf_size && (Wn(n, 255 & e.adler), Wn(n, e.adler >> 8 & 255), e.adler = 0, n.status = Mn)) : n.status = Mn), 0 !== n.pending) {
	          if (Zn(e), 0 === e.avail_out) return n.last_flush = -1, on;
	        } else if (0 === e.avail_in && Fn(t) <= Fn(r) && t !== rn) return Hn(e, fn);
	        if (n.status === Cn && 0 !== e.avail_in) return Hn(e, fn);
	        if (0 !== e.avail_in || 0 !== n.lookahead || t !== Qr && n.status !== Cn) {
	          var s = n.strategy === un ? function (e, t) {
	            for (var r;;) {
	              if (0 === e.lookahead && (Xn(e), 0 === e.lookahead)) {
	                if (t === Qr) return Dn;
	                break;
	              }
	              if (e.match_length = 0, r = qr(e, 0, e.window[e.strstart]), e.lookahead--, e.strstart++, r && (jn(e, !1), 0 === e.strm.avail_out)) return Dn;
	            }
	            return e.insert = 0, t === rn ? (jn(e, !0), 0 === e.strm.avail_out ? Pn : On) : e.last_lit && (jn(e, !1), 0 === e.strm.avail_out) ? Dn : In;
	          }(n, t) : n.strategy === dn ? function (e, t) {
	            for (var r, n, i, o, a = e.window;;) {
	              if (e.lookahead <= Sn) {
	                if (Xn(e), e.lookahead <= Sn && t === Qr) return Dn;
	                if (0 === e.lookahead) break;
	              }
	              if (e.match_length = 0, e.lookahead >= En && e.strstart > 0 && (n = a[i = e.strstart - 1]) === a[++i] && n === a[++i] && n === a[++i]) {
	                o = e.strstart + Sn;
	                do {} while (n === a[++i] && n === a[++i] && n === a[++i] && n === a[++i] && n === a[++i] && n === a[++i] && n === a[++i] && n === a[++i] && i < o);
	                e.match_length = Sn - (o - i), e.match_length > e.lookahead && (e.match_length = e.lookahead);
	              }
	              if (e.match_length >= En ? (r = qr(e, 1, e.match_length - En), e.lookahead -= e.match_length, e.strstart += e.match_length, e.match_length = 0) : (r = qr(e, 0, e.window[e.strstart]), e.lookahead--, e.strstart++), r && (jn(e, !1), 0 === e.strm.avail_out)) return Dn;
	            }
	            return e.insert = 0, t === rn ? (jn(e, !0), 0 === e.strm.avail_out ? Pn : On) : e.last_lit && (jn(e, !1), 0 === e.strm.avail_out) ? Dn : In;
	          }(n, t) : Jr[n.level].func(n, t);
	          if (s !== Pn && s !== On || (n.status = Cn), s === Dn || s === Pn) return 0 === e.avail_out && (n.last_flush = -1), on;
	          if (s === In && (t === en ? Kr(n) : t !== nn && (Yr(n, 0, 0, !1), t === tn && (Nn(n.head), 0 === n.lookahead && (n.strstart = 0, n.block_start = 0, n.insert = 0))), Zn(e), 0 === e.avail_out)) return n.last_flush = -1, on;
	        }
	        return t !== rn ? on : n.wrap <= 0 ? an : (2 === n.wrap ? (Wn(n, 255 & e.adler), Wn(n, e.adler >> 8 & 255), Wn(n, e.adler >> 16 & 255), Wn(n, e.adler >> 24 & 255), Wn(n, 255 & e.total_in), Wn(n, e.total_in >> 8 & 255), Wn(n, e.total_in >> 16 & 255), Wn(n, e.total_in >> 24 & 255)) : (Yn(n, e.adler >>> 16), Yn(n, 65535 & e.adler)), Zn(e), n.wrap > 0 && (n.wrap = -n.wrap), 0 !== n.pending ? on : an);
	      }
	      Jr = [new Gn(0, 0, 0, 0, function (e, t) {
	        var r = 65535;
	        for (r > e.pending_buf_size - 5 && (r = e.pending_buf_size - 5);;) {
	          if (e.lookahead <= 1) {
	            if (Xn(e), 0 === e.lookahead && t === Qr) return Dn;
	            if (0 === e.lookahead) break;
	          }
	          e.strstart += e.lookahead, e.lookahead = 0;
	          var n = e.block_start + r;
	          if ((0 === e.strstart || e.strstart >= n) && (e.lookahead = e.strstart - n, e.strstart = n, jn(e, !1), 0 === e.strm.avail_out)) return Dn;
	          if (e.strstart - e.block_start >= e.w_size - xn && (jn(e, !1), 0 === e.strm.avail_out)) return Dn;
	        }
	        return e.insert = 0, t === rn ? (jn(e, !0), 0 === e.strm.avail_out ? Pn : On) : (e.strstart > e.block_start && (jn(e, !1), e.strm.avail_out), Dn);
	      }), new Gn(4, 4, 8, 4, qn), new Gn(4, 5, 16, 8, qn), new Gn(4, 6, 32, 32, qn), new Gn(4, 4, 16, 16, Vn), new Gn(8, 16, 32, 32, Vn), new Gn(8, 16, 128, 128, Vn), new Gn(8, 32, 128, 256, Vn), new Gn(32, 128, 258, 1024, Vn), new Gn(32, 258, 258, 4096, Vn)];
	      var ei = 30,
	        ti = 12;
	      function ri(e, t) {
	        var r, n, i, o, a, s, h, f, l, c, u, d, p, _, g, v, w, b, y, m, k, E, S, x, R;
	        r = e.state, n = e.next_in, x = e.input, i = n + (e.avail_in - 5), o = e.next_out, R = e.output, a = o - (t - e.avail_out), s = o + (e.avail_out - 257), h = r.dmax, f = r.wsize, l = r.whave, c = r.wnext, u = r.window, d = r.hold, p = r.bits, _ = r.lencode, g = r.distcode, v = (1 << r.lenbits) - 1, w = (1 << r.distbits) - 1;
	        e: do {
	          p < 15 && (d += x[n++] << p, p += 8, d += x[n++] << p, p += 8), b = _[d & v];
	          t: for (;;) {
	            if (d >>>= y = b >>> 24, p -= y, 0 === (y = b >>> 16 & 255)) R[o++] = 65535 & b;else {
	              if (!(16 & y)) {
	                if (0 == (64 & y)) {
	                  b = _[(65535 & b) + (d & (1 << y) - 1)];
	                  continue t;
	                }
	                if (32 & y) {
	                  r.mode = ti;
	                  break e;
	                }
	                e.msg = 'invalid literal/length code', r.mode = ei;
	                break e;
	              }
	              m = 65535 & b, (y &= 15) && (p < y && (d += x[n++] << p, p += 8), m += d & (1 << y) - 1, d >>>= y, p -= y), p < 15 && (d += x[n++] << p, p += 8, d += x[n++] << p, p += 8), b = g[d & w];
	              r: for (;;) {
	                if (d >>>= y = b >>> 24, p -= y, !(16 & (y = b >>> 16 & 255))) {
	                  if (0 == (64 & y)) {
	                    b = g[(65535 & b) + (d & (1 << y) - 1)];
	                    continue r;
	                  }
	                  e.msg = 'invalid distance code', r.mode = ei;
	                  break e;
	                }
	                if (k = 65535 & b, p < (y &= 15) && (d += x[n++] << p, (p += 8) < y && (d += x[n++] << p, p += 8)), (k += d & (1 << y) - 1) > h) {
	                  e.msg = 'invalid distance too far back', r.mode = ei;
	                  break e;
	                }
	                if (d >>>= y, p -= y, k > (y = o - a)) {
	                  if ((y = k - y) > l && r.sane) {
	                    e.msg = 'invalid distance too far back', r.mode = ei;
	                    break e;
	                  }
	                  if (E = 0, S = u, 0 === c) {
	                    if (E += f - y, y < m) {
	                      m -= y;
	                      do {
	                        R[o++] = u[E++];
	                      } while (--y);
	                      E = o - k, S = R;
	                    }
	                  } else if (c < y) {
	                    if (E += f + c - y, (y -= c) < m) {
	                      m -= y;
	                      do {
	                        R[o++] = u[E++];
	                      } while (--y);
	                      if (E = 0, c < m) {
	                        m -= y = c;
	                        do {
	                          R[o++] = u[E++];
	                        } while (--y);
	                        E = o - k, S = R;
	                      }
	                    }
	                  } else if (E += c - y, y < m) {
	                    m -= y;
	                    do {
	                      R[o++] = u[E++];
	                    } while (--y);
	                    E = o - k, S = R;
	                  }
	                  for (; m > 2;) R[o++] = S[E++], R[o++] = S[E++], R[o++] = S[E++], m -= 3;
	                  m && (R[o++] = S[E++], m > 1 && (R[o++] = S[E++]));
	                } else {
	                  E = o - k;
	                  do {
	                    R[o++] = R[E++], R[o++] = R[E++], R[o++] = R[E++], m -= 3;
	                  } while (m > 2);
	                  m && (R[o++] = R[E++], m > 1 && (R[o++] = R[E++]));
	                }
	                break;
	              }
	            }
	            break;
	          }
	        } while (n < i && o < s);
	        n -= m = p >> 3, d &= (1 << (p -= m << 3)) - 1, e.next_in = n, e.next_out = o, e.avail_in = n < i ? i - n + 5 : 5 - (n - i), e.avail_out = o < s ? s - o + 257 : 257 - (o - s), r.hold = d, r.bits = p;
	      }
	      var ni = 15,
	        ii = 852,
	        oi = 592,
	        ai = 0,
	        si = 1,
	        hi = 2,
	        fi = [3, 4, 5, 6, 7, 8, 9, 10, 11, 13, 15, 17, 19, 23, 27, 31, 35, 43, 51, 59, 67, 83, 99, 115, 131, 163, 195, 227, 258, 0, 0],
	        li = [16, 16, 16, 16, 16, 16, 16, 16, 17, 17, 17, 17, 18, 18, 18, 18, 19, 19, 19, 19, 20, 20, 20, 20, 21, 21, 21, 21, 16, 72, 78],
	        ci = [1, 2, 3, 4, 5, 7, 9, 13, 17, 25, 33, 49, 65, 97, 129, 193, 257, 385, 513, 769, 1025, 1537, 2049, 3073, 4097, 6145, 8193, 12289, 16385, 24577, 0, 0],
	        ui = [16, 16, 16, 16, 17, 17, 18, 18, 19, 19, 20, 20, 21, 21, 22, 22, 23, 23, 24, 24, 25, 25, 26, 26, 27, 27, 28, 28, 29, 29, 64, 64];
	      function di(e, t, r, n, i, o, a, s) {
	        var h,
	          f,
	          l,
	          c,
	          u,
	          d,
	          p,
	          _,
	          g,
	          v = s.bits,
	          w = 0,
	          b = 0,
	          y = 0,
	          m = 0,
	          k = 0,
	          E = 0,
	          S = 0,
	          x = 0,
	          R = 0,
	          A = 0,
	          B = null,
	          z = 0,
	          L = new Yt(ni + 1),
	          T = new Yt(ni + 1),
	          M = null,
	          C = 0;
	        for (w = 0; w <= ni; w++) L[w] = 0;
	        for (b = 0; b < n; b++) L[t[r + b]]++;
	        for (k = v, m = ni; m >= 1 && 0 === L[m]; m--);
	        if (k > m && (k = m), 0 === m) return i[o++] = 20971520, i[o++] = 20971520, s.bits = 1, 0;
	        for (y = 1; y < m && 0 === L[y]; y++);
	        for (k < y && (k = y), x = 1, w = 1; w <= ni; w++) if (x <<= 1, (x -= L[w]) < 0) return -1;
	        if (x > 0 && (e === ai || 1 !== m)) return -1;
	        for (T[1] = 0, w = 1; w < ni; w++) T[w + 1] = T[w] + L[w];
	        for (b = 0; b < n; b++) 0 !== t[r + b] && (a[T[t[r + b]]++] = b);
	        if (e === ai ? (B = M = a, d = 19) : e === si ? (B = fi, z -= 257, M = li, C -= 257, d = 256) : (B = ci, M = ui, d = -1), A = 0, b = 0, w = y, u = o, E = k, S = 0, l = -1, c = (R = 1 << k) - 1, e === si && R > ii || e === hi && R > oi) return 1;
	        for (;;) {
	          p = w - S, a[b] < d ? (_ = 0, g = a[b]) : a[b] > d ? (_ = M[C + a[b]], g = B[z + a[b]]) : (_ = 96, g = 0), h = 1 << w - S, y = f = 1 << E;
	          do {
	            i[u + (A >> S) + (f -= h)] = p << 24 | _ << 16 | g | 0;
	          } while (0 !== f);
	          for (h = 1 << w - 1; A & h;) h >>= 1;
	          if (0 !== h ? (A &= h - 1, A += h) : A = 0, b++, 0 == --L[w]) {
	            if (w === m) break;
	            w = t[r + a[b]];
	          }
	          if (w > k && (A & c) !== l) {
	            for (0 === S && (S = k), u += y, x = 1 << (E = w - S); E + S < m && !((x -= L[E + S]) <= 0);) E++, x <<= 1;
	            if (R += 1 << E, e === si && R > ii || e === hi && R > oi) return 1;
	            i[l = A & c] = k << 24 | E << 16 | u - o | 0;
	          }
	        }
	        return 0 !== A && (i[u + A] = w - S << 24 | 64 << 16 | 0), s.bits = k, 0;
	      }
	      var pi = 0,
	        _i = 1,
	        gi = 2,
	        vi = 4,
	        wi = 5,
	        bi = 6,
	        yi = 0,
	        mi = 1,
	        ki = 2,
	        Ei = -2,
	        Si = -3,
	        xi = -4,
	        Ri = -5,
	        Ai = 8,
	        Bi = 1,
	        zi = 2,
	        Li = 3,
	        Ti = 4,
	        Mi = 5,
	        Ci = 6,
	        Di = 7,
	        Ii = 8,
	        Pi = 9,
	        Oi = 10,
	        Ui = 11,
	        Hi = 12,
	        Fi = 13,
	        Ni = 14,
	        Zi = 15,
	        ji = 16,
	        Wi = 17,
	        Yi = 18,
	        Ki = 19,
	        Xi = 20,
	        qi = 21,
	        Vi = 22,
	        Gi = 23,
	        $i = 24,
	        Ji = 25,
	        Qi = 26,
	        eo = 27,
	        to = 28,
	        ro = 29,
	        no = 30,
	        io = 31,
	        oo = 32,
	        ao = 852,
	        so = 592;
	      function ho(e) {
	        return (e >>> 24 & 255) + (e >>> 8 & 65280) + ((65280 & e) << 8) + ((255 & e) << 24);
	      }
	      function fo() {
	        this.mode = 0, this.last = !1, this.wrap = 0, this.havedict = !1, this.flags = 0, this.dmax = 0, this.check = 0, this.total = 0, this.head = null, this.wbits = 0, this.wsize = 0, this.whave = 0, this.wnext = 0, this.window = null, this.hold = 0, this.bits = 0, this.length = 0, this.offset = 0, this.extra = 0, this.lencode = null, this.distcode = null, this.lenbits = 0, this.distbits = 0, this.ncode = 0, this.nlen = 0, this.ndist = 0, this.have = 0, this.next = null, this.lens = new Yt(320), this.work = new Yt(288), this.lendyn = null, this.distdyn = null, this.sane = 0, this.back = 0, this.was = 0;
	      }
	      function lo(e) {
	        var t;
	        return e && e.state ? ((t = e.state).wsize = 0, t.whave = 0, t.wnext = 0, function (e) {
	          var t;
	          return e && e.state ? (t = e.state, e.total_in = e.total_out = t.total = 0, e.msg = '', t.wrap && (e.adler = 1 & t.wrap), t.mode = Bi, t.last = 0, t.havedict = 0, t.dmax = 32768, t.head = null, t.hold = 0, t.bits = 0, t.lencode = t.lendyn = new Kt(ao), t.distcode = t.distdyn = new Kt(so), t.sane = 1, t.back = -1, yi) : Ei;
	        }(e)) : Ei;
	      }
	      function co(e, t) {
	        var r, n;
	        return e ? (n = new fo(), e.state = n, n.window = null, (r = function (e, t) {
	          var r, n;
	          return e && e.state ? (n = e.state, t < 0 ? (r = 0, t = -t) : (r = 1 + (t >> 4), t < 48 && (t &= 15)), t && (t < 8 || t > 15) ? Ei : (null !== n.window && n.wbits !== t && (n.window = null), n.wrap = r, n.wbits = t, lo(e))) : Ei;
	        }(e, t)) !== yi && (e.state = null), r) : Ei;
	      }
	      var uo,
	        po,
	        _o = !0;
	      function go(e) {
	        if (_o) {
	          var t;
	          for (uo = new Kt(512), po = new Kt(32), t = 0; t < 144;) e.lens[t++] = 8;
	          for (; t < 256;) e.lens[t++] = 9;
	          for (; t < 280;) e.lens[t++] = 7;
	          for (; t < 288;) e.lens[t++] = 8;
	          for (di(_i, e.lens, 0, 288, uo, 0, e.work, {
	            bits: 9
	          }), t = 0; t < 32;) e.lens[t++] = 5;
	          di(gi, e.lens, 0, 32, po, 0, e.work, {
	            bits: 5
	          }), _o = !1;
	        }
	        e.lencode = uo, e.lenbits = 9, e.distcode = po, e.distbits = 5;
	      }
	      function vo(e, t) {
	        var r,
	          n,
	          i,
	          o,
	          a,
	          s,
	          h,
	          f,
	          l,
	          c,
	          u,
	          d,
	          p,
	          _,
	          g,
	          v,
	          w,
	          b,
	          y,
	          m,
	          k,
	          E,
	          S,
	          x,
	          R = 0,
	          A = new Wt(4),
	          B = [16, 17, 18, 0, 8, 7, 9, 6, 10, 5, 11, 4, 12, 3, 13, 2, 14, 1, 15];
	        if (!e || !e.state || !e.output || !e.input && 0 !== e.avail_in) return Ei;
	        (r = e.state).mode === Hi && (r.mode = Fi), a = e.next_out, i = e.output, h = e.avail_out, o = e.next_in, n = e.input, s = e.avail_in, f = r.hold, l = r.bits, c = s, u = h, E = yi;
	        e: for (;;) switch (r.mode) {
	          case Bi:
	            if (0 === r.wrap) {
	              r.mode = Fi;
	              break;
	            }
	            for (; l < 16;) {
	              if (0 === s) break e;
	              s--, f += n[o++] << l, l += 8;
	            }
	            if (2 & r.wrap && 35615 === f) {
	              r.check = 0, A[0] = 255 & f, A[1] = f >>> 8 & 255, r.check = $r(r.check, A, 2, 0), f = 0, l = 0, r.mode = zi;
	              break;
	            }
	            if (r.flags = 0, r.head && (r.head.done = !1), !(1 & r.wrap) || (((255 & f) << 8) + (f >> 8)) % 31) {
	              e.msg = 'incorrect header check', r.mode = no;
	              break;
	            }
	            if ((15 & f) !== Ai) {
	              e.msg = 'unknown compression method', r.mode = no;
	              break;
	            }
	            if (l -= 4, k = 8 + (15 & (f >>>= 4)), 0 === r.wbits) r.wbits = k;else if (k > r.wbits) {
	              e.msg = 'invalid window size', r.mode = no;
	              break;
	            }
	            r.dmax = 1 << k, e.adler = r.check = 1, r.mode = 512 & f ? Oi : Hi, f = 0, l = 0;
	            break;
	          case zi:
	            for (; l < 16;) {
	              if (0 === s) break e;
	              s--, f += n[o++] << l, l += 8;
	            }
	            if (r.flags = f, (255 & r.flags) !== Ai) {
	              e.msg = 'unknown compression method', r.mode = no;
	              break;
	            }
	            if (57344 & r.flags) {
	              e.msg = 'unknown header flags set', r.mode = no;
	              break;
	            }
	            r.head && (r.head.text = f >> 8 & 1), 512 & r.flags && (A[0] = 255 & f, A[1] = f >>> 8 & 255, r.check = $r(r.check, A, 2, 0)), f = 0, l = 0, r.mode = Li;
	          case Li:
	            for (; l < 32;) {
	              if (0 === s) break e;
	              s--, f += n[o++] << l, l += 8;
	            }
	            r.head && (r.head.time = f), 512 & r.flags && (A[0] = 255 & f, A[1] = f >>> 8 & 255, A[2] = f >>> 16 & 255, A[3] = f >>> 24 & 255, r.check = $r(r.check, A, 4, 0)), f = 0, l = 0, r.mode = Ti;
	          case Ti:
	            for (; l < 16;) {
	              if (0 === s) break e;
	              s--, f += n[o++] << l, l += 8;
	            }
	            r.head && (r.head.xflags = 255 & f, r.head.os = f >> 8), 512 & r.flags && (A[0] = 255 & f, A[1] = f >>> 8 & 255, r.check = $r(r.check, A, 2, 0)), f = 0, l = 0, r.mode = Mi;
	          case Mi:
	            if (1024 & r.flags) {
	              for (; l < 16;) {
	                if (0 === s) break e;
	                s--, f += n[o++] << l, l += 8;
	              }
	              r.length = f, r.head && (r.head.extra_len = f), 512 & r.flags && (A[0] = 255 & f, A[1] = f >>> 8 & 255, r.check = $r(r.check, A, 2, 0)), f = 0, l = 0;
	            } else r.head && (r.head.extra = null);
	            r.mode = Ci;
	          case Ci:
	            if (1024 & r.flags && ((d = r.length) > s && (d = s), d && (r.head && (k = r.head.extra_len - r.length, r.head.extra || (r.head.extra = new Array(r.head.extra_len)), jt(r.head.extra, n, o, d, k)), 512 & r.flags && (r.check = $r(r.check, n, d, o)), s -= d, o += d, r.length -= d), r.length)) break e;
	            r.length = 0, r.mode = Di;
	          case Di:
	            if (2048 & r.flags) {
	              if (0 === s) break e;
	              d = 0;
	              do {
	                k = n[o + d++], r.head && k && r.length < 65536 && (r.head.name += String.fromCharCode(k));
	              } while (k && d < s);
	              if (512 & r.flags && (r.check = $r(r.check, n, d, o)), s -= d, o += d, k) break e;
	            } else r.head && (r.head.name = null);
	            r.length = 0, r.mode = Ii;
	          case Ii:
	            if (4096 & r.flags) {
	              if (0 === s) break e;
	              d = 0;
	              do {
	                k = n[o + d++], r.head && k && r.length < 65536 && (r.head.comment += String.fromCharCode(k));
	              } while (k && d < s);
	              if (512 & r.flags && (r.check = $r(r.check, n, d, o)), s -= d, o += d, k) break e;
	            } else r.head && (r.head.comment = null);
	            r.mode = Pi;
	          case Pi:
	            if (512 & r.flags) {
	              for (; l < 16;) {
	                if (0 === s) break e;
	                s--, f += n[o++] << l, l += 8;
	              }
	              if (f !== (65535 & r.check)) {
	                e.msg = 'header crc mismatch', r.mode = no;
	                break;
	              }
	              f = 0, l = 0;
	            }
	            r.head && (r.head.hcrc = r.flags >> 9 & 1, r.head.done = !0), e.adler = r.check = 0, r.mode = Hi;
	            break;
	          case Oi:
	            for (; l < 32;) {
	              if (0 === s) break e;
	              s--, f += n[o++] << l, l += 8;
	            }
	            e.adler = r.check = ho(f), f = 0, l = 0, r.mode = Ui;
	          case Ui:
	            if (0 === r.havedict) return e.next_out = a, e.avail_out = h, e.next_in = o, e.avail_in = s, r.hold = f, r.bits = l, ki;
	            e.adler = r.check = 1, r.mode = Hi;
	          case Hi:
	            if (t === wi || t === bi) break e;
	          case Fi:
	            if (r.last) {
	              f >>>= 7 & l, l -= 7 & l, r.mode = eo;
	              break;
	            }
	            for (; l < 3;) {
	              if (0 === s) break e;
	              s--, f += n[o++] << l, l += 8;
	            }
	            switch (r.last = 1 & f, l -= 1, 3 & (f >>>= 1)) {
	              case 0:
	                r.mode = Ni;
	                break;
	              case 1:
	                if (go(r), r.mode = Xi, t === bi) {
	                  f >>>= 2, l -= 2;
	                  break e;
	                }
	                break;
	              case 2:
	                r.mode = Wi;
	                break;
	              case 3:
	                e.msg = 'invalid block type', r.mode = no;
	            }
	            f >>>= 2, l -= 2;
	            break;
	          case Ni:
	            for (f >>>= 7 & l, l -= 7 & l; l < 32;) {
	              if (0 === s) break e;
	              s--, f += n[o++] << l, l += 8;
	            }
	            if ((65535 & f) != (f >>> 16 ^ 65535)) {
	              e.msg = 'invalid stored block lengths', r.mode = no;
	              break;
	            }
	            if (r.length = 65535 & f, f = 0, l = 0, r.mode = Zi, t === bi) break e;
	          case Zi:
	            r.mode = ji;
	          case ji:
	            if (d = r.length) {
	              if (d > s && (d = s), d > h && (d = h), 0 === d) break e;
	              jt(i, n, o, d, a), s -= d, o += d, h -= d, a += d, r.length -= d;
	              break;
	            }
	            r.mode = Hi;
	            break;
	          case Wi:
	            for (; l < 14;) {
	              if (0 === s) break e;
	              s--, f += n[o++] << l, l += 8;
	            }
	            if (r.nlen = 257 + (31 & f), f >>>= 5, l -= 5, r.ndist = 1 + (31 & f), f >>>= 5, l -= 5, r.ncode = 4 + (15 & f), f >>>= 4, l -= 4, r.nlen > 286 || r.ndist > 30) {
	              e.msg = 'too many length or distance symbols', r.mode = no;
	              break;
	            }
	            r.have = 0, r.mode = Yi;
	          case Yi:
	            for (; r.have < r.ncode;) {
	              for (; l < 3;) {
	                if (0 === s) break e;
	                s--, f += n[o++] << l, l += 8;
	              }
	              r.lens[B[r.have++]] = 7 & f, f >>>= 3, l -= 3;
	            }
	            for (; r.have < 19;) r.lens[B[r.have++]] = 0;
	            if (r.lencode = r.lendyn, r.lenbits = 7, S = {
	              bits: r.lenbits
	            }, E = di(pi, r.lens, 0, 19, r.lencode, 0, r.work, S), r.lenbits = S.bits, E) {
	              e.msg = 'invalid code lengths set', r.mode = no;
	              break;
	            }
	            r.have = 0, r.mode = Ki;
	          case Ki:
	            for (; r.have < r.nlen + r.ndist;) {
	              for (; v = (R = r.lencode[f & (1 << r.lenbits) - 1]) >>> 16 & 255, w = 65535 & R, !((g = R >>> 24) <= l);) {
	                if (0 === s) break e;
	                s--, f += n[o++] << l, l += 8;
	              }
	              if (w < 16) f >>>= g, l -= g, r.lens[r.have++] = w;else {
	                if (16 === w) {
	                  for (x = g + 2; l < x;) {
	                    if (0 === s) break e;
	                    s--, f += n[o++] << l, l += 8;
	                  }
	                  if (f >>>= g, l -= g, 0 === r.have) {
	                    e.msg = 'invalid bit length repeat', r.mode = no;
	                    break;
	                  }
	                  k = r.lens[r.have - 1], d = 3 + (3 & f), f >>>= 2, l -= 2;
	                } else if (17 === w) {
	                  for (x = g + 3; l < x;) {
	                    if (0 === s) break e;
	                    s--, f += n[o++] << l, l += 8;
	                  }
	                  l -= g, k = 0, d = 3 + (7 & (f >>>= g)), f >>>= 3, l -= 3;
	                } else {
	                  for (x = g + 7; l < x;) {
	                    if (0 === s) break e;
	                    s--, f += n[o++] << l, l += 8;
	                  }
	                  l -= g, k = 0, d = 11 + (127 & (f >>>= g)), f >>>= 7, l -= 7;
	                }
	                if (r.have + d > r.nlen + r.ndist) {
	                  e.msg = 'invalid bit length repeat', r.mode = no;
	                  break;
	                }
	                for (; d--;) r.lens[r.have++] = k;
	              }
	            }
	            if (r.mode === no) break;
	            if (0 === r.lens[256]) {
	              e.msg = 'invalid code -- missing end-of-block', r.mode = no;
	              break;
	            }
	            if (r.lenbits = 9, S = {
	              bits: r.lenbits
	            }, E = di(_i, r.lens, 0, r.nlen, r.lencode, 0, r.work, S), r.lenbits = S.bits, E) {
	              e.msg = 'invalid literal/lengths set', r.mode = no;
	              break;
	            }
	            if (r.distbits = 6, r.distcode = r.distdyn, S = {
	              bits: r.distbits
	            }, E = di(gi, r.lens, r.nlen, r.ndist, r.distcode, 0, r.work, S), r.distbits = S.bits, E) {
	              e.msg = 'invalid distances set', r.mode = no;
	              break;
	            }
	            if (r.mode = Xi, t === bi) break e;
	          case Xi:
	            r.mode = qi;
	          case qi:
	            if (s >= 6 && h >= 258) {
	              e.next_out = a, e.avail_out = h, e.next_in = o, e.avail_in = s, r.hold = f, r.bits = l, ri(e, u), a = e.next_out, i = e.output, h = e.avail_out, o = e.next_in, n = e.input, s = e.avail_in, f = r.hold, l = r.bits, r.mode === Hi && (r.back = -1);
	              break;
	            }
	            for (r.back = 0; v = (R = r.lencode[f & (1 << r.lenbits) - 1]) >>> 16 & 255, w = 65535 & R, !((g = R >>> 24) <= l);) {
	              if (0 === s) break e;
	              s--, f += n[o++] << l, l += 8;
	            }
	            if (v && 0 == (240 & v)) {
	              for (b = g, y = v, m = w; v = (R = r.lencode[m + ((f & (1 << b + y) - 1) >> b)]) >>> 16 & 255, w = 65535 & R, !(b + (g = R >>> 24) <= l);) {
	                if (0 === s) break e;
	                s--, f += n[o++] << l, l += 8;
	              }
	              f >>>= b, l -= b, r.back += b;
	            }
	            if (f >>>= g, l -= g, r.back += g, r.length = w, 0 === v) {
	              r.mode = Qi;
	              break;
	            }
	            if (32 & v) {
	              r.back = -1, r.mode = Hi;
	              break;
	            }
	            if (64 & v) {
	              e.msg = 'invalid literal/length code', r.mode = no;
	              break;
	            }
	            r.extra = 15 & v, r.mode = Vi;
	          case Vi:
	            if (r.extra) {
	              for (x = r.extra; l < x;) {
	                if (0 === s) break e;
	                s--, f += n[o++] << l, l += 8;
	              }
	              r.length += f & (1 << r.extra) - 1, f >>>= r.extra, l -= r.extra, r.back += r.extra;
	            }
	            r.was = r.length, r.mode = Gi;
	          case Gi:
	            for (; v = (R = r.distcode[f & (1 << r.distbits) - 1]) >>> 16 & 255, w = 65535 & R, !((g = R >>> 24) <= l);) {
	              if (0 === s) break e;
	              s--, f += n[o++] << l, l += 8;
	            }
	            if (0 == (240 & v)) {
	              for (b = g, y = v, m = w; v = (R = r.distcode[m + ((f & (1 << b + y) - 1) >> b)]) >>> 16 & 255, w = 65535 & R, !(b + (g = R >>> 24) <= l);) {
	                if (0 === s) break e;
	                s--, f += n[o++] << l, l += 8;
	              }
	              f >>>= b, l -= b, r.back += b;
	            }
	            if (f >>>= g, l -= g, r.back += g, 64 & v) {
	              e.msg = 'invalid distance code', r.mode = no;
	              break;
	            }
	            r.offset = w, r.extra = 15 & v, r.mode = $i;
	          case $i:
	            if (r.extra) {
	              for (x = r.extra; l < x;) {
	                if (0 === s) break e;
	                s--, f += n[o++] << l, l += 8;
	              }
	              r.offset += f & (1 << r.extra) - 1, f >>>= r.extra, l -= r.extra, r.back += r.extra;
	            }
	            if (r.offset > r.dmax) {
	              e.msg = 'invalid distance too far back', r.mode = no;
	              break;
	            }
	            r.mode = Ji;
	          case Ji:
	            if (0 === h) break e;
	            if (d = u - h, r.offset > d) {
	              if ((d = r.offset - d) > r.whave && r.sane) {
	                e.msg = 'invalid distance too far back', r.mode = no;
	                break;
	              }
	              d > r.wnext ? (d -= r.wnext, p = r.wsize - d) : p = r.wnext - d, d > r.length && (d = r.length), _ = r.window;
	            } else _ = i, p = a - r.offset, d = r.length;
	            d > h && (d = h), h -= d, r.length -= d;
	            do {
	              i[a++] = _[p++];
	            } while (--d);
	            0 === r.length && (r.mode = qi);
	            break;
	          case Qi:
	            if (0 === h) break e;
	            i[a++] = r.length, h--, r.mode = qi;
	            break;
	          case eo:
	            if (r.wrap) {
	              for (; l < 32;) {
	                if (0 === s) break e;
	                s--, f |= n[o++] << l, l += 8;
	              }
	              if (u -= h, e.total_out += u, r.total += u, u && (e.adler = r.check = r.flags ? $r(r.check, i, u, a - u) : Vr(r.check, i, u, a - u)), u = h, (r.flags ? f : ho(f)) !== r.check) {
	                e.msg = 'incorrect data check', r.mode = no;
	                break;
	              }
	              f = 0, l = 0;
	            }
	            r.mode = to;
	          case to:
	            if (r.wrap && r.flags) {
	              for (; l < 32;) {
	                if (0 === s) break e;
	                s--, f += n[o++] << l, l += 8;
	              }
	              if (f !== (4294967295 & r.total)) {
	                e.msg = 'incorrect length check', r.mode = no;
	                break;
	              }
	              f = 0, l = 0;
	            }
	            r.mode = ro;
	          case ro:
	            E = mi;
	            break e;
	          case no:
	            E = Si;
	            break e;
	          case io:
	            return xi;
	          case oo:
	          default:
	            return Ei;
	        }
	        return e.next_out = a, e.avail_out = h, e.next_in = o, e.avail_in = s, r.hold = f, r.bits = l, (r.wsize || u !== e.avail_out && r.mode < no && (r.mode < eo || t !== vi)) && function (e, t, r, n) {
	          var i,
	            o = e.state;
	          null === o.window && (o.wsize = 1 << o.wbits, o.wnext = 0, o.whave = 0, o.window = new Wt(o.wsize)), n >= o.wsize ? (jt(o.window, t, r - o.wsize, o.wsize, 0), o.wnext = 0, o.whave = o.wsize) : ((i = o.wsize - o.wnext) > n && (i = n), jt(o.window, t, r - n, i, o.wnext), (n -= i) ? (jt(o.window, t, r - n, n, 0), o.wnext = n, o.whave = o.wsize) : (o.wnext += i, o.wnext === o.wsize && (o.wnext = 0), o.whave < o.wsize && (o.whave += i)));
	        }(e, e.output, e.next_out, u - e.avail_out), c -= e.avail_in, u -= e.avail_out, e.total_in += c, e.total_out += u, r.total += u, r.wrap && u && (e.adler = r.check = r.flags ? $r(r.check, i, u, e.next_out - u) : Vr(r.check, i, u, e.next_out - u)), e.data_type = r.bits + (r.last ? 64 : 0) + (r.mode === Hi ? 128 : 0) + (r.mode === Xi || r.mode === Zi ? 256 : 0), (0 === c && 0 === u || t === vi) && E === yi && (E = Ri), E;
	      }
	      var wo,
	        bo = 1,
	        yo = 7;
	      function mo(e) {
	        if (e < bo || e > yo) throw new TypeError('Bad argument');
	        this.mode = e, this.init_done = !1, this.write_in_progress = !1, this.pending_close = !1, this.windowBits = 0, this.level = 0, this.memLevel = 0, this.strategy = 0, this.dictionary = null;
	      }
	      function ko(e, t) {
	        for (var r = 0; r < e.length; r++) this[t + r] = e[r];
	      }
	      mo.prototype.init = function (e, t, r, n, i) {
	        var o;
	        switch (this.windowBits = e, this.level = t, this.memLevel = r, this.strategy = n, 3 !== this.mode && 4 !== this.mode || (this.windowBits += 16), this.mode === yo && (this.windowBits += 32), 5 !== this.mode && 6 !== this.mode || (this.windowBits = -this.windowBits), this.strm = new Zt(), this.mode) {
	          case bo:
	          case 3:
	          case 5:
	            o = function (e, t, r, n, i, o) {
	              if (!e) return sn;
	              var a = 1;
	              if (t === ln && (t = 6), n < 0 ? (a = 0, n = -n) : n > 15 && (a = 2, n -= 16), i < 1 || i > vn || r !== gn || n < 8 || n > 15 || t < 0 || t > 9 || o < 0 || o > pn) return Hn(e, sn);
	              8 === n && (n = 9);
	              var s = new $n();
	              return e.state = s, s.strm = e, s.wrap = a, s.gzhead = null, s.w_bits = n, s.w_size = 1 << s.w_bits, s.w_mask = s.w_size - 1, s.hash_bits = i + 7, s.hash_size = 1 << s.hash_bits, s.hash_mask = s.hash_size - 1, s.hash_shift = ~~((s.hash_bits + En - 1) / En), s.window = new Wt(2 * s.w_size), s.head = new Yt(s.hash_size), s.prev = new Yt(s.w_size), s.lit_bufsize = 1 << i + 6, s.pending_buf_size = 4 * s.lit_bufsize, s.pending_buf = new Wt(s.pending_buf_size), s.d_buf = 1 * s.lit_bufsize, s.l_buf = 3 * s.lit_bufsize, s.level = t, s.strategy = o, s.method = r, Jn(e);
	            }(this.strm, this.level, 8, this.windowBits, this.memLevel, this.strategy);
	            break;
	          case 2:
	          case 4:
	          case 6:
	          case yo:
	            o = co(this.strm, this.windowBits);
	            break;
	          default:
	            throw new Error('Unknown mode ' + this.mode);
	        }
	        0 === o ? (this.write_in_progress = !1, this.init_done = !0) : this._error(o);
	      }, mo.prototype.params = function () {
	        throw new Error('deflateParams Not supported');
	      }, mo.prototype._writeCheck = function () {
	        if (!this.init_done) throw new Error('write before init');
	        if (0 === this.mode) throw new Error('already finalized');
	        if (this.write_in_progress) throw new Error('write already in progress');
	        if (this.pending_close) throw new Error('close is pending');
	      }, mo.prototype.write = function (e, t, r, n, i, o, a) {
	        this._writeCheck(), this.write_in_progress = !0;
	        var s = this;
	        return de(function () {
	          s.write_in_progress = !1;
	          var h = s._write(e, t, r, n, i, o, a);
	          s.callback(h[0], h[1]), s.pending_close && s.close();
	        }), this;
	      }, mo.prototype.writeSync = function (e, t, r, n, i, o, a) {
	        return this._writeCheck(), this._write(e, t, r, n, i, o, a);
	      }, mo.prototype._write = function (e, t, r, n, i, o, a) {
	        if (this.write_in_progress = !0, 0 !== e && 1 !== e && 2 !== e && 3 !== e && 4 !== e && 5 !== e) throw new Error('Invalid flush value');
	        null == t && (t = new p(0), n = 0, r = 0), i._set ? i.set = i._set : i.set = ko;
	        var s,
	          h = this.strm;
	        switch (h.avail_in = n, h.input = t, h.next_in = r, h.avail_out = a, h.output = i, h.next_out = o, this.mode) {
	          case bo:
	          case 3:
	          case 5:
	            s = Qn(h, e);
	            break;
	          case yo:
	          case 2:
	          case 4:
	          case 6:
	            s = vo(h, e);
	            break;
	          default:
	            throw new Error('Unknown mode ' + this.mode);
	        }
	        return 1 !== s && 0 !== s && this._error(s), this.write_in_progress = !1, [h.avail_in, h.avail_out];
	      }, mo.prototype.close = function () {
	        this.write_in_progress ? this.pending_close = !0 : (this.pending_close = !1, this.mode === bo || 3 === this.mode || 5 === this.mode ? function (e) {
	          var t;
	          e && e.state && ((t = e.state.status) !== An && t !== Bn && t !== zn && t !== Ln && t !== Tn && t !== Mn && t !== Cn ? Hn(e, sn) : (e.state = null, t === Mn && Hn(e, hn)));
	        }(this.strm) : function (e) {
	          if (!e || !e.state) return Ei;
	          var t = e.state;
	          t.window && (t.window = null), e.state = null;
	        }(this.strm), this.mode = 0);
	      }, mo.prototype.reset = function () {
	        switch (this.mode) {
	          case bo:
	          case 5:
	            wo = Jn(this.strm);
	            break;
	          case 2:
	          case 6:
	            wo = lo(this.strm);
	        }
	        0 !== wo && this._error(wo);
	      }, mo.prototype._error = function (e) {
	        this.onerror(Nt[e] + ': ' + this.strm.msg, e), this.write_in_progress = !1, this.pending_close && this.close();
	      };
	      var Eo = Object.freeze({
	        NONE: 0,
	        DEFLATE: bo,
	        INFLATE: 2,
	        GZIP: 3,
	        GUNZIP: 4,
	        DEFLATERAW: 5,
	        INFLATERAW: 6,
	        UNZIP: yo,
	        Z_NO_FLUSH: 0,
	        Z_PARTIAL_FLUSH: 1,
	        Z_SYNC_FLUSH: 2,
	        Z_FULL_FLUSH: 3,
	        Z_FINISH: 4,
	        Z_BLOCK: 5,
	        Z_TREES: 6,
	        Z_OK: 0,
	        Z_STREAM_END: 1,
	        Z_NEED_DICT: 2,
	        Z_ERRNO: -1,
	        Z_STREAM_ERROR: -2,
	        Z_DATA_ERROR: -3,
	        Z_BUF_ERROR: -5,
	        Z_NO_COMPRESSION: 0,
	        Z_BEST_SPEED: 1,
	        Z_BEST_COMPRESSION: 9,
	        Z_DEFAULT_COMPRESSION: -1,
	        Z_FILTERED: 1,
	        Z_HUFFMAN_ONLY: 2,
	        Z_RLE: 3,
	        Z_FIXED: 4,
	        Z_DEFAULT_STRATEGY: 0,
	        Z_BINARY: 0,
	        Z_TEXT: 1,
	        Z_UNKNOWN: 2,
	        Z_DEFLATED: 8,
	        Zlib: mo
	      });
	      var So = {};
	      Object.keys(Eo).forEach(function (e) {
	        So[e] = Eo[e];
	      }), So.Z_MIN_WINDOWBITS = 8, So.Z_MAX_WINDOWBITS = 15, So.Z_DEFAULT_WINDOWBITS = 15, So.Z_MIN_CHUNK = 64, So.Z_MAX_CHUNK = 1 / 0, So.Z_DEFAULT_CHUNK = 16384, So.Z_MIN_MEMLEVEL = 1, So.Z_MAX_MEMLEVEL = 9, So.Z_DEFAULT_MEMLEVEL = 8, So.Z_MIN_LEVEL = -1, So.Z_MAX_LEVEL = 9, So.Z_DEFAULT_LEVEL = So.Z_DEFAULT_COMPRESSION;
	      var xo = {
	        Z_OK: So.Z_OK,
	        Z_STREAM_END: So.Z_STREAM_END,
	        Z_NEED_DICT: So.Z_NEED_DICT,
	        Z_ERRNO: So.Z_ERRNO,
	        Z_STREAM_ERROR: So.Z_STREAM_ERROR,
	        Z_DATA_ERROR: So.Z_DATA_ERROR,
	        Z_MEM_ERROR: So.Z_MEM_ERROR,
	        Z_BUF_ERROR: So.Z_BUF_ERROR,
	        Z_VERSION_ERROR: So.Z_VERSION_ERROR
	      };
	      function Ro(e, t, r) {
	        var n = [],
	          i = 0;
	        function o() {
	          for (var t; null !== (t = e.read());) n.push(t), i += t.length;
	          e.once('readable', o);
	        }
	        function a() {
	          var t = p.concat(n, i);
	          n = [], r(null, t), e.close();
	        }
	        e.on('error', function (t) {
	          e.removeListener('end', a), e.removeListener('readable', o), r(t);
	        }), e.on('end', a), e.end(t), o();
	      }
	      function Ao(e, t) {
	        if ('string' == typeof t && (t = new p(t)), !$(t)) throw new TypeError('Not a string or buffer');
	        var r = So.Z_FINISH;
	        return e._processChunk(t, r);
	      }
	      function Bo(e) {
	        if (!(this instanceof Bo)) return new Bo(e);
	        Io.call(this, e, So.DEFLATE);
	      }
	      function zo(e) {
	        if (!(this instanceof zo)) return new zo(e);
	        Io.call(this, e, So.INFLATE);
	      }
	      function Lo(e) {
	        if (!(this instanceof Lo)) return new Lo(e);
	        Io.call(this, e, So.GZIP);
	      }
	      function To(e) {
	        if (!(this instanceof To)) return new To(e);
	        Io.call(this, e, So.GUNZIP);
	      }
	      function Mo(e) {
	        if (!(this instanceof Mo)) return new Mo(e);
	        Io.call(this, e, So.DEFLATERAW);
	      }
	      function Co(e) {
	        if (!(this instanceof Co)) return new Co(e);
	        Io.call(this, e, So.INFLATERAW);
	      }
	      function Do(e) {
	        if (!(this instanceof Do)) return new Do(e);
	        Io.call(this, e, So.UNZIP);
	      }
	      function Io(e, t) {
	        if (this._opts = e = e || {}, this._chunkSize = e.chunkSize || So.Z_DEFAULT_CHUNK, Ot.call(this, e), e.flush && e.flush !== So.Z_NO_FLUSH && e.flush !== So.Z_PARTIAL_FLUSH && e.flush !== So.Z_SYNC_FLUSH && e.flush !== So.Z_FULL_FLUSH && e.flush !== So.Z_FINISH && e.flush !== So.Z_BLOCK) throw new Error('Invalid flush flag: ' + e.flush);
	        if (this._flushFlag = e.flush || So.Z_NO_FLUSH, e.chunkSize && (e.chunkSize < So.Z_MIN_CHUNK || e.chunkSize > So.Z_MAX_CHUNK)) throw new Error('Invalid chunk size: ' + e.chunkSize);
	        if (e.windowBits && (e.windowBits < So.Z_MIN_WINDOWBITS || e.windowBits > So.Z_MAX_WINDOWBITS)) throw new Error('Invalid windowBits: ' + e.windowBits);
	        if (e.level && (e.level < So.Z_MIN_LEVEL || e.level > So.Z_MAX_LEVEL)) throw new Error('Invalid compression level: ' + e.level);
	        if (e.memLevel && (e.memLevel < So.Z_MIN_MEMLEVEL || e.memLevel > So.Z_MAX_MEMLEVEL)) throw new Error('Invalid memLevel: ' + e.memLevel);
	        if (e.strategy && e.strategy != So.Z_FILTERED && e.strategy != So.Z_HUFFMAN_ONLY && e.strategy != So.Z_RLE && e.strategy != So.Z_FIXED && e.strategy != So.Z_DEFAULT_STRATEGY) throw new Error('Invalid strategy: ' + e.strategy);
	        if (e.dictionary && !$(e.dictionary)) throw new Error('Invalid dictionary: it should be a Buffer instance');
	        this._binding = new So.Zlib(t);
	        var r = this;
	        this._hadError = !1, this._binding.onerror = function (e, t) {
	          r._binding = null, r._hadError = !0;
	          var n = new Error(e);
	          n.errno = t, n.code = So.codes[t], r.emit('error', n);
	        };
	        var n = So.Z_DEFAULT_COMPRESSION;
	        'number' == typeof e.level && (n = e.level);
	        var i = So.Z_DEFAULT_STRATEGY;
	        'number' == typeof e.strategy && (i = e.strategy), this._binding.init(e.windowBits || So.Z_DEFAULT_WINDOWBITS, n, e.memLevel || So.Z_DEFAULT_MEMLEVEL, i, e.dictionary), this._buffer = new p(this._chunkSize), this._offset = 0, this._closed = !1, this._level = n, this._strategy = i, this.once('end', this.close);
	      }
	      Object.keys(xo).forEach(function (e) {
	        xo[xo[e]] = e;
	      }), Be(Io, Ot), Io.prototype.params = function (e, t, r) {
	        if (e < So.Z_MIN_LEVEL || e > So.Z_MAX_LEVEL) throw new RangeError('Invalid compression level: ' + e);
	        if (t != So.Z_FILTERED && t != So.Z_HUFFMAN_ONLY && t != So.Z_RLE && t != So.Z_FIXED && t != So.Z_DEFAULT_STRATEGY) throw new TypeError('Invalid strategy: ' + t);
	        if (this._level !== e || this._strategy !== t) {
	          var n = this;
	          this.flush(So.Z_SYNC_FLUSH, function () {
	            n._binding.params(e, t), n._hadError || (n._level = e, n._strategy = t, r && r());
	          });
	        } else de(r);
	      }, Io.prototype.reset = function () {
	        return this._binding.reset();
	      }, Io.prototype._flush = function (e) {
	        this._transform(new p(0), '', e);
	      }, Io.prototype.flush = function (e, t) {
	        var r = this._writableState;
	        if (('function' == typeof e || void 0 === e && !t) && (t = e, e = So.Z_FULL_FLUSH), r.ended) t && de(t);else if (r.ending) t && this.once('end', t);else if (r.needDrain) {
	          var n = this;
	          this.once('drain', function () {
	            n.flush(t);
	          });
	        } else this._flushFlag = e, this.write(new p(0), '', t);
	      }, Io.prototype.close = function (e) {
	        if (e && de(e), !this._closed) {
	          this._closed = !0, this._binding.close();
	          var t = this;
	          de(function () {
	            t.emit('close');
	          });
	        }
	      }, Io.prototype._transform = function (e, t, r) {
	        var n,
	          i = this._writableState,
	          o = (i.ending || i.ended) && (!e || i.length === e.length);
	        if (null === !e && !$(e)) return r(new Error('invalid input'));
	        o ? n = So.Z_FINISH : (n = this._flushFlag, e.length >= i.length && (this._flushFlag = this._opts.flush || So.Z_NO_FLUSH)), this._processChunk(e, n, r);
	      }, Io.prototype._processChunk = function (e, t, r) {
	        var n = e && e.length,
	          i = this._chunkSize - this._offset,
	          o = 0,
	          a = this,
	          s = 'function' == typeof r;
	        if (!s) {
	          var h,
	            f = [],
	            l = 0;
	          this.on('error', function (e) {
	            h = e;
	          });
	          do {
	            var c = this._binding.writeSync(t, e, o, n, this._buffer, this._offset, i);
	          } while (!this._hadError && _(c[0], c[1]));
	          if (this._hadError) throw h;
	          var u = p.concat(f, l);
	          return this.close(), u;
	        }
	        var d = this._binding.write(t, e, o, n, this._buffer, this._offset, i);
	        function _(h, c) {
	          if (!a._hadError) {
	            var u = i - c;
	            if (function (e, t) {
	              if (!e) throw new Error(t);
	            }(u >= 0, 'have should not go down'), u > 0) {
	              var d = a._buffer.slice(a._offset, a._offset + u);
	              a._offset += u, s ? a.push(d) : (f.push(d), l += d.length);
	            }
	            if ((0 === c || a._offset >= a._chunkSize) && (i = a._chunkSize, a._offset = 0, a._buffer = new p(a._chunkSize)), 0 === c) {
	              if (o += n - h, n = h, !s) return !0;
	              var g = a._binding.write(t, e, o, n, a._buffer, a._offset, a._chunkSize);
	              return g.callback = _, void (g.buffer = e);
	            }
	            if (!s) return !1;
	            r();
	          }
	        }
	        d.buffer = e, d.callback = _;
	      }, Be(Bo, Io), Be(zo, Io), Be(Lo, Io), Be(To, Io), Be(Mo, Io), Be(Co, Io), Be(Do, Io);
	      var Po = {
	        codes: xo,
	        createDeflate: function createDeflate(e) {
	          return new Bo(e);
	        },
	        createInflate: function createInflate(e) {
	          return new zo(e);
	        },
	        createDeflateRaw: function createDeflateRaw(e) {
	          return new Mo(e);
	        },
	        createInflateRaw: function createInflateRaw(e) {
	          return new Co(e);
	        },
	        createGzip: function createGzip(e) {
	          return new Lo(e);
	        },
	        createGunzip: function createGunzip(e) {
	          return new To(e);
	        },
	        createUnzip: function createUnzip(e) {
	          return new Do(e);
	        },
	        deflate: function deflate(e, t, r) {
	          return 'function' == typeof t && (r = t, t = {}), Ro(new Bo(t), e, r);
	        },
	        deflateSync: function deflateSync(e, t) {
	          return Ao(new Bo(t), e);
	        },
	        gzip: function gzip(e, t, r) {
	          return 'function' == typeof t && (r = t, t = {}), Ro(new Lo(t), e, r);
	        },
	        gzipSync: function gzipSync(e, t) {
	          return Ao(new Lo(t), e);
	        },
	        deflateRaw: function deflateRaw(e, t, r) {
	          return 'function' == typeof t && (r = t, t = {}), Ro(new Mo(t), e, r);
	        },
	        deflateRawSync: function deflateRawSync(e, t) {
	          return Ao(new Mo(t), e);
	        },
	        unzip: function unzip(e, t, r) {
	          return 'function' == typeof t && (r = t, t = {}), Ro(new Do(t), e, r);
	        },
	        unzipSync: function unzipSync(e, t) {
	          return Ao(new Do(t), e);
	        },
	        inflate: function inflate(e, t, r) {
	          return 'function' == typeof t && (r = t, t = {}), Ro(new zo(t), e, r);
	        },
	        inflateSync: function inflateSync(e, t) {
	          return Ao(new zo(t), e);
	        },
	        gunzip: function gunzip(e, t, r) {
	          return 'function' == typeof t && (r = t, t = {}), Ro(new To(t), e, r);
	        },
	        gunzipSync: function gunzipSync(e, t) {
	          return Ao(new To(t), e);
	        },
	        inflateRaw: function inflateRaw(e, t, r) {
	          return 'function' == typeof t && (r = t, t = {}), Ro(new Co(t), e, r);
	        },
	        inflateRawSync: function inflateRawSync(e, t) {
	          return Ao(new Co(t), e);
	        },
	        Deflate: Bo,
	        Inflate: zo,
	        Gzip: Lo,
	        Gunzip: To,
	        DeflateRaw: Mo,
	        InflateRaw: Co,
	        Unzip: Do,
	        Zlib: Io
	      };
	      return /*#__PURE__*/function () {
	        function _class(e, t, r) {
	          _classCallCheck(this, _class);
	          this.SDKAPPID = e, this.EXPIRETIME = r, this.PRIVATEKEY = t;
	        }
	        return _createClass(_class, [{
	          key: "genTestUserSig",
	          value: function genTestUserSig(e) {
	            return this._isNumber(this.SDKAPPID) ? this._isString(this.PRIVATEKEY) ? this._isString(e) ? this._isNumber(this.EXPIRETIME) ? (console.log('sdkAppID=' + this.SDKAPPID + ' key=' + this.PRIVATEKEY + ' userID=' + e + ' expire=' + this.EXPIRETIME), this.genSigWithUserbuf(e, this.EXPIRETIME, null)) : (console.error('expireTime must be a number'), '') : (console.error('userID must be a string'), '') : (console.error('privateKey must be a string'), '') : (console.error('sdkAppID must be a number'), '');
	          }
	        }, {
	          key: "newBuffer",
	          value: function newBuffer(e, t) {
	            return p.from ? p.from(e, t) : new p(e, t);
	          }
	        }, {
	          key: "unescape",
	          value: function unescape(e) {
	            return e.replace(/_/g, '=').replace(/\-/g, '/').replace(/\*/g, '+');
	          }
	        }, {
	          key: "escape",
	          value: function escape(e) {
	            return e.replace(/\+/g, '*').replace(/\//g, '-').replace(/=/g, '_');
	          }
	        }, {
	          key: "encode",
	          value: function encode(e) {
	            return this.escape(this.newBuffer(e).toString('base64'));
	          }
	        }, {
	          key: "decode",
	          value: function decode(e) {
	            return this.newBuffer(this.unescape(e), 'base64');
	          }
	        }, {
	          key: "base64encode",
	          value: function base64encode(e) {
	            return this.newBuffer(e).toString('base64');
	          }
	        }, {
	          key: "base64decode",
	          value: function base64decode(e) {
	            return this.newBuffer(e, 'base64').toString();
	          }
	        }, {
	          key: "_hmacsha256",
	          value: function _hmacsha256(e, t, r, n) {
	            var i = 'TLS.identifier:' + e + '\n';
	            i += 'TLS.sdkappid:' + this.SDKAPPID + '\n', i += 'TLS.time:' + t + '\n', i += 'TLS.expire:' + r + '\n', null != n && (i += 'TLS.userbuf:' + n + '\n');
	            var o = te.HmacSHA256(i, this.PRIVATEKEY);
	            return te.enc.Base64.stringify(o);
	          }
	        }, {
	          key: "_utc",
	          value: function _utc() {
	            return Math.round(Date.now() / 1e3);
	          }
	        }, {
	          key: "_isNumber",
	          value: function _isNumber(e) {
	            return null !== e && ('number' == typeof e && !isNaN(e - 0) || 'object' == _typeof(e) && e.constructor === Number);
	          }
	        }, {
	          key: "_isString",
	          value: function _isString(e) {
	            return 'string' == typeof e;
	          }
	        }, {
	          key: "genSigWithUserbuf",
	          value: function genSigWithUserbuf(e, t, r) {
	            var n = this._utc(),
	              i = {
	                'TLS.ver': '2.0',
	                'TLS.identifier': e,
	                'TLS.sdkappid': this.SDKAPPID,
	                'TLS.time': n,
	                'TLS.expire': t
	              },
	              o = '';
	            if (null != r) {
	              var _a = this.base64encode(r);
	              i['TLS.userbuf'] = _a, o = this._hmacsha256(e, n, t, _a);
	            } else o = this._hmacsha256(e, n, t, null);
	            i['TLS.sig'] = o;
	            var a = JSON.stringify(i),
	              s = Po.deflateSync(this.newBuffer(a)).toString('base64'),
	              h = this.escape(s);
	            return console.log('ret=' + h), h;
	          }
	        }, {
	          key: "validate",
	          value: function validate(e) {
	            var t = this.decode(e),
	              r = Po.inflateSync(t);
	            console.log('validate ret=' + r);
	          }
	        }]);
	      }();
	    });
	  })(libGenerateTestUsersig_min$1, libGenerateTestUsersig_min$1.exports);
	  return libGenerateTestUsersig_min$1.exports;
	}

	var libGenerateTestUsersig_minExports = requireLibGenerateTestUsersig_min();
	var LibGenerateTestUserSig = /*@__PURE__*/getDefaultExportFromCjs(libGenerateTestUsersig_minExports);

	var imChat = {
	  data: function data() {
	    return {
	      imChat: null,
	      sdkAppId: 1600034165,
	      sdkSecretKey: 'd5e0d1870929a2f52025a0cf19a9281ac133d3b8391877a3dab09bc40a2b2b30',
	      SDKIsReady: false,
	      groupID: 'av1'
	    };
	  },
	  methods: {
	    createChat: function createChat(_ref) {
	      var sdkAppId = _ref.sdkAppId,
	        sdkSecretKey = _ref.sdkSecretKey;
	      this.sdkAppId = sdkAppId;
	      this.sdkSecretKey = sdkSecretKey;
	      this.imChat = TencentCloudChat.create({
	        SDKAppID: this.sdkAppId
	      });
	      this.imChat.setLogLevel(0);
	      this.chatInstallEvent();
	      this.addSignalingListener();
	    },
	    loginChat: function loginChat(userID) {
	      return this.imChat.login({
	        userID: userID,
	        userSig: new LibGenerateTestUserSig(this.sdkAppId, this.sdkSecretKey, 604800).genTestUserSig(userID)
	      });
	    },
	    loginOutChat: function loginOutChat() {
	      return this.imChat.logout();
	    },
	    // 销毁 SDK 实例。SDK 会先 logout，然后断开 WebSocket 长连接，并释放资源。
	    destroyChat: function destroyChat() {
	      this.chatUnInstallEvent();
	      this.removeSignalingListener();
	      this.imChat.destroy();
	    },
	    // 发送文字消息
	    sendTextMessage: function sendTextMessage(_ref2) {
	      var remoteUserID = _ref2.remoteUserID,
	        _ref2$conversationTyp = _ref2.conversationType,
	        conversationType = _ref2$conversationTyp === void 0 ? TencentCloudChat.TYPES.CONV_C2C : _ref2$conversationTyp,
	        text = _ref2.text;
	      var messsage = this.imChat.createTextMessage({
	        to: remoteUserID,
	        conversationType: conversationType,
	        payload: {
	          text: text
	        } // 内容容器 {text: 'hello'}
	      });
	      return this.imChat.sendMessage(messsage);
	    },
	    // 自定义消息
	    sendCustomMessage: function sendCustomMessage(_ref3) {
	      var to = _ref3.to,
	        _ref3$conversationTyp = _ref3.conversationType,
	        conversationType = _ref3$conversationTyp === void 0 ? TencentCloudChat.TYPES.CONV_GROUP : _ref3$conversationTyp,
	        type = _ref3.type,
	        _ref3$description = _ref3.description,
	        description = _ref3$description === void 0 ? '' : _ref3$description,
	        _ref3$extension = _ref3.extension,
	        extension = _ref3$extension === void 0 ? '' : _ref3$extension;
	      var messsage = this.imChat.createCustomMessage({
	        to: to,
	        // 可以是要发送给对方的userid, 也可以是 群聊groupid
	        conversationType: conversationType,
	        payload: {
	          data: type,
	          // 用于标识该消息是骰子类型消息
	          description: description,
	          // 获取骰子点数
	          extension: extension
	        } // 内容容器
	      });
	      return this.imChat.sendMessage(messsage);
	    },
	    // 信令 邀请单聊
	    // userID 被邀请方userid
	    invite: function invite(_ref4) {
	      var userID = _ref4.userID,
	        _ref4$data = _ref4.data,
	        data = _ref4$data === void 0 ? '' : _ref4$data,
	        _ref4$timeout = _ref4.timeout,
	        timeout = _ref4$timeout === void 0 ? 30 : _ref4$timeout;
	      return this.imChat.invite({
	        userID: userID,
	        data: data,
	        timeout: timeout
	      });
	    },
	    // 信令 邀请群聊
	    inviteGroup: function inviteGroup(_ref5) {
	      var _ref5$groupID = _ref5.groupID,
	        groupID = _ref5$groupID === void 0 ? this.groupID : _ref5$groupID,
	        inviteeList = _ref5.inviteeList,
	        _ref5$data = _ref5.data,
	        data = _ref5$data === void 0 ? '' : _ref5$data,
	        _ref5$timeout = _ref5.timeout,
	        timeout = _ref5$timeout === void 0 ? 30 : _ref5$timeout;
	      return this.imChat.inviteInGroup({
	        groupID: groupID,
	        inviteeList: inviteeList,
	        data: data,
	        timeout: timeout
	      });
	    },
	    // 信令 取消邀请
	    cancelInvite: function cancelInvite(_ref6) {
	      var inviteID = _ref6.inviteID,
	        _ref6$data = _ref6.data,
	        data = _ref6$data === void 0 ? '' : _ref6$data;
	      return this.imChat.cancel({
	        inviteID: inviteID,
	        // 邀请的用户 ID， 邀请者 invite / inviteGroup 成功后，返回值中的 inviteID
	        data: data
	      });
	    },
	    // 信令 接受邀请
	    acceptInvite: function acceptInvite(_ref7) {
	      var inviteID = _ref7.inviteID,
	        _ref7$data = _ref7.data,
	        data = _ref7$data === void 0 ? '' : _ref7$data;
	      return this.imChat.accept({
	        inviteID: inviteID,
	        data: data
	      });
	    },
	    // 信令 拒绝邀请
	    rejectInvite: function rejectInvite(_ref8) {
	      var inviteID = _ref8.inviteID,
	        _ref8$data = _ref8.data,
	        data = _ref8$data === void 0 ? '' : _ref8$data;
	      return this.imChat.reject({
	        inviteID: inviteID,
	        data: data
	      });
	    },
	    // 群聊
	    // 创建群聊
	    createGroupChat: function createGroupChat(groupID) {
	      return this.imChat.createGroup({
	        type: TencentCloudChat.TYPES.GRP_AVCHATROOM,
	        // 直播类型 群聊
	        name: '智能眼镜',
	        groupID: groupID
	      });
	    },
	    // 搜索群组
	    searchGroupByID: function searchGroupByID(groupID) {
	      return this.imChat.searchGroupByID(groupID);
	    },
	    // 加入群聊
	    joinGroupChat: function joinGroupChat(groupID) {
	      return this.imChat.joinGroup({
	        groupID: groupID
	      });
	    },
	    // 退出群聊
	    quitGroupChat: function quitGroupChat(groupID) {
	      return this.imChat.quitGroup(groupID);
	    },
	    // 解散群
	    dismissGroupChat: function dismissGroupChat(groupID) {
	      return this.imChat.dismissGroup(groupID);
	    },
	    // 监听信令事件
	    addSignalingListener: function addSignalingListener() {
	      // 收到新的邀请
	      this.imChat.addSignalingListener(TencentCloudChat.TSignaling.NEW_INVITATION_RECEIVED, this.onNewInvitationReceived);
	      // 被邀请人接受了邀请
	      this.imChat.addSignalingListener(TencentCloudChat.TSignaling.INVITEE_ACCEPTED, this.onInviteeAccepted);
	      // 被邀请人拒绝了邀请
	      this.imChat.addSignalingListener(TencentCloudChat.TSignaling.INVITEE_REJECTED, this.onInviteeRejected);
	      // 邀请被发起者取消
	      this.imChat.addSignalingListener(TencentCloudChat.TSignaling.INVITATION_CANCELLED, this.onInvitationCancelled);
	      // 邀请超时
	      this.imChat.addSignalingListener(TencentCloudChat.TSignaling.INVITATION_TIMEOUT, this.onInvitationTimeout);
	    },
	    // 移除监听信令事件
	    removeSignalingListener: function removeSignalingListener() {
	      // 收到新的邀请
	      this.imChat.removeSignalingListener(TencentCloudChat.TSignaling.NEW_INVITATION_RECEIVED, this.onNewInvitationReceived);
	      // 被邀请人接受了邀请
	      this.imChat.removeSignalingListener(TencentCloudChat.TSignaling.INVITEE_ACCEPTED, this.onInviteeAccepted);
	      // 被邀请人拒绝了邀请
	      this.imChat.removeSignalingListener(TencentCloudChat.TSignaling.INVITEE_REJECTED, this.onInviteeRejected);
	      // 邀请被发起者取消
	      this.imChat.removeSignalingListener(TencentCloudChat.TSignaling.INVITATION_CANCELLED, this.onInvitationCancelled);
	      // 邀请超时
	      this.imChat.removeSignalingListener(TencentCloudChat.TSignaling.INVITATION_TIMEOUT, this.onInvitationTimeout);
	    },
	    onNewInvitationReceived: function onNewInvitationReceived(event) {
	      console.log('onNewInvitationReceived-收到邀请--', event);
	      this.$store.dispatch('setTisgnalingEvent', event);
	    },
	    onInviteeAccepted: function onInviteeAccepted(event) {
	      console.log('onInviteeAccepted--被邀请人接受邀请-', event);
	      this.$store.dispatch('setTisgnalingEvent', event);
	    },
	    onInviteeRejected: function onInviteeRejected(event) {
	      console.log('onInviteeRejected---被邀请人拒绝了邀请--', event);
	      this.$message.warning('对方未接听！');
	      this.$store.dispatch('setTisgnalingEvent', event);
	    },
	    onInvitationCancelled: function onInvitationCancelled(event) {
	      console.log('onInvitationCancelled---邀请被发起者取消--', event);
	      this.$message.warning('对方取消通话！');
	      this.$store.dispatch('setTisgnalingEvent', event);
	    },
	    onInvitationTimeout: function onInvitationTimeout(event) {
	      console.log('onInvitationTimeout---邀请超时--', event);
	      this.$message.warning('对方无响应！');
	      this.$store.dispatch('setTisgnalingEvent', event);
	    },
	    chatInstallEvent: function chatInstallEvent() {
	      // SDK ready
	      this.imChat.on(TencentCloudChat.EVENT.SDK_READY, this.onSdkReady);
	      this.imChat.on(TencentCloudChat.EVENT.SDK_NOT_READY, this.onSdkNotReady);
	      // SDK 不支持多实例登录，即如果此已在其他页面登录，若继续在当前页面登录成功，则会触发 EVENT.KICKED_OUT
	      this.imChat.on(TencentCloudChat.EVENT.KICKED_OUT, this.onKickedOut);
	      // 接收消息
	      this.imChat.on(TencentCloudChat.EVENT.MESSAGE_RECEIVED, this.onMessageReceived);
	      // 群组事件监听
	      this.imChat.on(TencentCloudChat.EVENT.GROUP_LIST_UPDATED, this.onGroupListUpdated);
	    },
	    chatUnInstallEvent: function chatUnInstallEvent() {
	      // SDK ready
	      this.imChat.off(TencentCloudChat.EVENT.SDK_READY, this.onSdkReady);
	      this.imChat.off(TencentCloudChat.EVENT.SDK_NOT_READY, this.onSdkNotReady);
	      // SDK 不支持多实例登录，即如果此已在其他页面登录，若继续在当前页面登录成功，则会触发 EVENT.KICKED_OUT
	      this.imChat.off(TencentCloudChat.EVENT.KICKED_OUT, this.onKickedOut);
	      // 接收消息
	      this.imChat.off(TencentCloudChat.EVENT.MESSAGE_RECEIVED, this.onMessageReceived);
	      // 群组事件监听
	      this.imChat.off(TencentCloudChat.EVENT.GROUP_LIST_UPDATED, this.onGroupListUpdated);
	    },
	    onSdkReady: function onSdkReady(event) {
	      console.log('sdk-ready-', event);
	      this.SDKIsReady = true;
	      this.$store.dispatch('setSDKReady', true);
	    },
	    onSdkNotReady: function onSdkNotReady(event) {
	      console.log('sdk-no-ready-', event);
	      this.$store.dispatch('setSDKReady', false);
	      // 可调用login 使 sdk 进入 ready
	    },
	    // 在其他页面登录
	    onKickedOut: function onKickedOut(event) {
	      console.log('onKickedOut--', event.data.type);
	      // TencentCloudChat.TYPES.KICKED_OUT_MULT_ACCOUNT(Web端，同一账号，多页面登录被踢)
	      // TencentCloudChat.TYPES.KICKED_OUT_MULT_DEVICE(同一账号，多端登录被踢)
	      // TencentCloudChat.TYPES.KICKED_OUT_USERSIG_EXPIRED(签名过期)
	      // TencentCloudChat.TYPES.KICKED_OUT_REST_API(REST API kick 接口踢出)
	    },
	    // 接收消息
	    onMessageReceived: function onMessageReceived(event) {
	      console.log('onMessageReceived--', event);
	    },
	    // 群组事件监听  群组管理功能指的是搜索群组、创建群组、加入群组、获取已加入的群组、退出群组和解散群组等
	    onGroupListUpdated: function onGroupListUpdated(event) {
	      console.log('onGroupListUpdated--', event);
	    },
	    // 生成房间号
	    createRoomId: function createRoomId() {
	      return Math.random().toString().slice(2, 11);
	    }
	  }
	};

	var trtc$2 = {exports: {}};

	var trtc$1 = trtc$2.exports;

	var hasRequiredTrtc;

	function requireTrtc () {
		if (hasRequiredTrtc) return trtc$2.exports;
		hasRequiredTrtc = 1;
		(function (module, exports) {
			!function(e,t){module.exports=t();}(trtc$1,(function(){function e(e,t){return t.forEach((function(t){t&&"string"!=typeof t&&!Array.isArray(t)&&Object.keys(t).forEach((function(i){if("default"!==i&&!(i in e)){var r=Object.getOwnPropertyDescriptor(t,i);Object.defineProperty(e,i,r.get?r:{enumerable:!0,get:function(){return t[i]}});}}));})),Object.freeze(e)}var t="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof commonjsGlobal?commonjsGlobal:"undefined"!=typeof self?self:{},i=function(e){try{return !!e()}catch(t){return !0}},r=!i((function(){var e=function(){}.bind();return "function"!=typeof e||e.hasOwnProperty("prototype")})),n=r,o=Function.prototype,s=o.call,a=n&&o.bind.bind(s,s),c=n?a:function(e){return function(){return s.apply(e,arguments)}},l=c,d=l({}.toString),u=l("".slice),h=function(e){return u(d(e),8,-1)},p=i,m=h,_=Object,f=c("".split),g=p((function(){return !_("z").propertyIsEnumerable(0)}))?function(e){return "String"==m(e)?f(e,""):_(e)}:_,T=function(e){return null==e},E=T,v=TypeError,y=function(e){if(E(e))throw v("Can't call method on "+e);return e},S=g,I=y,R=function(e){return S(I(e))},A=function(e){return e&&e.Math==Math&&e},C=A("object"==typeof globalThis&&globalThis)||A("object"==typeof window&&window)||A("object"==typeof self&&self)||A("object"==typeof t&&t)||function(){return this}()||Function("return this")(),b={},k={get exports(){return b},set exports(e){b=e;}},D=C,N=Object.defineProperty,w=function(e,t){try{N(D,e,{value:t,configurable:!0,writable:!0});}catch(i){D[e]=t;}return t},O=w,P="__core-js_shared__",M=C[P]||O(P,{}),L=M;(k.exports=function(e,t){return L[e]||(L[e]=void 0!==t?t:{})})("versions",[]).push({version:"3.30.0",mode:"global",copyright:"© 2014-2023 Denis Pushkarev (zloirock.ru)",license:"https://github.com/zloirock/core-js/blob/v3.30.0/LICENSE",source:"https://github.com/zloirock/core-js"});var x,V,U=y,F=Object,B=function(e){return F(U(e))},H=B,j=c({}.hasOwnProperty),W=Object.hasOwn||function(e,t){return j(H(e),t)},G=c,J=0,K=Math.random(),z=G(1..toString),q=function(e){return "Symbol("+(void 0===e?"":e)+")_"+z(++J+K,36)},Y="undefined"!=typeof navigator&&String(navigator.userAgent)||"",Q=C,X=Y,$=Q.process,Z=Q.Deno,ee=$&&$.versions||Z&&Z.version,te=ee&&ee.v8;te&&(V=(x=te.split("."))[0]>0&&x[0]<4?1:+(x[0]+x[1])),!V&&X&&(!(x=X.match(/Edge\/(\d+)/))||x[1]>=74)&&(x=X.match(/Chrome\/(\d+)/))&&(V=+x[1]);var ie=V,re=ie,ne=i,oe=!!Object.getOwnPropertySymbols&&!ne((function(){var e=Symbol();return !String(e)||!(Object(e)instanceof Symbol)||!Symbol.sham&&re&&re<41})),se=oe&&!Symbol.sham&&"symbol"==typeof Symbol.iterator,ae=b,ce=W,le=q,de=oe,ue=se,he=C.Symbol,pe=ae("wks"),me=ue?he.for||he:he&&he.withoutSetter||le,_e=function(e){return ce(pe,e)||(pe[e]=de&&ce(he,e)?he[e]:me("Symbol."+e)),pe[e]},fe="object"==typeof document&&document.all,ge={all:fe,IS_HTMLDDA:void 0===fe&&void 0!==fe},Te=ge.all,Ee=ge.IS_HTMLDDA?function(e){return "function"==typeof e||e===Te}:function(e){return "function"==typeof e},ve=Ee,ye=ge.all,Se=ge.IS_HTMLDDA?function(e){return "object"==typeof e?null!==e:ve(e)||e===ye}:function(e){return "object"==typeof e?null!==e:ve(e)},Ie=Se,Re=String,Ae=TypeError,Ce=function(e){if(Ie(e))return e;throw Ae(Re(e)+" is not an object")},be={},ke=!i((function(){return 7!=Object.defineProperty({},1,{get:function(){return 7}})[1]})),De=ke&&i((function(){return 42!=Object.defineProperty((function(){}),"prototype",{value:42,writable:!1}).prototype})),Ne={},we=Se,Oe=C.document,Pe=we(Oe)&&we(Oe.createElement),Me=function(e){return Pe?Oe.createElement(e):{}},Le=Me,xe=!ke&&!i((function(){return 7!=Object.defineProperty(Le("div"),"a",{get:function(){return 7}}).a})),Ve=r,Ue=Function.prototype.call,Fe=Ve?Ue.bind(Ue):function(){return Ue.apply(Ue,arguments)},Be=C,He=Ee,je=function(e,t){return arguments.length<2?(i=Be[e],He(i)?i:void 0):Be[e]&&Be[e][t];var i;},We=c({}.isPrototypeOf),Ge=je,Je=Ee,Ke=We,ze=Object,qe=se?function(e){return "symbol"==typeof e}:function(e){var t=Ge("Symbol");return Je(t)&&Ke(t.prototype,ze(e))},Ye=String,Qe=function(e){try{return Ye(e)}catch(t){return "Object"}},Xe=Ee,$e=Qe,Ze=TypeError,et=function(e){if(Xe(e))return e;throw Ze($e(e)+" is not a function")},tt=et,it=T,rt=function(e,t){var i=e[t];return it(i)?void 0:tt(i)},nt=Fe,ot=Ee,st=Se,at=TypeError,ct=Fe,lt=Se,dt=qe,ut=rt,ht=function(e,t){var i,r;if("string"===t&&ot(i=e.toString)&&!st(r=nt(i,e)))return r;if(ot(i=e.valueOf)&&!st(r=nt(i,e)))return r;if("string"!==t&&ot(i=e.toString)&&!st(r=nt(i,e)))return r;throw at("Can't convert object to primitive value")},pt=TypeError,mt=_e("toPrimitive"),_t=function(e,t){if(!lt(e)||dt(e))return e;var i,r=ut(e,mt);if(r){if(void 0===t&&(t="default"),i=ct(r,e,t),!lt(i)||dt(i))return i;throw pt("Can't convert object to primitive value")}return void 0===t&&(t="number"),ht(e,t)},ft=_t,gt=qe,Tt=function(e){var t=ft(e,"string");return gt(t)?t:t+""},Et=ke,vt=xe,yt=De,St=Ce,It=Tt,Rt=TypeError,At=Object.defineProperty,Ct=Object.getOwnPropertyDescriptor,bt="enumerable",kt="configurable",Dt="writable";Ne.f=Et?yt?function(e,t,i){if(St(e),t=It(t),St(i),"function"==typeof e&&"prototype"===t&&"value"in i&&Dt in i&&!i[Dt]){var r=Ct(e,t);r&&r[Dt]&&(e[t]=i.value,i={configurable:kt in i?i[kt]:r[kt],enumerable:bt in i?i[bt]:r[bt],writable:!1});}return At(e,t,i)}:At:function(e,t,i){if(St(e),t=It(t),St(i),vt)try{return At(e,t,i)}catch(r){}if("get"in i||"set"in i)throw Rt("Accessors not supported");return "value"in i&&(e[t]=i.value),e};var Nt=Math.ceil,wt=Math.floor,Ot=Math.trunc||function(e){var t=+e;return (t>0?wt:Nt)(t)},Pt=Ot,Mt=function(e){var t=+e;return t!=t||0===t?0:Pt(t)},Lt=Mt,xt=Math.max,Vt=Math.min,Ut=function(e,t){var i=Lt(e);return i<0?xt(i+t,0):Vt(i,t)},Ft=Mt,Bt=Math.min,Ht=function(e){return e>0?Bt(Ft(e),9007199254740991):0},jt=Ht,Wt=function(e){return jt(e.length)},Gt=R,Jt=Ut,Kt=Wt,zt=function(e){return function(t,i,r){var n,o=Gt(t),s=Kt(o),a=Jt(r,s);if(e&&i!=i){for(;s>a;)if((n=o[a++])!=n)return !0}else for(;s>a;a++)if((e||a in o)&&o[a]===i)return e||a||0;return !e&&-1}},qt={includes:zt(!0),indexOf:zt(!1)},Yt={},Qt=W,Xt=R,$t=qt.indexOf,Zt=Yt,ei=c([].push),ti=function(e,t){var i,r=Xt(e),n=0,o=[];for(i in r)!Qt(Zt,i)&&Qt(r,i)&&ei(o,i);for(;t.length>n;)Qt(r,i=t[n++])&&(~$t(o,i)||ei(o,i));return o},ii=["constructor","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","toLocaleString","toString","valueOf"],ri=ti,ni=ii,oi=Object.keys||function(e){return ri(e,ni)},si=ke,ai=De,ci=Ne,li=Ce,di=R,ui=oi;be.f=si&&!ai?Object.defineProperties:function(e,t){li(e);for(var i,r=di(t),n=ui(t),o=n.length,s=0;o>s;)ci.f(e,i=n[s++],r[i]);return e};var hi,pi=je("document","documentElement"),mi=q,_i=b("keys"),fi=function(e){return _i[e]||(_i[e]=mi(e))},gi=Ce,Ti=be,Ei=ii,vi=Yt,yi=pi,Si=Me,Ii="prototype",Ri="script",Ai=fi("IE_PROTO"),Ci=function(){},bi=function(e){return "<"+Ri+">"+e+"</"+Ri+">"},ki=function(e){e.write(bi("")),e.close();var t=e.parentWindow.Object;return e=null,t},Di=function(){try{hi=new ActiveXObject("htmlfile");}catch(n){}var e,t,i;Di="undefined"!=typeof document?document.domain&&hi?ki(hi):(t=Si("iframe"),i="java"+Ri+":",t.style.display="none",yi.appendChild(t),t.src=String(i),(e=t.contentWindow.document).open(),e.write(bi("document.F=Object")),e.close(),e.F):ki(hi);for(var r=Ei.length;r--;)delete Di[Ii][Ei[r]];return Di()};vi[Ai]=!0;var Ni=Object.create||function(e,t){var i;return null!==e?(Ci[Ii]=gi(e),i=new Ci,Ci[Ii]=null,i[Ai]=e):i=Di(),void 0===t?i:Ti.f(i,t)},wi=_e,Oi=Ni,Pi=Ne.f,Mi=wi("unscopables"),Li=Array.prototype;null==Li[Mi]&&Pi(Li,Mi,{configurable:!0,value:Oi(null)});var xi,Vi,Ui,Fi=function(e){Li[Mi][e]=!0;},Bi={},Hi=Ee,ji=C.WeakMap,Wi=Hi(ji)&&/native code/.test(String(ji)),Gi=function(e,t){return {enumerable:!(1&e),configurable:!(2&e),writable:!(4&e),value:t}},Ji=Ne,Ki=Gi,zi=ke?function(e,t,i){return Ji.f(e,t,Ki(1,i))}:function(e,t,i){return e[t]=i,e},qi=Wi,Yi=C,Qi=Se,Xi=zi,$i=W,Zi=M,er=fi,tr=Yt,ir="Object already initialized",rr=Yi.TypeError,nr=Yi.WeakMap;if(qi||Zi.state){var or=Zi.state||(Zi.state=new nr);or.get=or.get,or.has=or.has,or.set=or.set,xi=function(e,t){if(or.has(e))throw rr(ir);return t.facade=e,or.set(e,t),t},Vi=function(e){return or.get(e)||{}},Ui=function(e){return or.has(e)};}else {var sr=er("state");tr[sr]=!0,xi=function(e,t){if($i(e,sr))throw rr(ir);return t.facade=e,Xi(e,sr,t),t},Vi=function(e){return $i(e,sr)?e[sr]:{}},Ui=function(e){return $i(e,sr)};}var ar={set:xi,get:Vi,has:Ui,enforce:function(e){return Ui(e)?Vi(e):xi(e,{})},getterFor:function(e){return function(t){var i;if(!Qi(t)||(i=Vi(t)).type!==e)throw rr("Incompatible receiver, "+e+" required");return i}}},cr={},lr={},dr={}.propertyIsEnumerable,ur=Object.getOwnPropertyDescriptor,hr=ur&&!dr.call({1:2},1);lr.f=hr?function(e){var t=ur(this,e);return !!t&&t.enumerable}:dr;var pr=ke,mr=Fe,_r=lr,fr=Gi,gr=R,Tr=Tt,Er=W,vr=xe,yr=Object.getOwnPropertyDescriptor;cr.f=pr?yr:function(e,t){if(e=gr(e),t=Tr(t),vr)try{return yr(e,t)}catch(i){}if(Er(e,t))return fr(!mr(_r.f,e,t),e[t])};var Sr={},Ir={get exports(){return Sr},set exports(e){Sr=e;}},Rr=ke,Ar=W,Cr=Function.prototype,br=Rr&&Object.getOwnPropertyDescriptor,kr=Ar(Cr,"name"),Dr={EXISTS:kr,PROPER:kr&&"something"===function(){}.name,CONFIGURABLE:kr&&(!Rr||Rr&&br(Cr,"name").configurable)},Nr=Ee,wr=M,Or=c(Function.toString);Nr(wr.inspectSource)||(wr.inspectSource=function(e){return Or(e)});var Pr=wr.inspectSource,Mr=c,Lr=i,xr=Ee,Vr=W,Ur=ke,Fr=Dr.CONFIGURABLE,Br=Pr,Hr=ar.enforce,jr=ar.get,Wr=String,Gr=Object.defineProperty,Jr=Mr("".slice),Kr=Mr("".replace),zr=Mr([].join),qr=Ur&&!Lr((function(){return 8!==Gr((function(){}),"length",{value:8}).length})),Yr=String(String).split("String"),Qr=Ir.exports=function(e,t,i){"Symbol("===Jr(Wr(t),0,7)&&(t="["+Kr(Wr(t),/^Symbol\(([^)]*)\)/,"$1")+"]"),i&&i.getter&&(t="get "+t),i&&i.setter&&(t="set "+t),(!Vr(e,"name")||Fr&&e.name!==t)&&(Ur?Gr(e,"name",{value:t,configurable:!0}):e.name=t),qr&&i&&Vr(i,"arity")&&e.length!==i.arity&&Gr(e,"length",{value:i.arity});try{i&&Vr(i,"constructor")&&i.constructor?Ur&&Gr(e,"prototype",{writable:!1}):e.prototype&&(e.prototype=void 0);}catch(n){}var r=Hr(e);return Vr(r,"source")||(r.source=zr(Yr,"string"==typeof t?t:"")),e};Function.prototype.toString=Qr((function(){return xr(this)&&jr(this).source||Br(this)}),"toString");var Xr=Ee,$r=Ne,Zr=Sr,en=w,tn=function(e,t,i,r){r||(r={});var n=r.enumerable,o=void 0!==r.name?r.name:t;if(Xr(i)&&Zr(i,o,r),r.global)n?e[t]=i:en(t,i);else {try{r.unsafe?e[t]&&(n=!0):delete e[t];}catch(s){}n?e[t]=i:$r.f(e,t,{value:i,enumerable:!1,configurable:!r.nonConfigurable,writable:!r.nonWritable});}return e},rn={},nn=ti,on=ii.concat("length","prototype");rn.f=Object.getOwnPropertyNames||function(e){return nn(e,on)};var sn={};sn.f=Object.getOwnPropertySymbols;var an,cn,ln,dn=je,un=rn,hn=sn,pn=Ce,mn=c([].concat),_n=dn("Reflect","ownKeys")||function(e){var t=un.f(pn(e)),i=hn.f;return i?mn(t,i(e)):t},fn=W,gn=_n,Tn=cr,En=Ne,vn=function(e,t,i){for(var r=gn(t),n=En.f,o=Tn.f,s=0;s<r.length;s++){var a=r[s];fn(e,a)||i&&fn(i,a)||n(e,a,o(t,a));}},yn=i,Sn=Ee,In=/#|\.prototype\./,Rn=function(e,t){var i=Cn[An(e)];return i==kn||i!=bn&&(Sn(t)?yn(t):!!t)},An=Rn.normalize=function(e){return String(e).replace(In,".").toLowerCase()},Cn=Rn.data={},bn=Rn.NATIVE="N",kn=Rn.POLYFILL="P",Dn=Rn,Nn=C,wn=cr.f,On=zi,Pn=tn,Mn=w,Ln=vn,xn=Dn,Vn=function(e,t){var i,r,n,o,s,a=e.target,c=e.global,l=e.stat;if(i=c?Nn:l?Nn[a]||Mn(a,{}):(Nn[a]||{}).prototype)for(r in t){if(o=t[r],n=e.dontCallGetSet?(s=wn(i,r))&&s.value:i[r],!xn(c?r:a+(l?".":"#")+r,e.forced)&&void 0!==n){if(typeof o==typeof n)continue;Ln(o,n);}(e.sham||n&&n.sham)&&On(o,"sham",!0),Pn(i,r,o,e);}},Un=!i((function(){function e(){}return e.prototype.constructor=null,Object.getPrototypeOf(new e)!==e.prototype})),Fn=W,Bn=Ee,Hn=B,jn=Un,Wn=fi("IE_PROTO"),Gn=Object,Jn=Gn.prototype,Kn=jn?Gn.getPrototypeOf:function(e){var t=Hn(e);if(Fn(t,Wn))return t[Wn];var i=t.constructor;return Bn(i)&&t instanceof i?i.prototype:t instanceof Gn?Jn:null},zn=i,qn=Ee,Yn=Se,Qn=Kn,Xn=tn,$n=_e("iterator"),Zn=!1;[].keys&&("next"in(ln=[].keys())?(cn=Qn(Qn(ln)))!==Object.prototype&&(an=cn):Zn=!0);var eo=!Yn(an)||zn((function(){var e={};return an[$n].call(e)!==e}));eo&&(an={}),qn(an[$n])||Xn(an,$n,(function(){return this}));var to={IteratorPrototype:an,BUGGY_SAFARI_ITERATORS:Zn},io=Ne.f,ro=W,no=_e("toStringTag"),oo=function(e,t,i){e&&!i&&(e=e.prototype),e&&!ro(e,no)&&io(e,no,{configurable:!0,value:t});},so=to.IteratorPrototype,ao=Ni,co=Gi,lo=oo,uo=Bi,ho=function(){return this},po=function(e,t,i,r){var n=t+" Iterator";return e.prototype=ao(so,{next:co(+!r,i)}),lo(e,n,!1),uo[n]=ho,e},mo=c,_o=et,fo=Ee,go=String,To=TypeError,Eo=function(e,t,i){try{return mo(_o(Object.getOwnPropertyDescriptor(e,t)[i]))}catch(r){}},vo=Ce,yo=function(e){if("object"==typeof e||fo(e))return e;throw To("Can't set "+go(e)+" as a prototype")},So=Object.setPrototypeOf||("__proto__"in{}?function(){var e,t=!1,i={};try{(e=Eo(Object.prototype,"__proto__","set"))(i,[]),t=i instanceof Array;}catch(r){}return function(i,r){return vo(i),yo(r),t?e(i,r):i.__proto__=r,i}}():void 0),Io=Vn,Ro=Fe,Ao=Ee,Co=po,bo=Kn,ko=So,Do=oo,No=zi,wo=tn,Oo=Bi,Po=Dr.PROPER,Mo=Dr.CONFIGURABLE,Lo=to.IteratorPrototype,xo=to.BUGGY_SAFARI_ITERATORS,Vo=_e("iterator"),Uo="keys",Fo="values",Bo="entries",Ho=function(){return this},jo=function(e,t,i,r,n,o,s){Co(i,t,r);var a,c,l,d=function(e){if(e===n&&_)return _;if(!xo&&e in p)return p[e];switch(e){case Uo:case Fo:case Bo:return function(){return new i(this,e)}}return function(){return new i(this)}},u=t+" Iterator",h=!1,p=e.prototype,m=p[Vo]||p["@@iterator"]||n&&p[n],_=!xo&&m||d(n),f="Array"==t&&p.entries||m;if(f&&(a=bo(f.call(new e)))!==Object.prototype&&a.next&&(bo(a)!==Lo&&(ko?ko(a,Lo):Ao(a[Vo])||wo(a,Vo,Ho)),Do(a,u,!0)),Po&&n==Fo&&m&&m.name!==Fo&&(Mo?No(p,"name",Fo):(h=!0,_=function(){return Ro(m,this)})),n)if(c={values:d(Fo),keys:o?_:d(Uo),entries:d(Bo)},s)for(l in c)(xo||h||!(l in p))&&wo(p,l,c[l]);else Io({target:t,proto:!0,forced:xo||h},c);return p[Vo]!==_&&wo(p,Vo,_,{name:n}),Oo[t]=_,c},Wo=function(e,t){return {value:e,done:t}},Go=R,Jo=Fi,Ko=Bi,zo=ar,qo=Ne.f,Yo=jo,Qo=Wo,Xo=ke,$o="Array Iterator",Zo=zo.set,es=zo.getterFor($o),ts=Yo(Array,"Array",(function(e,t){Zo(this,{type:$o,target:Go(e),index:0,kind:t});}),(function(){var e=es(this),t=e.target,i=e.kind,r=e.index++;return !t||r>=t.length?(e.target=void 0,Qo(void 0,!0)):Qo("keys"==i?r:"values"==i?t[r]:[r,t[r]],!1)}),"values"),is=Ko.Arguments=Ko.Array;if(Jo("keys"),Jo("values"),Jo("entries"),Xo&&"values"!==is.name)try{qo(is,"name",{value:"values"});}catch(SB){}var rs={CSSRuleList:0,CSSStyleDeclaration:0,CSSValueList:0,ClientRectList:0,DOMRectList:0,DOMStringList:0,DOMTokenList:1,DataTransferItemList:0,FileList:0,HTMLAllCollection:0,HTMLCollection:0,HTMLFormElement:0,HTMLSelectElement:0,MediaList:0,MimeTypeArray:0,NamedNodeMap:0,NodeList:1,PaintRequestList:0,Plugin:0,PluginArray:0,SVGLengthList:0,SVGNumberList:0,SVGPathSegList:0,SVGPointList:0,SVGStringList:0,SVGTransformList:0,SourceBufferList:0,StyleSheetList:0,TextTrackCueList:0,TextTrackList:0,TouchList:0},ns=Me("span").classList,os=ns&&ns.constructor&&ns.constructor.prototype,ss=os===Object.prototype?void 0:os,as=C,cs=rs,ls=ss,ds=ts,us=zi,hs=_e,ps=hs("iterator"),ms=hs("toStringTag"),_s=ds.values,fs=function(e,t){if(e){if(e[ps]!==_s)try{us(e,ps,_s);}catch(SB){e[ps]=_s;}if(e[ms]||us(e,ms,t),cs[t])for(var i in ds)if(e[i]!==ds[i])try{us(e,i,ds[i]);}catch(SB){e[i]=ds[i];}}};for(var gs in cs)fs(as[gs]&&as[gs].prototype,gs);fs(ls,"DOMTokenList");var Ts="undefined"!=typeof process&&"process"==h(process),Es=Sr,vs=Ne,ys=function(e,t,i){return i.get&&Es(i.get,t,{getter:!0}),i.set&&Es(i.set,t,{setter:!0}),vs.f(e,t,i)},Ss=je,Is=ys,Rs=ke,As=_e("species"),Cs=function(e){var t=Ss(e);Rs&&t&&!t[As]&&Is(t,As,{configurable:!0,get:function(){return this}});},bs=We,ks=TypeError,Ds=function(e,t){if(bs(t,e))return e;throw ks("Incorrect invocation")},Ns={};Ns[_e("toStringTag")]="z";var ws="[object z]"===String(Ns),Os=Ee,Ps=h,Ms=_e("toStringTag"),Ls=Object,xs="Arguments"==Ps(function(){return arguments}()),Vs=ws?Ps:function(e){var t,i,r;return void 0===e?"Undefined":null===e?"Null":"string"==typeof(i=function(e,t){try{return e[t]}catch(SB){}}(t=Ls(e),Ms))?i:xs?Ps(t):"Object"==(r=Ps(t))&&Os(t.callee)?"Arguments":r},Us=c,Fs=i,Bs=Ee,Hs=Vs,js=Pr,Ws=function(){},Gs=[],Js=je("Reflect","construct"),Ks=/^\s*(?:class|function)\b/,zs=Us(Ks.exec),qs=!Ks.exec(Ws),Ys=function(e){if(!Bs(e))return !1;try{return Js(Ws,Gs,e),!0}catch(SB){return !1}},Qs=function(e){if(!Bs(e))return !1;switch(Hs(e)){case"AsyncFunction":case"GeneratorFunction":case"AsyncGeneratorFunction":return !1}try{return qs||!!zs(Ks,js(e))}catch(SB){return !0}};Qs.sham=!0;var Xs,$s,Zs,ea,ta=!Js||Fs((function(){var e;return Ys(Ys.call)||!Ys(Object)||!Ys((function(){e=!0;}))||e}))?Qs:Ys,ia=ta,ra=Qe,na=TypeError,oa=function(e){if(ia(e))return e;throw na(ra(e)+" is not a constructor")},sa=Ce,aa=oa,ca=T,la=_e("species"),da=function(e,t){var i,r=sa(e).constructor;return void 0===r||ca(i=sa(r)[la])?t:aa(i)},ua=r,ha=Function.prototype,pa=ha.apply,ma=ha.call,_a="object"==typeof Reflect&&Reflect.apply||(ua?ma.bind(pa):function(){return ma.apply(pa,arguments)}),fa=h,ga=c,Ta=function(e){if("Function"===fa(e))return ga(e)},Ea=et,va=r,ya=Ta(Ta.bind),Sa=function(e,t){return Ea(e),void 0===t?e:va?ya(e,t):function(){return e.apply(t,arguments)}},Ia=c([].slice),Ra=TypeError,Aa=function(e,t){if(e<t)throw Ra("Not enough arguments");return e},Ca=/(?:ipad|iphone|ipod).*applewebkit/i.test(Y),ba=C,ka=_a,Da=Sa,Na=Ee,wa=W,Oa=i,Pa=pi,Ma=Ia,La=Me,xa=Aa,Va=Ca,Ua=Ts,Fa=ba.setImmediate,Ba=ba.clearImmediate,Ha=ba.process,ja=ba.Dispatch,Wa=ba.Function,Ga=ba.MessageChannel,Ja=ba.String,Ka=0,za={},qa="onreadystatechange";Oa((function(){Xs=ba.location;}));var Ya=function(e){if(wa(za,e)){var t=za[e];delete za[e],t();}},Qa=function(e){return function(){Ya(e);}},Xa=function(e){Ya(e.data);},$a=function(e){ba.postMessage(Ja(e),Xs.protocol+"//"+Xs.host);};Fa&&Ba||(Fa=function(e){xa(arguments.length,1);var t=Na(e)?e:Wa(e),i=Ma(arguments,1);return za[++Ka]=function(){ka(t,void 0,i);},$s(Ka),Ka},Ba=function(e){delete za[e];},Ua?$s=function(e){Ha.nextTick(Qa(e));}:ja&&ja.now?$s=function(e){ja.now(Qa(e));}:Ga&&!Va?(ea=(Zs=new Ga).port2,Zs.port1.onmessage=Xa,$s=Da(ea.postMessage,ea)):ba.addEventListener&&Na(ba.postMessage)&&!ba.importScripts&&Xs&&"file:"!==Xs.protocol&&!Oa($a)?($s=$a,ba.addEventListener("message",Xa,!1)):$s=qa in La("script")?function(e){Pa.appendChild(La("script"))[qa]=function(){Pa.removeChild(this),Ya(e);};}:function(e){setTimeout(Qa(e),0);});var Za={set:Fa,clear:Ba},ec=function(){this.head=null,this.tail=null;};ec.prototype={add:function(e){var t={item:e,next:null},i=this.tail;i?i.next=t:this.head=t,this.tail=t;},get:function(){var e=this.head;if(e)return null===(this.head=e.next)&&(this.tail=null),e.item}};var tc,ic,rc,nc,oc,sc=ec,ac=/ipad|iphone|ipod/i.test(Y)&&"undefined"!=typeof Pebble,cc=/web0s(?!.*chrome)/i.test(Y),lc=C,dc=Sa,uc=cr.f,hc=Za.set,pc=sc,mc=Ca,_c=ac,fc=cc,gc=Ts,Tc=lc.MutationObserver||lc.WebKitMutationObserver,Ec=lc.document,vc=lc.process,yc=lc.Promise,Sc=uc(lc,"queueMicrotask"),Ic=Sc&&Sc.value;if(!Ic){var Rc=new pc,Ac=function(){var e,t;for(gc&&(e=vc.domain)&&e.exit();t=Rc.get();)try{t();}catch(SB){throw Rc.head&&tc(),SB}e&&e.enter();};mc||gc||fc||!Tc||!Ec?!_c&&yc&&yc.resolve?((nc=yc.resolve(void 0)).constructor=yc,oc=dc(nc.then,nc),tc=function(){oc(Ac);}):gc?tc=function(){vc.nextTick(Ac);}:(hc=dc(hc,lc),tc=function(){hc(Ac);}):(ic=!0,rc=Ec.createTextNode(""),new Tc(Ac).observe(rc,{characterData:!0}),tc=function(){rc.data=ic=!ic;}),Ic=function(e){Rc.head||tc(),Rc.add(e);};}var Cc=Ic,bc=function(e){try{return {error:!1,value:e()}}catch(SB){return {error:!0,value:SB}}},kc=C.Promise,Dc="object"==typeof Deno&&Deno&&"object"==typeof Deno.version,Nc=!Dc&&!Ts&&"object"==typeof window&&"object"==typeof document,wc=C,Oc=kc,Pc=Ee,Mc=Dn,Lc=Pr,xc=_e,Vc=Nc,Uc=Dc,Fc=ie;Oc&&Oc.prototype;var Bc=xc("species"),Hc=!1,jc=Pc(wc.PromiseRejectionEvent),Wc=Mc("Promise",(function(){var e=Lc(Oc),t=e!==String(Oc);if(!t&&66===Fc)return !0;if(!Fc||Fc<51||!/native code/.test(e)){var i=new Oc((function(e){e(1);})),r=function(e){e((function(){}),(function(){}));};if((i.constructor={})[Bc]=r,!(Hc=i.then((function(){}))instanceof r))return !0}return !t&&(Vc||Uc)&&!jc})),Gc={CONSTRUCTOR:Wc,REJECTION_EVENT:jc,SUBCLASSING:Hc},Jc={},Kc=et,zc=TypeError,qc=function(e){var t,i;this.promise=new e((function(e,r){if(void 0!==t||void 0!==i)throw zc("Bad Promise constructor");t=e,i=r;})),this.resolve=Kc(t),this.reject=Kc(i);};Jc.f=function(e){return new qc(e)};var Yc,Qc,Xc,$c=Vn,Zc=Ts,el=C,tl=Fe,il=tn,rl=So,nl=oo,ol=Cs,sl=et,al=Ee,cl=Se,ll=Ds,dl=da,ul=Za.set,hl=Cc,pl=function(e,t){try{1==arguments.length?console.error(e):console.error(e,t);}catch(SB){}},ml=bc,_l=sc,fl=ar,gl=kc,Tl=Jc,El="Promise",vl=Gc.CONSTRUCTOR,yl=Gc.REJECTION_EVENT,Sl=Gc.SUBCLASSING,Il=fl.getterFor(El),Rl=fl.set,Al=gl&&gl.prototype,Cl=gl,bl=Al,kl=el.TypeError,Dl=el.document,Nl=el.process,wl=Tl.f,Ol=wl,Pl=!!(Dl&&Dl.createEvent&&el.dispatchEvent),Ml="unhandledrejection",Ll=function(e){var t;return !(!cl(e)||!al(t=e.then))&&t},xl=function(e,t){var i,r,n,o=t.value,s=1==t.state,a=s?e.ok:e.fail,c=e.resolve,l=e.reject,d=e.domain;try{a?(s||(2===t.rejection&&Hl(t),t.rejection=1),!0===a?i=o:(d&&d.enter(),i=a(o),d&&(d.exit(),n=!0)),i===e.promise?l(kl("Promise-chain cycle")):(r=Ll(i))?tl(r,i,c,l):c(i)):l(o);}catch(SB){d&&!n&&d.exit(),l(SB);}},Vl=function(e,t){e.notified||(e.notified=!0,hl((function(){for(var i,r=e.reactions;i=r.get();)xl(i,e);e.notified=!1,t&&!e.rejection&&Fl(e);})));},Ul=function(e,t,i){var r,n;Pl?((r=Dl.createEvent("Event")).promise=t,r.reason=i,r.initEvent(e,!1,!0),el.dispatchEvent(r)):r={promise:t,reason:i},!yl&&(n=el["on"+e])?n(r):e===Ml&&pl("Unhandled promise rejection",i);},Fl=function(e){tl(ul,el,(function(){var t,i=e.facade,r=e.value;if(Bl(e)&&(t=ml((function(){Zc?Nl.emit("unhandledRejection",r,i):Ul(Ml,i,r);})),e.rejection=Zc||Bl(e)?2:1,t.error))throw t.value}));},Bl=function(e){return 1!==e.rejection&&!e.parent},Hl=function(e){tl(ul,el,(function(){var t=e.facade;Zc?Nl.emit("rejectionHandled",t):Ul("rejectionhandled",t,e.value);}));},jl=function(e,t,i){return function(r){e(t,r,i);}},Wl=function(e,t,i){e.done||(e.done=!0,i&&(e=i),e.value=t,e.state=2,Vl(e,!0));},Gl=function(e,t,i){if(!e.done){e.done=!0,i&&(e=i);try{if(e.facade===t)throw kl("Promise can't be resolved itself");var r=Ll(t);r?hl((function(){var i={done:!1};try{tl(r,t,jl(Gl,i,e),jl(Wl,i,e));}catch(SB){Wl(i,SB,e);}})):(e.value=t,e.state=1,Vl(e,!1));}catch(SB){Wl({done:!1},SB,e);}}};if(vl&&(bl=(Cl=function(e){ll(this,bl),sl(e),tl(Yc,this);var t=Il(this);try{e(jl(Gl,t),jl(Wl,t));}catch(SB){Wl(t,SB);}}).prototype,(Yc=function(e){Rl(this,{type:El,done:!1,notified:!1,parent:!1,reactions:new _l,rejection:!1,state:0,value:void 0});}).prototype=il(bl,"then",(function(e,t){var i=Il(this),r=wl(dl(this,Cl));return i.parent=!0,r.ok=!al(e)||e,r.fail=al(t)&&t,r.domain=Zc?Nl.domain:void 0,0==i.state?i.reactions.add(r):hl((function(){xl(r,i);})),r.promise})),Qc=function(){var e=new Yc,t=Il(e);this.promise=e,this.resolve=jl(Gl,t),this.reject=jl(Wl,t);},Tl.f=wl=function(e){return e===Cl||undefined===e?new Qc(e):Ol(e)},al(gl)&&Al!==Object.prototype)){Xc=Al.then,Sl||il(Al,"then",(function(e,t){var i=this;return new Cl((function(e,t){tl(Xc,i,e,t);})).then(e,t)}),{unsafe:!0});try{delete Al.constructor;}catch(SB){}rl&&rl(Al,bl);}$c({global:!0,constructor:!0,wrap:!0,forced:vl},{Promise:Cl}),nl(Cl,El,!1),ol(El);var Jl=Bi,Kl=_e("iterator"),zl=Array.prototype,ql=function(e){return void 0!==e&&(Jl.Array===e||zl[Kl]===e)},Yl=Vs,Ql=rt,Xl=T,$l=Bi,Zl=_e("iterator"),ed=function(e){if(!Xl(e))return Ql(e,Zl)||Ql(e,"@@iterator")||$l[Yl(e)]},td=Fe,id=et,rd=Ce,nd=Qe,od=ed,sd=TypeError,ad=function(e,t){var i=arguments.length<2?od(e):t;if(id(i))return rd(td(i,e));throw sd(nd(e)+" is not iterable")},cd=Fe,ld=Ce,dd=rt,ud=function(e,t,i){var r,n;ld(e);try{if(!(r=dd(e,"return"))){if("throw"===t)throw i;return i}r=cd(r,e);}catch(SB){n=!0,r=SB;}if("throw"===t)throw i;if(n)throw r;return ld(r),i},hd=Sa,pd=Fe,md=Ce,_d=Qe,fd=ql,gd=Wt,Td=We,Ed=ad,vd=ed,yd=ud,Sd=TypeError,Id=function(e,t){this.stopped=e,this.result=t;},Rd=Id.prototype,Ad=function(e,t,i){var r,n,o,s,a,c,l,d=i&&i.that,u=!(!i||!i.AS_ENTRIES),h=!(!i||!i.IS_RECORD),p=!(!i||!i.IS_ITERATOR),m=!(!i||!i.INTERRUPTED),_=hd(t,d),f=function(e){return r&&yd(r,"normal",e),new Id(!0,e)},g=function(e){return u?(md(e),m?_(e[0],e[1],f):_(e[0],e[1])):m?_(e,f):_(e)};if(h)r=e.iterator;else if(p)r=e;else {if(!(n=vd(e)))throw Sd(_d(e)+" is not iterable");if(fd(n)){for(o=0,s=gd(e);s>o;o++)if((a=g(e[o]))&&Td(Rd,a))return a;return new Id(!1)}r=Ed(e,n);}for(c=h?e.next:r.next;!(l=pd(c,r)).done;){try{a=g(l.value);}catch(SB){yd(r,"throw",SB);}if("object"==typeof a&&a&&Td(Rd,a))return a}return new Id(!1)},Cd=_e("iterator"),bd=!1;try{var kd=0,Dd={next:function(){return {done:!!kd++}},return:function(){bd=!0;}};Dd[Cd]=function(){return this},Array.from(Dd,(function(){throw 2}));}catch(SB){}var Nd=function(e,t){if(!t&&!bd)return !1;var i=!1;try{var r={};r[Cd]=function(){return {next:function(){return {done:i=!0}}}},e(r);}catch(SB){}return i},wd=kc,Od=Gc.CONSTRUCTOR||!Nd((function(e){wd.all(e).then(void 0,(function(){}));})),Pd=Fe,Md=et,Ld=Jc,xd=bc,Vd=Ad;Vn({target:"Promise",stat:!0,forced:Od},{all:function(e){var t=this,i=Ld.f(t),r=i.resolve,n=i.reject,o=xd((function(){var i=Md(t.resolve),o=[],s=0,a=1;Vd(e,(function(e){var c=s++,l=!1;a++,Pd(i,t,e).then((function(e){l||(l=!0,o[c]=e,--a||r(o));}),n);})),--a||r(o);}));return o.error&&n(o.value),i.promise}});var Ud=Vn,Fd=Gc.CONSTRUCTOR,Bd=kc,Hd=je,jd=Ee,Wd=tn,Gd=Bd&&Bd.prototype;if(Ud({target:"Promise",proto:!0,forced:Fd,real:!0},{catch:function(e){return this.then(void 0,e)}}),jd(Bd)){var Jd=Hd("Promise").prototype.catch;Gd.catch!==Jd&&Wd(Gd,"catch",Jd,{unsafe:!0});}var Kd=Fe,zd=et,qd=Jc,Yd=bc,Qd=Ad;Vn({target:"Promise",stat:!0,forced:Od},{race:function(e){var t=this,i=qd.f(t),r=i.reject,n=Yd((function(){var n=zd(t.resolve);Qd(e,(function(e){Kd(n,t,e).then(i.resolve,r);}));}));return n.error&&r(n.value),i.promise}});var Xd=Fe,$d=Jc;Vn({target:"Promise",stat:!0,forced:Gc.CONSTRUCTOR},{reject:function(e){var t=$d.f(this);return Xd(t.reject,void 0,e),t.promise}});var Zd=Ce,eu=Se,tu=Jc,iu=function(e,t){if(Zd(e),eu(t)&&t.constructor===e)return t;var i=tu.f(e);return (0, i.resolve)(t),i.promise},ru=Vn,nu=Gc.CONSTRUCTOR,ou=iu;je("Promise"),ru({target:"Promise",stat:!0,forced:nu},{resolve:function(e){return ou(this,e)}});var su=Ee,au=Se,cu=So,lu=function(e,t,i){var r,n;return cu&&su(r=t.constructor)&&r!==i&&au(n=r.prototype)&&n!==i.prototype&&cu(e,n),e},du=Se,uu=h,hu=_e("match"),pu=Vs,mu=String,_u=function(e){if("Symbol"===pu(e))throw TypeError("Cannot convert a Symbol value to a string");return mu(e)},fu=Ce,gu=function(){var e=fu(this),t="";return e.hasIndices&&(t+="d"),e.global&&(t+="g"),e.ignoreCase&&(t+="i"),e.multiline&&(t+="m"),e.dotAll&&(t+="s"),e.unicode&&(t+="u"),e.unicodeSets&&(t+="v"),e.sticky&&(t+="y"),t},Tu=Fe,Eu=W,vu=We,yu=gu,Su=RegExp.prototype,Iu=i,Ru=C.RegExp,Au=Iu((function(){var e=Ru("a","y");return e.lastIndex=2,null!=e.exec("abcd")})),Cu=Au||Iu((function(){return !Ru("a","y").sticky})),bu=Au||Iu((function(){var e=Ru("^r","gy");return e.lastIndex=2,null!=e.exec("str")})),ku={BROKEN_CARET:bu,MISSED_STICKY:Cu,UNSUPPORTED_Y:Au},Du=Ne.f,Nu=i,wu=C.RegExp,Ou=Nu((function(){var e=wu(".","s");return !(e.dotAll&&e.exec("\n")&&"s"===e.flags)})),Pu=i,Mu=C.RegExp,Lu=Pu((function(){var e=Mu("(?<a>b)","g");return "b"!==e.exec("b").groups.a||"bc"!=="b".replace(e,"$<a>c")})),xu=ke,Vu=C,Uu=c,Fu=Dn,Bu=lu,Hu=zi,ju=rn.f,Wu=We,Gu=function(e){var t;return du(e)&&(void 0!==(t=e[hu])?!!t:"RegExp"==uu(e))},Ju=_u,Ku=function(e){var t=e.flags;return void 0!==t||"flags"in Su||Eu(e,"flags")||!vu(Su,e)?t:Tu(yu,e)},zu=ku,qu=function(e,t,i){i in e||Du(e,i,{configurable:!0,get:function(){return t[i]},set:function(e){t[i]=e;}});},Yu=tn,Qu=i,Xu=W,$u=ar.enforce,Zu=Cs,eh=Ou,th=Lu,ih=_e("match"),rh=Vu.RegExp,nh=rh.prototype,oh=Vu.SyntaxError,sh=Uu(nh.exec),ah=Uu("".charAt),ch=Uu("".replace),lh=Uu("".indexOf),dh=Uu("".slice),uh=/^\?<[^\s\d!#%&*+<=>@^][^\s!#%&*+<=>@^]*>/,hh=/a/g,ph=/a/g,mh=new rh(hh)!==hh,_h=zu.MISSED_STICKY,fh=zu.UNSUPPORTED_Y,gh=xu&&(!mh||_h||eh||th||Qu((function(){return ph[ih]=!1,rh(hh)!=hh||rh(ph)==ph||"/a/i"!=rh(hh,"i")})));if(Fu("RegExp",gh)){for(var Th=function(e,t){var i,r,n,o,s,a,c=Wu(nh,this),l=Gu(e),d=void 0===t,u=[],h=e;if(!c&&l&&d&&e.constructor===Th)return e;if((l||Wu(nh,e))&&(e=e.source,d&&(t=Ku(h))),e=void 0===e?"":Ju(e),t=void 0===t?"":Ju(t),h=e,eh&&"dotAll"in hh&&(r=!!t&&lh(t,"s")>-1)&&(t=ch(t,/s/g,"")),i=t,_h&&"sticky"in hh&&(n=!!t&&lh(t,"y")>-1)&&fh&&(t=ch(t,/y/g,"")),th&&(o=function(e){for(var t,i=e.length,r=0,n="",o=[],s={},a=!1,c=!1,l=0,d="";r<=i;r++){if("\\"===(t=ah(e,r)))t+=ah(e,++r);else if("]"===t)a=!1;else if(!a)switch(!0){case"["===t:a=!0;break;case"("===t:sh(uh,dh(e,r+1))&&(r+=2,c=!0),n+=t,l++;continue;case">"===t&&c:if(""===d||Xu(s,d))throw new oh("Invalid capture group name");s[d]=!0,o[o.length]=[d,l],c=!1,d="";continue}c?d+=t:n+=t;}return [n,o]}(e),e=o[0],u=o[1]),s=Bu(rh(e,t),c?this:nh,Th),(r||n||u.length)&&(a=$u(s),r&&(a.dotAll=!0,a.raw=Th(function(e){for(var t,i=e.length,r=0,n="",o=!1;r<=i;r++)"\\"!==(t=ah(e,r))?o||"."!==t?("["===t?o=!0:"]"===t&&(o=!1),n+=t):n+="[\\s\\S]":n+=t+ah(e,++r);return n}(e),i)),n&&(a.sticky=!0),u.length&&(a.groups=u)),e!==h)try{Hu(s,"source",""===h?"(?:)":h);}catch(SB){}return s},Eh=ju(rh),vh=0;Eh.length>vh;)qu(Th,rh,Eh[vh++]);nh.constructor=Th,Th.prototype=nh,Yu(Vu,"RegExp",Th,{constructor:!0});}Zu("RegExp");var yh=Fe,Sh=c,Ih=_u,Rh=gu,Ah=ku,Ch=Ni,bh=ar.get,kh=Ou,Dh=Lu,Nh=b("native-string-replace",String.prototype.replace),wh=RegExp.prototype.exec,Oh=wh,Ph=Sh("".charAt),Mh=Sh("".indexOf),Lh=Sh("".replace),xh=Sh("".slice),Vh=function(){var e=/a/,t=/b*/g;return yh(wh,e,"a"),yh(wh,t,"a"),0!==e.lastIndex||0!==t.lastIndex}(),Uh=Ah.BROKEN_CARET,Fh=void 0!==/()??/.exec("")[1];(Vh||Fh||Uh||kh||Dh)&&(Oh=function(e){var t,i,r,n,o,s,a,c=this,l=bh(c),d=Ih(e),u=l.raw;if(u)return u.lastIndex=c.lastIndex,t=yh(Oh,u,d),c.lastIndex=u.lastIndex,t;var h=l.groups,p=Uh&&c.sticky,m=yh(Rh,c),_=c.source,f=0,g=d;if(p&&(m=Lh(m,"y",""),-1===Mh(m,"g")&&(m+="g"),g=xh(d,c.lastIndex),c.lastIndex>0&&(!c.multiline||c.multiline&&"\n"!==Ph(d,c.lastIndex-1))&&(_="(?: "+_+")",g=" "+g,f++),i=new RegExp("^(?:"+_+")",m)),Fh&&(i=new RegExp("^"+_+"$(?!\\s)",m)),Vh&&(r=c.lastIndex),n=yh(wh,p?i:c,g),p?n?(n.input=xh(n.input,f),n[0]=xh(n[0],f),n.index=c.lastIndex,c.lastIndex+=n[0].length):c.lastIndex=0:Vh&&n&&(c.lastIndex=c.global?n.index+n[0].length:r),Fh&&n&&n.length>1&&yh(Nh,n[0],i,(function(){for(o=1;o<arguments.length-2;o++)void 0===arguments[o]&&(n[o]=void 0);})),n&&h)for(n.groups=s=Ch(null),o=0;o<h.length;o++)s[(a=h[o])[0]]=n[a[1]];return n});var Bh=Oh;Vn({target:"RegExp",proto:!0,forced:/./.exec!==Bh},{exec:Bh});var Hh=h,jh=Array.isArray||function(e){return "Array"==Hh(e)},Wh=jh,Gh=ta,Jh=Se,Kh=_e("species"),zh=Array,qh=function(e){var t;return Wh(e)&&(t=e.constructor,(Gh(t)&&(t===zh||Wh(t.prototype))||Jh(t)&&null===(t=t[Kh]))&&(t=void 0)),void 0===t?zh:t},Yh=Sa,Qh=g,Xh=B,$h=Wt,Zh=function(e,t){return new(qh(e))(0===t?0:t)},ep=c([].push),tp=function(e){var t=1==e,i=2==e,r=3==e,n=4==e,o=6==e,s=7==e,a=5==e||o;return function(c,l,d,u){for(var h,p,m=Xh(c),_=Qh(m),f=Yh(l,d),g=$h(_),T=0,E=u||Zh,v=t?E(c,g):i||s?E(c,0):void 0;g>T;T++)if((a||T in _)&&(p=f(h=_[T],T,m),e))if(t)v[T]=p;else if(p)switch(e){case 3:return !0;case 5:return h;case 6:return T;case 2:ep(v,h);}else switch(e){case 4:return !1;case 7:ep(v,h);}return o?-1:r||n?n:v}},ip={forEach:tp(0),map:tp(1),filter:tp(2),some:tp(3),every:tp(4),find:tp(5),findIndex:tp(6),filterReject:tp(7)},rp=i,np=function(e,t){var i=[][e];return !!i&&rp((function(){i.call(null,t||function(){return 1},1);}))},op=ip.forEach,sp=np("forEach")?[].forEach:function(e){return op(this,e,arguments.length>1?arguments[1]:void 0)},ap=C,cp=rs,lp=ss,dp=sp,up=zi,hp=function(e){if(e&&e.forEach!==dp)try{up(e,"forEach",dp);}catch(SB){e.forEach=dp;}};for(var pp in cp)cp[pp]&&hp(ap[pp]&&ap[pp].prototype);hp(lp);var mp=et,_p=B,fp=g,gp=Wt,Tp=TypeError,Ep=function(e){return function(t,i,r,n){mp(i);var o=_p(t),s=fp(o),a=gp(o),c=e?a-1:0,l=e?-1:1;if(r<2)for(;;){if(c in s){n=s[c],c+=l;break}if(c+=l,e?c<0:a<=c)throw Tp("Reduce of empty array with no initial value")}for(;e?c>=0:a>c;c+=l)c in s&&(n=i(n,s[c],c,o));return n}},vp={left:Ep(!1),right:Ep(!0)}.left;Vn({target:"Array",proto:!0,forced:!Ts&&ie>79&&ie<83||!np("reduce")},{reduce:function(e){var t=arguments.length;return vp(this,e,t,t>1?arguments[1]:void 0)}});var yp=Ta,Sp=tn,Ip=Bh,Rp=i,Ap=_e,Cp=zi,bp=Ap("species"),kp=RegExp.prototype,Dp=c,Np=Mt,wp=_u,Op=y,Pp=Dp("".charAt),Mp=Dp("".charCodeAt),Lp=Dp("".slice),xp=function(e){return function(t,i){var r,n,o=wp(Op(t)),s=Np(i),a=o.length;return s<0||s>=a?e?"":void 0:(r=Mp(o,s))<55296||r>56319||s+1===a||(n=Mp(o,s+1))<56320||n>57343?e?Pp(o,s):r:e?Lp(o,s,s+2):n-56320+(r-55296<<10)+65536}},Vp={codeAt:xp(!1),charAt:xp(!0)},Up=Vp.charAt,Fp=c,Bp=B,Hp=Math.floor,jp=Fp("".charAt),Wp=Fp("".replace),Gp=Fp("".slice),Jp=/\$([$&'`]|\d{1,2}|<[^>]*>)/g,Kp=/\$([$&'`]|\d{1,2})/g,zp=Fe,qp=Ce,Yp=Ee,Qp=h,Xp=Bh,$p=TypeError,Zp=_a,em=Fe,tm=c,im=function(e,t,i,r){var n=Ap(e),o=!Rp((function(){var t={};return t[n]=function(){return 7},7!=""[e](t)})),s=o&&!Rp((function(){var t=!1,i=/a/;return "split"===e&&((i={}).constructor={},i.constructor[bp]=function(){return i},i.flags="",i[n]=/./[n]),i.exec=function(){return t=!0,null},i[n](""),!t}));if(!o||!s||i){var a=yp(/./[n]),c=t(n,""[e],(function(e,t,i,r,n){var s=yp(e),c=t.exec;return c===Ip||c===kp.exec?o&&!n?{done:!0,value:a(t,i,r)}:{done:!0,value:s(i,t,r)}:{done:!1}}));Sp(String.prototype,e,c[0]),Sp(kp,n,c[1]);}r&&Cp(kp[n],"sham",!0);},rm=i,nm=Ce,om=Ee,sm=T,am=Mt,cm=Ht,lm=_u,dm=y,um=function(e,t,i){return t+(i?Up(e,t).length:1)},hm=rt,pm=function(e,t,i,r,n,o){var s=i+e.length,a=r.length,c=Kp;return void 0!==n&&(n=Bp(n),c=Jp),Wp(o,c,(function(o,c){var l;switch(jp(c,0)){case"$":return "$";case"&":return e;case"`":return Gp(t,0,i);case"'":return Gp(t,s);case"<":l=n[Gp(c,1,-1)];break;default:var d=+c;if(0===d)return o;if(d>a){var u=Hp(d/10);return 0===u?o:u<=a?void 0===r[u-1]?jp(c,1):r[u-1]+jp(c,1):o}l=r[d-1];}return void 0===l?"":l}))},mm=function(e,t){var i=e.exec;if(Yp(i)){var r=zp(i,e,t);return null!==r&&qp(r),r}if("RegExp"===Qp(e))return zp(Xp,e,t);throw $p("RegExp#exec called on incompatible receiver")},_m=_e("replace"),fm=Math.max,gm=Math.min,Tm=tm([].concat),Em=tm([].push),vm=tm("".indexOf),ym=tm("".slice),Sm="$0"==="a".replace(/./,"$0"),Im=!!/./[_m]&&""===/./[_m]("a","$0"),Rm=!rm((function(){var e=/./;return e.exec=function(){var e=[];return e.groups={a:"7"},e},"7"!=="".replace(e,"$<a>")}));im("replace",(function(e,t,i){var r=Im?"$":"$0";return [function(e,i){var r=dm(this),n=sm(e)?void 0:hm(e,_m);return n?em(n,e,r,i):em(t,lm(r),e,i)},function(e,n){var o=nm(this),s=lm(e);if("string"==typeof n&&-1===vm(n,r)&&-1===vm(n,"$<")){var a=i(t,o,s,n);if(a.done)return a.value}var c=om(n);c||(n=lm(n));var l=o.global;if(l){var d=o.unicode;o.lastIndex=0;}for(var u=[];;){var h=mm(o,s);if(null===h)break;if(Em(u,h),!l)break;""===lm(h[0])&&(o.lastIndex=um(s,cm(o.lastIndex),d));}for(var p,m="",_=0,f=0;f<u.length;f++){for(var g=lm((h=u[f])[0]),T=fm(gm(am(h.index),s.length),0),E=[],v=1;v<h.length;v++)Em(E,void 0===(p=h[v])?p:String(p));var y=h.groups;if(c){var S=Tm([g],E,T,s);void 0!==y&&Em(S,y);var I=lm(Zp(n,void 0,S));}else I=pm(g,s,T,E,y,n);T>=_&&(m+=ym(s,_,T)+I,_=T+g.length);}return m+ym(s,_)}]}),!Rm||!Sm||Im);var Am=qt.includes,Cm=Fi;Vn({target:"Array",proto:!0,forced:i((function(){return !Array(1).includes()}))},{includes:function(e){return Am(this,e,arguments.length>1?arguments[1]:void 0)}}),Cm("includes");var bm=Mt,km=_u,Dm=y,Nm=RangeError,wm=c,Om=Ht,Pm=_u,Mm=function(e){var t=km(Dm(this)),i="",r=bm(e);if(r<0||Infinity==r)throw Nm("Wrong number of repetitions");for(;r>0;(r>>>=1)&&(t+=t))1&r&&(i+=t);return i},Lm=y,xm=wm(Mm),Vm=wm("".slice),Um=Math.ceil,Fm=function(e){return function(t,i,r){var n,o,s=Pm(Lm(t)),a=Om(i),c=s.length,l=void 0===r?" ":Pm(r);return a<=c||""==l?s:((o=xm(l,Um((n=a-c)/l.length))).length>n&&(o=Vm(o,0,n)),e?s+o:o+s)}},Bm={start:Fm(!1),end:Fm(!0)},Hm=/Version\/10(?:\.\d+){1,2}(?: [\w./]+)?(?: Mobile\/\w+)? Safari\//.test(Y),jm=Bm.start;Vn({target:"String",proto:!0,forced:Hm},{padStart:function(e){return jm(this,e,arguments.length>1?arguments[1]:void 0)}});var Wm=i,Gm=ke,Jm=_e("iterator"),Km=!Wm((function(){var e=new URL("b?a=1&b=2&c=3","http://a"),t=e.searchParams,i="";return e.pathname="c%20d",t.forEach((function(e,r){t.delete("b"),i+=r+e;})),!t.size&&!Gm||!t.sort||"http://a/c%20d?a=1&c=3"!==e.href||"3"!==t.get("c")||"a=1"!==String(new URLSearchParams("?a=1"))||!t[Jm]||"a"!==new URL("https://a@b").username||"b"!==new URLSearchParams(new URLSearchParams("a=b")).get("a")||"xn--e1aybc"!==new URL("http://тест").host||"#%D0%B1"!==new URL("http://a#б").hash||"a1c3"!==i||"x"!==new URL("http://x",void 0).host})),zm=tn,qm=function(e,t,i){for(var r in t)zm(e,r,t[r],i);return e},Ym=Tt,Qm=Ne,Xm=Gi,$m=function(e,t,i){var r=Ym(t);r in e?Qm.f(e,r,Xm(0,i)):e[r]=i;},Zm=Ut,e_=Wt,t_=$m,i_=Array,r_=Math.max,n_=function(e,t,i){for(var r=e_(e),n=Zm(t,r),o=Zm(void 0===i?r:i,r),s=i_(r_(o-n,0)),a=0;n<o;n++,a++)t_(s,a,e[n]);return s.length=a,s},o_=n_,s_=Math.floor,a_=function(e,t){var i=e.length,r=s_(i/2);return i<8?c_(e,t):l_(e,a_(o_(e,0,r),t),a_(o_(e,r),t),t)},c_=function(e,t){for(var i,r,n=e.length,o=1;o<n;){for(r=o,i=e[o];r&&t(e[r-1],i)>0;)e[r]=e[--r];r!==o++&&(e[r]=i);}return e},l_=function(e,t,i,r){for(var n=t.length,o=i.length,s=0,a=0;s<n||a<o;)e[s+a]=s<n&&a<o?r(t[s],i[a])<=0?t[s++]:i[a++]:s<n?t[s++]:i[a++];return e},d_=a_,u_=Vn,h_=C,p_=Fe,m_=c,__=ke,f_=Km,g_=tn,T_=ys,E_=qm,v_=oo,y_=po,S_=ar,I_=Ds,R_=Ee,A_=W,C_=Sa,b_=Vs,k_=Ce,D_=Se,N_=_u,w_=Ni,O_=Gi,P_=ad,M_=ed,L_=Aa,x_=d_,V_=_e("iterator"),U_="URLSearchParams",F_=U_+"Iterator",B_=S_.set,H_=S_.getterFor(U_),j_=S_.getterFor(F_),W_=Object.getOwnPropertyDescriptor,G_=function(e){if(!__)return h_[e];var t=W_(h_,e);return t&&t.value},J_=G_("fetch"),K_=G_("Request"),z_=G_("Headers"),q_=K_&&K_.prototype,Y_=z_&&z_.prototype,Q_=h_.RegExp,X_=h_.TypeError,$_=h_.decodeURIComponent,Z_=h_.encodeURIComponent,ef=m_("".charAt),tf=m_([].join),rf=m_([].push),nf=m_("".replace),of=m_([].shift),sf=m_([].splice),af=m_("".split),cf=m_("".slice),lf=/\+/g,df=Array(4),uf=function(e){return df[e-1]||(df[e-1]=Q_("((?:%[\\da-f]{2}){"+e+"})","gi"))},hf=function(e){try{return $_(e)}catch(SB){return e}},pf=function(e){var t=nf(e,lf," "),i=4;try{return $_(t)}catch(SB){for(;i;)t=nf(t,uf(i--),hf);return t}},mf=/[!'()~]|%20/g,_f={"!":"%21","'":"%27","(":"%28",")":"%29","~":"%7E","%20":"+"},ff=function(e){return _f[e]},gf=function(e){return nf(Z_(e),mf,ff)},Tf=y_((function(e,t){B_(this,{type:F_,iterator:P_(H_(e).entries),kind:t});}),"Iterator",(function(){var e=j_(this),t=e.kind,i=e.iterator.next(),r=i.value;return i.done||(i.value="keys"===t?r.key:"values"===t?r.value:[r.key,r.value]),i}),!0),Ef=function(e){this.entries=[],this.url=null,void 0!==e&&(D_(e)?this.parseObject(e):this.parseQuery("string"==typeof e?"?"===ef(e,0)?cf(e,1):e:N_(e)));};Ef.prototype={type:U_,bindURL:function(e){this.url=e,this.update();},parseObject:function(e){var t,i,r,n,o,s,a,c=M_(e);if(c)for(i=(t=P_(e,c)).next;!(r=p_(i,t)).done;){if(o=(n=P_(k_(r.value))).next,(s=p_(o,n)).done||(a=p_(o,n)).done||!p_(o,n).done)throw X_("Expected sequence with length 2");rf(this.entries,{key:N_(s.value),value:N_(a.value)});}else for(var l in e)A_(e,l)&&rf(this.entries,{key:l,value:N_(e[l])});},parseQuery:function(e){if(e)for(var t,i,r=af(e,"&"),n=0;n<r.length;)(t=r[n++]).length&&(i=af(t,"="),rf(this.entries,{key:pf(of(i)),value:pf(tf(i,"="))}));},serialize:function(){for(var e,t=this.entries,i=[],r=0;r<t.length;)e=t[r++],rf(i,gf(e.key)+"="+gf(e.value));return tf(i,"&")},update:function(){this.entries.length=0,this.parseQuery(this.url.query);},updateURL:function(){this.url&&this.url.update();}};var vf=function(){I_(this,yf);var e=B_(this,new Ef(arguments.length>0?arguments[0]:void 0));__||(this.length=e.entries.length);},yf=vf.prototype;if(E_(yf,{append:function(e,t){L_(arguments.length,2);var i=H_(this);rf(i.entries,{key:N_(e),value:N_(t)}),__||this.length++,i.updateURL();},delete:function(e){L_(arguments.length,1);for(var t=H_(this),i=t.entries,r=N_(e),n=0;n<i.length;)i[n].key===r?sf(i,n,1):n++;__||(this.length=i.length),t.updateURL();},get:function(e){L_(arguments.length,1);for(var t=H_(this).entries,i=N_(e),r=0;r<t.length;r++)if(t[r].key===i)return t[r].value;return null},getAll:function(e){L_(arguments.length,1);for(var t=H_(this).entries,i=N_(e),r=[],n=0;n<t.length;n++)t[n].key===i&&rf(r,t[n].value);return r},has:function(e){L_(arguments.length,1);for(var t=H_(this).entries,i=N_(e),r=0;r<t.length;)if(t[r++].key===i)return !0;return !1},set:function(e,t){L_(arguments.length,1);for(var i,r=H_(this),n=r.entries,o=!1,s=N_(e),a=N_(t),c=0;c<n.length;c++)(i=n[c]).key===s&&(o?sf(n,c--,1):(o=!0,i.value=a));o||rf(n,{key:s,value:a}),__||(this.length=n.length),r.updateURL();},sort:function(){var e=H_(this);x_(e.entries,(function(e,t){return e.key>t.key?1:-1})),e.updateURL();},forEach:function(e){for(var t,i=H_(this).entries,r=C_(e,arguments.length>1?arguments[1]:void 0),n=0;n<i.length;)r((t=i[n++]).value,t.key,this);},keys:function(){return new Tf(this,"keys")},values:function(){return new Tf(this,"values")},entries:function(){return new Tf(this,"entries")}},{enumerable:!0}),g_(yf,V_,yf.entries,{name:"entries"}),g_(yf,"toString",(function(){return H_(this).serialize()}),{enumerable:!0}),__&&T_(yf,"size",{get:function(){return H_(this).entries.length},configurable:!0,enumerable:!0}),v_(vf,U_),u_({global:!0,constructor:!0,forced:!f_},{URLSearchParams:vf}),!f_&&R_(z_)){var Sf=m_(Y_.has),If=m_(Y_.set),Rf=function(e){if(D_(e)){var t,i=e.body;if(b_(i)===U_)return t=e.headers?new z_(e.headers):new z_,Sf(t,"content-type")||If(t,"content-type","application/x-www-form-urlencoded;charset=UTF-8"),w_(e,{body:O_(0,N_(i)),headers:O_(0,t)})}return e};if(R_(J_)&&u_({global:!0,enumerable:!0,dontCallGetSet:!0,forced:!0},{fetch:function(e){return J_(e,arguments.length>1?Rf(arguments[1]):{})}}),R_(K_)){var Af=function(e){return I_(this,q_),new K_(e,arguments.length>1?Rf(arguments[1]):{})};q_.constructor=Af,Af.prototype=q_,u_({global:!0,constructor:!0,dontCallGetSet:!0,forced:!0},{Request:Af});}}var Cf={URLSearchParams:vf,getState:H_},bf=Vn,kf=kc,Df=i,Nf=je,wf=Ee,Of=da,Pf=iu,Mf=tn,Lf=kf&&kf.prototype;if(bf({target:"Promise",proto:!0,real:!0,forced:!!kf&&Df((function(){Lf.finally.call({then:function(){}},(function(){}));}))},{finally:function(e){var t=Of(this,Nf("Promise")),i=wf(e);return this.then(i?function(i){return Pf(t,e()).then((function(){return i}))}:e,i?function(i){return Pf(t,e()).then((function(){throw i}))}:e)}}),wf(kf)){var xf=Nf("Promise").prototype.finally;Lf.finally!==xf&&Mf(Lf,"finally",xf,{unsafe:!0});}var Vf="\t\n\v\f\r                　\u2028\u2029\ufeff",Uf=y,Ff=_u,Bf=Vf,Hf=c("".replace),jf=RegExp("^["+Bf+"]+"),Wf=RegExp("(^|[^"+Bf+"])["+Bf+"]+$"),Gf=function(e){return function(t){var i=Ff(Uf(t));return 1&e&&(i=Hf(i,jf,"")),2&e&&(i=Hf(i,Wf,"$1")),i}},Jf={start:Gf(1),end:Gf(2),trim:Gf(3)},Kf=Dr.PROPER,zf=i,qf=Vf,Yf=Jf.trim;Vn({target:"String",proto:!0,forced:function(e){return zf((function(){return !!qf[e]()||"​᠎"!=="​᠎"[e]()||Kf&&qf[e].name!==e}))}("trim")},{trim:function(){return Yf(this)}});var Qf="undefined"!=typeof ArrayBuffer&&"undefined"!=typeof DataView,Xf=Mt,$f=Ht,Zf=RangeError,eg=function(e){if(void 0===e)return 0;var t=Xf(e),i=$f(t);if(t!==i)throw Zf("Wrong length or index");return i},tg=Array,ig=Math.abs,rg=Math.pow,ng=Math.floor,og=Math.log,sg=Math.LN2,ag={pack:function(e,t,i){var r,n,o,s=tg(i),a=8*i-t-1,c=(1<<a)-1,l=c>>1,d=23===t?rg(2,-24)-rg(2,-77):0,u=e<0||0===e&&1/e<0?1:0,h=0;for((e=ig(e))!=e||Infinity===e?(n=e!=e?1:0,r=c):(r=ng(og(e)/sg),e*(o=rg(2,-r))<1&&(r--,o*=2),(e+=r+l>=1?d/o:d*rg(2,1-l))*o>=2&&(r++,o/=2),r+l>=c?(n=0,r=c):r+l>=1?(n=(e*o-1)*rg(2,t),r+=l):(n=e*rg(2,l-1)*rg(2,t),r=0));t>=8;)s[h++]=255&n,n/=256,t-=8;for(r=r<<t|n,a+=t;a>0;)s[h++]=255&r,r/=256,a-=8;return s[--h]|=128*u,s},unpack:function(e,t){var i,r=e.length,n=8*r-t-1,o=(1<<n)-1,s=o>>1,a=n-7,c=r-1,l=e[c--],d=127&l;for(l>>=7;a>0;)d=256*d+e[c--],a-=8;for(i=d&(1<<-a)-1,d>>=-a,a+=t;a>0;)i=256*i+e[c--],a-=8;if(0===d)d=1-s;else {if(d===o)return i?NaN:l?-Infinity:Infinity;i+=rg(2,t),d-=s;}return (l?-1:1)*i*rg(2,d-t)}},cg=B,lg=Ut,dg=Wt,ug=function(e){for(var t=cg(this),i=dg(t),r=arguments.length,n=lg(r>1?arguments[1]:void 0,i),o=r>2?arguments[2]:void 0,s=void 0===o?i:lg(o,i);s>n;)t[n++]=e;return t},hg=C,pg=c,mg=ke,_g=Qf,fg=Dr,gg=zi,Tg=ys,Eg=qm,vg=i,yg=Ds,Sg=Mt,Ig=Ht,Rg=eg,Ag=ag,Cg=Kn,bg=So,kg=rn.f,Dg=ug,Ng=n_,wg=oo,Og=ar,Pg=fg.PROPER,Mg=fg.CONFIGURABLE,Lg="ArrayBuffer",xg="DataView",Vg="prototype",Ug="Wrong index",Fg=Og.getterFor(Lg),Bg=Og.getterFor(xg),Hg=Og.set,jg=hg[Lg],Wg=jg,Gg=Wg&&Wg[Vg],Jg=hg[xg],Kg=Jg&&Jg[Vg],zg=Object.prototype,qg=hg.Array,Yg=hg.RangeError,Qg=pg(Dg),Xg=pg([].reverse),$g=Ag.pack,Zg=Ag.unpack,eT=function(e){return [255&e]},tT=function(e){return [255&e,e>>8&255]},iT=function(e){return [255&e,e>>8&255,e>>16&255,e>>24&255]},rT=function(e){return e[3]<<24|e[2]<<16|e[1]<<8|e[0]},nT=function(e){return $g(e,23,4)},oT=function(e){return $g(e,52,8)},sT=function(e,t,i){Tg(e[Vg],t,{configurable:!0,get:function(){return i(this)[t]}});},aT=function(e,t,i,r){var n=Rg(i),o=Bg(e);if(n+t>o.byteLength)throw Yg(Ug);var s=o.bytes,a=n+o.byteOffset,c=Ng(s,a,a+t);return r?c:Xg(c)},cT=function(e,t,i,r,n,o){var s=Rg(i),a=Bg(e);if(s+t>a.byteLength)throw Yg(Ug);for(var c=a.bytes,l=s+a.byteOffset,d=r(+n),u=0;u<t;u++)c[l+u]=d[o?u:t-u-1];};if(_g){var lT=Pg&&jg.name!==Lg;if(vg((function(){jg(1);}))&&vg((function(){new jg(-1);}))&&!vg((function(){return new jg,new jg(1.5),new jg(NaN),1!=jg.length||lT&&!Mg})))lT&&Mg&&gg(jg,"name",Lg);else {(Wg=function(e){return yg(this,Gg),new jg(Rg(e))})[Vg]=Gg;for(var dT,uT=kg(jg),hT=0;uT.length>hT;)(dT=uT[hT++])in Wg||gg(Wg,dT,jg[dT]);Gg.constructor=Wg;}bg&&Cg(Kg)!==zg&&bg(Kg,zg);var pT=new Jg(new Wg(2)),mT=pg(Kg.setInt8);pT.setInt8(0,2147483648),pT.setInt8(1,2147483649),!pT.getInt8(0)&&pT.getInt8(1)||Eg(Kg,{setInt8:function(e,t){mT(this,e,t<<24>>24);},setUint8:function(e,t){mT(this,e,t<<24>>24);}},{unsafe:!0});}else Gg=(Wg=function(e){yg(this,Gg);var t=Rg(e);Hg(this,{type:Lg,bytes:Qg(qg(t),0),byteLength:t}),mg||(this.byteLength=t,this.detached=!1);})[Vg],Kg=(Jg=function(e,t,i){yg(this,Kg),yg(e,Gg);var r=Fg(e),n=r.byteLength,o=Sg(t);if(o<0||o>n)throw Yg("Wrong offset");if(o+(i=void 0===i?n-o:Ig(i))>n)throw Yg("Wrong length");Hg(this,{type:xg,buffer:e,byteLength:i,byteOffset:o,bytes:r.bytes}),mg||(this.buffer=e,this.byteLength=i,this.byteOffset=o);})[Vg],mg&&(sT(Wg,"byteLength",Fg),sT(Jg,"buffer",Bg),sT(Jg,"byteLength",Bg),sT(Jg,"byteOffset",Bg)),Eg(Kg,{getInt8:function(e){return aT(this,1,e)[0]<<24>>24},getUint8:function(e){return aT(this,1,e)[0]},getInt16:function(e){var t=aT(this,2,e,arguments.length>1?arguments[1]:void 0);return (t[1]<<8|t[0])<<16>>16},getUint16:function(e){var t=aT(this,2,e,arguments.length>1?arguments[1]:void 0);return t[1]<<8|t[0]},getInt32:function(e){return rT(aT(this,4,e,arguments.length>1?arguments[1]:void 0))},getUint32:function(e){return rT(aT(this,4,e,arguments.length>1?arguments[1]:void 0))>>>0},getFloat32:function(e){return Zg(aT(this,4,e,arguments.length>1?arguments[1]:void 0),23)},getFloat64:function(e){return Zg(aT(this,8,e,arguments.length>1?arguments[1]:void 0),52)},setInt8:function(e,t){cT(this,1,e,eT,t);},setUint8:function(e,t){cT(this,1,e,eT,t);},setInt16:function(e,t){cT(this,2,e,tT,t,arguments.length>2?arguments[2]:void 0);},setUint16:function(e,t){cT(this,2,e,tT,t,arguments.length>2?arguments[2]:void 0);},setInt32:function(e,t){cT(this,4,e,iT,t,arguments.length>2?arguments[2]:void 0);},setUint32:function(e,t){cT(this,4,e,iT,t,arguments.length>2?arguments[2]:void 0);},setFloat32:function(e,t){cT(this,4,e,nT,t,arguments.length>2?arguments[2]:void 0);},setFloat64:function(e,t){cT(this,8,e,oT,t,arguments.length>2?arguments[2]:void 0);}});wg(Wg,Lg),wg(Jg,xg);var _T={ArrayBuffer:Wg,DataView:Jg},fT=Vn,gT=Ta,TT=i,ET=Ce,vT=Ut,yT=Ht,ST=da,IT=_T.ArrayBuffer,RT=_T.DataView,AT=RT.prototype,CT=gT(IT.prototype.slice),bT=gT(AT.getUint8),kT=gT(AT.setUint8);fT({target:"ArrayBuffer",proto:!0,unsafe:!0,forced:TT((function(){return !new IT(2).slice(1,void 0).byteLength}))},{slice:function(e,t){if(CT&&void 0===t)return CT(ET(this),e);for(var i=ET(this).byteLength,r=vT(e,i),n=vT(void 0===t?i:t,i),o=new(ST(this,IT))(yT(n-r)),s=new RT(this),a=new RT(o),c=0;r<n;)kT(a,c++,bT(s,r++));return o}});var DT,NT,wT,OT={},PT={get exports(){return OT},set exports(e){OT=e;}},MT=Qf,LT=ke,xT=C,VT=Ee,UT=Se,FT=W,BT=Vs,HT=Qe,jT=zi,WT=tn,GT=ys,JT=We,KT=Kn,zT=So,qT=_e,YT=q,QT=ar.enforce,XT=ar.get,$T=xT.Int8Array,ZT=$T&&$T.prototype,eE=xT.Uint8ClampedArray,tE=eE&&eE.prototype,iE=$T&&KT($T),rE=ZT&&KT(ZT),nE=Object.prototype,oE=xT.TypeError,sE=qT("toStringTag"),aE=YT("TYPED_ARRAY_TAG"),cE="TypedArrayConstructor",lE=MT&&!!zT&&"Opera"!==BT(xT.opera),dE=!1,uE={Int8Array:1,Uint8Array:1,Uint8ClampedArray:1,Int16Array:2,Uint16Array:2,Int32Array:4,Uint32Array:4,Float32Array:4,Float64Array:8},hE={BigInt64Array:8,BigUint64Array:8},pE=function(e){var t=KT(e);if(UT(t)){var i=XT(t);return i&&FT(i,cE)?i[cE]:pE(t)}},mE=function(e){if(!UT(e))return !1;var t=BT(e);return FT(uE,t)||FT(hE,t)};for(DT in uE)(wT=(NT=xT[DT])&&NT.prototype)?QT(wT)[cE]=NT:lE=!1;for(DT in hE)(wT=(NT=xT[DT])&&NT.prototype)&&(QT(wT)[cE]=NT);if((!lE||!VT(iE)||iE===Function.prototype)&&(iE=function(){throw oE("Incorrect invocation")},lE))for(DT in uE)xT[DT]&&zT(xT[DT],iE);if((!lE||!rE||rE===nE)&&(rE=iE.prototype,lE))for(DT in uE)xT[DT]&&zT(xT[DT].prototype,rE);if(lE&&KT(tE)!==rE&&zT(tE,rE),LT&&!FT(rE,sE))for(DT in dE=!0,GT(rE,sE,{configurable:!0,get:function(){return UT(this)?this[aE]:void 0}}),uE)xT[DT]&&jT(xT[DT],aE,DT);var _E={NATIVE_ARRAY_BUFFER_VIEWS:lE,TYPED_ARRAY_TAG:dE&&aE,aTypedArray:function(e){if(mE(e))return e;throw oE("Target is not a typed array")},aTypedArrayConstructor:function(e){if(VT(e)&&(!zT||JT(iE,e)))return e;throw oE(HT(e)+" is not a typed array constructor")},exportTypedArrayMethod:function(e,t,i,r){if(LT){if(i)for(var n in uE){var o=xT[n];if(o&&FT(o.prototype,e))try{delete o.prototype[e];}catch(SB){try{o.prototype[e]=t;}catch(s){}}}rE[e]&&!i||WT(rE,e,i?t:lE&&ZT[e]||t,r);}},exportTypedArrayStaticMethod:function(e,t,i){var r,n;if(LT){if(zT){if(i)for(r in uE)if((n=xT[r])&&FT(n,e))try{delete n[e];}catch(SB){}if(iE[e]&&!i)return;try{return WT(iE,e,i?t:lE&&iE[e]||t)}catch(SB){}}for(r in uE)!(n=xT[r])||n[e]&&!i||WT(n,e,t);}},getTypedArrayConstructor:pE,isView:function(e){if(!UT(e))return !1;var t=BT(e);return "DataView"===t||FT(uE,t)||FT(hE,t)},isTypedArray:mE,TypedArray:iE,TypedArrayPrototype:rE},fE=C,gE=i,TE=Nd,EE=_E.NATIVE_ARRAY_BUFFER_VIEWS,vE=fE.ArrayBuffer,yE=fE.Int8Array,SE=!EE||!gE((function(){yE(1);}))||!gE((function(){new yE(-1);}))||!TE((function(e){new yE,new yE(null),new yE(1.5),new yE(e);}),!0)||gE((function(){return 1!==new yE(new vE(2),1,void 0).length})),IE=Se,RE=Math.floor,AE=Number.isInteger||function(e){return !IE(e)&&isFinite(e)&&RE(e)===e},CE=Mt,bE=RangeError,kE=function(e){var t=CE(e);if(t<0)throw bE("The argument can't be less than 0");return t},DE=RangeError,NE=function(e,t){var i=kE(e);if(i%t)throw DE("Wrong offset");return i},wE=Vs,OE=_t,PE=TypeError,ME=function(e){var t=OE(e,"number");if("number"==typeof t)throw PE("Can't convert number to bigint");return BigInt(t)},LE=Sa,xE=Fe,VE=oa,UE=B,FE=Wt,BE=ad,HE=ed,jE=ql,WE=function(e){var t=wE(e);return "BigInt64Array"==t||"BigUint64Array"==t},GE=_E.aTypedArrayConstructor,JE=ME,KE=function(e){var t,i,r,n,o,s,a,c,l=VE(this),d=UE(e),u=arguments.length,h=u>1?arguments[1]:void 0,p=void 0!==h,m=HE(d);if(m&&!jE(m))for(c=(a=BE(d,m)).next,d=[];!(s=xE(c,a)).done;)d.push(s.value);for(p&&u>2&&(h=LE(h,arguments[2])),i=FE(d),r=new(GE(l))(i),n=WE(r),t=0;i>t;t++)o=p?h(d[t],t):d[t],r[t]=n?JE(o):+o;return r},zE=Vn,qE=C,YE=Fe,QE=ke,XE=SE,$E=_E,ZE=_T,ev=Ds,tv=Gi,iv=zi,rv=AE,nv=Ht,ov=eg,sv=NE,av=Tt,cv=W,lv=Vs,dv=Se,uv=qe,hv=Ni,pv=We,mv=So,_v=rn.f,fv=KE,gv=ip.forEach,Tv=Cs,Ev=ys,vv=Ne,yv=cr,Sv=lu,Iv=ar.get,Rv=ar.set,Av=ar.enforce,Cv=vv.f,bv=yv.f,kv=Math.round,Dv=qE.RangeError,Nv=ZE.ArrayBuffer,wv=Nv.prototype,Ov=ZE.DataView,Pv=$E.NATIVE_ARRAY_BUFFER_VIEWS,Mv=$E.TYPED_ARRAY_TAG,Lv=$E.TypedArray,xv=$E.TypedArrayPrototype,Vv=$E.aTypedArrayConstructor,Uv=$E.isTypedArray,Fv="BYTES_PER_ELEMENT",Bv="Wrong length",Hv=function(e,t){Vv(e);for(var i=0,r=t.length,n=new e(r);r>i;)n[i]=t[i++];return n},jv=function(e,t){Ev(e,t,{configurable:!0,get:function(){return Iv(this)[t]}});},Wv=function(e){var t;return pv(wv,e)||"ArrayBuffer"==(t=lv(e))||"SharedArrayBuffer"==t},Gv=function(e,t){return Uv(e)&&!uv(t)&&t in e&&rv(+t)&&t>=0},Jv=function(e,t){return t=av(t),Gv(e,t)?tv(2,e[t]):bv(e,t)},Kv=function(e,t,i){return t=av(t),!(Gv(e,t)&&dv(i)&&cv(i,"value"))||cv(i,"get")||cv(i,"set")||i.configurable||cv(i,"writable")&&!i.writable||cv(i,"enumerable")&&!i.enumerable?Cv(e,t,i):(e[t]=i.value,e)};QE?(Pv||(yv.f=Jv,vv.f=Kv,jv(xv,"buffer"),jv(xv,"byteOffset"),jv(xv,"byteLength"),jv(xv,"length")),zE({target:"Object",stat:!0,forced:!Pv},{getOwnPropertyDescriptor:Jv,defineProperty:Kv}),PT.exports=function(e,t,i){var r=e.match(/\d+/)[0]/8,n=e+(i?"Clamped":"")+"Array",o="get"+e,s="set"+e,a=qE[n],c=a,l=c&&c.prototype,d={},u=function(e,t){Cv(e,t,{get:function(){return function(e,t){var i=Iv(e);return i.view[o](t*r+i.byteOffset,!0)}(this,t)},set:function(e){return function(e,t,n){var o=Iv(e);i&&(n=(n=kv(n))<0?0:n>255?255:255&n),o.view[s](t*r+o.byteOffset,n,!0);}(this,t,e)},enumerable:!0});};Pv?XE&&(c=t((function(e,t,i,n){return ev(e,l),Sv(dv(t)?Wv(t)?void 0!==n?new a(t,sv(i,r),n):void 0!==i?new a(t,sv(i,r)):new a(t):Uv(t)?Hv(c,t):YE(fv,c,t):new a(ov(t)),e,c)})),mv&&mv(c,Lv),gv(_v(a),(function(e){e in c||iv(c,e,a[e]);})),c.prototype=l):(c=t((function(e,t,i,n){ev(e,l);var o,s,a,d=0,h=0;if(dv(t)){if(!Wv(t))return Uv(t)?Hv(c,t):YE(fv,c,t);o=t,h=sv(i,r);var p=t.byteLength;if(void 0===n){if(p%r)throw Dv(Bv);if((s=p-h)<0)throw Dv(Bv)}else if((s=nv(n)*r)+h>p)throw Dv(Bv);a=s/r;}else a=ov(t),o=new Nv(s=a*r);for(Rv(e,{buffer:o,byteOffset:h,byteLength:s,length:a,view:new Ov(o)});d<a;)u(e,d++);})),mv&&mv(c,Lv),l=c.prototype=hv(xv)),l.constructor!==c&&iv(l,"constructor",c),Av(l).TypedArrayConstructor=c,Mv&&iv(l,Mv,n);var h=c!=a;d[n]=c,zE({global:!0,constructor:!0,forced:h,sham:!Pv},d),Fv in c||iv(c,Fv,r),Fv in l||iv(l,Fv,r),Tv(n);}):PT.exports=function(){},OT("Uint8",(function(e){return function(t,i,r){return e(this,t,i,r)}}));var zv=ug,qv=ME,Yv=Vs,Qv=Fe,Xv=i,$v=_E.aTypedArray,Zv=_E.exportTypedArrayMethod,ey=c("".slice);Zv("fill",(function(e){var t=arguments.length;$v(this);var i="Big"===ey(Yv(this),0,3)?qv(e):+e;return Qv(zv,this,i,t>1?arguments[1]:void 0,t>2?arguments[2]:void 0)}),Xv((function(){var e=0;return new Int8Array(2).fill({valueOf:function(){return e++}}),1!==e})));var ty=C,iy=Fe,ry=_E,ny=Wt,oy=NE,sy=B,ay=i,cy=ty.RangeError,ly=ty.Int8Array,dy=ly&&ly.prototype,uy=dy&&dy.set,hy=ry.aTypedArray,py=ry.exportTypedArrayMethod,my=!ay((function(){var e=new Uint8ClampedArray(2);return iy(uy,e,{length:1,0:3},1),3!==e[1]})),_y=my&&ry.NATIVE_ARRAY_BUFFER_VIEWS&&ay((function(){var e=new ly(2);return e.set(1),e.set("2",1),0!==e[0]||2!==e[1]}));py("set",(function(e){hy(this);var t=oy(arguments.length>1?arguments[1]:void 0,1),i=sy(e);if(my)return iy(uy,this,i,t);var r=this.length,n=ny(i),o=0;if(n+t>r)throw cy("Wrong length");for(;o<n;)this[t+o]=i[o++];}),!my||_y);var fy=Y.match(/firefox\/(\d+)/i),gy=!!fy&&+fy[1],Ty=/MSIE|Trident/.test(Y),Ey=Y.match(/AppleWebKit\/(\d+)\./),vy=!!Ey&&+Ey[1],yy=Ta,Sy=i,Iy=et,Ry=d_,Ay=gy,Cy=Ty,by=ie,ky=vy,Dy=_E.aTypedArray,Ny=_E.exportTypedArrayMethod,wy=C.Uint16Array,Oy=wy&&yy(wy.prototype.sort),Py=!(!Oy||Sy((function(){Oy(new wy(2),null);}))&&Sy((function(){Oy(new wy(2),{});}))),My=!!Oy&&!Sy((function(){if(by)return by<74;if(Ay)return Ay<67;if(Cy)return !0;if(ky)return ky<602;var e,t,i=new wy(516),r=Array(516);for(e=0;e<516;e++)t=e%4,i[e]=515-e,r[e]=e-2*t+3;for(Oy(i,(function(e,t){return (e/4|0)-(t/4|0)})),e=0;e<516;e++)if(i[e]!==r[e])return !0}));Ny("sort",(function(e){return void 0!==e&&Iy(e),My?Oy(this,e):Ry(Dy(this),function(e){return function(t,i){return void 0!==e?+e(t,i)||0:i!=i?-1:t!=t?1:0===t&&0===i?1/t>0&&1/i<0?1:-1:t>i}}(e))}),!My||Py);var Ly=Vn,xy=ke,Vy=c,Uy=W,Fy=Ee,By=We,Hy=_u,jy=ys,Wy=vn,Gy=C.Symbol,Jy=Gy&&Gy.prototype;if(xy&&Fy(Gy)&&(!("description"in Jy)||void 0!==Gy().description)){var Ky={},zy=function(){var e=arguments.length<1||void 0===arguments[0]?void 0:Hy(arguments[0]),t=By(Jy,this)?new Gy(e):void 0===e?Gy():Gy(e);return ""===e&&(Ky[t]=!0),t};Wy(zy,Gy),zy.prototype=Jy,Jy.constructor=zy;var qy="Symbol(test)"==String(Gy("test")),Yy=Vy(Jy.valueOf),Qy=Vy(Jy.toString),Xy=/^Symbol\((.*)\)[^)]+$/,$y=Vy("".replace),Zy=Vy("".slice);jy(Jy,"description",{configurable:!0,get:function(){var e=Yy(this);if(Uy(Ky,e))return "";var t=Qy(e),i=qy?Zy(t,7,-1):$y(t,Xy,"$1");return ""===i?void 0:i}}),Ly({global:!0,constructor:!0,forced:!0},{Symbol:zy});}var eS=Vp.charAt,tS=_u,iS=ar,rS=jo,nS=Wo,oS="String Iterator",sS=iS.set,aS=iS.getterFor(oS);rS(String,"String",(function(e){sS(this,{type:oS,string:tS(e),index:0});}),(function(){var e,t=aS(this),i=t.string,r=t.index;return r>=i.length?nS(void 0,!0):(e=eS(i,r),t.index+=e.length,nS(e,!1))}));var cS,lS=ke,dS=c,uS=Fe,hS=i,pS=oi,mS=sn,_S=lr,fS=B,gS=g,TS=Object.assign,ES=Object.defineProperty,vS=dS([].concat),yS=!TS||hS((function(){if(lS&&1!==TS({b:1},TS(ES({},"a",{enumerable:!0,get:function(){ES(this,"b",{value:3,enumerable:!1});}}),{b:2})).b)return !0;var e={},t={},i=Symbol(),r="abcdefghijklmnopqrst";return e[i]=7,r.split("").forEach((function(e){t[e]=e;})),7!=TS({},e)[i]||pS(TS({},t)).join("")!=r}))?function(e,t){for(var i=fS(e),r=arguments.length,n=1,o=mS.f,s=_S.f;r>n;)for(var a,c=gS(arguments[n++]),l=o?vS(pS(c),o(c)):pS(c),d=l.length,u=0;d>u;)a=l[u++],lS&&!uS(s,c,a)||(i[a]=c[a]);return i}:TS,SS=Ce,IS=ud,RS=Sa,AS=Fe,CS=B,bS=function(e,t,i,r){try{return r?t(SS(i)[0],i[1]):t(i)}catch(SB){IS(e,"throw",SB);}},kS=ql,DS=ta,NS=Wt,wS=$m,OS=ad,PS=ed,MS=Array,LS=c,xS=2147483647,VS=/[^\0-\u007E]/,US=/[.\u3002\uFF0E\uFF61]/g,FS="Overflow: input needs wider integers to process",BS=RangeError,HS=LS(US.exec),jS=Math.floor,WS=String.fromCharCode,GS=LS("".charCodeAt),JS=LS([].join),KS=LS([].push),zS=LS("".replace),qS=LS("".split),YS=LS("".toLowerCase),QS=function(e){return e+22+75*(e<26)},XS=function(e,t,i){var r=0;for(e=i?jS(e/700):e>>1,e+=jS(e/t);e>455;)e=jS(e/35),r+=36;return jS(r+36*e/(e+38))},$S=function(e){var t=[];e=function(e){for(var t=[],i=0,r=e.length;i<r;){var n=GS(e,i++);if(n>=55296&&n<=56319&&i<r){var o=GS(e,i++);56320==(64512&o)?KS(t,((1023&n)<<10)+(1023&o)+65536):(KS(t,n),i--);}else KS(t,n);}return t}(e);var i,r,n=e.length,o=128,s=0,a=72;for(i=0;i<e.length;i++)(r=e[i])<128&&KS(t,WS(r));var c=t.length,l=c;for(c&&KS(t,"-");l<n;){var d=xS;for(i=0;i<e.length;i++)(r=e[i])>=o&&r<d&&(d=r);var u=l+1;if(d-o>jS((xS-s)/u))throw BS(FS);for(s+=(d-o)*u,o=d,i=0;i<e.length;i++){if((r=e[i])<o&&++s>xS)throw BS(FS);if(r==o){for(var h=s,p=36;;){var m=p<=a?1:p>=a+26?26:p-a;if(h<m)break;var _=h-m,f=36-m;KS(t,WS(QS(m+_%f))),h=jS(_/f),p+=36;}KS(t,WS(QS(h))),a=XS(s,u,l==c),s=0,l++;}}s++,o++;}return JS(t,"")},ZS=Vn,eI=ke,tI=Km,iI=C,rI=Sa,nI=c,oI=tn,sI=ys,aI=Ds,cI=W,lI=yS,dI=function(e){var t=CS(e),i=DS(this),r=arguments.length,n=r>1?arguments[1]:void 0,o=void 0!==n;o&&(n=RS(n,r>2?arguments[2]:void 0));var s,a,c,l,d,u,h=PS(t),p=0;if(!h||this===MS&&kS(h))for(s=NS(t),a=i?new this(s):MS(s);s>p;p++)u=o?n(t[p],p):t[p],wS(a,p,u);else for(d=(l=OS(t,h)).next,a=i?new this:[];!(c=AS(d,l)).done;p++)u=o?bS(l,n,[c.value,p],!0):c.value,wS(a,p,u);return a.length=p,a},uI=n_,hI=Vp.codeAt,pI=function(e){var t,i,r=[],n=qS(zS(YS(e),US,"."),".");for(t=0;t<n.length;t++)i=n[t],KS(r,HS(VS,i)?"xn--"+$S(i):i);return JS(r,".")},mI=_u,_I=oo,fI=Aa,gI=Cf,TI=ar,EI=TI.set,vI=TI.getterFor("URL"),yI=gI.URLSearchParams,SI=gI.getState,II=iI.URL,RI=iI.TypeError,AI=iI.parseInt,CI=Math.floor,bI=Math.pow,kI=nI("".charAt),DI=nI(/./.exec),NI=nI([].join),wI=nI(1..toString),OI=nI([].pop),PI=nI([].push),MI=nI("".replace),LI=nI([].shift),xI=nI("".split),VI=nI("".slice),UI=nI("".toLowerCase),FI=nI([].unshift),BI="Invalid scheme",HI="Invalid host",jI="Invalid port",WI=/[a-z]/i,GI=/[\d+-.a-z]/i,JI=/\d/,KI=/^0x/i,zI=/^[0-7]+$/,qI=/^\d+$/,YI=/^[\da-f]+$/i,QI=/[\0\t\n\r #%/:<>?@[\\\]^|]/,XI=/[\0\t\n\r #/:<>?@[\\\]^|]/,$I=/^[\u0000-\u0020]+/,ZI=/(^|[^\u0000-\u0020])[\u0000-\u0020]+$/,eR=/[\t\n\r]/g,tR=function(e){var t,i,r,n;if("number"==typeof e){for(t=[],i=0;i<4;i++)FI(t,e%256),e=CI(e/256);return NI(t,".")}if("object"==typeof e){for(t="",r=function(e){for(var t=null,i=1,r=null,n=0,o=0;o<8;o++)0!==e[o]?(n>i&&(t=r,i=n),r=null,n=0):(null===r&&(r=o),++n);return n>i&&(t=r,i=n),t}(e),i=0;i<8;i++)n&&0===e[i]||(n&&(n=!1),r===i?(t+=i?":":"::",n=!0):(t+=wI(e[i],16),i<7&&(t+=":")));return "["+t+"]"}return e},iR={},rR=lI({},iR,{" ":1,'"':1,"<":1,">":1,"`":1}),nR=lI({},rR,{"#":1,"?":1,"{":1,"}":1}),oR=lI({},nR,{"/":1,":":1,";":1,"=":1,"@":1,"[":1,"\\":1,"]":1,"^":1,"|":1}),sR=function(e,t){var i=hI(e,0);return i>32&&i<127&&!cI(t,e)?e:encodeURIComponent(e)},aR={ftp:21,file:null,http:80,https:443,ws:80,wss:443},cR=function(e,t){var i;return 2==e.length&&DI(WI,kI(e,0))&&(":"==(i=kI(e,1))||!t&&"|"==i)},lR=function(e){var t;return e.length>1&&cR(VI(e,0,2))&&(2==e.length||"/"===(t=kI(e,2))||"\\"===t||"?"===t||"#"===t)},dR=function(e){return "."===e||"%2e"===UI(e)},uR={},hR={},pR={},mR={},_R={},fR={},gR={},TR={},ER={},vR={},yR={},SR={},IR={},RR={},AR={},CR={},bR={},kR={},DR={},NR={},wR={},OR=function(e,t,i){var r,n,o,s=mI(e);if(t){if(n=this.parse(s))throw RI(n);this.searchParams=null;}else {if(void 0!==i&&(r=new OR(i,!0)),n=this.parse(s,null,r))throw RI(n);(o=SI(new yI)).bindURL(this),this.searchParams=o;}};OR.prototype={type:"URL",parse:function(e,t,i){var r,n,o,s,a,c=this,l=t||uR,d=0,u="",h=!1,p=!1,m=!1;for(e=mI(e),t||(c.scheme="",c.username="",c.password="",c.host=null,c.port=null,c.path=[],c.query=null,c.fragment=null,c.cannotBeABaseURL=!1,e=MI(e,$I,""),e=MI(e,ZI,"$1")),e=MI(e,eR,""),r=dI(e);d<=r.length;){switch(n=r[d],l){case uR:if(!n||!DI(WI,n)){if(t)return BI;l=pR;continue}u+=UI(n),l=hR;break;case hR:if(n&&(DI(GI,n)||"+"==n||"-"==n||"."==n))u+=UI(n);else {if(":"!=n){if(t)return BI;u="",l=pR,d=0;continue}if(t&&(c.isSpecial()!=cI(aR,u)||"file"==u&&(c.includesCredentials()||null!==c.port)||"file"==c.scheme&&!c.host))return;if(c.scheme=u,t)return void(c.isSpecial()&&aR[c.scheme]==c.port&&(c.port=null));u="","file"==c.scheme?l=RR:c.isSpecial()&&i&&i.scheme==c.scheme?l=mR:c.isSpecial()?l=TR:"/"==r[d+1]?(l=_R,d++):(c.cannotBeABaseURL=!0,PI(c.path,""),l=DR);}break;case pR:if(!i||i.cannotBeABaseURL&&"#"!=n)return BI;if(i.cannotBeABaseURL&&"#"==n){c.scheme=i.scheme,c.path=uI(i.path),c.query=i.query,c.fragment="",c.cannotBeABaseURL=!0,l=wR;break}l="file"==i.scheme?RR:fR;continue;case mR:if("/"!=n||"/"!=r[d+1]){l=fR;continue}l=ER,d++;break;case _R:if("/"==n){l=vR;break}l=kR;continue;case fR:if(c.scheme=i.scheme,n==cS)c.username=i.username,c.password=i.password,c.host=i.host,c.port=i.port,c.path=uI(i.path),c.query=i.query;else if("/"==n||"\\"==n&&c.isSpecial())l=gR;else if("?"==n)c.username=i.username,c.password=i.password,c.host=i.host,c.port=i.port,c.path=uI(i.path),c.query="",l=NR;else {if("#"!=n){c.username=i.username,c.password=i.password,c.host=i.host,c.port=i.port,c.path=uI(i.path),c.path.length--,l=kR;continue}c.username=i.username,c.password=i.password,c.host=i.host,c.port=i.port,c.path=uI(i.path),c.query=i.query,c.fragment="",l=wR;}break;case gR:if(!c.isSpecial()||"/"!=n&&"\\"!=n){if("/"!=n){c.username=i.username,c.password=i.password,c.host=i.host,c.port=i.port,l=kR;continue}l=vR;}else l=ER;break;case TR:if(l=ER,"/"!=n||"/"!=kI(u,d+1))continue;d++;break;case ER:if("/"!=n&&"\\"!=n){l=vR;continue}break;case vR:if("@"==n){h&&(u="%40"+u),h=!0,o=dI(u);for(var _=0;_<o.length;_++){var f=o[_];if(":"!=f||m){var g=sR(f,oR);m?c.password+=g:c.username+=g;}else m=!0;}u="";}else if(n==cS||"/"==n||"?"==n||"#"==n||"\\"==n&&c.isSpecial()){if(h&&""==u)return "Invalid authority";d-=dI(u).length+1,u="",l=yR;}else u+=n;break;case yR:case SR:if(t&&"file"==c.scheme){l=CR;continue}if(":"!=n||p){if(n==cS||"/"==n||"?"==n||"#"==n||"\\"==n&&c.isSpecial()){if(c.isSpecial()&&""==u)return HI;if(t&&""==u&&(c.includesCredentials()||null!==c.port))return;if(s=c.parseHost(u))return s;if(u="",l=bR,t)return;continue}"["==n?p=!0:"]"==n&&(p=!1),u+=n;}else {if(""==u)return HI;if(s=c.parseHost(u))return s;if(u="",l=IR,t==SR)return}break;case IR:if(!DI(JI,n)){if(n==cS||"/"==n||"?"==n||"#"==n||"\\"==n&&c.isSpecial()||t){if(""!=u){var T=AI(u,10);if(T>65535)return jI;c.port=c.isSpecial()&&T===aR[c.scheme]?null:T,u="";}if(t)return;l=bR;continue}return jI}u+=n;break;case RR:if(c.scheme="file","/"==n||"\\"==n)l=AR;else {if(!i||"file"!=i.scheme){l=kR;continue}if(n==cS)c.host=i.host,c.path=uI(i.path),c.query=i.query;else if("?"==n)c.host=i.host,c.path=uI(i.path),c.query="",l=NR;else {if("#"!=n){lR(NI(uI(r,d),""))||(c.host=i.host,c.path=uI(i.path),c.shortenPath()),l=kR;continue}c.host=i.host,c.path=uI(i.path),c.query=i.query,c.fragment="",l=wR;}}break;case AR:if("/"==n||"\\"==n){l=CR;break}i&&"file"==i.scheme&&!lR(NI(uI(r,d),""))&&(cR(i.path[0],!0)?PI(c.path,i.path[0]):c.host=i.host),l=kR;continue;case CR:if(n==cS||"/"==n||"\\"==n||"?"==n||"#"==n){if(!t&&cR(u))l=kR;else if(""==u){if(c.host="",t)return;l=bR;}else {if(s=c.parseHost(u))return s;if("localhost"==c.host&&(c.host=""),t)return;u="",l=bR;}continue}u+=n;break;case bR:if(c.isSpecial()){if(l=kR,"/"!=n&&"\\"!=n)continue}else if(t||"?"!=n)if(t||"#"!=n){if(n!=cS&&(l=kR,"/"!=n))continue}else c.fragment="",l=wR;else c.query="",l=NR;break;case kR:if(n==cS||"/"==n||"\\"==n&&c.isSpecial()||!t&&("?"==n||"#"==n)){if(".."===(a=UI(a=u))||"%2e."===a||".%2e"===a||"%2e%2e"===a?(c.shortenPath(),"/"==n||"\\"==n&&c.isSpecial()||PI(c.path,"")):dR(u)?"/"==n||"\\"==n&&c.isSpecial()||PI(c.path,""):("file"==c.scheme&&!c.path.length&&cR(u)&&(c.host&&(c.host=""),u=kI(u,0)+":"),PI(c.path,u)),u="","file"==c.scheme&&(n==cS||"?"==n||"#"==n))for(;c.path.length>1&&""===c.path[0];)LI(c.path);"?"==n?(c.query="",l=NR):"#"==n&&(c.fragment="",l=wR);}else u+=sR(n,nR);break;case DR:"?"==n?(c.query="",l=NR):"#"==n?(c.fragment="",l=wR):n!=cS&&(c.path[0]+=sR(n,iR));break;case NR:t||"#"!=n?n!=cS&&("'"==n&&c.isSpecial()?c.query+="%27":c.query+="#"==n?"%23":sR(n,iR)):(c.fragment="",l=wR);break;case wR:n!=cS&&(c.fragment+=sR(n,rR));}d++;}},parseHost:function(e){var t,i,r;if("["==kI(e,0)){if("]"!=kI(e,e.length-1))return HI;if(t=function(e){var t,i,r,n,o,s,a,c=[0,0,0,0,0,0,0,0],l=0,d=null,u=0,h=function(){return kI(e,u)};if(":"==h()){if(":"!=kI(e,1))return;u+=2,d=++l;}for(;h();){if(8==l)return;if(":"!=h()){for(t=i=0;i<4&&DI(YI,h());)t=16*t+AI(h(),16),u++,i++;if("."==h()){if(0==i)return;if(u-=i,l>6)return;for(r=0;h();){if(n=null,r>0){if(!("."==h()&&r<4))return;u++;}if(!DI(JI,h()))return;for(;DI(JI,h());){if(o=AI(h(),10),null===n)n=o;else {if(0==n)return;n=10*n+o;}if(n>255)return;u++;}c[l]=256*c[l]+n,2!=++r&&4!=r||l++;}if(4!=r)return;break}if(":"==h()){if(u++,!h())return}else if(h())return;c[l++]=t;}else {if(null!==d)return;u++,d=++l;}}if(null!==d)for(s=l-d,l=7;0!=l&&s>0;)a=c[l],c[l--]=c[d+s-1],c[d+--s]=a;else if(8!=l)return;return c}(VI(e,1,-1)),!t)return HI;this.host=t;}else if(this.isSpecial()){if(e=pI(e),DI(QI,e))return HI;if(t=function(e){var t,i,r,n,o,s,a,c=xI(e,".");if(c.length&&""==c[c.length-1]&&c.length--,(t=c.length)>4)return e;for(i=[],r=0;r<t;r++){if(""==(n=c[r]))return e;if(o=10,n.length>1&&"0"==kI(n,0)&&(o=DI(KI,n)?16:8,n=VI(n,8==o?1:2)),""===n)s=0;else {if(!DI(10==o?qI:8==o?zI:YI,n))return e;s=AI(n,o);}PI(i,s);}for(r=0;r<t;r++)if(s=i[r],r==t-1){if(s>=bI(256,5-t))return null}else if(s>255)return null;for(a=OI(i),r=0;r<i.length;r++)a+=i[r]*bI(256,3-r);return a}(e),null===t)return HI;this.host=t;}else {if(DI(XI,e))return HI;for(t="",i=dI(e),r=0;r<i.length;r++)t+=sR(i[r],iR);this.host=t;}},cannotHaveUsernamePasswordPort:function(){return !this.host||this.cannotBeABaseURL||"file"==this.scheme},includesCredentials:function(){return ""!=this.username||""!=this.password},isSpecial:function(){return cI(aR,this.scheme)},shortenPath:function(){var e=this.path,t=e.length;!t||"file"==this.scheme&&1==t&&cR(e[0],!0)||e.length--;},serialize:function(){var e=this,t=e.scheme,i=e.username,r=e.password,n=e.host,o=e.port,s=e.path,a=e.query,c=e.fragment,l=t+":";return null!==n?(l+="//",e.includesCredentials()&&(l+=i+(r?":"+r:"")+"@"),l+=tR(n),null!==o&&(l+=":"+o)):"file"==t&&(l+="//"),l+=e.cannotBeABaseURL?s[0]:s.length?"/"+NI(s,"/"):"",null!==a&&(l+="?"+a),null!==c&&(l+="#"+c),l},setHref:function(e){var t=this.parse(e);if(t)throw RI(t);this.searchParams.update();},getOrigin:function(){var e=this.scheme,t=this.port;if("blob"==e)try{return new PR(e.path[0]).origin}catch(SB){return "null"}return "file"!=e&&this.isSpecial()?e+"://"+tR(this.host)+(null!==t?":"+t:""):"null"},getProtocol:function(){return this.scheme+":"},setProtocol:function(e){this.parse(mI(e)+":",uR);},getUsername:function(){return this.username},setUsername:function(e){var t=dI(mI(e));if(!this.cannotHaveUsernamePasswordPort()){this.username="";for(var i=0;i<t.length;i++)this.username+=sR(t[i],oR);}},getPassword:function(){return this.password},setPassword:function(e){var t=dI(mI(e));if(!this.cannotHaveUsernamePasswordPort()){this.password="";for(var i=0;i<t.length;i++)this.password+=sR(t[i],oR);}},getHost:function(){var e=this.host,t=this.port;return null===e?"":null===t?tR(e):tR(e)+":"+t},setHost:function(e){this.cannotBeABaseURL||this.parse(e,yR);},getHostname:function(){var e=this.host;return null===e?"":tR(e)},setHostname:function(e){this.cannotBeABaseURL||this.parse(e,SR);},getPort:function(){var e=this.port;return null===e?"":mI(e)},setPort:function(e){this.cannotHaveUsernamePasswordPort()||(""==(e=mI(e))?this.port=null:this.parse(e,IR));},getPathname:function(){var e=this.path;return this.cannotBeABaseURL?e[0]:e.length?"/"+NI(e,"/"):""},setPathname:function(e){this.cannotBeABaseURL||(this.path=[],this.parse(e,bR));},getSearch:function(){var e=this.query;return e?"?"+e:""},setSearch:function(e){""==(e=mI(e))?this.query=null:("?"==kI(e,0)&&(e=VI(e,1)),this.query="",this.parse(e,NR)),this.searchParams.update();},getSearchParams:function(){return this.searchParams.facade},getHash:function(){var e=this.fragment;return e?"#"+e:""},setHash:function(e){""!=(e=mI(e))?("#"==kI(e,0)&&(e=VI(e,1)),this.fragment="",this.parse(e,wR)):this.fragment=null;},update:function(){this.query=this.searchParams.serialize()||null;}};var PR=function(e){var t=aI(this,MR),i=fI(arguments.length,1)>1?arguments[1]:void 0,r=EI(t,new OR(e,!1,i));eI||(t.href=r.serialize(),t.origin=r.getOrigin(),t.protocol=r.getProtocol(),t.username=r.getUsername(),t.password=r.getPassword(),t.host=r.getHost(),t.hostname=r.getHostname(),t.port=r.getPort(),t.pathname=r.getPathname(),t.search=r.getSearch(),t.searchParams=r.getSearchParams(),t.hash=r.getHash());},MR=PR.prototype,LR=function(e,t){return {get:function(){return vI(this)[e]()},set:t&&function(e){return vI(this)[t](e)},configurable:!0,enumerable:!0}};if(eI&&(sI(MR,"href",LR("serialize","setHref")),sI(MR,"origin",LR("getOrigin")),sI(MR,"protocol",LR("getProtocol","setProtocol")),sI(MR,"username",LR("getUsername","setUsername")),sI(MR,"password",LR("getPassword","setPassword")),sI(MR,"host",LR("getHost","setHost")),sI(MR,"hostname",LR("getHostname","setHostname")),sI(MR,"port",LR("getPort","setPort")),sI(MR,"pathname",LR("getPathname","setPathname")),sI(MR,"search",LR("getSearch","setSearch")),sI(MR,"searchParams",LR("getSearchParams")),sI(MR,"hash",LR("getHash","setHash"))),oI(MR,"toJSON",(function(){return vI(this).serialize()}),{enumerable:!0}),oI(MR,"toString",(function(){return vI(this).serialize()}),{enumerable:!0}),II){var xR=II.createObjectURL,VR=II.revokeObjectURL;xR&&oI(PR,"createObjectURL",rI(xR,II)),VR&&oI(PR,"revokeObjectURL",rI(VR,II));}_I(PR,"URL"),ZS({global:!0,constructor:!0,forced:!tI,sham:!eI},{URL:PR}),OT("Float32",(function(e){return function(t,i,r){return e(this,t,i,r)}}));var UR=Cs,FR="ArrayBuffer",BR=_T[FR];Vn({global:!0,constructor:!0,forced:C[FR]!==BR},{ArrayBuffer:BR}),UR(FR);var HR=Vn,jR=jh,WR=c([].reverse),GR=[1,2];HR({target:"Array",proto:!0,forced:String(GR)===String(GR.reverse())},{reverse:function(){return jR(this)&&(this.length=this.length),WR(this)}});var JR=Qe,KR=TypeError,zR=Vn,qR=c,YR=et,QR=B,XR=Wt,$R=function(e,t){if(!delete e[t])throw KR("Cannot delete property "+JR(t)+" of "+JR(e))},ZR=_u,eA=i,tA=d_,iA=np,rA=gy,nA=Ty,oA=ie,sA=vy,aA=[],cA=qR(aA.sort),lA=qR(aA.push),dA=eA((function(){aA.sort(void 0);})),uA=eA((function(){aA.sort(null);})),hA=iA("sort"),pA=!eA((function(){if(oA)return oA<70;if(!(rA&&rA>3)){if(nA)return !0;if(sA)return sA<603;var e,t,i,r,n="";for(e=65;e<76;e++){switch(t=String.fromCharCode(e),e){case 66:case 69:case 70:case 72:i=3;break;case 68:case 71:i=4;break;default:i=2;}for(r=0;r<47;r++)aA.push({k:t+r,v:i});}for(aA.sort((function(e,t){return t.v-e.v})),r=0;r<aA.length;r++)t=aA[r].k.charAt(0),n.charAt(n.length-1)!==t&&(n+=t);return "DGBEFHACIJK"!==n}}));zR({target:"Array",proto:!0,forced:dA||!uA||!hA||!pA},{sort:function(e){void 0!==e&&YR(e);var t=QR(this);if(pA)return void 0===e?cA(t):cA(t,e);var i,r,n=[],o=XR(t);for(r=0;r<o;r++)r in t&&lA(n,t[r]);for(tA(n,function(e){return function(t,i){return void 0===i?-1:void 0===t?1:void 0!==e?+e(t,i)||0:ZR(t)>ZR(i)?1:-1}}(e)),i=XR(n),r=0;r<i;)t[r]=n[r++];for(;r<o;)$R(t,r++);return t}}),(0, _E.exportTypedArrayStaticMethod)("from",KE,SE);let mA=!0,_A=!0;function fA(e,t,i){const r=e.match(t);return r&&r.length>=i&&parseInt(r[i],10)}function gA(e,t,i){if(!e.RTCPeerConnection)return;const r=e.RTCPeerConnection.prototype,n=r.addEventListener;r.addEventListener=function(e,r){if(e!==t)return n.apply(this,arguments);const o=e=>{const t=i(e);t&&(r.handleEvent?r.handleEvent(t):r(t));};return this._eventMap=this._eventMap||{},this._eventMap[t]||(this._eventMap[t]=new Map),this._eventMap[t].set(r,o),n.apply(this,[e,o])};const o=r.removeEventListener;r.removeEventListener=function(e,i){if(e!==t||!this._eventMap||!this._eventMap[t])return o.apply(this,arguments);if(!this._eventMap[t].has(i))return o.apply(this,arguments);const r=this._eventMap[t].get(i);return this._eventMap[t].delete(i),0===this._eventMap[t].size&&delete this._eventMap[t],0===Object.keys(this._eventMap).length&&delete this._eventMap,o.apply(this,[e,r])},Object.defineProperty(r,"on"+t,{get(){return this["_on"+t]},set(e){this["_on"+t]&&(this.removeEventListener(t,this["_on"+t]),delete this["_on"+t]),e&&this.addEventListener(t,this["_on"+t]=e);},enumerable:!0,configurable:!0});}function TA(e){return "boolean"!=typeof e?new Error("Argument type: "+typeof e+". Please use a boolean."):(mA=e,e?"adapter.js logging disabled":"adapter.js logging enabled")}function EA(e){return "boolean"!=typeof e?new Error("Argument type: "+typeof e+". Please use a boolean."):(_A=!e,"adapter.js deprecation warnings "+(e?"disabled":"enabled"))}function vA(){if("object"==typeof window){if(mA)return;"undefined"!=typeof console&&"function"==typeof console.log&&console.log.apply(console,arguments);}}function yA(e,t){_A&&console.warn(e+" is deprecated, please use "+t+" instead.");}function SA(e){return "[object Object]"===Object.prototype.toString.call(e)}function IA(e){return SA(e)?Object.keys(e).reduce((function(t,i){const r=SA(e[i]),n=r?IA(e[i]):e[i],o=r&&!Object.keys(n).length;return void 0===n||o?t:Object.assign(t,{[i]:n})}),{}):e}function RA(e,t,i){t&&!i.has(t.id)&&(i.set(t.id,t),Object.keys(t).forEach((r=>{r.endsWith("Id")?RA(e,e.get(t[r]),i):r.endsWith("Ids")&&t[r].forEach((t=>{RA(e,e.get(t),i);}));})));}function AA(e,t,i){const r=i?"outbound-rtp":"inbound-rtp",n=new Map;if(null===t)return n;const o=[];return e.forEach((e=>{"track"===e.type&&e.trackIdentifier===t.id&&o.push(e);})),o.forEach((t=>{e.forEach((i=>{i.type===r&&i.trackId===t.id&&RA(e,i,n);}));})),n}const CA=vA;function bA(e,t){const i=e&&e.navigator;if(!i.mediaDevices)return;const r=function(e){if("object"!=typeof e||e.mandatory||e.optional)return e;const t={};return Object.keys(e).forEach((i=>{if("require"===i||"advanced"===i||"mediaSource"===i)return;const r="object"==typeof e[i]?e[i]:{ideal:e[i]};void 0!==r.exact&&"number"==typeof r.exact&&(r.min=r.max=r.exact);const n=function(e,t){return e?e+t.charAt(0).toUpperCase()+t.slice(1):"deviceId"===t?"sourceId":t};if(void 0!==r.ideal){t.optional=t.optional||[];let e={};"number"==typeof r.ideal?(e[n("min",i)]=r.ideal,t.optional.push(e),e={},e[n("max",i)]=r.ideal,t.optional.push(e)):(e[n("",i)]=r.ideal,t.optional.push(e));}void 0!==r.exact&&"number"!=typeof r.exact?(t.mandatory=t.mandatory||{},t.mandatory[n("",i)]=r.exact):["min","max"].forEach((e=>{void 0!==r[e]&&(t.mandatory=t.mandatory||{},t.mandatory[n(e,i)]=r[e]);}));})),e.advanced&&(t.optional=(t.optional||[]).concat(e.advanced)),t},n=function(e,n){if(t.version>=61)return n(e);if((e=JSON.parse(JSON.stringify(e)))&&"object"==typeof e.audio){const t=function(e,t,i){t in e&&!(i in e)&&(e[i]=e[t],delete e[t]);};t((e=JSON.parse(JSON.stringify(e))).audio,"autoGainControl","googAutoGainControl"),t(e.audio,"noiseSuppression","googNoiseSuppression"),e.audio=r(e.audio);}if(e&&"object"==typeof e.video){let o=e.video.facingMode;o=o&&("object"==typeof o?o:{ideal:o});const s=t.version<66;if(o&&("user"===o.exact||"environment"===o.exact||"user"===o.ideal||"environment"===o.ideal)&&(!i.mediaDevices.getSupportedConstraints||!i.mediaDevices.getSupportedConstraints().facingMode||s)){let t;if(delete e.video.facingMode,"environment"===o.exact||"environment"===o.ideal?t=["back","rear"]:"user"!==o.exact&&"user"!==o.ideal||(t=["front"]),t)return i.mediaDevices.enumerateDevices().then((i=>{let s=(i=i.filter((e=>"videoinput"===e.kind))).find((e=>t.some((t=>e.label.toLowerCase().includes(t)))));return !s&&i.length&&t.includes("back")&&(s=i[i.length-1]),s&&(e.video.deviceId=o.exact?{exact:s.deviceId}:{ideal:s.deviceId}),e.video=r(e.video),CA("chrome: "+JSON.stringify(e)),n(e)}))}e.video=r(e.video);}return CA("chrome: "+JSON.stringify(e)),n(e)},o=function(e){return t.version>=64?e:{name:{PermissionDeniedError:"NotAllowedError",PermissionDismissedError:"NotAllowedError",InvalidStateError:"NotAllowedError",DevicesNotFoundError:"NotFoundError",ConstraintNotSatisfiedError:"OverconstrainedError",TrackStartError:"NotReadableError",MediaDeviceFailedDueToShutdown:"NotAllowedError",MediaDeviceKillSwitchOn:"NotAllowedError",TabCaptureError:"AbortError",ScreenCaptureError:"AbortError",DeviceCaptureError:"AbortError"}[e.name]||e.name,message:e.message,constraint:e.constraint||e.constraintName,toString(){return this.name+(this.message&&": ")+this.message}}};if(i.getUserMedia=function(e,t,r){n(e,(e=>{i.webkitGetUserMedia(e,t,(e=>{r&&r(o(e));}));}));}.bind(i),i.mediaDevices.getUserMedia){const e=i.mediaDevices.getUserMedia.bind(i.mediaDevices);i.mediaDevices.getUserMedia=function(t){return n(t,(t=>e(t).then((e=>{if(t.audio&&!e.getAudioTracks().length||t.video&&!e.getVideoTracks().length)throw e.getTracks().forEach((e=>{e.stop();})),new DOMException("","NotFoundError");return e}),(e=>Promise.reject(o(e))))))};}}function kA(e){e.MediaStream=e.MediaStream||e.webkitMediaStream;}function DA(e){if("object"==typeof e&&e.RTCPeerConnection&&!("ontrack"in e.RTCPeerConnection.prototype)){Object.defineProperty(e.RTCPeerConnection.prototype,"ontrack",{get(){return this._ontrack},set(e){this._ontrack&&this.removeEventListener("track",this._ontrack),this.addEventListener("track",this._ontrack=e);},enumerable:!0,configurable:!0});const t=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(){return this._ontrackpoly||(this._ontrackpoly=t=>{t.stream.addEventListener("addtrack",(i=>{let r;r=e.RTCPeerConnection.prototype.getReceivers?this.getReceivers().find((e=>e.track&&e.track.id===i.track.id)):{track:i.track};const n=new Event("track");n.track=i.track,n.receiver=r,n.transceiver={receiver:r},n.streams=[t.stream],this.dispatchEvent(n);})),t.stream.getTracks().forEach((i=>{let r;r=e.RTCPeerConnection.prototype.getReceivers?this.getReceivers().find((e=>e.track&&e.track.id===i.id)):{track:i};const n=new Event("track");n.track=i,n.receiver=r,n.transceiver={receiver:r},n.streams=[t.stream],this.dispatchEvent(n);}));},this.addEventListener("addstream",this._ontrackpoly)),t.apply(this,arguments)};}else gA(e,"track",(e=>(e.transceiver||Object.defineProperty(e,"transceiver",{value:{receiver:e.receiver}}),e)));}function NA(e){if("object"==typeof e&&e.RTCPeerConnection&&!("getSenders"in e.RTCPeerConnection.prototype)&&"createDTMFSender"in e.RTCPeerConnection.prototype){const t=function(e,t){return {track:t,get dtmf(){return void 0===this._dtmf&&("audio"===t.kind?this._dtmf=e.createDTMFSender(t):this._dtmf=null),this._dtmf},_pc:e}};if(!e.RTCPeerConnection.prototype.getSenders){e.RTCPeerConnection.prototype.getSenders=function(){return this._senders=this._senders||[],this._senders.slice()};const i=e.RTCPeerConnection.prototype.addTrack;e.RTCPeerConnection.prototype.addTrack=function(e,r){let n=i.apply(this,arguments);return n||(n=t(this,e),this._senders.push(n)),n};const r=e.RTCPeerConnection.prototype.removeTrack;e.RTCPeerConnection.prototype.removeTrack=function(e){r.apply(this,arguments);const t=this._senders.indexOf(e);-1!==t&&this._senders.splice(t,1);};}const i=e.RTCPeerConnection.prototype.addStream;e.RTCPeerConnection.prototype.addStream=function(e){this._senders=this._senders||[],i.apply(this,[e]),e.getTracks().forEach((e=>{this._senders.push(t(this,e));}));};const r=e.RTCPeerConnection.prototype.removeStream;e.RTCPeerConnection.prototype.removeStream=function(e){this._senders=this._senders||[],r.apply(this,[e]),e.getTracks().forEach((e=>{const t=this._senders.find((t=>t.track===e));t&&this._senders.splice(this._senders.indexOf(t),1);}));};}else if("object"==typeof e&&e.RTCPeerConnection&&"getSenders"in e.RTCPeerConnection.prototype&&"createDTMFSender"in e.RTCPeerConnection.prototype&&e.RTCRtpSender&&!("dtmf"in e.RTCRtpSender.prototype)){const t=e.RTCPeerConnection.prototype.getSenders;e.RTCPeerConnection.prototype.getSenders=function(){const e=t.apply(this,[]);return e.forEach((e=>e._pc=this)),e},Object.defineProperty(e.RTCRtpSender.prototype,"dtmf",{get(){return void 0===this._dtmf&&("audio"===this.track.kind?this._dtmf=this._pc.createDTMFSender(this.track):this._dtmf=null),this._dtmf}});}}function wA(e){if(!e.RTCPeerConnection)return;const t=e.RTCPeerConnection.prototype.getStats;e.RTCPeerConnection.prototype.getStats=function(){const[e,i,r]=arguments;if(arguments.length>0&&"function"==typeof e)return t.apply(this,arguments);if(0===t.length&&(0===arguments.length||"function"!=typeof e))return t.apply(this,[]);const n=function(e){const t={};return e.result().forEach((e=>{const i={id:e.id,timestamp:e.timestamp,type:{localcandidate:"local-candidate",remotecandidate:"remote-candidate"}[e.type]||e.type};e.names().forEach((t=>{i[t]=e.stat(t);})),t[i.id]=i;})),t},o=function(e){return new Map(Object.keys(e).map((t=>[t,e[t]])))};if(arguments.length>=2){const r=function(e){i(o(n(e)));};return t.apply(this,[r,e])}return new Promise(((e,i)=>{t.apply(this,[function(t){e(o(n(t)));},i]);})).then(i,r)};}function OA(e){if(!("object"==typeof e&&e.RTCPeerConnection&&e.RTCRtpSender&&e.RTCRtpReceiver))return;if(!("getStats"in e.RTCRtpSender.prototype)){const t=e.RTCPeerConnection.prototype.getSenders;t&&(e.RTCPeerConnection.prototype.getSenders=function(){const e=t.apply(this,[]);return e.forEach((e=>e._pc=this)),e});const i=e.RTCPeerConnection.prototype.addTrack;i&&(e.RTCPeerConnection.prototype.addTrack=function(){const e=i.apply(this,arguments);return e._pc=this,e}),e.RTCRtpSender.prototype.getStats=function(){const e=this;return this._pc.getStats().then((t=>AA(t,e.track,!0)))};}if(!("getStats"in e.RTCRtpReceiver.prototype)){const t=e.RTCPeerConnection.prototype.getReceivers;t&&(e.RTCPeerConnection.prototype.getReceivers=function(){const e=t.apply(this,[]);return e.forEach((e=>e._pc=this)),e}),gA(e,"track",(e=>(e.receiver._pc=e.srcElement,e))),e.RTCRtpReceiver.prototype.getStats=function(){const e=this;return this._pc.getStats().then((t=>AA(t,e.track,!1)))};}if(!("getStats"in e.RTCRtpSender.prototype)||!("getStats"in e.RTCRtpReceiver.prototype))return;const t=e.RTCPeerConnection.prototype.getStats;e.RTCPeerConnection.prototype.getStats=function(){if(arguments.length>0&&arguments[0]instanceof e.MediaStreamTrack){const e=arguments[0];let t,i,r;return this.getSenders().forEach((i=>{i.track===e&&(t?r=!0:t=i);})),this.getReceivers().forEach((t=>(t.track===e&&(i?r=!0:i=t),t.track===e))),r||t&&i?Promise.reject(new DOMException("There are more than one sender or receiver for the track.","InvalidAccessError")):t?t.getStats():i?i.getStats():Promise.reject(new DOMException("There is no sender or receiver for the track.","InvalidAccessError"))}return t.apply(this,arguments)};}function PA(e){e.RTCPeerConnection.prototype.getLocalStreams=function(){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},Object.keys(this._shimmedLocalStreams).map((e=>this._shimmedLocalStreams[e][0]))};const t=e.RTCPeerConnection.prototype.addTrack;e.RTCPeerConnection.prototype.addTrack=function(e,i){if(!i)return t.apply(this,arguments);this._shimmedLocalStreams=this._shimmedLocalStreams||{};const r=t.apply(this,arguments);return this._shimmedLocalStreams[i.id]?-1===this._shimmedLocalStreams[i.id].indexOf(r)&&this._shimmedLocalStreams[i.id].push(r):this._shimmedLocalStreams[i.id]=[i,r],r};const i=e.RTCPeerConnection.prototype.addStream;e.RTCPeerConnection.prototype.addStream=function(e){this._shimmedLocalStreams=this._shimmedLocalStreams||{},e.getTracks().forEach((e=>{if(this.getSenders().find((t=>t.track===e)))throw new DOMException("Track already exists.","InvalidAccessError")}));const t=this.getSenders();i.apply(this,arguments);const r=this.getSenders().filter((e=>-1===t.indexOf(e)));this._shimmedLocalStreams[e.id]=[e].concat(r);};const r=e.RTCPeerConnection.prototype.removeStream;e.RTCPeerConnection.prototype.removeStream=function(e){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},delete this._shimmedLocalStreams[e.id],r.apply(this,arguments)};const n=e.RTCPeerConnection.prototype.removeTrack;e.RTCPeerConnection.prototype.removeTrack=function(e){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},e&&Object.keys(this._shimmedLocalStreams).forEach((t=>{const i=this._shimmedLocalStreams[t].indexOf(e);-1!==i&&this._shimmedLocalStreams[t].splice(i,1),1===this._shimmedLocalStreams[t].length&&delete this._shimmedLocalStreams[t];})),n.apply(this,arguments)};}function MA(e,t){if(!e.RTCPeerConnection)return;if(e.RTCPeerConnection.prototype.addTrack&&t.version>=65)return PA(e);const i=e.RTCPeerConnection.prototype.getLocalStreams;e.RTCPeerConnection.prototype.getLocalStreams=function(){const e=i.apply(this);return this._reverseStreams=this._reverseStreams||{},e.map((e=>this._reverseStreams[e.id]))};const r=e.RTCPeerConnection.prototype.addStream;e.RTCPeerConnection.prototype.addStream=function(t){if(this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},t.getTracks().forEach((e=>{if(this.getSenders().find((t=>t.track===e)))throw new DOMException("Track already exists.","InvalidAccessError")})),!this._reverseStreams[t.id]){const i=new e.MediaStream(t.getTracks());this._streams[t.id]=i,this._reverseStreams[i.id]=t,t=i;}r.apply(this,[t]);};const n=e.RTCPeerConnection.prototype.removeStream;function o(e,t){let i=t.sdp;return Object.keys(e._reverseStreams||[]).forEach((t=>{const r=e._reverseStreams[t],n=e._streams[r.id];i=i.replace(new RegExp(n.id,"g"),r.id);})),new RTCSessionDescription({type:t.type,sdp:i})}e.RTCPeerConnection.prototype.removeStream=function(e){this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},n.apply(this,[this._streams[e.id]||e]),delete this._reverseStreams[this._streams[e.id]?this._streams[e.id].id:e.id],delete this._streams[e.id];},e.RTCPeerConnection.prototype.addTrack=function(t,i){if("closed"===this.signalingState)throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");const r=[].slice.call(arguments,1);if(1!==r.length||!r[0].getTracks().find((e=>e===t)))throw new DOMException("The adapter.js addTrack polyfill only supports a single  stream which is associated with the specified track.","NotSupportedError");if(this.getSenders().find((e=>e.track===t)))throw new DOMException("Track already exists.","InvalidAccessError");this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{};const n=this._streams[i.id];if(n)n.addTrack(t),Promise.resolve().then((()=>{this.dispatchEvent(new Event("negotiationneeded"));}));else {const r=new e.MediaStream([t]);this._streams[i.id]=r,this._reverseStreams[r.id]=i,this.addStream(r);}return this.getSenders().find((e=>e.track===t))},["createOffer","createAnswer"].forEach((function(t){const i=e.RTCPeerConnection.prototype[t],r={[t](){const e=arguments;return arguments.length&&"function"==typeof arguments[0]?i.apply(this,[t=>{const i=o(this,t);e[0].apply(null,[i]);},t=>{e[1]&&e[1].apply(null,t);},arguments[2]]):i.apply(this,arguments).then((e=>o(this,e)))}};e.RTCPeerConnection.prototype[t]=r[t];}));const s=e.RTCPeerConnection.prototype.setLocalDescription;e.RTCPeerConnection.prototype.setLocalDescription=function(){return arguments.length&&arguments[0].type?(arguments[0]=function(e,t){let i=t.sdp;return Object.keys(e._reverseStreams||[]).forEach((t=>{const r=e._reverseStreams[t],n=e._streams[r.id];i=i.replace(new RegExp(r.id,"g"),n.id);})),new RTCSessionDescription({type:t.type,sdp:i})}(this,arguments[0]),s.apply(this,arguments)):s.apply(this,arguments)};const a=Object.getOwnPropertyDescriptor(e.RTCPeerConnection.prototype,"localDescription");Object.defineProperty(e.RTCPeerConnection.prototype,"localDescription",{get(){const e=a.get.apply(this);return ""===e.type?e:o(this,e)}}),e.RTCPeerConnection.prototype.removeTrack=function(e){if("closed"===this.signalingState)throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");if(!e._pc)throw new DOMException("Argument 1 of RTCPeerConnection.removeTrack does not implement interface RTCRtpSender.","TypeError");if(!(e._pc===this))throw new DOMException("Sender was not created by this connection.","InvalidAccessError");let t;this._streams=this._streams||{},Object.keys(this._streams).forEach((i=>{this._streams[i].getTracks().find((t=>e.track===t))&&(t=this._streams[i]);})),t&&(1===t.getTracks().length?this.removeStream(this._reverseStreams[t.id]):t.removeTrack(e.track),this.dispatchEvent(new Event("negotiationneeded")));};}function LA(e,t){!e.RTCPeerConnection&&e.webkitRTCPeerConnection&&(e.RTCPeerConnection=e.webkitRTCPeerConnection),e.RTCPeerConnection&&t.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach((function(t){const i=e.RTCPeerConnection.prototype[t],r={[t](){return arguments[0]=new("addIceCandidate"===t?e.RTCIceCandidate:e.RTCSessionDescription)(arguments[0]),i.apply(this,arguments)}};e.RTCPeerConnection.prototype[t]=r[t];}));}function xA(e,t){gA(e,"negotiationneeded",(e=>{const i=e.target;if(!(t.version<72||i.getConfiguration&&"plan-b"===i.getConfiguration().sdpSemantics)||"stable"===i.signalingState)return e}));}var VA=Object.freeze({__proto__:null,shimMediaStream:kA,shimOnTrack:DA,shimGetSendersWithDtmf:NA,shimGetStats:wA,shimSenderReceiverGetStats:OA,shimAddTrackRemoveTrackWithNative:PA,shimAddTrackRemoveTrack:MA,shimPeerConnection:LA,fixNegotiationNeeded:xA,shimGetUserMedia:bA,shimGetDisplayMedia:function(e,t){e.navigator.mediaDevices&&"getDisplayMedia"in e.navigator.mediaDevices||e.navigator.mediaDevices&&("function"==typeof t?e.navigator.mediaDevices.getDisplayMedia=function(i){return t(i).then((t=>{const r=i.video&&i.video.width,n=i.video&&i.video.height,o=i.video&&i.video.frameRate;return i.video={mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:t,maxFrameRate:o||3}},r&&(i.video.mandatory.maxWidth=r),n&&(i.video.mandatory.maxHeight=n),e.navigator.mediaDevices.getUserMedia(i)}))}:console.error("shimGetDisplayMedia: getSourceId argument is not a function"));}});function UA(e,t){const i=e&&e.navigator,r=e&&e.MediaStreamTrack;if(i.getUserMedia=function(e,t,r){yA("navigator.getUserMedia","navigator.mediaDevices.getUserMedia"),i.mediaDevices.getUserMedia(e).then(t,r);},!(t.version>55&&"autoGainControl"in i.mediaDevices.getSupportedConstraints())){const e=function(e,t,i){t in e&&!(i in e)&&(e[i]=e[t],delete e[t]);},t=i.mediaDevices.getUserMedia.bind(i.mediaDevices);if(i.mediaDevices.getUserMedia=function(i){return "object"==typeof i&&"object"==typeof i.audio&&(i=JSON.parse(JSON.stringify(i)),e(i.audio,"autoGainControl","mozAutoGainControl"),e(i.audio,"noiseSuppression","mozNoiseSuppression")),t(i)},r&&r.prototype.getSettings){const t=r.prototype.getSettings;r.prototype.getSettings=function(){const i=t.apply(this,arguments);return e(i,"mozAutoGainControl","autoGainControl"),e(i,"mozNoiseSuppression","noiseSuppression"),i};}if(r&&r.prototype.applyConstraints){const t=r.prototype.applyConstraints;r.prototype.applyConstraints=function(i){return "audio"===this.kind&&"object"==typeof i&&(i=JSON.parse(JSON.stringify(i)),e(i,"autoGainControl","mozAutoGainControl"),e(i,"noiseSuppression","mozNoiseSuppression")),t.apply(this,[i])};}}}function FA(e){"object"==typeof e&&e.RTCTrackEvent&&"receiver"in e.RTCTrackEvent.prototype&&!("transceiver"in e.RTCTrackEvent.prototype)&&Object.defineProperty(e.RTCTrackEvent.prototype,"transceiver",{get(){return {receiver:this.receiver}}});}function BA(e,t){if("object"!=typeof e||!e.RTCPeerConnection&&!e.mozRTCPeerConnection)return;!e.RTCPeerConnection&&e.mozRTCPeerConnection&&(e.RTCPeerConnection=e.mozRTCPeerConnection),t.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach((function(t){const i=e.RTCPeerConnection.prototype[t],r={[t](){return arguments[0]=new("addIceCandidate"===t?e.RTCIceCandidate:e.RTCSessionDescription)(arguments[0]),i.apply(this,arguments)}};e.RTCPeerConnection.prototype[t]=r[t];}));const i={inboundrtp:"inbound-rtp",outboundrtp:"outbound-rtp",candidatepair:"candidate-pair",localcandidate:"local-candidate",remotecandidate:"remote-candidate"},r=e.RTCPeerConnection.prototype.getStats;e.RTCPeerConnection.prototype.getStats=function(){const[e,n,o]=arguments;return r.apply(this,[e||null]).then((e=>{if(t.version<53&&!n)try{e.forEach((e=>{e.type=i[e.type]||e.type;}));}catch(db){if("TypeError"!==db.name)throw db;e.forEach(((t,r)=>{e.set(r,Object.assign({},t,{type:i[t.type]||t.type}));}));}return e})).then(n,o)};}function HA(e){if("object"!=typeof e||!e.RTCPeerConnection||!e.RTCRtpSender)return;if(e.RTCRtpSender&&"getStats"in e.RTCRtpSender.prototype)return;const t=e.RTCPeerConnection.prototype.getSenders;t&&(e.RTCPeerConnection.prototype.getSenders=function(){const e=t.apply(this,[]);return e.forEach((e=>e._pc=this)),e});const i=e.RTCPeerConnection.prototype.addTrack;i&&(e.RTCPeerConnection.prototype.addTrack=function(){const e=i.apply(this,arguments);return e._pc=this,e}),e.RTCRtpSender.prototype.getStats=function(){return this.track?this._pc.getStats(this.track):Promise.resolve(new Map)};}function jA(e){if("object"!=typeof e||!e.RTCPeerConnection||!e.RTCRtpSender)return;if(e.RTCRtpSender&&"getStats"in e.RTCRtpReceiver.prototype)return;const t=e.RTCPeerConnection.prototype.getReceivers;t&&(e.RTCPeerConnection.prototype.getReceivers=function(){const e=t.apply(this,[]);return e.forEach((e=>e._pc=this)),e}),gA(e,"track",(e=>(e.receiver._pc=e.srcElement,e))),e.RTCRtpReceiver.prototype.getStats=function(){return this._pc.getStats(this.track)};}function WA(e){e.RTCPeerConnection&&!("removeStream"in e.RTCPeerConnection.prototype)&&(e.RTCPeerConnection.prototype.removeStream=function(e){yA("removeStream","removeTrack"),this.getSenders().forEach((t=>{t.track&&e.getTracks().includes(t.track)&&this.removeTrack(t);}));});}function GA(e){e.DataChannel&&!e.RTCDataChannel&&(e.RTCDataChannel=e.DataChannel);}function JA(e){if("object"!=typeof e||!e.RTCPeerConnection)return;const t=e.RTCPeerConnection.prototype.addTransceiver;t&&(e.RTCPeerConnection.prototype.addTransceiver=function(){this.setParametersPromises=[];let e=arguments[1]&&arguments[1].sendEncodings;void 0===e&&(e=[]),e=[...e];const i=e.length>0;i&&e.forEach((e=>{if("rid"in e){if(!/^[a-z0-9]{0,16}$/i.test(e.rid))throw new TypeError("Invalid RID value provided.")}if("scaleResolutionDownBy"in e&&!(parseFloat(e.scaleResolutionDownBy)>=1))throw new RangeError("scale_resolution_down_by must be >= 1.0");if("maxFramerate"in e&&!(parseFloat(e.maxFramerate)>=0))throw new RangeError("max_framerate must be >= 0.0")}));const r=t.apply(this,arguments);if(i){const{sender:t}=r,i=t.getParameters();(!("encodings"in i)||1===i.encodings.length&&0===Object.keys(i.encodings[0]).length)&&(i.encodings=e,t.sendEncodings=e,this.setParametersPromises.push(t.setParameters(i).then((()=>{delete t.sendEncodings;})).catch((()=>{delete t.sendEncodings;}))));}return r});}function KA(e){if("object"!=typeof e||!e.RTCRtpSender)return;const t=e.RTCRtpSender.prototype.getParameters;t&&(e.RTCRtpSender.prototype.getParameters=function(){const e=t.apply(this,arguments);return "encodings"in e||(e.encodings=[].concat(this.sendEncodings||[{}])),e});}function zA(e){if("object"!=typeof e||!e.RTCPeerConnection)return;const t=e.RTCPeerConnection.prototype.createOffer;e.RTCPeerConnection.prototype.createOffer=function(){return this.setParametersPromises&&this.setParametersPromises.length?Promise.all(this.setParametersPromises).then((()=>t.apply(this,arguments))).finally((()=>{this.setParametersPromises=[];})):t.apply(this,arguments)};}function qA(e){if("object"!=typeof e||!e.RTCPeerConnection)return;const t=e.RTCPeerConnection.prototype.createAnswer;e.RTCPeerConnection.prototype.createAnswer=function(){return this.setParametersPromises&&this.setParametersPromises.length?Promise.all(this.setParametersPromises).then((()=>t.apply(this,arguments))).finally((()=>{this.setParametersPromises=[];})):t.apply(this,arguments)};}var YA=Object.freeze({__proto__:null,shimOnTrack:FA,shimPeerConnection:BA,shimSenderGetStats:HA,shimReceiverGetStats:jA,shimRemoveStream:WA,shimRTCDataChannel:GA,shimAddTransceiver:JA,shimGetParameters:KA,shimCreateOffer:zA,shimCreateAnswer:qA,shimGetUserMedia:UA,shimGetDisplayMedia:function(e,t){e.navigator.mediaDevices&&"getDisplayMedia"in e.navigator.mediaDevices||e.navigator.mediaDevices&&(e.navigator.mediaDevices.getDisplayMedia=function(i){if(!i||!i.video){const e=new DOMException("getDisplayMedia without video constraints is undefined");return e.name="NotFoundError",e.code=8,Promise.reject(e)}return !0===i.video?i.video={mediaSource:t}:i.video.mediaSource=t,e.navigator.mediaDevices.getUserMedia(i)});}});function QA(e){if("object"==typeof e&&e.RTCPeerConnection){if("getLocalStreams"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.getLocalStreams=function(){return this._localStreams||(this._localStreams=[]),this._localStreams}),!("addStream"in e.RTCPeerConnection.prototype)){const t=e.RTCPeerConnection.prototype.addTrack;e.RTCPeerConnection.prototype.addStream=function(e){this._localStreams||(this._localStreams=[]),this._localStreams.includes(e)||this._localStreams.push(e),e.getAudioTracks().forEach((i=>t.call(this,i,e))),e.getVideoTracks().forEach((i=>t.call(this,i,e)));},e.RTCPeerConnection.prototype.addTrack=function(e,...i){return i&&i.forEach((e=>{this._localStreams?this._localStreams.includes(e)||this._localStreams.push(e):this._localStreams=[e];})),t.apply(this,arguments)};}"removeStream"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.removeStream=function(e){this._localStreams||(this._localStreams=[]);const t=this._localStreams.indexOf(e);if(-1===t)return;this._localStreams.splice(t,1);const i=e.getTracks();this.getSenders().forEach((e=>{i.includes(e.track)&&this.removeTrack(e);}));});}}function XA(e){if("object"==typeof e&&e.RTCPeerConnection&&("getRemoteStreams"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.getRemoteStreams=function(){return this._remoteStreams?this._remoteStreams:[]}),!("onaddstream"in e.RTCPeerConnection.prototype))){Object.defineProperty(e.RTCPeerConnection.prototype,"onaddstream",{get(){return this._onaddstream},set(e){this._onaddstream&&(this.removeEventListener("addstream",this._onaddstream),this.removeEventListener("track",this._onaddstreampoly)),this.addEventListener("addstream",this._onaddstream=e),this.addEventListener("track",this._onaddstreampoly=e=>{e.streams.forEach((e=>{if(this._remoteStreams||(this._remoteStreams=[]),this._remoteStreams.includes(e))return;this._remoteStreams.push(e);const t=new Event("addstream");t.stream=e,this.dispatchEvent(t);}));});}});const t=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(){const e=this;return this._onaddstreampoly||this.addEventListener("track",this._onaddstreampoly=function(t){t.streams.forEach((t=>{if(e._remoteStreams||(e._remoteStreams=[]),e._remoteStreams.indexOf(t)>=0)return;e._remoteStreams.push(t);const i=new Event("addstream");i.stream=t,e.dispatchEvent(i);}));}),t.apply(e,arguments)};}}function $A(e){if("object"!=typeof e||!e.RTCPeerConnection)return;const t=e.RTCPeerConnection.prototype,i=t.createOffer,r=t.createAnswer,n=t.setLocalDescription,o=t.setRemoteDescription,s=t.addIceCandidate;t.createOffer=function(e,t){const r=arguments.length>=2?arguments[2]:arguments[0],n=i.apply(this,[r]);return t?(n.then(e,t),Promise.resolve()):n},t.createAnswer=function(e,t){const i=arguments.length>=2?arguments[2]:arguments[0],n=r.apply(this,[i]);return t?(n.then(e,t),Promise.resolve()):n};let a=function(e,t,i){const r=n.apply(this,[e]);return i?(r.then(t,i),Promise.resolve()):r};t.setLocalDescription=a,a=function(e,t,i){const r=o.apply(this,[e]);return i?(r.then(t,i),Promise.resolve()):r},t.setRemoteDescription=a,a=function(e,t,i){const r=s.apply(this,[e]);return i?(r.then(t,i),Promise.resolve()):r},t.addIceCandidate=a;}function ZA(e){const t=e&&e.navigator;if(t.mediaDevices&&t.mediaDevices.getUserMedia){const e=t.mediaDevices,i=e.getUserMedia.bind(e);t.mediaDevices.getUserMedia=e=>i(eC(e));}!t.getUserMedia&&t.mediaDevices&&t.mediaDevices.getUserMedia&&(t.getUserMedia=function(e,i,r){t.mediaDevices.getUserMedia(e).then(i,r);}.bind(t));}function eC(e){return e&&void 0!==e.video?Object.assign({},e,{video:IA(e.video)}):e}function tC(e){if(!e.RTCPeerConnection)return;const t=e.RTCPeerConnection;e.RTCPeerConnection=function(e,i){if(e&&e.iceServers){const t=[];for(let i=0;i<e.iceServers.length;i++){let r=e.iceServers[i];void 0===r.urls&&r.url?(yA("RTCIceServer.url","RTCIceServer.urls"),r=JSON.parse(JSON.stringify(r)),r.urls=r.url,delete r.url,t.push(r)):t.push(e.iceServers[i]);}e.iceServers=t;}return new t(e,i)},e.RTCPeerConnection.prototype=t.prototype,"generateCertificate"in t&&Object.defineProperty(e.RTCPeerConnection,"generateCertificate",{get:()=>t.generateCertificate});}function iC(e){"object"==typeof e&&e.RTCTrackEvent&&"receiver"in e.RTCTrackEvent.prototype&&!("transceiver"in e.RTCTrackEvent.prototype)&&Object.defineProperty(e.RTCTrackEvent.prototype,"transceiver",{get(){return {receiver:this.receiver}}});}function rC(e){const t=e.RTCPeerConnection.prototype.createOffer;e.RTCPeerConnection.prototype.createOffer=function(e){if(e){void 0!==e.offerToReceiveAudio&&(e.offerToReceiveAudio=!!e.offerToReceiveAudio);const t=this.getTransceivers().find((e=>"audio"===e.receiver.track.kind));!1===e.offerToReceiveAudio&&t?"sendrecv"===t.direction?t.setDirection?t.setDirection("sendonly"):t.direction="sendonly":"recvonly"===t.direction&&(t.setDirection?t.setDirection("inactive"):t.direction="inactive"):!0!==e.offerToReceiveAudio||t||this.addTransceiver("audio",{direction:"recvonly"}),void 0!==e.offerToReceiveVideo&&(e.offerToReceiveVideo=!!e.offerToReceiveVideo);const i=this.getTransceivers().find((e=>"video"===e.receiver.track.kind));!1===e.offerToReceiveVideo&&i?"sendrecv"===i.direction?i.setDirection?i.setDirection("sendonly"):i.direction="sendonly":"recvonly"===i.direction&&(i.setDirection?i.setDirection("inactive"):i.direction="inactive"):!0!==e.offerToReceiveVideo||i||this.addTransceiver("video",{direction:"recvonly"});}return t.apply(this,arguments)};}function nC(e){"object"!=typeof e||e.AudioContext||(e.AudioContext=e.webkitAudioContext);}var oC=Object.freeze({__proto__:null,shimLocalStreamsAPI:QA,shimRemoteStreamsAPI:XA,shimCallbacksAPI:$A,shimGetUserMedia:ZA,shimConstraints:eC,shimRTCIceServerUrls:tC,shimTrackEventTransceiver:iC,shimCreateOfferLegacy:rC,shimAudioContext:nC}),sC={},aC={get exports(){return sC},set exports(e){sC=e;}};!function(e){const t={generateIdentifier:function(){return Math.random().toString(36).substring(2,12)}};t.localCName=t.generateIdentifier(),t.splitLines=function(e){return e.trim().split("\n").map((e=>e.trim()))},t.splitSections=function(e){return e.split("\nm=").map(((e,t)=>(t>0?"m="+e:e).trim()+"\r\n"))},t.getDescription=function(e){const i=t.splitSections(e);return i&&i[0]},t.getMediaSections=function(e){const i=t.splitSections(e);return i.shift(),i},t.matchPrefix=function(e,i){return t.splitLines(e).filter((e=>0===e.indexOf(i)))},t.parseCandidate=function(e){let t;t=0===e.indexOf("a=candidate:")?e.substring(12).split(" "):e.substring(10).split(" ");const i={foundation:t[0],component:{1:"rtp",2:"rtcp"}[t[1]]||t[1],protocol:t[2].toLowerCase(),priority:parseInt(t[3],10),ip:t[4],address:t[4],port:parseInt(t[5],10),type:t[7]};for(let r=8;r<t.length;r+=2)switch(t[r]){case"raddr":i.relatedAddress=t[r+1];break;case"rport":i.relatedPort=parseInt(t[r+1],10);break;case"tcptype":i.tcpType=t[r+1];break;case"ufrag":i.ufrag=t[r+1],i.usernameFragment=t[r+1];break;default:void 0===i[t[r]]&&(i[t[r]]=t[r+1]);}return i},t.writeCandidate=function(e){const t=[];t.push(e.foundation);const i=e.component;"rtp"===i?t.push(1):"rtcp"===i?t.push(2):t.push(i),t.push(e.protocol.toUpperCase()),t.push(e.priority),t.push(e.address||e.ip),t.push(e.port);const r=e.type;return t.push("typ"),t.push(r),"host"!==r&&e.relatedAddress&&e.relatedPort&&(t.push("raddr"),t.push(e.relatedAddress),t.push("rport"),t.push(e.relatedPort)),e.tcpType&&"tcp"===e.protocol.toLowerCase()&&(t.push("tcptype"),t.push(e.tcpType)),(e.usernameFragment||e.ufrag)&&(t.push("ufrag"),t.push(e.usernameFragment||e.ufrag)),"candidate:"+t.join(" ")},t.parseIceOptions=function(e){return e.substring(14).split(" ")},t.parseRtpMap=function(e){let t=e.substring(9).split(" ");const i={payloadType:parseInt(t.shift(),10)};return t=t[0].split("/"),i.name=t[0],i.clockRate=parseInt(t[1],10),i.channels=3===t.length?parseInt(t[2],10):1,i.numChannels=i.channels,i},t.writeRtpMap=function(e){let t=e.payloadType;void 0!==e.preferredPayloadType&&(t=e.preferredPayloadType);const i=e.channels||e.numChannels||1;return "a=rtpmap:"+t+" "+e.name+"/"+e.clockRate+(1!==i?"/"+i:"")+"\r\n"},t.parseExtmap=function(e){const t=e.substring(9).split(" ");return {id:parseInt(t[0],10),direction:t[0].indexOf("/")>0?t[0].split("/")[1]:"sendrecv",uri:t[1],attributes:t.slice(2).join(" ")}},t.writeExtmap=function(e){return "a=extmap:"+(e.id||e.preferredId)+(e.direction&&"sendrecv"!==e.direction?"/"+e.direction:"")+" "+e.uri+(e.attributes?" "+e.attributes:"")+"\r\n"},t.parseFmtp=function(e){const t={};let i;const r=e.substring(e.indexOf(" ")+1).split(";");for(let n=0;n<r.length;n++)i=r[n].trim().split("="),t[i[0].trim()]=i[1];return t},t.writeFmtp=function(e){let t="",i=e.payloadType;if(void 0!==e.preferredPayloadType&&(i=e.preferredPayloadType),e.parameters&&Object.keys(e.parameters).length){const r=[];Object.keys(e.parameters).forEach((t=>{void 0!==e.parameters[t]?r.push(t+"="+e.parameters[t]):r.push(t);})),t+="a=fmtp:"+i+" "+r.join(";")+"\r\n";}return t},t.parseRtcpFb=function(e){const t=e.substring(e.indexOf(" ")+1).split(" ");return {type:t.shift(),parameter:t.join(" ")}},t.writeRtcpFb=function(e){let t="",i=e.payloadType;return void 0!==e.preferredPayloadType&&(i=e.preferredPayloadType),e.rtcpFeedback&&e.rtcpFeedback.length&&e.rtcpFeedback.forEach((e=>{t+="a=rtcp-fb:"+i+" "+e.type+(e.parameter&&e.parameter.length?" "+e.parameter:"")+"\r\n";})),t},t.parseSsrcMedia=function(e){const t=e.indexOf(" "),i={ssrc:parseInt(e.substring(7,t),10)},r=e.indexOf(":",t);return r>-1?(i.attribute=e.substring(t+1,r),i.value=e.substring(r+1)):i.attribute=e.substring(t+1),i},t.parseSsrcGroup=function(e){const t=e.substring(13).split(" ");return {semantics:t.shift(),ssrcs:t.map((e=>parseInt(e,10)))}},t.getMid=function(e){const i=t.matchPrefix(e,"a=mid:")[0];if(i)return i.substring(6)},t.parseFingerprint=function(e){const t=e.substring(14).split(" ");return {algorithm:t[0].toLowerCase(),value:t[1].toUpperCase()}},t.getDtlsParameters=function(e,i){return {role:"auto",fingerprints:t.matchPrefix(e+i,"a=fingerprint:").map(t.parseFingerprint)}},t.writeDtlsParameters=function(e,t){let i="a=setup:"+t+"\r\n";return e.fingerprints.forEach((e=>{i+="a=fingerprint:"+e.algorithm+" "+e.value+"\r\n";})),i},t.parseCryptoLine=function(e){const t=e.substring(9).split(" ");return {tag:parseInt(t[0],10),cryptoSuite:t[1],keyParams:t[2],sessionParams:t.slice(3)}},t.writeCryptoLine=function(e){return "a=crypto:"+e.tag+" "+e.cryptoSuite+" "+("object"==typeof e.keyParams?t.writeCryptoKeyParams(e.keyParams):e.keyParams)+(e.sessionParams?" "+e.sessionParams.join(" "):"")+"\r\n"},t.parseCryptoKeyParams=function(e){if(0!==e.indexOf("inline:"))return null;const t=e.substring(7).split("|");return {keyMethod:"inline",keySalt:t[0],lifeTime:t[1],mkiValue:t[2]?t[2].split(":")[0]:void 0,mkiLength:t[2]?t[2].split(":")[1]:void 0}},t.writeCryptoKeyParams=function(e){return e.keyMethod+":"+e.keySalt+(e.lifeTime?"|"+e.lifeTime:"")+(e.mkiValue&&e.mkiLength?"|"+e.mkiValue+":"+e.mkiLength:"")},t.getCryptoParameters=function(e,i){return t.matchPrefix(e+i,"a=crypto:").map(t.parseCryptoLine)},t.getIceParameters=function(e,i){const r=t.matchPrefix(e+i,"a=ice-ufrag:")[0],n=t.matchPrefix(e+i,"a=ice-pwd:")[0];return r&&n?{usernameFragment:r.substring(12),password:n.substring(10)}:null},t.writeIceParameters=function(e){let t="a=ice-ufrag:"+e.usernameFragment+"\r\na=ice-pwd:"+e.password+"\r\n";return e.iceLite&&(t+="a=ice-lite\r\n"),t},t.parseRtpParameters=function(e){const i={codecs:[],headerExtensions:[],fecMechanisms:[],rtcp:[]},r=t.splitLines(e)[0].split(" ");i.profile=r[2];for(let o=3;o<r.length;o++){const n=r[o],s=t.matchPrefix(e,"a=rtpmap:"+n+" ")[0];if(s){const r=t.parseRtpMap(s),o=t.matchPrefix(e,"a=fmtp:"+n+" ");switch(r.parameters=o.length?t.parseFmtp(o[0]):{},r.rtcpFeedback=t.matchPrefix(e,"a=rtcp-fb:"+n+" ").map(t.parseRtcpFb),i.codecs.push(r),r.name.toUpperCase()){case"RED":case"ULPFEC":i.fecMechanisms.push(r.name.toUpperCase());}}}t.matchPrefix(e,"a=extmap:").forEach((e=>{i.headerExtensions.push(t.parseExtmap(e));}));const n=t.matchPrefix(e,"a=rtcp-fb:* ").map(t.parseRtcpFb);return i.codecs.forEach((e=>{n.forEach((t=>{e.rtcpFeedback.find((e=>e.type===t.type&&e.parameter===t.parameter))||e.rtcpFeedback.push(t);}));})),i},t.writeRtpDescription=function(e,i){let r="";r+="m="+e+" ",r+=i.codecs.length>0?"9":"0",r+=" "+(i.profile||"UDP/TLS/RTP/SAVPF")+" ",r+=i.codecs.map((e=>void 0!==e.preferredPayloadType?e.preferredPayloadType:e.payloadType)).join(" ")+"\r\n",r+="c=IN IP4 0.0.0.0\r\n",r+="a=rtcp:9 IN IP4 0.0.0.0\r\n",i.codecs.forEach((e=>{r+=t.writeRtpMap(e),r+=t.writeFmtp(e),r+=t.writeRtcpFb(e);}));let n=0;return i.codecs.forEach((e=>{e.maxptime>n&&(n=e.maxptime);})),n>0&&(r+="a=maxptime:"+n+"\r\n"),i.headerExtensions&&i.headerExtensions.forEach((e=>{r+=t.writeExtmap(e);})),r},t.parseRtpEncodingParameters=function(e){const i=[],r=t.parseRtpParameters(e),n=-1!==r.fecMechanisms.indexOf("RED"),o=-1!==r.fecMechanisms.indexOf("ULPFEC"),s=t.matchPrefix(e,"a=ssrc:").map((e=>t.parseSsrcMedia(e))).filter((e=>"cname"===e.attribute)),a=s.length>0&&s[0].ssrc;let c;const l=t.matchPrefix(e,"a=ssrc-group:FID").map((e=>e.substring(17).split(" ").map((e=>parseInt(e,10)))));l.length>0&&l[0].length>1&&l[0][0]===a&&(c=l[0][1]),r.codecs.forEach((e=>{if("RTX"===e.name.toUpperCase()&&e.parameters.apt){let t={ssrc:a,codecPayloadType:parseInt(e.parameters.apt,10)};a&&c&&(t.rtx={ssrc:c}),i.push(t),n&&(t=JSON.parse(JSON.stringify(t)),t.fec={ssrc:a,mechanism:o?"red+ulpfec":"red"},i.push(t));}})),0===i.length&&a&&i.push({ssrc:a});let d=t.matchPrefix(e,"b=");return d.length&&(d=0===d[0].indexOf("b=TIAS:")?parseInt(d[0].substring(7),10):0===d[0].indexOf("b=AS:")?1e3*parseInt(d[0].substring(5),10)*.95-16e3:void 0,i.forEach((e=>{e.maxBitrate=d;}))),i},t.parseRtcpParameters=function(e){const i={},r=t.matchPrefix(e,"a=ssrc:").map((e=>t.parseSsrcMedia(e))).filter((e=>"cname"===e.attribute))[0];r&&(i.cname=r.value,i.ssrc=r.ssrc);const n=t.matchPrefix(e,"a=rtcp-rsize");i.reducedSize=n.length>0,i.compound=0===n.length;const o=t.matchPrefix(e,"a=rtcp-mux");return i.mux=o.length>0,i},t.writeRtcpParameters=function(e){let t="";return e.reducedSize&&(t+="a=rtcp-rsize\r\n"),e.mux&&(t+="a=rtcp-mux\r\n"),void 0!==e.ssrc&&e.cname&&(t+="a=ssrc:"+e.ssrc+" cname:"+e.cname+"\r\n"),t},t.parseMsid=function(e){let i;const r=t.matchPrefix(e,"a=msid:");if(1===r.length)return i=r[0].substring(7).split(" "),{stream:i[0],track:i[1]};const n=t.matchPrefix(e,"a=ssrc:").map((e=>t.parseSsrcMedia(e))).filter((e=>"msid"===e.attribute));return n.length>0?(i=n[0].value.split(" "),{stream:i[0],track:i[1]}):void 0},t.parseSctpDescription=function(e){const i=t.parseMLine(e),r=t.matchPrefix(e,"a=max-message-size:");let n;r.length>0&&(n=parseInt(r[0].substring(19),10)),isNaN(n)&&(n=65536);const o=t.matchPrefix(e,"a=sctp-port:");if(o.length>0)return {port:parseInt(o[0].substring(12),10),protocol:i.fmt,maxMessageSize:n};const s=t.matchPrefix(e,"a=sctpmap:");if(s.length>0){const e=s[0].substring(10).split(" ");return {port:parseInt(e[0],10),protocol:e[1],maxMessageSize:n}}},t.writeSctpDescription=function(e,t){let i=[];return i="DTLS/SCTP"!==e.protocol?["m="+e.kind+" 9 "+e.protocol+" "+t.protocol+"\r\n","c=IN IP4 0.0.0.0\r\n","a=sctp-port:"+t.port+"\r\n"]:["m="+e.kind+" 9 "+e.protocol+" "+t.port+"\r\n","c=IN IP4 0.0.0.0\r\n","a=sctpmap:"+t.port+" "+t.protocol+" 65535\r\n"],void 0!==t.maxMessageSize&&i.push("a=max-message-size:"+t.maxMessageSize+"\r\n"),i.join("")},t.generateSessionId=function(){return Math.random().toString().substr(2,22)},t.writeSessionBoilerplate=function(e,i,r){let n;const o=void 0!==i?i:2;n=e||t.generateSessionId();return "v=0\r\no="+(r||"thisisadapterortc")+" "+n+" "+o+" IN IP4 127.0.0.1\r\ns=-\r\nt=0 0\r\n"},t.getDirection=function(e,i){const r=t.splitLines(e);for(let t=0;t<r.length;t++)switch(r[t]){case"a=sendrecv":case"a=sendonly":case"a=recvonly":case"a=inactive":return r[t].substring(2)}return i?t.getDirection(i):"sendrecv"},t.getKind=function(e){return t.splitLines(e)[0].split(" ")[0].substring(2)},t.isRejected=function(e){return "0"===e.split(" ",2)[1]},t.parseMLine=function(e){const i=t.splitLines(e)[0].substring(2).split(" ");return {kind:i[0],port:parseInt(i[1],10),protocol:i[2],fmt:i.slice(3).join(" ")}},t.parseOLine=function(e){const i=t.matchPrefix(e,"o=")[0].substring(2).split(" ");return {username:i[0],sessionId:i[1],sessionVersion:parseInt(i[2],10),netType:i[3],addressType:i[4],address:i[5]}},t.isValidSDP=function(e){if("string"!=typeof e||0===e.length)return !1;const i=t.splitLines(e);for(let t=0;t<i.length;t++)if(i[t].length<2||"="!==i[t].charAt(1))return !1;return !0},e.exports=t;}(aC);var cC=sC,lC=e({__proto__:null,default:cC},[sC]);function dC(e){if(!e.RTCIceCandidate||e.RTCIceCandidate&&"foundation"in e.RTCIceCandidate.prototype)return;const t=e.RTCIceCandidate;e.RTCIceCandidate=function(e){if("object"==typeof e&&e.candidate&&0===e.candidate.indexOf("a=")&&((e=JSON.parse(JSON.stringify(e))).candidate=e.candidate.substring(2)),e.candidate&&e.candidate.length){const i=new t(e),r=cC.parseCandidate(e.candidate);for(const e in r)e in i||Object.defineProperty(i,e,{value:r[e]});return i.toJSON=function(){return {candidate:i.candidate,sdpMid:i.sdpMid,sdpMLineIndex:i.sdpMLineIndex,usernameFragment:i.usernameFragment}},i}return new t(e)},e.RTCIceCandidate.prototype=t.prototype,gA(e,"icecandidate",(t=>(t.candidate&&Object.defineProperty(t,"candidate",{value:new e.RTCIceCandidate(t.candidate),writable:"false"}),t)));}function uC(e){!e.RTCIceCandidate||e.RTCIceCandidate&&"relayProtocol"in e.RTCIceCandidate.prototype||gA(e,"icecandidate",(e=>{if(e.candidate){const t=cC.parseCandidate(e.candidate.candidate);"relay"===t.type&&(e.candidate.relayProtocol={0:"tls",1:"tcp",2:"udp"}[t.priority>>24]);}return e}));}function hC(e,t){if(!e.RTCPeerConnection)return;"sctp"in e.RTCPeerConnection.prototype||Object.defineProperty(e.RTCPeerConnection.prototype,"sctp",{get(){return void 0===this._sctp?null:this._sctp}});const i=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(){if(this._sctp=null,"chrome"===t.browser&&t.version>=76){const{sdpSemantics:e}=this.getConfiguration();"plan-b"===e&&Object.defineProperty(this,"sctp",{get(){return void 0===this._sctp?null:this._sctp},enumerable:!0,configurable:!0});}if(function(e){if(!e||!e.sdp)return !1;const t=cC.splitSections(e.sdp);return t.shift(),t.some((e=>{const t=cC.parseMLine(e);return t&&"application"===t.kind&&-1!==t.protocol.indexOf("SCTP")}))}(arguments[0])){const e=function(e){const t=e.sdp.match(/mozilla...THIS_IS_SDPARTA-(\d+)/);if(null===t||t.length<2)return -1;const i=parseInt(t[1],10);return i!=i?-1:i}(arguments[0]),i=function(e){let i=65536;return "firefox"===t.browser&&(i=t.version<57?-1===e?16384:2147483637:t.version<60?57===t.version?65535:65536:2147483637),i}(e),r=function(e,i){let r=65536;"firefox"===t.browser&&57===t.version&&(r=65535);const n=cC.matchPrefix(e.sdp,"a=max-message-size:");return n.length>0?r=parseInt(n[0].substring(19),10):"firefox"===t.browser&&-1!==i&&(r=2147483637),r}(arguments[0],e);let n;n=0===i&&0===r?Number.POSITIVE_INFINITY:0===i||0===r?Math.max(i,r):Math.min(i,r);const o={};Object.defineProperty(o,"maxMessageSize",{get:()=>n}),this._sctp=o;}return i.apply(this,arguments)};}function pC(e){if(!e.RTCPeerConnection||!("createDataChannel"in e.RTCPeerConnection.prototype))return;function t(e,t){const i=e.send;e.send=function(){const r=arguments[0],n=r.length||r.size||r.byteLength;if("open"===e.readyState&&t.sctp&&n>t.sctp.maxMessageSize)throw new TypeError("Message too large (can send a maximum of "+t.sctp.maxMessageSize+" bytes)");return i.apply(e,arguments)};}const i=e.RTCPeerConnection.prototype.createDataChannel;e.RTCPeerConnection.prototype.createDataChannel=function(){const e=i.apply(this,arguments);return t(e,this),e},gA(e,"datachannel",(e=>(t(e.channel,e.target),e)));}function mC(e){if(!e.RTCPeerConnection||"connectionState"in e.RTCPeerConnection.prototype)return;const t=e.RTCPeerConnection.prototype;Object.defineProperty(t,"connectionState",{get(){return {completed:"connected",checking:"connecting"}[this.iceConnectionState]||this.iceConnectionState},enumerable:!0,configurable:!0}),Object.defineProperty(t,"onconnectionstatechange",{get(){return this._onconnectionstatechange||null},set(e){this._onconnectionstatechange&&(this.removeEventListener("connectionstatechange",this._onconnectionstatechange),delete this._onconnectionstatechange),e&&this.addEventListener("connectionstatechange",this._onconnectionstatechange=e);},enumerable:!0,configurable:!0}),["setLocalDescription","setRemoteDescription"].forEach((e=>{const i=t[e];t[e]=function(){return this._connectionstatechangepoly||(this._connectionstatechangepoly=e=>{const t=e.target;if(t._lastConnectionState!==t.connectionState){t._lastConnectionState=t.connectionState;const i=new Event("connectionstatechange",e);t.dispatchEvent(i);}return e},this.addEventListener("iceconnectionstatechange",this._connectionstatechangepoly)),i.apply(this,arguments)};}));}function _C(e,t){if(!e.RTCPeerConnection)return;if("chrome"===t.browser&&t.version>=71)return;if("safari"===t.browser&&t.version>=605)return;const i=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(t){if(t&&t.sdp&&-1!==t.sdp.indexOf("\na=extmap-allow-mixed")){const i=t.sdp.split("\n").filter((e=>"a=extmap-allow-mixed"!==e.trim())).join("\n");e.RTCSessionDescription&&t instanceof e.RTCSessionDescription?arguments[0]=new e.RTCSessionDescription({type:t.type,sdp:i}):t.sdp=i;}return i.apply(this,arguments)};}function fC(e,t){if(!e.RTCPeerConnection||!e.RTCPeerConnection.prototype)return;const i=e.RTCPeerConnection.prototype.addIceCandidate;i&&0!==i.length&&(e.RTCPeerConnection.prototype.addIceCandidate=function(){return arguments[0]?("chrome"===t.browser&&t.version<78||"firefox"===t.browser&&t.version<68||"safari"===t.browser)&&arguments[0]&&""===arguments[0].candidate?Promise.resolve():i.apply(this,arguments):(arguments[1]&&arguments[1].apply(null),Promise.resolve())});}function gC(e,t){if(!e.RTCPeerConnection||!e.RTCPeerConnection.prototype)return;const i=e.RTCPeerConnection.prototype.setLocalDescription;i&&0!==i.length&&(e.RTCPeerConnection.prototype.setLocalDescription=function(){let e=arguments[0]||{};if("object"!=typeof e||e.type&&e.sdp)return i.apply(this,arguments);if(e={type:e.type,sdp:e.sdp},!e.type)switch(this.signalingState){case"stable":case"have-local-offer":case"have-remote-pranswer":e.type="offer";break;default:e.type="answer";}if(e.sdp||"offer"!==e.type&&"answer"!==e.type)return i.apply(this,[e]);return ("offer"===e.type?this.createOffer:this.createAnswer).apply(this).then((e=>i.apply(this,[e])))});}var TC=Object.freeze({__proto__:null,shimRTCIceCandidate:dC,shimRTCIceCandidateRelayProtocol:uC,shimMaxMessageSize:hC,shimSendThrowTypeError:pC,shimConnectionState:mC,removeExtmapAllowMixed:_C,shimAddIceCandidateNullOrEmpty:fC,shimParameterlessSetLocalDescription:gC});!function({window:e}={},t={shimChrome:!0,shimFirefox:!0,shimSafari:!0}){const i=vA,r=function(e){const t={browser:null,version:null};if(void 0===e||!e.navigator||!e.navigator.userAgent)return t.browser="Not a browser.",t;const{navigator:i}=e;if(i.mozGetUserMedia)t.browser="firefox",t.version=fA(i.userAgent,/Firefox\/(\d+)\./,1);else if(i.webkitGetUserMedia||!1===e.isSecureContext&&e.webkitRTCPeerConnection)t.browser="chrome",t.version=fA(i.userAgent,/Chrom(e|ium)\/(\d+)\./,2);else {if(!e.RTCPeerConnection||!i.userAgent.match(/AppleWebKit\/(\d+)\./))return t.browser="Not a supported browser.",t;t.browser="safari",t.version=fA(i.userAgent,/AppleWebKit\/(\d+)\./,1),t.supportsUnifiedPlan=e.RTCRtpTransceiver&&"currentDirection"in e.RTCRtpTransceiver.prototype;}return t}(e),n={browserDetails:r,commonShim:TC,extractVersion:fA,disableLog:TA,disableWarnings:EA,sdp:lC};switch(r.browser){case"chrome":if(!VA||!LA||!t.shimChrome)return i("Chrome shim is not included in this adapter release."),n;if(null===r.version)return i("Chrome shim can not determine version, not shimming."),n;i("adapter.js shimming chrome."),n.browserShim=VA,fC(e,r),gC(e),bA(e,r),kA(e),LA(e,r),DA(e),MA(e,r),NA(e),wA(e),OA(e),xA(e,r),dC(e),uC(e),mC(e),hC(e,r),pC(e),_C(e,r);break;case"firefox":if(!YA||!BA||!t.shimFirefox)return i("Firefox shim is not included in this adapter release."),n;i("adapter.js shimming firefox."),n.browserShim=YA,fC(e,r),gC(e),UA(e,r),BA(e,r),FA(e),WA(e),HA(e),jA(e),GA(e),JA(e),KA(e),zA(e),qA(e),dC(e),mC(e),hC(e,r),pC(e);break;case"safari":if(!oC||!t.shimSafari)return i("Safari shim is not included in this adapter release."),n;i("adapter.js shimming safari."),n.browserShim=oC,fC(e,r),gC(e),tC(e),rC(e),$A(e),QA(e),XA(e),iC(e),ZA(e),nC(e),dC(e),uC(e),hC(e,r),pC(e),_C(e,r);break;default:i("Unsupported browser!");}}({window:"undefined"==typeof window?void 0:window});var EC,vC=Object.create,yC=Object.defineProperty,SC=Object.defineProperties,IC=Object.getOwnPropertyDescriptor,RC=Object.getOwnPropertyDescriptors,AC=Object.getOwnPropertyNames,CC=Object.getOwnPropertySymbols,bC=Object.getPrototypeOf,kC=Object.prototype.hasOwnProperty,DC=Object.prototype.propertyIsEnumerable,NC=Reflect.get,wC=Math.pow,OC=(e,t,i)=>t in e?yC(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i,PC=(e,t)=>{for(var i in t||(t={}))kC.call(t,i)&&OC(e,i,t[i]);if(CC)for(var i of CC(t))DC.call(t,i)&&OC(e,i,t[i]);return e},MC=(e,t)=>SC(e,RC(t)),LC=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports),xC=(e,t)=>{for(var i in t)yC(e,i,{get:t[i],enumerable:!0});},VC=(e,t,i)=>(i=null!=e?vC(bC(e)):{},((e,t,i,r)=>{if(t&&"object"==typeof t||"function"==typeof t)for(let n of AC(t))!kC.call(e,n)&&n!==i&&yC(e,n,{get:()=>t[n],enumerable:!(r=IC(t,n))||r.enumerable});return e})(!t&&e&&e.__esModule?i:yC(i,"default",{value:e,enumerable:!0}),e)),UC=(e,t,i,r)=>{for(var n,o=r>1?void 0:r?IC(t,i):t,s=e.length-1;s>=0;s--)(n=e[s])&&(o=(r?n(t,i,o):n(o))||o);return r&&o&&yC(t,i,o),o},FC=(e,t,i)=>(OC(e,"symbol"!=typeof t?t+"":t,i),i),BC=(e,t,i)=>NC(bC(e),i,t),HC=(e,t,i)=>new Promise(((r,n)=>{var o=e=>{try{a(i.next(e));}catch(dO){n(dO);}},s=e=>{try{a(i.throw(e));}catch(dO){n(dO);}},a=e=>e.done?r(e.value):Promise.resolve(e.value).then(o,s);a((i=i.apply(e,t)).next());})),jC=LC(((e,t)=>{var i=Object.prototype.hasOwnProperty,r="~";function n(){}function o(e,t,i){this.fn=e,this.context=t,this.once=i||!1;}function s(e,t,i,n,s){if("function"!=typeof i)throw new TypeError("The listener must be a function");var a=new o(i,n||e,s),c=r?r+t:t;return e._events[c]?e._events[c].fn?e._events[c]=[e._events[c],a]:e._events[c].push(a):(e._events[c]=a,e._eventsCount++),e}function a(e,t){0==--e._eventsCount?e._events=new n:delete e._events[t];}function c(){this._events=new n,this._eventsCount=0;}Object.create&&(n.prototype=Object.create(null),(new n).__proto__||(r=!1)),c.prototype.eventNames=function(){var e,t,n=[];if(0===this._eventsCount)return n;for(t in e=this._events)i.call(e,t)&&n.push(r?t.slice(1):t);return Object.getOwnPropertySymbols?n.concat(Object.getOwnPropertySymbols(e)):n},c.prototype.listeners=function(e){var t=r?r+e:e,i=this._events[t];if(!i)return [];if(i.fn)return [i.fn];for(var n=0,o=i.length,s=new Array(o);n<o;n++)s[n]=i[n].fn;return s},c.prototype.listenerCount=function(e){var t=r?r+e:e,i=this._events[t];return i?i.fn?1:i.length:0},c.prototype.emit=function(e,t,i,n,o,s){var a=r?r+e:e;if(!this._events[a])return !1;var c,l,d=this._events[a],u=arguments.length;if(d.fn){switch(d.once&&this.removeListener(e,d.fn,void 0,!0),u){case 1:return d.fn.call(d.context),!0;case 2:return d.fn.call(d.context,t),!0;case 3:return d.fn.call(d.context,t,i),!0;case 4:return d.fn.call(d.context,t,i,n),!0;case 5:return d.fn.call(d.context,t,i,n,o),!0;case 6:return d.fn.call(d.context,t,i,n,o,s),!0}for(l=1,c=new Array(u-1);l<u;l++)c[l-1]=arguments[l];d.fn.apply(d.context,c);}else {var h,p=d.length;for(l=0;l<p;l++)switch(d[l].once&&this.removeListener(e,d[l].fn,void 0,!0),u){case 1:d[l].fn.call(d[l].context);break;case 2:d[l].fn.call(d[l].context,t);break;case 3:d[l].fn.call(d[l].context,t,i);break;case 4:d[l].fn.call(d[l].context,t,i,n);break;default:if(!c)for(h=1,c=new Array(u-1);h<u;h++)c[h-1]=arguments[h];d[l].fn.apply(d[l].context,c);}}return !0},c.prototype.on=function(e,t,i){return s(this,e,t,i,!1)},c.prototype.once=function(e,t,i){return s(this,e,t,i,!0)},c.prototype.removeListener=function(e,t,i,n){var o=r?r+e:e;if(!this._events[o])return this;if(!t)return a(this,o),this;var s=this._events[o];if(s.fn)s.fn===t&&(!n||s.once)&&(!i||s.context===i)&&a(this,o);else {for(var c=0,l=[],d=s.length;c<d;c++)(s[c].fn!==t||n&&!s[c].once||i&&s[c].context!==i)&&l.push(s[c]);l.length?this._events[o]=1===l.length?l[0]:l:a(this,o);}return this},c.prototype.removeAllListeners=function(e){var t;return e?(t=r?r+e:e,this._events[t]&&a(this,t)):(this._events=new n,this._eventsCount=0),this},c.prototype.off=c.prototype.removeListener,c.prototype.addListener=c.prototype.on,c.prefixed=r,c.EventEmitter=c,void 0!==t&&(t.exports=c);})),WC=LC(((e,t)=>{var i=t.exports={v:[{name:"version",reg:/^(\d*)$/}],o:[{name:"origin",reg:/^(\S*) (\d*) (\d*) (\S*) IP(\d) (\S*)/,names:["username","sessionId","sessionVersion","netType","ipVer","address"],format:"%s %s %d %s IP%d %s"}],s:[{name:"name"}],i:[{name:"description"}],u:[{name:"uri"}],e:[{name:"email"}],p:[{name:"phone"}],z:[{name:"timezones"}],r:[{name:"repeats"}],t:[{name:"timing",reg:/^(\d*) (\d*)/,names:["start","stop"],format:"%d %d"}],c:[{name:"connection",reg:/^IN IP(\d) (\S*)/,names:["version","ip"],format:"IN IP%d %s"}],b:[{push:"bandwidth",reg:/^(TIAS|AS|CT|RR|RS):(\d*)/,names:["type","limit"],format:"%s:%s"}],m:[{reg:/^(\w*) (\d*) ([\w/]*)(?: (.*))?/,names:["type","port","protocol","payloads"],format:"%s %d %s %s"}],a:[{push:"rtp",reg:/^rtpmap:(\d*) ([\w\-.]*)(?:\s*\/(\d*)(?:\s*\/(\S*))?)?/,names:["payload","codec","rate","encoding"],format:function(e){return e.encoding?"rtpmap:%d %s/%s/%s":e.rate?"rtpmap:%d %s/%s":"rtpmap:%d %s"}},{push:"fmtp",reg:/^fmtp:(\d*) ([\S| ]*)/,names:["payload","config"],format:"fmtp:%d %s"},{name:"control",reg:/^control:(.*)/,format:"control:%s"},{name:"rtcp",reg:/^rtcp:(\d*)(?: (\S*) IP(\d) (\S*))?/,names:["port","netType","ipVer","address"],format:function(e){return null!=e.address?"rtcp:%d %s IP%d %s":"rtcp:%d"}},{push:"rtcpFbTrrInt",reg:/^rtcp-fb:(\*|\d*) trr-int (\d*)/,names:["payload","value"],format:"rtcp-fb:%s trr-int %d"},{push:"rtcpFb",reg:/^rtcp-fb:(\*|\d*) ([\w-_]*)(?: ([\w-_]*))?/,names:["payload","type","subtype"],format:function(e){return null!=e.subtype?"rtcp-fb:%s %s %s":"rtcp-fb:%s %s"}},{push:"ext",reg:/^extmap:(\d+)(?:\/(\w+))?(?: (urn:ietf:params:rtp-hdrext:encrypt))? (\S*)(?: (\S*))?/,names:["value","direction","encrypt-uri","uri","config"],format:function(e){return "extmap:%d"+(e.direction?"/%s":"%v")+(e["encrypt-uri"]?" %s":"%v")+" %s"+(e.config?" %s":"")}},{name:"extmapAllowMixed",reg:/^(extmap-allow-mixed)/},{push:"crypto",reg:/^crypto:(\d*) ([\w_]*) (\S*)(?: (\S*))?/,names:["id","suite","config","sessionConfig"],format:function(e){return null!=e.sessionConfig?"crypto:%d %s %s %s":"crypto:%d %s %s"}},{name:"setup",reg:/^setup:(\w*)/,format:"setup:%s"},{name:"connectionType",reg:/^connection:(new|existing)/,format:"connection:%s"},{name:"mid",reg:/^mid:([^\s]*)/,format:"mid:%s"},{name:"msid",reg:/^msid:(.*)/,format:"msid:%s"},{name:"ptime",reg:/^ptime:(\d*(?:\.\d*)*)/,format:"ptime:%d"},{name:"maxptime",reg:/^maxptime:(\d*(?:\.\d*)*)/,format:"maxptime:%d"},{name:"direction",reg:/^(sendrecv|recvonly|sendonly|inactive)/},{name:"icelite",reg:/^(ice-lite)/},{name:"iceUfrag",reg:/^ice-ufrag:(\S*)/,format:"ice-ufrag:%s"},{name:"icePwd",reg:/^ice-pwd:(\S*)/,format:"ice-pwd:%s"},{name:"fingerprint",reg:/^fingerprint:(\S*) (\S*)/,names:["type","hash"],format:"fingerprint:%s %s"},{push:"candidates",reg:/^candidate:(\S*) (\d*) (\S*) (\d*) (\S*) (\d*) typ (\S*)(?: raddr (\S*) rport (\d*))?(?: tcptype (\S*))?(?: generation (\d*))?(?: network-id (\d*))?(?: network-cost (\d*))?/,names:["foundation","component","transport","priority","ip","port","type","raddr","rport","tcptype","generation","network-id","network-cost"],format:function(e){var t="candidate:%s %d %s %d %s %d typ %s";return t+=null!=e.raddr?" raddr %s rport %d":"%v%v",t+=null!=e.tcptype?" tcptype %s":"%v",null!=e.generation&&(t+=" generation %d"),t+=null!=e["network-id"]?" network-id %d":"%v",t+=null!=e["network-cost"]?" network-cost %d":"%v"}},{name:"endOfCandidates",reg:/^(end-of-candidates)/},{name:"remoteCandidates",reg:/^remote-candidates:(.*)/,format:"remote-candidates:%s"},{name:"iceOptions",reg:/^ice-options:(\S*)/,format:"ice-options:%s"},{push:"ssrcs",reg:/^ssrc:(\d*) ([\w_-]*)(?::(.*))?/,names:["id","attribute","value"],format:function(e){var t="ssrc:%d";return null!=e.attribute&&(t+=" %s",null!=e.value&&(t+=":%s")),t}},{push:"ssrcGroups",reg:/^ssrc-group:([\x21\x23\x24\x25\x26\x27\x2A\x2B\x2D\x2E\w]*) (.*)/,names:["semantics","ssrcs"],format:"ssrc-group:%s %s"},{name:"msidSemantic",reg:/^msid-semantic:\s?(\w*) (\S*)/,names:["semantic","token"],format:"msid-semantic: %s %s"},{push:"groups",reg:/^group:(\w*) (.*)/,names:["type","mids"],format:"group:%s %s"},{name:"rtcpMux",reg:/^(rtcp-mux)/},{name:"rtcpRsize",reg:/^(rtcp-rsize)/},{name:"sctpmap",reg:/^sctpmap:([\w_/]*) (\S*)(?: (\S*))?/,names:["sctpmapNumber","app","maxMessageSize"],format:function(e){return null!=e.maxMessageSize?"sctpmap:%s %s %s":"sctpmap:%s %s"}},{name:"xGoogleFlag",reg:/^x-google-flag:([^\s]*)/,format:"x-google-flag:%s"},{push:"rids",reg:/^rid:([\d\w]+) (\w+)(?: ([\S| ]*))?/,names:["id","direction","params"],format:function(e){return e.params?"rid:%s %s %s":"rid:%s %s"}},{push:"imageattrs",reg:new RegExp("^imageattr:(\\d+|\\*)[\\s\\t]+(send|recv)[\\s\\t]+(\\*|\\[\\S+\\](?:[\\s\\t]+\\[\\S+\\])*)(?:[\\s\\t]+(recv|send)[\\s\\t]+(\\*|\\[\\S+\\](?:[\\s\\t]+\\[\\S+\\])*))?"),names:["pt","dir1","attrs1","dir2","attrs2"],format:function(e){return "imageattr:%s %s %s"+(e.dir2?" %s %s":"")}},{name:"simulcast",reg:new RegExp("^simulcast:(send|recv) ([a-zA-Z0-9\\-_~;,]+)(?:\\s?(send|recv) ([a-zA-Z0-9\\-_~;,]+))?$"),names:["dir1","list1","dir2","list2"],format:function(e){return "simulcast:%s %s"+(e.dir2?" %s %s":"")}},{name:"simulcast_03",reg:/^simulcast:[\s\t]+([\S+\s\t]+)$/,names:["value"],format:"simulcast: %s"},{name:"framerate",reg:/^framerate:(\d+(?:$|\.\d+))/,format:"framerate:%s"},{name:"sourceFilter",reg:/^source-filter: *(excl|incl) (\S*) (IP4|IP6|\*) (\S*) (.*)/,names:["filterMode","netType","addressTypes","destAddress","srcList"],format:"source-filter: %s %s %s %s %s"},{name:"bundleOnly",reg:/^(bundle-only)/},{name:"label",reg:/^label:(.+)/,format:"label:%s"},{name:"sctpPort",reg:/^sctp-port:(\d+)$/,format:"sctp-port:%s"},{name:"maxMessageSize",reg:/^max-message-size:(\d+)$/,format:"max-message-size:%s"},{push:"tsRefClocks",reg:/^ts-refclk:([^\s=]*)(?:=(\S*))?/,names:["clksrc","clksrcExt"],format:function(e){return "ts-refclk:%s"+(null!=e.clksrcExt?"=%s":"")}},{name:"mediaClk",reg:/^mediaclk:(?:id=(\S*))? *([^\s=]*)(?:=(\S*))?(?: *rate=(\d+)\/(\d+))?/,names:["id","mediaClockName","mediaClockValue","rateNumerator","rateDenominator"],format:function(e){var t="mediaclk:";return t+=null!=e.id?"id=%s %s":"%v%s",t+=null!=e.mediaClockValue?"=%s":"",t+=null!=e.rateNumerator?" rate=%s":"",t+=null!=e.rateDenominator?"/%s":""}},{name:"keywords",reg:/^keywds:(.+)$/,format:"keywds:%s"},{name:"content",reg:/^content:(.+)/,format:"content:%s"},{name:"bfcpFloorCtrl",reg:/^floorctrl:(c-only|s-only|c-s)/,format:"floorctrl:%s"},{name:"bfcpConfId",reg:/^confid:(\d+)/,format:"confid:%s"},{name:"bfcpUserId",reg:/^userid:(\d+)/,format:"userid:%s"},{name:"bfcpFloorId",reg:/^floorid:(.+) (?:m-stream|mstrm):(.+)/,names:["id","mStream"],format:"floorid:%s mstrm:%s"},{push:"invalid",names:["value"]}]};Object.keys(i).forEach((function(e){i[e].forEach((function(e){e.reg||(e.reg=/(.*)/),e.format||(e.format="%s");}));}));})),GC=LC((e=>{var t=function(e){return String(Number(e))===e?Number(e):e},i=function(e,i,r){var n=e.name&&e.names;e.push&&!i[e.push]?i[e.push]=[]:n&&!i[e.name]&&(i[e.name]={});var o=e.push?{}:n?i[e.name]:i;((function(e,i,r,n){if(n&&!r)i[n]=t(e[1]);else for(var o=0;o<r.length;o+=1)null!=e[o+1]&&(i[r[o]]=t(e[o+1]));}))(r.match(e.reg),o,e.names,e.name),e.push&&i[e.push].push(o);},r=WC(),n=RegExp.prototype.test.bind(/^([a-z])=(.*)/);e.parse=function(e){var t={},o=[],s=t;return e.split(/(\r\n|\r|\n)/).filter(n).forEach((function(e){var t=e[0],n=e.slice(2);"m"===t&&(o.push({rtp:[],fmtp:[]}),s=o[o.length-1]);for(var a=0;a<(r[t]||[]).length;a+=1){var c=r[t][a];if(c.reg.test(n))return i(c,s,n)}})),t.media=o,t};var o=function(e,i){var r=i.split(/=(.+)/,2);return 2===r.length?e[r[0]]=t(r[1]):1===r.length&&i.length>1&&(e[r[0]]=void 0),e};e.parseParams=function(e){return e.split(/;\s?/).reduce(o,{})},e.parseFmtpConfig=e.parseParams,e.parsePayloads=function(e){return e.toString().split(" ").map(Number)},e.parseRemoteCandidates=function(e){for(var i=[],r=e.split(" ").map(t),n=0;n<r.length;n+=3)i.push({component:r[n],ip:r[n+1],port:r[n+2]});return i},e.parseImageAttributes=function(e){return e.split(" ").map((function(e){return e.substring(1,e.length-1).split(",").reduce(o,{})}))},e.parseSimulcastStreamList=function(e){return e.split(";").map((function(e){return e.split(",").map((function(e){var i,r=!1;return "~"!==e[0]?i=t(e):(i=t(e.substring(1,e.length)),r=!0),{scid:i,paused:r}}))}))};})),JC=LC(((e,t)=>{var i=WC(),r=/%[sdv%]/g,n=function(e){var t=1,i=arguments,n=i.length;return e.replace(r,(function(e){if(t>=n)return e;var r=i[t];switch(t+=1,e){case"%%":return "%";case"%s":return String(r);case"%d":return Number(r);case"%v":return ""}}))},o=function(e,t,i){var r=[e+"="+(t.format instanceof Function?t.format(t.push?i:i[t.name]):t.format)];if(t.names)for(var o=0;o<t.names.length;o+=1){var s=t.names[o];t.name?r.push(i[t.name][s]):r.push(i[t.names[o]]);}else r.push(i[t.name]);return n.apply(null,r)},s=["v","o","s","i","u","e","p","c","b","t","r","z","a"],a=["i","c","b","a"];t.exports=function(e,t){t=t||{},null==e.version&&(e.version=0),null==e.name&&(e.name=" "),e.media.forEach((function(e){null==e.payloads&&(e.payloads="");}));var r=t.outerOrder||s,n=t.innerOrder||a,c=[];return r.forEach((function(t){i[t].forEach((function(i){i.name in e&&null!=e[i.name]?c.push(o(t,i,e)):i.push in e&&null!=e[i.push]&&e[i.push].forEach((function(e){c.push(o(t,i,e));}));}));})),e.media.forEach((function(e){c.push(o("m",i.m[0],e)),n.forEach((function(t){i[t].forEach((function(i){i.name in e&&null!=e[i.name]?c.push(o(t,i,e)):i.push in e&&null!=e[i.push]&&e[i.push].forEach((function(e){c.push(o(t,i,e));}));}));}));})),c.join("\r\n")+"\r\n"};})),KC=LC((e=>{var t=GC(),i=JC();e.write=i,e.parse=t.parse,e.parseParams=t.parseParams,e.parseFmtpConfig=t.parseFmtpConfig,e.parsePayloads=t.parsePayloads,e.parseRemoteCandidates=t.parseRemoteCandidates,e.parseImageAttributes=t.parseImageAttributes,e.parseSimulcastStreamList=t.parseSimulcastStreamList;})),zC=LC(((e,t)=>{var i=t.exports={v:[{name:"version",reg:/^(\d*)$/}],o:[{name:"origin",reg:/^(\S*) (\d*) (\d*) (\S*) IP(\d) (\S*)/,names:["username","sessionId","sessionVersion","netType","ipVer","address"],format:"%s %s %d %s IP%d %s"}],s:[{name:"name"}],i:[{name:"description"}],u:[{name:"uri"}],e:[{name:"email"}],p:[{name:"phone"}],z:[{name:"timezones"}],r:[{name:"repeats"}],t:[{name:"timing",reg:/^(\d*) (\d*)/,names:["start","stop"],format:"%d %d"}],c:[{name:"connection",reg:/^IN IP(\d) (\S*)/,names:["version","ip"],format:"IN IP%d %s"}],b:[{push:"bandwidth",reg:/^(TIAS|AS|CT|RR|RS):(\d*)/,names:["type","limit"],format:"%s:%s"}],m:[{reg:/^(\w*) (\d*) ([\w/]*)(?: (.*))?/,names:["type","port","protocol","payloads"],format:"%s %d %s %s"}],a:[{push:"rtp",reg:/^rtpmap:(\d*) ([\w\-.]*)(?:\s*\/(\d*)(?:\s*\/(\S*))?)?/,names:["payload","codec","rate","encoding"],format:function(e){return e.encoding?"rtpmap:%d %s/%s/%s":e.rate?"rtpmap:%d %s/%s":"rtpmap:%d %s"}},{push:"fmtp",reg:/^fmtp:(\d*) ([\S| ]*)/,names:["payload","config"],format:"fmtp:%d %s"},{name:"control",reg:/^control:(.*)/,format:"control:%s"},{name:"rtcp",reg:/^rtcp:(\d*)(?: (\S*) IP(\d) (\S*))?/,names:["port","netType","ipVer","address"],format:function(e){return null!=e.address?"rtcp:%d %s IP%d %s":"rtcp:%d"}},{push:"rtcpFbTrrInt",reg:/^rtcp-fb:(\*|\d*) trr-int (\d*)/,names:["payload","value"],format:"rtcp-fb:%s trr-int %d"},{push:"rtcpFb",reg:/^rtcp-fb:(\*|\d*) ([\w-_]*)(?: ([\w-_]*))?/,names:["payload","type","subtype"],format:function(e){return null!=e.subtype?"rtcp-fb:%s %s %s":"rtcp-fb:%s %s"}},{push:"ext",reg:/^extmap:(\d+)(?:\/(\w+))?(?: (urn:ietf:params:rtp-hdrext:encrypt))? (\S*)(?: (\S*))?/,names:["value","direction","encrypt-uri","uri","config"],format:function(e){return "extmap:%d"+(e.direction?"/%s":"%v")+(e["encrypt-uri"]?" %s":"%v")+" %s"+(e.config?" %s":"")}},{name:"extmapAllowMixed",reg:/^(extmap-allow-mixed)/},{push:"crypto",reg:/^crypto:(\d*) ([\w_]*) (\S*)(?: (\S*))?/,names:["id","suite","config","sessionConfig"],format:function(e){return null!=e.sessionConfig?"crypto:%d %s %s %s":"crypto:%d %s %s"}},{name:"setup",reg:/^setup:(\w*)/,format:"setup:%s"},{name:"connectionType",reg:/^connection:(new|existing)/,format:"connection:%s"},{name:"mid",reg:/^mid:([^\s]*)/,format:"mid:%s"},{name:"msid",reg:/^msid:(.*)/,format:"msid:%s"},{name:"ptime",reg:/^ptime:(\d*(?:\.\d*)*)/,format:"ptime:%d"},{name:"maxptime",reg:/^maxptime:(\d*(?:\.\d*)*)/,format:"maxptime:%d"},{name:"direction",reg:/^(sendrecv|recvonly|sendonly|inactive)/},{name:"icelite",reg:/^(ice-lite)/},{name:"iceUfrag",reg:/^ice-ufrag:(\S*)/,format:"ice-ufrag:%s"},{name:"icePwd",reg:/^ice-pwd:(\S*)/,format:"ice-pwd:%s"},{name:"fingerprint",reg:/^fingerprint:(\S*) (\S*)/,names:["type","hash"],format:"fingerprint:%s %s"},{push:"candidates",reg:/^candidate:(\S*) (\d*) (\S*) (\d*) (\S*) (\d*) typ (\S*)(?: raddr (\S*) rport (\d*))?(?: tcptype (\S*))?(?: generation (\d*))?(?: network-id (\d*))?(?: network-cost (\d*))?/,names:["foundation","component","transport","priority","ip","port","type","raddr","rport","tcptype","generation","network-id","network-cost"],format:function(e){var t="candidate:%s %d %s %d %s %d typ %s";return t+=null!=e.raddr?" raddr %s rport %d":"%v%v",t+=null!=e.tcptype?" tcptype %s":"%v",null!=e.generation&&(t+=" generation %d"),t+=null!=e["network-id"]?" network-id %d":"%v",t+=null!=e["network-cost"]?" network-cost %d":"%v"}},{name:"endOfCandidates",reg:/^(end-of-candidates)/},{name:"remoteCandidates",reg:/^remote-candidates:(.*)/,format:"remote-candidates:%s"},{name:"iceOptions",reg:/^ice-options:(\S*)/,format:"ice-options:%s"},{push:"ssrcs",reg:/^ssrc:(\d*) ([\w_-]*)(?::(.*))?/,names:["id","attribute","value"],format:function(e){var t="ssrc:%d";return null!=e.attribute&&(t+=" %s",null!=e.value&&(t+=":%s")),t}},{push:"ssrcGroups",reg:/^ssrc-group:([\x21\x23\x24\x25\x26\x27\x2A\x2B\x2D\x2E\w]*) (.*)/,names:["semantics","ssrcs"],format:"ssrc-group:%s %s"},{name:"msidSemantic",reg:/^msid-semantic:\s?(\w*) (\S*)/,names:["semantic","token"],format:"msid-semantic: %s %s"},{push:"groups",reg:/^group:(\w*) (.*)/,names:["type","mids"],format:"group:%s %s"},{name:"rtcpMux",reg:/^(rtcp-mux)/},{name:"rtcpRsize",reg:/^(rtcp-rsize)/},{name:"sctpmap",reg:/^sctpmap:([\w_/]*) (\S*)(?: (\S*))?/,names:["sctpmapNumber","app","maxMessageSize"],format:function(e){return null!=e.maxMessageSize?"sctpmap:%s %s %s":"sctpmap:%s %s"}},{name:"xGoogleFlag",reg:/^x-google-flag:([^\s]*)/,format:"x-google-flag:%s"},{push:"rids",reg:/^rid:([\d\w]+) (\w+)(?: ([\S| ]*))?/,names:["id","direction","params"],format:function(e){return e.params?"rid:%s %s %s":"rid:%s %s"}},{push:"imageattrs",reg:new RegExp("^imageattr:(\\d+|\\*)[\\s\\t]+(send|recv)[\\s\\t]+(\\*|\\[\\S+\\](?:[\\s\\t]+\\[\\S+\\])*)(?:[\\s\\t]+(recv|send)[\\s\\t]+(\\*|\\[\\S+\\](?:[\\s\\t]+\\[\\S+\\])*))?"),names:["pt","dir1","attrs1","dir2","attrs2"],format:function(e){return "imageattr:%s %s %s"+(e.dir2?" %s %s":"")}},{name:"simulcast",reg:new RegExp("^simulcast:(send|recv) ([a-zA-Z0-9\\-_~;,]+)(?:\\s?(send|recv) ([a-zA-Z0-9\\-_~;,]+))?$"),names:["dir1","list1","dir2","list2"],format:function(e){return "simulcast:%s %s"+(e.dir2?" %s %s":"")}},{name:"simulcast_03",reg:/^simulcast:[\s\t]+([\S+\s\t]+)$/,names:["value"],format:"simulcast: %s"},{name:"framerate",reg:/^framerate:(\d+(?:$|\.\d+))/,format:"framerate:%s"},{name:"sourceFilter",reg:/^source-filter: *(excl|incl) (\S*) (IP4|IP6|\*) (\S*) (.*)/,names:["filterMode","netType","addressTypes","destAddress","srcList"],format:"source-filter: %s %s %s %s %s"},{name:"bundleOnly",reg:/^(bundle-only)/},{name:"label",reg:/^label:(.+)/,format:"label:%s"},{name:"sctpPort",reg:/^sctp-port:(\d+)$/,format:"sctp-port:%s"},{name:"maxMessageSize",reg:/^max-message-size:(\d+)$/,format:"max-message-size:%s"},{push:"tsRefClocks",reg:/^ts-refclk:([^\s=]*)(?:=(\S*))?/,names:["clksrc","clksrcExt"],format:function(e){return "ts-refclk:%s"+(null!=e.clksrcExt?"=%s":"")}},{name:"mediaClk",reg:/^mediaclk:(?:id=(\S*))? *([^\s=]*)(?:=(\S*))?(?: *rate=(\d+)\/(\d+))?/,names:["id","mediaClockName","mediaClockValue","rateNumerator","rateDenominator"],format:function(e){var t="mediaclk:";return t+=null!=e.id?"id=%s %s":"%v%s",t+=null!=e.mediaClockValue?"=%s":"",t+=null!=e.rateNumerator?" rate=%s":"",t+=null!=e.rateDenominator?"/%s":""}},{name:"keywords",reg:/^keywds:(.+)$/,format:"keywds:%s"},{name:"content",reg:/^content:(.+)/,format:"content:%s"},{name:"bfcpFloorCtrl",reg:/^floorctrl:(c-only|s-only|c-s)/,format:"floorctrl:%s"},{name:"bfcpConfId",reg:/^confid:(\d+)/,format:"confid:%s"},{name:"bfcpUserId",reg:/^userid:(\d+)/,format:"userid:%s"},{name:"bfcpFloorId",reg:/^floorid:(.+) (?:m-stream|mstrm):(.+)/,names:["id","mStream"],format:"floorid:%s mstrm:%s"},{push:"invalid",names:["value"]}]};Object.keys(i).forEach((function(e){i[e].forEach((function(e){e.reg||(e.reg=/(.*)/),e.format||(e.format="%s");}));}));})),qC=LC((e=>{var t=function(e){return String(Number(e))===e?Number(e):e},i=function(e,i,r){var n=e.name&&e.names;e.push&&!i[e.push]?i[e.push]=[]:n&&!i[e.name]&&(i[e.name]={});var o=e.push?{}:n?i[e.name]:i;((function(e,i,r,n){if(n&&!r)i[n]=t(e[1]);else for(var o=0;o<r.length;o+=1)null!=e[o+1]&&(i[r[o]]=t(e[o+1]));}))(r.match(e.reg),o,e.names,e.name),e.push&&i[e.push].push(o);},r=zC(),n=RegExp.prototype.test.bind(/^([a-z])=(.*)/);e.parse=function(e){var t={},o=[],s=t;return e.split(/(\r\n|\r|\n)/).filter(n).forEach((function(e){var t=e[0],n=e.slice(2);"m"===t&&(o.push({rtp:[],fmtp:[]}),s=o[o.length-1]);for(var a=0;a<(r[t]||[]).length;a+=1){var c=r[t][a];if(c.reg.test(n))return i(c,s,n)}})),t.media=o,t};var o=function(e,i){var r=i.split(/=(.+)/,2);return 2===r.length?e[r[0]]=t(r[1]):1===r.length&&i.length>1&&(e[r[0]]=void 0),e};e.parseParams=function(e){return e.split(/;\s?/).reduce(o,{})},e.parseFmtpConfig=e.parseParams,e.parsePayloads=function(e){return e.toString().split(" ").map(Number)},e.parseRemoteCandidates=function(e){for(var i=[],r=e.split(" ").map(t),n=0;n<r.length;n+=3)i.push({component:r[n],ip:r[n+1],port:r[n+2]});return i},e.parseImageAttributes=function(e){return e.split(" ").map((function(e){return e.substring(1,e.length-1).split(",").reduce(o,{})}))},e.parseSimulcastStreamList=function(e){return e.split(";").map((function(e){return e.split(",").map((function(e){var i,r=!1;return "~"!==e[0]?i=t(e):(i=t(e.substring(1,e.length)),r=!0),{scid:i,paused:r}}))}))};})),YC=LC(((e,t)=>{var i=zC(),r=/%[sdv%]/g,n=function(e){var t=1,i=arguments,n=i.length;return e.replace(r,(function(e){if(t>=n)return e;var r=i[t];switch(t+=1,e){case"%%":return "%";case"%s":return String(r);case"%d":return Number(r);case"%v":return ""}}))},o=function(e,t,i){var r=[e+"="+(t.format instanceof Function?t.format(t.push?i:i[t.name]):t.format)];if(t.names)for(var o=0;o<t.names.length;o+=1){var s=t.names[o];t.name?r.push(i[t.name][s]):r.push(i[t.names[o]]);}else r.push(i[t.name]);return n.apply(null,r)},s=["v","o","s","i","u","e","p","c","b","t","r","z","a"],a=["i","c","b","a"];t.exports=function(e,t){t=t||{},null==e.version&&(e.version=0),null==e.name&&(e.name=" "),e.media.forEach((function(e){null==e.payloads&&(e.payloads="");}));var r=t.outerOrder||s,n=t.innerOrder||a,c=[];return r.forEach((function(t){i[t].forEach((function(i){i.name in e&&null!=e[i.name]?c.push(o(t,i,e)):i.push in e&&null!=e[i.push]&&e[i.push].forEach((function(e){c.push(o(t,i,e));}));}));})),e.media.forEach((function(e){c.push(o("m",i.m[0],e)),n.forEach((function(t){i[t].forEach((function(i){i.name in e&&null!=e[i.name]?c.push(o(t,i,e)):i.push in e&&null!=e[i.push]&&e[i.push].forEach((function(e){c.push(o(t,i,e));}));}));}));})),c.join("\r\n")+"\r\n"};})),QC=LC((e=>{var t=qC(),i=YC();e.write=i,e.parse=t.parse,e.parseParams=t.parseParams,e.parseFmtpConfig=t.parseFmtpConfig,e.parsePayloads=t.parsePayloads,e.parseRemoteCandidates=t.parseRemoteCandidates,e.parseImageAttributes=t.parseImageAttributes,e.parseSimulcastStreamList=t.parseSimulcastStreamList;})),XC=VC(jC()),$C=((EC=$C||{})[EC.INVALID_PARAMETER=4096]="INVALID_PARAMETER",EC[EC.INVALID_OPERATION=4097]="INVALID_OPERATION",EC[EC.NOT_SUPPORTED=4098]="NOT_SUPPORTED",EC[EC.DEVICE_NOT_FOUND=4099]="DEVICE_NOT_FOUND",EC[EC.INITIALIZE_FAILED=4100]="INITIALIZE_FAILED",EC[EC.SIGNAL_CHANNEL_SETUP_FAILED=16385]="SIGNAL_CHANNEL_SETUP_FAILED",EC[EC.SIGNAL_CHANNEL_ERROR=16386]="SIGNAL_CHANNEL_ERROR",EC[EC.ICE_TRANSPORT_ERROR=16387]="ICE_TRANSPORT_ERROR",EC[EC.JOIN_ROOM_FAILED=16388]="JOIN_ROOM_FAILED",EC[EC.CREATE_OFFER_FAILED=16389]="CREATE_OFFER_FAILED",EC[EC.SIGNAL_CHANNEL_RECONNECTION_FAILED=16390]="SIGNAL_CHANNEL_RECONNECTION_FAILED",EC[EC.UPLINK_RECONNECTION_FAILED=16391]="UPLINK_RECONNECTION_FAILED",EC[EC.DOWNLINK_RECONNECTION_FAILED=16392]="DOWNLINK_RECONNECTION_FAILED",EC[EC.REMOTE_STREAM_NOT_EXIST=16400]="REMOTE_STREAM_NOT_EXIST",EC[EC.CLIENT_BANNED=16448]="CLIENT_BANNED",EC[EC.SERVER_TIMEOUT=16449]="SERVER_TIMEOUT",EC[EC.SUBSCRIPTION_TIMEOUT=16450]="SUBSCRIPTION_TIMEOUT",EC[EC.PLAY_NOT_ALLOWED=16451]="PLAY_NOT_ALLOWED",EC[EC.DEVICE_AUTO_RECOVER_FAILED=16452]="DEVICE_AUTO_RECOVER_FAILED",EC[EC.START_PUBLISH_CDN_FAILED=16453]="START_PUBLISH_CDN_FAILED",EC[EC.STOP_PUBLISH_CDN_FAILED=16454]="STOP_PUBLISH_CDN_FAILED",EC[EC.START_MIX_TRANSCODE_FAILED=16455]="START_MIX_TRANSCODE_FAILED",EC[EC.STOP_MIX_TRANSCODE_FAILED=16456]="STOP_MIX_TRANSCODE_FAILED",EC[EC.NOT_SUPPORTED_H264=16457]="NOT_SUPPORTED_H264",EC[EC.SWITCH_ROLE_FAILED=16458]="SWITCH_ROLE_FAILED",EC[EC.API_CALL_TIMEOUT=16459]="API_CALL_TIMEOUT",EC[EC.SCHEDULE_FAILED=16460]="SCHEDULE_FAILED",EC[EC.API_CALL_ABORTED=16461]="API_CALL_ABORTED",EC[EC.SPC_INITIALIZED_FAILED=16462]="SPC_INITIALIZED_FAILED",EC[EC.VIDEO_MANAGER_ERROR=16463]="VIDEO_MANAGER_ERROR",EC[EC.UNKNOWN=65535]="UNKNOWN",EC),ZC=$C,eb=class extends Error{constructor(e){let{name:t="RtcError",message:i,code:r=ZC.UNKNOWN,extraCode:n=0,constraint:o}=e,s="<".concat(function(e){for(let t in ZC)if(ZC[t]===e)return t;return "UNKNOWN"}(r)," 0x").concat(r.toString(16),">"),a="".concat(i).concat(o?" constraint: ".concat(o):"").concat(null!=i&&i.includes(s)?"":" ".concat(s));super(a),FC(this,"code"),FC(this,"extraCode"),FC(this,"message"),FC(this,"originMessage"),FC(this,"name"),FC(this,"constraint"),this.code=r,this.extraCode=n,this.name=t,this.message=a,this.constraint=o,this.originMessage=i;}getCode(){return this.code}getExtraCode(){return this.extraCode}toString(){return this.originMessage}},tb=eb,ib=((new Date).getTime(),0),rb=function(){return (new Date).getTime()+ib},nb=function(){let e=new Date;return e.setTime(rb()),e.toLocaleString()},ob={};xC(ob,{bytes2ms:()=>uw,convertObjectNumberToInt:()=>eO,copyProperties:()=>dw,deepClone:()=>Gw,deepMerge:()=>Ww,delay:()=>tO,fibonacci:()=>Tw,formatedTime:()=>zw,getAbilityConfigUrl:()=>$N,getConstructorName:()=>Ow,getContainerFromElement:()=>Kw,getEnv:()=>iw,getInternalVersion:()=>Vw,getLoggerUrl:()=>nw,getMuteStateFromFlag:()=>Bw,getNetworkType:()=>sw,getNumNetworkType:()=>lw,getReconnectionTimeout:()=>Ew,getStringByteLength:()=>Qw,getTurnServer:()=>Hw,getUint32Version:()=>Zw,getValueType:()=>vw,getViewListFromView:()=>Jw,glog:()=>_w,ipv4ToUint32:()=>jw,isArray:()=>bw,isAudioWorkletSupported:()=>Pw,isBoolean:()=>Aw,isConstructor:()=>ww,isEmpty:()=>Fw,isFunction:()=>yw,isLangChinese:()=>fw,isMediaStreamTrack:()=>kw,isNumber:()=>Rw,isObject:()=>Cw,isOverseaSdkAppId:()=>rw,isPlainObject:()=>gw,isPortrait:()=>Xw,isPromise:()=>Nw,isRemoteTrack:()=>Dw,isString:()=>Iw,isUndefined:()=>Sw,loadImage:()=>$w,ms2bytes:()=>pw,ms2samples:()=>mw,performanceNow:()=>Lw,promiseAny:()=>Mw,samples2ms:()=>hw,setNetworkType:()=>cw,stringify:()=>qw,stringifyIncludeValue:()=>Yw,throttlePromise:()=>iO});var sb={};xC(sb,{AUDIO_MUTE_BIT:()=>Kb,AUDIO_STAT_BIT:()=>Jb,AUX_STAT_BIT:()=>Gb,AUX_STREAM_MSID:()=>Xb,BACKEND_ENV:()=>Bb,BASE_DOC_URL:()=>Sb,BASE_HOST:()=>Tb,CAPABILITIES_KEYS:()=>jk,CLASS_NAME:()=>Dk,CLOUD_CONSOLE_URL:()=>yb,CROSS_ROOM_BIT:()=>Yb,DATA_FREEZE_TIMING:()=>Sk,DOC_URL:()=>Ib,DTLS_STATE_UNKNOWN:()=>ak,ENV_NAME:()=>kb,EXCHANGE_SDP_TIMEOUT:()=>gk,INTERVAL:()=>Bk,IS_WORKER:()=>pb,IS_WORKLET:()=>mb,KIBANA_EVENT:()=>mk,LOCAL_STREAM_PUBLISH_STATE:()=>yk,LOGGER_CMD_TYPE:()=>bb,LOGGER_DOMAIN:()=>Rb,LOGGER_DOMAIN_OVERSEA:()=>Ab,LOG_LEVEL:()=>Db,LOG_LEVEL_NAME:()=>Mk,MAIN_STREAM_MSID:()=>Qb,MAX_RTT:()=>Wk,MICROPHONE_COMMUNICATIONS:()=>Pk,MICROPHONE_DEFAULT:()=>wk,MUTE_ALL_BIT:()=>qb,NAME:()=>Ub,NETWORK_TYPE:()=>Ob,NOT_SUPPORTED_H264:()=>vk,PAUSED_RETRY_COUNT:()=>Nk,PEERCONNECTION_CONNECTING_TIMEOUT:()=>Ck,PEER_CONNECTION_STATE:()=>ck,PEER_LEAVE_REASON:()=>Lk,RAF:()=>Fk,RECOVER_CAPTURE_INTERVAL:()=>Vk,REMOTE_STREAM_TYPE_AUX:()=>Zb,REMOTE_STREAM_TYPE_MAIN:()=>$b,RENDER_FREEZE_TIMING:()=>Ik,RIC:()=>Uk,SCHEDULE_DOMAIN:()=>bk,SCHEDULE_TIMEOUT:()=>kk,SDP_SEMANTICS_PLAN_B:()=>Ek,SDP_SEMANTICS_UNIFIED_PLAN:()=>Tk,SECOND_HOST:()=>Eb,SIGNAL_PING_PONG_INTERVAL:()=>wb,SIGNAL_PING_TIMEOUT:()=>Nb,SIGNAL_RECONNECTION_COUNT:()=>pk,SMALL_STAT_BIT:()=>Wb,SPEAKER_DEFAULT:()=>Ok,STORAGE_EXPIRES_TIME:()=>Pb,STREAM_TYPE_BIG:()=>Rk,STREAM_TYPE_SMALL:()=>Ak,SUBSCRIBE_SMALL_RETRY_COUNT:()=>xk,SYNC_USER_LIST_INTERVAL:()=>_k,Scene:()=>Hb,Switch:()=>Mb,THIRD_HOST:()=>vb,TIMEOUT:()=>Hk,TRANSPORT_DIRECTION:()=>Fb,TRTC_ERROR_ASSISTANCE:()=>Cb,TRTC_QUALITY_BAD:()=>nk,TRTC_QUALITY_DISCONNECTED:()=>sk,TRTC_QUALITY_EXCELLENT:()=>tk,TRTC_QUALITY_GOOD:()=>ik,TRTC_QUALITY_POOR:()=>rk,TRTC_QUALITY_UNKNOWN:()=>ek,TRTC_QUALITY_VERY_BAD:()=>ok,UPDATE_OFFER_TIMEOUT:()=>fk,VIDEO_MUTE_BIT:()=>zb,VIDEO_STAT_BIT:()=>jb,audioProfileMap:()=>Lb,getRetryCount:()=>uk,getScriptDir:()=>_b,innerVersion:()=>ab,loggerProxy:()=>fb,screenProfileMap:()=>Vb,setLoggerProxy:()=>gb,setRetryCount:()=>dk,setVersion:()=>lb,version:()=>cb,videoProfileMap:()=>xb});var ab="4.15.00.1600",cb="5.0.0";function lb(e){cb=e;let[t,i,r]=e.split(".").map((e=>parseInt(e,10)));ab="".concat(t,".").concat(Math.min(15,i),".").concat(Math.min(15,r),".").concat(i.toString().padStart(2,"0")).concat(r.toString().padStart(2,"0"));}var db,ub,hb,pb="undefined"!=typeof importScripts,mb="undefined"!=typeof registerProcessor,_b=()=>{let e=pb?self.location.href:document.currentScript.src;return e.substring(0,e.lastIndexOf("/")+1)},fb="",gb=e=>fb=e,Tb="web.sdk.qcloud.com",Eb="web.sdk.tencent.cn",vb="web.sdk.cloud.tencent.cn",yb="https://console.cloud.tencent.com/trtc",Sb="https://".concat(Tb,"/trtc/webrtc/v5/doc"),Ib="".concat(Sb,"/zh-cn/"),Rb="https://yun.tim.qq.com",Ab="https://apisgp.my-imcloud.com",Cb="trtc_error_assistance",bb={LOG:"jssdk_log",EVENT:"jssdk_event",KEY_POINT:"jssdk_new_endreport",KV_STAT:"jssdk_key_metrics_report"},kb={QCLOUD:"qcloud",OLD_CLOUD_LADDER:"trtc",WEBRTC:"webrtc"},Db=((hb=Db||{})[hb.TRACE=0]="TRACE",hb[hb.DEBUG=1]="DEBUG",hb[hb.INFO=2]="INFO",hb[hb.WARN=3]="WARN",hb[hb.ERROR=4]="ERROR",hb[hb.NONE=5]="NONE",hb),Nb=18e3,wb=2e3,Ob={unknown:0,wifi:1,"3g":2,"2g":3,"4g":4,wired:5,"5g":6},Pb=6048e5,Mb=((ub=Mb||{}).USEAINS="useAINS",ub.ENABLEDEBUG="enableDebug",ub.USEV2="useV2",ub.USEWT="useWt",ub),Lb={standard:{sampleRate:48e3,channelCount:1,bitrate:40},"standard-stereo":{sampleRate:48e3,channelCount:2,bitrate:64},high:{sampleRate:48e3,channelCount:1,bitrate:128},"high-stereo":{sampleRate:48e3,channelCount:2,bitrate:192}},xb={"120p":{width:160,height:120,frameRate:15,bitrate:200},"120p_2":{width:160,height:120,frameRate:15,bitrate:100},"180p":{width:320,height:180,frameRate:15,bitrate:350},"180p_2":{width:320,height:180,frameRate:15,bitrate:150},"240p":{width:320,height:240,frameRate:15,bitrate:400},"240p_2":{width:320,height:240,frameRate:15,bitrate:200},"360p":{width:640,height:360,frameRate:15,bitrate:800},"360p_2":{width:640,height:360,frameRate:15,bitrate:400},"480p":{width:640,height:480,frameRate:15,bitrate:900},"480p_2":{width:640,height:480,frameRate:15,bitrate:500},"720p":{width:1280,height:720,frameRate:15,bitrate:1500},"1080p":{width:1920,height:1080,frameRate:15,bitrate:2e3},"1440p":{width:2560,height:1440,frameRate:30,bitrate:4860},"4K":{width:3840,height:2160,frameRate:30,bitrate:9e3}},Vb={"480p":{width:640,height:480,frameRate:5,bitrate:900},"480p_2":{width:640,height:480,frameRate:30,bitrate:1e3},"720p":{width:1280,height:720,frameRate:5,bitrate:1200},"720p_2":{width:1280,height:720,frameRate:30,bitrate:3e3},"1080p":{width:1920,height:1080,frameRate:5,bitrate:1600},"1080p_2":{width:1920,height:1080,frameRate:30,bitrate:4e3}},Ub={CANVAS:"canvas",AUDIO:"audio",VIDEO:"video",SCREEN:"screen",SMALL:"small",BIG:"big",AUXILIARY:"auxiliary",SMALL_VIDEO:"smallVideo",FACING_MODE_USER:"user",FACING_MODE_ENVIRONMENT:"environment",MUTE:"mute",UNMUTE:"unmute",ENDED:"ended",PLAYING:"playing",PAUSE:"pause",ERROR:"error",LOADEDDATA:"loadeddata",AUDIO_INPUT:"audioinput",VIDEO_INPUT:"videoinput",DETAIL:"detail",TEXT:"text",MAIN:"main",BACKUP:"backup",BANNED:"banned",KICK:"kick",USER_TIME_OUT:"user_time_out",ROOM_DISBAND:"room_disband",SEI_MESSAGE:"sei-message",ADD:"add",REMOVE:"remove",REPLACE:"replace",TRACK:"track",SUBSCRIBE:"subscribe",UNSUBSCRIBE:"unsubscribe",TRANSCEIVER_DIRECTION_SENDONLY:"sendonly",TRANSCEIVER_DIRECTION_RECVONLY:"recvonly",ENTER_PICTURE_IN_PICTURE:"enterpictureinpicture",LEAVE_PICTURE_IN_PICTURE:"leavepictureinpicture"},Fb={INACTIVE:"inactive",SENDONLY:"sendonly",RECVONLY:"recvonly"},Bb={OLD_CLOUD_LADDER:"wss://trtc.rtc.qq.com",WEBRTC:"wss://webrtc.qq.com"},Hb=((db=Hb||{}).LIVE="live",db.RTC="rtc",db),jb=1,Wb=2,Gb=4,Jb=8,Kb=64,zb=16,qb=112,Yb=128,Qb="5Y2wZK8nANNAoVw6dSAHVjNxrD1ObBM2kBPV",Xb="224d130c-7b5c-415b-aaa2-79c2eb5a6df2",$b=Ub.MAIN,Zb=Ub.AUXILIARY,ek=0,tk=1,ik=2,rk=3,nk=4,ok=5,sk=6,ak="unknown",ck={NEW:"new",CONNECTING:"connecting",FAILED:"failed",CLOSED:"closed",DISCONNECTED:"disconnected",CONNECTED:"connected",COMPLETED:"completed"},lk=1/0;function dk(e){lk=e;}function uk(){return lk}var hk,pk=30,mk={JOIN:"join",DELTA_JOIN:"delta-join",REJOIN:"rejoin",LEAVE:"leave",DELTA_LEAVE:"delta-leave",PUBLISH:"publish",DELTA_PUBLISH:"delta-publish",UNPUBLISH:"unpublish",SUBSCRIBE:"subscribe",UNSUBSCRIBE:"unsubscribe",UPLINK_CONNECTION:"uplink-connection",UPLINK_RECONNECTION:"uplink-reconnection",DOWNLINK_CONNECTION:"downlink-connection",DOWNLINK_RECONNECTION:"downlink-reconnection",ON_TRACK:"ontrack",ICE_CONNECTION_STATE:"iceConnectionState",LOCAL_STREAM_INITIALIZE:"stream-initialize",SIGNAL_CONNECTION:"websocketConnectionState",SIGNAL_RECONNECTION:"websocketReconnectionState",UPDATE_STREAM:"update-stream",RECOVER_LOCAL_AUDIO_TRACK:"recover-local-audio-track",RECOVER_LOCAL_VIDEO_TRACK:"recover-local-video-track",RECOVER_SUBSCRIPTION:"recover-subscription",START_MIX_TRANSCODE:"start-mix-transcode",STOP_MIX_TRANSCODE:"stop-mix-transcode",PLAYER_ERROR:"player-error",SCHEDULE:"schedule",LOAD_WORKLET:"load-worklet",VIDEO_FROZEN_COUNT:"videoFrozenCount",GET_USER_MEDIA_RETRY:"getUserMedia-retry"},_k=1e4,fk=1e4,gk=1e4,Tk="unified-plan",Ek="plan-b",vk=1028,yk=((hk=yk||{})[hk.UNPUBLISH=-1]="UNPUBLISH",hk[hk.PUBLISHING=0]="PUBLISHING",hk[hk.PUBLISHED=1]="PUBLISHED",hk),Sk=500,Ik=1e3,Rk=Ub.BIG,Ak=Ub.SMALL,Ck=1e4,bk={MAIN:"schedule.cloud-rtc.com",BACKUP:"schedule.cloud-rtc.net",MAIN_OVERSEA:"schedule.rtc-web.com",BACKUP_OVERSEA:"schedule.rtc-web.io",MAIN_OVERSEA_OLD:"schedule.rtc.tencentcloud.com",BACKUP_OVERSEA_OLD:"schedule-ecdn.rtc.tencentcloud.com"},kk=2e3,Dk={TRTC:"TRTC",CLIENT:"Client",LOCAL_STREAM:"LocalStream",REMOTE_STREAM:"RemoteStream",STREAM:"Stream"},Nk=5,wk="default",Ok=wk,Pk="communications",Mk=Object.keys(Db),Lk=["normal leave","timeout leave","kick","role change"],xk=10,Vk=2e3,Uk="ric",Fk="raf",Bk="interval",Hk="timeout",jk=["width","height","frameRate","facingMode","sampleRate","sampleSize","channelCount","deviceId","min","max"],Wk=1e4;function Gk(e){let{url:t,body:i,method:r,timeout:n}=e,o=new XMLHttpRequest;return new Promise(((e,s)=>{o.onreadystatechange=()=>{if(4===o.readyState)if(o.status>=200&&o.status<300)try{let t=JSON.parse(o.response);e({data:t});}catch(t){e({data:o.response});}else s({status:o.status,statusText:o.statusText||"request failed!"});},o.timeout=n||5e3,o.open(r||"POST",t,!0),o.send(i);}))}function Jk(e){return HC(this,null,(function*(){let t=Lw(),i=JSON.stringify(e);try{if(!CompressionStream||i.length<=2800)return i;let e=new Blob([i],{type:"application/json"}).stream().pipeThrough(new CompressionStream("gzip")),r=yield (yield (yield new Response(e)).blob()).arrayBuffer();return sO.debug("compressJSON ".concat(i.length," -> ").concat(r.byteLength," ").concat(Lw()-t,"ms")),r}catch(hk){return i}}))}var Kk=1e8,zk={AVOID_REPEATED_CALL:"AVOID_REPEATED_CALL",INVALID_PARAMETER_REQUIRED:"INVALID_PARAMETER_REQUIRED",INVALID_PARAMETER_TYPE:"INVALID_PARAMETER_TYPE",INVALID_PARAMETER_EMPTY:"INVALID_PARAMETER_EMPTY",INVALID_PARAMETER_INSTANCE:"INVALID_PARAMETER_INSTANCE",INVALID_PARAMETER_RANGE:"INVALID_PARAMETER_RANGE",INVALID_PARAMETER_MIN:"INVALID_PARAMETER_MIN",INVALID_PARAMETER_MAX:"INVALID_PARAMETER_MAX",INVALID_PARAMETER_STREAMTYPE:"INVALID_PARAMETER_STREAMTYPE",API_CALL_TIMEOUT:"API_CALL_TIMEOUT",SIGNAL_CHANNEL_RECONNECTION_FAILED:"SIGNAL_CHANNEL_RECONNECTION_FAILED",SIGNAL_CHANNEL_SETUP_FAILED:"SIGNAL_CHANNEL_SETUP_FAILED",ERROR_MESSAGE:"ERROR_MESSAGE",EXCHANGE_SDP_TIMEOUT:"EXCHANGE_SDP_TIMEOUT",DOWNLINK_RECONNECTION_FAILED:"DOWNLINK_RECONNECTION_FAILED",EXCHANGE_SDP_FAILED:"EXCHANGE_SDP_FAILED",UPDATE_OFFER_TIMEOUT:"UPDATE_OFFER_TIMEOUT",UPLINK_RECONNECTION_FAILED:"UPLINK_RECONNECTION_FAILED",INVALID_RECORDID:"INVALID_RECORDID",INVALID_PURE_AUDIO:"INVALID_PURE_AUDIO",INVALID_STREAMID:"INVALID_STREAMID",INVALID_USER_DEFINE_RECORDID:"INVALID_USER_DEFINE_RECORDID",INVALID_USER_DEFINE_PUSH_ARGS:"INVALID_USER_DEFINE_PUSH_ARGS",INVALID_PROXY:"INVALID_PROXY",INVALID_JOIN:"INVALID_JOIN",INVALID_ROOMID_STRING:"INVALID_ROOMID_STRING",INVALID_ROOMID_INTEGER:"INVALID_ROOMID_INTEGER",INVALID_SIGNAL_CHANNEL:"INVALID_SIGNAL_CHANNEL",JOIN_ROOM_TIMEOUT:"JOIN_ROOM_TIMEOUT",JOIN_ROOM_FAILED:"JOIN_ROOM_FAILED",REJOIN_ROOM_FAILED:"REJOIN_ROOM_FAILED",INVALID_DESTROY:"INVALID_DESTROY",INVALID_PUBLISH:"INVALID_PUBLISH",INVALID_UNPUBLISH:"INVALID_UNPUBLISH",INVALID_AUDIENCE:"INVALID_AUDIENCE",INVALID_INITIALIZE:"INVALID_INITIALIZE",INVALID_DUPLICATE_PUBLISHING:"INVALID_DUPLICATE_PUBLISHING",INVALID_SUBSCRIBE_UNDEFINED:"INVALID_SUBSCRIBE_UNDEFINED",INVALID_SUBSCRIBE_LOCAL:"INVALID_SUBSCRIBE_LOCAL",INVALID_REMOTE_STREAM:"INVALID_REMOTE_STREAM",SUBSCRIBE_FAILED:"SUBSCRIBE_FAILED",INVALID_ROLE:"INVALID_ROLE",INVALID_PARAMETER_SWITCH_ROLE:"INVALID_PARAMETER_SWITCH_ROLE",INVALID_OPERATION_SWITCH_ROLE:"INVALID_OPERATION_SWITCH_ROLE",SWITCH_ROLE_TIMEOUT:"SWITCH_ROLE_TIMEOUT",SWITCH_ROLE_FAILED:"SWITCH_ROLE_FAILED",CLIENT_BANNED:"CLIENT_BANNED",INVALID_OPERATION_START_PUBLISH_CDN:"INVALID_OPERATION_START_PUBLISH_CDN",INVALID_OPERATION_STOP_PUBLISH_CDN:"INVALID_OPERATION_STOP_PUBLISH_CDN",INVALID_STREAM_ID:"INVALID_STREAM_ID",START_PUBLISH_CDN_FAILED:"START_PUBLISH_CDN_FAILED",STOP_PUBLISH_CDN_FAILED:"STOP_PUBLISH_CDN_FAILED",START_MIX_TRANSCODE:"START_MIX_TRANSCODE",STOP_MIX_TRANSCODE:"STOP_MIX_TRANSCODE",INVALID_AUDIO_VOLUME:"INVALID_AUDIO_VOLUME",ENABLE_SMALL_STREAM_PUBLISHED:"ENABLE_SMALL_STREAM_PUBLISHED",DISABLE_SMALL_STREAM_PUBLISHED:"DISABLE_SMALL_STREAM_PUBLISHED",NOT_SUPPORTED_SMALL_STREAM:"NOT_SUPPORTED_SMALL_STREAM",INVALID_SMALL_STREAM_PROFILE:"INVALID_SMALL_STREAM_PROFILE",INVALID_PARAMETER_REMOTE_STREAM:"INVALID_PARAMETER_REMOTE_STREAM",INVALID_OPERATION_CHANGE_SMALL:"INVALID_OPERATION_CHANGE_SMALL",REMOTE_NOT_PUBLISH_SMALL_STREAM:"REMOTE_NOT_PUBLISH_SMALL_STREAM",INVALID_SWITCH_DEVICE:"INVALID_SWITCH_DEVICE",INVALID_SWITCH_DEVICE_PUBLISHING:"INVALID_SWITCH_DEVICE_PUBLISHING",INVALID_REPLACE_TRACK:"INVALID_REPLACE_TRACK",INVALID_INITIALIZE_LOCAL_STREAM:"INVALID_INITIALIZE_LOCAL_STREAM",INVALID_ADD_TRACK_REPETITIVE:"INVALID_ADD_TRACK_REPETITIVE",INVALID_ADD_TRACK_REMOVING:"INVALID_ADD_TRACK_REMOVING",INVALID_ADD_TRACK_PUBLISHING:"INVALID_ADD_TRACK_PUBLISHING",INVALID_STREAM_INITIALIZED:"INVALID_STREAM_INITIALIZED",INVALID_ADD_TRACK_NUMBER:"INVALID_ADD_TRACK_NUMBER",INVALID_REMOVE_AUDIO_TRACK:"INVALID_REMOVE_AUDIO_TRACK",INVALID_REMOVE_AUDIO_ADDING:"INVALID_REMOVE_AUDIO_ADDING",INVALID_REMOVE_AUDIO_ON:"INVALID_REMOVE_AUDIO_ON",INVALID_REMOVE_TRACK_PUBLISHING:"INVALID_REMOVE_TRACK_PUBLISHING",INVALID_REMOVE_TRACK_NOT_TRACK:"INVALID_REMOVE_TRACK_NOT_TRACK",INVALID_REMOVE_TRACK_NUMBER:"INVALID_REMOVE_TRACK_NUMBER",INVALID_REPLACE_TRACK_NO_TRACK:"INVALID_REPLACE_TRACK_NO_TRACK",REPEAT_JOIN:"REPEAT_JOIN",CLIENT_DESTROYED:"CLIENT_DESTROYED",NOT_BUG_PACKAGE:"NOT_BUG_PACKAGE",START_MIX_TRANSCODE_FAILED:"START_MIX_TRANSCODE_FAILED",STOP_MIX_TRANSCODE_FAILED:"STOP_MIX_TRANSCODE_FAILED",MIX_TRANSCODE_NOT_STARTED:"MIX_TRANSCODE_NOT_STARTED",CANNOT_LESS_THAN_ZERO:"CANNOT_LESS_THAN_ZERO",MIX_PARAMS_VIDEO_FRAMERATE:"MIX_PARAMS_VIDEO_FRAMERATE",MIX_PARAMS_VIDEO_GOP:"MIX_PARAMS_VIDEO_GOP",MIX_PARAMS_AUDIO_BITRATE:"MIX_PARAMS_AUDIO_BITRATE",MIX_PARAMS_USER_Z_ORDER:"MIX_PARAMS_USER_Z_ORDER",MIX_PARAMS_NOT_SELF:"MIX_PARAMS_NOT_SELF",MIX_PARAMS_USER_STREAM:"MIX_PARAMS_USER_STREAM",INVALID_PLAY:"INVALID_PLAY",INVALID_ELEMENT_ID:"INVALID_ELEMENT_ID",INVALID_ELEMENT_ID_TYPE:"INVALID_ELEMENT_ID_TYPE",PLAY_FAILED:"PLAY_FAILED",INVALID_USERID:"INVALID_USERID",INVALID_CREATE_STREAM_SOURCE:"INVALID_CREATE_STREAM_SOURCE",INVALID_CREATE_STREAM_SCREEN:"INVALID_CREATE_STREAM_SCREEN",INVALID_CREATE_STREAM_AUDIO:"INVALID_CREATE_STREAM_AUDIO",INVALID_CREATE_STREAM_SCREEN_AUDIO:"INVALID_CREATE_STREAM_SCREEN_AUDIO",NOT_SUPPORTED_HTTP:"NOT_SUPPORTED_HTTP",NOT_SUPPORTED_WEBRTC:"NOT_SUPPORTED_WEBRTC",NOT_SUPPORTED_PROFILE:"NOT_SUPPORTED_PROFILE",NOT_SUPPORTED_MEDIA:"NOT_SUPPORTED_MEDIA",NOT_SUPPORTED_H264ENCODE:"NOT_SUPPORTED_H264ENCODE",NOT_SUPPORTED_H264DECODE:"NOT_SUPPORTED_H264DECODE",NOT_SUPPORTED_TRACK:"NOT_SUPPORTED_TRACK",NOT_SUPPORTED_SWITCH_DEVICE:"NOT_SUPPORTED_SWITCH_DEVICE",NOT_SUPPORTED_CAPTURE:"NOT_SUPPORTED_CAPTURE",NOT_SUPPORTED_AUX:"NOT_SUPPORTED_AUX",MICROPHONE_NOT_FOUND:"MICROPHONE_NOT_FOUND",CAMERA_NOT_FOUND:"CAMERA_NOT_FOUND",SIGNAL_RESPONSE_FAILED:"SIGNAL_RESPONSE_FAILED",CATCH_HANDLER_ERROR:"CATCH_HANDLER_ERROR",API_NOT_EXIST:"API_NOT_EXIST",CONNECTION_CLOSED:"CONNECTION_CLOSED",SUBSCRIBE_ALL_FALSE:"SUBSCRIBE_ALL_FALSE",SEI_NOT_SUPPORT:"SEI_NOT_SUPPORT",SEI_DISABLED:"SEI_DISABLED",SEI_BEFORE_PUBLISH:"SEI_BEFORE_PUBLISH",SEI_NOT_VIDEO:"SEI_NOT_VIDEO",CALL_FREQUENCY_LIMIT:"CALL_FREQUENCY_LIMIT",CONNECTION_ABORTED:"CONNECTION_ABORTED",API_CALL_ABORTED:"API_CALL_ABORTED",DUPLICATE_AUX:"DUPLICATE_AUX"},qk={AVOID_REPEATED_CALL:e=>"previous ".concat(e.name,"() is ongoing, please avoid repeated calls."),INVALID_PARAMETER_REQUIRED(e){let{key:t,rule:i,fnName:r,value:n}=e;return "'".concat(t||i.name,"' is a required param when calling ").concat(r,"(), received: ").concat(n,".")},INVALID_PARAMETER_TYPE(e){let{key:t,rule:i,fnName:r,value:n}=e,o="".concat(t||i.name),s="";return s=Array.isArray(i.type)?i.type.join("|"):i.type,"'".concat(o,"' must be type of ").concat(s," when calling ").concat(r,"(), received type: ").concat(vw(n),".")},INVALID_PARAMETER_EMPTY(e){let{key:t,rule:i,fnName:r,value:n}=e;return "'".concat(t||i.name,"' cannot be '").concat(n,"' when calling ").concat(r,"().")},INVALID_PARAMETER_INSTANCE(e){let{key:t,rule:i,fnName:r,value:n}=e,o="".concat(t||i.name),s="".concat(i.instanceOf.name||i.instanceOf);return "'".concat(o,"' must be instanceof ").concat(s," when calling ").concat(r,"(), received type: ").concat(vw(n),".")},INVALID_PARAMETER_RANGE(e){let{key:t,rule:i,fnName:r,value:n}=e;return "'".concat(t||i.name,"' must be one of ").concat(i.values.join("|")," when calling ").concat(r,"(), received: ").concat(n,".")},INVALID_PARAMETER_MIN(e){let{key:t,rule:i,fnName:r,value:n}=e;return "the min value of ".concat(t||i.name," is ").concat(i.min,", received: ").concat(n,".")},INVALID_PARAMETER_MAX(e){let{key:t,rule:i,fnName:r,value:n}=e;return "the max value of ".concat(t||i.name," is ").concat(i.max,", received: ").concat(n,".")},API_CALL_TIMEOUT:e=>"".concat(e.commandDesc||e.command," timeout observed."),SIGNAL_CHANNEL_RECONNECTION_FAILED:"signal channel reconnection failed, please check your network.",SIGNAL_CHANNEL_SETUP_FAILED:e=>"SignalChannel setup failure: (errorCode: ".concat(e.errorCode,", errorMsg: ").concat(e.errorMsg," })."),ERROR_MESSAGE(e){let t="".concat(e.type," failed");return e.message&&(t="".concat(t,": ").concat(e.message,".")),t},EXCHANGE_SDP_TIMEOUT:"exchange sdp timeout.",DOWNLINK_RECONNECTION_FAILED:"downlink reconnection failed, please check your network and re-join room.",EXCHANGE_SDP_FAILED:e=>"exchange sdp failed ".concat(e.errMsg,"."),UPDATE_OFFER_TIMEOUT:"update offer timeout observed.",UPLINK_RECONNECTION_FAILED:"uplink reconnection failed, please check your network and publish again.",INVALID_RECORDID:"recordId must be an integer number.",INVALID_PURE_AUDIO:"pureAudioPushMode must be 1 or 2.",INVALID_STREAMID:"streamId must be a sting literal within 64 bytes, and not be empty.",INVALID_USER_DEFINE_RECORDID:"userDefineRecordId must be a sting literal contains (a-zA-Z),(0-9), underline and hyphen, within 64 bytes, and not be empty.",INVALID_USER_DEFINE_PUSH_ARGS:"userDefinePushArgs must be a sting literal within 256 bytes, and not be empty.",INVALID_PROXY:'proxy server url must start with "wss://".',INVALID_JOIN:"duplicate join() called.",INVALID_ROOMID_STRING:e=>"'".concat(e,"' must be validate string when useStringRoomId is true."),INVALID_ROOMID_INTEGER:e=>"'".concat(e,"' must be an integer between [1, 4294967294] when useStringRoomId is false."),INVALID_SIGNAL_CHANNEL:"SignalChannel is not ready yet.",JOIN_ROOM_TIMEOUT:"join room timeout.",JOIN_ROOM_FAILED(e){let{error:t,code:i}=e;return "Failed to join room - ".concat(t," code: ").concat(i)},REJOIN_ROOM_FAILED:e=>"reJoin room: ".concat(e.roomId," failed, please check your network."),INVALID_DESTROY:"please call leave() before destroy().",INVALID_PUBLISH:"please call join() before publish().",INVALID_UNPUBLISH:"stream has not been published yet.",INVALID_AUDIENCE:"no permission to publish() under live/".concat("audience",', please call switchRole("',"anchor",'") firstly before publish().'),INVALID_INITIALIZE:"cannot publish stream because stream is not initialized, is switching device, or has been closed.",INVALID_DUPLICATE_PUBLISHING:e=>"duplicate ".concat(e," stream publishing, please unpublish your prev ").concat(e," stream and then re-publish."),INVALID_SUBSCRIBE_UNDEFINED:"stream is undefined or null.",INVALID_SUBSCRIBE_LOCAL:"stream cannot be LocalStream.",INVALID_REMOTE_STREAM:"remoteStream does not exist because it has been unpublished by remote peer.",SUBSCRIBE_FAILED(e){let{message:t,userId:i,streamType:r}=e;return "failed to subscribe ".concat(i," ").concat(r," stream, reason: ").concat(t,".")},INVALID_ROLE:"switchRole can only be called in live mode.",INVALID_PARAMETER_SWITCH_ROLE:"role could only be set to a value as ".concat("anchor"," or ","audience","."),INVALID_OPERATION_SWITCH_ROLE:"please call join() before switchRole().",SWITCH_ROLE_TIMEOUT:"switchRole timeout.",SWITCH_ROLE_FAILED:e=>"switchRole failed, errCode: ".concat(e.code," errMsg: ").concat(e.message,"."),CLIENT_BANNED:e=>"client was banned because of ".concat(e.message,"."),INVALID_OPERATION_START_PUBLISH_CDN:"please call startPublishCDNStream() after join room and publish the local stream.",INVALID_OPERATION_STOP_PUBLISH_CDN:"please call startPublishCDNStream() before stopPublishCDNStream().",START_PUBLISH_CDN_FAILED:e=>"startPublishCDNStream failed, errMsg: ".concat(e.message,"."),STOP_PUBLISH_CDN_FAILED:e=>"stopPublishCDNStream failed, errMsg: ".concat(e.message,"."),INVALID_STREAM_ID:e=>"'".concat(e,"' can only consist of uppercase and lowercase english letters (a-zA-Z), numbers (0-9), hyphens and underscores."),START_MIX_TRANSCODE:"please call startMixTranscode() after join().",STOP_MIX_TRANSCODE:"please call stopMixTranscode() after startMixTranscode().",INVALID_AUDIO_VOLUME:"interval must be a number.",ENABLE_SMALL_STREAM_PUBLISHED:"Cannot enable small stream after localStream published.",DISABLE_SMALL_STREAM_PUBLISHED:"Cannot disable small stream after localStream published.",NOT_SUPPORTED_SMALL_STREAM:"your browser does not support opening small stream.",INVALID_SMALL_STREAM_PROFILE:"small stream profile is invalid.",INVALID_PARAMETER_REMOTE_STREAM:"remoteStream is invalid.",INVALID_OPERATION_CHANGE_SMALL:"cannot switch to the small stream without subscribing to the video of remoteStream.",REMOTE_NOT_PUBLISH_SMALL_STREAM:"remote peer does not publish small stream.",INVALID_SWITCH_DEVICE:"cannot switch device on current stream.",INVALID_SWITCH_DEVICE_PUBLISHING:"cannot switch device when publishing localStream.",INVALID_REPLACE_TRACK:"cannot replace track when publishing localStream.",INVALID_INITIALIZE_LOCAL_STREAM:"local stream has not initialized yet.",INVALID_ADD_TRACK_REPETITIVE:"previous addTrack is ongoing, please avoid repetitive execution.",INVALID_ADD_TRACK_REMOVING:"cannot add track when a track is removing.",INVALID_ADD_TRACK_PUBLISHING:"cannot add track when publishing localStream.",INVALID_STREAM_INITIALIZED:"your local stream haven't been initialized yet.",INVALID_ADD_TRACK_NUMBER:"a Stream has at most one audio track and one video track.",INVALID_REMOVE_AUDIO_TRACK:"remove audio track is not supported on your browser.",INVALID_REMOVE_AUDIO_ADDING:"cannot remove track when a track is adding.",INVALID_REMOVE_AUDIO_ON:"previous removeTrack is ongoing, please avoid repetitive execution.",INVALID_REMOVE_TRACK_PUBLISHING:"cannot remove track when publishing localStream.",INVALID_REMOVE_TRACK_NOT_TRACK:"localStream has not this track.",INVALID_REMOVE_TRACK_NUMBER:"remove the only video track is not supported, please use replaceTrack or muteVideo.",INVALID_REPLACE_TRACK_NO_TRACK:e=>"cannot replace ".concat(e.kind," track because stream has not ").concat(e.kind," track"),NOT_BUG_PACKAGE:"You need to buy packages, refer to tencent console.",START_MIX_TRANSCODE_FAILED:e=>"startMixTranscode failed, errMsg: ".concat(e.message,"."),STOP_MIX_TRANSCODE_FAILED:e=>"stopMixTranscode failed, errMsg: ".concat(e.message,"."),MIX_TRANSCODE_NOT_STARTED:"mixTranscode has not been started.",CANNOT_LESS_THAN_ZERO(e){let{key:t,rule:i,fnName:r,value:n}=e;return "'".concat(t||i.name,"' cannot be less than 0 when calling ").concat(r,"().")},MIX_PARAMS_VIDEO_FRAMERATE:"'config.videoFramerate' should be an integer between 0 and 30, excluding 0.",MIX_PARAMS_VIDEO_GOP:"'config.videoGOP' should be an integer between 1 and 8.",MIX_PARAMS_AUDIO_BITRATE:"'config.audioBitrate' should be an integer between 32 and 192.",MIX_PARAMS_USER_Z_ORDER:e=>"'".concat(e,"' is required and must be between 1 and 15."),MIX_PARAMS_NOT_SELF:"'config.mixUsers' must contain self.",MIX_PARAMS_USER_STREAM:"'config.videoWidth' and 'config.videoHeight' of output stream should be contain all mix stream.",INVALID_PLAY:"duplicate play() call observed, please stop() firstly.",INVALID_ELEMENT_ID:e=>{let{key:t,fnName:i}=e;return "'".concat(t,"' is not found in the document object when calling ").concat(i,"().")},INVALID_ELEMENT_ID_TYPE:e=>{let{key:t,fnName:i,type:r}=e;return "the element corresponding to '".concat(t,"' must be instanceof HTMLElement when calling ").concat(i,"(), received: ").concat(r,".")},PLAY_FAILED:e=>"".concat(e.media," play failed，browser exception: ").concat(e.error.toString()),INVALID_USERID:"userId cannot be all spaces.",INVALID_CREATE_STREAM_SOURCE:"LocalStream must be created by createStream() with either audio/video or audioSource/videoSource, but can not be mixed with audio/video and audioSource/videoSource.",INVALID_CREATE_STREAM_SCREEN:"screen/video cannot be both true.",INVALID_CREATE_STREAM_AUDIO:"audio/screenAudio cannot be both true.",INVALID_CREATE_STREAM_SCREEN_AUDIO:"when screen is true, screenAudio can be configured.",NOT_SUPPORTED_HTTP:"http protocol does not support the ability to capture microphone, camera and screen. please use https to deploy your page.",NOT_SUPPORTED_WEBRTC:"your browser or environment does not support full WebRTC capabilities.",NOT_SUPPORTED_PROFILE:"your browser does not support setVideoProfile.",NOT_SUPPORTED_MEDIA:"your browser or environment does not support navigator.mediaDevices.",NOT_SUPPORTED_H264ENCODE:"your device does not support H.264 encoding.",NOT_SUPPORTED_H264DECODE:"your device does not support H.264 decoding.",NOT_SUPPORTED_TRACK:e=>"".concat(e,"Track is not supported on your browser."),NOT_SUPPORTED_SWITCH_DEVICE:"switchDevice is not supported on your browser.",NOT_SUPPORTED_CAPTURE:"Your browser or environment does not support screen sharing, please check whether the browser version.",MICROPHONE_NOT_FOUND:"no microphone detected, please check your microphone.",CAMERA_NOT_FOUND:"no camera detected, please check your camera.",SIGNAL_RESPONSE_FAILED:e=>"".concat(e.signalResponse," failed, response code is ").concat(e.code," , errMsg: ").concat(e.message,"."),CATCH_HANDLER_ERROR(e){let{name:t,event:i}=e;return "an error was caught in ".concat(t,".on('").concat(i,"', handler), please check your code in 'handler'.")},API_NOT_EXIST(e){let{name:t}=e;return "experimental api ".concat(t," does not exist.")},REPEAT_JOIN:e=>"please avoid repeated join.",CONNECTION_CLOSED:"remoteStream has been unsubscribed or unpublished by remote user.",SUBSCRIBE_ALL_FALSE:"cannot subscribe when both audio & video are false, use client.unsubscribe() instead",CLIENT_DESTROYED(e){let{funName:t}=e;return "failed to call ".concat(t,"() because client was destroyed.")},SEI_NOT_SUPPORT:e=>"not support to sendSEIMessage".concat(!1===e?" without using h264 codec":""),SEI_DISABLED:"SEI is disabled",SEI_BEFORE_PUBLISH:"please call sendSEIMessage() after publish() success",SEI_NOT_VIDEO:"cannot send sei when localStream has not video.",CALL_FREQUENCY_LIMIT:e=>{let{isSize:t,name:i,timesInSecond:r,maxSizeInSecond:n}=e;return "api ".concat(i," call ").concat(t?"size":"times"," is over ").concat(t?"".concat(n," bytes"):r," in a second.")},CONNECTION_ABORTED:e=>"connection aborted due to: ".concat(e),API_CALL_ABORTED(e){let t;return t=e.message.includes("REMOTE_STREAM_NOT_EXIST")?"Subscribe ".concat(e.userId," ").concat(e.streamType," stream aborted, reason: remote user ").concat(e.userId," unpublished stream."):"API aborted, reason: ".concat(e.message),t},DUPLICATE_AUX:"only one auxiliary stream can be published in a room.",NOT_SUPPORTED_AUX:"publish auxiliary stream is not supported on your browser.",INVALID_PARAMETER_STREAMTYPE:e=>"'streamType' is required when 'userId' is not '*', calling ".concat(e,"()")},Yk={};xC(Yk,{ANDROID_VERSION:()=>cD,CHROME_MAJOR_VERSION:()=>lN,CHROME_VERSION:()=>dN,EDGE_VERSION:()=>_D,EDG_MAJOR_VERSION:()=>TD,EDG_VERSION:()=>gD,FIREFOX_MAJOR_VERSION:()=>pD,FIREFOX_VERSION:()=>hD,HUAWEI_VERSION:()=>$D,IE_VERSION:()=>DD,IOS_MAIN_VERSION:()=>fN,IOS_VERSION:()=>_N,IPADQQB_VERSION:()=>BD,IS_ANDROID:()=>aD,IS_ANDROID_WEBVIEW:()=>mN,IS_ANY_SAFARI:()=>hN,IS_CHROME:()=>aN,IS_CHROME_OS:()=>GD,IS_CHROMIUM_BASE:()=>sN,IS_EDG:()=>fD,IS_EDGE:()=>mD,IS_ELECTRON:()=>zD,IS_FIREFOX:()=>uD,IS_HEADLESS_CHROME:()=>cN,IS_HUAWEI:()=>XD,IS_HUAWEIBROWSER:()=>QD,IS_IE:()=>kD,IS_IE8:()=>bD,IS_IOS:()=>sD,IS_IOS_13_OR_14:()=>EN,IS_IOS_15_1:()=>TN,IS_IPAD:()=>iD,IS_IPADQQB:()=>FD,IS_IPAD_PRO:()=>rD,IS_IPHONE:()=>nD,IS_IPOD:()=>oD,IS_LINUX:()=>WD,IS_LOCAL:()=>vN,IS_MAC:()=>jD,IS_MACQQB:()=>VD,IS_MIBROWSER:()=>qD,IS_MQQB:()=>PD,IS_NATIVE_ANDROID:()=>dD,IS_OLD_ANDROID:()=>lD,IS_OPPOBROWSER:()=>tN,IS_SAFARI:()=>uN,IS_SAFARI_15_1:()=>gN,IS_SAMSUNGBROWSER:()=>ZD,IS_SOGOU:()=>yD,IS_SOGOUM:()=>ED,IS_TBS:()=>ID,IS_UCBROWSER:()=>KD,IS_VIVOBROWSER:()=>rN,IS_WECHAT:()=>ND,IS_WIN:()=>HD,IS_WQQB:()=>LD,IS_WX:()=>JD,IS_X5MQQB:()=>OD,IS_XWEB:()=>AD,MACQQB_VERSION:()=>UD,MI_VERSION:()=>YD,MQQB_VERSION:()=>MD,OPPO_VERSION:()=>iN,SAFARI_VERSION:()=>pN,SAMSUNG_VERSION:()=>eN,SOGOUM_VERSION:()=>vD,SOGOU_VERSION:()=>SD,TBS_VERSION:()=>RD,UA_DATA_STRING:()=>AN,USER_AGENT:()=>Qk,VIVO_VERSION:()=>nN,WECHAT_VERSION:()=>wD,WQQB_VERSION:()=>xD,XWEB_VERSION:()=>CD,browserInfo:()=>SN,getBrowserInfo:()=>IN,getChromeMajorVersion:()=>oN,getDeviceModel:()=>bN,getOSName:()=>DN,getOSNumber:()=>NN,getOSString:()=>wN,getOSType:()=>PN,getTerminalType:()=>ON,getUserAgentData:()=>CN,isLocalStorageEnabled:()=>yN});var Qk="undefined"==typeof navigator?"":navigator.userAgent,Xk=e=>new RegExp(e,"i").test(Qk),$k=e=>{if(Xk(e)){let t=new RegExp("".concat(e,"\\/([\\d.]+)")),i=Qk.match(t);if(i&&i[1])return i[1]}return ""},Zk=e=>{if(Xk(e)){let t=new RegExp("".concat(e,"\\/(\\d+)")),i=Qk.match(t);if(i&&i[1])return parseFloat(i[1])}return NaN},eD=/AppleWebKit\/([\d.]+)/i.exec(Qk),tD=eD?parseFloat(eD[1]):NaN,iD=Xk("iPad"),rD="undefined"!=typeof navigator&&navigator.maxTouchPoints&&navigator.maxTouchPoints>2&&Xk("Macintosh"),nD=Xk("iPhone")&&!iD,oD=Xk("iPod"),sD=nD||iD||oD||rD,aD=Xk("Android"),cD=function(){if(aD){let e=Qk.match(/Android (\d+)(?:\.(\d+))?(?:\.(\d+))*/i);if(e){let t=e[1]&&parseFloat(e[1]),i=e[2]&&parseFloat(e[2]);if(t&&i)return parseFloat("".concat(e[1],".").concat(e[2]));if(t)return t}}return NaN}(),lD=aD&&Xk("webkit")&&cD<2.3,dD=aD&&cD<5&&tD<537,uD=Xk("Firefox"),hD=$k("Firefox"),pD=Zk("Firefox"),mD=Xk("Edge"),_D=$k("Edge"),fD=Xk("Edg"),gD=$k("Edg"),TD=Zk("Edg"),ED=Xk("SogouMobileBrowser"),vD=$k("SogouMobileBrowser"),yD=Xk("MetaSr\\s"),SD=$k("MetaSr\\s"),ID=Xk("TBS"),RD=$k("TBS"),AD=Xk("XWEB"),CD=$k("XWEB"),bD=Xk("MSIE\\s8\\.0"),kD=Xk("MSIE\\/\\d+"),DD=function(){if(kD){let e=/MSIE\s(\d+)\.\d/.exec(Qk),t=e&&parseFloat(e[1]);return !t&&/Trident\/7.0/i.test(Qk)&&/rv:11.0/.test(Qk)&&(t=11),t}return NaN}(),ND=Xk("(micromessenger|webbrowser)"),wD=$k("MicroMessenger"),OD=!ID&&Xk("MQQBrowser")&&Xk("COVC"),PD=!ID&&Xk("MQQBrowser")&&!Xk("COVC"),MD=PD||OD?$k("MQQBrowser"):"",LD=!ID&&Xk(" QQBrowser"),xD=$k(" QQBrowser"),VD=!ID&&Xk("QQBrowserLite"),UD=$k("QQBrowserLite"),FD=!ID&&Xk("MQBHD"),BD=$k("MQBHD"),HD=Xk("Windows"),jD=!sD&&Xk("MAC OS X"),WD=!aD&&Xk("Linux"),GD=Xk("CrOS"),JD=Xk("MicroMessenger"),KD=Xk("UCBrowser"),zD=Xk("Electron"),qD=Xk("MiuiBrowser"),YD=$k("MiuiBrowser"),QD=Xk("HuaweiBrowser"),XD=Xk("Huawei"),$D=$k("HuaweiBrowser"),ZD=Xk("SamsungBrowser"),eN=$k("SamsungBrowser"),tN=Xk("HeyTapBrowser"),iN=$k("HeyTapBrowser"),rN=Xk("VivoBrowser"),nN=$k("VivoBrowser"),oN=()=>Zk("Chrome"),sN=Xk("Chrome"),aN=!mD&&!yD&&!ED&&!ID&&!AD&&!fD&&!LD&&!qD&&!QD&&!ZD&&!tN&&!rN&&sN,cN=Xk("HeadlessChrome"),lN=oN(),dN=$k("Chrome"),uN=!sN&&!PD&&!OD&&!VD&&!FD&&Xk("Safari"),hN=uN||sD,pN=$k("Version"),mN=/Android.*(wv|.0.0.0)/.test(Qk),_N=(()=>{if(rD)return pN;if(sD){let e=Qk.match(/OS (\d+)_(\d+)/i);if(e&&e[1]){let t=e[1];return e[2]&&(t+=".".concat(e[2])),t}}return ""})(),fN=Number(_N.split(".")[0]),gN="15.1"===pN,TN="15.1"===_N,EN=(()=>{let e=Number(_N.split(".")[0]);return 14===e||13===e})(),vN="undefined"!=typeof location&&("file:"===location.protocol||"localhost"===location.hostname||"127.0.0.1"===location.hostname),yN=(()=>{let e;return ()=>{if(void 0===e)try{e=!!window.localStorage;}catch(hO){e=!1;}return e}})(),SN=IN();function IN(){let e=new Map([[uD,["Firefox",hD]],[fD,["Edg",gD]],[aN,["Chrome",dN]],[uN,["Safari",pN]],[ID,["TBS",RD]],[AD,["XWEB",CD]],[ND&&nD,["WeChat",wD]],[LD,["QQ(Win)",xD]],[PD,["QQ(Mobile)",MD]],[OD,["QQ(Mobile X5)",MD]],[VD,["QQ(Mac)",UD]],[FD,["QQ(iPad)",BD]],[qD,["MI",YD]],[QD,["HW",$D]],[ZD,["Samsung",eN]],[tN,["OPPO",iN]],[rN,["VIVO",nN]],[mD,["EDGE",_D]],[ED,["SogouMobile",vD]],[yD,["Sogou",SD]]]),t="unknown",i="unknown";return e.has(!0)&&([t,i]=e.get(!0)),{name:t,version:i}}var RN=null,AN="";function CN(){return HC(this,null,(function*(){if(RN)return RN;if(!navigator.userAgentData||"function"!=typeof navigator.userAgentData.getHighEntropyValues)return null;try{return (RN=yield navigator.userAgentData.getHighEntropyValues(["architecture","bitness","model","platformVersion","fullVersionList"]))&&!AN&&(AN="UAData: ".concat(RN.platform,"/").concat(RN.platformVersion),RN.architecture&&RN.bitness&&(AN+=" ".concat(RN.architecture,"/").concat(RN.bitness)),RN.mobile&&(AN+=" mobile"),RN.model&&(AN+=" model: ".concat(RN.model)),RN.fullVersionList&&(AN+=" ".concat(RN.fullVersionList.filter((e=>"Not/A)Brand"!==e.brand)).map((e=>"".concat(e.brand,"/").concat(e.version))).join(",")))),RN}catch(sx){return null}}))}function bN(){return (null==RN?void 0:RN.model)||""}var kN=new Map([[aD,"Android"],[sD,"iOS"],[HD,"Windows"],[jD,"MacOS"],[WD,"Linux"],[GD,"ChromeOS"]]),DN=function(){return kN.get(!0)?kN.get(!0):RN?RN.platform:"unknown"};function NN(){return HD?1:aD?2:jD?3:sD?4:WD?5:GD?6:0}var wN=()=>{let e=DN();return e+="/".concat(SN.name,"/").concat(uN?SN.version:SN.version.split(".")[0]),null!=RN&&RN.platformVersion&&(e+="/".concat(RN.platformVersion)),null!=RN&&RN.architecture&&(e+="/".concat(RN.architecture)),e};function ON(){return aD?4:nD?2:iD?3:jD?12:HD?5:WD?13:1}function PN(){return aD?"Android":nD?"iPhone":iD?"iPad":jD?"Mac":HD?"Windows":WD?"Linux":"unknown"}var MN=(e,t)=>t?"".concat(Sb,"/").concat(e,"/").concat(t):"".concat(Sb,"/").concat(e,"/index.html"),LN=()=>{if(window.TRTC_ERROR_INFO&&window.TRTC_ERROR_LINK)return {TRTC_ERROR_INFO:window.TRTC_ERROR_INFO,TRTC_ERROR_LINK:window.TRTC_ERROR_LINK};let e=null==localStorage?void 0:localStorage.getItem(Cb);if(e){e=JSON.parse(e);let t=document.createElement("script");t.type="text/javascript",t.text=e.message,document.body.appendChild(t);let i=window.TRTC_ERROR_INFO,r=window.TRTC_ERROR_LINK;return document.body.removeChild(t),{TRTC_ERROR_INFO:i,TRTC_ERROR_LINK:r}}return {}};function xN(e){let{key:t,data:i,link:r,addDocLink:n=!0}=e,o="",s="",a="";yw(qk[t])?o=qk[t](i):Iw(qk[t])&&(o=qk[t]);let{TRTC_ERROR_INFO:c,TRTC_ERROR_LINK:l}=LN();r?a="".concat(r.className,".html#").concat(r.fnName):l&&l[t]&&(yw(l[t])?a=l[t](i):Iw(l[t])&&(a=l[t]));let d=o;return fw()&&(c&&c[t]&&(yw(c[t])?s=c[t](i):Iw(c[t])&&(s=c[t])),s&&(d=n?"".concat(s,"\n请查看文档: ").concat(MN("zh-cn",a),"\n\n"):"".concat(s,"\n\n"),d+=o)),n&&(d+=" \nRefer to: ".concat(MN("en",a),"\n")),d}var VN=Object.prototype.hasOwnProperty,UN=e=>"function"==typeof e,FN=e=>void 0===e;function BN(e){if(null==e)return !0;if("boolean"==typeof e)return !1;if("number"==typeof e)return 0===e;if("string"==typeof e||"function"==typeof e||Array.isArray(e))return 0===e.length;if(e instanceof Error)return ""===e.message;if(function(e){if(!e||"object"!=typeof e||"[object Object]"!=Object.prototype.toString.call(e))return !1;let t=Object.getPrototypeOf(e);if(null===t)return !0;let i=Object.prototype.hasOwnProperty.call(t,"constructor")&&t.constructor;return "function"==typeof i&&i instanceof i&&Function.prototype.toString.call(i)===Function.prototype.toString.call(Object)}(e))switch(Object.prototype.toString.call(e)){case"[object File]":case"[object Map]":case"[object Set]":return 0===e.size;case"[object Object]":for(let t in e)if(VN.call(e,t))return !1;return !0}return !1}var HN=function(e){let{retryFunction:t,settings:i,onError:r,onRetrying:n,onRetryFailed:o,onRetrySuccess:s,context:a}=e;return function(){for(var e=arguments.length,c=new Array(e),l=0;l<e;l++)c[l]=arguments[l];let{retries:d=5,timeout:u=1e3}=i,h=0,p=-1,m=0,_=(e,i)=>HC(this,null,(function*(){let l=a||this;try{let i=yield t.apply(l,c);h>0&&s&&s.call(this,h),h=0,e(i);}catch(f){let t=()=>{clearTimeout(p),h=0,m=2,i(f);},s=()=>{2!==m&&h<(UN(d)?d():d)?(h++,m=1,UN(n)&&n.call(this,h,t),p=window.setTimeout((()=>{p=-1,_(e,i);}),UN(u)?u(h):u)):(t(),UN(o)&&o.call(this,f));};UN(r)?r.call(this,{error:f,retry:s,reject:i,retryFuncArgs:c,retriedCount:h}):s();}}));return new Promise(_)}},jN=new(VC(jC(),1).default),WN=(e=>(e.ROOM_DESTROY="1",e.JOIN_START="21",e.JOIN_SCHEDULE_SUCCESS="22",e.JOIN_SIGNAL_CONNECTION_START="23",e.JOIN_SIGNAL_CONNECTION_END="24",e.JOIN_SEND_CMD="25",e.JOIN_RECEIVED_CMD_RES="26",e.JOIN_SUCCESS="27",e.JOIN_FAILED="28",e.LEAVE_START="51",e.LEAVE_SEND_CMD="52",e.LEAVE_SUCCESS="53",e.PUBLISH_START="61",e.SEND_FIRST_VIDEO_FRAME="62",e.PUBLISH_FAILED="63",e.SUBSCRIBE_START="81",e.SUBSCRIBE_SUCCESS="82",e.SUBSCRIBE_FAILED="84",e.UNSUBSCRIBE_SUCCESS="83",e.LOCAL_TRACK_CAPTURE_START="101",e.LOCAL_TRACK_CAPTURE_SUCCESS="102",e.LOCAL_TRACK_CAPTURE_FAILED="103",e.LOCAL_TRACK_PUBLISHED="104",e.LOCAL_TRACK_UNPUBLISHED="105",e.LOCAL_TRACK_REPLACED="106",e.SWITCH_DEVICE_SUCCESS="107",e.TRACK_MUTED="108",e.TRACK_UNMUTED="109",e.REMOTE_TRACK_SUBSCRIBED="110",e.REMOTE_TRACK_UNSUBSCRIBED="111",e.LOCAL_TRACK_RECAPTURE="112",e.PLAY_TRACK_START="151",e.PLAYER_STATE_CHANGED="152",e.VIDEO_LOADED_DATA="153",e.AUTOPLAY_DIALOG_CLICK_CONFIRM="154",e.SIGNAL_CONNECTION_STATE_CHANGED="201",e.PEER_CONNECTION_STATE_CHANGED="202",e.SINGLE_CONNECTION_STAT="203",e.SPC_RECONNECTED="204",e.HEARTBEAT_REPORT="251",e.RECEIVED_PUBLISHED_USER_LIST="252",e.REMOTE_PUBLISH_STATE_CHANGED="253",e.AUDIO_LEVEL_INTERVAL="260",e.NETWORK_QUALITY="261",e.VIDEO_CODEC_IMPLEMENTATION_CHANGED="262",e.QUALITY_LIMITATION_CHANGED="263",e.LOG="264",e))(WN||{}),GN=new class{constructor(){this._roomIdMap=new Map,"undefined"==typeof registerProcessor&&(this._configs={sdkAppId:"",userId:"",version:cb,env:kb.QCLOUD,browserVersion:SN.name+SN.version,ua:navigator.userAgent});}setConfig(e){let{sdkAppId:t,env:i,userId:r,roomId:n}=e;t!==this._configs.sdkAppId&&(this._configs.sdkAppId=String(t)),this._configs.env=i,this._configs.userId=r,this._roomIdMap.set(r,String(n));}logSuccessEvent(e){vN||!sO.isAbleToUpload||this._configs.env===kb.QCLOUD&&this.uploadEventToKibana(MC(PC({},e),{result:"success"}));}logFailedEvent(e){if(vN||!sO.isAbleToUpload)return;let{eventType:t,code:i,error:r,userId:n}=e,o={roomId:this._roomIdMap.get(n||this._configs.userId),userId:n,eventType:t,result:"failed",code:i||(null==r?void 0:r.extraCode)||(null==r?void 0:r.code)||ZC.UNKNOWN};this._configs.env===kb.QCLOUD&&this.uploadEventToKibana(MC(PC({},o),{error:r}));}uploadEventToKibana(e){let t="stat-".concat(e.eventType,"-").concat(e.result);("delta-join"===e.eventType||"delta-leave"===e.eventType||"delta-publish"===e.eventType)&&(t="".concat(e.eventType,":").concat(e.delta)),this.uploadEvent({log:t,userId:e.userId}),"failed"===e.result&&(t="stat-".concat(e.eventType,"-").concat(e.result,"-").concat(e.code),this.uploadEvent({log:t,userId:e.userId,error:e.error}));}uploadEvent(e){let{log:t,userId:i,error:r}=e,n={timestamp:nb(),sdkAppId:this._configs.sdkAppId,userId:i||this._configs.userId,version:cb,log:t};r&&(n.errorInfo=r.message,r.stack&&(n.errorInfo+="\n".concat(r.stack))),this.sendRequest(nw(this._configs.sdkAppId,bb.LOG),n);}sendRequest(e,t){sO.isAbleToUpload?Gk({url:e,body:JSON.stringify(t)}).catch((()=>{})):setTimeout((()=>{this.sendRequest(e,t);}),1e3);}},JN=null,KN=!0;function zN(e){Aw(e)&&e!==KN&&(KN=e,sO.info("setIsNeedToSchedule ".concat(e)));}function qN(e){return HC(this,arguments,(function(e){let{userId:t,sdkAppId:i,useStringRoomId:r,roomId:n,userSig:o,version:s,frameWorkType:a,role:c,latencyLevel:l}=e;return function*(){if(!KN&&JN)return {isCached:!0,result:JN};let e={delta:0,count:[1,1],msg:[],detail:[]};try{let d=new FormData;d.append("userId",String(t)),d.append("sdkAppId",String(i)),d.append("isStrGroupId",String(r)),d.append("groupId",String(n)),d.append("sdkVersion",s),d.append("userSig",String(o)),c&&d.append("role",String(c)),l&&d.append("latencyLevel",String(l)),a&&d.append("frameWorkType",String(a));let u=Lw(),h=yield function(e,t,i){return new Promise(((r,n)=>{let o=null;Mw([tw((e=>t.count[0]=e+1),(e=>{let{error:r,retry:n,retriedCount:s,retryFuncArgs:a}=e;t.msg[0]=r.message,o||(s>=2&&(a[0]=XN(i,Ub.MAIN,!0)),n());}))(XN(i,Ub.MAIN),e,{get timeout(){return 1e3*Tw(2+t.count[0])}}),tw((e=>t.count[1]=e+1),(e=>{let{error:r,retry:n,retriedCount:s,retryFuncArgs:a}=e;t.msg[1]=r.message,o||(s>=2&&(a[0]=XN(i,Ub.BACKUP,!0)),n());}))(XN(i,Ub.BACKUP),e,{get timeout(){return 1e3*Tw(2+t.count[1])}})]).then((e=>{o=e,r(o);})).catch(n);}))}(d,e,i);h.config&&(h.config.loggerDomain&&gb(h.config.loggerDomain),Aw(h.config.scheduleCache)&&zN(!h.config.scheduleCache)),e.delta=Lw()-u;let p=function(e,t,i){let r={totalCost:0,local:0,dns:0,tcp:0,tls:0,request:0,response:0};try{let n=performance.getEntriesByType("resource"),o=XN(e,Ub.MAIN),s=XN(e,Ub.BACKUP);for(let e of n)if(e.startTime>=i&&(e.name===o||e.name===s)&&e.transferSize>0){let i=e.name===o?Ub.MAIN:Ub.BACKUP,n=Math.round(e.duration),s=Math.round(e.domainLookupStart-e.startTime),a=e.redirectStart>0?Math.round(e.redirectEnd-e.redirectStart):0,c=e.fetchStart>0?Math.round(e.domainLookupStart-e.fetchStart):0,l=Math.round(e.domainLookupEnd-e.domainLookupStart),d=Math.round(e.requestStart-e.secureConnectionStart),u=Math.round(e.secureConnectionStart-e.connectStart),h=Math.round(e.responseStart-e.requestStart),p=Math.round(e.responseEnd-e.responseStart),m=[l,d,u,h,p];GN.uploadEvent({log:"stat-schedule-net:".concat(n,"(").concat(s,"(").concat(a,"->").concat(c,")->").concat(m.join("->"),") ").concat(i),userId:t}),r=MC(PC({},r),{totalCost:n,local:s,dns:l,tcp:u,tls:d,request:h,response:p});break}}catch(o){sO.error("getScheduleDetailCost error",o);}return r}(Number(i),t,u);return JN=h,{isCached:!1,result:h,detailCost:p}}catch(d){let e=bw(d)?d[0]:d,t=Rw(e.code)?e.code:0,i="schedule failed".concat(e.message?": ".concat(e.message):""),r=new tb({code:ZC.SCHEDULE_FAILED,extraCode:t,message:xN({key:zk.JOIN_ROOM_FAILED,data:{error:i,code:t}})});throw sO.error(i,t),r}}()}))}document&&document.head.insertAdjacentHTML("beforeend",Object.values(bk).map((e=>'<link rel="dns-prefetch" href="https://'.concat(e,'">'))).join("\r\n")),jN.on("28",(()=>zN(!0))),jN.on("63",(()=>zN(!0))),jN.on("84",(()=>zN(!0))),jN.on("201",(e=>{"RECONNECTING"===e.state&&zN(!0);})),jN.on("202",(e=>{"RECONNECTING"===e.state&&zN(!0);}));var YN={main:"",backup:""};function QN(e){bw(e)?(YN.main=e[0],YN.backup=e[1]):YN.main=e;}function XN(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:Ub.MAIN,i=arguments.length>2&&void 0!==arguments[2]&&arguments[2];return "https://".concat(YN[t]||ZN(e,t,i),"/api/v1/config")}function $N(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:Ub.MAIN;return "https://".concat(YN[t]||ZN(e,t),"/api/v1/trtcAutoConf")}function ZN(e){let t,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:Ub.MAIN,r=arguments.length>2&&void 0!==arguments[2]&&arguments[2];return rw(e)?i===Ub.MAIN?bk.MAIN_OVERSEA:bk.BACKUP_OVERSEA:(t=rw(e)?r?i===Ub.MAIN?bk.MAIN_OVERSEA_OLD:bk.BACKUP_OVERSEA_OLD:i===Ub.MAIN?bk.MAIN_OVERSEA:bk.BACKUP_OVERSEA:i===Ub.MAIN?bk.MAIN:bk.BACKUP,t)}function ew(e,t,i){return new Promise(((r,n)=>{Gk({url:e,body:t,timeout:i.timeout}).then((e=>{0===e.data.code?r(e.data.data):n({code:e.data.code,message:e.data.msg});})).catch(n);}))}var tw=(e,t)=>HN({retryFunction:ew,settings:{retries:3,timeout:0},onError:t,onRetrying:e});var iw=function(){return new URLSearchParams(location.search).get("trtc_env")||""},rw=e=>Number(e)<14e8,nw=function(e,t){let i;i=fb||(rw(e)?Ab:Rb);let r=Math.floor(Math.random()*wC(2,31));return "".concat(i,"/v5/AVQualityReportSvc/C2S?random=").concat(r,"&sdkappid=").concat(e,"&cmdtype=").concat(t)},ow="unknown";function sw(){if("unknown"!==ow)return ow;let{userAgent:e,connection:t}=navigator,i=(e.match(/NetType\/\S+/)||[])[0]||"";i=i.toLowerCase().replace("nettype/",""),"3gnet"===i&&(i="3g");let r=t&&t.type&&t.type.toLowerCase(),n=t&&t.effectiveType&&t.effectiveType.toLowerCase();return "slow-2"===n&&(n="2g"),r&&(ow=aw(r,n)),ow}function aw(e,t){if(Ob[e])return e;switch(e){case"cellular":case"wimax":return t||"unknown";case"ethernet":return "wired";default:return "unknown"}}function cw(e){ow=aw(e);}function lw(){return Ob[sw()]}function dw(e,t){for(let i of Reflect.ownKeys(t))if("constructor"!==i&&"prototype"!==i&&"name"!==i){let r=Object.getOwnPropertyDescriptor(t,i)||"";Object.defineProperty(e,i,r);}return e}function uw(e){return hw(e/4,arguments.length>1&&void 0!==arguments[1]?arguments[1]:48e3)}function hw(e){return 1e3*e/(arguments.length>1&&void 0!==arguments[1]?arguments[1]:48e3)}function pw(e){return 4*mw(e,arguments.length>1&&void 0!==arguments[1]?arguments[1]:48e3)}function mw(e){return e*(arguments.length>1&&void 0!==arguments[1]?arguments[1]:48e3)/1e3}var _w="undefined"!=typeof window&&"function"==typeof window.glog?window.glog:()=>{},fw=()=>{let e=navigator.language;return e=e.substring(0,2),"zh"===e},gw=function(e){if(!e||"object"!=typeof e||"[object Object]"!=Object.prototype.toString.call(e))return !1;let t=Object.getPrototypeOf(e);if(null===t)return !0;let i=Object.prototype.hasOwnProperty.call(t,"constructor")&&t.constructor;return "function"==typeof i&&i instanceof i&&Function.prototype.toString.call(i)===Function.prototype.toString.call(Object)};function Tw(e){let t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1;return e<=1?t:Tw(e-1,t,(arguments.length>1&&void 0!==arguments[1]?arguments[1]:1)+t)}function Ew(e){return e>8?3e4:1e3*Tw(e)}function vw(e){return Reflect.apply(Object.prototype.toString,e,[]).replace(/^\[object\s(\w+)\]$/,"$1").toLowerCase()}var yw=e=>"function"==typeof e,Sw=e=>void 0===e,Iw=e=>"string"==typeof e,Rw=e=>"number"==typeof e,Aw=e=>"boolean"==typeof e,Cw=e=>"object"===vw(e),bw=e=>"array"===vw(e),kw=e=>vw(e)==="MediaStreamTrack".toLowerCase(),Dw=e=>e.isRemote,Nw=e=>"promise"===vw(e),ww=e=>yw(e)&&e.prototype.constructor===e,Ow=e=>ww(e)?e.prototype.constructor.name:"",Pw="undefined"!=typeof AudioWorkletNode;function Mw(e){return new Promise(((t,i)=>{let r=[];e.forEach((n=>{n.then(t).catch((t=>{r.push(t),r.length===e.length&&i(r);}));}));}))}function Lw(){return performance&&performance.now?Math.floor(performance.now()):Date.now()}var xw=e=>+e<10?"0".concat(e):e,Vw=e=>{let t=e.match(/^\d+\.\d+\.\d+/)[0];if(!t)return e;let i=t.split("."),r=xw(i[1])+xw(i[2]);return i[1]-15>0&&(i[1]="15"),i[2]-15>0&&(i[2]="15"),"".concat(i.join("."),".").concat(r)},Uw=Object.prototype.hasOwnProperty;function Fw(e){if(null==e)return !0;if("boolean"==typeof e)return !1;if("number"==typeof e)return 0===e;if("string"==typeof e||"function"==typeof e||Array.isArray(e))return 0===e.length;if(e instanceof Error)return ""===e.message;if(gw(e))switch(Object.prototype.toString.call(e)){case"[object File]":case"[object Map]":case"[object Set]":return 0===e.size;case"[object Object]":for(let t in e)if(Uw.call(e,t))return !1;return !0}return !1}function Bw(e,t){return {userId:t,hasAudio:!!(e&Jb),hasVideo:!!(e&jb),hasAuxiliary:!!(e&Gb),hasSmall:!!(e&Wb),audioMuted:!!(e&Kb),videoMuted:!!(e&zb),audioAvailable:!(!(e&Jb)||e&Kb),videoAvailable:!(!(e&jb)||e&zb)}}function Hw(e){let t={urls:e.url.startsWith("turn:")||e.url.startsWith("turns:")?e.url:"turn:".concat(e.url)};return !Sw(e.username)&&!Sw(e.credential)&&(t.username=e.username,t.credential=e.credential,t.credentialType="password",Sw(e.credentialType)||(t.credentialType=e.credentialType)),t}function jw(e){let t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];if(!Iw(e))return 0;let i=e.split(".");return t?(Number(i[0])<<24|Number(i[1])<<16|Number(i[2])<<8|Number(i[3]))>>>0:(Number(i[3])<<24|Number(i[2])<<16|Number(i[1])<<8|Number(i[0]))>>>0}var Ww=function(e,t,i,r){if(!Cw(e)||!Cw(t))return 0;let n,o=0,s=Object.keys(t);for(let a=0,c=s.length;a<c;a++)if(n=s[a],!(Sw(t[n])||i&&i.includes(n)))if(Cw(e[n])&&Cw(t[n]))o+=Ww(e[n],t[n],i,r);else {if(r&&r.includes(t[n]))continue;e[n]!==t[n]&&(e[n]=Gw(t[n]),o+=1);}return o};function Gw(e){if(bw(e)){let t=[];return e.forEach(((e,i)=>{t[i]=Gw(e);})),t}if(Cw(e)){let t={};return Object.keys(e).forEach((i=>{t[i]=Gw(e[i]);})),t}return e}var Jw=e=>{let t=[];if(bw(e))t=[...e];else if(Iw(e)){let i=document.getElementById(e);i&&t.push(i);}else e&&t.push(e);return t},Kw=e=>Iw(e)?document.getElementById(e):e,zw=()=>(e=>{let t=e=>e<10?"0".concat(e):"".concat(e),i=e.getFullYear(),r=e.getMonth()+1,n=e.getDate(),o=t(e.getHours()),s=t(e.getMinutes()),a=t(e.getSeconds());return "".concat(i,"/").concat(r,"/").concat(n," ").concat(o,":").concat(s,":").concat(a)})(new Date);function qw(e,t){let{keysToInclude:i,keysToExclude:r}=t;try{if(bw(e))return "[".concat(e.map((e=>qw(e,{keysToInclude:i,keysToExclude:r}))).join(","),"]");if(!gw(e)||!bw(i)&&!bw(r))return JSON.stringify(e);let t={},n=new Set(i),o=new Set(r);return Object.keys(e).forEach((s=>{(0===o.size&&n.has(s)||0===n.size&&!o.has(s))&&(t[s]=gw(e[s])||bw(e[s])?JSON.parse(qw(e[s],{keysToExclude:r,keysToInclude:i})):e[s]);})),JSON.stringify(t)}catch(hk){return "{}"}}function Yw(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],i=[];return Object.keys(e).forEach((r=>{t===e[r]&&i.push(r);})),qw(e,{keysToInclude:i})}function Qw(e){return e.replace(/[\u4e00-\u9fa5]/g,"aa").length}var Xw=()=>{var e,t,i,r;return null!=(e=window.screen)&&e.orientation?!(null==(r=null==(i=null==(t=window.screen)?void 0:t.orientation)?void 0:i.type)||!r.includes("portrait")):0===window.orientation||180===window.orientation},$w=e=>HC(void 0,null,(function*(){return new Promise(((t,i)=>{let r;if(Iw(e))r=new Image,r.crossOrigin="anonymous",r.src=e;else if(r=e,r.complete)return void t(r);r.onload=()=>t(r),r.onerror=()=>{i(new tb({code:ZC.INVALID_PARAMETER,message:"load image failed, url: ".concat(e)}));};}))})),Zw=e=>{let t=e.split(".");return +t[0]<<24|+t[1]<<16|+t[2]<<8|+t[3]},eO=e=>(Object.keys(e).forEach((t=>{Rw(e[t])&&(t.startsWith("uint")||t.startsWith("int"))?e[t]=Math.floor(e[t]):(gw(e[t])||bw(e[t]))&&eO(e[t]);})),e);function tO(e,t){return new Promise((i=>{let r=setTimeout(i,e);t&&t(r);}))}var iO=(e,t)=>{let i=null;return function(){for(var r=arguments.length,n=new Array(r),o=0;o<r;o++)n[o]=arguments[o];return i||(i=e.apply(t||this,n),i.finally((()=>i=null)),i)}},rO=class{constructor(e){FC(this,"userId"),FC(this,"remoteUserId"),FC(this,"id"),FC(this,"sdkAppId"),FC(this,"type"),FC(this,"isLocal"),this.id=e.id,this.userId=e.userId,this.sdkAppId=e.sdkAppId,this.remoteUserId=e.remoteUserId,this.isLocal="boolean"!=typeof e.isLocal||e.isLocal,this.type=this.isLocal?"":e.type;}createChild(e){return Object.setPrototypeOf(e,this)}setUserId(e){this.userId=e;}setSdkAppId(e){this.sdkAppId=e;}log(e,t){let i=this.isLocal?this.userId:this.remoteUserId;t.unshift("[".concat(this.isLocal?"↑":"↓").concat(this.type&&"main"!==this.type?"*":"").concat(this.id).concat(i?"|".concat(i):"","]")),sO.log(e,t,FN(this.userId)||BN(this.userId),this.userId,this.sdkAppId);}info(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];this.log(2,t);}debug(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];this.log(1,t);}warn(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];this.log(3,t);}error(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];this.log(4,t);}},nO=WN,oO=!(sD||aD||cN),sO=new class{constructor(){FC(this,"_isEnableUploadLog",!0),FC(this,"_localJoinedUser",new Map),FC(this,"_queue",[]),FC(this,"_timeoutId",-1),FC(this,"_logLevel",1),FC(this,"_logLevelToUpload",2),!pb&&!mb&&(this.checkURLParam(),this.installEvents());}get isAbleToUpload(){return this._isEnableUploadLog&&-1!==this._timeoutId}installEvents(){jN.on(nO.JOIN_SCHEDULE_SUCCESS,(e=>{let{schedule:t}=e;var i;(null==(i=null==t?void 0:t.config)?void 0:i.logLevelToUpload)&&Db[t.config.logLevelToUpload]&&(this._logLevelToUpload=t.config.logLevelToUpload);})),jN.on(nO.JOIN_SUCCESS,(e=>{let{room:t}=e;this.addJoinedUser({userId:t.userId,sdkAppId:t.sdkAppId}),this.startUpload();})),jN.once(nO.JOIN_FAILED,(()=>{this.startUpload();})),jN.on(nO.LEAVE_SUCCESS,(e=>{let{room:t}=e;this.deleteJoinedUser(t.userId);}));}startUpload(){-1===this._timeoutId&&this.uploadInterval();}addJoinedUser(e){this._localJoinedUser.set(e.userId,e),this.startUpload();}deleteJoinedUser(e){this._localJoinedUser.delete(e);}uploadInterval(){this.upload().catch((()=>{})),this._timeoutId=window.setTimeout((()=>this.uploadInterval()),2e3);}getLogsToUpload(){let e={map:new Map,splicedQueue:[]};if(this._queue[0].forAllJoinedClients&&0===this._localJoinedUser.size)return e;let t=0;for(;t<this._queue.length&&50!==t;t++){let i=this._queue[t];if(i.forAllJoinedClients)this._localJoinedUser.forEach((t=>{let{userId:r,sdkAppId:n}=t;e.map.has(r)?e.map.get(r).logs.push(i):e.map.set(r,{userId:r,sdkAppId:n,logs:[i]});}));else if(Iw(i.userId)&&Rw(i.sdkAppId)){let{userId:t,sdkAppId:r}=i;e.map.has(t)?e.map.get(t).logs.push(i):e.map.set(t,{userId:t,sdkAppId:r,logs:[i]});}}return e.map.size>0&&(e.splicedQueue=this._queue.splice(0,t)),e}upload(){return HC(this,null,(function*(){if(0===this._queue.length||!this._isEnableUploadLog)return;let{map:e,splicedQueue:t}=this.getLogsToUpload();if(0===e.size)return;try{let t=[...e.values()];for(let e=0;e<t.length;e++){let{userId:i,sdkAppId:r,logs:n}=t[e];yield this.uploadLogWithRetry(JSON.stringify({timestamp:nb(),sdkAppId:String(r),userId:i,version:cb,log:n.map((e=>e.log)).join("\n")}),r),n.forEach((e=>e.uploaded=!0));}}catch(ub){}let i=t.filter((e=>!e.uploaded));i.length>0&&(this._queue=i.concat(this._queue));}))}uploadLogWithRetry(e,t){return HN({retryFunction:()=>Gk({url:nw(t,bb.LOG),body:e,timeout:5e3}),settings:{retries:3,timeout:1e3},onError:e=>{let{retry:t}=e;t();}})()}getPrefix(e){let t=new Date;t.setTime(rb());let i=String(t.getMilliseconds());return "padStart"in String.prototype&&(i=i.toString().padStart(3,"0")),"[".concat(t.toTimeString().replace(/.*(\d{2}:\d{2}:\d{2}).*/,"$1"),":").concat(i,"] <").concat(Db[e],">")}getLogLevel(){return this._logLevel}setLogLevel(e){Sw(Db[e])||(this._logLevel!==e&&this.info("setLogLevel",e),this._logLevel=e);}enableUploadLog(){this._isEnableUploadLog=!0;}disableUploadLog(){this.warn("disableUploadLog"),this._isEnableUploadLog=!1;}logChunkToString(e){if(Iw(e))return e;try{return e instanceof Error?e.toString():JSON.stringify(e)}catch(db){return ""}}log(e,t){let i=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],r=arguments.length>3?arguments[3]:void 0,n=arguments.length>4?arguments[4]:void 0;var o;t.unshift(this.getPrefix(e));let s={log:t.reduce(((e,t)=>"".concat(e," ").concat(this.logChunkToString(t)).trim()),""),level:e,userId:r,sdkAppId:n,forAllJoinedClients:i};if(jN.emit(nO.LOG,{log:s}),this._isEnableUploadLog&&e>=this._logLevelToUpload&&this._queue.push(s),e<this._logLevel)return;let a=(null==(o=Db[e])?void 0:o.toLowerCase())||"info";oO?console[a]("%cTRTC%c%s","padding: 1px 4px;border-radius: 3px;color: #fff;background: #1E88E5;","display: inline",...t):console[a](...t);}debug(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];this.log(1,t);}info(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];this.log(2,t);}warn(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];this.log(3,t);}error(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];this.log(4,t);}createLogger(e){return new rO(e)}checkURLParam(){let e=new URLSearchParams(location.search).get("logLevelToUpload"),t=e?Number(e):-1;Db[t]&&(this._logLevelToUpload=t);}getQueue(){return this._queue}},aO=function(){return "xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(e=>{let t=16*Math.random()|0;return ("x"==e?t:3&t|8).toString(16)}))},cO=new class{constructor(){FC(this,"_prefix","TRTC"),FC(this,"_queue",new Map),this.checkStorage();}getRealKey(e){return "".concat(this._prefix,"_").concat(e)}checkStorage(){yN()&&(setInterval(this.doFlush.bind(this),2e4),Object.keys(localStorage).filter((e=>{if(e.startsWith(this._prefix)){let t=localStorage.getItem(e);if(!t)return !1;let i=JSON.parse(t);if(i&&i.expiresIn<Date.now())return !0}return !1})).forEach((e=>localStorage.removeItem(e))));}doFlush(){if(yN())try{for(let[e,t]of this._queue)localStorage.setItem(e,JSON.stringify(t));}catch(hO){sO.warn(hO);}}getItem(e){if(!yN())return null;try{let t=localStorage.getItem(this.getRealKey(e));if(!t)return null;let i=JSON.parse(t);return i&&i.expiresIn>=Date.now()?i.value:null}catch(db){sO.warn(db);}}setItem(e,t){if(yN())try{let i={expiresIn:Date.now()+Pb,value:t};this._queue.set(this.getRealKey(e),i);}catch(hk){sO.warn(hk);}}deleteItem(e){if(!yN())return !1;try{return e=this.getRealKey(e),this._queue.delete(e),localStorage.removeItem(e),!0}catch(db){return sO.warn(db),!1}}clear(){if(yN())try{localStorage.clear();}catch(hO){sO.warn(hO);}}},lO={};xC(lO,{HTTPS_API:()=>FO,IS_GET_CAPABILITIES_SUPPORTED:()=>nP,IS_GET_SETTINGS_SUPPORTED:()=>rP,IS_GET_SYNCHRONIZATION_SOURCES_SUPPORTED:()=>iP,IS_INSERTABLE_STREAM_SUPPORTED:()=>oP,IS_RTC_RTP_SENDER_SUPPORTED:()=>ZO,IS_SCRIPT_TRANSFORM_SUPPORTED:()=>sP,IS_SEI_SUPPORTED:()=>aP,IS_SPC_SUPPORTED:()=>XO,basis:()=>pP,checkSystemRequirementsInternal:()=>LO,decodeSupportStatus:()=>MO,encodeSupportStatus:()=>PO,getBrowserInfo:()=>CO,getDisplayResolution:()=>HO,isAddTransceiverSupported:()=>QO,isBrowserSupported:()=>bO,isGetReceiversSupported:()=>zO,isGetSendersSupported:()=>qO,isGetTransceiversSupported:()=>YO,isGetUserMediaSupported:()=>jO,isMediaDevicesSupported:()=>DO,isMediaSessionSupported:()=>dP,isMediaStreamTrackProcessorSupported:()=>OO,isReplaceTrackSupported:()=>eP,isRequestVideoFrameCallbackSupported:()=>_P,isSIMDSupported:()=>hP,isScreenCaptureApiAvailable:()=>VO,isSelectedCandidatePair:()=>BO,isSetParametersSupported:()=>tP,isSmallStreamAPISupported:()=>GO,isSmallStreamSupported:()=>JO,isStopTransceiverSupported:()=>$O,isTRTCSupported:()=>xO,isUnifiedPlanDefault:()=>KO,isUsedInHttpProtocol:()=>wO,isWebAudioSupported:()=>WO,isWebCodecSupported:()=>lP,isWebCodecsSupported:()=>kO,isWebRTCSupported:()=>cP,isWebTransportSupported:()=>uP});var dO,uO,hO,pO=VC(KC(),1),mO=class{constructor(){let e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];this.countMap=new Map,this.distributionMap=new Map,this.log=sO.createLogger({id:"kv"}),e&&(jN.on("102",(e=>{let{track:t,cost:i}=e;this.addSuccessEvent({key:t.kind===Ub.AUDIO?EO.START_MICROPHONE:vO.START_CAMERA,cost:i});})),jN.on("103",(e=>{let{track:t,error:i}=e;this.addFailedEvent({key:t.kind===Ub.AUDIO?EO.START_MICROPHONE:vO.START_CAMERA,error:i});})));}getReportData(){let e={msg_sdk_basic_info:{uint32_sdk_version:Zw(this.version||cb),uint32_terminal_type:15,bytes_device_name:"",bytes_os_version:"",uint32_framework:30,uint32_network_type:0},stats_count:[...this.countMap.entries()].map((e=>{let[t,i]=e;return {uint32_key:t,uint32_count:i}})),stats_distribution:[...this.distributionMap.entries()].map((e=>{let[t,i]=e;return {uint32_key:t,distribution_items:[...i.entries()].map((e=>{let[t,i]=e;return {uint32_item_key:t,uint32_item_value:i}}))}}))};return this.countMap.clear(),this.distributionMap.clear(),e}clear(){this.countMap.clear(),this.distributionMap.clear();}isEnumKey(e){let t=+String(e).slice(-3);return t>=700&&t<799}isErrorCodeKey(e){let t=+String(e).slice(-3);return t>=600&&t<699}isCountKey(e){let t=+String(e).slice(-3);return t>=0&&t<599}isNumberKey(e){let t=+String(e).slice(-3);return t>=800&&t<899}addCount(e){let{key:t,useUV:i=!1}=e;this.isCountKey(t)?i&&this.countMap.has(t)||this.countMap.set(t,(this.countMap.get(t)||0)+1):this.log.debug("".concat(t," is not count key, last 3 number should be 0~599"));}addEnum(e){let{key:t,value:i,useUV:r=!0}=e;var n;if(!this.isEnumKey(t))return this.log.debug("".concat(t," is not enum key, last 3 number should be 700~799"));if(r&&this.countMap.has(t))return;this.countMap.set(t,(this.countMap.get(t)||0)+1);let o=(null==(n=this.distributionMap)?void 0:n.get(t))||new Map;o.set(i,(o.get(i)||0)+1),this.distributionMap.set(t,o);}addNumber(e){let{key:t,value:i,split:r=100,useUV:n=!1}=e;var o;if(!this.isNumberKey(t))return this.log.debug("".concat(t," is not number key, last 3 number should be 800~899"));if(n&&this.countMap.has(t))return;this.countMap.set(t,(this.countMap.get(t)||0)+1);let s=(null==(o=this.distributionMap)?void 0:o.get(t))||new Map,a=0;if(Rw(r))a=Math.floor(i/r);else for(let c=r.length-1;c>0;c--)if(i>r[c]){a=c;break}s.set(a,(s.get(a)||0)+1),this.distributionMap.set(t,s);}addSuccessEvent(e){let{key:t,cost:i,timeKey:r,split:n}=e;if(t&&(this.addEnum({key:t,value:1,useUV:!1}),i)){let e=+String(t).slice(-3);e<800&&e>=700?this.addNumber({key:r||t+100,value:i,split:n}):r||this.log.debug("time stat ignored, ".concat(t));}}addFailedEvent(e){let{key:t,error:i}=e;if(!t)return;let r=ZC.UNKNOWN;i&&(Rw(i)?r=i:(!Sw(i.extraCode)||!Sw(i.code))&&(r=i.extraCode||i.code)),this.addEnum({key:t,value:0,useUV:!1}),this.addEnum({key:t,value:r,useUV:!1});}},_O=((uO=_O||{})[uO.enterRoom=500700]="enterRoom",uO[uO.exitRoom=500701]="exitRoom",uO[uO.switchRole=500702]="switchRole",uO[uO.destroy=500703]="destroy",uO[uO.startLocalAudio=500704]="startLocalAudio",uO[uO.updateLocalAudio=500705]="updateLocalAudio",uO[uO.stopLocalAudio=500706]="stopLocalAudio",uO[uO.startLocalVideo=500707]="startLocalVideo",uO[uO.updateLocalVideo=500708]="updateLocalVideo",uO[uO.stopLocalVideo=500709]="stopLocalVideo",uO[uO.startScreenShare=500710]="startScreenShare",uO[uO.updateScreenShare=500711]="updateScreenShare",uO[uO.stopScreenShare=500712]="stopScreenShare",uO[uO.startRemoteVideo=500713]="startRemoteVideo",uO[uO.updateRemoteVideo=500714]="updateRemoteVideo",uO[uO.stopRemoteVideo=500715]="stopRemoteVideo",uO[uO.muteRemoteAudio=500716]="muteRemoteAudio",uO[uO.setRemoteAudioVolume=500717]="setRemoteAudioVolume",uO[uO.use=500718]="use",uO[uO.sendSEIMessage=5e5]="sendSEIMessage",uO[uO.sendCustomMessage=500001]="sendCustomMessage",uO),fO=((dO=fO||{})[dO.AudioMixer=550700]="AudioMixer",dO[dO.AIDenoiser=551700]="AIDenoiser",dO[dO.VirtualBackground=570700]="VirtualBackground",dO[dO.Beauty=571700]="Beauty",dO[dO.Watermark=572700]="Watermark",dO[dO.BasicBeauty=574700]="BasicBeauty",dO[dO.CDNStreaming=590700]="CDNStreaming",dO[dO.DeviceDetector=591700]="DeviceDetector",dO[dO.Debug=592700]="Debug",dO),gO=(e=>(e[e.AudioMixer=550701]="AudioMixer",e[e.AIDenoiser=551701]="AIDenoiser",e[e.VirtualBackground=570701]="VirtualBackground",e[e.Beauty=571701]="Beauty",e[e.Watermark=572701]="Watermark",e[e.BasicBeauty=574701]="BasicBeauty",e[e.CDNStreaming=590701]="CDNStreaming",e[e.DeviceDetector=591701]="DeviceDetector",e[e.Debug=592701]="Debug",e))(gO||{}),TO=(e=>(e[e.AudioMixer=550702]="AudioMixer",e[e.AIDenoiser=551702]="AIDenoiser",e[e.VirtualBackground=570702]="VirtualBackground",e[e.Beauty=571702]="Beauty",e[e.Watermark=572702]="Watermark",e[e.BasicBeauty=574702]="BasicBeauty",e[e.CDNStreaming=590702]="CDNStreaming",e[e.DeviceDetector=591702]="DeviceDetector",e[e.Debug=592702]="Debug",e))(TO||{}),EO=(e=>(e[e.START_MICROPHONE=501700]="START_MICROPHONE",e[e.MICROPHONE_CAHNNELS=501701]="MICROPHONE_CAHNNELS",e[e.MICROPHONE_SAMPLERATE=501702]="MICROPHONE_SAMPLERATE",e))(EO||{}),vO=((hO=vO||{})[hO.START_CAMERA=511700]="START_CAMERA",hO),yO=new mO(!0),SO=new mO(!1),IO=yO,RO={result:!1,detail:{isBrowserSupported:!1,isWebRTCSupported:!1,isWebCodecsSupported:!1,isMediaDevicesSupported:!1,isScreenShareSupported:!1,isSmallStreamSupported:!1,isH264EncodeSupported:!1,isVp8EncodeSupported:!1,isH264DecodeSupported:!1,isVp8DecodeSupported:!1}},AO=new Map([[uD,["Firefox",hD]],[fD,["Edg",gD]],[aN,["Chrome",dN]],[uN,["Safari",pN]],[ID,["TBS",RD]],[AD,["XWEB",CD]],[ND&&nD,["WeChat",wD]],[LD,["QQ(Win)",xD]],[PD,["QQ(Mobile)",MD]],[OD,["QQ(Mobile X5)",MD]],[VD,["QQ(Mac)",UD]],[FD,["QQ(iPad)",BD]],[qD,["MI",YD]],[QD,["HW",$D]],[ZD,["Samsung",eN]],[tN,["OPPO",iN]],[rN,["VIVO",nN]],[mD,["EDGE",_D]],[ED,["SogouMobile",vD]],[yD,["Sogou",SD]]]);function CO(){let e=AO.get(!0);return {browserName:e?e[0]:"unknown",browserVersion:e?e[1]:"unknown"}}var bO=function(){return !(KD||mD||fD&&TD<80||uD&&pD<56)},kO=function(){return ["VideoDecoder","VideoEncoder","AudioEncoder","AudioDecoder","MediaStreamTrackGenerator"].every((e=>e in window))},DO=function(){if(!navigator.mediaDevices)return wO()||sO.error(qk.NOT_SUPPORTED_MEDIA),!1;let e=["getUserMedia","enumerateDevices"];return e.filter((e=>e in navigator.mediaDevices)).length===e.length},NO=!1;function wO(){return "http:"===location.protocol&&!vN&&(NO||sO.error(xN({key:zk.NOT_SUPPORTED_HTTP})),NO=!0,!0)}var OO=function(){return (null==window?void 0:window.OffscreenCanvas)&&(null==window?void 0:window.MediaStreamTrackProcessor)&&(null==window?void 0:window.MediaStreamTrackGenerator)},PO=function(){return HC(this,null,(function*(){if(RO.detail.isH264EncodeSupported&&RO.detail.isVp8EncodeSupported)return {isH264EncodeSupported:RO.detail.isH264EncodeSupported,isVp8EncodeSupported:RO.detail.isVp8EncodeSupported};let e,t=!1,i=!1;try{let r=new RTCPeerConnection,n=document.createElement(Ub.CANVAS);n.getContext("2d");let o=n.captureStream(0);return r.addTrack(o.getVideoTracks()[0],o),e=yield r.createOffer(),-1!==e.sdp.toLowerCase().indexOf("h264")&&(t=!0),-1!==e.sdp.toLowerCase().indexOf("vp8")&&(i=!0),r.close(),RO.detail.isH264EncodeSupported=t,RO.detail.isVp8EncodeSupported=i,{isH264EncodeSupported:RO.detail.isH264EncodeSupported,isVp8EncodeSupported:RO.detail.isVp8EncodeSupported}}catch(hk){return {isH264EncodeSupported:!1,isVp8EncodeSupported:!1}}}))},MO=function(){return HC(this,null,(function*(){if(RO.detail.isH264DecodeSupported&&RO.detail.isVp8DecodeSupported)return {isH264DecodeSupported:RO.detail.isH264DecodeSupported,isVp8DecodeSupported:RO.detail.isVp8DecodeSupported};let e,t=!1,i=!1;try{let r=new RTCPeerConnection;return e=yield r.createOffer({offerToReceiveAudio:!0,offerToReceiveVideo:!0}),-1!==e.sdp.toLowerCase().indexOf("h264")&&(t=!0),-1!==e.sdp.toLowerCase().indexOf("vp8")&&(i=!0),r.close(),{isH264DecodeSupported:t,isVp8DecodeSupported:i}}catch(hk){return {isH264DecodeSupported:!1,isVp8DecodeSupported:!1}}}))},LO=iO((()=>HC(void 0,null,(function*(){if(RO.result&&RO.detail.isH264EncodeSupported&&RO.detail.isVp8EncodeSupported&&RO.detail.isH264DecodeSupported&&RO.detail.isVp8DecodeSupported)return RO;let e=Date.now(),t=bO(),i=cP(),r=kO(),n=DO(),{isH264EncodeSupported:o,isVp8EncodeSupported:s}=yield PO(),{isH264DecodeSupported:a,isVp8DecodeSupported:c}=yield MO();if(!o||!s){let e=yield PO();sO.warn("detect encode again h264:".concat(o," vp8:").concat(s," result: ").concat(JSON.stringify(e))),o=e.isH264EncodeSupported,s=e.isVp8EncodeSupported;}if(o&&a&&(tN||rN||mN)&&!ID&&oN()<79){let{encode:e,decode:t}=yield function(){return HC(this,null,(function*(){return UO||(UO=new Promise((e=>HC(this,null,(function*(){let t={encode:!1,decode:!1},i=()=>{};try{sO.warn("detectH264Supported start");let r=document.createElement("canvas"),n=r.getContext("2d");r.width=320,r.height=240;let o=setInterval((()=>{n.fillText("test",Math.floor(320*Math.random()),Math.floor(240*Math.random()));}),66),s=-1,a=-1;i=()=>{clearInterval(s),clearInterval(o),clearTimeout(a),l.close(),d.close(),c.getTracks().forEach((e=>e.stop()));},a=setTimeout((()=>{i(),e(t);}),2e3);let c=r.captureStream(),l=new RTCPeerConnection({}),d=new RTCPeerConnection({offerToReceiveAudio:!0,offerToReceiveVideo:!0});l.addEventListener("icecandidate",(e=>d.addIceCandidate(e.candidate))),d.addEventListener("icecandidate",(e=>l.addIceCandidate(e.candidate))),l.addTrack(c.getVideoTracks()[0],c);let u=yield l.createOffer();yield l.setLocalDescription(u),yield d.setRemoteDescription(u);let h=yield d.createAnswer(),p=pO.default.parse(h.sdp),m=p.media[0].rtp.findIndex((e=>"H264"===e.codec));p.media[0].rtp=[p.media[0].rtp[m]],p.media[0].fmtp=p.media[0].fmtp.filter((e=>e.payload===p.media[0].rtp[0].payload)),p.media[0].rtcpFb&&(p.media[0].rtcpFb=p.media[0].rtcpFb.filter((e=>e.payload===p.media[0].rtp[0].payload))),h.sdp=pO.default.write(p),yield d.setLocalDescription(h),yield l.setRemoteDescription(h),s=setInterval((()=>HC(this,null,(function*(){t.encode&&t.decode&&(i(),e(t));let r=yield l.getSenders()[0].getStats(),n=yield d.getReceivers()[0].getStats();t.encode||r.forEach((e=>{"outbound-rtp"===e.type&&e.mediaType===Ub.VIDEO&&e.bytesSent>0&&(t.encode=!0);})),t.decode||n.forEach((e=>{"inbound-rtp"===e.type&&e.mediaType===Ub.VIDEO&&e.bytesReceived>0&&(t.decode=!0);}));}))),100);}catch(r){i(),sO.warn(r),e(t);}})))).then((e=>((!e.encode||!e.decode)&&sO.warn("detectH264Supported encode: ".concat(e.encode," decode: ").concat(e.decode," ").concat(AN)),e))),UO)}))}();o=e,a=t;}return RO.result=t&&i&&n&&(o||s)&&(a||c),RO.detail.isBrowserSupported=t,RO.detail.isWebRTCSupported=i,RO.detail.isWebCodecsSupported=r,RO.detail.isMediaDevicesSupported=n,RO.detail.isScreenShareSupported=VO(),RO.detail.isSmallStreamSupported=JO(),RO.detail.isH264EncodeSupported=o,RO.detail.isVp8EncodeSupported=s,RO.detail.isH264DecodeSupported=a,RO.detail.isVp8DecodeSupported=c,RO.result||sO.error("".concat(navigator.userAgent," ").concat(Yw(RO.detail,!1))),cO.setItem(mP,{ua:navigator.userAgent,checkResult:RO}),IO.addNumber({key:523800,value:Date.now()-e}),RO})))),xO=function(){return RO.result},VO=function(){return !(!navigator.mediaDevices||!navigator.mediaDevices.getDisplayMedia)},UO=null;var FO=(e,t,i)=>{"http:"===location.protocol&&!vN&&(e[t]=()=>{throw new tb({code:ZC.INVALID_OPERATION,message:qk.NOT_SUPPORTED_HTTP})});},BO=function(e){return !("candidate-pair"!==e.type||!e.nominated||"in-progress"!==e.state&&"succeeded"!==e.state)&&!(Aw(e.selected)&&!e.selected)};function HO(){let e="";if(screen.width){let t=screen.width?screen.width*window.devicePixelRatio:"",i=screen.height?screen.height*window.devicePixelRatio:"";e+="".concat(t," * ").concat(i);}return e}function jO(){return navigator.getUserMedia||navigator.mediaDevices&&navigator.mediaDevices.getUserMedia}function WO(){let e={isSupported:!1},t=["AudioContext","webkitAudioContext","mozAudioContext","msAudioContext"];for(let i=0;i<t.length;i++)if(t[i]in window){e.isSupported=!0;break}return e.isSupported}function GO(){return "captureStream"in HTMLCanvasElement.prototype}function JO(){return !(ND||sD||lN&&lN<63)&&!(!bO()||!GO())}var KO=function(){if(Sw(window.RTCRtpTransceiver)||!("currentDirection"in RTCRtpTransceiver.prototype))return !1;let e=null,t=!1;try{e=new RTCPeerConnection({sdpSemantics:Tk}),e.addTransceiver(Ub.AUDIO),t=!0;}catch(db){}return null==e||e.close(),t};function zO(){return "RTCPeerConnection"in window&&"getReceivers"in window.RTCPeerConnection.prototype}function qO(){return "RTCPeerConnection"in window&&"getSenders"in window.RTCPeerConnection.prototype}function YO(){return "RTCPeerConnection"in window&&"getTransceivers"in window.RTCPeerConnection.prototype}function QO(){return 11!==fN&&("RTCPeerConnection"in window&&"addTransceiver"in window.RTCPeerConnection.prototype)}var XO=!(!QO()||sN&&lN<86);function $O(){return "RTCRtpTransceiver"in window&&"stop"in window.RTCRtpTransceiver.prototype}var ZO="RTCRtpSender"in window;function eP(){return ZO&&"replaceTrack"in window.RTCRtpSender.prototype}function tP(){return ZO&&"setParameters"in window.RTCRtpSender.prototype&&qO()}var iP="RTCRtpReceiver"in window&&"getSynchronizationSources"in window.RTCRtpReceiver.prototype,rP=window.MediaStreamTrack&&"getSettings"in MediaStreamTrack.prototype,nP=window.MediaStreamTrack&&"getCapabilities"in MediaStreamTrack.prototype,oP=ZO&&"createEncodedStreams"in window.RTCRtpSender.prototype&&oN()>=86,sP="RTCRtpScriptTransform"in window,aP=ZO&&(oP||sP),cP=function(){return ["RTCPeerConnection","webkitRTCPeerConnection","RTCIceGatherer"].filter((e=>e in window)).length>0};function lP(){let e={AudioDecoder:!1,AudioEncoder:!1,VideoDecoder:!1,VideoEncoder:!1,ImageDecoder:!1};return Sw(window.AudioDecoder)||(e.AudioDecoder=!0),Sw(window.AudioEncoder)||(e.AudioEncoder=!0),Sw(window.VideoDecoder)||(e.VideoDecoder=!0),Sw(window.VideoEncoder)||(e.VideoEncoder=!0),Sw(window.ImageDecoder)||(e.ImageDecoder=!0),e}function dP(){return "mediaSession"in navigator&&!Sw(navigator.mediaSession.setActionHandler)}function uP(){return !Sw(window.WebTransport)}function hP(){return "undefined"!=typeof WebAssembly&&WebAssembly.validate(new Uint8Array([0,97,115,109,1,0,0,0,1,5,1,96,0,1,123,3,2,1,0,10,10,1,8,0,65,0,253,15,253,98,11]))}function pP(){let e={browser:"".concat(SN.name,"/").concat(SN.version),os:DN(),displayResolution:HO(),isScreenShareSupported:VO(),isWebRTCSupported:cP(),isGetUserMediaSupported:jO(),isWebAudioSupported:WO(),isWebSocketsSupported:"WebSocket"in window&&2===window.WebSocket.CLOSING,isWebCodecSupported:lP(),isMediaSessionSupported:dP(),isWebTransportSupported:uP()};return navigator.userAgent.includes("miniProgram")&&(e.browser="mini/".concat(e.browser)),e}var mP="checkResult";function _P(){return "requestVideoFrameCallback"in HTMLVideoElement.prototype}!function(){wO();let e=cO.getItem(mP);e&&e.ua===navigator.userAgent&&(RO=e.checkResult),LO();}();var fP=VC(jC(),1),gP=Symbol("instance"),TP=Symbol("cacheResult"),EP=class{constructor(e,t,i){this.oldState=e,this.newState=t,this.action=i,this.aborted=!1;}abort(e){this.aborted=!0,RP.call(e,this.oldState,new Error("action '".concat(this.action,"' aborted")));}toString(){return "".concat(this.action,"ing")}},vP=class extends Error{constructor(e,t,i){super(t),this.state=e,this.message=t,this.cause=i;}};var yP=new Map;function SP(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return (r,n,o)=>{let s=i.action||n;if(!i.context){let i=yP.get(r)||[];yP.has(r)||yP.set(r,i),i.push({from:e,to:t,action:s});}let a=o.value;o.value=function(){let r=this;for(var n=arguments.length,o=new Array(n),c=0;c<n;c++)o[c]=arguments[c];if(i.context&&(r=AP.get("function"==typeof i.context?i.context.call(this,...o):i.context)),r.state===t)return i.sync?r[TP]:Promise.resolve(r[TP]);r.state instanceof EP&&r.state.action==i.abortAction&&r.state.abort(r);let l=null;Array.isArray(e)?0==e.length?r.state instanceof EP&&r.state.abort(r):("string"!=typeof r.state||!e.includes(r.state))&&(l=new vP(r._state,"".concat(r.name," ").concat(s," to ").concat(t," failed: current state ").concat(r._state," not from ").concat(e.join("|")))):e!==r.state&&(l=new vP(r._state,"".concat(r.name," ").concat(s," to ").concat(t," failed: current state ").concat(r._state," not from ").concat(e)));let d=e=>{if(i.fail&&i.fail.call(this,e),i.sync){if(i.ignoreError)return e;throw e}return i.ignoreError?Promise.resolve(e):Promise.reject(e)};if(l)return d(l);let u=r.state,h=new EP(u,t,s);RP.call(r,h);let p=e=>{var n;return r[TP]=e,h.aborted||(RP.call(r,t),null===(n=i.success)||void 0===n||n.call(this,r[TP])),e},m=e=>{let t=e instanceof Error?e.message:String(e);return RP.call(r,u,e),d(new vP(r._state,"action '".concat(s,"' failed :").concat(t),e instanceof Error?e:new Error(t)))};try{let e=a.apply(this,o);return function(e){return "object"==typeof e&&e&&"then"in e}(e)?e.then(p).catch(m):i.sync?p(e):Promise.resolve(p(e))}catch(_){return m(_)}};}}var IP="undefined"!=typeof window&&window.__AFSM__?(e,t)=>{window.dispatchEvent(new CustomEvent(e,{detail:t}));}:"undefined"!=typeof importScripts?(e,t)=>{postMessage({type:e,payload:t});}:()=>{};function RP(e,t){let i=this._state;this._state=e;let r=e.toString();e&&this.emit(r,i),this.emit(AP.STATECHANGED,e,i,t),this.updateDevTools({value:e,old:i,err:t instanceof Error?t.message:String(t)});}var AP=class extends fP.default{constructor(e,t,i){super(),this.name=e,this.groupName=t,this._state=AP.INIT,e||(e=Date.now().toString(36)),i?Object.setPrototypeOf(this,i):i=Object.getPrototypeOf(this),t||(this.groupName=this.constructor.name);let r=i[gP];r?this.name=r.name+"-"+r.count++:i[gP]={name:this.name,count:0},this.updateDevTools({diagram:this.stateDiagram});}get stateDiagram(){let e=Object.getPrototypeOf(this),t=yP.get(e)||[],i=new Set,r=[],n=[],o=new Set,s=Object.getPrototypeOf(e);yP.has(s)&&(s.stateDiagram.forEach((e=>i.add(e))),s.allStates.forEach((e=>o.add(e)))),t.forEach((e=>{let{from:t,to:i,action:o}=e;"string"==typeof t?r.push({from:t,to:i,action:o}):t.length?t.forEach((e=>{r.push({from:e,to:i,action:o});})):n.push({to:i,action:o});})),r.forEach((e=>{let{from:t,to:r,action:n}=e;o.add(t),o.add(r),o.add(n+"ing"),i.add("".concat(t," --\x3e ").concat(n,"ing : ").concat(n)),i.add("".concat(n,"ing --\x3e ").concat(r," : ").concat(n," 🟢")),i.add("".concat(n,"ing --\x3e ").concat(t," : ").concat(n," 🔴"));})),n.forEach((e=>{let{to:t,action:r}=e;i.add("".concat(r,"ing --\x3e ").concat(t," : ").concat(r," 🟢")),o.forEach((e=>{e!==t&&i.add("".concat(e," --\x3e ").concat(r,"ing : ").concat(r));}));}));let a=[...i];return Object.defineProperties(e,{stateDiagram:{value:a},allStates:{value:o}}),a}static get(e){let t;return "string"==typeof e?(t=AP.instances.get(e),t||AP.instances.set(e,t=new AP(e,void 0,Object.create(AP.prototype)))):(t=AP.instances2.get(e),t||AP.instances2.set(e,t=new AP(e.constructor.name,void 0,Object.create(AP.prototype)))),t}static getState(e){var t;return null===(t=AP.get(e))||void 0===t?void 0:t.state}updateDevTools(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};IP(AP.UPDATEAFSM,Object.assign({name:this.name,group:this.groupName},e));}get state(){return this._state}set state(e){RP.call(this,e);}};AP.STATECHANGED="stateChanged",AP.UPDATEAFSM="updateAFSM",AP.INIT="[*]",AP.ON="on",AP.OFF="off",AP.instances=new Map,AP.instances2=new WeakMap;var CP=(null==window?void 0:window.requestIdleCallback)||function(e){let t=Date.now();return setTimeout((()=>{e({didTimeout:!1,timeRemaining:()=>Math.max(0,50-(Date.now()-t))});}),1e3)},bP=(null==window?void 0:window.cancelIdleCallback)||function(e){clearTimeout(e);},kP=(null==window?void 0:window.cancelAnimationFrame)||(null==window?void 0:window.mozCancelAnimationFrame),DP=class{static generateTaskID(){return this.currentTaskID++}static run(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:Hk,t=arguments.length>1?arguments[1]:void 0,i=arguments.length>2?arguments[2]:void 0;i=PC(e===Bk?{delay:2e3,count:0,backgroundTask:!0}:e===Uk?{delay:1e4,count:0}:e===Fk?{fps:60,delay:16.6,count:0,backgroundTask:!0}:{delay:2e3,count:0,backgroundTask:!0},i),Cw(t)&&(i=PC(PC({},i),t)),yw(e)&&(t=e,e=Hk);let r=PC({taskID:this.generateTaskID(),loopCount:0,intervalID:null,timeoutID:null,rafID:null,ricID:null,taskName:e,callback:t},i);return this.taskMap.set(r.taskID,r),this[e](r),r.taskID}static interval(e){return e.intervalID=setInterval((()=>{e.callback(),e.loopCount+=1,this.isBreakLoop(e);}),e.delay)}static intervalInWorker(e){e.delay=(1e3/e.fps).toFixed(2);let t=new Worker(URL.createObjectURL(new Blob(["\n        let timerID = null;\n        self.onmessage = function (e) {\n          if (e.data === 'start') {\n            timerID = setInterval(() => {\n              self.postMessage('tick');\n            }, ".concat(e.delay,");\n          } else if (e.data === 'stop') {\n            clearInterval(timerID);\n          }\n        };\n      ")],{type:"application/javascript"})));t.onmessage=i=>{"tick"===i.data&&(e.callback(),e.loopCount+=1,this.isBreakLoop(e)&&t.postMessage("stop"));},e.worker=t,t.postMessage("start");}static timeout(e){let t=()=>{if(e.callback(),e.loopCount+=1,!this.isBreakLoop(e))return e.timeoutID=setTimeout(t,e.delay)};return e.timeoutID=setTimeout(t,e.delay)}static ric(e){let t,i=Lw(),r=()=>{if(t=Lw()-i,t>=e.delay&&(i=Lw()-Math.floor(t%e.delay),e.callback(),e.loopCount+=1),!this.isBreakLoop(e))return e.ricID=CP(r,{timeout:e.delay})};return e.ricID=CP(r,{timeout:e.delay})}static raf(e){e.delay=(1e3/e.fps).toFixed(2);let t,i=Lw(),r=()=>document.hidden&&e.backgroundTask?(t=Lw()-i,i=Lw(),e.callback(),e.loopCount+=1,this.isBreakLoop(e)?void 0:e.timeoutID=setTimeout(r,e.delay-Math.floor(t%e.delay))):(t=Lw()-i,t>=e.delay&&(i=Lw()-Math.floor(t%e.delay),e.callback(),e.loopCount+=1),this.isBreakLoop(e)?void 0:e.rafID=requestAnimationFrame(r));if(e.rafID=requestAnimationFrame(r),e.backgroundTask){let t=()=>{if(document.hidden){let t=Lw()-i;t>=e.delay?r():e.timeoutID=setTimeout(r,e.delay-t);}};document.addEventListener("visibilitychange",t),e.onVisibilitychange=t,document.hidden&&t();}return e.taskID}static hasTask(e){return this.taskMap.has(e)}static clearTask(e){if(!this.taskMap.has(e))return !0;let{intervalID:t,timeoutID:i,rafID:r,ricID:n,onVisibilitychange:o,worker:s}=this.taskMap.get(e);return s&&s.terminate(),t&&clearInterval(t),i&&clearTimeout(i),r&&kP(r),n&&bP(n),o&&document.removeEventListener("visibilitychange",o),this.taskMap.delete(e),!0}static isBreakLoop(e){return !this.taskMap.has(e.taskID)||0!==e.count&&e.loopCount>=e.count&&(this.clearTask(e.taskID),!0)}};DP.taskMap=new Map,DP.currentTaskID=1;var NP=DP;Ub.SEI_MESSAGE;var wP={LOADED_DATA:Ub.LOADEDDATA,MEDIA_TRACK_CHANGED:"media-track-changed",PLAYER_STATE_CHANGED:"player-state-changed",ERROR:"error"},OP={};xC(OP,{create:()=>MP,remove:()=>LP});var PP=new WeakMap;function MP(e,t){PP.has(e)||PP.set(e,[]);let i=PP.get(e),r={add:(e,n)=>("addEventListener"in t?(i.push(t.removeEventListener.bind(t,e,n)),t.addEventListener(e,n)):(i.push(t.off.bind(t,e,n)),t.on(e,n)),r)};return r}function LP(e){let t=PP.get(e);t&&(t.forEach((e=>e())),PP.delete(e));}var xP=new WeakMap;function VP(e){let{settings:t={retries:5,timeout:2e3},onError:i,onRetrying:r,onRetryFailed:n}=e;return function(e,o,s){let a=HN({retryFunction:s.value,settings:t,onError(t){let{error:r,retry:n,reject:s,retryFuncArgs:a}=t;var c;i?i.call(this,r,(()=>{var t;null!=(t=xP.get(e))&&t.has(o)?n():s(r);}),s,a):null!=(c=xP.get(e))&&c.has(o)?n():s(r);},onRetrying(t,i){var n;UN(r)&&r.call(this,t,i),null!=(n=xP.get(e))&&n.has(o)&&(xP.get(e).get(o).stopRetry=i);},onRetryFailed:n});return s.value=function(){let t=xP.get(e);for(var i=arguments.length,r=new Array(i),n=0;n<i;n++)r[n]=arguments[n];return t?t.set(o,{args:r}):xP.set(e,new Map([[o,{args:r}]])),a.apply(this,r).finally((()=>{var t;return null==(t=xP.get(e))?void 0:t.delete(o)}))},s}}function UP(e){let{fnName:t,callback:i,validateArgs:r=!0}=e;return function(e,n,o){let s=o.value;return o.value=function(){for(var n,o,a=arguments.length,c=new Array(a),l=0;l<a;l++)c[l]=arguments[l];if(null!=(n=xP.get(e))&&n.has(t)){let{stopRetry:n,args:s}=xP.get(e).get(t),a=!0;if(r)for(let e of s)if(!c.find((t=>t===e))){a=!1;break}a&&(i&&i.apply(this,c),n&&n(),null==(o=xP.get(e))||o.delete(t));}return s.apply(this,c)},o}}var FP=class extends AP{constructor(e,t){super(e.id,"".concat(t,"-player")),this.kind=t,FC(this,"id"),FC(this,"element",null),FC(this,"track"),FC(this,"url"),FC(this,"attr"),FC(this,"muted"),FC(this,"_log"),FC(this,"_pausedRetryCount"),FC(this,"_isElementPlayingFired",!1),FC(this,"_interval"),FC(this,"_delayDestroyTimeoutId",0),FC(this,"_isReplayByRecreateMediaStreamCalled",!1),this.id=e.id,this._log=e.log,this.track=e.track,this.muted=e.muted,this._pausedRetryCount=Nk,this._state="STOPPED",this.bindTrackEvents(),this._log.info("create ".concat(t,"-player ").concat(this.id));}get isPlaying(){var e;return "PLAYING"===this._state&&!1===(null==(e=this.element)?void 0:e.paused)}get isStopped(){return "STOPPED"===this._state}setAttr(e){this.attr=e;}setUrl(e){this.track&&(this.unbindTrackEvents(),this.element&&(this.element.srcObject=null),this.track=null),e!==this.url&&(this.url=e,null!==e&&this.element&&(this.element.crossOrigin="anonymous",this.element.src=e));}play(){return HC(this,null,(function*(){if(!this.isPlaying)try{this._delayDestroyTimeoutId&&(clearTimeout(this._delayDestroyTimeoutId),this._delayDestroyTimeoutId=0,this.bindTrackEvents(),this.bindElementEvents()),this.bindAutoPlayEvent(),yield this.element.play();}catch(db){let t=xN({key:zk.PLAY_FAILED,data:{media:this.kind,error:db}});if(this.track&&!this.track.muted&&this._log.warn(db),t.includes("NotAllowedError"))throw new tb({code:ZC.PLAY_NOT_ALLOWED,message:t})}}))}stop(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;this._isElementPlayingFired=!1,this.unbindEvents(),e>0?this._delayDestroyTimeoutId||(this._log.info("destroy element after 3 * ".concat(e)),this._delayDestroyTimeoutId=setTimeout((()=>this.destroyElement()),3*e)):this.destroyElement(),this.handleStopped(Ub.ENDED),this._interval>0&&NP.clearTask(this._interval);}destroyElement(){this.element&&(this._log.debug("destroy element"),this.element.remove(),this.element.srcObject=null,this.element=null),clearTimeout(this._delayDestroyTimeoutId),this._delayDestroyTimeoutId=0;}pause(){var e;this.isPlaying&&(null==(e=this.element)||e.pause());}resume(){return this._log.info("resume"),this.isPlaying?Promise.resolve():TN?this.replay():this.play().catch((()=>{}))}setMuted(e){this.element&&(this.element.muted=e),this.muted=e;}replay(){return this.stop(),this.play().catch((()=>{}))}bindElementEvents(){if(this.element){let e=this.handleElementEvent.bind(this);return MP(this.element,this.element).add(Ub.PLAYING,e).add(Ub.ENDED,e).add(Ub.PAUSE,e).add(Ub.ERROR,e).add(Ub.LOADEDDATA,e)}}bindTrackEvents(){if(this.track){let e=this.handleTrackEvent.bind(this);null==OP||OP.create(this.track,this.track).add(Ub.ENDED,e).add(Ub.MUTE,e).add(Ub.UNMUTE,e),this.track.readyState===Ub.ENDED&&this.handleTrackEvent({type:Ub.ENDED}),this.track.muted&&this.handleTrackEvent({type:Ub.MUTE});}}bindAutoPlayEvent(){jN.on(nO.AUTOPLAY_DIALOG_CLICK_CONFIRM,this.resume,this);}unbindTrackEvents(){this.track&&LP(this.track);}unbindEvents(){this.element&&LP(this.element),this.unbindTrackEvents(),jN.off(nO.AUTOPLAY_DIALOG_CLICK_CONFIRM,this.resume,this);}handleElementEvent(e){switch(e.type){case Ub.PLAYING:this._isElementPlayingFired=!0,this._log.info("".concat(this.kind," player is playing")),this.handlePlaying(Ub.PLAYING),this._interval&&(NP.clearTask(this._interval),this._interval=-1);break;case Ub.ENDED:this._log.info("".concat(this.kind," player is ended")),this.handleStopped(Ub.ENDED);break;case Ub.PAUSE:this._log.info("".concat(this.kind," player is paused")),this.handlePaused(Ub.PAUSE),sD&&(this._interval=NP.run(Hk,(()=>{this.element&&"PAUSED"===this._state&&this.resume();}),{delay:3e3}));break;case Ub.ERROR:if(this.element&&this.element.error){this.handlePaused(Ub.ERROR);let{code:e,message:t}=this.element.error;this._log.error("".concat(this.kind," ").concat(this._log.isLocal?"local":"remote"," MediaError code: ").concat(e," message: ").concat(t," userAgent: ").concat(navigator.userAgent)),GN.uploadEvent({log:"stat-".concat(this.kind,"-").concat(mk.PLAYER_ERROR,"-").concat(e,"-").concat(navigator.userAgent),error:this.element.error}),this.replayByRecreateMediaStream(this.element.error);}break;case Ub.LOADEDDATA:this.kind===Ub.VIDEO&&this.emit(wP.LOADED_DATA);}}replayByRecreateMediaStream(e){if(!this._isReplayByRecreateMediaStreamCalled)return this._isReplayByRecreateMediaStreamCalled=!0,this.doReplayByRecreateMediaStream(1e3).then((()=>{this._log.warn("replayByRecreateMediaStream success"),GN.uploadEvent({log:"stat-replayByRecreateMediaStream-success"}),IO.addSuccessEvent({key:this.kind===Ub.AUDIO?506700:516700});})).catch((()=>{var t;this._log.error("replayByRecreateMediaStream failed"),GN.uploadEvent({log:"stat-replayByRecreateMediaStream-failed"}),IO.addFailedEvent({key:this.kind===Ub.AUDIO?506700:516700,error:null==(t=this.element)?void 0:t.error}),this.emit(wP.ERROR,e);}))}doReplayByRecreateMediaStream(e){return this._log.warn("delay ".concat(e,"ms to recreate mediaStream")),new Promise(((t,i)=>{tO(e).then((()=>{this.element&&(this.element.srcObject=null,this.element.srcObject=new MediaStream([this.track]),this._log.warn("recreated mediaStream"),this.element.onerror=()=>{var e,t,r;this._log.warn("element onerror ".concat(null==(t=null==(e=this.element)?void 0:e.error)?void 0:t.code," fired after recreated mediaStream")),i(null==(r=this.element)?void 0:r.error);}),tO(5e3).then((()=>{var e,r;(!this.isPlaying||(null==(e=this.element)?void 0:e.error))&&i(null==(r=this.element)?void 0:r.error),t();}));}));})).finally((()=>{this.element&&(this.element.onerror=null);}))}handleTrackEvent(e){switch(e.type){case Ub.ENDED:this.handleStopped(Ub.ENDED);break;case Ub.MUTE:this.handlePaused(Ub.MUTE);break;case Ub.UNMUTE:this._isElementPlayingFired&&this.handlePlaying(Ub.UNMUTE);}}handlePlaying(e){this.emit(wP.PLAYER_STATE_CHANGED,{type:this.kind,state:"PLAYING",reason:e});}handlePaused(e){this.emit(wP.PLAYER_STATE_CHANGED,{type:this.kind,state:"PAUSED",reason:e});}handleStopped(e){this.emit(wP.PLAYER_STATE_CHANGED,{type:this.kind,state:"STOPPED",reason:e});}getElement(){return this.element}};UC([VP({settings:{retries:2,timeout:0},onError(e,t,i,r){r[0]=(r[0]||1e3)+1e3,t();}})],FP.prototype,"doReplayByRecreateMediaStream",1),UC([SP([],"PLAYING",{sync:!0})],FP.prototype,"handlePlaying",1),UC([SP("PLAYING","PAUSED",{ignoreError:!0,sync:!0})],FP.prototype,"handlePaused",1),UC([SP([],"STOPPED",{sync:!0})],FP.prototype,"handleStopped",1);var BP="trtc_autoplay",HP="".concat(BP,"_mask"),jP="".concat(BP,"_wrapper"),WP="".concat(BP,"_header"),GP="".concat(BP,"_content"),JP="".concat(BP,"_action_wrapper"),KP="".concat(BP,"_question"),zP="".concat(BP,"_collapse"),qP="".concat(BP,"_action_confirm"),YP="".concat(BP,"_detail"),QP="#2473E8",XP="dialog",$P="".concat(XP,"-show"),ZP="".concat(XP,"-1"),eM="".concat(XP,"-2"),tM=!1,iM=()=>!!document.querySelector(".".concat(jP)),rM="".concat(Sb,"/").concat(fw()?"zh-cn":"en","/tutorial-21-advanced-auto-play-policy.html"),nM="<br><a href='".concat(rM,"' target='_blank'>").concat(fw()?"其他方案？":"Any other solution?","</a>"),oM="".concat(fw()?"浏览器自动播放策略：在用户与页面产生交互（点击、触摸）之前，浏览器禁止播放有声媒体。该弹窗用于帮助用户恢复音视频播放。".concat(nM):"Autoplay Policy: Before user interacts with the web page (clicking, touching), page will not be allowed to play media with sound. This Dialog is used to help users resume playback. ".concat(nM)),sM=class{constructor(){if(FC(this,"content","音视频播放被浏览器拦截，请点击“恢复播放”。"),FC(this,"_dialogNode",null),FC(this,"_bodyPosition",""),FC(this,"_showDetail",!1),FC(this,"_isCollapseClicked",!1),FC(this,"_isQuestionClicked",!1),fw()||(this.content='Media playback failed. Click the "Resume" to resume playback.'),!tM){let e=document.createElement("style");e.innerHTML=".".concat(HP,"{position:fixed;top:0;left:0;right:0;bottom:0;width:100vw;height:100vh;display:flex;justify-content:center;align-items:center;background:rgba(0,0,0,0.5);z-index:1500;}.").concat(HP," div:not(.").concat(JP,"){display:block !important;}.").concat(jP,"{padding:14px;background:#fff;border-radius:3px;box-shadow:0px 3px 15px #434343;border:1px solid #d1cfcf;max-width:500px;}.").concat(jP," a{color:").concat(QP,";}.").concat(WP,"{overflow:hidden;text-overflow:ellipsis;font-size:16px;font-weight:600;}.").concat(GP,"{margin:8px 0;}.").concat(JP,"{width:100%;display:flex !important;align-items:center;justify-content:right;float:right;}.").concat(zP,"{margin-right:auto;cursor:pointer}.").concat(KP,"{height:100%;line-height:16px;cursor:pointer;}.").concat(qP,"{margin-left:8px;color:#fff;background:").concat(QP,";padding:4px 12px;outline:none;border:1px solid;border-radius:3px;font-weight:bold;}.").concat(qP,":hover{opacity:0.9;}.").concat(zP,",.").concat(qP,",.").concat(GP,",.").concat(KP,"{font-size:14px;}@media screen and (max-width:750px){.").concat(jP,"{width:80vw;}}"),document.head.appendChild(e),tM=!0;}this.addDiaLog();}createDiaLog(){let e=document.createElement("template");e.innerHTML='<div class="'.concat(HP,"\"><div class='").concat(jP,"'><div class='").concat(WP,"'>").concat(location.host,"</div><div class='").concat(GP,"'>").concat(this.content,"</div><div class='").concat(YP,'\' style="visibility:hidden;width:100%;height:0;font-size:12px;color:gray;">').concat(oM,"</div><div class='").concat(JP,"'></div></div></div>").trim();let t=document.createElement("button");t.className=qP,t.innerText=fw()?"恢复播放":"Resume",t.onclick=this.onConfirm.bind(this);let i=document.createElement("div");i.className=KP,i.innerHTML='<?xml version="1.0" encoding="UTF-8"?>\n    <svg class="icon" width="18" height="18" p-id="2030" t="1639646523624" version="1.1" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg">\n    <path d="m464 784.35c0 26.51 21.49 48 48 48s48-21.49 48-48-21.49-48-48-48-48 21.49-48 48z" p-id="2031"/>\n    <path d="m512 960c-247.04 0-448-200.96-448-448s200.96-448 448-448 448 200.96 448 448-200.96 448-448 448zm0-831.71c-211.58 0-383.71 172.13-383.71 383.71 0 211.55 172.13 383.71 383.71 383.71 211.55 0 383.71-172.16 383.71-383.71 0-211.58-172.16-383.71-383.71-383.71z" p-id="2032"/>\n    <path d="m512 673.7c-17.665 0-32.001-14.336-32.001-31.999v-54.112c0-52.353 40-92.352 75.328-127.65 25.887-25.92 52.672-52.672 52.672-74.017 0-53.343-43.072-96.735-95.999-96.735-53.823 0-95.999 41.536-95.999 94.559 0 17.665-14.336 31.999-32.001 31.999s-32.001-14.336-32.001-31.999c0-87.424 71.775-158.56 160-158.56s160 72.095 160 160.74c0 47.904-36.32 84.192-71.424 119.3-27.84 27.776-56.576 56.512-56.576 82.336v54.112c0 17.665-14.336 32.032-32.001 32.032z" p-id="2033"/>\n    </svg>\n    ',i.onclick=this.onQuestionClick.bind(this);let r=document.createElement("div");r.className=zP,r.innerText="".concat(fw()?"详情 >":"Detail >"),r.onclick=this.onCollapseClick.bind(this);let n=e.content.firstChild,o=n.querySelector(".".concat(JP));return o.appendChild(r),o.appendChild(i),o.appendChild(t),n}addDiaLog(){iM()||(this._dialogNode=this.createDiaLog(),document.body.appendChild(this._dialogNode),this._dialogNode.onclick=this.onConfirm.bind(this),this._dialogNode.querySelector(".".concat(jP)).onclick=e=>e.stopPropagation(),this._bodyPosition=document.body.style.position,document.body.style.position="fixed",sO.info("show autoplay dialog"),GN.uploadEvent({log:$P}));}deleteDiaLog(){this._dialogNode&&(document.body.removeChild(this._dialogNode),document.body.style.position=this._bodyPosition,this._dialogNode=null);}onConfirm(){sO.warn("confirm clicked, try resume stream"),jN.emit(nO.AUTOPLAY_DIALOG_CLICK_CONFIRM),this.deleteDiaLog();}onCollapseClick(){let e=this._dialogNode.querySelector(".".concat(YP));e.style.visibility="".concat(this._showDetail?"hidden":"visible"),e.style.height="".concat(this._showDetail?0:"fit-content"),this._showDetail=!this._showDetail,this._isCollapseClicked||GN.uploadEvent({log:ZP}),this._isCollapseClicked=!0;}onQuestionClick(){window.open(rM,"_blank"),this._isQuestionClicked||GN.uploadEvent({log:eM}),this._isQuestionClicked=!0;}},aM=class extends FP{constructor(e){super(e,Ub.VIDEO),FC(this,"viewMirror",!1),FC(this,"objectFit"),FC(this,"container"),FC(this,"canvas"),this.container=e.container,this.canvas=e.canvas,Sw(e.viewMirror)||(this.viewMirror=e.viewMirror),Sw(e.objectFit)||(this.objectFit=e.objectFit),this.initializeElement();}initializeElement(){var e;let t=document.createElement(Ub.VIDEO);this.track&&(t.srcObject=new MediaStream([this.track])),t.muted=!0,t.setAttribute("id","video_".concat(this.id)),t.setAttribute("style",this.styleAttribute),this.canvas&&this.canvas.setAttribute("style",this.styleAttribute),t.setAttribute("autoplay","autoplay"),t.setAttribute("playsinline","playsinline"),this.element=t,null==(e=this.container)||e.appendChild(this.elementToRender),this.bindElementEvents();}get styleAttribute(){let e="width: 100%; height: 100%; object-fit: ".concat(this.objectFit,";background-color: black;");return this.viewMirror&&(e+="transform: scaleX(-1);"),e}setContainer(e){var t;this.container=e,this.track&&this.elementToRender&&(null==(t=this.container)||t.appendChild(this.elementToRender));}bindElementEvents(){let e=super.bindElementEvents();this.handleElementEvent=this.handleElementEvent.bind(this),e&&e.add(Ub.ENTER_PICTURE_IN_PICTURE,this.handleElementEvent).add(Ub.LEAVE_PICTURE_IN_PICTURE,this.handleElementEvent);}handleElementEvent(e){var t;super.handleElementEvent(e);let i=e.type;if(i===Ub.PAUSE&&(this.container&&document.getElementById(this.container.id)||this._log.warn("".concat(this.kind," player has been remove, element ID: ").concat(null==(t=this.container)?void 0:t.id)),this._pausedRetryCount>0&&!iM()&&(this._log.info("".concat(this.kind," player auto resume when paused")),this.resume(),this._pausedRetryCount--)),this.viewMirror&&this.element){let e=this.element.style.transform;i===Ub.ENTER_PICTURE_IN_PICTURE?this.element.style.transform=e.replace("scaleX(-1)",""):i===Ub.LEAVE_PICTURE_IN_PICTURE&&!e.includes("scaleX")&&(this.element.style.transform="".concat(e," scaleX(-1)"));}}setCanvas(e){var t,i;this.canvas!==e&&(null==(t=this.canvas)||t.remove(),null==e||e.setAttribute("style",this.styleAttribute),this.canvas=e,e&&(null==(i=this.container)||i.appendChild(e)));}setAttr(e){let t=Object.assign({autoplay:"autoplay",playsinline:"playsinline",muted:!0},e);t.style=Object.assign({width:"100%",height:"100%"},t.style),super.setAttr(t);}get mirror(){return this.viewMirror}setRect(e,t){this.elementToRender&&(this.elementToRender.style.width="".concat(e,"px"),this.elementToRender.style.height="".concat(t,"px"));}setViewMirror(e){this.elementToRender&&(this.elementToRender.style.transform=e?"scaleX(-1)":""),this.viewMirror=e;}setObjectFit(e){this.elementToRender&&(this.elementToRender.style.objectFit="".concat(e)),this.objectFit=e;}stop(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;var t;super.stop(e),null==(t=this.canvas)||t.remove();}play(){return this.element?this.elementToRender&&this.elementToRender.parentElement!==this.container&&this.container&&this.container.append(this.elementToRender):this.initializeElement(),super.play()}get elementToRender(){return this.canvas||this.element}setTrack(e){e!==this.track&&(this.unbindTrackEvents(),this.track=e,this.emit(wP.MEDIA_TRACK_CHANGED,e),null!==e&&(this.bindTrackEvents(),this.element&&(this.element.srcObject=new MediaStream([e]),this.element.remove()),this.elementToRender&&this.elementToRender.parentElement!==this.container&&this.container&&this.container.append(this.elementToRender)));}getVideoFrame(){if(this.canvas)return this.canvas.toDataURL("image/png");if(!this.element)return "";let e=document.createElement("canvas");return e.width=this.element.videoWidth,e.height=this.element.videoHeight,e.getContext("2d").drawImage(this.element,0,0),e.toDataURL("image/png")}getElement(){return this.element}};function cM(e,t){return HC(this,null,(function*(){if(!e.audioWorklet)return Promise.reject("audioWorklet is not supported");try{yield e.audioWorklet.addModule(t),sO.info("worklet addModule success");}catch(db){throw sO.info("worklet addModule catch error. ".concat(db.message)),db}}))}"undefined"!=typeof window&&(window.AudioContext=window.AudioContext||window.webkitAudioContext||window.mozAudioContext);var lM=new window.AudioContext({sampleRate:48e3}),dM=()=>{"suspended"===lM.state?(lM.resume(),document.addEventListener("click",dM)):"interrupted"===lM.state?lM.resume():document.removeEventListener("click",dM);};document.addEventListener("click",dM),lM.onstatechange=()=>{sO.info("context state: ".concat(lM.state)),dM();};var uM=e=>lM,hM=class{constructor(){this.pre=new Set,this.next=new Set,this.connectedNodes=new Set,this._channelCount=1;}get channelCount(){return this._channelCount}set channelCount(e){this._channelCount=e,this.node&&(this.node.channelCount=e),this.next.forEach((t=>t.channelCount=e));}setContext(e){this.context=e,this.node&&e.addMixWeight();}removeContext(){var e;this.node&&(null==(e=this.context)||e.reduceMixWeight()),delete this.context;}setNode(e){var t;if(!this.node)try{null==(t=this.context)||t.addMixWeight(),this.node=e,this.node.channelCountMode="explicit",this.node.channelCount=this._channelCount,this.preNodeReconnect(),this.reconnect(),IO.addSuccessEvent({key:502701});}catch(hk){sO.error(hk),IO.addFailedEvent({key:502701,error:hk});}}deleteNode(){var e;if(this.node)try{this._disconnect(),delete this.node,null==(e=this.context)||e.reduceMixWeight(),this.preNodeReconnect(),IO.addSuccessEvent({key:502702});}catch(db){sO.error(db),IO.addFailedEvent({key:502702,error:db});}}preNodeReconnect(){this.pre.forEach((e=>{e.node?e.reconnect():e.preNodeReconnect();}));}connectNext(e){this.next.forEach((t=>e._connect(t.node)||t.connectNext(e)));}_connect(e){return !(!this.node||!e)&&(this.node.connect(e),this.connectedNodes.add(e),!0)}_disconnect(){this.connectedNodes.forEach((e=>{var t;return null==(t=this.node)?void 0:t.disconnect(e)})),this.connectedNodes.clear();}reconnect(){this._disconnect(),this.connectNext(this);}pipeTo(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];return t.forEach((e=>{this.next.add(e),e.pre.add(this);})),this}},pM=class extends hM{constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:256;super(),this.fftSize=e,this.dataArray=new Uint8Array(0);}setNode(e){e.fftSize=this.fftSize,this.dataArray=new Uint8Array(e.frequencyBinCount),super.setNode(e);}getByteTimeDomainData(){var e;return null==(e=this.node)||e.getByteTimeDomainData(this.dataArray),this.dataArray}get level(){var e;return null==(e=this.node)||e.getByteTimeDomainData(this.dataArray),Math.max(...this.dataArray)/128-1}get timeDomainPathData(){let e=this.getByteTimeDomainData(),t=0,i=0,r="M".concat(t,",").concat(i);for(let n=0;n<e.length;n++)i=e[n]/128*100/2,r+="L".concat(t,",").concat(i),t+=1;return r}},mM=class{constructor(){this.source=new hM,this.gain=new hM,this.destination=new hM;}get volume(){var e;return (null==(e=this.gain.node)?void 0:e.gain.value)||1}setVolume(e){1!==e?(this.gain.node||this.gain.setNode(this.source.node.context.createGain()),this.gain.node.gain.value=e):this.gain.node&&this.gain.deleteNode();}replaceSource(e){this.source.deleteNode(),this.source.setNode(TM(e));}get track(){var e;return null==(e=this.stream)?void 0:e.getAudioTracks()[0]}get stream(){var e;return null==(e=this.destination.node)?void 0:e.stream}},_M=class extends mM{constructor(e){super(),this.context=e,this.denoiser=new hM,this.source.pipeTo(this.denoiser.pipeTo(this.gain.pipeTo(this.destination)));}connect(){this.context.inputs.has(this)||(this.destination.setNode(this.context.destination),this.source.setContext(this.context),this.denoiser.setContext(this.context),this.gain.setContext(this.context),this.context.inputs.add(this));}disconnect(){!this.context.inputs.has(this)||(this.destination.deleteNode(),this.source.removeContext(),this.denoiser.removeContext(),this.gain.removeContext(),this.context.inputs.delete(this));}remove(){this.gain.deleteNode(),this.denoiser.deleteNode(),this.source.deleteNode(),this.disconnect();}setVolume(e){1!==e?(this.gain.node||this.gain.setNode(this.context.audioContext.createGain()),this.gain.node.gain.value=e):this.gain.node&&this.gain.deleteNode();}},fM=class{constructor(){this.audioContext=uM(),this.destination=this.audioContext.createMediaStreamDestination(),this.inputs=new Set,this.mixWeight=0;}addMixWeight(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1;this.mixWeight+=e,this.mixWeight-1==e+1>>1&&this.mixOnChange();}reduceMixWeight(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1;this.addMixWeight(-e);}close(){this.inputs.forEach((e=>e.remove()));}get mixTrack(){return this.destination.stream.getAudioTracks()[0]}},gM=new WeakMap;function TM(e){let t=gM.get(e);if(t)return t;let i=uM();if(e instanceof HTMLAudioElement)t=i.createMediaElementSource(e);else {if(!(e instanceof MediaStreamTrack))return e;t=i.createMediaStreamSource(new MediaStream([e]));}return gM.set(e,t),t}window.AudioWorkletProcessor||(window.AudioWorkletProcessor=class{constructor(){FC(this,"port");}});var EM=class extends AudioWorkletProcessor{constructor(){super(),this.volume=0,this.intervalTime=200,this.tick=200,this.isStop=!1,this.cache=[],this.sentFirstInfo1=!1,this.unmute=!1,this.port.onmessage=e=>{let{data:t}=e;switch(t.name){case"chunk":this.cache.push.apply(this.cache,t.data),this.sentFirstInfo1||(this.port.postMessage({cl:t.data.length}),this.sentFirstInfo1=!0);break;case"setIntervalTime":this.intervalTime=t.intervalTime;break;case"unmute":this.unmute=!0;break;case"stop":this.isStop=!0;}};}process(e,t){let i=e[0],r=t[0];if(!i&&!r)return !0;if(this.isStop)return !1;let n=r?r[0].length:0,o=this.cache.length;o>n?(r[0].set(this.cache.slice(0,n)),this.cache=this.cache.slice(n)):this.unmute&&r[0].set(i[0]);let s=o>n?r[0]:i[0];if(!s)return !0;let a=0;for(let c=0;c<s.length;++c)a=Math.max(Math.abs(s[c]),a);return this.volume=a,this.tick-=s.length,this.tick<0&&(this.tick+=this.intervalTime/1e3*sampleRate,this.port.postMessage({volume:this.volume,cacheLen:o,outputLen:n})),!0}},vM=EM.toString();delete window.AudioWorkletProcessor;var yM=class{constructor(e){this._volume=0,this._scriptProcessorNode=null,this._audioWorkletNode=null,this._interval=200,this.ready=this.preload();let{log:t}=e;this._log=t,jN.on(nO.AUDIO_LEVEL_INTERVAL,this.handleAudioLevelInterval,this);}static get isRunning(){return Date.now()-yM.lastMessageTime<2e3}get node(){return this._audioWorkletNode||this._scriptProcessorNode}preload(){if(!yM.workletReady){let e="".concat(vM.slice(0,5)," VolumeMeterWorklet ").concat(vM.slice(6),";registerProcessor('volume-meter', VolumeMeterWorklet);");yM.workletReady=cM(yM.audioContext,URL.createObjectURL(new Blob([e],{type:"application/javascript"})));}return yM.workletReady.then((()=>this.initAudioWorklet())).catch((e=>(this._log.error("volumeMeter preload error: ".concat(e)),this.initScriptProcessor())))}initAudioWorklet(){if(!this._audioWorkletNode)try{this._audioWorkletNode=new AudioWorkletNode(yM.audioContext,"volume-meter");let e=!1;this._audioWorkletNode.port.onmessage=t=>{yM.lastMessageTime=Date.now(),this._volume=t.data.volume||0,!e&&t.data.cacheLen&&t.data.outputLen&&(this._log.warn("worklet play success"),e=!0);},this.handleAudioLevelInterval({interval:this._interval});}catch(hO){this._log.error("volumeMeter init audio worklet error: ".concat(hO)),GN.logFailedEvent({userId:this._log.userId,eventType:mk.LOAD_WORKLET,error:hO}),this.initScriptProcessor();}}initScriptProcessor(){if(!this._scriptProcessorNode)try{this._scriptProcessorNode=uM("volume-meter").createScriptProcessor(2048,1,1),this._scriptProcessorNode.onaudioprocess=e=>{yM.lastMessageTime=Date.now();let t=e.inputBuffer.getChannelData(0),i=0;for(let r=0;r<t.length;++r)i+=t[r]*t[r];this._volume=Math.sqrt(i/t.length)||0;};}catch(hO){this._log.error("volumeMeter init script processor error: ".concat(hO));}}destroy(){this._scriptProcessorNode&&(this._scriptProcessorNode.onaudioprocess=null),this._audioWorkletNode&&(this._audioWorkletNode.port.postMessage({name:"stop"}),this._audioWorkletNode.port.onmessage=null),this._audioWorkletNode=null,this._scriptProcessorNode=null,jN.off(nO.AUDIO_LEVEL_INTERVAL,this.handleAudioLevelInterval,this);}getInternalAudioLevel(){return this._volume}getCalculatedVolume(){return parseFloat(this._volume.toFixed(2))}handleAudioLevelInterval(e){var t;let{interval:i}=e;this._interval=i,null==(t=this._audioWorkletNode)||t.port.postMessage({name:"setIntervalTime",intervalTime:i});}},SM=yM;SM.lastMessageTime=0,SM.audioContext=uM();var IM=class extends hM{constructor(e){super(),this._volumeMeter=new SM(e);}deleteNode(){super.deleteNode(),this._volumeMeter.destroy();}init(){return HC(this,null,(function*(){yield this._volumeMeter.preload(),this.setNode(this._volumeMeter.node);}))}getCalculatedVolume(){return this._volumeMeter.getCalculatedVolume()}getInternalAudioLevel(){return this._volumeMeter.getInternalAudioLevel()}write(e){if(this.node){let t=e.allocationSize({planeIndex:0}),i=new Float32Array(t>>2);e.copyTo(i,{planeIndex:0}),this.node.port.postMessage({name:"chunk",data:i},[i.buffer]),e.close();}}},RM=SM,AM=VC(jC(),1),CM=e=>t=>t.deviceId===e,bM=class{constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"Input";FC(this,"kind"),FC(this,"type"),FC(this,"devices",[]),this.kind=e,this.type=t;}update(e,t){let i=e.filter((e=>e.kind==="".concat(this.kind).concat(this.type.toLocaleLowerCase())));1===this.devices.length&&NM(this.devices[0])||t&&(i.forEach((e=>{if(e.deviceId&&!this.devices.find(CM(e.deviceId))){let i="".concat(this.kind).concat(this.type,"Added");sO.warn("".concat(i,": ").concat(JSON.stringify(e))),t.emit(i,e);}})),this.devices.forEach((e=>{if(e.deviceId&&!i.find(CM(e.deviceId))){let i="".concat(this.kind).concat(this.type,"Removed");sO.warn("".concat(i,": ").concat(JSON.stringify(e))),t.emit(i,e);}}))),this.devices=i;}hasDevice(e){return !!this.devices.find((t=>t.deviceId===e))}},kM=class extends AM.EventEmitter{constructor(){super(),FC(this,"audioInputs",new bM(Ub.AUDIO)),FC(this,"videoInputs",new bM(Ub.VIDEO)),FC(this,"audioOutputs",new bM(Ub.AUDIO,"Output")),this.init(),navigator.mediaDevices&&(navigator.mediaDevices.addEventListener&&navigator.mediaDevices.addEventListener("devicechange",(()=>this.update())),"ondevicechange"in navigator.mediaDevices||NP.run(Bk,(()=>{this.update();}),{delay:1e4}));}init(){wM().then((e=>{this.audioInputs.update(e),this.videoInputs.update(e),this.audioOutputs.update(e);}));}update(){return HC(this,arguments,(function(){var e=this;let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;return function*(){let i=yield wM(t);return e.audioInputs.update(i,e),e.videoInputs.update(i,e),e.audioOutputs.update(i,e),e}()}))}},DM=mb||pb?null:new kM;function NM(e){return e.deviceId===e.groupId&&""===e.groupId}function wM(){return HC(this,arguments,(function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;return function*(){if(wO()||!DO())return [];let t=yield navigator.mediaDevices.enumerateDevices();if(0!==e){let i={audio:!1,video:!1};if(t.forEach((e=>{NM(e)&&(e.kind===Ub.AUDIO_INPUT?i.audio=!0:e.kind===Ub.VIDEO_INPUT&&(i.video=!0));})),2===e&&(i.audio=!1),1===e&&(i.video=!1),i.audio||i.video){let e;try{e=yield navigator.mediaDevices.getUserMedia(i);}catch(ub){sO.debug("capture before getDevices failed: ",ub);}t=yield navigator.mediaDevices.enumerateDevices(),null==e||e.getTracks().forEach((e=>e.stop()));}}return t.map(((e,t)=>{let i={kind:e.kind,deviceId:e.deviceId,groupId:e.groupId,label:e.label||"".concat(e.kind,"_").concat(t)};return e.deviceId.length>0&&xM.add("".concat(e.deviceId,"_").concat(e.kind)),e.getCapabilities&&(i.getCapabilities=()=>e.getCapabilities()),i}))}()}))}function OM(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];return DM.update(e?1:0).then((e=>e.audioInputs.devices))}function PM(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];return DM.update(e?2:0).then((e=>e.videoInputs.devices))}var MM=!1;function LM(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];return HC(this,null,(function*(){return DM.update(e?1:0).then((e=>e.audioOutputs.devices))}))}var xM=new Set;function VM(e,t){return HC(this,null,(function*(){let i=(yield OM()).find((e=>e.deviceId===wk));return !t&&(null==i?void 0:i.groupId)===e||(null==i?void 0:i.groupId)===e&&i.label===t}))}var UM,FM=class extends mM{constructor(e){super(),this.log=e,FC(this,"volumeMeter"),FC(this,"volumeDestination"),FC(this,"analyser",new pM),this.volumeMeter=new IM({log:this.log}),this.volumeDestination=new hM,this.volumeMeter.pipeTo(this.volumeDestination);}destory(){this.gain.deleteNode(),this.volumeMeter.deleteNode(),this.analyser.deleteNode(),this.source.deleteNode(),this.destination.deleteNode(),this.volumeDestination.deleteNode();}},BM=class extends FP{constructor(e){super(e,Ub.AUDIO),FC(this,"_outputDeviceId"),FC(this,"_volume",1),FC(this,"_destination",uM().createMediaStreamDestination()),FC(this,"pipeline"),FC(this,"volumeMeterMode","worklet"),this.pipeline=new FM(this._log);}getMediaStream(){return this.pipeline.stream||(this.track?new MediaStream([this.track]):null)}initializeElement(){if(("15.2"===_N||"15.3"===_N||"15.4"===_N)&&this.muted)return void this._log.info("audioElement is muted.");let e=UM||new Audio;e.setAttribute("autoplay","autoplay"),e.srcObject=this.getMediaStream(),e.muted=this.muted,this.element=e,e===UM&&(UM=void 0),this.bindElementEvents();}play(){return HC(this,null,(function*(){if(this.track)return this.pipeline.source.node||this.pipeline.replaceSource(this.track),this.element||this.initializeElement(),this._outputDeviceId&&(yield this.setSinkId(this._outputDeviceId)),"worklet"===this.volumeMeterMode?this.pipeline.volumeMeter.init():"analyser"===this.volumeMeterMode&&this.pipeline.analyser.setNode(uM().createAnalyser()),this.setVolume(this._volume),function(){HC(this,null,(function*(){try{MM||(MM=!0,sO.info("speakers:".concat((yield LM()).map((e=>" ".concat(e.deviceId.slice(0,8),": ").concat(e.label))))));}catch(sx){}}));}(),BC(BM.prototype,this,"play").call(this)}))}stop(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;this.pipeline.destory(),super.stop(e);}setSinkId(e){return HC(this,null,(function*(){var t,i;this._outputDeviceId!==e&&(this._outputDeviceId=e),this.element&&this.element.sinkId!==e&&(yield null==(i=(t=this.element).setSinkId)?void 0:i.call(t,e));}))}get useDestination(){return !!this.pipeline.stream}setLoop(e){!this.element||(this.element.loop=e);}getAudioLevel(){return this.pipeline.volumeMeter.getCalculatedVolume()}getInternalAudioLevel(){return this.pipeline.volumeMeter.getInternalAudioLevel()}},HM=class extends BM{constructor(e){super(e),this.pipeline.source.pipeTo(this.pipeline.volumeMeter,this.pipeline.destination);}setTrack(e){var t;this.track!==e&&(this.unbindTrackEvents(),this.track=e,this.emit(wP.MEDIA_TRACK_CHANGED,e),e?(this.bindTrackEvents(),this.pipeline.source.channelCount=(null==(t=e.getSettings())?void 0:t.channelCount)||1,this.pipeline.replaceSource(e),!this.useDestination&&this.element&&(this.element.srcObject=new MediaStream([e]))):this.pipeline.source.deleteNode());}setSourceNode(e){!e||this.pipeline.source.node===e||(this.pipeline.replaceSource(e),e instanceof MediaStreamAudioSourceNode?this.pipeline.destination.setNode(this._destination):this.pipeline.destination.deleteNode(),this.element&&(this.element.srcObject=this.getMediaStream(),this.element.play().catch((()=>{})),this.setVolume(this._volume)));}setVolume(e){this._volume=e,this.element&&(this.element.volume=e);}},jM=class extends BM{constructor(e){super(e),FC(this,"_sourceElement"),FC(this,"_output",new hM),this.pipeline.source.pipeTo(this.pipeline.gain.pipeTo(this.pipeline.volumeMeter.pipeTo(this._output),this.pipeline.destination));}setOutput(){this._output.setNode(uM().destination);}write(e){this.pipeline.volumeMeter.write(e);}setTrack(e){var t,i,r;(null==(i=null==(t=this.element)?void 0:t.error)?void 0:i.code)!==MediaError.MEDIA_ERR_DECODE&&this.track!==e&&(this.unbindTrackEvents(),this.track=e,this.emit(wP.MEDIA_TRACK_CHANGED,e),e?(this.bindTrackEvents(),this._sourceElement?this._sourceElement.srcObject=new MediaStream([e]):!this.useDestination&&this.element&&(this.element.srcObject=new MediaStream([e])),this.pipeline.source.channelCount=(null==(r=e.getSettings())?void 0:r.channelCount)||1,this.pipeline.replaceSource(e)):this.pipeline.source.deleteNode());}setVolume(e){this._volume=e,this.useDestination?(this.pipeline.setVolume(e),this._log.info("set pipeline volume: ".concat(e))):e<=1?(this.element?this._log.info("set element volume: ".concat(e)):this._log.info("set element volume: no element"),this.element&&(this.element.volume=e)):(this._log.info("start set pipeline volume: ".concat(e)),this.pipeline.setVolume(e),this.element&&!this._sourceElement&&(this.pipeline.destination.setNode(this._destination),LP(this.element),this._sourceElement=this.element,this._sourceElement.muted=!0,this.element=null,this.play()));}stop(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;this.pipeline.destory();let t=this._sourceElement||this.element;t&&hN&&(UM=t),this._sourceElement&&(this._sourceElement.srcObject=null,delete this._sourceElement),super.stop(e);}},WM=class extends AP{constructor(e){let{userId:t,sdkAppId:i,mediaType:r,room:n,PlayerClass:o=(1===r?jM:aM)}=e;var s;super(),FC(this,"id",aO()),FC(this,"userId",""),FC(this,"isRemote"),FC(this,"mediaType"),FC(this,"room"),FC(this,"user"),FC(this,"_log"),FC(this,"_inputTrack"),FC(this,"_outputTrack"),FC(this,"isPlayCalled"),FC(this,"container",null),FC(this,"player"),FC(this,"subVideoPlayerMap"),FC(this,"muted",!1),FC(this,"abortCtrl"),FC(this,"objectFit","cover"),FC(this,"mirror"),FC(this,"isScreen",!1),FC(this,"manager"),FC(this,"trackSettings"),this.userId=t||"",this.mediaType=r,this._log=sO.createLogger({id:"".concat(this.kind[0],"t"),userId:null==(s=n||this.room)?void 0:s.userId,remoteUserId:this instanceof dL?void 0:this.userId,sdkAppId:i,type:2===this.mediaType?"auxiliary":"main",isLocal:this instanceof dL}),this.player=new o({id:this.userId||this.id,track:null,muted:!1,container:null,log:this._log}),this.player.on(wP.PLAYER_STATE_CHANGED,(e=>{jN.emit(nO.PLAYER_STATE_CHANGED,PC({track:this},e)),this.emit("player-state-changed",e);})),this.kind===Ub.VIDEO&&(this.player.on(wP.LOADED_DATA,(()=>{jN.emit(nO.VIDEO_LOADED_DATA,{track:this});})),this.player.on(wP.MEDIA_TRACK_CHANGED,(e=>{var t;null==(t=this.subVideoPlayerMap)||t.forEach((t=>t.setTrack(e)));}))),this.onTrackMuted=this.onTrackMuted.bind(this),this.onTrackUnmuted=this.onTrackUnmuted.bind(this),this.onTrackEnded=this.onTrackEnded.bind(this),this.onPlayerError&&this.player.on(wP.ERROR,this.onPlayerError.bind(this));}get log(){return this._log||sO}get kind(){return 1===this.mediaType?Ub.AUDIO:Ub.VIDEO}get strMediaType(){return 4===this.mediaType?Ub.VIDEO:2===this.mediaType?Ub.SCREEN:Ub.AUDIO}get streamType(){return 2&this.mediaType?"auxiliary":"main"}get isMediaTrackActive(){return !!this.mediaTrack&&(!this.mediaTrack.muted&&"live"===this.mediaTrack.readyState&&this.mediaTrack.enabled)}play(e,t){return HC(this,null,(function*(){let i=bw(e)?e[0]:e;if(this.isPlayCalled)return this.log.info("play update options: ".concat(JSON.stringify(t))),t&&!Sw(t.muted)&&this.setPlayerMute(t.muted),t&&!Sw(t.objectFit)&&(this.objectFit=t.objectFit),void(this.player instanceof aM&&(this.player.setObjectFit(this.objectFit),this.container!==i&&i&&(this.container=i,this.player.setContainer(i)),bw(e)&&e.length>=1&&(yield this.playSubContainer(e.slice(1),t))));if(t&&!Sw(t.muted)?this.setPlayerMute(t.muted):(!this.isRemote||this.kind===Ub.VIDEO)&&this.setPlayerMute(!0),t&&!Sw(t.objectFit)&&(this.objectFit=t.objectFit),this.player instanceof aM&&this.player.setObjectFit(this.objectFit),this.isPlayCalled=!0,i&&(this.container=i,this.player instanceof aM&&this.player.setContainer(i)),jN.emit(nO.PLAY_TRACK_START,{track:this}),this._outputTrack){this._log.info("play with options: ".concat(JSON.stringify(t)));try{this.player.setTrack(this.playerMediaTrack),yield this.player.play(),bw(e)&&e.length>1&&(yield this.playSubContainer(e.slice(1),t));}catch(r){throw this.handleAutoPlayFailed(),this.emit("error",r),r}}else this.log.info("play has not mediaTrack, abort");}))}setMirror(e,t){if(this.isScreen||this.kind!==Ub.VIDEO||Sw(e)||e===this.mirror)return;this.mirror=e;let i=this.player;t&&(i=t);let r=this.manager;if(Aw(this.mirror))return i.setViewMirror(this.mirror),void(r&&(r.mirror=!1));switch(this.mirror){case"view":r&&(r.mirror=!1),i.setViewMirror(!0);break;case"publish":r&&(r.mirror=!0),i.setViewMirror(!0);break;case"both":r&&(r.mirror=!0),i.setViewMirror(!1);}}playSubContainer(e,t){return HC(this,null,(function*(){if(!this._outputTrack||this.kind===Ub.AUDIO)return;this.subVideoPlayerMap||(this.subVideoPlayerMap=new Map),this.subVideoPlayerMap.forEach(((t,i)=>{var r;e.find((e=>i===e))||(t.stop(),null==(r=this.subVideoPlayerMap)||r.delete(i));}));for(let[r,n]of e.entries()){let e=this.subVideoPlayerMap.get(n);e?t&&(Sw(t.objectFit)||e.setObjectFit(t.objectFit)):this.subVideoPlayerMap.set(n,new aM({id:this.userId||this.id,track:this.playerMediaTrack,container:n,muted:this.player.muted,objectFit:this.objectFit,log:this.log.createChild({id:"vp-sub".concat(r+1)})}));}let i=[...this.subVideoPlayerMap.values()];for(let e of i)e.setViewMirror(this.player.mirror),yield e.play();}))}setAudioOutput(e){return this.player.setSinkId(e)}setAudioVolume(e){this.player.setVolume(e);}getAudioLevel(){return this.player.getAudioLevel()||0}getInternalAudioLevel(){var e;return (null==(e=this.player)?void 0:e.getInternalAudioLevel())||0}stop(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];!this.isPlayCalled||(this.isPlayCalled=!1,this.player&&(this.log.info("stop ".concat(this.kind," player")),this.player.stop(Dw(this)&&!e?this.jitterBufferDelay:0)),this.subVideoPlayerMap&&this.subVideoPlayerMap.size>0&&this.subVideoPlayerMap.forEach((e=>{e.stop();})),this.container=null);}resume(){return HC(this,null,(function*(){var e;!this.isPlayCalled||(yield null==(e=this.player)?void 0:e.resume());}))}close(){this.log.info("close"),this.isPlayCalled&&this.stop(!0);}setMute(e){this.muted=e,this._inputTrack&&(this._inputTrack.enabled=!e),this._outputTrack&&(this._outputTrack.enabled=!e),this.emit(e?"mute":"unmute",this),jN.emit(e?nO.TRACK_MUTED:nO.TRACK_UNMUTED,{track:this});}setPlayerMute(e){this.player.setMuted(e);}get mediaTrack(){return this._inputTrack||null}get outMediaTrack(){return this._outputTrack||null}get playerMediaTrack(){return this.outMediaTrack}installTrackEvent(e){MP(e,e).add(Ub.MUTE,this.onTrackMuted).add(Ub.UNMUTE,this.onTrackUnmuted).add(Ub.ENDED,this.onTrackEnded),e.muted&&this.onTrackMuted(),e.readyState===Ub.ENDED&&this.onTrackEnded();}uninstallTrackEvent(e){LP(e);}setInputMediaStreamTrack(e){var t;let i=this._inputTrack;if(e!==i)return this._inputTrack=e,this.trackSettings=null==(t=e.getSettings)?void 0:t.call(e),e.enabled=!this.muted,i&&this.uninstallTrackEvent(i),this.installTrackEvent(e),this.emit("input-media-track-changed",e||null,i||null),this.manager?this.manager.changeInput(this):this.setOutputMediaStreamTrack(e)}setOutputMediaStreamTrack(e){var t;e!==this._outputTrack&&(this.isRemote?this.log.debug("setOutputMediaStreamTrack",e.label):this.log.info("setOutputMediaStreamTrack",null==(t=e.getSettings)?void 0:t.call(e).deviceId,e.label),this._outputTrack=e,this._inputTrack&&(this._outputTrack.contentHint=this._inputTrack.contentHint,this._outputTrack.enabled=this._inputTrack.enabled),this.updatePlayingState(!!e),this.emit("output-media-track-changed",e));}setMediaType(e){this.mediaType=e;}updatePlayingState(e){if(this.isPlayCalled)if(e){if(this.player.setTrack(this.playerMediaTrack),this.player.isStopped)return this.player.play().catch((()=>this.handleAutoPlayFailed())),void this.log.info("playing state updated, play ".concat(this.kind))}else if(!this.player.isStopped)return this.player.stop(Dw(this)?this.jitterBufferDelay:0),void this.log.info("playing state updated, stop ".concat(this.kind));this.log.debug("updatePlayingState abort ".concat(this.isPlayCalled," ").concat(e," ").concat(this.player.isStopped));}handleAutoPlayFailed(){if(this.room&&this.room.enableAutoPlayDialog)new sM;else {let e=()=>{this.resume().then((()=>{document.removeEventListener("click",e,!0);}));};document.addEventListener("click",e,!0);}}getVideoFrame(){return this.player instanceof aM?this.player.getVideoFrame():""}onTrackMuted(){this._log.warn("".concat(this.kind," track is unable to provide media output"));}onTrackUnmuted(){this._log.info("".concat(this.kind," track is able to provide media output"));}onTrackEnded(){this._log.warn("".concat(this.kind," track ended"));}};UC([SP([],AP.INIT,{sync:!0})],WM.prototype,"close",1);var GM=Object.prototype.hasOwnProperty;var JM=function(e){if(null==e)return !0;if("boolean"==typeof e)return !1;if("number"==typeof e)return 0===e;if("string"==typeof e||"function"==typeof e||Array.isArray(e))return 0===e.length;if(e instanceof Error)return ""===e.message;if(gw(e))switch(Object.prototype.toString.call(e)){case"[object File]":case"[object Map]":case"[object Set]":return 0===e.size;case"[object Object]":for(let t in e)if(GM.call(e,t))return !1;return !0}return !1},KM=HN({retryFunction:function(e){return HC(this,null,(function*(){let t=function(e){return {audio:qM(e),video:YM(e)}}(e);sO.info("getUserMedia with constraints: ".concat(JSON.stringify(t)));let i=[],r=[],n=["label","deviceId"];t.audio&&(i=yield OM(),sO.info("microphones: ".concat(qw(i,{keysToInclude:n})))),t.video&&(r=yield PM(),sO.info("cameras: ".concat(qw(r,{keysToInclude:n}))));try{let e=yield navigator.mediaDevices.getUserMedia(t);return nP&&e.getTracks().forEach((e=>{sO.info("".concat(e.kind," capabilities: ").concat(qw(e.getCapabilities(),{keysToInclude:jk})));})),e}catch(o){let{message:t}=o;throw "NotFoundError"===o.name&&(e.video&&r&&0===r.length&&(t=xN({key:zk.CAMERA_NOT_FOUND})),e.audio&&i&&0===i.length&&(t=xN({key:zk.MICROPHONE_NOT_FOUND}))),new tb({code:ZC.INITIALIZE_FAILED,name:o.name,message:t,constraint:o.constraint})}}))},settings:{retries:3,timeout:500},onError:e=>{let{error:t,retry:i,reject:r,retryFuncArgs:n,retriedCount:o}=e,s=o+1;"NotReadableError"===t.name||"OverconstrainedError"===t.name?(1===s?(n[0].video&&(n[0].maxResolution=!1,(!uN||n[0].width*n[0].height<=2073600)&&n[0].frameRate&&(n[0].frameRate=n[0].frameRate>10?10:5)),n[0].retryWhenExactFailed&&n[0].useExactDeviceId&&(n[0].useExactDeviceId=!1)):2===s?n[0].useDeviceIdOnly=!0:3===s&&!n[0].useExactDeviceId&&(n[0].useTrueAsConstraint=!0),i()):r(t),n[0].microphoneId&&zM(n[0].microphoneId,!1),n[0].cameraId&&zM(n[0].cameraId,!0);},onRetrying:e=>{sO.warn("getUserMedia NotReadableError observed, retrying [".concat(e,"/3]"));},onRetryFailed:e=>{GN.logFailedEvent({eventType:mk.GET_USER_MEDIA_RETRY,error:e});},onRetrySuccess:e=>{GN.logSuccessEvent({eventType:mk.GET_USER_MEDIA_RETRY}),GN.uploadEvent({log:"stat-".concat(mk.GET_USER_MEDIA_RETRY,"-success-").concat(e)});}});function zM(e,t){return HC(this,null,(function*(){let i=(t?yield PM():yield OM()).find((t=>t.deviceId===e));i&&yw(i.getCapabilities)&&sO.warn(qw(i.getCapabilities(),{keysToInclude:jk}));}))}function qM(e){if(!e.audio)return !1;if(e.useTrueAsConstraint)return !0;let t={echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0,sampleRate:e.sampleRate};return !JM(e.microphoneId)&&(t.deviceId=e.useExactDeviceId?{exact:e.microphoneId}:e.microphoneId,e.useDeviceIdOnly)?t:(Rw(e.channelCount)&&(t.channelCount=e.channelCount),Aw(e.echoCancellation)&&!e.echoCancellation&&(t.echoCancellation=!1),Aw(e.noiseSuppression)&&!e.noiseSuppression&&(t.noiseSuppression=!1),Aw(e.autoGainControl)&&!e.autoGainControl&&(t.autoGainControl=!1),!!JM(t)||t)}function YM(e){if(!e.video)return !1;if(e.useTrueAsConstraint)return !0;let{maxResolution:t=!0}=e,i={};return e.cameraId?i.deviceId=e.useExactDeviceId?{exact:e.cameraId}:e.cameraId:e.facingMode&&(i.facingMode=e.facingMode),e.useDeviceIdOnly&&!JM(i)?i:(e.width&&(i.width={ideal:e.width},t&&!uD&&(i.width.max=e.width)),e.height&&(i.height={ideal:e.height},t&&!uD&&(i.height.max=e.height)),uD&&jD&&e.width&&e.height&&e.width*e.height<101376&&(i.width=e.width,i.height=e.height),e.frameRate&&(i.frameRate=e.frameRate),!!JM(i)||i)}var QM=KM;function XM(e){return ZM(((t,i)=>function(){for(var i=arguments.length,r=new Array(i),n=0;n<i;n++)r[n]=arguments[n];return HC(this,null,(function*(){return yield e.apply(this,r),t.apply(this,r)}))}))}function $M(e){return ZM(((t,i)=>function(){for(var i=arguments.length,r=new Array(i),n=0;n<i;n++)r[n]=arguments[n];return HC(this,null,(function*(){let i=yield t.apply(this,r);return yield e.call(this,...r),i}))}))}function ZM(e){return function(t,i,r){return r.value=e(r.value,i),r}}var eL=(()=>{let e=!1,t=document.visibilityState;return ()=>{document.visibilityState!==t&&sO.info("visibility change: ".concat(document.visibilityState)),!e&&(document.addEventListener("visibilitychange",(()=>{sO.info("visibility change: ".concat(document.visibilityState)),t=document.visibilityState;})),e=!0);}})(),tL=0,iL=class{constructor(){this.log=sO.createLogger({id:"fq".concat(++tL)}),this.isRunning=!1,this.queue=[];}get length(){return this.queue.length}get lastQueueItem(){return 0===this.length?null:this.queue[this.length-1]}push(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];var i,r;let n=PC({},e),o=new Promise(((e,t)=>{n.resolve=e,n.reject=t;}));return n.promise=o,t?this.length<=1?this.queue.push(n):null==(r=null==(i=this.lastQueueItem)?void 0:i.promise)||r.then(n.resolve,n.reject):this.queue.push(n),this.log.debug("push ".concat(this.length)),this.isRunning||this.callNext(),o}shift(){let e=this.queue.shift();return this.log.debug("shift ".concat(this.length)),e}callNext(){if(this.isRunning||0===this.length)return;this.log.debug("callNext ",this.length);let{fn:e,args:t,context:i,resolve:r,reject:n}=this.queue[0];this.isRunning=!0,e.apply(i,t).then(r,n).finally((()=>{this.isRunning=!1,this.shift(),this.callNext();}));}},rL=new WeakMap,nL=new WeakMap;function oL(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];return function(t,i,r){let n=r.value;return r.value=function(){let t=rL.get(this)||new iL;for(var i=arguments.length,r=new Array(i),o=0;o<i;o++)r[o]=arguments[o];return rL.set(this,t),t.push({fn:n,args:r,context:this},e)},r}}function sL(e){return function(t,i,r){let n=r.value;return r.value=function(){var t,i,r;let o=[];for(var s=arguments.length,a=new Array(s),c=0;c<s;c++)a[c]=arguments[c];return null==(i=null==(t=rL.get(this))?void 0:t.queue)||i.forEach((e=>o.push(e))),null==(r=nL.get(this))||r.forEach((e=>null==e?void 0:e.queue.forEach((e=>o.push(e))))),o.forEach((t=>{t.reject(new tb({code:ZC.API_CALL_ABORTED,message:e}));})),rL.delete(this),nL.delete(this),n.apply(this,a)},r}}function aL(e){return function(t,i,r){let n=r.value,o=t=>e(...t);return r.value=function(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];let r=nL.get(this)||new Map,s=r.get(o(t))||new iL;return r.set(o(t),s),nL.set(this,r),s.push({fn:n,args:t,context:this})},r}}function cL(e,t){return ZM(((i,r)=>function(){let r=e;try{for(var n=arguments.length,o=new Array(n),s=0;s<n;s++)o[s]=arguments[s];let e=i.apply(this,o),a=Lw();return Nw(e)?e.then((e=>(t?IO.addSuccessEvent({key:r,cost:Lw()-a}):IO.addSuccessEvent({key:r}),e))).catch((e=>{throw IO.addFailedEvent({key:r,error:e}),e})):(IO.addSuccessEvent({key:r}),e)}catch(hb){throw IO.addFailedEvent({key:r,error:hb}),hb}}))}var lL=class extends WM{constructor(e,t){super({mediaType:e,PlayerClass:t}),FC(this,"isRemote",!1),FC(this,"deviceId"),FC(this,"groupId",""),FC(this,"label",""),FC(this,"_isRecapturing",!1),FC(this,"_lastRecaptureTime",0),FC(this,"_onMuteTimeoutId",-1),FC(this,"_encodeCheckTimeoutId",-1),FC(this,"profile");}get enableEncodeFrame(){return !1}get isPublishing(){return "publishing"===this.state.toString()}get isPublished(){return "publish"===this.state}encodeFrame(e,t){throw new Error("Method not implemented.")}installTrackEvent(e){MP(e,e).add(Ub.MUTE,this.onTrackMuted).add(Ub.UNMUTE,this.onTrackUnmuted).add(Ub.ENDED,this.onTrackEnded),e.muted&&this.onTrackMuted(),e.readyState===Ub.ENDED&&this.onTrackEnded();}uninstallTrackEvent(e){LP(e);}setStateToCapture(){}capture(e){return HC(this,null,(function*(){var t;try{let i,r=Lw();jN.emit(nO.LOCAL_TRACK_CAPTURE_START,{track:this}),e.customSource?(i=new MediaStream,i.addTrack(e.customSource)):(null==(t=this.mediaTrack)||t.stop(),i=yield QM(e));let n=i.getTracks()[0];return yield this.setInputMediaStreamTrack(n),e.customSource||(this.updateDeviceIdInUse(),this.listenDeviceChange()),jN.emit(nO.LOCAL_TRACK_CAPTURE_SUCCESS,{track:this,cost:Lw()-r}),i}catch(ub){throw jN.emit(nO.LOCAL_TRACK_CAPTURE_FAILED,{track:this,error:ub}),this.log.error("getUserMedia error observed ".concat(ub)),ub}}))}setInputMediaStreamTrack(e){return this.state===AP.INIT&&this.setStateToCapture(),super.setInputMediaStreamTrack(e)}setOutputMediaStreamTrack(e){var t;if(super.setOutputMediaStreamTrack(e),this.isPublishing||this.isPublished)return null==(t=this.room)?void 0:t.replaceTrack(this)}publish(e,t){return this.room=e,this.emit("4",{mediaType:this.strMediaType,state:"starting",prevState:"stopped"}),this.userId=e.userId,this._log.setUserId(e.userId),this._log.setSdkAppId(e.sdkAppId),t}unpublish(){this.room&&this.room.localTracks.delete(this),jN.emit(nO.LOCAL_TRACK_UNPUBLISHED,{track:this});}updateDeviceIdInUse(){return HC(this,null,(function*(){if(this.mediaTrack&&rP){let{deviceId:e,groupId:t}=this.mediaTrack.getSettings(),{label:i}=this.mediaTrack;(yield function(e){return HC(this,arguments,(function(e){let{newDeviceId:t,oldDeviceId:i,oldGroupId:r,oldLabel:n,kind:o}=e;return function*(){return t===i&&(o!==Ub.AUDIO||t!==wk||(yield VM(r,n)))}()}))}({newDeviceId:e,oldDeviceId:this.deviceId,oldGroupId:this.groupId,oldLabel:this.label,kind:this.kind}))||(this.deviceId=e,this.label=i,t&&(this.groupId=t),wM().then((t=>{let i=t.find((t=>t.deviceId===e));i&&this.emit("2",i);})));}}))}setProfile(e){this.log.info("setProfile",e),Object.assign(this.profile,e);}isNeedToRecapture(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];return !(!this.deviceId||!this.mediaTrack||this.kind===Ub.AUDIO&&!function(e){if(e instanceof CanvasCaptureMediaStreamTrack||!(e instanceof MediaStreamTrack))return !1;let t=e.label.toLocaleLowerCase();if(t.includes("mic")||t.includes("麦克风"))return !0;let i="".concat(((null==e?void 0:e.getSettings())||{}).deviceId,"_").concat(Ub.AUDIO_INPUT);return !!xM.has(i)}(this.mediaTrack)||this.kind===Ub.VIDEO&&!function(e){if(e instanceof CanvasCaptureMediaStreamTrack||!(e instanceof MediaStreamTrack))return !1;let t=e.label.toLocaleLowerCase();if(t.includes("camera")||t.includes("webcam"))return !0;let i="".concat(((null==e?void 0:e.getSettings())||{}).deviceId,"_").concat(Ub.VIDEO_INPUT);return !!xM.has(i)}(this.mediaTrack)||this._isRecapturing||e&&jD&&uN)}onTrackMuted(){if(super.onTrackMuted(),eL(),this.isNeedToRecapture(!0)){if(Date.now()-this._lastRecaptureTime<Vk)return void setTimeout((()=>this.onTrackMuted()),Vk);this._onMuteTimeoutId=setTimeout((()=>HC(this,null,(function*(){var e;if(null!=(e=this.mediaTrack)&&e.muted){if((sD||aD)&&"visible"!==document.visibilityState)return;this.recapture(yield this.getRecoverCaptureDeviceId());}}))),5e3);}}onTrackUnmuted(){super.onTrackUnmuted(),this._onMuteTimeoutId>0&&clearTimeout(this._onMuteTimeoutId);}onTrackEnded(){return HC(this,null,(function*(){if(BC(lL.prototype,this,"onTrackEnded").call(this),this.isNeedToRecapture()){if(Date.now()-this._lastRecaptureTime<Vk)return void setTimeout((()=>this.onTrackEnded()),Vk);this.recapture(yield this.getRecoverCaptureDeviceId());}}))}recapture(e){return HC(this,null,(function*(){var t;if(this._isRecapturing||!this._inputTrack)return;this.log.warn("recapture trying"),null==(t=this._inputTrack)||t.stop(),this._isRecapturing=!0,this._lastRecaptureTime=Date.now();let i={useExactDeviceId:!0};if("user"===e||"environment"===e)i.facingMode=e;else {let t;("audio"===this.kind?yield OM():yield PM()).find((t=>t.deviceId===e))&&(t=e),i.deviceId=t;}return this.capture(i).then((()=>{this._isRecapturing=!1,this.log.warn("recapture success"),this.emit("1",{deviceId:this.deviceId}),jN.emit(nO.LOCAL_TRACK_RECAPTURE,{track:this});})).catch((e=>{this._isRecapturing=!1,this.log.warn("recapture failed ".concat(e.message)),this.emit("5",e),jN.emit(nO.LOCAL_TRACK_RECAPTURE,{track:this,error:e});}))}))}getRecoverCaptureDeviceId(){return HC(this,null,(function*(){let e=this instanceof _L;if(e&&this.facingMode)return this.facingMode;let{deviceId:t}=this;if(t){let i=(uL.get(t)||0)+1;if(uL.set(t,i),i>=3){let r=e?(yield PM()).find((e=>!uL.has(e.deviceId))):(yield OM()).find((e=>!uL.has(e.deviceId)));r&&(this.log.warn("".concat(t," capture fail ").concat(i," times, change new ").concat(r.deviceId)),t=r.deviceId);}}return t}))}close(){var e;super.close(),this._inputTrack&&(this._inputTrack.stop(),this.uninstallTrackEvent(this._inputTrack)),null==(e=this.manager)||e.removeInput(this);}},dL=lL;UC([SP(AP.INIT,"capture",{ignoreError:!0,sync:!0})],dL.prototype,"setStateToCapture",1),UC([oL()],dL.prototype,"capture",1),UC([SP("capture","publish",{ignoreError:!0,success(){var e,t;this.room.localTracks.add(this),jN.emit(nO.LOCAL_TRACK_PUBLISHED,{track:this}),this.emit("4",{mediaType:this.strMediaType,state:"started",prevState:"starting"}),!(((null==(t=null==(e=this.room)?void 0:e.networkQuality)?void 0:t.uplinkNetworkQuality)||0)>3)&&(this._encodeCheckTimeoutId=setTimeout((()=>{var e,t;if(!(((null==(t=null==(e=this.room)?void 0:e.networkQuality)?void 0:t.uplinkNetworkQuality)||0)>3)&&this.isPublished&&this.isMediaTrackActive){let e=this.kind===Ub.AUDIO,t=this.stat.bytesSent>0;IO[t?"addSuccessEvent":"addFailedEvent"]({key:e?503700:513702}),t||(IO.addEnum({key:e?503701:513703,value:NN()}),GN.uploadEvent({log:"stat-encode-failed-".concat(this.kind,"-").concat(bN()||wN()),userId:this.userId}),this.log.warn("encode failed"),this.emit("6",this));}}),5e3));},fail(e){let t="error",i=e.cause;i.message.includes("timeout")?t="timeout":i.code===ZC.API_CALL_ABORTED&&(t="api-call"),this.emit("4",{mediaType:this.strMediaType,state:"stopped",prevState:"starting",reason:t,error:i});}}),cL(521714,!1)],dL.prototype,"publish",1),UC([ZM((e=>function(){return HC(this,null,(function*(){let t="publish"===this.state?"started":"starting";e.call(this),this.emit("4",{mediaType:this.strMediaType,state:"stopped",prevState:t,reason:"api-call"}),clearTimeout(this._encodeCheckTimeoutId);}))})),SP([],"capture",{sync:!0})],dL.prototype,"unpublish",1);var uL=new Map;jN.on(nO.SWITCH_DEVICE_SUCCESS,(e=>{e.track.deviceId&&uL.delete(e.track.deviceId);}));var hL=class extends dL{constructor(e){super(1,HM),FC(this,"mediaType",1),FC(this,"volume",0),FC(this,"profile",{echoCancellation:!0,autoGainControl:!0,noiseSuppression:!0,sampleRate:48e3,channelCount:1,bitrate:40}),FC(this,"playerMuted",!0),FC(this,"pipeline"),FC(this,"stat",{bytesSent:0,packetsSent:0,audioLevel:0,totalAudioEnergy:0}),this.manager=e,this.pipeline=new _M(e),this.handleMicrophoneAdded=this.handleMicrophoneAdded.bind(this),this.handleMicrophoneRemoved=this.handleMicrophoneRemoved.bind(this);}getAudioLevel(){let e=(this.volume||super.getAudioLevel())*this.captureVolume;return e>1?1:e}get playerMediaTrack(){return this.mediaTrack}setInputMediaStreamTrack(e){return HC(this,null,(function*(){yield BC(hL.prototype,this,"setInputMediaStreamTrack").call(this,e);let t=this.trackSettings||{};IO.addEnum({key:501701,value:t.channelCount||0,useUV:!1}),IO.addEnum({key:501702,value:t.sampleRate||0,useUV:!1}),IO.addEnum({key:502700,value:0});let{sampleRate:i,channelCount:r}=t;this._log.info("local audio track input ".concat(JSON.stringify({sampleRate:i,channelCount:r}))),this.pipeline.source.channelCount=r||1,this.pipeline.replaceSource(e),this.updatePlayingState(!!e);}))}capture(e){let{deviceId:t,customSource:i,useExactDeviceId:r=!0}=e;return super.capture({video:!1,audio:!0,microphoneId:t,echoCancellation:this.profile.echoCancellation,autoGainControl:this.profile.autoGainControl,noiseSuppression:this.profile.noiseSuppression,sampleRate:this.profile.sampleRate,channelCount:this.profile.channelCount,useExactDeviceId:r,customSource:i})}switchDevice(e){return HC(this,null,(function*(){if(this.mediaTrack){if(this.deviceId===e){if(e!==wk)return;if(yield VM(this.groupId,this.label))return}try{this.log.info("switchDevice audio to: ".concat(e)),this.mediaTrack&&this.mediaTrack.stop(),yield this.capture({deviceId:e,useExactDeviceId:!0,retryWhenExactFailed:!1}),this.room&&(yield this.room.replaceTrack(this)),jN.emit(nO.SWITCH_DEVICE_SUCCESS,{track:this}),this.log.info("switch microphone success");}catch(hk){throw this.log.error("switch microphone failed ".concat(hk)),this.deviceId&&this.recapture(this.deviceId),hk}}}))}listenDeviceChange(){DM&&!DM.listeners("audioInputRemoved").includes(this.handleMicrophoneRemoved)&&DM.on("audioInputRemoved",this.handleMicrophoneRemoved,this);}handleMicrophoneRemoved(e){return HC(this,null,(function*(){if(e.deviceId===this.deviceId){this.log.warn("current microphone is lost: ".concat(JSON.stringify(e))),Ax(this.userId,{eventId:2003,param1:6,streamType:1});let t=yield OM();t[0]?this.recapture(t[0].deviceId):DM.on("audioInputAdded",this.handleMicrophoneAdded,this);}}))}handleMicrophoneAdded(e){this.log.warn("microphone added: ".concat(JSON.stringify(e))),this.recapture(e.deviceId);}update3A(e){return HC(this,arguments,(function(e){var t=this;let{echoCancellation:i,noiseSuppression:r,autoGainControl:n}=e;return function*(){let e=!1;!Sw(i)&&i!==t.profile.echoCancellation&&(t.profile.echoCancellation=i,e=!0),!Sw(r)&&r!==t.profile.noiseSuppression&&(t.profile.noiseSuppression=r,e=!0),!Sw(n)&&n!==t.profile.autoGainControl&&(t.profile.autoGainControl=n,e=!0),e&&t.deviceId&&(yield t.recapture(t.deviceId));}()}))}get captureVolume(){return this.pipeline.volume}setCaptureVolume(e){this.pipeline.setVolume(e/100),this.pipeline.gain.node&&IO.addEnum({key:502700,value:2}),this.resetPlayerSource();}enableTrackANS(e){if(!this._inputTrack)return;let t=this._inputTrack.getConstraints();return t.noiseSuppression=e,this._inputTrack.applyConstraints(t).catch((t=>this._log.warn("".concat(e?"enable":"disable"," ANS failed "),t)))}addDenoiser(e){var t;lN<=92&&48e3!==(null==(t=this.trackSettings)?void 0:t.sampleRate)?this._log.warn("denoiser only support sampleRate 48000 before chrome 93"):(IO.addEnum({key:502700,value:1}),this.pipeline.denoiser.setNode(e),this.resetPlayerSource(),this.enableTrackANS(!1));}removeDenoiser(e){this.pipeline.denoiser.node===e&&(this.pipeline.denoiser.deleteNode(),this.resetPlayerSource(),this.enableTrackANS(!0));}resetPlayerSource(){this.player.setSourceNode(this.pipeline.gain.node||this.pipeline.denoiser.node||this.pipeline.source.node);}close(){this.pipeline.remove(),DM.off("audioInputAdded",this.handleMicrophoneAdded,this),DM.off("audioInputRemoved",this.handleMicrophoneRemoved,this),super.close();}recapture(e){return HC(this,null,(function*(){try{yield BC(hL.prototype,this,"recapture").call(this,e);}catch(hk){let i=(yield OM()).find((t=>t.deviceId!==e));if(!i)throw hk;yield BC(hL.prototype,this,"recapture").call(this,i.deviceId);}}))}encodeFrame(e){return this.manager?this.manager.encodePipeline.reduce(((e,t)=>t?t({frame:e}):e),e):e}get enableEncodeFrame(){return !!this.manager&&this.manager.encodePipeline.some((e=>e))}},pL=class{constructor(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];this.dataView=e,this.isSEI&&(t?this.addPreventionByte():this.removePreventionByte());}addPreventionByte(){let e=this.seiPayloadStartIndex,t=this.dataView.byteLength-2,i=[],r=0;for(let o=e;o<=t;o++){let e=this.dataView.getInt8(o);switch(e){case 0:case 1:case 2:case 3:2===r&&(i.push(3),r=0),0==e?r++:r=0,i.push(e);break;default:r=0,i.push(e);}}i.push(this.dataView.getInt8(this.dataView.byteLength-1));let n=new DataView(new Uint8Array([...new Uint8Array(this.dataView.buffer).slice(0,e),...i]).buffer);this.dataView=n;}removePreventionByte(){let e=this.seiPayloadStartIndex,t=this.dataView.byteLength-1,i=[],r=0;for(let o=e;o<=t;o++)switch(this.dataView.getInt8(o)){case 0:r++,i.push(this.dataView.getInt8(o));break;case 3:2!==r&&i.push(this.dataView.getInt8(o)),r=0;break;default:i.push(this.dataView.getInt8(o)),r=0;}let n=new DataView(new Uint8Array([...new Uint8Array(this.dataView.buffer).slice(0,e),...i]).buffer);this.dataView=n;}get isSEI(){return 6===this.dataView.getUint8(4)}get seiPayloadStartIndex(){let e=6;for(let t=6;t<this.dataView.buffer.byteLength&&(e++,255===this.dataView.getUint8(t));t++);return e}get seiPayloadType(){return this.isSEI?this.dataView.getUint8(5):null}get seiPayload(){if(!this.isSEI)return null;let e=0,t=6;for(let n=6;n<this.dataView.buffer.byteLength;n++){let i=this.dataView.getUint8(n);if(t++,255!==i){e+=i;break}e+=255;}let i=new ArrayBuffer(e),r=new DataView(i);for(let n=0;n<i.byteLength;n++,t++)r.setInt8(n,this.dataView.getInt8(t));return r}},mL=class{constructor(){FC(this,"_seiMessageList",[]),FC(this,"_smallSeiMessageList",[]),FC(this,"_seiPayloadType",243);}encodeSEINalu(e){let t=e.byteLength,i=parseInt(String(t/255),10),r=t%255,n=[];n.push(0,0,0,1,6,this._seiPayloadType);for(let s=0;s<i;s++)n.push(255);n.push(r);let o=new DataView(e);return n.push(...new Uint8Array(o.buffer)),n.push(128),new pL(new DataView(new Uint8Array(n).buffer),!0)}sendSEI(e,t){null!=t&&t.seiPayloadType&&(this._seiPayloadType=t.seiPayloadType),this._seiMessageList.push(e),null!=t&&t.small&&this._smallSeiMessageList.push(e);}getNaluCount(e){let t=0,i=0,r=new DataView(e);for(let n=0;n<e.byteLength;n++)switch(r.getUint8(n)){case 0:t++;break;case 1:(2===t||3===t)&&i++,t=0;break;default:t=0;}return i}encode(e,t){let i=t?this._smallSeiMessageList:this._seiMessageList;if(i.length>0&&e.data.byteLength>0){let t=9-this.getNaluCount(e.data);if(t<=0)return 0;let r=i.splice(0,t).reverse().map(this.encodeSEINalu.bind(this)),n=r.reduce(((e,t)=>e+t.dataView.byteLength),0),o=new ArrayBuffer(n+e.data.byteLength),s=new DataView(o),a=new DataView(e.data),c=0;for(let e=0;e<r.length;e++)for(let t=0;t<r[e].dataView.byteLength;t++)s.setInt8(c++,r[e].dataView.getInt8(t));for(let i=0;i<e.data.byteLength;i++)s.setInt8(c++,a.getInt8(i));return e.data=o,r.length}return 0}},_L=class extends dL{constructor(e){super(arguments.length>1&&void 0!==arguments[1]?arguments[1]:4,aM),FC(this,"profile",{width:640,height:480,frameRate:15,bitrate:500}),FC(this,"stat",{bytesSent:0,packetsSent:0,framesEncoded:0,framesSent:0,frameWidth:0,frameHeight:0,fpsCapture:0}),FC(this,"small"),FC(this,"isNeedToSetBandwidth"),FC(this,"muteImage"),FC(this,"manager"),FC(this,"_seiCodec",new mL),this.manager=e;let t=()=>{this.isAllowed2k4k(this.profile)?this.room&&this.settings.height>=1440&&"publish"===this.state&&this.room.sendAbilityStatus({"2k4k":1}):(this.log.warn("Resolution is reset to 1080p, need to upgrade ability here https://cloud.tencent.com/document/product/647/85386"),this.setProfile(MC(PC({},this.profile),{width:1920,height:1080})),this.applyProfile());};this.on("input-media-track-changed",t),this.on("publish",t),this.handleCameraAdded=this.handleCameraAdded.bind(this),this.handleCameraRemoved=this.handleCameraRemoved.bind(this);}get facingMode(){if(rP&&this.mediaTrack)return this.mediaTrack.getSettings().facingMode}get isQosClearFirst(){var e;return "detail"===(null==(e=this._inputTrack)?void 0:e.contentHint)}setMute(e){return HC(this,null,(function*(){var t,i,r;if(Iw(e)){if(this.muteImage===e)return;yield null==(t=this.manager)?void 0:t.deleteWatermark("mute"),yield null==(i=this.manager)?void 0:i.setWatermark({x:0,y:0,width:this.settings.width,height:this.settings.height,type:"mute",zIndex:999,imageUrl:e}),this.muteImage=e,BC(_L.prototype,this,"setMute").call(this,!1);}else yield null==(r=this.manager)?void 0:r.deleteWatermark("mute"),this.muteImage=void 0,BC(_L.prototype,this,"setMute").call(this,e);}))}capture(e){let{deviceId:t,facingMode:i,useExactDeviceId:r=!0,customSource:n,retryWhenExactFailed:o=!0}=e;return super.capture({audio:!1,video:!0,facingMode:i||this.facingMode,cameraId:t,width:this.profile.width,height:this.profile.height,frameRate:this.profile.frameRate,useExactDeviceId:r,retryWhenExactFailed:o,customSource:n})}setProfile(e){let t=PC({},e),i=t.width>t.height;t.width*t.height<=19200&&aD&&sN&&(this.log.warn("resolution is ".concat(t.width,"*").concat(t.height,", fallback to 240*180")),t.width=i?240:180,t.height=i?180:240,t.bitrate=Math.max(t.bitrate,150)),t.width*t.height>921600&&EN&&(t.width=i?1280:720,t.height=i?720:1280,this.log.warn("reset to 1280 * 720 on iOS 13~14")),t.bitrate&&(this.isNeedToSetBandwidth=t.bitrate!==this.profile.bitrate),this.isAllowed2k4k(this.profile)?super.setProfile(t):(this.log.warn("Resolution is reset to 1080p, need to upgrade ability here https://cloud.tencent.com/document/product/647/85386"),super.setProfile(MC(PC({},this.profile),{width:1920,height:1080})));}applyProfile(){var e;if(!this.mediaTrack)return;let t=this.settings;return t.height!==this.profile.height||t.width!==this.profile.width||t.frameRate!==this.profile.frameRate?null==(e=this.mediaTrack)?void 0:e.applyConstraints({width:this.profile.width,height:this.profile.height,frameRate:this.profile.frameRate}).then((()=>{if(this.manager&&this.manager.changeInput(this),this.room&&this.settings.height>=1440&&"publish"===this.state&&this.room.sendAbilityStatus({"2k4k":1}),this.isNeedToSetBandwidth&&this.room&&this.room.setBandWidth)return this.isNeedToSetBandwidth=!1,this.room.setBandWidth({bandwidth:this.profile.bitrate,type:Ub.VIDEO,videoType:Ub.BIG})})):void 0}get settings(){let e={width:this.profile.width,height:this.profile.height,frameRate:this.profile.frameRate};return rP&&this.mediaTrack&&Object.assign(e,this.mediaTrack.getSettings()),e}get scaleResolutionDownBy(){let{settings:e}=this;return e.width===this.profile.width&&e.height===this.profile.height?1:Xw()&&this.profile.width>this.profile.height&&e.height>e.width?Math.max(e.width/this.profile.height,e.height/this.profile.width,1):Math.max(e.width/this.profile.width,e.height/this.profile.height,1)}isAllowed2k4k(e){var t;return !(this.room&&this.room.scheduleResult&&!this.isScreen&&!(e.height*e.width<3686400))||1===(null==(t=this.room.scheduleResult.trtcAutoConf)?void 0:t["2k4k"])}isNeedToSwitchDevice(e){return !(!this.mediaTrack||this.deviceId===e||this.facingMode===e)}switchDevice(e){return HC(this,null,(function*(){try{if(!this.isNeedToSwitchDevice(e))return;let t={useExactDeviceId:!0,retryWhenExactFailed:!1};"user"===e||"environment"===e?t.facingMode=e:t.deviceId=e,this.mediaTrack.stop(),yield this.capture(t),jN.emit(nO.SWITCH_DEVICE_SUCCESS,{track:this}),this.log.info("switch camera success");}catch(hk){throw this.log.error("switch camera failed ".concat(hk)),this.deviceId&&this.recapture(this.deviceId),hk}}))}listenDeviceChange(){DM&&!DM.listeners("videoInputRemoved").includes(this.handleCameraRemoved)&&DM.on("videoInputRemoved",this.handleCameraRemoved,this);}handleCameraRemoved(e){return HC(this,null,(function*(){if(e.deviceId===this.deviceId){this.log.warn("current camera is lost: ".concat(JSON.stringify(e))),Ax(this.userId,{eventId:2003,param1:7,streamType:2});let t=yield PM();t[0]?this.recapture(t[0].deviceId):DM.on("videoInputAdded",this.handleCameraAdded,this);}}))}handleCameraAdded(e){return HC(this,null,(function*(){this.log.warn("camera added: ".concat(JSON.stringify(e))),this.recapture(e.deviceId);}))}encodeFrame(e,t){if(!this.manager)return e;let i=t?8:this.mediaType;return this.manager.encodePipeline.reduce(((e,t)=>t?t({frame:e,mediaType:i}):e),e)}get enableEncodeFrame(){return !!this.manager&&this.manager.encodePipeline.some((e=>e))}play(e,t){return HC(this,null,(function*(){return Sw(this.mirror)&&!this.isScreen&&this.setMirror("view"),BC(_L.prototype,this,"play").call(this,e,t)}))}close(){DM.off("videoInputAdded",this.handleCameraAdded,this),DM.off("videoInputRemoved",this.handleCameraRemoved,this),super.close();}recapture(e){return HC(this,null,(function*(){try{yield BC(_L.prototype,this,"recapture").call(this,e);}catch(hk){let i=(yield PM()).find((t=>t.deviceId!==e));if(!i)throw hk;yield BC(_L.prototype,this,"recapture").call(this,i.deviceId);}}))}},fL=aO();if(navigator.mediaDevices&&"setCaptureHandleConfig"in navigator.mediaDevices)try{navigator.mediaDevices.setCaptureHandleConfig({handle:fL,exposeOrigin:!0,permittedOrigins:["*"]});}catch(sx){}var gL,TL=function(e){return HC(this,null,(function*(){let t=null,i=function(e){let t={preferCurrentTab:"current-tab"===e.preferDisplaySurface||!!e.captureElement,systemAudio:"include",selfBrowserSurface:"include",surfaceSwitching:"include"},i={width:uN?{max:e.width}:{ideal:e.width,max:e.width},height:uN?{max:e.height}:{ideal:e.height,max:e.height},frameRate:e.frameRate,displaySurface:e.preferDisplaySurface||"monitor"};if(t.video=i,e.systemAudio){let{echoCancellation:i=!0,noiseSuppression:r=!1,autoGainControl:n=!1}=e;t.audio={echoCancellation:i,noiseSuppression:r,autoGainControl:n,sampleRate:48e3};}return t}(e);sO.info("getDisplayMedia with constraints: ".concat(JSON.stringify(i)));let r=yield navigator.mediaDevices.getDisplayMedia(i);e.systemAudio&&0===r.getAudioTracks().length&&(aN&&lN<74||uN||uD)&&sO.warn("Your browser not support capture system audio");let n=r.getVideoTracks()[0];if(n){if(e.frameRate)try{yield n.applyConstraints({frameRate:{min:e.frameRate,ideal:e.frameRate},width:e.width,height:e.height});}catch(o){sO.warn("screen applyConstraints failed: ".concat(o));}e.captureElement&&(yield function(e,t){return HC(this,null,(function*(){var i;if("CropTarget"in window&&"fromElement"in CropTarget&&yw(e.cropTo))try{if((null==(i=e.getCaptureHandle())?void 0:i.handle)!==fL)return;let r=yield CropTarget.fromElement(t);yield e.cropTo(r);}catch(r){sO.warn("cropTo target failed ".concat(r));}}))}(n,e.captureElement));}if(e.audio){let i=function(e){let t={echoCancellation:e.echoCancellation,autoGainControl:e.autoGainControl,noiseSuppression:e.noiseSuppression,sampleRate:e.sampleRate,channelCount:e.channelCount};return Sw(e.microphoneId)||(t.deviceId=e.microphoneId),{audio:t,video:!1}}(e);sO.info("getUserMedia with constraints: ".concat(JSON.stringify(i))),t=yield navigator.mediaDevices.getUserMedia(i),r.addTrack(t.getAudioTracks()[0]);}return r}))},EL=class extends _L{constructor(e){super(e,2),FC(this,"profile",{width:1920,height:1080,frameRate:5,bitrate:1600}),FC(this,"objectFit","contain"),FC(this,"isScreen",!0),this._log.id="s-".concat(this._log.id);}capture(e){return HC(this,arguments,(function(e){var t=this;let{systemAudio:i=!1,autoGainControl:r,echoCancellation:n,noiseSuppression:o,audioTrack:s,videoTrack:a,captureElement:c,preferDisplaySurface:l}=e;return function*(){try{let e;return a||s?(e=new MediaStream,a&&e.addTrack(a),s&&e.addTrack(s)):e=yield TL({audio:!1,systemAudio:i,width:t.profile.width,height:t.profile.height,frameRate:t.profile.frameRate,autoGainControl:r,echoCancellation:n,noiseSuppression:o,captureElement:c,preferDisplaySurface:l}),yield t.setInputMediaStreamTrack(e.getVideoTracks()[0]),e}catch(e){throw t.log.error("getDisplayMedia error observed ".concat(e)),e instanceof tb?e:new tb({code:ZC.INITIALIZE_FAILED,name:e.name,message:e.message})}}()}))}switchDevice(e){return HC(this,null,(function*(){throw new Error("Method not implemented.")}))}},vL=class extends hL{constructor(e){super(e),this._log.id="s-".concat(this._log.id);}},yL="registerProcessor('dumper', class extends AudioWorkletProcessor {process(inputs) {this.port.postMessage(inputs);return true;}});";function SL(e){return HC(this,null,(function*(){let t=uM();gL||(gL=cM(t,URL.createObjectURL(new Blob([yL],{type:"application/javascript"})))),yield gL;let i=new AudioWorkletNode(t,"dumper",{numberOfInputs:e.length,numberOfOutputs:0});return e.forEach(((e,t)=>e.connect(i,0,t))),new ReadableStream({start(e){i.port.onmessage=t=>{e.enqueue(t.data);};},cancel(){e.forEach((e=>e.disconnect(i))),i.port.close();}})}))}var IL=class extends fM{constructor(e){super(),this.room=e,FC(this,"_localAudioTrack"),FC(this,"_localScreenAudioTrack"),FC(this,"log",sO.createLogger({id:"am"})),FC(this,"denoiser"),FC(this,"mixChangedDebounce"),FC(this,"encodePipeline",[]),FC(this,"decodePipeline",[]),e&&(this.log.setUserId(e.userId),this.log.setSdkAppId(e.sdkAppId));}get _localAudioPipline(){var e;return null==(e=this._localAudioTrack)?void 0:e.pipeline}dump(e){var t,i;if(!this._localAudioTrack)return;let r=[],n=[];null!=(t=this._localAudioPipline)&&t.source.node&&(r.push(this._localAudioPipline.source.node),n.push("mic")),null!=(i=this._localAudioPipline)&&i.denoiser.node&&(r.push(this._localAudioPipline.denoiser.node),n.push("mic-processed")),this.mixWeight>1&&(r.push(this.audioContext.createMediaStreamSource(this._localAudioPipline.stream)),n.push("mix")),this.log.info("dump audio track ".concat(n,", duration: ").concat(e));let o=new AbortController,s=[],a=setTimeout((()=>{this.log.info('dump audio track complete please input "download()" to download.'),o.abort("timeout");}),1e3*e),c=()=>{for(let e=0;e<n.length;e++){let t=URL.createObjectURL(new Blob(s[e])),i=document.createElement("a");i.href=t,i.download="".concat(n[e],".pcm"),i.style.display="none",document.body.appendChild(i),i.click(),URL.revokeObjectURL(t),i.remove();}clearTimeout(a),o.abort("download");},l=SL(r).then((e=>e.pipeTo(new WritableStream({write(e){e.forEach(((e,t)=>s[t]=s[t]?s[t].concat(e[0]):[e[0]]));}}),o).catch((e=>c))));return {then:l.then.bind(l),download:c}}getPCM(e){var t;if(Sw(WritableStream))return void this.log.warn("getPCM failed: browser not support WritableStream");if(null==(t=this._localAudioPipline)||!t.source.node)return void this.log.warn("getPCM failed: no local audio track");let i=new Float32Array(1920),r=0,n=new AbortController;return SL([this._localAudioPipline.source.node]).then((t=>t.pipeTo(new WritableStream({write(t){!t[0][0]||(i.set(t[0][0],r),r+=t[0][0].length,r>=1920&&(r=0,e(i),i=new Float32Array(1920)));}}),n).catch((e=>this.log.error("stop getPCM reason:".concat(e)))))),n}get hasScreenAudioTrack(){return null!==this._localScreenAudioTrack}get hasAudioTrack(){return null!==this._localAudioTrack}changeInput(e){return e instanceof vL?(this._localScreenAudioTrack=e,e.pipeline.connect(),this.mixOnChange()):e instanceof hL?(this._localAudioTrack=e,this.denoiser&&e.addDenoiser(this.denoiser),e.pipeline.connect(),this.mixOnChange()):e instanceof bL?e.setOutputMediaStreamTrack(e.mediaTrack):void 0}mixOnChange(){return this.mixChangedDebounce||(this.mixChangedDebounce=Promise.resolve().then((()=>{var e,t;return delete this.mixChangedDebounce,Promise.all([null==(e=this._localAudioTrack)?void 0:e.setOutputMediaStreamTrack(this.mixWeight>1?this.mixTrack:this._localAudioTrack.mediaTrack),null==(t=this._localScreenAudioTrack)?void 0:t.setOutputMediaStreamTrack(this.mixWeight>1?this.mixTrack:this._localScreenAudioTrack.mediaTrack)])}))),this.mixChangedDebounce}removeInput(e){e instanceof vL?delete this._localScreenAudioTrack:e instanceof hL&&delete this._localAudioTrack;}addDenoiser(e){var t;this.denoiser=e,null==(t=this._localAudioTrack)||t.addDenoiser(e);}removeDenoiser(e){var t;if(delete this.denoiser,null==(t=this._localAudioTrack)||t.removeDenoiser(e),this.mixChangedDebounce)return this.mixChangedDebounce}destroy(){this.close();}addEncodeProcessor(e){let{processor:t,type:i}=e;this.encodePipeline.includes(t)||(this.encodePipeline[i]=t);}addDecodeProcessor(e){let{processor:t,type:i}=e;this.decodePipeline.includes(t)||(this.decodePipeline[i]=t);}removeEncodeProcessor(e){let{type:t}=e;this.encodePipeline[t]=void 0;}removeDecodeProcessor(e){let{type:t}=e;this.decodePipeline[t]=void 0;}};function RL(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:30,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:2;return ZM(((i,r)=>function(){for(var n=arguments.length,o=new Array(n),s=0;s<n;s++)o[s]=arguments[s];return new Promise(((n,s)=>{let a=setTimeout((()=>{let i=new tb({code:ZC.API_CALL_TIMEOUT,message:"checkPendingPromise ".concat(r,"() timeout ").concat(e,"s")});sO.warn(i),2===t?s(i):1===t&&n();}),1e3*e);i.apply(this,o).then(n,s).finally((()=>{clearTimeout(a);}));}))}))}var AL=class extends WM{constructor(e,t,i){super({userId:t.userId,sdkAppId:e.sdkAppId,mediaType:i,room:e}),this.room=e,this.user=t,FC(this,"tinyId"),FC(this,"isRemote",!0),FC(this,"jitterBufferDelay",0),FC(this,"_decodeCheckTimeoutId",-1),this.tinyId=t.tinyId;}setMute(e){this.hasFlag&&super.setMute(e);}setInputMediaStreamTrack(e){super.setInputMediaStreamTrack(e),this.hasFlag&&this.isSubscribed&&this.player.setTrack(this.outMediaTrack);}waitHasMediaTrack(){return new Promise((e=>{this.mediaTrack?e():this.once("input-media-track-changed",e);}))}get isSubscribing(){return "subscribeing"===this.state.toString()}get isSubscribed(){return this.state===AL.STATE_SUBSCRIBE}subscribe(e){return e}unsubscribe(){this.player.setTrack(null),"main"===this.streamType&&"video"===this.kind&&this.room.changeType(!1,this.user);}updatePlayingState(e){if(this.isPlayCalled&&this.player.isStopped===e){if(e&&(!this.isSubscribed||!this.hasFlag||!this.outMediaTrack))return void this.log.info("abort play, isSubscribed: ".concat(this.isSubscribed," hasFlag: ").concat(this.hasFlag," hasTrack: ").concat(!!this.outMediaTrack," "));super.updatePlayingState(e);}}close(){super.close(),this.outMediaTrack&&this.uninstallTrackEvent(this.outMediaTrack);}onFlagChanged(){this.updatePlayingState(this.hasFlag);}onTrackMuted(){this.hasFlag&&(this.isSubscribed||this.isSubscribing)&&this.isPlayCalled&&super.onTrackMuted();}onTrackUnmuted(){this.hasFlag&&(this.isSubscribed||this.isSubscribing)&&this.isPlayCalled&&super.onTrackUnmuted();}onTrackEnded(){this.hasFlag&&(this.isSubscribed||this.isSubscribing)&&this.isPlayCalled&&super.onTrackEnded();}},CL=AL;FC(CL,"STATE_SUBSCRIBE","subscribe"),UC([RL(5,1)],CL.prototype,"waitHasMediaTrack",1),UC([SP(AP.INIT,CL.STATE_SUBSCRIBE,{success(){var e,t;this.log.info("subscribed"),jN.emit(nO.REMOTE_TRACK_SUBSCRIBED,{track:this}),this.updatePlayingState(!0),!(((null==(t=null==(e=this.room)?void 0:e.networkQuality)?void 0:t.downlinkNetworkQuality)||0)>3)&&(this._decodeCheckTimeoutId=setTimeout((()=>{var e,t;if(!(((null==(t=null==(e=this.room)?void 0:e.networkQuality)?void 0:t.downlinkNetworkQuality)||0)>3)&&this.isSubscribed&&this.isPlayCalled&&this.stat.bytesReceived>0){let e=this.kind===Ub.AUDIO,t=this.player.isPlaying||(e?this.getAudioLevel()>0:this.stat.framesDecoded>0);IO[t?"addSuccessEvent":"addFailedEvent"]({key:e?504700:514702}),t||(IO.addEnum({key:e?504701:514703,value:NN()}),GN.uploadEvent({log:"stat-decode-failed-".concat(this.kind,"-").concat(bN()||wN()),userId:this.room.userId}),this._log.warn("decode failed: isPlaying: ".concat(this.player.isPlaying," ").concat(this.kind===Ub.AUDIO?"audioLevel: ".concat(this.getAudioLevel()):"framesDecoded: ".concat(this.stat.framesDecoded>0))));}}),5e3));},ignoreError:!0}),cL(521716,!1)],CL.prototype,"subscribe",1),UC([SP(CL.STATE_SUBSCRIBE,AP.INIT,{sync:!0,success(){this.log.info("unsubscribed"),this.updatePlayingState(!1),jN.emit(nO.REMOTE_TRACK_UNSUBSCRIBED,{track:this}),clearTimeout(this._decodeCheckTimeoutId);}})],CL.prototype,"unsubscribe",1);var bL=class extends CL{constructor(e,t){super(e,t,1),FC(this,"volume",0),FC(this,"mediaType",1),FC(this,"stat",{bytesReceived:0,packetsReceived:0,packetsLost:0,end2EndDelay:0,jitterBufferDelay:0}),FC(this,"audioDecoder"),this.manager=e.audioManager;}onPlayerError(e){if(this.enableDecodeFrame){this._log.warn("use audio decoder"),this.room.enableInsertableStreams(),this.player.setOutput();let e=new AudioDecoder({error:e=>this._log.error(e),output:e=>{this.player.write(e);}});e.configure({codec:"opus",sampleRate:48e3,numberOfChannels:1}),this._log.info("audioDecoder state:".concat(e.state)),this.audioDecoder=e;}}get enableDecodeFrame(){var e,t;return !!this.manager&&(this.manager.decodePipeline.some((e=>e))||(null==(t=null==(e=this.player.element)?void 0:e.error)?void 0:t.code)===MediaError.MEDIA_ERR_DECODE&&lP().AudioDecoder&&oP)}decodeFrame(e){var t;if(!this.manager)return e;let i=this.manager.decodePipeline.reduce(((e,t)=>t?t({frame:e}):e),e);return "configured"===(null==(t=this.audioDecoder)?void 0:t.state)&&this.audioDecoder.decode(new EncodedAudioChunk({data:i.data,timestamp:i.timestamp,type:"key"})),i}getAudioLevel(){let e=this.volume||super.getAudioLevel();return e>1?1:e}get hasFlag(){return this.user.muteState.hasAudio}isFlagChanged(e){let t=e.hasAudio&&!e.audioMuted;return this.hasFlag||(this.volume=0),this.hasFlag!==t}},kL=[-1,-1,1,-1,-1,1,1,1],DL=[0,0,1,0,0,1,1,1],NL=class extends AP{constructor(e,t){if(super(),this.context=e,FC(this,"name"),FC(this,"input"),FC(this,"output"),FC(this,"texture"),FC(this,"ctx2d",null),FC(this,"fbo"),FC(this,"width",0),FC(this,"height",0),FC(this,"x",0),FC(this,"y",0),FC(this,"program"),FC(this,"vertexShader"),FC(this,"fragmentShader"),FC(this,"totalFrames",0),FC(this,"dropFrames",0),FC(this,"matchInputSize",!0),FC(this,"texCoordBuffer"),FC(this,"positionBuffer"),FC(this,"lastInfo",{name:"",timestamp:0,totalFrames:0,x:0,y:0,width:0,height:0,fps:0}),FC(this,"cost",0),FC(this,"_canvas",null),FC(this,"_image"),FC(this,"log"),this.context.on("disconnect",this.close,this),this.name=t.name,this.log=t.logger,this.matchInputSize=!1!==t.matchInputSize,this.width=t.width||e.width,this.height=t.height||e.height,this._image=t.image,e instanceof yx){if(e.ctx&&t.create2d){let e=document.createElement("canvas"),t="function"==typeof e.transferControlToOffscreen?e.transferControlToOffscreen():e;t.width=this.width,t.height=this.height,this.ctx2d=t.getContext("2d"),this._image=t,this._canvas=t;}}else try{let i=e.ctx;this.texCoordBuffer=this.createBuffer(DL),this.positionBuffer=this.createBuffer(kL),!1!==t.createTexture&&(this.texture=i.createTexture(),this.useTexture(),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,i.LINEAR),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,i.LINEAR),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_S,i.CLAMP_TO_EDGE),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_T,i.CLAMP_TO_EDGE),i.pixelStorei(i.PACK_ALIGNMENT,1),i.pixelStorei(i.UNPACK_ALIGNMENT,1)),t.useFbo&&(this.fbo=i.createFramebuffer(),this.useBufferFrame(),this.useTexture(),i.texImage2D(i.TEXTURE_2D,0,i.RGBA,this.width,this.height,0,i.RGBA,i.UNSIGNED_BYTE,null),i.framebufferTexture2D(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0,i.TEXTURE_2D,this.texture,0)),t.useDefaultProgram?this.program=e.defaultProgam:(t.vertexShaderSource||t.fragmentShaderSource)&&(this.vertexShader=t.vertexShaderSource?e.createShader(i.VERTEX_SHADER,t.vertexShaderSource):e.defaultVShader,this.fragmentShader=t.fragmentShaderSource?e.createShader(i.FRAGMENT_SHADER,t.fragmentShaderSource):e.defaultFShader,this.program=e.createProgram(this.vertexShader,this.fragmentShader));}catch(ub){this.context.destroy(new tb({code:ZC.VIDEO_MANAGER_ERROR,extraCode:3,message:"create video node ".concat(this.name," error ").concat(ub.message||ub)}));}}get image(){return this._image}set image(e){this._image=e;}createFramebuffer(e){let t=this.context.ctx,i=t.createFramebuffer();return t.bindFramebuffer(t.FRAMEBUFFER,i),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,e,0),i}connect(e){for(var t=arguments.length,i=new Array(t>1?t-1:0),r=1;r<t;r++)i[r-1]=arguments[r];return e.addInput(this,...i),this.output=e,e}addInput(e){this.input=e,this.matchInputSize&&e.width&&e.height&&this.resize(e.width,e.height);}requestFrame(e){let t=Date.now();return !!(this.context instanceof vx&&this.render(e)||this.context instanceof yx&&this.render2d(e))&&(this.totalFrames++,this.cost=Date.now()-t,!0)}render2d(e){var t;return !(null==(t=this.input)||!t.requestFrame(e))&&this.draw2d(this.input.image,0,0,this.width,this.height)}update(e){var t;null==(t=this.output)||t.update(e);}disconnect(){for(var e,t=arguments.length,i=new Array(t),r=0;r<t;r++)i[r]=arguments[r];null==(e=this.output)||e.removeInput(this,...i),delete this.output;}removeInput(e){delete this.input;}close(){var e,t;if(this.context.off("disconnect",this.close,this),null==(e=this.output)||e.removeInput(this),delete this.output,null==(t=this.input)||t.disconnect(),this.context instanceof vx){let e=this.context.ctx;e.deleteBuffer(this.texCoordBuffer),e.deleteBuffer(this.positionBuffer),this.fbo&&e.deleteFramebuffer(this.fbo),this.texture&&e.deleteTexture(this.texture),this.vertexShader&&this.vertexShader!==this.context.defaultVShader&&e.deleteShader(this.vertexShader),this.fragmentShader&&this.fragmentShader!==this.context.defaultFShader&&e.deleteShader(this.fragmentShader),this.program&&this.program!==this.context.defaultProgam&&e.deleteProgram(this.program);}this._canvas&&(this._canvas.width=0,this._canvas.height=0,this.ctx2d=null),this.removeAllListeners();}useTexture(){this.useTextures(this.texture);}useInputTexture(){var e;this.useTextures(null==(e=this.input)?void 0:e.texture);}useTextures(){let e=this.context.ctx;for(var t=arguments.length,i=new Array(t),r=0;r<t;r++)i[r]=arguments[r];i.forEach(((t,i)=>{t&&(e.activeTexture(e.TEXTURE0+i),e.bindTexture(e.TEXTURE_2D,t));}));}useProgram(){this.context.ctx.useProgram(this.program);}useBufferFrame(){let e=this.context.ctx;e.bindFramebuffer(e.FRAMEBUFFER,this.fbo||null);}createBuffer(e){let t=this.context.ctx,i=t.createBuffer();return t.bindBuffer(t.ARRAY_BUFFER,i),t.bufferData(t.ARRAY_BUFFER,new Float32Array(e),t.STATIC_DRAW),i}setTexBuffer(e){let t=this.context.ctx;t.bindBuffer(t.ARRAY_BUFFER,this.texCoordBuffer),t.bufferData(t.ARRAY_BUFFER,new Float32Array(e),t.STATIC_DRAW);}setPosBuffer(e){let t=this.context.ctx;t.bindBuffer(t.ARRAY_BUFFER,this.positionBuffer),t.bufferData(t.ARRAY_BUFFER,new Float32Array(e),t.STATIC_DRAW);}changeBufferData(e,t){let i=this.context.ctx;i.bindBuffer(i.ARRAY_BUFFER,e),i.bufferData(i.ARRAY_BUFFER,new Float32Array(t),i.STATIC_DRAW);}setAttributes(){let e=this.context.ctx;for(var t=arguments.length,i=new Array(t),r=0;r<t;r++)i[r]=arguments[r];i.forEach(((t,i)=>{e.enableVertexAttribArray(i),e.bindBuffer(e.ARRAY_BUFFER,t),e.vertexAttribPointer(i,2,e.FLOAT,!1,0,0);}));}getVertexPoint(e,t){return [e/this.width*2-1,t/this.height*2-1]}layout2texCoords(e){return [...this.getVertexPoint(e.x,e.y),...this.getVertexPoint(e.x+e.width,e.y),...this.getVertexPoint(e.x,e.y+e.height),...this.getVertexPoint(e.x+e.width,e.y+e.height)]}resize(e,t){if(this.width!==e||this.height!==t){if(this.width=e,this.height=t,this._canvas&&(this._canvas.width=e,this._canvas.height=t),this.texture&&this.fbo){this.useTexture();let i=this.context.ctx;i.texImage2D(i.TEXTURE_2D,0,i.RGBA,e,t,0,i.RGBA,i.UNSIGNED_BYTE,null);}this.output&&this.output.matchInputSize&&this.output.resize(e,t);}}draw(e,t){this.setAttributes(e||this.positionBuffer,t||this.texCoordBuffer);let i=this.context.ctx;i.drawArrays(i.TRIANGLE_STRIP,0,4);}draw2d(e,t,i,r,n){return !(!this.ctx2d||!e)&&(e instanceof ImageData?this.ctx2d.putImageData(e,t,i):this.ctx2d.drawImage(e,t,i,r,n),!0)}getInfo(){var e;let{totalFrames:t,x:i,y:r,width:n,height:o,name:s,cost:a}=this,c=Date.now(),l=(t-this.lastInfo.totalFrames)/((c-this.lastInfo.timestamp)/1e3)|0;return this.lastInfo={totalFrames:t,x:i,y:r,width:n,height:o,timestamp:c,fps:l,name:s,cost:a},PC({parent:null==(e=this.input)?void 0:e.getInfo()},this.lastInfo)}createTexture(e){let t=this.context.ctx,i=t.createTexture();return this.useTextures(i),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.pixelStorei(t.PACK_ALIGNMENT,1),t.pixelStorei(t.UNPACK_ALIGNMENT,1),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,e),i}};function wL(){}UC([SP(AP.INIT,"connected",{sync:!0})],NL.prototype,"connect",1),UC([SP("connected",AP.INIT,{ignoreError:!0,sync:!0})],NL.prototype,"disconnect",1),UC([SP([],"closed",{sync:!0})],NL.prototype,"close",1);var OL=e=>e();function PL(){this.dispose();}var ML=()=>"undefined"!=typeof __FASTRX_DEVTOOLS__,LL=1,xL=class extends Function{toString(){return "".concat(this.name,"(").concat(this.args.length?[...this.args].join(", "):"",")")}subscribe(e){let t=new GL(e,this,this.streamId++);return JL.subscribe({id:this.id,end:!1},{nodeId:t.sourceId,streamId:t.id}),this(t),t}},VL=class{constructor(){this.defers=new Set,this.disposed=!1;}next(e){}complete(){this.dispose();}error(e){this.dispose();}get bindDispose(){return ()=>this.dispose()}dispose(){this.disposed=!0,this.complete=wL,this.error=wL,this.next=wL,this.dispose=wL,this.subscribe=wL,this.doDefer();}subscribe(e){return e instanceof xL?e.subscribe(this):e(this),this}get bindSubscribe(){return e=>this.subscribe(e)}doDefer(){this.defers.forEach(OL),this.defers.clear();}defer(e){this.defers.add(e);}removeDefer(e){this.defers.delete(e);}reset(){this.disposed=!1,delete this.complete,delete this.next,delete this.dispose,delete this.next,delete this.subscribe;}resetNext(){delete this.next;}resetComplete(){delete this.complete;}resetError(){delete this.error;}},UL=class extends VL{constructor(e){super(),this.sink=e,e.defer(this.bindDispose);}next(e){this.sink.next(e);}complete(){this.sink.complete();}error(e){this.sink.error(e);}},FL=class extends VL{constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:wL,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:wL,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:wL;if(super(),this._next=t,this._error=i,this._complete=r,this.then=wL,e instanceof xL){let n={toString:()=>"subscribe",id:0,source:e};this.defer((()=>{JL.defer(n,0);})),JL.create(n),JL.pipe(n),this.sourceId=n.id,this.subscribe(e),JL.subscribe({id:n.id,end:!0}),t==wL?this._next=e=>JL.next(n,0,e):this.next=e=>{JL.next(n,0,e),t(e);},r==wL?this._complete=()=>JL.complete(n,0):this.complete=()=>{this.dispose(),JL.complete(n,0),r();},i==wL?this._error=e=>JL.complete(n,0,e):this.error=e=>{this.dispose(),JL.complete(n,0,e),i();};}else this.subscribe(e);}next(e){this._next(e);}complete(){this.dispose(),this._complete();}error(e){this.dispose(),this._error(e);}};function BL(e){for(var t=arguments.length,i=new Array(t>1?t-1:0),r=1;r<t;r++)i[r-1]=arguments[r];return i.reduce(((e,t)=>t(e)),e)}function HL(e,t,i){if(ML()){let r=Object.defineProperties(Object.setPrototypeOf(e,xL.prototype),{streamId:{value:0,writable:!0,configurable:!0},name:{value:t,writable:!0,configurable:!0},args:{value:i,writable:!0,configurable:!0},id:{value:0,writable:!0,configurable:!0}});JL.create(r);for(let e=0;e<i.length;e++){let t=i[e];"function"==typeof t&&t instanceof xL&&JL.addSource(r,t);}return r}return e}function jL(e,t){return function(){for(var i=arguments.length,r=new Array(i),n=0;n<i;n++)r[n]=arguments[n];return i=>{if(i instanceof xL){let n=HL((t=>{let o=new e(t,...r);o.sourceId=n.id,o.subscribe(i);}),t,arguments);return n.source=i,JL.pipe(n),n}return t=>i(new e(t,...r))}}}function WL(e,t){window.postMessage({source:"fastrx-devtools-backend",payload:{event:e,payload:t}});}var GL=class extends UL{constructor(e,t,i){super(e),this.source=t,this.id=i,this.sourceId=e.sourceId,this.defer((()=>{JL.defer(this.source,this.id);}));}next(e){JL.next(this.source,this.id,e),this.sink.next(e);}complete(){JL.complete(this.source,this.id),this.sink.complete();}error(e){JL.complete(this.source,this.id,e),this.sink.error(e);}},JL={addSource(e,t){WL("addSource",{id:e.id,name:e.toString(),source:{id:t.id,name:t.toString()}});},next(e,t,i){WL("next",{id:e.id,streamId:t,data:i&&i.toString()});},subscribe(e,t){let{id:i,end:r}=e;WL("subscribe",{id:i,end:r,sink:{nodeId:t&&t.nodeId,streamId:t&&t.streamId}});},complete(e,t,i){WL("complete",{id:e.id,streamId:t,err:i?i.toString():null});},defer(e,t){WL("defer",{id:e.id,streamId:t});},pipe(e){WL("pipe",{name:e.toString(),id:e.id,source:{id:e.source.id,name:e.source.toString()}});},update(e){WL("update",{id:e.id,name:e.toString()});},create(e){e.id||(e.id=LL++),WL("create",{name:e.toString(),id:e.id});}},KL=class extends VL{constructor(e){super(),this.source=e,this.sinks=new Set;}add(e){e.defer((()=>this.remove(e))),1===this.sinks.add(e).size&&(this.reset(),this.subscribe(this.source));}remove(e){this.sinks.delete(e),0===this.sinks.size&&this.dispose();}next(e){this.sinks.forEach((t=>t.next(e)));}complete(){this.sinks.forEach((e=>e.complete())),this.sinks.clear();}error(e){this.sinks.forEach((t=>t.error(e))),this.sinks.clear();}};function zL(){return e=>{let t=new KL(e);if(e instanceof xL){let i=HL((e=>{t.add(e);}),"share",arguments);return t.sourceId=i.id,i.source=e,JL.pipe(i),i}return HL(t.add.bind(t),"share",arguments)}}function qL(e,t){return i=>{let r=e=>i.next(e);i.defer((()=>t(r))),e(r);}}function YL(e,t){if("on"in e&&"off"in e)return HL(qL((i=>e.on(t,i)),(i=>e.off(t,i))),"fromEvent",arguments);if("addListener"in e&&"removeListener"in e)return HL(qL((i=>e.addListener(t,i)),(i=>e.removeListener(t,i))),"fromEvent",arguments);if("addEventListener"in e)return HL(qL((i=>e.addEventListener(t,i)),(i=>e.removeEventListener(t,i))),"fromEvent",arguments);throw "target is not a EventDispachter"}var QL=jL(class extends UL{constructor(e,t,i){super(e),this.filter=t,this.thisArg=i;}next(e){this.filter.call(this.thisArg,e)&&this.sink.next(e);}},"filter"),XL=jL(class extends UL{constructor(e,t){super(e),this.count=t;}next(e){this.sink.next(e),0==--this.count&&this.complete();}},"take"),$L=jL(class extends UL{constructor(e,t){super(e);let i=new UL(e);i.next=()=>e.complete(),i.complete=PL,i.subscribe(t);}},"takeUntil"),ZL=jL(class extends UL{constructor(e,t){super(e),this.f=t;}next(e){this.f(e)||(this.next=super.next,this.next(e));}},"skipWhile"),ex=jL(class extends UL{constructor(e,t,i){super(e),this.mapper=t,this.thisArg=i;}next(e){super.next(this.mapper.call(this.thisArg,e));}},"map"),tx=class extends UL{constructor(e,t,i){super(e),this.data=t,this.context=i;}next(e){let t=this.context.combineResults;t?this.sink.next(t(this.data,e)):this.sink.next(e);}tryComplete(){this.context.resetComplete(),this.dispose();}},ix=class extends UL{constructor(e,t,i){super(e),this.makeSource=t,this.combineResults=i,this.index=0;}subInner(e,t){let i=this.currentSink=new t(this.sink,e,this);this.complete=this.tryComplete,i.complete=i.tryComplete,i.subscribe(this.makeSource(e,this.index++));}tryComplete(){this.currentSink.resetComplete(),this.dispose();}},rx=class extends tx{},nx=class extends ix{next(e){this.subInner(e,rx),this.next=e=>{this.currentSink.dispose(),this.subInner(e,rx);};}},ox=jL(nx,"switchMap");var sx,ax=(sx=jL(nx,"switchMapTo"),(e,t)=>sx((()=>e),t)),cx=function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:wL,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:wL,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:wL;return r=>new FL(r,e,t,i)},lx=BL(function(e){return HL((t=>{let i=0,r=setInterval((()=>t.next(i++)),e);return t.defer((()=>{clearInterval(r);})),"interval"}),"interval",arguments)}(250),ex((()=>performance.now())),zL()),dx=[0,1,1,1,0,0,1,0],ux=class extends NL{constructor(e,t){super(e,Object.assign({useDefaultProgram:!0,createTexture:!1,name:"destination"},t)),FC(this,"_intervalId",0),FC(this,"_sequence",0),FC(this,"checkGLError",!1),FC(this,"checkVisibilityChange"),e instanceof yx?this.ctx2d=e.ctx||null:e.available&&(null==t?void 0:t.mirrorUpAndDown)&&this.setTexBuffer(dx);}start(e){this.log.info("".concat(this.name," start render ").concat(e," fps")),NP.clearTask(this._intervalId),this._intervalId=NP.run("intervalInWorker",(()=>{if(e!==this.context.frameRate&&(NP.clearTask(this._intervalId),this.start(this.context.frameRate)),this.requestFrame(this._sequence++),this.checkGLError&&this.context instanceof vx){let e=this.context.ctx.getError();e&&this.context.destroy(new tb({code:ZC.VIDEO_MANAGER_ERROR,extraCode:5,message:"".concat(this.name," req ").concat(this._sequence," render ").concat(this.totalFrames," faild ").concat(e)}));}}),{fps:this.context.frameRate});}render(e){var t;return !(null==(t=this.input)||!t.requestFrame(e))&&(this.useProgram(),this.useBufferFrame(),this.useInputTexture(),this.draw(),!0)}addInput(e){for(var t=arguments.length,i=new Array(t>1?t-1:0),r=1;r<t;r++)i[r-1]=arguments[r];super.addInput(e,...i),this.start(this.context.frameRate);}update(e){if(this._intervalId&&(NP.clearTask(this._intervalId),this._intervalId=0,1===e)){this.log.info("".concat(this.name," use requestVideoFrameCallback"));let e=()=>{document.hidden&&(this.start(this.context.frameRate),this.log.info("".concat(this.name," use timer")),document.removeEventListener("visibilitychange",e));};document.addEventListener("visibilitychange",e);}this.requestFrame(this._sequence++);}removeInput(e){super.removeInput(e),NP.clearTask(this._intervalId);}resize(e,t){super.resize(e,t),this.context.setSize(e,t);}close(){super.close(),NP.clearTask(this._intervalId),document.removeEventListener("visibilitychange",this.checkVisibilityChange);}},hx=class extends ux{constructor(e,t){super(e,t),FC(this,"_videoTrack"),FC(this,"_muteOb"),FC(this,"_closedOb",YL(this,"closed")),FC(this,"_subscription"),FC(this,"_canvasContainer"),Number(pN)<17&&(this._canvasContainer=document.createElement("div"),this._canvasContainer.style.display="none"),[this._videoTrack]=e._canvas.captureStream().getVideoTracks(),this._muteOb=YL(this._videoTrack,"mute"),BL(YL(this._videoTrack,"ended"),$L(this._closedOb),cx((()=>{this.context.destroy(new tb({code:ZC.VIDEO_MANAGER_ERROR,extraCode:8,message:"video track ended"}));})));}enableCheckMute(){this._subscription=BL(this._muteOb,$L(this._closedOb),ax((e=>t=>{let i=performance.now();BL(lx,ZL((t=>t-i<e)),XL(1))(t);})(5e3)),cx((()=>{var e;null==(e=this._videoTrack)||!e.muted||this.context.destroy(new tb({code:ZC.VIDEO_MANAGER_ERROR,extraCode:7,message:"video track muted"}));})));}disableCheckMute(){var e;null==(e=this._subscription)||e.dispose();}get videoTrack(){return this._videoTrack}putCanvasIntoDom(){!this.context._canvas||!this._canvasContainer||document.getElementById(this.context._canvas.id)||(this.log.info("".concat(this.name," put canvas to body")),document.body.appendChild(this._canvasContainer),this._canvasContainer.appendChild(this.context._canvas));}render(e){return this.putCanvasIntoDom(),super.render(e)}render2d(e){return this.putCanvasIntoDom(),super.render2d(e)}close(){var e,t;super.close(),null==(e=this._videoTrack)||e.stop(),delete this._videoTrack,null==(t=this._canvasContainer)||t.remove();}},px=class extends hx{render(e){var t;return !(null==(t=this.input)||!t.requestFrame(e))}},mx=class extends hx{constructor(e,t,i){super(e,{name:"smallDestination",logger:i}),this.resolution=t;}resize(e,t){let i,r=e*t,n=this.resolution.width*this.resolution.height;this.log.info("big res: ".concat(e,"*").concat(t," small res: ").concat(this.resolution.width,"*").concat(this.resolution.height," ")),r>n?i=r/n:(this.log.warn("Small stream resolution is not smaller than big stream, which is invalid. big: ".concat(e," * ").concat(t," small: ").concat(this.resolution.width," * ").concat(this.resolution.height)),i=r/19200),super.resize(e/Math.sqrt(i),t/Math.sqrt(i));}},_x=class extends NL{constructor(e,t){super(e,PC({name:"imageSource"},t)),FC(this,"_lastImage"),FC(this,"_totalFrames",0),FC(this,"_autoResize",!1),FC(this,"_canvasRendered"),FC(this,"_videoCallbackId",0),this._autoResize=!1!==(null==t?void 0:t.autoResize),16===fN&&(this._canvasRendered=function(e){let t=arguments,i=zL()(HL((t=>{i.next=e=>t.next(e),i.complete=()=>t.complete(),i.error=e=>t.error(e),e&&t.subscribe(e);}),"subject",t));return i.next=wL,i.complete=wL,i.error=wL,i}(),BL(this._canvasRendered,function(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];return e=>HL((function(i){let r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:t.length;for(;r<n&&!i.disposed;)i.next(t[r++]);i.disposed||i.subscribe(e);}),"startWith",arguments)}(this._image),ox((e=>e instanceof HTMLCanvasElement?YL(e,"rendered"):function(){return HL((e=>e.complete()),"empty",arguments)}())),$L(YL(this,"closed")),cx((()=>{this.update(0);}))));}tryVideoFrameCallback(e){this._videoCallbackId&&e.cancelVideoFrameCallback(this._videoCallbackId),_P()&&!document.hidden&&(this._videoCallbackId=e.requestVideoFrameCallback(((e,t)=>{document.hidden||(this._totalFrames=t.presentedFrames,this.update(1));})));}_render(e,t){let{width:i,height:r}=this,{image:n}=this;if(n instanceof HTMLVideoElement){if(this.tryVideoFrameCallback(n),({videoWidth:i,videoHeight:r}=n),!i||!r)return !1;n.width=i,n.height=r;}else if(n instanceof HTMLImageElement||n instanceof ImageData||n instanceof ImageBitmap){if(({width:i,height:r}=n),n!==this._lastImage)this._lastImage=n;else if(i===this.width&&r===this.height)return !1}else (n instanceof HTMLCanvasElement||n instanceof OffscreenCanvas)&&(({width:i,height:r}=n),this._lastImage=n);if(!this._autoResize)return !0;if(this.width===i&&this.height===r&&this.totalFrames){if(t){this.useTexture();let e=this.context.ctx;e.texSubImage2D(e.TEXTURE_2D,0,0,0,e.RGBA,e.UNSIGNED_BYTE,n);}}else {if(t){this.useTexture();let e=this.context.ctx;e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,n);}this.resize(i,r);}return !0}get image(){return this._image}set image(e){var t;null==(t=this._canvasRendered)||t.next(e),this._image=e;}render(e){return this._render(e,!0)}render2d(e){return this._render(e,!1)}},fx=class extends _x{constructor(e,t,i){super(e,i),this._player=t,this.name="videoPlayerSource",BL(YL(this._player,wP.PLAYER_STATE_CHANGED),$L(YL(this,"closed")),QL((e=>{let{state:t}=e;return "PLAYING"===t})),cx((()=>{this.tryVideoFrameCallback(this._player.element);})));}get image(){return this._player.element}},gx=class extends fx{constructor(e,t,i){super(e,new aM({id:i.name,track:t,muted:!0,container:null,objectFit:"contain",log:i.logger}),i),this.name="videoTrackSource",this._player.play();}replaceTrack(e){this._player.setTrack(e),this._player.play();}close(){super.close(),this._player.stop();}},Tx=class extends AP{constructor(e){super(),FC(this,"frameRate"),FC(this,"_canvas"),FC(this,"log"),FC(this,"hasAlpha",!1),FC(this,"name"),FC(this,"error"),this.name=e.name,this.log=e.logger.createChild({id:"vc-".concat(this.name)}),this.frameRate=e.frameRate;}set width(e){this._canvas&&(this._canvas.width=e);}get width(){var e;return (null==(e=this._canvas)?void 0:e.width)||0}set height(e){this._canvas&&(this._canvas.height=e);}get height(){var e;return (null==(e=this._canvas)?void 0:e.height)||0}setSize(e,t){this._canvas&&(this._canvas.width=e,this._canvas.height=t);}createVideoTrackSource(e,t){return new gx(this,e,{logger:this.log,name:t})}createVideoTrackDestination(e){return new hx(this,e)}createVideoImageSource(e,t){return new _x(this,t?Object.assign(t,{logger:this.log,image:e}):{logger:this.log,image:e})}createVideoPlayerSource(e,t){return new fx(this,e,t?Object.assign(t,{logger:this.log}):{logger:this.log})}get available(){return "created"===this.state}disconnect(){this.emit("disconnect");}};FC(Tx,"_ids",0);var Ex={alpha:!0,antialias:!1,premultipliedAlpha:!1,preserveDrawingBuffer:!1,depth:!1,stencil:!1,failIfMajorPerformanceCaveat:!0,powerPreference:"low-power"},vx=class extends Tx{constructor(){super(...arguments),FC(this,"defaultProgam"),FC(this,"defaultVShader"),FC(this,"defaultFShader"),FC(this,"ctx");}create(){if(this._canvas||(this._canvas=document.createElement("canvas"),this._canvas.id="trtc_".concat(this.name,"_").concat(Tx._ids++)),this.ctx=this._canvas.getContext("webgl2",Ex),!this.ctx)throw new tb({code:ZC.VIDEO_MANAGER_ERROR,extraCode:2,message:"webgl2 not supported"});this.defaultVShader=this.createShader(this.ctx.VERTEX_SHADER,"\n// 顶点着色器\nattribute vec4 a_position;\nattribute vec2 a_texCoord;\nvarying vec2 v_texCoord;\n\nvoid main() {\n  gl_Position = a_position;\n  v_texCoord = a_texCoord;\n}\n"),this.defaultFShader=this.createShader(this.ctx.FRAGMENT_SHADER,"\n// 片元着色器\nprecision mediump float;\nvarying vec2 v_texCoord;\nuniform sampler2D u_texture;\n\nvoid main() {\n  gl_FragColor = texture2D(u_texture, v_texCoord);\n} "),this.defaultProgam=this.createProgram(this.defaultVShader,this.defaultFShader),this._canvas.addEventListener("webglcontextlost",(()=>{this.destroy(new tb({code:ZC.VIDEO_MANAGER_ERROR,extraCode:4,message:"webgl context lost"}));})),this.log.info("video context created use webgl");}destroy(e){let t="";return e&&(t=e.message,this.error=e,IO.addFailedEvent({key:512702,error:e})),this.disconnect(),this.log.info("video context destroy".concat(t)?": ".concat(t):""),this.ctx&&(this.ctx.deleteShader(this.defaultVShader),this.ctx.deleteShader(this.defaultFShader),this.ctx.deleteProgram(this.defaultProgam),delete this.ctx),e}set width(e){var t;null==(t=this.ctx)||t.viewport(0,0,e,this.height),super.width=e;}set height(e){var t;null==(t=this.ctx)||t.viewport(0,0,this.width,e),super.height=e;}setSize(e,t){var i;null==(i=this.ctx)||i.viewport(0,0,e,t),super.setSize(e,t);}createShader(e,t){let i=this.ctx,r=i.createShader(e);return i.shaderSource(r,t),i.compileShader(r),r}createProgram(e,t){let i=this.ctx,r=i.createProgram();return i.attachShader(r,e),i.attachShader(r,t),i.linkProgram(r),i.getProgramParameter(r,i.LINK_STATUS)||this.log.error(i.getProgramInfoLog(r)),r}};UC([SP(AP.INIT,"created",{sync:!0,fail(e){IO.addFailedEvent({key:512700,error:e.cause});},success(){IO.addSuccessEvent({key:512700});}})],vx.prototype,"create",1),UC([SP("created",AP.INIT,{ignoreError:!0,sync:!0,success(e){e&&this.emit("unavailable",e),this.removeAllListeners();}})],vx.prototype,"destroy",1);var yx=class extends Tx{constructor(){super(...arguments),FC(this,"ctx");}create(e){if(this.hasAlpha=e.alpha,this._canvas=document.createElement("canvas"),this._canvas.id="trtc_".concat(this.name,"_").concat(Tx._ids++),this.ctx=this._canvas.getContext("2d",{alpha:e.alpha}),!this.ctx)throw new tb({code:ZC.VIDEO_MANAGER_ERROR,extraCode:2,message:"2d context not supported"});this.log.info("video context created use 2d");}destroy(e){let t="";e&&(t=e.message,this.error=e,IO.addFailedEvent({key:512703,error:e})),this.disconnect(),this.log.info("video context destroy ".concat(t?": ".concat(t):"")),delete this.ctx,this._canvas&&(this._canvas.remove(),this._canvas.width=0,this._canvas.height=0,delete this._canvas),this.removeAllListeners(),IO.addSuccessEvent({key:512703});}};UC([SP(AP.INIT,"created",{sync:!0,fail(e){IO.addFailedEvent({key:512701,error:e.cause});},success(){IO.addSuccessEvent({key:512701});}})],yx.prototype,"create",1),UC([SP("created",AP.INIT,{ignoreError:!0,sync:!0})],yx.prototype,"destroy",1);var Sx=class extends CL{constructor(e,t){super(e,t,arguments.length>2&&void 0!==arguments[2]?arguments[2]:4),FC(this,"mediaType",4),FC(this,"source"),FC(this,"stat",{bytesReceived:0,packetsReceived:0,packetsLost:0,framesReceived:0,framesDecoded:0,frameWidth:0,frameHeight:0,end2EndDelay:0,jitterBufferDelay:0}),this.manager=e.videoManager;}play(e,t){return (Aw(null==t?void 0:t.canvasRender)?t.canvasRender:17===fN)&&!this.source&&this.useCanvasPlayer(),super.play(e,t)}useCanvasPlayer(){if(this.log.info("useCanvasPlayer(), ".concat(!!this.player.element)),!this.player.element)return;let e=new yx({frameRate:15,logger:this.log,name:this.userId});e.create({alpha:!1});let t=e.createVideoPlayerSource(this.player);this.source=t;let i=new ux(e,{name:"remotePlayer",logger:this.log});t.connect(i),this.player.setCanvas(e._canvas),_P()||(this.updateCanvasPlayerFPS=this.updateCanvasPlayerFPS.bind(this,e),this.room.on("heartbeat-report",this.updateCanvasPlayerFPS,this));}updateCanvasPlayerFPS(e){let t=this.decodeFPS,i=function(e){return [15,30,45,60].reduce(((t,i)=>Math.abs(i-e)<Math.abs(t-e)?i:t))}(t);!Rw(t)||t<=0?this.log.debug("updateCanvasPlayerFPS() ignore decoder: ".concat(t," ")):i!==e.frameRate?(this.log.info("updateCanvasPlayerFPS() decoder: ".concat(t,", closest: ").concat(i,", current: ").concat(e.frameRate)),e.frameRate=i):this.log.debug("updateCanvasPlayerFPS() ignore ClosestFPS ".concat(i," == ").concat(e.frameRate));}get decodeFPS(){var e;let{msg_video_status:t}=(null==(e=this.room.heartbeatReport)?void 0:e.msg_down_stream_info.find((e=>e.msg_user_info.str_identifier===this.userId)))||{},i=2===this.mediaType?7:this.isSmall?3:2;if(!t||0===t.length)return 0;let r=t.find((e=>e.uint32_video_stream_type===i));return (null==r?void 0:r.uint32_video_dec_fps)||0}stop(){return this.room.off("heartbeat-report",this.updateCanvasPlayerFPS,this),super.stop()}get enableDecodeFrame(){return !!this.manager&&this.manager.decodePipeline.some((e=>e))}decodeFrame(e){return this.manager?this.manager.decodePipeline.reduce(((e,t)=>t?t({frame:e,track:this}):e),e):e}get isBig(){return 4===this.mediaType}get isSmall(){return 8===this.mediaType}changeType(e){this.room.changeType(e,this.user);}get hasFlag(){return this.user.muteState.hasVideo&&!this.user.muteState.videoMuted}isFlagChanged(e){let t=e.hasVideo&&!e.videoMuted;return this.hasFlag!==t}setMirror(e){"publish"===e||"both"===e||super.setMirror(e);}},Ix=class extends Sx{constructor(e,t){super(e,t,2),FC(this,"mediaType",2),FC(this,"objectFit","contain");}get hasFlag(){return this.user.muteState.hasAuxiliary}isFlagChanged(e){let t=e.hasAuxiliary;return this.hasFlag!==t}},Rx=new Map;function Ax(e,t){let i=MC(PC({},t),{timestamp:rb()});Rx.has(e)?Rx.get(e).push(i):Rx.set(e,[i]);}jN.on(nO.JOIN_SUCCESS,(e=>{let{room:t}=e;Ax(t.userId,{eventId:32788});})),jN.on(nO.LEAVE_START,(e=>{let{room:t}=e;Ax(t.userId,{eventId:32789});})),jN.on(nO.LOCAL_TRACK_PUBLISHED,(e=>{let{track:t}=e;if(t.room){let e=32769;4===t.mediaType?e=32768:2===t.mediaType&&(e=32805),Ax(t.room.userId,{eventId:e});}})),jN.on(nO.LOCAL_TRACK_UNPUBLISHED,(e=>{let{track:t}=e;if(t.room){let e=32771;4===t.mediaType?e=32770:2===t.mediaType&&(e=32806),Ax(t.room.userId,{eventId:e});}})),jN.on(nO.TRACK_MUTED,(e=>{let{track:t}=e;t.room&&(t.kind===Ub.AUDIO?Ax(t.room.userId,{eventId:t.isRemote?32785:32772,remoteUserId:t.isRemote?t.userId:void 0}):Ax(t.room.userId,{eventId:t.isRemote?32784:32773,remoteUserId:t.isRemote?t.userId:void 0}));})),jN.on(nO.TRACK_UNMUTED,(e=>{let{track:t}=e;t.room&&(t.kind===Ub.AUDIO?Ax(t.room.userId,{eventId:t.isRemote?32787:32774,remoteUserId:t.isRemote?t.userId:void 0}):Ax(t.room.userId,{eventId:t.isRemote?32786:32775,remoteUserId:t.isRemote?t.userId:void 0}));})),jN.on(nO.REMOTE_TRACK_SUBSCRIBED,(e=>{let{track:t}=e;!t.room||(1===t.mediaType&&Ax(t.room.userId,{eventId:32777,remoteUserId:t.userId}),4===t.mediaType&&Ax(t.room.userId,{eventId:32776,remoteUserId:t.userId}),8===t.mediaType&&Ax(t.room.userId,{eventId:32803,remoteUserId:t.userId}));})),jN.on(nO.REMOTE_TRACK_UNSUBSCRIBED,(e=>{let{track:t}=e;!t.room||(1===t.mediaType&&Ax(t.room.userId,{eventId:32779,remoteUserId:t.userId}),4===t.mediaType&&Ax(t.room.userId,{eventId:32778,remoteUserId:t.userId}),8===t.mediaType&&Ax(t.room.userId,{eventId:32804,remoteUserId:t.userId}));})),jN.on(nO.SWITCH_DEVICE_SUCCESS,(e=>{let{track:t}=e;t.room&&Ax(t.room.userId,{eventId:t.kind===Ub.VIDEO?32780:32781});})),jN.on(nO.LOCAL_TRACK_REPLACED,(e=>{let{track:t}=e;t.room&&Ax(t.room.userId,{eventId:t.kind===Ub.VIDEO?32782:32783});})),jN.on(nO.SIGNAL_CONNECTION_STATE_CHANGED,(e=>{let t,{room:i,prevState:r,state:n}=e;switch(n){case"CONNECTED":t="RECONNECTING"===r?32795:32791;break;case"DISCONNECTED":t="RECONNECTING"===r?32796:32790;break;case"RECONNECTING":t=32794;}t&&Ax(i.userId,{eventId:t});})),jN.on(nO.PEER_CONNECTION_STATE_CHANGED,(e=>{let t,{room:i,prevState:r,state:n,remoteUserId:o}=e,s=!!o;switch(n){case"CONNECTED":t="RECONNECTING"===r?s?32801:32798:s?32793:32792;break;case"DISCONNECTED":"RECONNECTING"===r&&(t=s?32802:32799);break;case"RECONNECTING":t=s?32800:32797;}t&&Ax(i.userId,{eventId:t,remoteUserId:o});})),jN.on(nO.VIDEO_CODEC_IMPLEMENTATION_CHANGED,(e=>{let{userId:t,remoteUserId:i,codec:r,isHWCodec:n,prevImplementation:o,streamType:s}=e,a=n?1:0;o||(a=n?3:2);let c="h264"===r?0:2,l={eventId:4004,param1:a,param2:c,streamType:s||2};i&&(l.remoteUserId=i,l.eventId=4005),Ax(t,l),IO.addEnum({key:i?514701:513701,value:a}),IO.addEnum({key:i?514700:513700,value:c});})),jN.on(nO.LOCAL_TRACK_RECAPTURE,(e=>{let{track:t,error:i}=e;if(t.userId){let e={eventId:2003,param1:0};t.kind===Ub.AUDIO?(e.streamType=1,i&&(e.param1=2)):(e.streamType="auxiliary"===t.streamType?7:2,i&&(e.param1=8)),Ax(t.userId,e);}}));var Cx=VC(jC(),1),bx=class extends Cx.EventEmitter{constructor(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"userId";super(),this.mySelfId=e,this._log=t,this.key=i,FC(this,"userMap",new Map),FC(this,"remotePublishedUserMap",new Map);}get hasRobotUser(){return !![...this.remotePublishedUserMap.values()].find((e=>e.isRobot))}getPublishedUser(e){return this.remotePublishedUserMap.get(e)}addUser(e){let t=e[this.key],{userId:i,tinyId:r,role:n}=e;if(this.userMap.has(t))return;let o={userId:i,tinyId:r,role:20===n?"anchor":"audience"};this.userMap.set(t,o),this.emit("1",o);}deleteUser(e,t){let i=this.userMap.get(e);if(!i)return;let r="peer leave [".concat(e,"]");Sw(t)||(r+=":".concat(Lk[t])),this._log.info(r);let n=this.remotePublishedUserMap.get(e);if(n){let t=n.muteState;n.flag=0,this.emit("5",n.userId),this.deleteRemotePublishedUser(e),this.emit("6",{prevMuteState:t,muteState:n.muteState,flag:0});}this.userMap.delete(e),this.emit("2",i.userId);}setUserList(e){this.userMap.forEach((t=>{e.findIndex((e=>e[this.key]===t[this.key]))<0&&this.deleteUser(t[this.key],0);})),e.forEach((e=>{!this.userMap.has(e[this.key])&&e[this.key]!==this.mySelfId&&this.addUser(e);}));}addRemotePublishedUser(e){this.remotePublishedUserMap.has(e[this.key])||this.remotePublishedUserMap.set(e[this.key],e);}deleteRemotePublishedUser(e){!this.remotePublishedUserMap.has(e)||this.remotePublishedUserMap.delete(e);}setRemotePublishedUserList(e){this.remotePublishedUserMap.forEach((t=>{let i=t[this.key];if(e.findIndex((e=>e[this.key]===t[this.key]))<0){this._log.info("remote [".concat(i,"] unpublish"));let e=t.muteState;t.flag=0,this.emit("5",t.userId),this.deleteRemotePublishedUser(i),this.emit("6",{prevMuteState:e,muteState:t.muteState,flag:0});}})),e.forEach((e=>{var t;let i=e[this.key];if(i===this.mySelfId)return;let{flag:r,userId:n,tinyId:o}=e,s=Bw(r,n),a=null==(t=this.remotePublishedUserMap.get(i))?void 0:t.muteState;if(a){let e=this.remotePublishedUserMap.get(i);e&&e.flag!==r&&(e.flag=r,this._log.info("remote publish updated: ".concat(JSON.stringify(e.muteState))),this.emit("6",{prevMuteState:a,muteState:s,flag:r}));}else this._log.info("remote publish. state: ".concat(JSON.stringify(s))),this.addUser({userId:n,tinyId:o,role:20}),this.emit("3",e),this.emit("6",{prevMuteState:Bw(0,n),muteState:s,flag:r});}));}clear(){this.userMap.clear(),this.remotePublishedUserMap.clear();}};function kx(e){let{timesInSecond:t,maxSizeInSecond:i,getSize:r}=e;return ZM(((e,n)=>{let o=new WeakMap;return jN.on(nO.ROOM_DESTROY,(e=>{let{room:t}=e;return o.delete(t)})),function(){let s=o.get(this);for(var a=arguments.length,c=new Array(a),l=0;l<a;l++)c[l]=arguments[l];if(s||(s={callCountInSecond:0,timestamp:0,totalSizeInSecond:0},o.set(this,s)),0===s.timestamp?s.timestamp=Date.now():Date.now()-s.timestamp>1e3&&(s.timestamp=Date.now(),s.callCountInSecond=0,s.totalSizeInSecond=0),r&&(s.totalSizeInSecond+=r(...c)),0!==s.timestamp&&Date.now()-s.timestamp<1e3&&(s.callCountInSecond>=t||s.totalSizeInSecond>i))throw new tb({code:ZC.INVALID_OPERATION,message:xN({key:zk.CALL_FREQUENCY_LIMIT,data:{isTimes:s.callCountInSecond>=t,isSize:s.totalSizeInSecond>i,name:n,timesInSecond:t,maxSizeInSecond:i}})});s.callCountInSecond++,e.call(this,...c);}}))}var Dx,Nx=!0,wx={SCENE_LIVE:"live",SCENE_RTC:"rtc",ROLE_ANCHOR:"anchor",ROLE_AUDIENCE:"audience",STREAM_TYPE_MAIN:"main",STREAM_TYPE_SUB:"sub",AUDIO_PROFILE_STANDARD:"standard",AUDIO_PROFILE_STANDARD_STEREO:"standard-stereo",AUDIO_PROFILE_HIGH:"high",AUDIO_PROFILE_HIGH_STEREO:"high-stereo",QOS_PREFERENCE_SMOOTH:"smooth",QOS_PREFERENCE_CLEAR:"clear"},Ox={INVALID_PARAMETER:5e3,INVALID_OPERATION:5100,ENV_NOT_SUPPORTED:5200,DEVICE_ERROR:5300,SERVER_ERROR:5400,OPERATION_FAILED:5500,OPERATION_ABORT:5998,UNKNOWN_ERROR:5999},Px=((Dx=Px||{})[Dx.INVALID_PARAMETER=5e3]="INVALID_PARAMETER",Dx[Dx.INVALID_PARAMETER_REQUIRED=5001]="INVALID_PARAMETER_REQUIRED",Dx[Dx.INVALID_PARAMETER_TYPE=5002]="INVALID_PARAMETER_TYPE",Dx[Dx.INVALID_PARAMETER_EMPTY=5003]="INVALID_PARAMETER_EMPTY",Dx[Dx.INVALID_PARAMETER_INSTANCE=5004]="INVALID_PARAMETER_INSTANCE",Dx[Dx.INVALID_PARAMETER_RANGE=5005]="INVALID_PARAMETER_RANGE",Dx[Dx.INVALID_PARAMETER_LESS_THAN_ZERO=5006]="INVALID_PARAMETER_LESS_THAN_ZERO",Dx[Dx.INVALID_PARAMETER_MIN=5007]="INVALID_PARAMETER_MIN",Dx[Dx.INVALID_PARAMETER_MAX=5008]="INVALID_PARAMETER_MAX",Dx[Dx.INVALID_ELEMENT_ID=5009]="INVALID_ELEMENT_ID",Dx[Dx.INVALID_ELEMENT_ID_TYPE=5010]="INVALID_ELEMENT_ID_TYPE",Dx[Dx.INVALID_STREAM_ID=5011]="INVALID_STREAM_ID",Dx[Dx.INVALID_ROOM_ID_STRING=5012]="INVALID_ROOM_ID_STRING",Dx[Dx.INVALID_ROOM_ID_INTEGER=5013]="INVALID_ROOM_ID_INTEGER",Dx[Dx.INVALID_STREAM_TYPE=5014]="INVALID_STREAM_TYPE",Dx[Dx.INVALID_ROOM_ID_REQUIED=5015]="INVALID_ROOM_ID_REQUIED",Dx[Dx.INVALID_ROOM_ID_INTEGER_STRING=5016]="INVALID_ROOM_ID_INTEGER_STRING",Dx[Dx.INVALID_BUFFER_EMPTY=5017]="INVALID_BUFFER_EMPTY",Dx[Dx.INVALID_BUFFER_OVERSIZE=5018]="INVALID_BUFFER_OVERSIZE",Dx[Dx.INVALID_OPERATION=5100]="INVALID_OPERATION",Dx[Dx.INVALID_OPERATION_NOT_JOINED=5101]="INVALID_OPERATION_NOT_JOINED",Dx[Dx.INVALID_OPERATION_REMOTE_USER_NOT_EXIST=5102]="INVALID_OPERATION_REMOTE_USER_NOT_EXIST",Dx[Dx.INVALID_OPERATION_STREAM_TYPE_NOT_EXIST=5103]="INVALID_OPERATION_STREAM_TYPE_NOT_EXIST",Dx[Dx.INVALID_OPERATION_REPEAT_CALL=5104]="INVALID_OPERATION_REPEAT_CALL",Dx[Dx.INVALID_OPERATION_NEED_VIDEO=5105]="INVALID_OPERATION_NEED_VIDEO",Dx[Dx.INVALID_OPERATION_NEED_AUDIO=5106]="INVALID_OPERATION_NEED_AUDIO",Dx[Dx.INVALID_ROLE_AUDIENCE=5107]="INVALID_ROLE_AUDIENCE",Dx[Dx.INVALID_NOT_ENABLE_SEI=5108]="INVALID_NOT_ENABLE_SEI",Dx[Dx.INVALID_NEED_CALL_PUBLISHED=5109]="INVALID_NEED_CALL_PUBLISHED",Dx[Dx.ENV_NOT_SUPPORTED=5200]="ENV_NOT_SUPPORTED",Dx[Dx.NOT_SUPPORTED_HTTP=5201]="NOT_SUPPORTED_HTTP",Dx[Dx.NOT_SUPPORTED_WEBRTC=5202]="NOT_SUPPORTED_WEBRTC",Dx[Dx.NOT_SUPPORTED_H264_ENCODE=5203]="NOT_SUPPORTED_H264_ENCODE",Dx[Dx.NOT_SUPPORTED_H264_DECODE=5204]="NOT_SUPPORTED_H264_DECODE",Dx[Dx.NOT_SUPPORTED_SCREEN_SHARE=5205]="NOT_SUPPORTED_SCREEN_SHARE",Dx[Dx.NOT_SUPPORTED_SMALL_VIDEO=5206]="NOT_SUPPORTED_SMALL_VIDEO",Dx[Dx.NOT_SUPPORTED_SEI=5207]="NOT_SUPPORTED_SEI",Dx[Dx.NOT_SUPPORTED_WEBGL=5208]="NOT_SUPPORTED_WEBGL",Dx[Dx.NOT_SUPPORTED_CHROME_VERSION=5209]="NOT_SUPPORTED_CHROME_VERSION",Dx[Dx.NOT_SUPPORTED_PLUGIN=5210]="NOT_SUPPORTED_PLUGIN",Dx[Dx.DEVICE_ERROR=5300]="DEVICE_ERROR",Dx[Dx.DEVICE_NOT_FOUND_ERROR=5301]="DEVICE_NOT_FOUND_ERROR",Dx[Dx.DEVICE_NOT_ALLOWED_ERROR=5302]="DEVICE_NOT_ALLOWED_ERROR",Dx[Dx.DEVICE_NOT_READABLE_ERROR=5303]="DEVICE_NOT_READABLE_ERROR",Dx[Dx.DEVICE_OVERCONSTRAINED_ERROR=5304]="DEVICE_OVERCONSTRAINED_ERROR",Dx[Dx.DEVICE_INVALID_STATE_ERROR=5305]="DEVICE_INVALID_STATE_ERROR",Dx[Dx.DEVICE_SECURITY_ERROR=5306]="DEVICE_SECURITY_ERROR",Dx[Dx.DEVICE_ABORT_ERROR=5307]="DEVICE_ABORT_ERROR",Dx[Dx.CAMERA_RECOVER_FAILED=5308]="CAMERA_RECOVER_FAILED",Dx[Dx.MICROPHONE_RECOVER_FAILED=5309]="MICROPHONE_RECOVER_FAILED",Dx[Dx.SERVER_ERROR=5400]="SERVER_ERROR",Dx[Dx.NEED_TO_BUY=5401]="NEED_TO_BUY",Dx[Dx.ACCOUNT_NO_MONEY=-100013]="ACCOUNT_NO_MONEY",Dx[Dx.OPERATION_FAILED=5500]="OPERATION_FAILED",Dx[Dx.FIREWALL_RESTRICTION=5501]="FIREWALL_RESTRICTION",Dx[Dx.REJOIN_FAILED=5502]="REJOIN_FAILED",Dx[Dx.EVENT_HANDLER_ERROR=5503]="EVENT_HANDLER_ERROR",Dx[Dx.VIDEO_CONTEXT_ERROR=5504]="VIDEO_CONTEXT_ERROR",Dx[Dx.OPERATION_ABORT=5998]="OPERATION_ABORT",Dx[Dx.UNKNOWN_ERROR=5999]="UNKNOWN_ERROR",Dx);var Mx=MC(PC({},qk),{INVALID_PARAMETER(e){let{fnName:t}=e;return "the parameters of the '".concat(t,"' you called does not meet the requirements, please check the API documentation.")},INVALID_PARAMETER_REQUIRED(e){let{key:t,rule:i,fnName:r,value:n}=e;return "'".concat(t||i.name,"' is a required param when calling ").concat(r,"(), received: ").concat(n,".")},INVALID_PARAMETER_TYPE(e){let{key:t,rule:i,fnName:r,value:n}=e,o="".concat(t||i.name),s="";return s=Array.isArray(i.type)?i.type.join("|"):i.type,"'".concat(o,"' must be type of ").concat(s," when calling ").concat(r,"(), received type: ").concat(vw(n),".")},INVALID_PARAMETER_EMPTY(e){let{key:t,rule:i,fnName:r,value:n}=e;return "'".concat(t||i.name,"' cannot be '").concat(n,"' when calling ").concat(r,"().")},INVALID_PARAMETER_INSTANCE(e){let{key:t,rule:i,fnName:r,value:n}=e,o="".concat(t||i.name),s="".concat(i.instanceOf.name||i.instanceOf);return "'".concat(o,"' must be instanceof ").concat(s," when calling ").concat(r,"(), received type: ").concat(vw(n),".")},INVALID_PARAMETER_RANGE(e){let{key:t,rule:i,fnName:r,value:n}=e;return "'".concat(t||i.name,"' must be one of ").concat(i.values.join("|")," when calling ").concat(r,"(), received: ").concat(n,".")},INVALID_PARAMETER_LESS_THAN_ZERO(e){let{key:t,rule:i,fnName:r}=e;return "'".concat(t||i.name,"' cannot be less than 0 when calling ").concat(r,"().")},INVALID_PARAMETER_MIN(e){let{key:t,rule:i,value:r}=e;return "the min value of ".concat(t||i.name," is ").concat(i.min,", received: ").concat(r,".")},INVALID_PARAMETER_MAX(e){let{key:t,rule:i,value:r}=e;return "the max value of ".concat(t||i.name," is ").concat(i.max,", received: ").concat(r,".")},INVALID_ELEMENT_ID(e){let{key:t,fnName:i}=e;return "'".concat(t,"' is not found in the document object when calling ").concat(i,"().")},INVALID_ELEMENT_ID_TYPE(e){let{key:t,fnName:i,type:r}=e;return "the element corresponding to '".concat(t,"' must be instanceof HTMLElement when calling ").concat(i,"(), received: ").concat(r,".")},INVALID_STREAM_ID(e){let{key:t}=e;return "'".concat(t,"' can only consist of uppercase and lowercase english letters (a-zA-Z), numbers (0-9), hyphens and underscores.")},INVALID_ROOM_ID_STRING(e){let{key:t}=e;return "'".concat(t,"' must be a valid string.")},INVALID_ROOM_ID_INTEGER(e){let{key:t}=e;return "'".concat(t,"' must be an integer between [1, 4294967294].")},INVALID_ROOM_ID_INTEGER_STRING(e){let{key:t}=e;return "'".concat(t,"' must be an integer but go a string, use 'parseInt' to convert it or use 'strRoomId' instead.")},INVALID_ROOM_ID_REQUIED:()=>"at least one of 'roomId'(between [1, 4294967294]) and 'strRoomId'(not empty) is required.",INVALID_STREAM_TYPE:e=>{let{fnName:t}=e;return "'streamType' is required when 'userId' is not '*', calling ".concat(t,"()")},INVALID_IMAGE_URL:"The 'src' param must be filled in when the background type is image.",INVALID_OPERATION(e){let{fnName:t}=e;return "the API '".concat(t,"' you called does not meet the requirements, please check the API documentation.")},INVALID_OPERATION_NOT_JOINED(e){let{fnName:t}=e;return "cannot ".concat(t," because you are not enter room yet.")},INVALID_OPERATION_REMOTE_USER_NOT_EXIST(e){let{fnName:t,value:i}=e;return "cannot ".concat(t," because remote user(userId: ").concat(i.userId,") does not publishing stream.")},INVALID_OPERATION_STREAM_TYPE_NOT_EXIST(e){let{fnName:t,value:i}=e;return "cannot ".concat(t," because remote user(userId: ").concat(i.userId,") does not publishing ").concat(i.streamType," video.")},INVALID_OPERATION_REPEAT_CALL(e){let{fnName:t}=e;return "you are already ".concat(t,"(), cannot repeated call '").concat(t,"'.")},INVALID_OPERATION_NEED_VIDEO(e){let{fnName:t}=e;return "cannot call '".concat(t,"' because the camera is not turned on.")},INVALID_OPERATION_NEED_AUDIO(e){let{fnName:t}=e;return "cannot call '".concat(t,"' because the microphone is not turned on.")},INVALID_BUFFER_EMPTY:e=>{let{key:t}=e;return "the buffer size of paramerter '".concat(t,"' cannot be empty")},INVALID_BUFFER_OVERSIZE:()=>"buffer size is over 1000 Bytes",INVALID_ROLE_AUDIENCE:()=>"role: '".concat("audience","' cannot call this api."),INVALID_NOT_ENABLE_SEI:()=>"you need to enable SEI in TRTC.create({ enableSEI: true })",INVALID_NEED_CALL_PUBLISHED:e=>{let{fnName:t}=e;return "you need to call ".concat(t,"() after publish stream.")},ENV_NOT_SUPPORTED(e){let{fnName:t}=e;return "the current browser does not support the capability of the function '".concat(t,"' you are calling, please check the API documentation.")},NOT_SUPPORTED_WEBRTC:"the current browser does not support WebRTC capability, please check the SDK documentation.",NOT_SUPPORTED_H264_ENCODE:"this browser does not support H264 encode.",NOT_SUPPORTED_H264_DECODE:"this browser does not support H264 decode.",NOT_SUPPORTED_SCREEN_SHARE:"this browser does not support screen share, please check the browser version.",NOT_SUPPORTED_SMALL_VIDEO:"this browser does not support small video, please check the browser version.",NOT_SUPPORTED_SEI:"this browser does not support SEI, please check the browser version.",NOT_SUPPORTED_WEBGL:"this browser does not support WebGL, please check the browser version.",NOT_SUPPORTED_CHROME_VERSION(e){let{fnName:t}=e;return "cannot call ".concat(t," because the browser version is too low, please upgrade to the latest version")},DEVICE_ERROR(e){let{fnName:t,error:i}=e;return "'".concat(t,"' got device exception").concat(i?", error: ".concat(i.toString(),"."):".")},DEVICE_NOT_FOUND_ERROR(e){let{fnName:t,deviceType:i=Lx(t),error:r}=e;return "NotFoundError, no ".concat(i," detected, please check your device and the configuration on '").concat(t,"'").concat(r?", error: ".concat(r.toString(),"."):".")},DEVICE_NOT_ALLOWED_ERROR(e){let{fnName:t,deviceType:i=Lx(t),error:r}=e;return "NotAllowedError, you have disabled ".concat(i," access, please allow the current application to use the ").concat(i).concat(r?", error: ".concat(r.toString(),"."):".")},DEVICE_NOT_READABLE_ERROR(e){let{fnName:t,deviceType:i=Lx(t),error:r}=e;return "NotReadableError, the ".concat(i," maybe in use by another APP, please check if the device is pre-occupied by another APP.")},DEVICE_OVERCONSTRAINED_ERROR(e){let{fnName:t,deviceType:i=Lx(t),error:r}=e;return "OverconstrainedError, the device ID is incorrect, please check whether the device ID passed in is correct".concat(r?", error: ".concat(r.toString(),"."):".")},DEVICE_INVALID_STATE_ERROR(e){let{fnName:t,deviceType:i=Lx(t),error:r}=e;return "InvalidStateError, after the user clicks and interacts with the page, turn on the ".concat(i).concat(r?", error: ".concat(r.toString(),"."):".")},DEVICE_SECURITY_ERROR(e){let{fnName:t,deviceType:i=Lx(t),error:r}=e;return "SecurityError, check whether the system security policy restricts the use of the ".concat(i,", and it is recommended to turn on the ").concat(i," after the user interacts with the page").concat(r?", error: ".concat(r.toString(),"."):".")},DEVICE_ABORT_ERROR(e){let{fnName:t,deviceType:i=Lx(t),error:r}=e;return "AbortError, an unknown exception in the system makes the device unusable, recommended to change the device or browser and re-check whether the device is normal".concat(r?" error: ".concat(r.toString(),"."):".")},CAMERA_RECOVER_FAILED(e){let{error:t}=e;return "camera recover capture failed ".concat((null==t?void 0:t.name)||"",": ").concat((null==t?void 0:t.originMessage)||(null==t?void 0:t.message))},MICROPHONE_RECOVER_FAILED(e){let{error:t}=e;return "microphone recover capture failed ".concat((null==t?void 0:t.name)||"",": ").concat((null==t?void 0:t.originMessage)||(null==t?void 0:t.message))},OPERATION_FAILED(e){let{fnName:t,error:i}=e;return "'".concat(t,"' failed, reason: ").concat(null==i?void 0:i.toString())},FIREWALL_RESTRICTION:()=>"media connection failure due to firewall restrictions, please try to change your network.",EVENT_HANDLER_ERROR(e){let{eventName:t}=e;return "an error was caught on trtc.on('".concat(t,"', handler), please check your code on 'handler'.")},VIDEO_CONTEXT_ERROR(e){let{reason:t,error:i}=e;return "video context error ".concat(t," ").concat((null==i?void 0:i.name)||""," ").concat((null==i?void 0:i.message)||"")},SERVER_ERROR(e){let{fnName:t,error:i}=e;return "'".concat(t,"' got server error: ").concat(null==i?void 0:i.toString(),", please check the SDK documentation.")},NEED_TO_BUY(e){let{value:t,url:i}=e;return "You need to buy packages for ".concat(t,". Refer to: ").concat(i)},ACCOUNT_NO_MONEY:e=>{let{fnParams:t}=e;return "your TRTC account run out of credit, please recharge.".concat(t.sdkAppId?" SDKAppId: ".concat(t.sdkAppId):"")},OPERATION_ABORT(e){let{fnName:t}=e;return "'".concat(t,"' abort")},UNKNOWN_ERROR(e){let{fnName:t,error:i}=e;return "'".concat(t,"' throw unknown exception").concat(i?", error: ".concat(i.toString(),"."):".")}});function Lx(e){if(!e)return "camera";let t=e.toLowerCase();return t.includes("screen")?"screen share":t.includes("audio")?"microphone":"camera"}var xx=class extends Error{constructor(e){let{code:t,extraCode:i,message:r="",messageParams:n,fnName:o="",originError:s}=e;var a;let c;c=r||function(e){let t,{code:i,params:r,enableDocLink:n=!1}=e,s="",a=Px[i];try{t=Mx[a];}catch(o){t=Mx.UNKNOWN_ERROR;}return yw(t)?s=t(r):Iw(t)&&(s=t),r.fnName&&!s.includes(r.fnName)&&("."!==s[s.length-1]&&(s+="."),s+=" thrown from ".concat(r.fnName,"()")),n&&(s+=" doc:"),s}({code:t===Ox.SERVER_ERROR?t:i||t,params:PC({fnName:o,error:s},n)}),super(c),FC(this,"name","RtcError"),FC(this,"code"),FC(this,"extraCode"),FC(this,"functionName"),FC(this,"message"),FC(this,"handler"),FC(this,"originError"),this.name=Px[t],this.code=t,this.extraCode=i,this.functionName=o,this.originError=s,this.message=c,5302===this.extraCode&&(null==(a=this.originError)?void 0:a.message.includes("system"))&&(this.handler=()=>{let e=document.createElement("a");HD?e.href="ms-settings:privacy-".concat({startLocalVideo:"webcam",startLocalAudio:"microphone"}[this.functionName]):jD&&(e.href="x-apple.systempreferences:com.apple.preference.security?Privacy_".concat({startLocalVideo:"Camera",startLocalAudio:"Microphone",startScreenShare:"ScreenCapture"}[this.functionName])),e.href.length>0&&e.click();});}static convertFrom(e,t,i){let r=e;if(e instanceof tb){let{stack:n}=e,o={code:Ox.UNKNOWN_ERROR,fnName:t,originError:e};switch(e.getCode()){case ZC.INVALID_PARAMETER:o.code=Ox.INVALID_PARAMETER,o.message=e.message;break;case ZC.INVALID_OPERATION:o.code=Ox.INVALID_OPERATION;break;case ZC.NOT_SUPPORTED:case ZC.NOT_SUPPORTED_H264:o.code=Ox.ENV_NOT_SUPPORTED,e.getCode()===ZC.NOT_SUPPORTED_H264&&(o.extraCode=e.message.includes(qk.NOT_SUPPORTED_H264ENCODE)?5203:5204);break;case ZC.JOIN_ROOM_FAILED:o.messageParams={fnParams:i};case ZC.SERVER_TIMEOUT:case ZC.SWITCH_ROLE_FAILED:o.code=Ox.SERVER_ERROR,o.extraCode=e.getExtraCode();break;case ZC.API_CALL_ABORTED:o.code=Ox.OPERATION_ABORT;break;case ZC.DEVICE_NOT_FOUND:case ZC.DEVICE_AUTO_RECOVER_FAILED:case ZC.INITIALIZE_FAILED:o.code=5300,e.name&&(o.extraCode=function(e){let t;switch(e){case"NotFoundError":t=5301;break;case"NotAllowedError":t=5302;break;case"NotReadableError":t=5303;break;case"OverconstrainedError":t=5304;break;case"InvalidStateError":t=5305;break;case"SecurityError":t=5306;break;case"AbortError":t=5307;break;default:t=5300;}return t}(e.name));break;case ZC.UNKNOWN:break;default:o.code=Ox.OPERATION_FAILED;}r=new xx(o),n&&(r.stack+=n.substr(n.indexOf("\n")));}else {if(e instanceof xx)return e;r=new xx({code:Ox.UNKNOWN_ERROR,fnName:t,originError:e});}return r}};var Vx=xx,Ux={type:"object",properties:{cameraId:{type:"string"},useFrontCamera:{type:"boolean"},fillMode:{type:"string",values:["contain","cover","fill"]},mirror:{type:["string","boolean"],values:[!0,!1,"view","publish","both"]},small:{properties:{width:{type:"number"},height:{type:"number"},frameRate:{type:"number"},bitrate:{type:"number"}}},videoTrack:{instanceOf:MediaStreamTrack}}},Fx={type:"object",properties:{systemAudio:{type:"boolean"},fillMode:{type:"string",values:["contain","cover","fill"]},profile:{type:["string","object"],properties:{width:{type:"number"},height:{type:"number"},frameRate:{type:"number"},bitrate:{type:"number"}}},videoTrack:{instanceOf:MediaStreamTrack},audioTrack:{instanceOf:MediaStreamTrack}}},Bx={type:["string",HTMLElement,null,"array"],arrayItem:{instanceOf:HTMLElement},validate(e,t,i){if(Iw(e)&&!document.getElementById(e))throw new Vx({code:Ox.INVALID_PARAMETER,extraCode:5009,fnName:i,messageParams:{key:t}})}},Hx={name:"userId",required:!0,type:"string"},jx={type:"object",properties:{microphoneId:{type:"string"},audioTrack:{instanceOf:MediaStreamTrack},captureVolume:{type:"number",min:0},earMonitorVolume:{type:"number",min:0,max:100},profile:{values:[wx.AUDIO_PROFILE_STANDARD,wx.AUDIO_PROFILE_STANDARD_STEREO,wx.AUDIO_PROFILE_HIGH,wx.AUDIO_PROFILE_HIGH_STEREO]},echoCancellation:{type:"boolean"},autoGainControl:{type:"boolean"},noiseSuppression:{type:"boolean"}}};function Wx(e,t){if(!e)throw new Vx({code:Ox.INVALID_OPERATION,extraCode:5101,fnName:t})}function Gx(e,t,i){if(!e)throw new Vx({code:Ox.INVALID_OPERATION,extraCode:5102,fnName:t,messageParams:{value:i}})}var Jx={create:[{name:"RoomConfig",instanceOf:Function},{name:"CreateConfig",type:"object",properties:{plugins:{type:"array",arrayItem:{instanceOf:Function}}}}],enterRoom:{name:"EnterRoomConfig",type:"object",required:!0,validate(e,t,i){if(this._room.isJoined)throw new Vx({code:Ox.INVALID_OPERATION,extraCode:5104,fnName:i});if(e.roomId){if(Iw(e.roomId))throw new Vx({code:Ox.INVALID_PARAMETER,extraCode:5016,fnName:i,messageParams:{key:t}});if(!(/^[1-9]\d*$/.test(String(e.roomId))&&e.roomId<4294967295))throw new Vx({code:Ox.INVALID_PARAMETER,extraCode:5013,fnName:i,messageParams:{key:t}})}else {if(!e.strRoomId)throw new Vx({code:Ox.INVALID_PARAMETER,extraCode:5015,fnName:i});if(!/^[A-Za-z\d\s!#$%&()+\-:;<=.>?@[\]^_{}|~,]{1,64}$/.test(e.strRoomId))throw new Vx({code:Ox.INVALID_PARAMETER,extraCode:5012,fnName:i,messageParams:{key:t}})}},properties:{sdkAppId:{required:!0,type:"number",allowEmpty:!1},userId:{required:!0,type:"string",allowEmpty:!1},userSig:{required:!0,type:"string",allowEmpty:!1},scene:{type:"string",values:["live","rtc"]},role:{type:"string",values:["audience","anchor"]},roomId:{type:["string","number"]},strRoomId:{type:"string"},proxy:{type:["object","string"],properties:{websocketProxy:{type:"string"},turnServer:{type:["object","array"],properties:{url:{required:!0,type:"string"},username:{type:"string"},credential:{type:"string"},credentialType:{type:"string",values:["password"]}}},loggerProxy:{type:"string"},webtransportProxy:{type:"string"}}},enableAutoPlayDialog:{type:"boolean"},userDefineRecordId:{type:"string"},latencyLevel:{type:"number"}}},startLocalVideo:{name:"LocalVideoConfig",type:"object",properties:{view:Bx,mute:{type:["boolean","string"]},publish:{type:"boolean"},option:Ux},validate(e){var t;if((null==(t=null==e?void 0:e.option)||!t.videoTrack)&&wO())throw new Vx({code:Ox.ENV_NOT_SUPPORTED,extraCode:5201})}},updateLocalVideo:{name:"updateLocalVideoConfig",type:"object",required:!0,properties:{view:MC(PC({},Bx),{required:!1}),publish:{type:"boolean"},mute:{type:["boolean","string"]},option:Ux}},startLocalAudio:{name:"LocalAudioConfig",type:"object",properties:{publish:{type:"boolean"},option:jx},validate(e){var t;if((null==(t=null==e?void 0:e.option)||!t.audioTrack)&&wO())throw new Vx({code:Ox.ENV_NOT_SUPPORTED,extraCode:5201})}},updateLocalAudio:{name:"updateLocalAudioConfig",type:"object",required:!0,properties:{publish:{type:"boolean"},mute:{type:"boolean"},option:jx}},startScreenShare:{name:"ScreenShareConfig",type:"object",properties:{view:Bx,publish:{type:"boolean"},option:Fx},validate(e,t,i,r,n){var o;if((null==(o=null==e?void 0:e.option)||!o.videoTrack)&&wO())throw new Vx({code:Ox.ENV_NOT_SUPPORTED,extraCode:5201});if(!VO())throw new Vx({code:Ox.ENV_NOT_SUPPORTED,fnName:i,extraCode:5205})}},updateScreenShare:{name:"updateScreenShareConfig",type:"object",required:!0,properties:{view:Bx,publish:{type:"boolean"},option:Fx}},muteRemoteAudio:[Hx,{name:"mute",required:!0,type:"boolean"}],setRemoteAudioVolume:[Hx,{name:"volume",required:!0,type:"number",min:0}],startRemoteVideo:{name:"startRemoteVideoConfig",type:"object",required:!0,properties:{view:Bx,userId:{type:"string",required:!0},streamType:{values:["main","sub"],required:!0},option:{type:"object",properties:{fillMode:{type:"string",values:["contain","cover","fill"]},mirror:{type:"boolean"}}}},validate(e,t,i){Wx(this._room.isJoined,i);let r=this._room.remotePublishedUserMap.get(e.userId);if(Gx(!!r,i,e),r&&("main"===e.streamType&&!r.muteState.videoAvailable||"sub"===e.streamType&&!r.muteState.hasAuxiliary))throw new Vx({code:Ox.INVALID_OPERATION,extraCode:5103,fnName:i,messageParams:{value:e}})}},updateRemoteVideo:{name:"updateRemoteVideoConfig",type:"object",required:!0,properties:{view:MC(PC({},Bx),{required:!1}),userId:{type:"string",required:!0},streamType:{values:["main","sub"],required:!0},option:{type:"object",properties:{fillMode:{type:"string",values:["contain","cover","fill"]},mirror:{type:"boolean"}}}},validate(e,t,i){Wx(this._room.isJoined,i);let r=this._room.remotePublishedUserMap.get(e.userId);if(Gx(!!r,i,e),r&&("main"===e.streamType&&!r.muteState.videoAvailable||"sub"===e.streamType&&!r.muteState.hasAuxiliary))throw new Vx({code:Ox.INVALID_OPERATION,extraCode:5103,fnName:i,messageParams:{value:e}})}},stopRemoteVideo:{name:"stopRemoteVideoConfig",type:"object",required:!0,properties:{userId:{type:"string",required:!0},streamType:{values:["main","sub"]}},validate(e,t,i){if("*"!==e.userId&&Sw(e.streamType))throw new Vx({code:Ox.INVALID_PARAMETER,extraCode:5014,fnName:i})}},switchRole:{name:"role",required:!0,values:["anchor","audience"],validate(e,t,i){Wx(this._room.isJoining||this._room.isJoined,i);}},enableAudioVolumeEvaluation:[{name:"interval",type:"number"},{name:"enableInBackground",type:"boolean"}],sendSEIMessage:[{name:"buffer",required:!0,instanceOf:ArrayBuffer,validate(e,t,i,r){if(!aP)throw new Vx({code:Ox.ENV_NOT_SUPPORTED,fnName:i,extraCode:5207});if(!this._room.enableSEI)throw new Vx({code:Ox.INVALID_OPERATION,fnName:i,extraCode:5108});if(e.byteLength>1e3)throw new Vx({code:Ox.INVALID_PARAMETER,extraCode:5018,fnName:i});if(0===e.byteLength)throw new Vx({code:Ox.INVALID_PARAMETER,extraCode:5017,messageParams:{key:t},fnName:i});Wx(this._room.isJoined,i);}},{name:"options",type:"object",properties:{seiPayloadType:{type:"number",values:[5,243]},toSubStream:{type:"boolean",validate(e,t,i){if(!e&&!this._room.isMainStreamPublished||e&&!this._room.isAuxStreamPublished)throw new Vx({code:Ox.INVALID_OPERATION,extraCode:5109,messageParams:{key:t},fnName:i})}}}}],sendCustomMessage:{name:"message",required:!0,type:"object",properties:{cmdId:{type:"number",required:!0,min:1,max:10},data:{instanceOf:ArrayBuffer,required:!0,validate(e,t,i,r){if(e.byteLength>1e3)throw new Vx({code:Ox.INVALID_PARAMETER,extraCode:5018,fnName:i});if(0===e.byteLength)throw new Vx({code:Ox.INVALID_PARAMETER,extraCode:5017,fnName:i,messageParams:{key:t}})}}},validate(e,t,i){if(Wx(this._room.isJoined,i),"live"===this._room.scene&&"audience"===this._room.role)throw new Vx({code:Ox.INVALID_OPERATION,extraCode:5107,fnName:i,messageParams:{key:t}})}}},Kx={TRTC:Jx},zx=class extends Error{};function qx(e,t){let i=Gw(e);for(let r=0;r<t.length;r++)Ww(i[r],t[r]);return i}function Yx(e){this._resolve=Promise.resolve(e);}function Qx(e){this._reject=Promise.reject(e);}var Xx=class{constructor(e,t){this.instance=e,this.group=t,this.started=!1,this.ops=[],this.startSame=()=>!0,this.mergeUpdate=qx;let i=Xx.instances.get(e);i?i.set(t,this):Xx.instances.set(e,new Map([[t,this]]));}static get(e,t){if(!t)return;let i=Xx.instances.get(e);return i&&i.get(t)||new Xx(e,t)}static gets(e,t){let i=Xx.instances.get(e),r=[];return i&&i.forEach(((e,i)=>{t.test(i)&&r.push(e);})),r}action(e,t,i){let r=t=>{var i;return 0===e?this.started=!0:3===e&&(this.started=!1),this.ops.shift(),null==(i=this.currentOp)||i.action(),t},n=t=>{var i,r;throw this.ops.shift(),0===e&&2===(null==(i=this.currentOp)?void 0:i.type)&&this.ops.shift().reject(new zx("start failed")),null==(r=this.currentOp)||r.action(),t},o={type:e,action:()=>t(...o.args).then(r,n),args:i,resolve:Yx,reject:Qx};try{switch(this.state){case 1:if(0===e)throw new zx("already started");break;case 4:if(2===e)throw new zx("not started");break;default:return this.cacheOp(o)}}catch(s){return Promise.reject(s)}return this.ops.push(o),o.promise=t(...o.args).then(r,n)}cacheOp(e){if(1===this.ops.length)switch(this.state){case 0:case 2:if(0===e.type)throw new zx("already start");break;case 3:switch(e.type){case 2:throw new zx("update not allowed when stopping");case 3:return this.currentOp.promise}break;default:throw new zx("unknown state")}else switch(e.type){case 3:if(3===this.lastOpType)return this.lastOp.promise;{let e=new zx("keep stop");if(this.ops.slice(1).forEach((t=>t.reject(e))),this.ops=this.ops.slice(0,1),3===this.state)return this.currentOp.promise}break;case 2:switch(this.lastOpType){case 2:return this.lastOp.args=this.mergeUpdate(this.lastOp.args,e.args),this.lastOp.promise;case 3:throw new zx("update not allowed after stop")}break;case 0:switch(this.lastOpType){case 2:throw new zx("start not allowed after update");case 0:throw new zx("duplicate start");case 3:if(this.startSame(this.currentOp.args,e.args))throw this.ops.pop().reject(new zx("keep start")),new zx("already start")}}e.promise=new Promise(((t,i)=>{e._resolve?e._resolve.then(t):e.resolve=t,e._reject?e._reject.catch(i):e.reject=i;}));let{action:t}=e;return e.action=()=>t().then(e.resolve,e.reject),this.ops.push(e),e.promise}get lastOp(){return this.ops[this.ops.length-1]}get lastOpType(){return this.lastOp.type}get currentOp(){return this.ops[0]}get state(){return this.currentOp?this.currentOp.type:this.started?1:4}},$x=Xx;$x.instances=new WeakMap;var Zx=new WeakMap,eV=(e,t)=>{if(t instanceof zx){let{stack:i}=t;t=new Vx({code:Ox.OPERATION_ABORT,message:"".concat(e," abort: ").concat(t.message),fnName:e}),i&&(t.stack+=i.substr(i.indexOf("\n")));}throw t};function tV(e,t){return ZM(((i,r)=>function(){for(var n=arguments.length,o=new Array(n),s=0;s<n;s++)o[s]=arguments[s];let a=$x.get(this,"string"==typeof e?e:e.call(this,...o));return a?(t&&(a.startSame=t.bind(this)),a.action(0,i.bind(this),o).catch(eV.bind(null,r))):i.apply(this,o)}))}function iV(e,t){let{merge:i,debounce:r}=t||{};return ZM(((t,n)=>function(){for(var o=arguments.length,s=new Array(o),a=0;a<o;a++)s[a]=arguments[a];let c=$x.get(this,"string"==typeof e?e:e.call(this,...s));if(!c)return t.apply(this,s);if(i&&(c.mergeUpdate=i.bind(this)),r&&r.isNeedToDebounce.apply(this,s)){let{delay:e,getKey:i}=r;return new Promise(((r,o)=>{var a,l;let d=null==(a=Zx.get(this))?void 0:a.get(i(...s));if(d){let{timeoutId:e,resolve:t}=d;clearTimeout(e),t();}let u=setTimeout((()=>{if(3===c.state||4===c.state)return r();c.action(2,t.bind(this),s).catch(eV.bind(null,n)).then(r,o);}),e);Zx.has(this)?null==(l=Zx.get(this))||l.set(i(...s),{timeoutId:u,resolve:r}):Zx.set(this,new Map([[i(...s),{timeoutId:u,resolve:r}]]));}))}return c.action(2,t.bind(this),s).catch(eV.bind(null,n))}))}function rV(e){return ZM(((t,i)=>function(){for(var r=arguments.length,n=new Array(r),o=0;o<r;o++)n[o]=arguments[o];let s="function"==typeof e?e.call(this,...n):e;if(s instanceof RegExp)return Promise.all($x.gets(this,s).map((e=>e.action(3,(()=>Promise.resolve()),n)))).then((()=>t.call(this,...n)));let a=$x.get(this,s);return a?a.action(3,t.bind(this),n).catch(eV.bind(null,i)):t.apply(this,n)}))}var nV={ERROR:"error",AUTOPLAY_FAILED:"autoplay-failed",KICKED_OUT:"kicked-out",REMOTE_USER_ENTER:"remote-user-enter",REMOTE_USER_EXIT:"remote-user-exit",REMOTE_AUDIO_AVAILABLE:"remote-audio-available",REMOTE_AUDIO_UNAVAILABLE:"remote-audio-unavailable",REMOTE_VIDEO_AVAILABLE:"remote-video-available",REMOTE_VIDEO_UNAVAILABLE:"remote-video-unavailable",AUDIO_VOLUME:"audio-volume",AUDIO_FRAME:"audio-frame",NETWORK_QUALITY:"network-quality",CONNECTION_STATE_CHANGED:"connection-state-changed",AUDIO_PLAY_STATE_CHANGED:"audio-play-state-changed",VIDEO_PLAY_STATE_CHANGED:"video-play-state-changed",SCREEN_SHARE_STOPPED:"screen-share-stopped",DEVICE_CHANGED:"device-changed",PUBLISH_STATE_CHANGED:"publish-state-changed",TRACK:"track",STATISTICS:"statistics",SEI_MESSAGE:"sei-message",CUSTOM_MESSAGE:"custom-message"},oV=new Set([nV.ERROR,nV.AUTOPLAY_FAILED,nV.KICKED_OUT,nV.REMOTE_USER_ENTER,nV.REMOTE_USER_EXIT,nV.REMOTE_AUDIO_AVAILABLE,nV.REMOTE_AUDIO_UNAVAILABLE,nV.REMOTE_VIDEO_AVAILABLE,nV.REMOTE_VIDEO_UNAVAILABLE,nV.CONNECTION_STATE_CHANGED,nV.PUBLISH_STATE_CHANGED,nV.SCREEN_SHARE_STOPPED,nV.DEVICE_CHANGED]);function sV(e){return "sub"===e?"auxiliary":"auxiliary"===e?"sub":"main"}function aV(e){return e===wx.QOS_PREFERENCE_CLEAR?"detail":e===wx.QOS_PREFERENCE_SMOOTH?"motion":""}var cV=class{constructor(){FC(this,"_log"),this._log=sO.createLogger({id:"fd"});}download(e,t){return HC(this,null,(function*(){let{type:i="blob"}=t||{};try{let t,r=Lw();if(t=yw(fetch)?yield this.downloadWithFetch(e,i):yield this.downloadWithXHR(e,i),!t||!t.data)throw new Error("data is empty");let n=Lw()-r;return this._log.info("downloaded: ".concat(e,", return type: ").concat(i,", cost: ").concat(n,"ms")),IO.addSuccessEvent({key:522700,cost:Lw()-r}),t.data}catch(ub){throw this._log.error("failed to download: ".concat(e,", error: ").concat(ub)),IO.addFailedEvent({key:522700,error:ub}),ub}}))}downloadWithFetch(e,t){return HC(this,null,(function*(){this._log.info("download with fetch: ".concat(e,", return type: ").concat(t));try{let i,r=yield fetch(e);if(!r.ok)throw new Error("network response was not ok");return i="arraybuffer"===t?yield r.arrayBuffer():yield r.blob(),{data:i}}catch(hk){throw hk}}))}downloadWithXHR(e,t){return this._log.info("download with xhr: ".concat(e,", return type: ").concat(t)),new Promise(((i,r)=>{let n=new XMLHttpRequest;n.open("GET",e,!0),n.responseType=t,n.onload=()=>{200===n.status||0===n.status&&n.response?i({data:n.response}):r(new Error("XHR failed"));},n.onerror=r,n.send(null);}))}loadWasm(e,t){return HC(this,null,(function*(){this._log.info("loadWasm ".concat(e,", importObject: ").concat(JSON.stringify(t)));let i=Lw(),r=null,n=null;if(yw(WebAssembly.instantiateStreaming)&&!(e=>e.startsWith("data:application/octet-stream;base64,"))(e)&&!(e=>e.startsWith("file://"))(e)&&yw(fetch))try{let i=fetch(e);r=(yield WebAssembly.instantiateStreaming(i,t)).instance;}catch(hb){n=hb;}if(!r)try{let i=yield this.download(e,{type:"arraybuffer"});r=(yield WebAssembly.instantiate(i,t)).instance;}catch(hb){n=hb;}if(r){let t=Lw()-i;return this._log.info("loadedWasm ".concat(e,", cost: ").concat(t,"ms")),IO.addSuccessEvent({key:522701,cost:t}),r}throw this._log.error("failed to loadWasm ".concat(e,", error: ").concat(n)),IO.addFailedEvent({key:522701,error:n}),n}))}};UC([VP({settings:{timeout:0,retries:3},onRetrying(e){this._log.warn("download retrying: ".concat(e));}})],cV.prototype,"download",1);var lV=new cV;function dV(e){let{TRTC:t,room:i,errorModule:r,assetsPath:n}=e;return {TRTC:t,room:i,assetsPath:n,fileDownloader:lV,innerEmitter:jN,constants:sb,environment:Yk,utils:ob,eventLogger:GN,log:this.room.getLogger(),loggerManager:sO,errorModule:r,kvStatManager:IO,rtcDectection:lO,trtc:this,clearStarted:(e,t)=>{let i=e.getAlias(),r=$x.instances.get(this);if(r)if(t){let e=r.get(i+t);if(!e)return;e.started=!1;}else r.forEach(((e,t)=>{t.startsWith(i)&&(e.started=!1);}));},startGetPCM:SL,createAudioNode:TM}}var uV=new WeakMap;function hV(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];return ZM(((e,i)=>function(){for(var r=arguments.length,n=new Array(r),o=0;o<r;o++)n[o]=arguments[o];try{mV.call(this,t,n,i,this._name);}catch(ub){return Promise.reject(ub)}return e.apply(this,n)}))}function pV(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];return ZM(((e,i)=>function(){for(var r=arguments.length,n=new Array(r),o=0;o<r;o++)n[o]=arguments[o];try{mV.call(this,t,n,i,this._name);}catch(ub){throw ub}return e.apply(this,n)}))}function mV(e,t,i,r){if(bw(e))for(let n=0;n<e.length;n++)_V.call(this,{rule:e[n],value:t[n],key:e[n].name,fnName:i,className:r});else _V.call(this,{rule:e,value:t[0],key:e.name,fnName:i,className:r});}function _V(e){let{rule:t,value:i,key:r,fnName:n,className:o}=e;function s(e){return {code:Ox.INVALID_PARAMETER,extraCode:e,fnName:n,messageParams:{key:r,rule:t,value:i}}}if(Sw(i)){if(t.required)throw new Vx(s(5001));if(Sw(t.defaultValue))return void(yw(t.validate)&&t.validate.call(this,i,r,n,o,this));i=t.defaultValue;}if(Array.isArray(t.type)){let e=!1;for(let r=0;r<t.type.length;r++)null===t.type[r]&&null===i&&(e=!0),yw(t.type[r])&&i instanceof t.type[r]&&(e=!0),Iw(t.type[r])&&vw(i)===t.type[r].toLowerCase()&&(e=!0);if(!e)throw new Vx({code:Ox.INVALID_PARAMETER,extraCode:5002,fnName:n,messageParams:{key:r,rule:{type:t.type.map((e=>ww(e)?Ow(e):Iw(e)?e:vw(e)))},value:i}})}else if(!Sw(t.type)&&vw(i)!==t.type)throw new Vx(s(5002));if(!1===t.allowEmpty){let e=Rw(i)&&(0===i||Number.isNaN(i)),t=Iw(i)&&""===i.trim();if(e||t)throw new Vx(s(5003))}if(t.notLessThanZero&&Rw(i)&&i<0)throw new Vx(s(5006));if(!Sw(t.min)&&Rw(i)&&i<t.min)throw new Vx(s(5007));if(!Sw(t.max)&&Rw(i)&&i>t.max)throw new Vx(s(5008));if(Iw(t.instanceOf)){if(!i||i._name!==t.instanceOf)throw new Vx(s(5004))}else if(yw(t.instanceOf)&&!(i instanceof t.instanceOf))throw new Vx(s(5004));if(Array.isArray(t.values)&&!t.values.includes(i))throw new Vx(s(5005));let{properties:a}=t;gw(a)&&Cw(i)&&Object.keys(a).forEach((e=>{_V.call(this,{rule:a[e],value:i&&i[e],key:"".concat(e),fnName:n,className:o});}));let{arrayItem:c}=t;gw(c)&&bw(i)&&i.forEach(((e,t)=>{_V.call(this,{rule:c,value:e,key:"".concat(r,"[").concat(t,"]"),fnName:n,className:o});})),yw(t.validate)&&t.validate.call(this,i,r,n,o,this);}function fV(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{getRemoteId:t=()=>"",replaceArg:i,getKVReportKey:r}=e;return ZM(((e,n)=>function(){for(var o=arguments.length,s=new Array(o),a=0;a<o;a++)s[a]=arguments[a];var c;function l(e,t,r){if(r&&r.includes(e))return "hided";if(i){let e=i(...s);if(s[e.argIndex]===t)return e.value}if(t===s||e in s)return t;try{return t instanceof HTMLElement?"id: ".concat(t.id," type:").concat(vw(t)):(JSON.stringify(t),t)}catch(n){return "type:".concat(vw(t))}}let d=this._log||sO;s.length>0?d.info("".concat(n,"() ").concat(JSON.stringify(s,((e,t)=>l(e,t,["userSig","privateMapKey"]))))):d.info("".concat(n,"()"));let u=r?r(...s):_O[n];try{let i=e.apply(this,s),r=Lw();return Nw(i)?i.then((e=>(d.info("".concat(n,"() success ").concat(t.call(this,...s))),IO.addSuccessEvent({key:u,cost:Lw()-r}),e))).catch((e=>{var i;let r=(e=Vx.convertFrom.call(this,e,n,1===s.length?s[0]:s)).extraCode||e.code,o=null!=(i=e.message)&&i.includes(r)?"":" code:".concat(r);throw d.error("".concat(n,"() failed ").concat(t.call(this,...s)," ").concat(e).concat(o," params: ").concat(JSON.stringify(s,l))),IO.addFailedEvent({key:u,error:e}),e})):(IO.addSuccessEvent({key:u}),i)}catch(h){let e=(h=Vx.convertFrom.call(this,h,n)).extraCode||h.code,t=null!=(c=h.message)&&c.includes(e)?"":" code:".concat(e);throw d.error("".concat(n,"() failed ").concat(h).concat(t," params: ").concat(JSON.stringify(s,l))),IO.addFailedEvent({key:u,error:h}),h}}))}var gV=e=>ZM(((t,i)=>function(r,n){return HC(this,null,(function*(){let o=this._plugins.get(r);if(!o)throw this._log.error("plugin ".concat(String(r)," is not found")),new Vx({code:Ox.OPERATION_ABORT,message:"plugin ".concat(String(r)," is not found"),fnName:i});if(yw(o.constructor.isSupported)&&!o.constructor.isSupported())throw this._log.error("plugin ".concat(String(r)," is not supported")),new Vx({code:Ox.ENV_NOT_SUPPORTED,message:"plugin ".concat(String(r)," is not supported"),extraCode:5210,fnName:i});return mV.call(this,o.getValidateRule(e),[n],i,"TRTC"),t.call(this,o,n)}))})),TV=0,EV=class{constructor(e,t){FC(this,"player"),FC(this,"publisher"),FC(this,"mixInput"),this.mixInput=new _M(t),e.url?(this.player=new Audio(e.url),this.player.crossOrigin="anonymous",this.publisher=new Audio(e.url),this.publisher.crossOrigin="anonymous",this.mixInput.replaceSource(this.publisher)):this.mixInput.replaceSource(e.track),this.mixInput.connect();}updateSettings(e){!this.player||(Sw(e.volume)||(this.volume=e.volume),Sw(e.loop)||(this.loop=e.loop),Sw(e.playbackRate)||(this.playbackRate=e.playbackRate));}updateListener(e){if(this.player){if(e.onDurationChange){let{onDurationChange:t}=e;this.player.ondurationchange=e=>{t(e.target.duration);};}if(e.onTimeUpdate){let t=e.onTimeUpdate,{player:i}=this;i.ontimeupdate=()=>{t(i.currentTime,i.duration);};}e.onEnded&&(this.player.onended=e.onEnded);}}reset(){this.seek(0),this.mixInput.connect();}seek(e){!this.player||e<0&&e>this.player.duration||(this.player.currentTime=e,this.publisher.currentTime=e);}play(){var e,t;return null==(e=this.publisher)||e.play(),null==(t=this.player)?void 0:t.play()}pause(){var e,t;null==(e=this.player)||e.pause(),null==(t=this.publisher)||t.pause();}stop(){var e;null==(e=this.player)||e.pause(),this.mixInput.disconnect();}setOperation(e){"pause"===e&&this.pause(),"resume"===e&&(this.pause(),this.play()),"stop"===e&&(this.pause(),this.seek(0));}set volume(e){!this.player||!this.publisher||(this.player.volume=e,this.publisher.volume=e);}set loop(e){!this.player||!this.publisher||(this.player.loop=e,this.publisher.loop=e);}set playbackRate(e){!this.player||!this.publisher||(this.player.playbackRate=e,this.publisher.playbackRate=e);}};function vV(e,t){if(t&&"function"!=typeof t)throw new Vx({code:Ox.INVALID_PARAMETER,message:"start audioMixer plugin: param ".concat(e," should be a function.")})}var yV=class{constructor(e){this.core=e,FC(this,"log"),FC(this,"mixedMusicMap",new Map),FC(this,"cacheMusicMap",new Map),TV+=1,this.log=e.log.createChild({id:"".concat(this.getAlias()).concat(TV)}),this.log.info("[audioMixer] created id=".concat(this.getAlias()).concat(TV)),this.core=e;}getName(){return yV.Name}getAlias(){return "ax"}getGroup(e){return null==e?void 0:e.id}getValidateRule(e){switch(e){case"start":return yV.startValidateRule;case"update":return yV.updateValidateRule;case"stop":return yV.stopValidateRule}}start(e){return HC(this,null,(function*(){let{room:t}=this.core;this.log.info("add music source, id: ".concat(e.id," url: ").concat(e.url,", track: ").concat(e.track));let{id:i,url:r}=e;if(this.mixedMusicMap.has(i))return;let n=this.cacheMusicMap.get(i);n?e.url?n.reset():(n.mixInput.replaceSource(e.track),n.mixInput.connect()):(n=new EV(e,t.audioManager),this.cacheMusicMap.set(i,n)),n.updateListener(e),n.updateSettings(e),yield n.play(),this.mixedMusicMap.set(i,n),this.log.info("start mix audio track ".concat(i," success.")),IO.addEnum({key:502700,value:3}),this.kvUpload(e);}))}update(e){return HC(this,null,(function*(){let{id:t,operation:i,seekFrom:r,playbackRate:n}=e;this.log.info("update music source, ".concat(JSON.stringify(e)));let o=this.mixedMusicMap.get(t);o?(o.updateSettings(e),o.updateListener(e),Sw(i)||o.setOperation(i),Sw(r)||o.seek(r),this.kvUpload(e)):this.log.warn("update music source failed, music id: ".concat(t," not found."));}))}stop(e){return HC(this,arguments,(function(e){var t=this;let{id:i}=e;return function*(){var e;t.mixedMusicMap.has(i)&&(t.log.info("remove music source, music id: ".concat(i)),null==(e=t.mixedMusicMap.get(i))||e.stop(),t.mixedMusicMap.delete(i)),"*"===i&&t.destroyAllMusic();}()}))}kvUpload(e){let{track:t,loop:i,volume:r,playbackRate:n,operation:o,seekFrom:s,onTimeUpdate:a,onDurationChange:c,onEnded:l}=e;t&&IO.addCount({key:502711}),i&&IO.addCount({key:502703}),r&&IO.addCount({key:502704}),n&&IO.addCount({key:502705}),o&&IO.addCount({key:502706}),s&&IO.addCount({key:502707}),"function"!=typeof a&&IO.addCount({key:502709}),"function"!=typeof l&&IO.addCount({key:502710}),"function"!=typeof c&&IO.addCount({key:502708});}destroyAllMusic(){this.log.info("destroy all music source."),this.mixedMusicMap.forEach(((e,t)=>this.stop({id:t})));}destroyAllCache(){this.log.info("destroy all music cache."),this.cacheMusicMap.clear();}destroy(){this.log.info("destroy audio mixer plugin."),this.destroyAllMusic(),this.destroyAllCache();}},SV=yV;FC(SV,"startValidateRule",{name:"options",required:!0,type:"object",properties:{id:{type:"string",required:!0},url:{type:"string",required:!1},track:{required:!1},loop:{type:"boolean"},volume:{type:"number"}},validate(e,t,i){if(e.url&&"*"!==e.url){let t=e.url.split("?")[0],r=["mp3","ogg","wav","flac"],n=t.split(".").pop(),o=r.indexOf(n)>=0,s=t.startsWith("blob"),a=t.startsWith("data");if(!(o||s||a))throw new Vx({code:Ox.INVALID_PARAMETER,message:"start audioMixer plugin: music url is invalid, please check your file format.",fnName:i})}if(!e.url&&!e.track)throw new Vx({code:Ox.INVALID_PARAMETER,message:"start audioMixer plugin: param url or track is required.",fnName:i});vV("onTimeUpdate",e.onTimeUpdate),vV("onEnded",e.onEnded),vV("onDurationChange",e.onDurationChange);}}),FC(SV,"updateValidateRule",{name:"options",required:!0,type:"object",properties:{id:{type:"string",required:!0},loop:{type:"boolean"},volume:{type:"number"},seekFrom:{type:"number"},operation:{type:"string",values:["pause","resume","stop"]}},validate(e,t,i){vV("onTimeUpdate",e.onTimeUpdate),vV("onEnded",e.onEnded),vV("onDurationChange",e.onDurationChange);}}),FC(SV,"stopValidateRule",{name:"options",type:"object",required:!0,properties:{id:{type:"string",required:!0}}}),FC(SV,"Name","AudioMixer");var IV,RV=e=>(e=Number(e))>0&&e<14e8,AV=0,CV=class{constructor(e){this.core=e,FC(this,"log"),FC(this,"audioContext",uM()),FC(this,"workletNode"),AV+=1,this.log=e.log.createChild({id:"".concat(this.getAlias()).concat(AV)}),this.log.info("[audioDenoiser] created id=".concat(this.getAlias()).concat(AV)),e.assetsPath&&this.preload("".concat(e.assetsPath,"/denoiser-wasm.js"));}static startValidateRule(e){return {name:"options",required:!0,type:"object",properties:{sdkAppId:{type:"number",required:!0},userId:{type:"string",required:!0},userSig:{type:"string",required:!0}},validate(t,i,r,n){if(!e.room.audioManager.hasAudioTrack)throw new Vx({code:Ox.INVALID_OPERATION,extraCode:5106,fnName:r})}}}preload(e){return IV||(IV=this.doPreload(e)),IV}doPreload(e){return HC(this,null,(function*(){let t=yield this.core.fileDownloader.download(e,{type:"blob"}),i=URL.createObjectURL(t);try{yield cM(this.audioContext,i);}finally{URL.revokeObjectURL(i);}}))}getName(){return CV.Name}getAlias(){return "ad"}getGroup(){return "AIDenoiser_".concat(Date.now())}getValidateRule(e){switch(e){case"start":return CV.startValidateRule(this.core);case"update":return CV.updateValidateRule;case"stop":return CV.stopValidateRule}}start(e){return HC(this,null,(function*(){let{room:t}=this.core;if(yield this.preload("".concat(e.assetsPath,"/denoiser-wasm.js")),!this.workletNode){let t=String(Date.now()).slice(0,-3),{auth:i,sign:r,status:n,message:o}=yield function(e){return HC(this,arguments,(function(e){let{sdkAppId:t,userId:i,userSig:r,timestamp:n}=e;return function*(){let e="https://".concat(function(e){let t;return t=RV(e)?kV.MAIN_OVERSEA:kV.MAIN,t}(t),"/api/v1/audioAiAuth?sdkAppId=").concat(t,"&userId=").concat(i,"&userSig=").concat(r,"&timestamp=").concat(n),o=yield fetch(e),{data:{errCode:s,errMsg:a,sign:c,status:l}}=yield o.json();if("1"===l)return {auth:!0,sign:c,status:l,message:a};let d="Init RTCAIDenoiser failed.",u="";switch(s){case 1:u="Please check your params.";break;case 2:u="You need to buy packages. Refer to: https://cloud.tencent.com/document/product/647/44247";break;case 3:u="Server is invalid. Please contact our engineer. ";break;case 4:u="Your packages is not active. Refer to: https://cloud.tencent.com/document/product/647/44247";break;case 5:u="Your packages is expired. Refer to: https://cloud.tencent.com/document/product/647/44247";break;case 6:u="Your version is not supported.";}return {auth:!1,status:l,message:a?"".concat(d," Reason: ").concat(a,". ").concat(u):"".concat(d,", ").concat(u)}}()}))}(MC(PC({},e),{timestamp:t}));if(!i)throw this.log.info("RTCAIDenoiser: ".concat(e.userId," auth result: ").concat(i,". Message: ").concat(o)),new Vx({code:Ox.INVALID_PARAMETER,message:o});this.workletNode=new AudioWorkletNode(this.audioContext,"trtc-denoiser-processor",{numberOfInputs:1,numberOfOutputs:1}),this.workletNode.port.postMessage({type:"init",data:{sdkAppId:String(e.sdkAppId),userId:e.userId,timestamp:t,sign:r,status:n}}),this.workletNode.port.onmessage=e=>{let{data:t}=e;"cost"===t.type&&this.log.debug("[RTCAIDenoiser] ".concat(t.value));};}this.workletNode.port.postMessage({type:"enable"}),t.audioManager.addDenoiser(this.workletNode),t.sendAbilityStatus({ai_denoise:1});}))}update(){return HC(this,null,(function*(){}))}stop(){return HC(this,null,(function*(){if(!this.workletNode)return;let{room:e}=this.core;this.workletNode.port.postMessage({type:"disable"}),yield e.audioManager.removeDenoiser(this.workletNode);}))}destroy(){!this.workletNode||(this.workletNode.port.onmessage=null);}},bV=CV;FC(bV,"updateValidateRule",{type:"object"}),FC(bV,"stopValidateRule",{type:"object"}),FC(bV,"Name","AIDenoiser");var kV={MAIN:"schedule.cloud-rtc.com",MAIN_OVERSEA:"schedule.rtc.tencentcloud.com"};var DV=VC(jC(),1),NV=class extends DV.EventEmitter{constructor(){super(),this.state="nominal",this.onPressureChange=this.onPressureChange.bind(this);}get stateNum(){switch(this.state){case"nominal":return 1;case"fair":return 2;case"serious":return 3;case"critical":return 4}}start(){return HC(this,null,(function*(){if(!this.observer)try{"PressureObserver"in window&&!aD&&(this.observer=new PressureObserver(this.onPressureChange),yield this.observer.observe("cpu",{sampleInterval:2e3}));}catch(db){GN.uploadEvent({log:"stat-pressure-detector-start-failed",error:db});}}))}onPressureChange(e){let t=this.stateNum,i=e[e.length-1];this.state=i.state,(this.stateNum>3||t>3)&&sO.info("".concat(i.source,": ").concat(i.state)),this.emit("state-changed",{type:i.source,state:this.state});}destroy(){var e;try{null==(e=this.observer)||e.disconnect(),this.observer=null;}catch(hk){GN.uploadEvent({log:"stat-pressure-detector-destroy-failed",error:hk});}}},wV=new NV;function OV(e){let[t,i]=e,r=i.byteLength,n=parseInt(String(r/255),10),o=r%255,s=[];s.push(0,0,0,1,6,t);for(let c=0;c<n;c++)s.push(255);s.push(o);let a=new DataView(i);return s.push(...new Uint8Array(a.buffer)),s.push(128),new pL(new DataView(new Uint8Array(s).buffer),!0)}function PV(e){return "empty"===e.type||0===e.data.byteLength}function MV(e){return 1===e.getInt32(0)&&6===e.getInt8(4)}function LV(e){let t=0,i=0,r=new DataView(e);for(let n=0;n<e.byteLength;n++)switch(r.getUint8(n)){case 0:t++;break;case 1:(2===t||3===t)&&i++,t=0;break;default:t=0;}return i}function xV(e){let{frame:t,seiMessageList:i}=e;if(!i||0===i.length||0===t.data.byteLength)return t;let r=9-LV(t.data);if(r<=0)return t;let n=i.splice(0,r).reverse().map(OV),o=n.reduce(((e,t)=>e+t.dataView.byteLength),0),s=new ArrayBuffer(o+t.data.byteLength),a=new DataView(s),c=new DataView(t.data),l=0;for(let d=0;d<n.length;d++)for(let e=0;e<n[d].dataView.byteLength;e++)a.setInt8(l++,n[d].dataView.getInt8(e));for(let d=0;d<t.data.byteLength;d++)a.setInt8(l++,c.getInt8(d));return t.data=s,t}function VV(e){let{frame:t,onSEI:i}=e;try{let e=new DataView(t.data);if(PV(t)||!MV(e))return t;let r=[],n=0,o=-1,s=-1;for(let i=0;i<t.data.byteLength;i++){let a=e.getUint8(i);if(0===a)n++;else if(1===a){if(2===n||3===n){let a=i-n;if(-1===o?o=a:-1===s&&(s=a,r.push(new pL(new DataView(e.buffer.slice(o,s)))),o=a,s=-1),6!==e.getUint8(i+1)){t.data=e.buffer.slice(a);break}}n=0;}else n=0;}null==i||i(r.reverse());}catch(db){}return t}var UV=0,FV=class{constructor(e){this.core=e,FC(this,"log"),FC(this,"_seiMessageList",[]),FC(this,"_smallSeiMessageList",[]),FC(this,"_subStreamSeiMessageList",[]),UV++,this.log=e.log.createChild({id:"".concat(this.getAlias()).concat(UV)}),this.log.info("[sei] created id=".concat(this.getAlias()).concat(UV)),this.core=e,this.encode=this.encode.bind(this),this.decode=this.decode.bind(this);}encode(e){let{frame:t,mediaType:i}=e;try{return xV({frame:t,seiMessageList:8===i?this._smallSeiMessageList:2===i?this._subStreamSeiMessageList:this._seiMessageList})}catch(hk){this.log.warn(hk);}return t}decode(e){let{frame:t,track:i}=e;return VV({frame:t,onSEI:e=>{e.forEach((e=>{this.core.trtc.emit(nV.SEI_MESSAGE,{seiPayloadType:e.seiPayloadType,data:e.seiPayload.buffer,userId:i.userId,streamType:2===i.mediaType?"sub":"main"});}));}})}destroy(){this.log.debug("destory"),this.stop(),delete this.core;}getValidateRule(e){switch(e){case"start":case"update":case"stop":return {type:"object"}}}start(){this.core.room.videoManager.addEncodeProcessor({processor:oP?this.encode:xV,type:1}),this.core.room.videoManager.addDecodeProcessor({processor:oP?this.decode:VV,type:1});}stop(){this.core.room.videoManager.removeEncodeProcessor({type:1}),this.core.room.videoManager.removeDecodeProcessor({type:1});}update(e){let{buffer:t,options:i}=e;var r;let n=[i.seiPayloadType,t],o=!!i.small;i.toSubStream?this._subStreamSeiMessageList.push(n):(this._seiMessageList.push(n),o&&this._smallSeiMessageList.push(n)),null==(r=this.core.room.scriptTransformWorker)||r.postMessage({type:"sei",data:n,isMain:!i.toSubStream,small:o});}getName(){return FV.Name}getAlias(){return "sei"}getGroup(){return "sei"}},BV=FV;FC(BV,"autoStart",!0),FC(BV,"Name","SEI");var HV,jV=0,WV=class{constructor(e){this.core=e,FC(this,"_core"),FC(this,"log"),FC(this,"dumpLocalVideoMap",{}),FC(this,"dumpRemoteVideoMap",{}),FC(this,"dialog"),this._core=e,this.log=e.log.createChild({id:"".concat(this.getAlias()).concat(++jV)}),this.log.info("created");}getName(){return WV.Name}getAlias(){return "dm"}getGroup(){return "dm"}getValidateRule(e){switch(e){case"start":return {name:"StartDebugOptions",required:!1};case"update":return {name:"UpdateDebugOptions",required:!1};case"stop":return {name:"StopDebugOptions",required:!1}}}start(){return HC(this,null,(function*(){!new URLSearchParams(location.search).has("trtcDebug")||(yield this.openDebugDiaLog(),this._core.rtcDectection.IS_INSERTABLE_STREAM_SUPPORTED&&this.addVideoProcessor());}))}update(){}stop(){this.closeDebugDiaLog(),this.removeVideoProcessor();}destroy(){this.stop();}openDebugDiaLog(){return HC(this,null,(function*(){try{if(HV)yield HV;else {let e=Date.now();HV=this.loadScript("https://web.sdk.qcloud.com/trtc/webrtc/assets/debug/debug-dialog@".concat(cb,".js")),yield HV,this.log.info("download debug dialog script cost: ".concat(Date.now()-e,"ms"));}this.dialog=new TRTCDebugDialog(this._core,this.log,this.dumpLocalVideoMap,this.dumpRemoteVideoMap),this._core.kvStatManager.addSuccessEvent({key:592705});}catch(hO){this._core.kvStatManager.addFailedEvent({key:592705}),this.log.error("load debug dialog script failed: ",JSON.stringify(hO));}}))}closeDebugDiaLog(){var e;null==(e=this.dialog)||e.closeDialog(),this.dialog=null;}addVideoProcessor(){this._core.room.videoManager.addEncodeProcessor({processor:this._core.rtcDectection.IS_INSERTABLE_STREAM_SUPPORTED?this.encodeVideo.bind(this):this.encodeVideoDump,type:2}),this._core.room.videoManager.addDecodeProcessor({processor:this._core.rtcDectection.IS_INSERTABLE_STREAM_SUPPORTED?this.decodeVideo.bind(this):this.decodeVideoDump,type:2});}removeVideoProcessor(){this._core.room.videoManager.removeEncodeProcessor({type:2}),this._core.room.videoManager.removeDecodeProcessor({type:2});}encodeVideo(e){let{frame:t,mediaType:i}=e;return this.encodeVideoDump({frame:t,onDump:()=>{if(!i)return;let e=2===i?"sub":"main",r=this.dumpLocalVideoMap[e];r&&(r.data.push(t.data),r.duration>0&&Date.now()-r.startTimestamp>1e3*r.duration&&r.onDumpEnd());}})}decodeVideo(e){let{frame:t,track:i}=e;return this.decodeVideoDump({frame:t,onDump:()=>{if(!i)return;let e=this.dumpRemoteVideoMap["".concat(i.userId,"-").concat(i.streamType)];e&&(e.data.push(t.data),e.duration>0&&Date.now()-e.startTimestamp>1e3*e.duration&&e.onDumpEnd());}})}encodeVideoDump(e){let{frame:t,onDump:i}=e;return null==i||i(),t}decodeVideoDump(e){let{frame:t,onDump:i}=e;return null==i||i(),t}loadScript(e){return new Promise(((t,i)=>{this.log.info("loading debug dialog from ".concat(e));let r=document.createElement("script");r.type="text/javascript",r.onload=t,r.onerror=i,r.crossOrigin="anonymous",r.src=e,document.head.append?document.head.append(r):document.getElementsByTagName("head")[0].appendChild(r);}))}},GV=WV;FC(GV,"Name","Debug"),FC(GV,"autoStart",!0),UC([VP({settings:{timeout:3e3,retries:3},onError(e,t,i){var r;null!=(r=null==e?void 0:e.message)&&r.includes("timeout")?t():i(e);}})],GV.prototype,"loadScript",1);var JV=0,KV=new Set,zV=null;lb("5.8.5");var qV={RtcError:Vx,ErrorCode:Ox,ErrorCodeDictionary:Px},YV=class extends XC.EventEmitter{constructor(e,t){super(),FC(this,"_room"),FC(this,"_eventListened",new Set),FC(this,"_localVideoTrack",null),FC(this,"_localAudioTrack",null),FC(this,"_localScreenTrack",null),FC(this,"_localScreenAudioTrack",null),FC(this,"_localVideoConfig",null),FC(this,"_localScreenConfig",null),FC(this,"_localAudioConfig",null),FC(this,"_remoteVideoConfigMap",new Map),FC(this,"_remoteAudioConfigMap",new Map),FC(this,"_remoteAudioMuteMap",new Map),FC(this,"_mediaTrackMap",new WeakMap),FC(this,"_log",sO.createLogger({id:"t".concat(++JV)})),FC(this,"_plugins",new Map),FC(this,"_networkQuality",null),FC(this,"_speakerId"),FC(this,"_getPCMAbortCtrl"),this._room=new e(PC({logger:this._log,frameWorkType:YV.frameWorkType},t)),this._log.debug("TRTC.create() ".concat(JSON.stringify(t,((e,t)=>"plugins"===e?t.map((e=>e.Name)):t)))),Object.defineProperties(this,{dumpAudio:{enumerable:!1,value(e){return this._room.audioManager.dump(e)}}}),t.plugins&&t.plugins.forEach((e=>{this._use(e,t.assetsPath);})),this._use(SV,t.assetsPath),this._use(bV,t.assetsPath),this._use(GV),t.enableSEI&&aP&&this._use(BV),this._room.on("audio-volume",(e=>{!e.find((e=>""===e.userId))&&this._localAudioTrack&&e.push({userId:"",volume:Math.floor(100*this._localAudioTrack.getAudioLevel())}),this.emit(nV.AUDIO_VOLUME,{result:e.sort(((e,t)=>t.volume-e.volume))});})),this._room.videoManager.on("error",(e=>{this._log.error(new Vx({code:Ox.OPERATION_FAILED,extraCode:5504,message:e.message,originError:e}));})),this._listenEvents(),this._initActiveSpeaker(),((e,t)=>{let{emit:i}=e;e.emit=function(){for(var r=arguments.length,n=new Array(r),o=0;o<r;o++)n[o]=arguments[o];try{return i.apply(e,n)}catch(ub){let i=xN({key:zk.CATCH_HANDLER_ERROR,data:{name:t,event:n[0]},addDocLink:!1});return sO.warn("".concat(i,"\n\n").concat(ub.stack)),!1}};})(this,"trtc");}static create(e){}static _create(e,t){!function(){var e;Nx&&(Nx=!1,5!==sO.getLogLevel()&&(console.info("******************************************************************************"),console.info("*   TRTC Web SDK"),console.info("*   API Document: ".concat(Sb,"/en/index.html")),console.info("*   Changelog: ".concat(Sb,"/en/tutorial-01-info-changelog.html")),console.info("*   Report issues: https://github.com/LiteAVSDK/TRTC_Web/issues"),console.info("******************************************************************************")),sO.info("TRTC Web SDK Version:",cb),sO.info("UA:",navigator.userAgent),sO.info("URL: ".concat(location.href).concat("IFRAME"===(null==(e=self.frameElement)?void 0:e.tagName)?" in iframe":"")),CN().then((e=>{e&&sO.info(AN);})));}();let i=new YV(e,t||{});return KV.add(i),i}get room(){return this._room}_listenEvents(){MP(this,this._room).add("peer-join",(e=>{let{userId:t}=e;this.emit(nV.REMOTE_USER_ENTER,{userId:t});})).add("peer-leave",(e=>{this.emit(nV.REMOTE_USER_EXIT,{userId:e});})).add("banned",(e=>{this._exitRoom().then((()=>{this.emit(nV.KICKED_OUT,{reason:e.reason});}));})).add("error",(e=>{this._exitRoom().then((()=>{this.emit(nV.ERROR,Vx.convertFrom(e));}));})).add("signal-connection-state-changed",(e=>{this.emit(nV.CONNECTION_STATE_CHANGED,e);})).add("network-quality",(e=>{this._networkQuality=e;let t=MC(PC({},e),{uplinkRTT:Math.min(e.uplinkRTT,Wk),downlinkRTT:Math.min(e.downlinkRTT,Wk)});this.emit(nV.NETWORK_QUALITY,t);})).add("remote-published",(e=>{[e.remoteAudioTrack,e.remoteVideoTrack,e.remoteAuxiliaryTrack].forEach((t=>{MP(t,t).add("player-state-changed",(i=>{let r=MC(PC({},i),{userId:e.userId});t.kind===Ub.VIDEO&&(r.streamType=sV(t.streamType)),this.emit(t.kind===Ub.AUDIO?nV.AUDIO_PLAY_STATE_CHANGED:nV.VIDEO_PLAY_STATE_CHANGED,r);})).add("error",(e=>{e.getCode()===ZC.PLAY_NOT_ALLOWED&&this.emit(nV.AUTOPLAY_FAILED,{userId:t.userId});}));}));})).add("remote-unpublished",(e=>{[e.remoteAudioTrack,e.remoteVideoTrack,e.remoteAuxiliaryTrack].forEach((e=>{LP(e);}));})).add("remote-publish-state-changed",(e=>{let{prevMuteState:t,muteState:i}=e,{userId:r}=i,n=t.audioAvailable,o=t.videoAvailable,{audioAvailable:s,videoAvailable:a}=i;s||this._remoteAudioConfigMap.delete(r),a||this._remoteVideoConfigMap.delete("".concat(r,"_","main")),i.hasAuxiliary||this._remoteVideoConfigMap.delete("".concat(r,"_","sub")),n!==s&&(this.emit(s?nV.REMOTE_AUDIO_AVAILABLE:nV.REMOTE_AUDIO_UNAVAILABLE,{userId:r}),s?this._onAudioAvailable({userId:r}):this._onAudioUnavailable({userId:r,muteState:i})),o!==a&&(this.emit(a?nV.REMOTE_VIDEO_AVAILABLE:nV.REMOTE_VIDEO_UNAVAILABLE,{userId:r,streamType:"main"}),a?this._onVideoAvailable({userId:r,streamType:"main"}):this._onVideoUnavailable({userId:r,streamType:"main"})),t.hasAuxiliary!==i.hasAuxiliary&&(this.emit(i.hasAuxiliary?nV.REMOTE_VIDEO_AVAILABLE:nV.REMOTE_VIDEO_UNAVAILABLE,{userId:r,streamType:"sub"}),i.hasAuxiliary?this._onVideoAvailable({userId:r,streamType:"sub"}):this._onVideoUnavailable({userId:r,streamType:"sub"}));})).add("sei-message",(e=>{this.emit(nV.SEI_MESSAGE,MC(PC({},e),{streamType:sV(e.streamType)}));})).add("firewall-restriction",(()=>{this.emit(nV.ERROR,new Vx({code:Ox.OPERATION_FAILED,extraCode:5501}));})).add("heartbeat-report",(e=>{var t,i,r,n,o,s,a;let c={2:"big",3:"small",7:"sub"},l={rtt:Math.min(e.msg_up_stream_info.msg_network_status.uint32_rtt||(null==(t=e.msg_down_stream_info[0])?void 0:t.msg_network_status.uint32_rtt)||(null==(i=this._networkQuality)?void 0:i.uplinkRTT)||(null==(r=this._networkQuality)?void 0:r.downlinkRTT)||0,Wk),upLoss:(null==(n=this._networkQuality)?void 0:n.uplinkLoss)||0,downLoss:(null==(o=this._networkQuality)?void 0:o.downlinkLoss)||0,bytesSent:e.bytes_sent||0,bytesReceived:e.bytes_received||0,localStatistics:{audio:{bitrate:((null==(s=e.msg_up_stream_info.msg_audio_status)?void 0:s.uint32_audio_codec_bitrate)||0)/1e3,audioLevel:((null==(a=e.msg_up_stream_info.msg_audio_status)?void 0:a.uint32_audio_level)||0)/Kk},video:e.msg_up_stream_info.msg_video_status.filter((e=>c[e.uint32_video_stream_type])).map((e=>({bitrate:(e.uint32_video_codec_bitrate||0)/1e3,width:e.uint32_video_width,height:e.uint32_video_height,frameRate:e.uint32_video_enc_fps,videoType:c[e.uint32_video_stream_type]})))},remoteStatistics:e.msg_down_stream_info.map((e=>({userId:e.msg_user_info.str_identifier,audio:{bitrate:(e.msg_audio_status.uint32_audio_codec_bitrate||0)/1e3,audioLevel:(e.msg_audio_status.uint32_audio_level||0)/Kk},video:e.msg_video_status.map((e=>({bitrate:(e.uint32_video_codec_bitrate||0)/1e3,width:e.uint32_video_width,height:e.uint32_video_height,frameRate:e.uint32_video_dec_fps,videoType:c[e.uint32_video_stream_type]})))})))};this.emit(nV.STATISTICS,l);})).add("custom-message",(e=>{this.emit(nV.CUSTOM_MESSAGE,e);})),MP(this,DM).add("audioInputAdded",(e=>{this.emit(nV.DEVICE_CHANGED,{type:"microphone",action:"add",device:e});})).add("audioInputRemoved",(e=>{this.emit(nV.DEVICE_CHANGED,{type:"microphone",action:"remove",device:e});})).add("videoInputAdded",(e=>{this.emit(nV.DEVICE_CHANGED,{type:"camera",action:"add",device:e});})).add("videoInputRemoved",(e=>{this.emit(nV.DEVICE_CHANGED,{type:"camera",action:"remove",device:e});})).add("audioOutputAdded",(e=>HC(this,null,(function*(){if(this.emit(nV.DEVICE_CHANGED,{type:"speaker",action:"add",device:e}),zV&&zV.deviceId===Ok){let e=(yield LM()).find((e=>e.deviceId===Ok));e&&zV.groupId!==e.groupId&&(zV=e,this.emit(nV.DEVICE_CHANGED,{type:"speaker",action:"active",device:e}));}})))).add("audioOutputRemoved",(e=>HC(this,null,(function*(){this.emit(nV.DEVICE_CHANGED,{type:"speaker",action:"remove",device:e});let t=(yield LM())[0];if(!t||!zV||zV.groupId===t.groupId)return;let i=zV.deviceId===e.deviceId,r=zV.deviceId===Ok&&zV.deviceId===t.deviceId;(i||r)&&(zV=t,this.emit(nV.DEVICE_CHANGED,{type:"speaker",action:"active",device:t}));}))));}use(e){let t,i;"plugin"in e?(t=e.plugin,i=e.assetsPath):t=e,this._use(t,i||"https://web.sdk.qcloud.com/trtc/webrtc/v5/assets/");}_use(e,t){if(this._plugins.get(e.Name))return void this._log.warn("duplicate install plugin",e.Name);let i=new e(dV.call(this,{TRTC:YV,room:this._room,errorModule:qV,assetsPath:t}));this._plugins.set(e.Name,i),e.autoStart&&this.startPlugin(e.Name);}enterRoom(e){return HC(this,null,(function*(){var t,i;let{scene:r="rtc",enableAutoPlayDialog:n=!0,autoReceiveAudio:o=!0,autoReceiveVideo:s=!1}=e;e.proxy&&(this._room.setProxyServer(e.proxy),!Iw(e.proxy)&&e.proxy.turnServer&&(null==(i=(t=this._room).setTurnServer)||i.call(t,e.proxy.turnServer,e.proxy.iceTransportPolicy))),this._room.enableAutoPlayDialog=n,this._room.autoReceiveAudio=o,this._room.autoReceiveVideo=s,Aw(e.preferHW)&&(this._room.preferHW=e.preferHW);let a={sdkAppId:e.sdkAppId,userId:e.userId,userSig:e.userSig,privateMapKey:e.privateMapKey||null,latencyLevel:e.latencyLevel,role:"audience"===e.role?21:20,roomId:e.roomId||0,strRoomId:e.strRoomId||"",businessInfo:e.businessInfo||null,streamId:null,userDefineRecordId:e.userDefineRecordId||null,frameWorkType:e.frameWorkType,component:e.component,language:e.language,priority:e.priority,useVp8:e.useVp8};e.strRoomId&&!e.roomId?this._room.useStringRoomId=!0:this._room.useStringRoomId=!1,yield this._room.join(a,r,YV.frameWorkType),this._checkTrackToPublish(),wV.start();}))}exitRoom(){return HC(this,null,(function*(){return yield this._exitRoom()}))}switchRole(e,t){return HC(this,null,(function*(){null!=t&&t.privateMapKey&&(this._room.privateMapKey=t.privateMapKey),null!=t&&t.latencyLevel&&(this._room.latencyLevel=t.latencyLevel),yield this._room.switchRole(e),"anchor"===e&&this._checkTrackToPublish();}))}destroy(){LP(this),this.removeAllListeners(),this._room.destroy(),KV.delete(this),0===KV.size&&wV.destroy(),this._localAudioTrack&&this.stopLocalAudio(),this._localVideoTrack&&this.stopLocalVideo(),this._localScreenTrack&&this.stopScreenShare(),this._plugins.forEach((e=>{var t;return null==(t=e.destroy)?void 0:t.call(e)}));}startLocalAudio(){return HC(this,arguments,(function(){var e=this;let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{publish:!0};return function*(){if(e._localAudioTrack)return void e._log.warn("local audio is already started");let{publish:i=!0,mute:r,option:n}=t,o=new hL(e._room.audioManager),s={},a={muted:!0};n&&(Sw(n.microphoneId)?Sw(n.audioTrack)||(s.customSource=n.audioTrack):s.deviceId=n.microphoneId,n&&Rw(n.captureVolume)&&o.setCaptureVolume(n.captureVolume),Sw(n.profile)||(Iw(n.profile)?Lb[n.profile]&&o.setProfile(Lb[n.profile]):o.setProfile(n.profile)),Rw(n.earMonitorVolume)&&(a.muted=!(n.earMonitorVolume>0),a.volume=n.earMonitorVolume),Sw(n.echoCancellation)||(o.profile.echoCancellation=n.echoCancellation),Sw(n.noiseSuppression)||(o.profile.noiseSuppression=n.noiseSuppression),Sw(n.autoGainControl)||(o.profile.autoGainControl=n.autoGainControl)),o.on("5",(t=>{e.emit(nV.ERROR,new Vx({code:Ox.DEVICE_ERROR,extraCode:5309,messageParams:{error:t}}));})),o.on("2",(t=>{e.emit(nV.DEVICE_CHANGED,{type:"microphone",action:"active",device:t});})),o.on("4",(t=>{let i;t.error&&(i=Vx.convertFrom(t.error)),e.emit(nV.PUBLISH_STATE_CHANGED,MC(PC({},t),{error:i}));})),e._listenOutputTrackChanged(o),e._speakerId&&o.setAudioOutput(e._speakerId),yield o.capture(s),Sw(r)||o.setMute(r),MP(o,o).add("player-state-changed",(t=>{e.emit(nV.AUDIO_PLAY_STATE_CHANGED,MC(PC({},t),{userId:""}));})),e.listeners(nV.AUDIO_FRAME).length>0&&(e._getPCMAbortCtrl=e._room.audioManager.getPCM((t=>{e.emit(YV.EVENT.AUDIO_FRAME,{data:t});}))),i&&e._room.isJoined&&e._room.publish(o).catch((()=>{})),e._localAudioTrack=o,e._localAudioConfig=MC(PC({},t),{publish:i}),yield e._updateAudioPlayOption({playOption:a,track:o});}()}))}updateLocalAudio(e){return HC(this,null,(function*(){if(!this._localAudioTrack||!this._localAudioConfig)return;let{publish:t,mute:i,option:r}=e,n={};r&&(r.microphoneId?yield this._localAudioTrack.switchDevice(r.microphoneId):Sw(r.audioTrack)||(yield this._localAudioTrack.setInputMediaStreamTrack(r.audioTrack)),Sw(r.captureVolume)||this._localAudioTrack.setCaptureVolume(r.captureVolume),Sw(r.earMonitorVolume)||(n.muted=!(r.earMonitorVolume>0),n.volume=r.earMonitorVolume),yield this._localAudioTrack.update3A(r)),this._room.isJoined&&!Sw(t)&&(t&&!this._localAudioConfig.publish&&this._room.publish(this._localAudioTrack).catch((()=>{})),this._localAudioConfig.publish&&!t&&this._room.unpublish(this._localAudioTrack).catch((()=>{}))),Sw(i)||this._localAudioTrack.setMute(i),yield this._updateAudioPlayOption({playOption:n,track:this._localAudioTrack,prevConfig:this._localAudioConfig}),Ww(this._localAudioConfig,e);}))}stopLocalAudio(){return HC(this,null,(function*(){!this._localAudioTrack||(this._room.isJoined&&(yield this._room.unpublish(this._localAudioTrack).catch((()=>{}))),this._localAudioTrack.stop(),this._localAudioTrack.close(),this._room.audioManager.removeInput(this._localAudioTrack),LP(this._localAudioTrack),this._localAudioTrack=null,this._localAudioConfig=null,this._getPCMAbortCtrl&&(this._getPCMAbortCtrl.abort("stopLocalAudio"),delete this._getPCMAbortCtrl));}))}startLocalVideo(){return HC(this,arguments,(function(){var e=this;let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{publish:!0,view:null};return function*(){if(e._localVideoTrack)return void e._log.warn("local video is already started");let{view:i,publish:r=!0,mute:n,option:o}=t,s=new _L(e._room.videoManager),a={},c={};if(o&&(o.cameraId?a.deviceId=o.cameraId:Sw(o.useFrontCamera)?Sw(o.videoTrack)||(a.customSource=o.videoTrack):a.facingMode=o.useFrontCamera?Ub.FACING_MODE_USER:Ub.FACING_MODE_ENVIRONMENT,Sw(o.profile)||(Iw(o.profile)?xb[o.profile]&&s.setProfile(xb[o.profile]):s.setProfile(o.profile)),Sw(o.fillMode)||(c.objectFit=o.fillMode),Sw(o.mirror)||(c.mirror=o.mirror),Sw(o.small)||(JO()?Iw(o.small)?s.small=xb[o.small]:!0===o.small?s.small=xb["120p"]:s.small=o.small:e._log.warn("small stream is not supported"))),s.on("5",(t=>{e.emit(nV.ERROR,new Vx({code:Ox.DEVICE_ERROR,extraCode:5308,messageParams:{error:t}}));})),s.on("2",(t=>{e.emit(nV.DEVICE_CHANGED,{type:"camera",action:"active",device:t});})),s.on("4",(t=>{let i;t.error&&(i=Vx.convertFrom(t.error)),e.emit(nV.PUBLISH_STATE_CHANGED,MC(PC({},t),{error:i}));})),e._listenOutputTrackChanged(s),yield s.capture(a),Sw(n)||(yield s.setMute(n)),s.mediaTrack){if(null!=o&&o.qosPreference){let e=aV(o.qosPreference);s.mediaTrack.contentHint=e;}else null!=o&&o.videoTrack||(s.mediaTrack.contentHint=aV(wx.QOS_PREFERENCE_SMOOTH));s.outMediaTrack&&(s.outMediaTrack.contentHint=s.mediaTrack.contentHint);}MP(s,s).add("player-state-changed",(t=>{e.emit(nV.VIDEO_PLAY_STATE_CHANGED,MC(PC({},t),{userId:"",streamType:"main"}));})),r&&e._room.isJoined&&e._room.publish(s).catch((()=>{})),e._localVideoTrack=s,e._localVideoConfig=MC(PC({},t),{view:i,publish:r}),yield e._updateVideoPlayOption({view:i,playOption:c,track:s});}()}))}updateLocalVideo(e){return HC(this,null,(function*(){if(!this._localVideoTrack||!this._localVideoConfig)return;let{view:t,publish:i,mute:r,option:n}=e,o={};if(n){if(Sw(n.profile)||(Iw(n.profile)?xb[n.profile]&&this._localVideoTrack.setProfile(xb[n.profile]):this._localVideoTrack.setProfile(n.profile),(!n.cameraId||!this._localVideoTrack.isNeedToSwitchDevice(n.cameraId))&&Sw(n.useFrontCamera)&&this._localVideoTrack.applyProfile()),n.cameraId?yield this._localVideoTrack.switchDevice(n.cameraId):Sw(n.useFrontCamera)?Sw(n.videoTrack)||(yield this._localVideoTrack.setInputMediaStreamTrack(n.videoTrack)):yield this._localVideoTrack.switchDevice(n.useFrontCamera?Ub.FACING_MODE_USER:Ub.FACING_MODE_ENVIRONMENT),Sw(n.fillMode)||(o.objectFit=n.fillMode),Sw(n.mirror)||(o.mirror=n.mirror),n.qosPreference&&this._localVideoTrack.mediaTrack){let e=aV(n.qosPreference);this._localVideoTrack.mediaTrack.contentHint=e,this._localVideoTrack.outMediaTrack&&(this._localVideoTrack.outMediaTrack.contentHint=e);}if(n.small){let e=!this._localVideoTrack.small;JO()?(!0===n.small?this._localVideoTrack.small=xb["120p"]:Iw(n.small)?this._localVideoTrack.small=xb[n.small]:this._localVideoTrack.small=n.small,this._room.videoManager.update(),e&&this._room.enableSmall(!0)):this._log.warn("small stream is not supported");}else !1===n.small&&this._localVideoTrack.small&&(delete this._localVideoTrack.small,this._room.videoManager.update(),this._room.enableSmall(!1));}this._room.isJoined&&!Sw(i)&&(i&&!this._localVideoConfig.publish&&this._room.publish(this._localVideoTrack).catch((()=>{})),this._localVideoConfig.publish&&!i&&this._room.unpublish(this._localVideoTrack).catch((()=>{}))),Sw(r)||(yield this._localVideoTrack.setMute(r)),yield this._updateVideoPlayOption({view:t,playOption:o,track:this._localVideoTrack,prevConfig:this._localVideoConfig}),Ww(this._localVideoConfig,e);}))}stopLocalVideo(){return HC(this,null,(function*(){!this._localVideoTrack||(this._room.isJoined&&(yield this._room.unpublish(this._localVideoTrack).catch((()=>{}))),this._localVideoTrack.stop(),this._localVideoTrack.close(),LP(this._localVideoTrack),this._localVideoTrack=null,this._localVideoConfig=null);}))}startScreenShare(){return HC(this,arguments,(function(){var e=this;let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{publish:!0,view:null};return function*(){if(e._localScreenTrack)return void e._log.warn("screen share is already started");let{view:i=null,publish:r=!0,option:n}=t,o=new EL(e._room.videoManager);o.on("4",(t=>{let i;t.error&&(i=Vx.convertFrom(t.error)),e.emit(nV.PUBLISH_STATE_CHANGED,MC(PC({},t),{error:i}));})),e._listenOutputTrackChanged(o),"main"===t.streamType&&(o.mediaType=4);let s=null,a={},c={};n&&(Sw(n.profile)||(Iw(n.profile)?Vb[n.profile]&&o.setProfile(Vb[n.profile]):o.setProfile(n.profile)),n.systemAudio&&(a.systemAudio=!0,a.echoCancellation=n.echoCancellation,a.noiseSuppression=n.noiseSuppression,a.autoGainControl=n.autoGainControl),Sw(n.fillMode)||(c.objectFit=n.fillMode),n.videoTrack&&(a.videoTrack=n.videoTrack),n.audioTrack&&(a.audioTrack=n.audioTrack),n.captureElement&&(a.captureElement=n.captureElement),n.preferDisplaySurface&&(a.preferDisplaySurface=n.preferDisplaySurface));let l=yield o.capture(a);if(null!=n&&n.qosPreference){let e=aV(n.qosPreference);o.mediaTrack.contentHint=e;}else null!=n&&n.videoTrack||(o.mediaTrack.contentHint=aV(wx.QOS_PREFERENCE_CLEAR));if(o.mediaTrack.addEventListener(Ub.ENDED,(()=>{e._stopScreenShare(),e.emit(nV.SCREEN_SHARE_STOPPED);})),l.getAudioTracks()[0]&&(s=new vL(e._room.audioManager),s.setInputMediaStreamTrack(l.getAudioTracks()[0]),e._speakerId&&s.setAudioOutput(e._speakerId)),MP(o,o).add("player-state-changed",(t=>{e.emit(nV.VIDEO_PLAY_STATE_CHANGED,MC(PC({},t),{userId:"",streamType:"sub"}));})),r&&e._room.isJoined){let t=[o];s&&t.push(s),e._room.publish(...t).catch((()=>{}));}e._localScreenTrack=o,e._localScreenAudioTrack=s,e._localScreenConfig=MC(PC({},t),{view:i,publish:r}),yield e._updateVideoPlayOption({view:i,playOption:c,track:o});}()}))}updateScreenShare(e){return HC(this,null,(function*(){if(!this._localScreenTrack||!this._localScreenConfig)return;let{view:t,publish:i,option:r}=e,n={};if(r&&(Sw(r.fillMode)||(n.objectFit=r.fillMode),r.qosPreference)){let e=aV(r.qosPreference);this._localScreenTrack.mediaTrack.contentHint=e;}this._room.isJoined&&!Sw(i)&&(i&&!this._localScreenConfig.publish&&(this._room.publish(this._localScreenTrack).catch((()=>{})),this._localScreenAudioTrack&&this._room.publish(this._localScreenAudioTrack).catch((()=>{}))),this._localScreenConfig.publish&&!i&&(this._room.unpublish(this._localScreenTrack).catch((()=>{})),this._localScreenAudioTrack&&this._room.unpublish(this._localScreenAudioTrack).catch((()=>{})))),yield this._updateVideoPlayOption({view:t,playOption:n,track:this._localScreenTrack,prevConfig:this._localScreenConfig}),Ww(this._localScreenConfig,e);}))}stopScreenShare(){return HC(this,null,(function*(){return yield this._stopScreenShare()}))}startRemoteVideo(e){return HC(this,null,(function*(){let{view:t,userId:i,streamType:r,option:n}=e,o="".concat(i,"_").concat(r);if(this._remoteVideoConfigMap.has(o))return void this._log.warn("remote video has already started. userId:".concat(i,", streamType:").concat(r));let s=this._room.remotePublishedUserMap.get(i);if(!s)return;let a={},c="main"===r?s.remoteVideoTrack:s.remoteAuxiliaryTrack;this._listenOutputTrackChanged(c),n&&(Sw(n.fillMode)||(a.objectFit=n.fillMode),Sw(n.mirror)||(a.mirror=n.mirror),a.canvasRender=n.canvasRender,"main"===r&&!Sw(n.small)&&(s.remoteVideoTrack.setMediaType(n.small?8:4),this._room.changeType(n.small,c.user))),yield this._room.subscribe(c),yield this._updateVideoPlayOption({view:t,playOption:a,track:c}),this._emitTrackEvent(c),this._remoteVideoConfigMap.set(o,{config:e}),n&&!Sw(n.receiveWhenViewVisible)&&this._observeView({remoteTrack:c,view:t,receiveWhenViewVisible:n.receiveWhenViewVisible,viewRoot:null==n?void 0:n.viewRoot});}))}updateRemoteVideo(e){return HC(this,null,(function*(){var t,i;let{view:r,userId:n,streamType:o,option:s}=e,a="".concat(n,"_").concat(o),c=this._remoteVideoConfigMap.get(a);if(!c||!this._room.remotePublishedUserMap.has(n))return;let l={};s&&(Sw(s.fillMode)||(l.objectFit=s.fillMode),Sw(s.mirror)||(l.mirror=s.mirror));let d=null,u=this._room.remotePublishedUserMap.get(n);if("main"===o&&(null==u?void 0:u.muteState.hasVideo)&&(d=u.remoteVideoTrack),"sub"===o&&(null==u?void 0:u.muteState.hasAuxiliary)&&(d=u.remoteAuxiliaryTrack),!d)return;let{config:h}=c;"main"===o&&s&&!Sw(s.small)&&this._room.changeType(s.small,d.user),yield this._updateVideoPlayOption({view:r,playOption:l,track:d,prevConfig:h}),Ww(h,e);let p=Sw(null==s?void 0:s.receiveWhenViewVisible)?null==(t=h.option)?void 0:t.receiveWhenViewVisible:s.receiveWhenViewVisible,m=Sw(r)?h.view:r,_=Sw(null==s?void 0:s.viewRoot)?null==(i=h.option)?void 0:i.viewRoot:s.viewRoot;this._observeView({remoteTrack:d,view:m,receiveWhenViewVisible:p,viewRoot:_});}))}stopRemoteVideo(e){return HC(this,null,(function*(){return this._stopRemoteVideo(e)}))}_stopRemoteVideo(e){let t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];return HC(this,null,(function*(){let i=[],r=this._room.remotePublishedUserMap.get(e.userId);if(r){let{muteState:t,remoteVideoTrack:n,remoteAuxiliaryTrack:o}=r;"main"===e.streamType&&(n.stop(),t.hasVideo&&i.push(n)),"sub"===e.streamType&&(o.stop(),t.hasAuxiliary&&i.push(o));}for(let e of i)t&&(yield this._room.unsubscribe(e),this._mediaTrackMap.get(e.outMediaTrack)===e.userId&&this._mediaTrackMap.delete(e.outMediaTrack));let n=this._remoteVideoConfigMap.get("".concat(e.userId,"_").concat(e.streamType));n&&n.observer&&n.observer.disconnect(),this._remoteVideoConfigMap.delete("".concat(e.userId,"_").concat(e.streamType));}))}muteRemoteAudio(e,t){return HC(this,null,(function*(){if("*"===e)if(t)yield this._stopRemoteAudio({userId:e});else {let e=[...this._room.remotePublishedUserMap.values()];for(let t of e)t.muteState.hasAudio&&!this._remoteAudioConfigMap.has(t.userId)&&(yield this._startRemoteAudio({userId:t.userId}));}else t?yield this._stopRemoteAudio({userId:e}):this._remoteAudioConfigMap.has(e)||(yield this._startRemoteAudio({userId:e}));this._remoteAudioMuteMap.set(e,t);}))}setRemoteAudioVolume(e,t){if("*"===e){let e=[...this._room.remotePublishedUserMap.values()];for(let i of e)i.remoteAudioTrack.isSubscribed&&this._updateAudioPlayOption({playOption:{volume:t},track:i.remoteAudioTrack});}else if(e){let i=this._room.remotePublishedUserMap.get(e);i&&i.remoteAudioTrack.isSubscribed&&this._updateAudioPlayOption({playOption:{volume:t},track:i.remoteAudioTrack});}}startPlugin(e,t){return HC(this,null,(function*(){return e.start(t)}))}updatePlugin(e,t){return HC(this,null,(function*(){return e.update(t)}))}stopPlugin(e,t){return HC(this,null,(function*(){return e.stop(t)}))}enableAudioVolumeEvaluation(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:2e3,t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];this._room.enableAudioVolumeEvaluation(e,t);}on(e,t,i){return this.listeners(e).includes(t)||(this._log.debug("on",e),super.on(e,t,i),this._eventListened.add(e),e===YV.EVENT.AUDIO_FRAME&&!this._getPCMAbortCtrl&&(this._getPCMAbortCtrl=this._room.audioManager.getPCM((e=>{this.emit(YV.EVENT.AUDIO_FRAME,{data:e});})))),this}emit(e){for(var t=arguments.length,i=new Array(t>1?t-1:0),r=1;r<t;r++)i[r-1]=arguments[r];try{oV.has(e)&&this._log.debug("emit ".concat(e," ").concat(JSON.stringify(i)));}catch(ub){}return super.emit(e,...i)}off(e,t,i){var r,n;return this._log.debug("off",e),"*"===e?(this._eventListened.clear(),this.removeAllListeners(),null==(r=this._getPCMAbortCtrl)||r.abort("off"),delete this._getPCMAbortCtrl):(super.off(e,t,i),e===YV.EVENT.AUDIO_FRAME&&(null==(n=this._getPCMAbortCtrl)||n.abort("off"),delete this._getPCMAbortCtrl)),this}getAudioTrack(){let e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{userId:"",streamType:"main"},i=null,r="main",n=!1;if(Iw(t)?e=t:(e=t.userId,n=!0===t.processed,t.streamType&&(r=t.streamType)),e){let t=this._room.remotePublishedUserMap.get(e);t&&(i=t.remoteAudioTrack);}else i="sub"===r?this._localScreenAudioTrack:this._localAudioTrack;return i?n&&i.outMediaTrack&&i.outMediaTrack!==i.mediaTrack?i.outMediaTrack.clone():i.mediaTrack:null}getVideoTrack(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{userId:"",streamType:"main"},{userId:t="",streamType:i="main",processed:r=!1}=e,n=null;if(""===t)"main"===i&&this._localVideoTrack&&(n=this._localVideoTrack),"sub"===i&&this._localScreenTrack&&(n=this._localScreenTrack);else {let e=this._room.remotePublishedUserMap.get(t);e&&(n="main"===i?e.remoteVideoTrack:e.remoteAuxiliaryTrack);}return n?r&&n.outMediaTrack&&n.outMediaTrack!==n.mediaTrack?n.outMediaTrack.clone():n.mediaTrack:null}getVideoSnapshot(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{userId:t,streamType:i="main"}=e;if(t){let e=this._room.remotePublishedUserMap.get(t);if("main"===i&&(null==e?void 0:e.muteState.hasVideo))return e.remoteVideoTrack.getVideoFrame();if("sub"===i&&(null==e?void 0:e.muteState.hasAuxiliary))return e.remoteAuxiliaryTrack.getVideoFrame()}else {if("main"===i&&this._localVideoTrack)return this._localVideoTrack.getVideoFrame();if("sub"===i&&this._localScreenTrack)return this._localScreenTrack.getVideoFrame()}return ""}_setCurrentSpeaker(e){var t,i;this._speakerId=e,null==(t=this._localAudioTrack)||t.setAudioOutput(e),null==(i=this._localScreenAudioTrack)||i.setAudioOutput(e),this._room.remotePublishedUserMap.forEach((t=>t.remoteAudioTrack.setAudioOutput(e)));}setCurrentSpeaker(e){return HC(this,null,(function*(){(yield LM()).forEach((t=>{t.deviceId===e&&(this._setCurrentSpeaker(e),this.emit(nV.DEVICE_CHANGED,{type:"speaker",action:"active",device:t}),zV=t);})),this._log.warn('the "setCurrentSpeaker" method of the instance will be deprecated in the future, please use "TRTC.setCurrentSpeaker" instead. For more information, please visit: https://web.sdk.qcloud.com/trtc/webrtc/v5/doc/en/TRTC.html#.setCurrentSpeaker');}))}_startRemoteAudio(e){return this._doStartRemoteAudio(e)}_doStartRemoteAudio(e){return HC(this,null,(function*(){let{userId:t,option:i}=e;if(this._remoteAudioConfigMap.has(t))return void this._log.warn("remote audio has already started. userId:".concat(t));let r=this._room.remotePublishedUserMap.get(t);if(!r)return;let n={};i&&(Sw(i.volume)||(n.volume=i.volume));let o=r.remoteAudioTrack;this._listenOutputTrackChanged(o),this._speakerId&&o.setAudioOutput(this._speakerId);try{this._remoteAudioConfigMap.set(t,e),yield this._room.subscribe(o),yield this._updateAudioPlayOption({playOption:n,track:o});}catch(QF){throw this._remoteAudioConfigMap.delete(t),QF}this._emitTrackEvent(o);}))}_stopRemoteAudio(e){let t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];return HC(this,null,(function*(){let i=this._room.remotePublishedUserMap.get(e.userId);i&&(i.remoteAudioTrack.stop(),i.muteState.hasAudio&&t&&(yield this._room.unsubscribe(i.remoteAudioTrack)),this._mediaTrackMap.get(i.remoteAudioTrack.outMediaTrack)===e.userId&&this._mediaTrackMap.delete(i.remoteAudioTrack.outMediaTrack)),this._remoteAudioConfigMap.delete("".concat(e.userId));}))}_updateVideoPlayOption(e){return HC(this,arguments,(function(e){let{view:t,playOption:i,track:r,prevConfig:n}=e;return function*(){if(r.setMirror(i.mirror),Sw(t)&&n&&n.view&&!Fw(i)){let e=Jw(n.view);e.length>0&&(yield r.play(e,i));}if(!Sw(t)){let e=Jw(t);e.length>0?yield r.play(e,i):r.stop();}}()}))}_updateAudioPlayOption(e){return HC(this,arguments,(function(e){let{playOption:t={},track:i,prevConfig:r}=e;return function*(){if(!i.isPlayCalled)try{yield i.play(null,t);}catch(hb){}Sw(t.muted)||i.setPlayerMute(t.muted),Sw(t.volume)||i.setAudioVolume(t.volume/100);}()}))}_listenOutputTrackChanged(e){0===e.listeners("output-media-track-changed").length&&e.on("output-media-track-changed",(()=>this._emitTrackEvent(e,!1)));}_emitTrackEvent(e){let t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],i=e.isRemote?e.userId:"";!e.outMediaTrack||t&&this._mediaTrackMap.get(e.outMediaTrack)===i||(this._mediaTrackMap.set(e.outMediaTrack,i),this.emit(nV.TRACK,{userId:i,streamType:sV(e.streamType),track:e.outMediaTrack}));}_checkTrackToPublish(){var e,t,i;let r=[];if((null==(e=this._localAudioConfig)?void 0:e.publish)&&this._localAudioTrack&&r.push(this._localAudioTrack),(null==(t=this._localVideoConfig)?void 0:t.publish)&&this._localVideoTrack&&r.push(this._localVideoTrack),null!=(i=this._localScreenConfig)&&i.publish&&(this._localScreenTrack&&r.push(this._localScreenTrack),this._localScreenAudioTrack&&r.push(this._localScreenAudioTrack)),0!==r.length)return this._room.publish(...r).catch((()=>{}))}_observeView(e){let{remoteTrack:t,view:i,receiveWhenViewVisible:r=!1,viewRoot:n}=e;if(Sw(i))return;let o=this._remoteVideoConfigMap.get("".concat(t.userId,"_").concat(sV(t.streamType)));if(!o)return;let s=o.observer||void 0;if(null===i||bw(i)&&0===i.length||!r)return null==s||s.disconnect(),void(t.isSubscribed||this._room.subscribe(t).catch((()=>{})));let a=o.visibleViewMap||new Map,c=-1;(!s||s.root!==n)&&(null==s||s.disconnect(),a.clear(),s=new IntersectionObserver((e=>{e.forEach((e=>{a.set(e.target,e.isIntersecting);})),clearTimeout(c),c=window.setTimeout((()=>{[...a.values()].find((e=>e))?t.isSubscribed||this._room.subscribe(t).catch((()=>{})):t.isSubscribed&&this._room.unsubscribe(t).catch((()=>{}));}),200);}),{root:n}));let l=new Set(Jw(i));a.forEach(((e,t)=>{l.has(t)||(s.unobserve(t),a.delete(t));})),l.forEach((e=>{a.set(e,!0),s.observe(e);})),s.takeRecords().forEach((e=>{a.set(e.target,e.isIntersecting);})),o.visibleViewMap=a,o.observer=s;}_exitRoom(){return HC(this,null,(function*(){this._room.isJoined&&(yield this._room.leave()),new Set([...this._remoteAudioConfigMap.keys(),...this._remoteAudioMuteMap.keys()]).forEach((e=>{this._stopRemoteAudio({userId:e}).catch();})),[...this._remoteVideoConfigMap.keys()].forEach((e=>{let t=e.includes("main")?"main":"sub",i=e.split("_".concat(t))[0];i&&this._stopRemoteVideo({userId:i,streamType:t}).catch();})),this._remoteVideoConfigMap.clear(),this._remoteAudioConfigMap.clear(),this._remoteAudioMuteMap.clear(),this._room.remotePublishedUserMap.forEach((e=>{LP(e.remoteAudioTrack),LP(e.remoteVideoTrack),LP(e.remoteAuxiliaryTrack);}));}))}_stopScreenShare(){return HC(this,null,(function*(){var e;if(this._localScreenTrack){if(this._room.isJoined){let t=[this._localScreenTrack];this._localScreenAudioTrack&&t.push(this._localScreenAudioTrack),yield null==(e=this._room)?void 0:e.unpublish(...t).catch((()=>{}));}this._localScreenTrack.stop(),this._localScreenTrack.close(),this._localScreenAudioTrack&&(this._localScreenAudioTrack.stop(),this._localScreenAudioTrack.close(),this._room.audioManager.removeInput(this._localScreenAudioTrack),this._localScreenAudioTrack=null),LP(this._localScreenTrack),this._localScreenTrack=null,this._localScreenConfig=null;}}))}_initActiveSpeaker(){return HC(this,null,(function*(){if(zV&&!NM(zV))this.emit(nV.DEVICE_CHANGED,{type:"speaker",action:"active",device:zV});else {let e=yield LM();if(e[0]&&!NM(e[0]))zV=e[0],this.emit(nV.DEVICE_CHANGED,{type:"speaker",action:"active",device:e[0]});else {let e=e=>{let{track:t}=e;"audio"===t.kind&&(!zV||NM(zV))&&(this._initActiveSpeaker(),jN.off("102",this._initActiveSpeaker));};jN.on("102",e);}}}))}_onAudioAvailable(e){let{userId:t}=e,i=this._remoteAudioMuteMap.has(t)?this._remoteAudioMuteMap.get(t):this._remoteAudioMuteMap.get("*");(!1===i||this._room.autoReceiveAudio&&!i)&&this._doStartRemoteAudio({userId:t}).catch((()=>{}));}_onVideoAvailable(e){let{userId:t,streamType:i}=e;if(!this._room.autoReceiveVideo)return;let r=this._room.remotePublishedUserMap.get(t);if(r){let e="main"===i?r.remoteVideoTrack:r.remoteAuxiliaryTrack;this._room.subscribe(e).then((()=>{this._emitTrackEvent(e);})).catch((()=>{}));}}_onAudioUnavailable(e){let{userId:t,muteState:i}=e;i.hasAudio&&i.audioMuted||this._stopRemoteAudio({userId:t},!1).catch((()=>{}));}_onVideoUnavailable(e){let{userId:t,streamType:i}=e;this._stopRemoteVideo({userId:t,streamType:i},!1).catch((()=>{}));}sendSEIMessage(e,t){var i;let r=this._plugins.get("SEI");r&&(r.update({buffer:e,options:MC(PC({seiPayloadType:243},t),{small:!(null==(i=this._localVideoTrack)||!i.small)})}),IO.addCount({key:5e5,useUV:!0}));}sendCustomMessage(e){var t,i;null==(i=(t=this._room).sendCustomMessage)||i.call(t,e),IO.addCount({key:500001,useUV:!0});}static setLogLevel(e,t){sO.setLogLevel(e),Sw(t)||(t?sO.enableUploadLog():sO.disableUploadLog());}static isSupported(){return LO()}static getCameraList(){return PM(!(arguments.length>0&&void 0!==arguments[0])||arguments[0])}static getMicrophoneList(){return OM(!(arguments.length>0&&void 0!==arguments[0])||arguments[0])}static getSpeakerList(){return LM(!(arguments.length>0&&void 0!==arguments[0])||arguments[0])}static setCurrentSpeaker(e){return HC(this,null,(function*(){(yield LM()).forEach((t=>{t.deviceId===e&&(KV.forEach((i=>{i._setCurrentSpeaker(e),i.emit(nV.DEVICE_CHANGED,{type:"speaker",action:"active",device:t});})),zV=t);}));}))}static _addKVStat(e){let{type:t,key:i,value:r,base:n,useUV:o,version:s}=e;switch(s&&(SO.version=s),t){case"count":SO.addCount({key:i,useUV:o});break;case"enum":SO.addEnum({key:i,value:r,useUV:o});break;case"number":SO.addNumber({key:i,value:r,split:n});}}},QV=YV;FC(QV,"_loggerManager",sO),FC(QV,"EVENT",nV),FC(QV,"ERROR_CODE",Ox),FC(QV,"TYPE",wx),FC(QV,"frameWorkType",30),UC([fV({replaceArg:e=>({argIndex:0,value:{name:"plugin"in e?e.plugin.Name:e.Name,assetsPath:"assetsPath"in e?null==e?void 0:e.assetsPath:"default"}})})],QV.prototype,"use",1),UC([hV(Kx.TRTC.enterRoom),tV("room",((e,t)=>{let[i]=e,[r]=t;return (i.roomId||i.strRoomId)===(r.roomId||r.strRoomId)&&i.userId===r.userId&&i.sdkAppId===r.sdkAppId})),ZM((e=>function(t){return this._log.setUserId(t.userId),this._log.setSdkAppId(t.sdkAppId),e.call(this,t)})),fV()],QV.prototype,"enterRoom",1),UC([fV()],QV.prototype,"exitRoom",1),UC([hV(Kx.TRTC.switchRole),iV("room",{merge:(e,t)=>t}),fV()],QV.prototype,"switchRole",1),UC([fV()],QV.prototype,"destroy",1),UC([hV(Kx.TRTC.startLocalAudio),tV("audio",((e,t)=>{let[i]=e,[r]=t;var n,o;return (null==(n=null==i?void 0:i.option)?void 0:n.microphoneId)===(null==(o=null==r?void 0:r.option)?void 0:o.microphoneId)})),fV()],QV.prototype,"startLocalAudio",1),UC([hV(Kx.TRTC.updateLocalAudio),iV("audio",{debounce:{delay:200,getKey:()=>"".concat(JV,"-localAudio"),isNeedToDebounce:e=>{var t;return !Sw(null==(t=e.option)?void 0:t.captureVolume)}}}),fV()],QV.prototype,"updateLocalAudio",1),UC([rV("audio"),fV()],QV.prototype,"stopLocalAudio",1),UC([hV(Kx.TRTC.startLocalVideo),tV("video",((e,t)=>{let[i]=e,[r]=t;var n,o;return (null==(n=null==i?void 0:i.option)?void 0:n.cameraId)===(null==(o=null==r?void 0:r.option)?void 0:o.cameraId)})),fV()],QV.prototype,"startLocalVideo",1),UC([hV(Kx.TRTC.updateLocalVideo),iV("video"),fV()],QV.prototype,"updateLocalVideo",1),UC([rV("video"),fV()],QV.prototype,"stopLocalVideo",1),UC([hV(Kx.TRTC.startScreenShare),tV("screen",(()=>!0)),fV()],QV.prototype,"startScreenShare",1),UC([hV(Kx.TRTC.updateScreenShare),iV("screen"),fV()],QV.prototype,"updateScreenShare",1),UC([fV()],QV.prototype,"stopScreenShare",1),UC([hV(Kx.TRTC.startRemoteVideo),tV((e=>"v".concat(e.userId).concat(e.streamType)),(()=>!0)),fV({getRemoteId:e=>"".concat(e.userId,"_").concat(e.streamType)})],QV.prototype,"startRemoteVideo",1),UC([hV(Kx.TRTC.updateRemoteVideo),iV((e=>"v".concat(e.userId).concat(e.streamType))),fV({getRemoteId:e=>"".concat(e.userId,"_").concat(e.streamType)})],QV.prototype,"updateRemoteVideo",1),UC([hV(Kx.TRTC.stopRemoteVideo),ZM((e=>function(t){return HC(this,null,(function*(){if("*"===t.userId){let e=[];return this._room.remotePublishedUserMap.forEach((t=>{this._remoteVideoConfigMap.has("".concat(t.userId,"_","main"))&&e.push(this.stopRemoteVideo({streamType:"main",userId:t.userId}).catch((()=>{}))),this._remoteVideoConfigMap.has("".concat(t.userId,"_","sub"))&&e.push(this.stopRemoteVideo({streamType:"sub",userId:t.userId}).catch((()=>{})));})),Promise.all(e)}return e.call(this,t)}))})),fV({getRemoteId:e=>"".concat(e.userId,"_").concat(e.streamType)})],QV.prototype,"stopRemoteVideo",1),UC([rV((e=>"v".concat(e.userId).concat(e.streamType)))],QV.prototype,"_stopRemoteVideo",1),UC([hV(...Kx.TRTC.muteRemoteAudio),fV({getRemoteId:e=>e})],QV.prototype,"muteRemoteAudio",1),UC([pV(...Kx.TRTC.setRemoteAudioVolume),function(e,t){return ZM(((i,r)=>function(){for(var r=arguments.length,n=new Array(r),o=0;o<r;o++)n[o]=arguments[o];var s,a;let c=null==(s=uV.get(this))?void 0:s.get(t(...n));c&&c>0&&clearTimeout(c);let l=window.setTimeout((()=>{i.apply(this,n);}),e);uV.has(this)?null==(a=uV.get(this))||a.set(t(...n),l):uV.set(this,new Map([[t(...n),l]]));}))}(200,(e=>e)),fV({getRemoteId:e=>e})],QV.prototype,"setRemoteAudioVolume",1),UC([gV("start"),$M((e=>{var t;return null==(t=e.afterStart)?void 0:t.call(e)})),tV(((e,t)=>e.disableRandomCall?null:e.getAlias()+e.getGroup(t))),fV({replaceArg:e=>({argIndex:0,value:e.getName()}),getKVReportKey:e=>fO[e.getName()]})],QV.prototype,"startPlugin",1),UC([gV("update"),iV(((e,t)=>e.disableRandomCall?null:e.getAlias()+e.getGroup(t))),fV({replaceArg:e=>({argIndex:0,value:e.getName()}),getKVReportKey:e=>gO[e.getName()]})],QV.prototype,"updatePlugin",1),UC([gV("stop"),rV(((e,t)=>{if(e.disableRandomCall)return null;let i=e.getGroup(t),r=e.getAlias();return "*"===i?new RegExp("".concat(r,".*")):r+i})),fV({replaceArg:e=>({argIndex:0,value:e.getName()}),getKVReportKey:e=>TO[e.getName()]})],QV.prototype,"stopPlugin",1),UC([pV(...Kx.TRTC.enableAudioVolumeEvaluation)],QV.prototype,"enableAudioVolumeEvaluation",1),UC([fV()],QV.prototype,"getVideoSnapshot",1),UC([fV()],QV.prototype,"_setCurrentSpeaker",1),UC([tV((e=>"a".concat(e.userId)),(()=>!0))],QV.prototype,"_startRemoteAudio",1),UC([ZM((e=>function(t){return HC(this,null,(function*(){return "*"===t.userId?Promise.all([...this._room.remotePublishedUserMap.values()].map((e=>this._stopRemoteAudio(MC(PC({},t),{userId:e.userId})).catch((()=>{}))))):e.call(this,t)}))})),rV((e=>"a".concat(e.userId)))],QV.prototype,"_stopRemoteAudio",1),UC([rV("room")],QV.prototype,"_exitRoom",1),UC([rV("screen")],QV.prototype,"_stopScreenShare",1),UC([hV(...Kx.TRTC.sendSEIMessage),kx({timesInSecond:30,maxSizeInSecond:8e3,getSize:function(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];return t[0].byteLength}})],QV.prototype,"sendSEIMessage",1),UC([hV(Kx.TRTC.sendCustomMessage),kx({timesInSecond:30,maxSizeInSecond:8e3,getSize:e=>e.data.byteLength})],QV.prototype,"sendCustomMessage",1),UC([hV(Kx.TRTC.create)],QV,"_create",1);var XV=QV,$V=class{constructor(){this._set=new Set,jN.on(nO.LEAVE_SUCCESS,this.delete,this);}add(e){let{room:t,roomId:i}=e;if("rtc"===t.scene)return;let r=this.getKey(t.userId,i||t.roomId,t.sdkAppId,t.useStringRoomId);this._set.add(r);}delete(e){let{room:t,roomId:i}=e;if("rtc"===t.scene)return;let r=this.getKey(t.userId,t.roomId||i,t.sdkAppId,t.useStringRoomId);this._set.delete(r);}getKey(e,t,i,r){return "".concat(i,"_").concat(t,"_").concat(e,"_").concat(r)}isJoined(e){let{userId:t,roomId:i,sdkAppId:r,room:n}=e;return "rtc"!==n.scene&&this._set.has(this.getKey(t,i,r,n.useStringRoomId))}};function ZV(){return HC(this,null,(function*(){let e,t;try{let t=yield OM();e=t&&t.length;}catch(u){}try{let e=yield PM();t=e&&e.length;}catch(u){}let i={microphone:e,camera:t},{isH264EncodeSupported:r,isVp8EncodeSupported:n,isH264DecodeSupported:o,isVp8DecodeSupported:s}=this.checkSystemResult.detail,a=lO.basis(),c={webRTC:a.isWebRTCSupported,getUserMedia:a.isGetUserMediaSupported,webSocket:a.isWebSocketsSupported,screenShare:a.isScreenShareSupported,webAudio:a.isWebAudioSupported,h264Encode:r,h264Decode:o,vp8Encode:n,vp8Decode:s},l={browser:a.browser,os:a.os,trtc:c,devices:i},d={isWebCodecSupported:a.isWebCodecSupported,isMediaSessionSupported:a.isMediaSessionSupported,isWebTransportSupported:a.isWebTransportSupported};GN.uploadEvent({log:"trtcstats-".concat(JSON.stringify(l)),userId:this.userId}),this._log.info("TrtcStats-".concat(JSON.stringify(l))),GN.uploadEvent({log:"trtcadvancedstats-".concat(JSON.stringify(d)),userId:this.userId});}))}var eU=VC(jC()),tU="1",iU="2",rU="3",nU="4",oU="5",sU="6",aU={CLIENT_BANNED:9,CHANNEL_SETUP_RESULT:19,CHANNEL_RECONNECT_RESULT:514,JOIN_ROOM_RESULT:20,PEER_JOIN:4134,PEER_LEAVE:4135,STREAM_ADDED:16,STREAM_REMOVED:18,UPLINK_NETWORK_STATS:22,UPDATE_REMOTE_MUTE_STAT:23,PUBLISH_RESULT:4098,PUBLISH_STATE_CHANGE_RESULT:4112,UNPUBLISH_RESULT:4100,SUBSCRIBE_RESULT:4102,UNSUBSCRIBE_RESULT:4104,SUBSCRIBE_CHANGE_RESULT:4106,MUTE_RESULT:4108,UPDATE_OFFER_RESULT:4128,START_PUBLISH_TENCENT_CDN_RES:1286,STOP_PUBLISH_TENCENT_CDN_RES:1288,START_PUBLISH_GIVEN_CDN_RES:777,STOP_PUBLISH_GIVEN_CDN_RES:779,START_MIX_TRANSCODE_RES:781,STOP_MIX_TRANSCODE_RES:783,START_PUBLISH_CDN_STREAM_RES:8196,UPDATE_PUBLISH_CDN_STREAM_RES:8198,STOP_PUBLISH_CDN_STREAM_RES:8200,USER_LIST_RES:4137,SWITCH_ROLE_RES:4110,UPDATE_CONSTRAINT_CONFIG_RES:772,REBUILD_PEER_CONNECTION_RES:4150,SPC_PUBLISH_RESULT:4146,SPC_SUBSCRIBE_RESULT:4156,ABILITY_STATUS_REPORT_RESULT:4158,SERVER_FIRST_PACKAGE_RECEIVED:5e3,RECEIVE_CUSTOM_MSG:4140},cU=[aU.UPDATE_REMOTE_MUTE_STAT,aU.UPLINK_NETWORK_STATS,aU.USER_LIST_RES,aU.MUTE_RESULT,aU.SERVER_FIRST_PACKAGE_RECEIVED,aU.RECEIVE_CUSTOM_MSG],lU={CLIENT_BANNED:"client-banned",CHANNEL_SETUP_RESULT:"channel-setup-result",CHANNEL_RECONNECT_RESULT:"channel-reconnect-result",JOIN_ROOM_RESULT:"join-room-result",PEER_JOIN:"peer-join",PEER_LEAVE:"peer-leave",STREAM_ADDED:"stream-added",STREAM_REMOVED:"stream-removed",UPLINK_NETWORK_STATS:"uplink-network-stats",UPDATE_REMOTE_MUTE_STAT:"update-remote-mute-stat",PUBLISH_RESULT:"publish-result",PUBLISH_STATE_CHANGE_RESULT:"publish-state-change-result",UNPUBLISH_RESULT:"unpublish-result",SUBSCRIBE_RESULT:"subscribe-result",SUBSCRIBE_CHANGE_RESULT:"subscribe-change-result",UNSUBSCRIBE_RESULT:"unsubscribe-result",UPDATE_OFFER_RESULT:"update-offer-result",START_PUBLISH_TENCENT_CDN_RES:"start-publish-tencent-cdn-res",STOP_PUBLISH_TENCENT_CDN_RES:"stop-publish-tencent-cdn-res",START_PUBLISH_GIVEN_CDN_RES:"start-publish-given-cdn-res",STOP_PUBLISH_GIVEN_CDN_RES:"stop-publish-given-cdn-res",START_MIX_TRANSCODE_RES:"start-mix-transcode-res",STOP_MIX_TRANSCODE_RES:"stop-mix-transcode-res",START_PUBLISH_CDN_STREAM_RES:"start-publish-cdn-stream-res",UPDATE_PUBLISH_CDN_STREAM_RES:"update-publish-cdn-stream-res",STOP_PUBLISH_CDN_STREAM_RES:"stop-publish-cdn-stream-res",USER_LIST_RES:"user-list-res",SWITCH_ROLE_RES:"switch_role_res",MUTE_RESULT:"mute-result",UPDATE_CONSTRAINT_CONFIG_RES:"update-contraint-config-res",REBUILD_PEER_CONNECTION_RES:"rebuild-pc-res",SPC_PUBLISH_RESULT:"spc-publish-result",SPC_SUBSCRIBE_RESULT:"spc-subscribe-result",ABILITY_STATUS_REPORT_RESULT:"ability-status-report",SERVER_FIRST_PACKAGE_RECEIVED:"first-pkg-received",RECEIVE_CUSTOM_MSG:"receive-custom-msg"},dU="publish_change",uU="join",hU="leave",pU="quality_report",mU="mute_uplink",_U="publish",fU="publish_state_change",gU="unpublish",TU="subscribe",EU="unsubscribe",vU="subscribe_change",yU="start_publishing",SU="stop_publishing",IU="start_push_user_cdn",RU="stop_push_user_cdn",AU="start_mcu_mix",CU="stop_mcu_mix",bU="start_publish_cdn_stream",kU="update_publish_cdn_stream",DU="stop_publish_cdn_stream",NU="get_user_list",wU="change_role",OU="update_constraint_config",PU="rebuild_pc",MU="join/v2",LU="publish/v2",xU="subscribe/v3",VU="ability_status_report",UU="reconnect",FU="channel_msg",BU=new Set;var HU=class extends eU.default{constructor(e){var t,i;super(),FC(this,"room"),FC(this,"url"),FC(this,"backupUrl"),FC(this,"race"),FC(this,"destroyed",!1),FC(this,"_socketInUse"),FC(this,"_socket"),FC(this,"_backupSocket"),FC(this,"_signalInfo",{tinyId:void 0,clientIp:"",signalIp:"",relayIp:"",relayInnerIp:"",relayPort:0}),FC(this,"_currentState","DISCONNECTED"),FC(this,"_isReconnecting",!1),FC(this,"_seq",0),FC(this,"_log"),FC(this,"_lastMessageTime",-1),FC(this,"_connnectStartTime",-1),FC(this,"_stopConnectRetry"),FC(this,"bytesSent",0),FC(this,"bytesReceived",0),FC(this,"keepAlive",!1),FC(this,"signalDomainWhenUnifiedProxy"),FC(this,"stopKeepAliveTimeout"),FC(this,"rtt",0),this.room=e.room,this.race=!!Sw(e.race)||e.race,this.signalDomainWhenUnifiedProxy=e.signalDomainWhenUnifiedProxy,((null==(i=null==(t=this.room.scheduleResult)?void 0:t.config)?void 0:i.keepAliveClient)||0)-BU.size>0&&this.room.enableSPC&&(this.keepAlive=!0,BU.add(this)),this.url=e.url,this.backupUrl=e.backupUrl,this._seq=0,this._log=sO.createLogger({id:"ws",userId:this.userId,sdkAppId:this.sdkAppId}),this.onmessage=this.onmessage.bind(this),this.onerror=this.onerror.bind(this),this.onclose=this.onclose.bind(this);}get urlParam(){let e="?sdkAppId=".concat(encodeURIComponent(this.sdkAppId),"&userId=").concat(encodeURIComponent(this.userId),"&userSig=").concat(encodeURIComponent(this.userSig),"&keepAlive=").concat(encodeURIComponent(Number(this.keepAlive)));this.signalDomainWhenUnifiedProxy&&(e+="&signalDomain=".concat(encodeURIComponent(this.signalDomainWhenUnifiedProxy)));let t=new URLSearchParams(location.search).get("clientIp");return t&&(e+="&clientIp=".concat(t)),this.race?"".concat(e,"&race=1"):e}get _urlWithParam(){return "".concat(this.url).concat(this.race?"/v2/ws":"").concat(this.urlParam)}get _backupUrlWithParam(){return "".concat(this.backupUrl).concat(this.race?"/v2/ws":"").concat(this.urlParam)}get isConnected(){return "CONNECTED"===this._currentState}get isConnecting(){return "CONNECTING"===this._currentState}get sdkAppId(){return this.room.sdkAppId}get userId(){return this.room.userId}get userSig(){return this.room.userSig}get isOnline(){return "CONNECTED"===this._currentState&&Date.now()-this._lastMessageTime<12e3}connect(){return HC(this,arguments,(function(){var e=this;let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1e4;return function*(){if(e.isConnected)return Promise.resolve();e._log.info("connect to [".concat(e.url,", ").concat(e.backupUrl,"]").concat(t?" timeout: ".concat(t):""," keepAlive: ").concat(Number(e.keepAlive))),e.emitConnectionStateChanged("CONNECTING"),e._connnectStartTime=Lw();let i=[e.connectWS({url:e._urlWithParam,isMain:!0,timeout:t})];e.race&&e._backupUrlWithParam!==e._urlWithParam&&i.push(e.connectWS({url:e._backupUrlWithParam,isMain:!1,timeout:t})),e._socketInUse=yield Mw(i),e.unbindAndCloseSocket(e._socketInUse===e._socket?Ub.BACKUP:Ub.MAIN),e.emitConnectionStateChanged("CONNECTED");}()}))}connectWS(e){let{url:t,timeout:i,isMain:r}=e,n=new WebSocket(t);this.bindSocket(n),r?this._socket=n:this._backupSocket=n;let o=-1;return new Promise(((e,t)=>{n.onclose=t,n.onerror=t,n.onopen=()=>e(n),i&&(o=setTimeout((()=>{this.unbindAndCloseSocket(r?Ub.MAIN:Ub.BACKUP),t(new tb({code:ZC.SIGNAL_CHANNEL_SETUP_FAILED,message:"ws connect timeout"}));}),i));})).finally((()=>{n.onclose=null,n.onerror=null,n.onopen=null,clearTimeout(o);}))}bindSocket(e){e.addEventListener("close",this.onclose),e.addEventListener("error",this.onerror),e.addEventListener("message",this.onmessage);}unbindSocket(e){e.removeEventListener("close",this.onclose),e.removeEventListener("error",this.onerror),e.removeEventListener("message",this.onmessage);}unbindAndCloseSocket(e){if(e===Ub.MAIN){if(this._socket){this.unbindSocket(this._socket);try{this._socket.close(1e3);}catch(hk){}this._socket=null;}}else if(this._backupSocket){this.unbindSocket(this._backupSocket);try{this._backupSocket.close(1e3);}catch(hk){}this._backupSocket=null;}}onclose(e){if(e.target===this._socketInUse){if(this._log.warn("".concat(e.target===this._socket?"main":"backup"," is closed code:").concat(e.code," ").concat(e.reason)),this.emitConnectionStateChanged("DISCONNECTED"),!e.wasClean||1e3!==e.code){this._socketInUse.onclose=null,this._socketInUse.close(4011);let e=this._socketInUse===this._socket;this.unbindAndCloseSocket(e?Ub.MAIN:Ub.BACKUP),this._socketInUse=null,this.reconnect();}this.room.isJoining&&this.emit(oU,new tb({code:ZC.SIGNAL_CHANNEL_SETUP_FAILED,message:"websocket onclose"}));}}onerror(e){this._log.error("".concat(e.target===this._socket?"main":"backup"," error observed")),this.emitConnectionStateChanged("DISCONNECTED"),e.target===this._socketInUse&&(this.unbindAndCloseSocket(Ub.MAIN),this.unbindAndCloseSocket(Ub.BACKUP),this._socketInUse=null,this.reconnect()),this.room.isJoining&&this.emit(oU,new tb({code:ZC.SIGNAL_CHANNEL_SETUP_FAILED,message:"websocket onerror"}));}onmessage(e){if(!this.isConnected)return;this._lastMessageTime=Date.now(),this.bytesReceived+=Qw(e.data);let t=JSON.parse(e.data),{cmd:i,data:r}=t,n=Object.values(aU),o=Object.keys(aU)[n.indexOf(i)],s=lU[o]||i;switch(cU.includes(i)||(this._log.debug("received ".concat(i," msg: ").concat(e.data)),s&&this._log.info("Received event: [ ".concat(s," ]"))),i){case aU.CHANNEL_SETUP_RESULT:if(0===t.code)this._signalInfo.clientIp=r.clientIp,this._signalInfo.signalIp=r.signalInnerIp,r.svrTime&&function(e){ib=e-(new Date).getTime();let t=new Date;t.setTime(e),sO.info("baseTime from server: ".concat(t," offset: ").concat(ib));}(r.svrTime),this._log.info("ChannelSetup Success"),IO.addSuccessEvent({key:521701,cost:Lw()-this._connnectStartTime}),this._connnectStartTime=-1,this.emit(tU,{signalInfo:this._signalInfo});else {let e=new tb({code:ZC.SIGNAL_CHANNEL_SETUP_FAILED,extraCode:t.code,message:xN({key:zk.SIGNAL_CHANNEL_SETUP_FAILED,data:{errorCode:t.code,errorMsg:t.message}})});this._log.error("".concat(t.code,", ").concat(t.message)),this.close(),IO.addFailedEvent({key:521701,error:e}),this.emit(oU,e);}break;case aU.JOIN_ROOM_RESULT:0===t.code&&(this._signalInfo.relayIp=r.relayOuterIp,this._signalInfo.relayInnerIp=r.relayInnerIp,this._signalInfo.relayPort=r.relayPort,this._signalInfo.tinyId=t.tinyId,this._log.info("signalIp:".concat(this._signalInfo.signalIp," clientIp:").concat(this._signalInfo.clientIp," relayIp: ").concat(this._signalInfo.relayIp))),this.emit(s,{data:t});break;default:this.emit(String(s),{data:t});}}reGetSignalChannelUrl(){return HC(this,null,(function*(){try{if(!this.room.joinParams)return;zN(!0),yield this.room.schedule(this.room.joinParams);let{mainUrl:e,backupUrl:t}=this.room.getSignalChannelUrl();this.url=e,this.backupUrl=t;}catch(db){}}))}reconnect(){return HC(this,null,(function*(){if(!this._isReconnecting){if(!this.room.isJoined&&this.keepAlive)return void this.close();this._isReconnecting=!0;try{this._log.warn("reconnect"),yield this.connect();let{roomId:e,useStringRoomId:t}=this.room,{relayIp:i,relayInnerIp:r,relayPort:n}=this._signalInfo,{data:o}=yield this.sendWaitForResponse({command:UU,data:{roomId:e,useStringRoomId:t,relayInnerIp:r,relayOuterIp:i,relayPort:n},responseCommand:lU.CHANNEL_RECONNECT_RESULT});0===o.code?(this._log.warn("reconnect success"),this.stopReconnection(),IO.addSuccessEvent({key:521702,cost:Lw()-this._connnectStartTime}),this._connnectStartTime=-1,this.room.syncUserList(),this.room.checkConnectionsToReconnect()):(IO.addFailedEvent({key:521702,error:o.code}),this._log.warn("reconnect failed, ".concat(o.code," ").concat(o.message)),this.room.reJoin());}catch(db){this._log.error(db),this.room.reJoin();}}}))}send(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(this.isConnected&&!this.room.isLeft){let i={cmd:e,data:t,userId:this.userId,tinyId:this._signalInfo.tinyId,seq:++this._seq},r=JSON.stringify(i);return this._socketInUse.send(r),this.bytesSent+=Qw(r),i.seq}}sendWaitForResponse(e){let{command:t,data:i,timeout:r=5e3,responseCommand:n,commandDesc:o,enableLog:s=!0,addReceiveTime:a=!1}=e;return new Promise(((e,c)=>{let l=setTimeout((()=>{this.off(n,d);let e=new tb({code:ZC.API_CALL_TIMEOUT,message:xN({key:zk.API_CALL_TIMEOUT,data:{commandDesc:o,command:t}})});s&&this._log.warn(e),c(e);}),r),d=t=>{t.data.seq===u&&(clearTimeout(l),this.off(n,d),a&&(t.data.receiveTime=Date.now()),e(t));};this.on(n,d);let u=this.send(t,i);}))}sendWaitForResponseWithRetry(e){let{commandDesc:t,command:i,retries:r=0,retryTimeout:n=0}=e;return HN({retryFunction:this.sendWaitForResponse,onError:e=>{let{retry:t}=e;this.isOnline?t():(this._log.warn("retry ".concat(i," when connected")),this.once(rU,t));},onRetrying:e=>{this._log.warn("".concat(t||i," timeout observed, retrying [").concat(e,"/").concat(r,"]"));},settings:{retries:r,timeout:n},context:this})(e)}getCurrentState(){return this._currentState}getSignalInfo(){return this._signalInfo}stopReconnection(){this._isReconnecting=!1,this._stopConnectRetry&&this._stopConnectRetry();}close(){this._log.info("closed"),clearTimeout(this.stopKeepAliveTimeout),BU.delete(this),this.stopReconnection(),this._signalInfo={tinyId:void 0,clientIp:"",signalIp:"",relayIp:"",relayInnerIp:"",relayPort:0},this._socketInUse=null,this.bytesSent=0,this.bytesReceived=0,this._stopConnectRetry&&this._stopConnectRetry(),this.unbindAndCloseSocket(Ub.MAIN),this.unbindAndCloseSocket(Ub.BACKUP),this.emitConnectionStateChanged("DISCONNECTED");}destroy(){this.close(),this.destroyed=!0;}stopKeepAliveIn(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:3600;if(this.keepAlive){this._log.info("stopKeepAlive in ".concat(e,"s")),this.stopKeepAliveTimeout=setTimeout((()=>{this.keepAlive=!1,this._log.info("close due to not used ".concat(e,"s")),this.close(),this.off(lU.JOIN_ROOM_RESULT,t);}),1e3*e);let t=e=>{0===e.data.code&&(this._log.info("stopKeepAlive clear timeout"),clearTimeout(this.stopKeepAliveTimeout),this.off(lU.JOIN_ROOM_RESULT,t));};this.on(lU.JOIN_ROOM_RESULT,t);}}emitConnectionStateChanged(e){e!==this._currentState&&(this._log.info("".concat(this._currentState," -> ").concat(e)),this.emit(iU,{prevState:this._currentState,state:e}),this._currentState=e,"CONNECTED"===e?this.emit(rU):"DISCONNECTED"===e&&this.emit(sU));}};UC([VP({settings:{retries:1/0,timeout:2e3},onError(e,t){!this.room.isDestroyed&&!this.destroyed&&t();},onRetrying(e,t){this._log.warn("retrying to connect ".concat(e)),e>=3&&e%3==0&&this.reGetSignalChannelUrl(),t&&(this._stopConnectRetry=t,(this.room.isDestroyed||this.destroyed)&&t());}})],HU.prototype,"connect",1);var jU=VC(jC()),WU=0,GU=!1,JU=new Set,KU=!1,zU=class{constructor(e){FC(this,"userId"),FC(this,"tinyId"),FC(this,"_sdpSemantics"),FC(this,"_isUplink"),FC(this,"_room"),FC(this,"_log"),FC(this,"_signalChannel"),FC(this,"_isErrorObserved",!1),FC(this,"_waitForPeerConnectionConnectedPromise"),FC(this,"_waitForPeerConnectionConnectedPromiseReject",null),FC(this,"_peerConnection",null),FC(this,"_emitter",new jU.default),FC(this,"_currentState","DISCONNECTED"),FC(this,"_isReconnecting",!1),FC(this,"_reconnectionCount",0),FC(this,"_reconnectionTimer",-1),FC(this,"_isFirstConnection",!0),FC(this,"_prevTime",-1),FC(this,"_localAddress"),FC(this,"_remoteAddress"),this.userId=e.userId,this.tinyId=e.tinyId,this._room=e.room,this._sdpSemantics=e.room.sdpSemantics,this._isUplink=e.isUplink,this._log=sO.createLogger({id:"n-mpc",userId:this._room.userId,remoteUserId:this.userId,sdkAppId:this._room.sdkAppId,isLocal:this._isUplink}),this._signalChannel=e.signalChannel;}beforeConnect(){this._prevTime<0&&(this._prevTime=Lw());}afterConnect(){try{this._isFirstConnection?(this._isFirstConnection=!1,IO.addSuccessEvent({key:521705,cost:Math.min(Lw()-this._prevTime,3e4)})):this._isReconnecting&&IO.addSuccessEvent({key:521706,cost:Lw()-this._prevTime}),this._prevTime=-1;}catch(hO){throw this._isFirstConnection?(this._isFirstConnection=!1,IO.addFailedEvent({key:521705,error:hO})):this._isReconnecting&&this._reconnectionCount>=3&&IO.addFailedEvent({key:521706,error:hO}),hO}}initialize(){let e={iceServers:this._room.getIceServers(),iceTransportPolicy:this._room.getIceTransportPolicy(),sdpSemantics:this._sdpSemantics,bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",tcpCandidatePolicy:"disable",IceTransportsType:"nohost"};this._peerConnection=new RTCPeerConnection(e),this._peerConnection.onconnectionstatechange=this.onConnectionStateChange.bind(this);}close(e){this._log.info("close connection"),this._emitter.emit("closed",e),this._isReconnecting&&this.stopReconnection(),this.closePeerConnection(),JU.delete(this);}closePeerConnection(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];this._peerConnection&&(this._log.info("close pc"),this._peerConnection.onconnectionstatechange=null,this._peerConnection.close(),this._peerConnection=null,e&&this.emitConnectionStateChangedEvent("DISCONNECTED")),this._waitForPeerConnectionConnectedPromiseReject&&this._waitForPeerConnectionConnectedPromiseReject(new tb({code:ZC.API_CALL_ABORTED,message:"connection closed"}));}getDTLSTransportState(){if(!this._peerConnection)return ak;let e=null;if(this._isUplink){if(!qO()||0===this._peerConnection.getSenders().length)return ak;e=this._peerConnection.getSenders()[0].transport;}else {if(!zO()||0===this._peerConnection.getReceivers().length)return ak;e=this._peerConnection.getReceivers()[0].transport;}return e?e.state:ak}onConnectionStateChange(e){let t=this._peerConnection.iceConnectionState,i=this.getDTLSTransportState();if(this._log.info("connectionState: ".concat(e.target.connectionState,", ICE: ").concat(t,", DTLS: ").concat(i)),e.target.connectionState===ck.CONNECTING&&this.emitConnectionStateChangedEvent("CONNECTING"),e.target.connectionState===ck.FAILED||e.target.connectionState===ck.CLOSED){let r="connection ".concat(e.target.connectionState,". ICE Transport state: ").concat(t,", DTLS Transport state: ").concat(i),n=new tb({message:r,code:ZC.ICE_TRANSPORT_ERROR});this.emitConnectionStateChangedEvent("DISCONNECTED"),this.startReconnection(),this._isErrorObserved||this._emitter.emit("error",n);}(e.target.connectionState===ck.CONNECTED||e.target.connectionState===ck.COMPLETED)&&(this.logSelectedCandidate(),GN.logSuccessEvent({userId:this._room.userId,eventType:mk.ICE_CONNECTION_STATE}),this.emitConnectionStateChangedEvent("CONNECTED"));}emitConnectionStateChangedEvent(e){return e!==this._currentState&&("CONNECTED"===e?(WU=0,GU=!1,KU=!0,JU.add(this)):JU.delete(this),jN.emit(nO.PEER_CONNECTION_STATE_CHANGED,{room:this._room,prevState:this._currentState,state:e,remoteUserId:this._isUplink?void 0:this.userId}),this._emitter.emit("connection-state-changed",{prevState:this._currentState,state:e}),this._currentState=e,!0)}getPeerConnection(){return this._peerConnection}getRoom(){return this._room}getUserId(){return this.userId}getTinyId(){return this.tinyId}logSelectedCandidate(){return HC(this,null,(function*(){if(!this._peerConnection)return;let e=yield this._peerConnection.getStats();for(let[,t]of e)if(BO(t)){let i=e.get(t.localCandidateId),r=e.get(t.remoteCandidateId);i&&(this._log.info("local candidate: ".concat(i.candidateType," ").concat(i.protocol,":").concat(i.ip||i.address,":").concat(i.port," ").concat(i.networkType||""," ").concat("relay"===i.candidateType?"relayProtocol:".concat(i.relayProtocol):"")),this._localAddress="".concat(i.ip||i.address,":").concat(i.port)),r&&(this._log.info("remote candidate: ".concat(r.candidateType," ").concat(r.protocol,":").concat(r.ip||r.address,":").concat(r.port)),this._remoteAddress="".concat(r.protocol,":").concat(r.ip||r.address));break}}))}getCurrentState(){return this._currentState}waitForPeerConnectionConnected(){return this._waitForPeerConnectionConnectedPromise||(this._waitForPeerConnectionConnectedPromise=new Promise(((e,t)=>{if("CONNECTED"===this._currentState)return e();this._waitForPeerConnectionConnectedPromiseReject=t;let i=t=>{"CONNECTED"===t.state&&(clearTimeout(o),n(),e());},r=e=>{let{room:i}=e;i===this._room&&(clearTimeout(o),n(),t(new tb({code:ZC.API_CALL_ABORTED,message:xN({key:zk.CONNECTION_ABORTED,data:"leave room"})})));},n=()=>{jN.off(nO.LEAVE_SUCCESS,r,this),this._emitter.off("connection-state-changed",i,this);},o=setTimeout((()=>{n();let e=new tb({code:ZC.API_CALL_TIMEOUT,message:"connection timeout"});WU+=1,(e=>WU>2&&!GU&&0===JU.size&&e)(this._signalChannel.isConnected)&&(this._log.warn("firewall restriction"),GU=!0,this._emitter.emit("firewall-restriction")),t(e);}),Ck);jN.on(nO.LEAVE_SUCCESS,r,this),this._emitter.on("connection-state-changed",i,this);})),this._waitForPeerConnectionConnectedPromise=this._waitForPeerConnectionConnectedPromise.finally((()=>{this._waitForPeerConnectionConnectedPromise=null,this._waitForPeerConnectionConnectedPromiseReject=null;}))),this._waitForPeerConnectionConnectedPromise}getReconnectionCount(){return this._reconnectionCount}startReconnection(){this._isReconnecting=!0,this.reconnect();}clearReconnectionTimer(){-1!==this._reconnectionTimer&&(clearTimeout(this._reconnectionTimer),this._reconnectionTimer=-1);}stopReconnection(){this._log.info("stop reconnection"),this._isReconnecting=!1,this._reconnectionCount=0,this.clearReconnectionTimer(),this._signalChannel.off(rU,this.reconnect,this);}beforeReconnect(){if(-1!==this._reconnectionTimer)return this._log.warn("reconnect() is reconnecting, ignore"),-1;if(this._reconnectionCount>=uk()){this._log.warn("SDK has tried reconnect for ".concat(this._reconnectionCount," times, but all failed, please check your network")),this.stopReconnection();let e=new tb({code:this._isUplink?ZC.UPLINK_RECONNECTION_FAILED:ZC.DOWNLINK_RECONNECTION_FAILED,message:xN({key:this._isUplink?zk.UPLINK_RECONNECTION_FAILED:zk.DOWNLINK_RECONNECTION_FAILED})});return this.emitConnectionStateChangedEvent("DISCONNECTED"),this._emitter.emit("error",e),-1}return this._signalChannel.isConnected?(this._reconnectionCount+=1,this._log.warn("reconnect() trying [".concat(this._reconnectionCount,"]")),1):(this._log.warn("reconnect() signal channel is not connected, suspend reconnection until signal is connected"),this._signalChannel.once(rU,this.reconnect,this),-1)}on(e,t,i){this._emitter.on(e,t,i);}off(e,t,i){this._emitter.off(e,t,i);}getIsReconnecting(){return this._isReconnecting}get isH264(){var e,t;return !(null==(t=null==(e=this._peerConnection)?void 0:e.remoteDescription)||!t.sdp.includes("H264"))}setOffer(e){var t;return null==(t=this._peerConnection)?void 0:t.setLocalDescription(e)}setAnswer(e){var t;return null==(t=this._peerConnection)?void 0:t.setRemoteDescription(e)}};UC([cL(521712,!1)],zU.prototype,"setOffer",1),UC([cL(521713,!1)],zU.prototype,"setAnswer",1);var qU=VC(QC()),YU=function(e){return qU.default.parse(e)},QU=function(e){return qU.default.write(e)};function XU(e){return Object.keys(e).filter((t=>e[t]))}var $U=class extends zU{constructor(e){super(MC(PC({},e),{isUplink:!1})),FC(this,"_flag",0),FC(this,"isRobot",!1),FC(this,"role","anchor"),FC(this,"remoteAudioTrack"),FC(this,"remoteVideoTrack"),FC(this,"remoteAuxiliaryTrack"),FC(this,"ssrc",{audio:0,video:0,auxiliary:0}),FC(this,"_isSDPExchanging",!1),this.flag=e.flag,this.isRobot=e.isRobot||!1,this.remoteAudioTrack=e.remoteAudioTrack||new bL(this._room,this),this.remoteVideoTrack=e.remoteVideoTrack||new Sx(this._room,this),this.remoteAuxiliaryTrack=e.remoteAuxiliaryTrack||new Ix(this._room,this);}get videoCodec(){var e,t;let i=null==(t=null==(e=this._peerConnection)?void 0:e.remoteDescription)?void 0:t.sdp;return i?i.includes("H264")?"h264":"vp8":"h264"}get subscribeState(){let e={audio:!1,video:!1,auxiliary:!1,smallVideo:!1};return this.remoteVideoTrack.isSubscribed&&(8&this.remoteVideoTrack.mediaType?e.smallVideo=!0:e.video=!0),this.remoteAudioTrack.isSubscribed&&(e.audio=!0),this.remoteAuxiliaryTrack.isSubscribed&&(e.auxiliary=!0),e}get muteState(){return Bw(this.flag,this.userId)}get flag(){return this._flag}set flag(e){var t,i,r;e!==this._flag&&(this._flag=e,null==(t=this.remoteAudioTrack)||t.onFlagChanged(),null==(i=this.remoteVideoTrack)||i.onFlagChanged(),null==(r=this.remoteAuxiliaryTrack)||r.onFlagChanged());}get hasMainStream(){return this.muteState.hasAudio||this.muteState.hasVideo||this.muteState.hasSmall}get hasAuxStream(){return this.muteState.hasAuxiliary}get isMainStreamSubscribed(){return (this.subscribeState.audio||this.subscribeState.video||this.subscribeState.smallVideo)&&(this.muteState.hasAudio||this.muteState.hasVideo||this.muteState.hasSmall)}get isAuxStreamSubscribed(){return this.subscribeState.auxiliary&&this.muteState.hasAuxiliary}get isSmallStreamSubscribed(){return this.subscribeState.smallVideo&&this.muteState.hasSmall}get isBigStreamSubscribed(){return this.subscribeState.video&&this.muteState.hasVideo}isStreamUnpublished(e){return e===Ub.MAIN?!this.muteState.hasAudio&&!this.muteState.hasVideo:!this.muteState.hasAuxiliary}initialize(){super.initialize(),this.installEvents(),this._peerConnection.ontrack=this.onTrack.bind(this);}close(e){super.close(e),this.emitConnectionStateChangedEvent("DISCONNECTED"),this.remoteAudioTrack.close(),this.remoteVideoTrack.close(),this.remoteAuxiliaryTrack.close(),this.uninstallEvents();}installEvents(){}uninstallEvents(){this._emitter.removeAllListeners();}emitConnectionStateChangedEvent(e){var t,i;let r=this._currentState,n=super.emitConnectionStateChangedEvent(e);return n&&r!==e&&(null==(t=this.remoteVideoTrack)||t.emit("connection-state-changed",{prevState:r,state:e}),null==(i=this.remoteAuxiliaryTrack)||i.emit("connection-state-changed",{prevState:r,state:e})),n}onTrack(e){let t=e.streams[0],{track:i}=e,r=t.id===Qb?Ub.MAIN:Ub.AUXILIARY;this._log.debug("ontrack ".concat(r," ").concat(i.kind));let n=Ub.AUDIO;i.kind===Ub.VIDEO&&(n=r===Ub.MAIN?Ub.VIDEO:Ub.AUXILIARY);let o=this.remoteAudioTrack;n===Ub.VIDEO?o=this.remoteVideoTrack:n===Ub.AUXILIARY&&(o=this.remoteAuxiliaryTrack),o.setInputMediaStreamTrack(i);}addRRTRLine(e){let t=e.split("\r\n"),i=new Map;t.forEach(((e,r)=>{/^a=rtcp-fb:/.test(e)&&t[r+1]&&!/^a=rtcp-fb:/.test(t[r+1])&&i.set(r+1,"".concat(e.match(/^a=rtcp-fb:\d+/)[0]," rrtr"));}));let r=[...i];for(let n=0;n<r.length;n++){let[e,i]=r[n];t.splice(e+n,0,i);}return t.join("\r\n")}addSPSDescription(e){let t=YU(e);return t.media.forEach((e=>{e.type===Ub.VIDEO&&e.fmtp.forEach((e=>{e.config+=";sps-pps-idr-in-keyframe=1";}));})),QU(t)}removeSDESDescription(e){let t=["urn:ietf:params:rtp-hdrext:sdes:mid","urn:ietf:params:rtp-hdrext:sdes:rtp-stream-id","urn:ietf:params:rtp-hdrext:sdes:repaired-rtp-stream-id"],i=YU(e);return i.media.forEach((e=>{!e.ext||(e.ext=e.ext.filter((e=>!t.includes(e.uri))));})),QU(i)}isSubscriptionStateNotChanged(e){return JSON.stringify(e)===JSON.stringify(this.subscribeState)}subscribe(e,t){return HC(this,null,(function*(){var i,r;try{if(((null==(i=this._peerConnection)?void 0:i.connectionState)===ck.NEW||(null==(r=this._peerConnection)?void 0:r.connectionState)===ck.CONNECTING)&&(yield this.waitForPeerConnectionConnected()),this.isSubscriptionStateNotChanged(e))return void(this._peerConnection||(this.initialize(),yield this.connect(e)));if(this._log.info("subscribe ".concat(t," ").concat(JSON.stringify(e))),this._peerConnection||this._isSDPExchanging){let t="subscribe_change";Object.values(e).find((e=>!0===e))||(t="unsubscribe"),yield this.sendSubscription(t,e);}else this.initialize(),yield this.connect(e);}catch(hb){throw this._room.isJoined&&this.isStreamUnpublished(t)?(this._log.warn("".concat(hb.message," ").concat(JSON.stringify(this.muteState))),new tb({code:ZC.REMOTE_STREAM_NOT_EXIST,message:"remote user ".concat(this.userId," unpublished stream")})):hb}}))}unsubscribe(e){return HC(this,arguments,(function(e){var t=this;let{remoteTracks:i,streamType:r}=e;return function*(){if("CONNECTED"===t._currentState&&("main"===r&&!t.isMainStreamSubscribed||"auxiliary"===r&&!t.isAuxStreamSubscribed))return void t._log.info("".concat(r," stream already unsubscribed"));let e=PC({},t.subscribeState);i.forEach((t=>{switch(t.mediaType){case 1:e.audio=!1;break;case 4:e.video=!1;break;case 8:e.smallVideo=!1;break;case 2:e.auxiliary=!1;}}));let n="subscribe_change";Object.values(e).find((e=>!0===e))||(n="unsubscribe"),t._log.info("".concat("unsubscribe"===n?n:"subscribe"," ").concat(r," [").concat(XU(e),"]")),yield t.sendSubscription(n,e),"unsubscribe"===n&&(t.closePeerConnection(),t.emitConnectionStateChangedEvent("DISCONNECTED"));}()}))}sendSubscription(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this.subscribeState,i={srcTinyId:this.tinyId,srcUserId:this.userId},r=EU,n=lU.UNSUBSCRIBE_RESULT;return "subscribe_change"===e&&(i={audio:t.audio,bigVideo:t.video,auxVideo:t.auxiliary,smallVideo:t.smallVideo,srcTinyId:this.tinyId},r=vU,n=lU.SUBSCRIBE_CHANGE_RESULT),this._signalChannel.sendWaitForResponse({command:r,data:i,responseCommand:n,timeout:1e4}).then((t=>{let{data:i}=t;if(0!==i.code){let t=new tb({code:i.code,message:xN({key:zk.ERROR_MESSAGE,data:{type:e,message:i.message}})});throw this._log.error(t),t}}))}connect(){return HC(this,arguments,(function(){var e=this;let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.subscribeState;return function*(){try{yield e.exchangeSDP(t),yield e.waitForPeerConnectionConnected();}catch(hk){throw e.closePeerConnection(!0),hk}}()}))}exchangeSDP(e){return HC(this,null,(function*(){try{this._isSDPExchanging=!0,yield this.createOffer(),this._log.info("createOffer success, sending offer");let{type:t,sdp:i}=this._peerConnection.localDescription,r={type:t,sdp:i,srcUserId:this.userId,srcTinyId:this.tinyId,audio:e.audio,bigVideo:e.video,auxVideo:e.auxiliary,smallVideo:e.smallVideo},n=yield this._signalChannel.sendWaitForResponse({command:TU,commandDesc:"exchange sdp",data:r,responseCommand:lU.SUBSCRIBE_RESULT,timeout:gk});if(!this._peerConnection){let e=new tb({code:ZC.INVALID_OPERATION,message:xN({key:zk.CONNECTION_CLOSED})});throw this._log.warn(e),e}yield this.onSubscribeResult(n),this._isSDPExchanging=!1;}catch(hk){throw this._isSDPExchanging=!1,hk}}))}createOffer(){return HC(this,null,(function*(){let e={voiceActivityDetection:!1};QO()&&this._sdpSemantics===Tk?(this._peerConnection.addTransceiver(Ub.AUDIO,{direction:Fb.RECVONLY}),this._peerConnection.addTransceiver(Ub.VIDEO,{direction:Fb.RECVONLY}),this._peerConnection.addTransceiver(Ub.VIDEO,{direction:Fb.RECVONLY})):(e.offerToReceiveAudio=!0,e.offerToReceiveVideo=!0);let t=yield this._peerConnection.createOffer(e);if(t.sdp){let{isH264DecodeSupported:e}=yield MO();e||(this._log.warn("remove h264 desc from sdp"),t.sdp=function(e){let t=YU(e);return t.media.forEach((e=>{var t,i;if(e.type===Ub.VIDEO){let r=new Set;e.rtp.forEach((e=>{let{payload:t,codec:i}=e;return "H264"===i&&r.add(t)})),e.fmtp.forEach((e=>{let{payload:t,config:i}=e,n=i.match(/apt=(\d+)/);n&&n[1]&&r.has(Number(n[1]))&&r.add(t);}));let n=e=>{let{payload:t}=e;return !r.has(t)};e.rtp=e.rtp.filter(n),e.rtcpFb=null==(t=e.rtcpFb)?void 0:t.filter(n),e.fmtp=e.fmtp.filter(n),e.payloads=null==(i=e.payloads)?void 0:i.split(" ").filter((e=>!r.has(Number(e)))).join(" ");}})),QU(t)}(t.sdp)),t.sdp=this.addRRTRLine(t.sdp),t.sdp=this.addSPSDescription(t.sdp),t.sdp=function(e){let t=YU(e);return t.media.forEach((e=>{e.type===Ub.AUDIO&&e.fmtp.forEach((e=>{e.config+=";sprop-stereo=1;stereo=1";}));})),QU(t)}(t.sdp),this._sdpSemantics===Tk&&(t.sdp=this.removeSDESDescription(t.sdp));}yield this.setOffer(t);}))}onSubscribeResult(e){return HC(this,null,(function*(){let{code:t,message:i=""}=e&&e.data||{},{type:r,sdp:n}=e&&e.data&&e.data.data||{};if(t===vk)throw new tb({code:ZC.NOT_SUPPORTED_H264,message:xN({key:zk.NOT_SUPPORTED_H264DECODE})});try{if(0!==t)throw new tb({code:t,message:xN({key:zk.EXCHANGE_SDP_FAILED,data:{errMsg:i}})});this._log.debug("accept remote answer: ".concat(n)),yield this.setAnswer({type:r,sdp:n}),this.updateSSRC(n);}catch(o){throw this._log.error(o),o}}))}updateSSRC(e){try{YU(e).media.forEach((e=>{if(e.ssrcs)if(e.type===Ub.AUDIO){let t=e.ssrcs.find((e=>{var t;return null==(t=e.value)?void 0:t.includes(Qb)}));t&&(this.ssrc.audio=Number(t.id));}else {let t=e.ssrcs.find((e=>{var t;return null==(t=e.value)?void 0:t.includes(Qb)})),i=e.ssrcs.find((e=>{var t;return null==(t=e.value)?void 0:t.includes(Xb)}));t&&(this.ssrc.video=Number(t.id)),i&&(this.ssrc.auxiliary=Number(i.id));}}));}catch(hk){}}getMainStreamVideoTrackId(){return this.remoteVideoTrack&&this.remoteVideoTrack.mediaTrack?this.remoteVideoTrack.mediaTrack.id:""}getAuxStreamVideoTrackId(){return this.remoteAuxiliaryTrack&&this.remoteAuxiliaryTrack.mediaTrack?this.remoteAuxiliaryTrack.mediaTrack.id:""}reconnect(){return HC(this,null,(function*(){if(!(BC($U.prototype,this,"beforeReconnect").call(this)<0))try{this.closePeerConnection(),this.initialize(),yield this.connect(),this.stopReconnection(),this._log.warn("reconnect() success");}catch(hk){let t=Ew(this._reconnectionCount);this._log.warn("reconnect() timeout, try again after ".concat(t/1e3,"s")),this._reconnectionTimer=setTimeout((()=>{this.clearReconnectionTimer(),this.reconnect();}),t);}}))}getIsReconnecting(){return this._isReconnecting}clearReconnectionTimer(){-1!==this._reconnectionTimer&&(clearTimeout(this._reconnectionTimer),this._reconnectionTimer=-1);}getCurrentState(){return this._currentState}setDelay(e){let{audioDelay:t,videoDelay:i}=e;this.remoteAudioTrack.stat.end2EndDelay=t,this.remoteVideoTrack.stat.end2EndDelay=i;}get audioReceiver(){var e;return (null==(e=this._peerConnection)?void 0:e.getReceivers()[0])||null}},ZU=$U;UC([ZM((e=>function(){for(var t=arguments.length,i=new Array(t),r=0;r<t;r++)i[r]=arguments[r];return new Promise(((t,r)=>{let n=e=>{this._emitter.off("closed",n),r(new tb({code:ZC.API_CALL_ABORTED,message:xN({key:zk.CONNECTION_ABORTED,data:e})}));};this._emitter.on("closed",n),e.apply(this,i).then(t,r).finally((()=>{this._emitter.off("closed",n);}));}))}))],ZU.prototype,"subscribe",1),UC([cL(521717,!1)],ZU.prototype,"unsubscribe",1),UC([$M(zU.prototype.afterConnect),XM(zU.prototype.beforeConnect)],ZU.prototype,"connect",1);var eF=ZU,tF={voiceActivityDetection:!1},iF=class extends zU{constructor(e){super(MC(PC({},e),{isUplink:!0})),FC(this,"localMainAudioTrack",null),FC(this,"localMainVideoTrack",null),FC(this,"localAuxAudioTrack",null),FC(this,"localAuxVideoTrack",null),FC(this,"ssrc",{audio:0,video:0,small:0,auxiliary:0}),FC(this,"_isPublishingAux",!1),FC(this,"_publishingLocalAudioTrack"),FC(this,"_publishingLocalVideoTrack"),FC(this,"_mediaSettings",{videoCodec:"",videoWidth:0,videoHeight:0,videoBps:0,videoFps:0,audioCodec:"opus",audioFs:0,audioChannel:0,audioBps:0,smallVideoWidth:0,smallVideoHeight:0,smallVideoFps:0,smallVideoBps:0,auxVideoWidth:0,auxVideoHeight:0,auxVideoFps:0,auxVideoBps:0}),FC(this,"flag",0);}get videoCodec(){return this._mediaSettings.videoCodec.toLowerCase()||"h264"}get isMainStreamPublished(){return !(!this.localMainAudioTrack&&!this.localMainVideoTrack)}get isAuxStreamPublished(){return !(!this.localAuxVideoTrack&&!this.localAuxAudioTrack)}get publishState(){var e,t,i,r;let n={audio:!1,bigVideo:!1,smallVideo:!1,auxVideo:!1};if(this._peerConnection){let o=this._peerConnection.getSenders();o&&(YO()?(n.audio=!(null==(e=o[0])||!e.track),n.bigVideo=!(null==(t=o[1])||!t.track),n.smallVideo=!(null==(i=o[2])||!i.track),n.auxVideo=!(null==(r=o[3])||!r.track)):o.forEach((e=>{e.track&&(e.track.kind===Ub.AUDIO?n.audio=!0:(n.bigVideo=!0,this._room.videoManager.hasSmall&&(n.smallVideo=!0)));})));}return n}initialize(){super.initialize(),this.installEvents();}reset(){this._isReconnecting&&this.stopReconnection(),this.closePeerConnection(),this.uninstallEvents();}close(e){super.close(e),this.reset(),this.emitConnectionStateChangedEvent("DISCONNECTED");}installEvents(){this._emitter.listeners("connection-state-changed").includes(this.handleConnectionStateChange)||this._emitter.on("connection-state-changed",this.handleConnectionStateChange,this);}uninstallEvents(){this._emitter.off("connection-state-changed",this.handleConnectionStateChange,this);}emitConnectionStateChangedEvent(e,t){var i,r,n;let o=this._currentState,s=super.emitConnectionStateChangedEvent(e);return s&&o!==e&&(t?t.emit("connection-state-changed",{prevState:o,state:e}):(null==(i=this.localMainVideoTrack)||i.emit("connection-state-changed",{prevState:o,state:e}),null==(r=this.localAuxVideoTrack)||r.emit("connection-state-changed",{prevState:o,state:e}),null==(n=this._publishingLocalVideoTrack)||n.emit("connection-state-changed",{prevState:o,state:e}))),s}publish(e){return HC(this,arguments,(function(e){var t=this;let{localAudioTrack:i,localVideoTrack:r,isAuxiliary:n}=e;return function*(){let e;t._peerConnection||t.initialize(),i&&(t._publishingLocalAudioTrack=i),r&&(t._publishingLocalVideoTrack=r),t._isPublishingAux=n,r&&!n&&r.small&&(e=t._room.videoManager.smallTrack),t.sendMediaSettings(),QO()?yield t.publishByTransceiver({localAudioTrack:i,localVideoTrack:r,smallTrack:e,isAuxiliary:n}):yield t.publishByAddTrack({localAudioTrack:i,localVideoTrack:r,smallTrack:e}),t._publishingLocalAudioTrack=null,t._publishingLocalVideoTrack=null,t._isPublishingAux=!1,n?(r&&(t.localAuxVideoTrack=r),i&&(t.localAuxAudioTrack=i)):(r&&(t.localMainVideoTrack=r),i&&(t.localMainAudioTrack=i)),t.installTrackMuteEvents(i,r),t.sendMutedFlag();}()}))}publishByTransceiver(e){return HC(this,arguments,(function(e){var t=this;let{localAudioTrack:i,localVideoTrack:r,smallTrack:n,isAuxiliary:o}=e;return function*(){t._log.info("publish by transceiver");let e=new MediaStream,s=null==r?void 0:r.outMediaTrack,a=null==i?void 0:i.outMediaTrack;a&&e.addTrack(a),s&&e.addTrack(s);let c=t._peerConnection.getTransceivers();if(0===c.length)t._peerConnection.addTransceiver(a||Ub.AUDIO,{direction:Fb.SENDONLY,streams:[e]}),t._peerConnection.addTransceiver(o?Ub.VIDEO:s||Ub.VIDEO,{direction:Fb.SENDONLY,streams:[e]}),t._peerConnection.addTransceiver(n||Ub.VIDEO,{direction:Fb.SENDONLY,streams:[e]}),t._peerConnection.addTransceiver(o&&s||Ub.VIDEO,{direction:Fb.SENDONLY,streams:[e]}),yield t.connect();else {let e=[];if(a&&(c[0].sender.track||e.push(0),yield c[0].sender.replaceTrack(a),yield t.setBandwidth({bandwidth:(null==i?void 0:i.profile.bitrate)||40,type:Ub.AUDIO})),s){let i=o?3:1;yield c[i].sender.replaceTrack(s),yield t.setBandwidth({bandwidth:r.profile.bitrate,type:Ub.VIDEO,videoType:o?Ub.AUXILIARY:Ub.BIG}),e.push(i),n&&(yield c[2].sender.replaceTrack(n),yield t.setBandwidth({bandwidth:r.small.bitrate,type:Ub.VIDEO,videoType:Ub.SMALL}),e.push(2));}yield t.setTransceiverDirection(Fb.SENDONLY,e),yield t.doPublishChange(),null==r||r.emit("connection-state-changed",{prevState:"DISCONNECTED",state:"CONNECTING"}),null==r||r.emit("connection-state-changed",{prevState:"CONNECTING",state:"CONNECTED"});}}()}))}publishByAddTrack(e){return HC(this,arguments,(function(e){var t=this;let{localAudioTrack:i,localVideoTrack:r,smallTrack:n}=e;return function*(){t._log.info("publish by addtrack");let e=null==r?void 0:r.outMediaTrack,o=null==i?void 0:i.outMediaTrack;if(t._peerConnection&&"new"!==t._peerConnection.connectionState)return i&&o&&(yield t.addTrack(i)),void(e&&(yield t.addTrack(r)));let s=new MediaStream;if(o&&s.addTrack(o),e&&s.addTrack(e),o&&t._peerConnection.addTrack(o,s),e&&(t._peerConnection.addTrack(e,s),n)){let e=new MediaStream;e.addTrack(n),t._peerConnection.addTrack(n,e);}yield t.connect();}()}))}enableSmall(e){return HC(this,null,(function*(){let t=this._peerConnection.getTransceivers();e?this._room.videoManager.smallTrack&&(yield t[2].sender.replaceTrack(this._room.videoManager.smallTrack),yield this.setTransceiverDirection(Fb.SENDONLY,[2])):(yield t[2].sender.replaceTrack(null),yield this.setTransceiverDirection(Fb.INACTIVE,[2])),this.updateMediaSettings(),yield this.doPublishChange();}))}installTrackMuteEvents(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];t.forEach((e=>{e&&(null==e||e.on("mute",this.sendMutedFlag,this),null==e||e.on("unmute",this.sendMutedFlag,this));}));}uninstallTrackMuteEvents(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];t.forEach((e=>{e&&(null==e||e.off("mute",this.sendMutedFlag,this),null==e||e.off("unmute",this.sendMutedFlag,this));}));}unpublish(e){return HC(this,arguments,(function(e){var t=this;let{localAudioTrack:i,localVideoTrack:r}=e;return function*(){if(!YO())return i&&i.outMediaTrack&&!r&&t.localMainVideoTrack?(yield t.removeTrack(i),void(t.localMainAudioTrack=null)):r&&r.outMediaTrack&&!i&&t.localMainAudioTrack?(yield t.removeTrack(r),void(t.localMainVideoTrack=null)):(yield t.doUnpublish(),t.uninstallTrackMuteEvents(i,r),void t.emitConnectionStateChangedEvent("DISCONNECTED",r));let e=r&&r===t.localAuxVideoTrack,n=null==r?void 0:r.outMediaTrack,o=t._peerConnection.getSenders(),s=[];i&&(e?t.localAuxAudioTrack=null:t.localMainAudioTrack=null,!t.localAuxAudioTrack&&!t.localMainAudioTrack&&(yield o[0].replaceTrack(null),s.push(0))),n&&(e?(yield o[3].replaceTrack(null),t.localAuxVideoTrack=null,t._mediaSettings=MC(PC({},t._mediaSettings),{auxVideoBps:0,auxVideoFps:0,auxVideoWidth:0,auxVideoHeight:0}),s.push(3)):(yield o[1].replaceTrack(null),yield o[2].replaceTrack(null),t.localMainVideoTrack=null,t._mediaSettings=MC(PC({},t._mediaSettings),{videoWidth:0,videoHeight:0,videoBps:0,videoFps:0,audioFs:0,audioChannel:0,audioBps:0,smallVideoWidth:0,smallVideoHeight:0,smallVideoFps:0,smallVideoBps:0}),s.push(1,2))),t.isMainStreamPublished||t.isAuxStreamPublished?(yield t.setTransceiverDirection(Fb.INACTIVE,s),yield t.doPublishChange(!1)):yield t.doUnpublish(),t.uninstallTrackMuteEvents(i,r),null==r||r.emit("connection-state-changed",{prevState:t._currentState,state:"DISCONNECTED"});}()}))}doPublishChange(){let e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];return HC(this,null,(function*(){let t={state:this.publishState,constraintConfig:this._mediaSettings},i=yield this._signalChannel.sendWaitForResponse({command:fU,data:t,responseCommand:lU.PUBLISH_STATE_CHANGE_RESULT,enableLog:e});this.checkPublishResultCode(i.data.code,i.data.message);}))}doUnpublish(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];return this._signalChannel.sendWaitForResponse({command:gU,commandDesc:"unpublish",responseCommand:lU.UNPUBLISH_RESULT,enableLog:e}).catch((e=>{if(e.getCode()===ZC.API_CALL_TIMEOUT)return Promise.resolve();throw e}))}updateMediaSettings(){let{detail:{isH264EncodeSupported:e,isVp8EncodeSupported:t}}=this._room.checkSystemResult;e?this._mediaSettings.videoCodec="H264":t&&(this._mediaSettings.videoCodec="VP8");let i=this._publishingLocalAudioTrack||this.localMainAudioTrack||this.localAuxAudioTrack,{localMainVideoTrack:r,localAuxVideoTrack:n}=this;if(this._publishingLocalVideoTrack&&(this._isPublishingAux?n=this._publishingLocalVideoTrack:r=this._publishingLocalVideoTrack),rP){if(i&&i.outMediaTrack){let e=i.outMediaTrack.getSettings();this._mediaSettings.audioChannel=e.channelCount||1,this._mediaSettings.audioBps=1e3*i.profile.bitrate,this._mediaSettings.audioFs=e.sampleRate||0;}if(r&&r.outMediaTrack){let e=r.outMediaTrack.getSettings();this._mediaSettings.videoWidth=e.width||0,this._mediaSettings.videoHeight=e.height||0,this._mediaSettings.videoFps=e.frameRate||0,this._mediaSettings.videoBps=1e3*r.profile.bitrate,r.small&&(this._mediaSettings.smallVideoWidth=r.small.width,this._mediaSettings.smallVideoHeight=r.small.height,this._mediaSettings.smallVideoFps=r.small.frameRate,this._mediaSettings.smallVideoBps=1e3*r.small.bitrate);}if(n&&n.outMediaTrack){let e=n.outMediaTrack.getSettings();this._mediaSettings.auxVideoWidth=e.width||0,this._mediaSettings.auxVideoHeight=e.height||0,this._mediaSettings.auxVideoFps=e.frameRate||0,this._mediaSettings.auxVideoBps=1e3*n.profile.bitrate;}}else i&&i.outMediaTrack&&(this._mediaSettings.audioChannel=i.profile.channelCount,this._mediaSettings.audioBps=1e3*i.profile.bitrate,this._mediaSettings.audioFs=i.profile.sampleRate),r&&r.outMediaTrack&&(this._mediaSettings.videoWidth=r.profile.width,this._mediaSettings.videoHeight=r.profile.height,this._mediaSettings.videoFps=r.profile.frameRate,this._mediaSettings.videoBps=1e3*r.profile.bitrate);this._log.info("updateMediaSettings: ".concat(JSON.stringify(this._mediaSettings)));}sendMediaSettings(){this.updateMediaSettings(),this._signalChannel.sendWaitForResponse({command:OU,data:this._mediaSettings,responseCommand:lU.UPDATE_CONSTRAINT_CONFIG_RES}).then((e=>{0!==e.data.code&&this._log.warn(e.data.message);})).catch((()=>{}));}addTrack(e){return HC(this,null,(function*(){if(!this._peerConnection)return;let t=e===this.localAuxAudioTrack||e===this.localAuxVideoTrack;this._log.info("is adding ".concat(e.kind," track to current published local ").concat(t?Ub.AUXILIARY:Ub.MAIN," stream")),QO()?yield this.addTrackByTransceiver(e,t):yield this.addTrackBySender(e);}))}addTrackByTransceiver(e,t){return HC(this,null,(function*(){var i;if(!e.mediaTrack)return;let r=this._peerConnection.getTransceivers();if(e.kind===Ub.AUDIO)yield r[0].sender.replaceTrack(e.outMediaTrack);else {let n=t?3:1;yield r[n].sender.replaceTrack(e.outMediaTrack),1===n&&(null==(i=this.localMainVideoTrack)?void 0:i.small)&&(yield r[2].sender.replaceTrack(this._room.videoManager.smallTrack)),r[n].direction===Fb.INACTIVE&&(yield this.setTransceiverDirection(Fb.SENDONLY,[n]));}this.updateMediaSettings(),yield this.doPublishChange();}))}addTrackBySender(e){return HC(this,null,(function*(){if(!e.outMediaTrack)return;let t=e.outMediaTrack;YO()&&this._peerConnection.getTransceivers().findIndex((e=>"stopped"===e.direction))>=0&&(this._log.warn("transceiver is stopping, negotiate sdp first"),yield this.updateOffer("remove",t));let i=this._peerConnection.getSenders().find((e=>e.track&&e.track.kind===t.kind));if(i&&i.track){this._log.warn("sender already exists, remove sender first");let e=i.track;this.removeSender(i),yield this.updateOffer("remove",e);}if(t&&this._peerConnection.addTrack(t,new MediaStream([t])),t.kind===Ub.VIDEO&&e instanceof _L&&e.small){let e=new MediaStream,{smallTrack:t}=this._room.videoManager;e.addTrack(t),this._peerConnection.addTrack(t,e);}yield this.updateOffer("add",t);}))}isNeedToResetOfferOrder(){if(this._sdpSemantics===Ek||!this._peerConnection||!this._peerConnection.localDescription)return !1;let{sdp:e}=this._peerConnection.localDescription,t=YU(e);for(let i=0;i<t.media.length;i++)if(0===Number(t.media[i].mid)&&t.media[i].type===Ub.VIDEO)return !0;return !1}removeSender(e){let t=null;YO()&&(t=this._peerConnection.getTransceivers().find((t=>t.sender&&t.sender.track===e.track))),this._peerConnection.removeTrack(e),t&&yw(t.stop)&&(this._log.info("stop transceiver"),t.stop());}removeTrack(e){return HC(this,null,(function*(){if(!this._peerConnection)return;let t=e===this.localAuxAudioTrack||e===this.localAuxVideoTrack;this._log.info("is removing ".concat(e.kind," track from current published local ").concat(t?Ub.AUXILIARY:Ub.MAIN," stream")),QO()?yield this.removeTrackByTransceiver(e,t):yield this.removeTrackBySender(e);}))}removeTrackByTransceiver(e,t){return HC(this,null,(function*(){if(!e.outMediaTrack)return;let i=this._peerConnection.getTransceivers();if(e.kind===Ub.AUDIO)yield i[0].sender.replaceTrack(null);else {let r=t?3:1;yield i[r].sender.replaceTrack(null),1===r&&e.small&&(yield i[2].sender.replaceTrack(null)),yield this.setTransceiverDirection(Fb.INACTIVE,[r]);}this.updateMediaSettings(),yield this.doPublishChange();}))}setTransceiverDirection(e,t){return HC(this,null,(function*(){if(!uD)return;let i=!1,r=!1;this._log.info("setting transceiver ".concat(t.join(",")," direction to ").concat(e));let n=this._peerConnection.getTransceivers();if(t.forEach((t=>{n[t].direction!==e&&(n[t].direction=e,i=!0);})),i){this._log.info("updating offer");let e=yield this._peerConnection.createOffer();yield this.setOffer(e);}let o=-1,s=this._peerConnection.remoteDescription.sdp.split("\r\n").map((i=>{if(i.match(new RegExp("a=(".concat(Fb.INACTIVE,"|").concat(Fb.RECVONLY,"|").concat(Fb.SENDONLY,")")))&&o++,t.includes(o)){if(e===Fb.INACTIVE&&i.includes("a=".concat(Fb.RECVONLY)))return r=!0,"a=".concat(e);if(e===Fb.SENDONLY&&i.includes("a=".concat(Fb.INACTIVE)))return r=!0,"a=".concat(Fb.RECVONLY)}return i})).join("\r\n");r&&(this._log.info("updating answer"),yield this.setAnswer({type:"answer",sdp:s}));}))}removeTrackBySender(e){return HC(this,null,(function*(){if(!e.outMediaTrack)return;if(e.kind===Ub.VIDEO&&this.isNeedToResetOfferOrder()&&this.localMainAudioTrack)return this.reset(),this.initialize(),void(yield this.publish({localAudioTrack:this.localMainAudioTrack,isAuxiliary:!1}));let t=this._peerConnection.getSenders().find((t=>t.track===e.outMediaTrack));t&&(this.removeSender(t),e.kind===Ub.VIDEO&&e.small&&this._peerConnection.getSenders().forEach((e=>{e.track&&e.track.kind===Ub.VIDEO&&this.removeSender(e);}))),yield this.updateOffer("remove",e.outMediaTrack);}))}replaceTrack(e){return HC(this,null,(function*(){var t;let i,r=null==(t=this._peerConnection)?void 0:t.getSenders();if(!r||0===r.length||!e.mediaTrack)return !1;if(i=QO()?e.kind===Ub.AUDIO?r[0]:r[1]:r.find((t=>t.track&&t.track.kind===e.kind)),!i)return !1;let n=e===this.localAuxAudioTrack||e===this.localAuxVideoTrack;return this._log.info("is replacing ".concat(e.kind," track on ").concat(n?Ub.AUXILIARY:Ub.MAIN," stream")),e.kind===Ub.AUDIO?yield i.replaceTrack(e.outMediaTrack):e.kind===Ub.VIDEO&&(n?r[3]&&(yield r[3].replaceTrack(e.outMediaTrack)):yield i.replaceTrack(e.outMediaTrack)),!0}))}updateOffer(e,t){return HC(this,null,(function*(){try{let i=yield this._peerConnection.createOffer(tF);uD&&i.sdp&&(i.sdp=this.setSDPDirection(i.sdp,"sendrecv")),yield this.setOffer(i);let r=this.updateMediaSettings(),n={action:e,trackId:t.id,kind:t.kind===Ub.VIDEO?"bigVideo":t.kind,type:"offer",sdp:this._peerConnection.localDescription.sdp,constraintConfig:r,state:this.publishState};this._log.info("createOffer success, sending updated offer to remote server"),this._log.debug("updatedOffer: ".concat(n.sdp));let o=yield this._signalChannel.sendWaitForResponse({command:dU,data:n,responseCommand:lU.UPDATE_OFFER_RESULT,timeout:fk,commandDesc:"update offer"}),{code:s,message:a}=o.data;0!==s&&this.checkPublishResultCode(s,a),yield this.acceptAnswer(o.data.data),i.sdp&&this.updateSSRC(i.sdp);}catch(ub){throw this._log.error(ub),ub}}))}setBandwidth(e){return HC(this,arguments,(function(e){var t=this;let{bandwidth:i,type:r,videoType:n,sdp:o}=e;return function*(){if(!tP())return o?r===Ub.VIDEO?t.updateVideoBandwidthRestriction(o,i,n):t.updateAudioBandwidthRestriction(o,i):void 0;let e,s=t._peerConnection.getSenders();if(QO()){let t=0;r===Ub.VIDEO&&(t=n===Ub.SMALL?2:n===Ub.AUXILIARY?3:1),e=s[t];}else e=s.find((e=>e.track&&e.track.kind===r));if(e){let s=e.getParameters();(!s.encodings||0===s.encodings.length)&&(s.encodings=[{}]),s.encodings[0].maxBitrate=1e3*i;try{return yield e.setParameters(s),t._log.info("".concat(n||"").concat(r," bandwidth ").concat(i," kbps")),o}catch(a){if(t._log.info("failed to set bandwidth by setting maxBitrate: ".concat(a)),o)return r===Ub.VIDEO?t.updateVideoBandwidthRestriction(o,i,n):t.updateAudioBandwidthRestriction(o,i)}}return o}()}))}updateVideoBandwidthRestriction(e,t,i){let r="AS";uD&&(r="TIAS",t*=1e3);let n=0,o=-1;return i===Ub.SMALL?n=1:i===Ub.AUXILIARY&&(n=2),e=e.replace(/m=video (.*)\r\nc=IN (.*)\r\n/g,(e=>(o+=1,o===n?"".concat(e,"b=").concat(r,":").concat(t,"\r\n"):e)))}updateAudioBandwidthRestriction(e,t){let i="AS";return uD&&(i="TIAS",t*=1e3),e=e.replace(/m=audio (.*)\r\nc=IN (.*)\r\n/,"m=audio $1\r\nc=IN $2\r\nb=".concat(i,":").concat(t,"\r\n"))}removeBandwidthRestriction(e){return e.replace(/b=AS:.*\r\n/,"").replace(/b=TIAS:.*\r\n/,"")}removeVideoOrientation(e){return e.replace(/urn:3gpp:video-orientation/,"")}connect(){return HC(this,null,(function*(){try{yield this.exchangeSDP(),yield this.waitForPeerConnectionConnected();}catch(db){throw this.closePeerConnection(!0),this.uninstallEvents(),db}}))}exchangeSDP(){return HC(this,null,(function*(){try{yield this.createOffer(),this._log.info("createOffer success, sending offer to remote server"),yield this.doExchangeSDP();}catch(db){throw db}}))}createOffer(){return HC(this,null,(function*(){try{let e=yield this._peerConnection.createOffer(tF);yield this.setOffer(e),e.sdp&&this.updateSSRC(e.sdp);}catch(db){throw db}}))}doExchangeSDP(){let e={command:_U,responseCommand:lU.PUBLISH_RESULT,data:{type:this._peerConnection.localDescription.type,sdp:this.removeVideoOrientation(this._peerConnection.localDescription.sdp),screen:this.localMainVideoTrack instanceof EL||this.localAuxVideoTrack instanceof EL,state:this.publishState,constraintConfig:this._mediaSettings},enableLog:!1};return this._log.debug("sending sdp offer: ".concat(e.data.sdp)),this._signalChannel.sendWaitForResponse(e).then((e=>{let{code:t,message:i,data:r}=e.data;return 0===t?this.acceptAnswer(r):this.checkPublishResultCode(t,i)}))}setSDPDirection(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"all",r=YU(e);return r.media.forEach((e=>{("all"===i||e.type===i)&&(e.direction=t);})),QU(r)}acceptAnswer(e){return HC(this,null,(function*(){var t,i,r,n,o;try{let s;if(this._publishingLocalAudioTrack||this._publishingLocalVideoTrack||this.isMainStreamPublished){let e=(null==(t=this._publishingLocalVideoTrack)?void 0:t.profile.bitrate)||(null==(i=this.localMainVideoTrack)?void 0:i.profile.bitrate),o=(null==(r=this._publishingLocalAudioTrack)?void 0:r.profile.bitrate)||(null==(n=this.localMainAudioTrack)?void 0:n.profile.bitrate);if(e){let t=this._isPublishingAux?Ub.AUXILIARY:Ub.BIG;s=yield this.setBandwidth({bandwidth:e,type:Ub.VIDEO,sdp:s,videoType:t});}o&&(s=yield this.setBandwidth({bandwidth:o,type:Ub.AUDIO,sdp:s}));}if(s=this.removeVideoOrientation(e.sdp),null!=(o=this._publishingLocalVideoTrack)&&o.small){let{smallStreamConfig:e}=this._room;s=yield this.setBandwidth({bandwidth:this._publishingLocalVideoTrack.small.bitrate||e.bitrate,type:Ub.VIDEO,videoType:Ub.SMALL,sdp:s});}let a={type:e.type,sdp:s};yield this.setAnswer(a),this._log.debug("accepted answer: ".concat(s));}catch(QF){throw this._log.error("failed to accept remote answer ".concat(QF)),QF}}))}sendMutedFlag(e){var t,i,r;if(e===this.localAuxAudioTrack||e===this.localAuxVideoTrack)return;let n={audio:!(null==(t=this.localMainAudioTrack)||!t.muted),bigVideo:!(null==(i=this.localMainVideoTrack)||!i.muted),auxVideo:!(null==(r=this.localAuxVideoTrack)||!r.muted)};this._log.info("send muted state: ".concat(JSON.stringify(n))),this._signalChannel.send(mU,n);}getIsReconnecting(){return this._isReconnecting}reconnect(){return HC(this,null,(function*(){if(!(BC(iF.prototype,this,"beforeReconnect").call(this)<0))try{yield this._signalChannel.sendWaitForResponse({command:gU,responseCommand:lU.UNPUBLISH_RESULT,enableLog:!1}),this.closePeerConnection(),this.initialize(),this.isMainStreamPublished&&(yield this.publish({localAudioTrack:this.localMainAudioTrack,localVideoTrack:this.localMainVideoTrack,isAuxiliary:!1})),this.isAuxStreamPublished&&(yield this.publish({localAudioTrack:this.localAuxAudioTrack,localVideoTrack:this.localAuxVideoTrack,isAuxiliary:!0})),this._log.warn("reconnect() uplink reconnect successfully"),this.stopReconnection();}catch(hk){let t=Ew(this._reconnectionCount);this._log.warn("reconnect() timeout, try again after ".concat(t/1e3,"s")),this._reconnectionTimer=setTimeout((()=>{this.clearReconnectionTimer(),this.reconnect();}),t);}}))}handleConnectionStateChange(e){"CONNECTED"===e.state&&(this.localMainVideoTrack||this._publishingLocalVideoTrack&&!this._isPublishingAux)&&jN.emit(nO.SEND_FIRST_VIDEO_FRAME,{room:this._room});}updateSSRC(e){try{YU(e).media.forEach(((e,t)=>{if(e.type===Ub.AUDIO){let t=e.ssrcs&&e.ssrcs[0];t&&(this.ssrc.audio=Number(t.id));}else {if(this._sdpSemantics===Ek&&e.ssrcGroups)return void e.ssrcGroups.forEach(((e,t)=>{let i=Number(e.ssrcs.split(" ")[0]);0===t?this.ssrc.video=i:1===t&&(this.ssrc.small=i);}));let i=e.ssrcs&&e.ssrcs[0];if(!i)return;switch(t){case 1:this.ssrc.video=Number(i.id);break;case 2:this.ssrc.small=Number(i.id);break;case 3:this.ssrc.auxiliary=Number(i.id);}}}));}catch(hk){}}getVideoTrackId(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:Ub.VIDEO;if(this._peerConnection){let t=this._peerConnection.getSenders();if(e===Ub.AUXILIARY&&t[3]&&t[3].track)return t[3].track.id;if(e===Ub.VIDEO&&t[1]&&t[1].track)return t[1].track.id}if(this.localMainVideoTrack&&e===Ub.VIDEO){let e=this.localMainVideoTrack.mediaTrack;if(e)return e.id}if(this.localAuxVideoTrack&&e===Ub.AUXILIARY){let e=this.localAuxVideoTrack.mediaTrack;if(e)return e.id}return ""}getSSRC(){return this.ssrc}checkPublishResultCode(e,t){if(0!==e)throw e===vk?(this._log.error(qk.NOT_SUPPORTED_H264ENCODE),new tb({code:ZC.NOT_SUPPORTED_H264,message:xN({key:zk.NOT_SUPPORTED_H264ENCODE})})):new tb({code:ZC.UNKNOWN,message:xN({key:zk.SIGNAL_RESPONSE_FAILED,data:{signalResponse:lU.PUBLISH_RESULT,code:e,message:t}})})}},rF=iF;UC([ZM((e=>function(){for(var t=arguments.length,i=new Array(t),r=0;r<t;r++)i[r]=arguments[r];return new Promise(((t,r)=>{let n=e=>{this._emitter.off("closed",n),r(new tb({code:ZC.API_CALL_ABORTED,message:xN({key:zk.CONNECTION_ABORTED,data:e})}));};this._emitter.on("closed",n),e.apply(this,i).then(t,r).finally((()=>{this._emitter.off("closed",n);}));}))}))],rF.prototype,"publish",1),UC([cL(521715,!1)],rF.prototype,"unpublish",1),UC([$M(zU.prototype.afterConnect),XM(zU.prototype.beforeConnect)],rF.prototype,"connect",1);var nF=rF,oF=class{constructor(e,t){this.room=e,FC(this,"_log"),FC(this,"_prevReportTime",0),FC(this,"_prevReport",{}),FC(this,"_prevStats",null),FC(this,"_prevEncoderImplementation",""),FC(this,"_prevAuxEncoderImpl",""),FC(this,"_prevQualityLimitationReason",""),FC(this,"_prevAuxQualityLimitationReason",""),FC(this,"_prevDecoderImplementationMap",new Map),FC(this,"totalBytesSent",0),FC(this,"totalBytesReceived",0),FC(this,"_spcStats",null),this._log=t;}get statInterval(){return 0===this._prevReportTime?2:(Date.now()-this._prevReportTime)/1e3}getSenderStats(e){return HC(this,null,(function*(){var t;let i={audio:{bytesSent:0,packetsSent:0,audioLevel:0,totalAudioEnergy:0},video:{bytesSent:0,packetsSent:0,framesEncoded:0,frameWidth:0,frameHeight:0,framesSent:0,fpsCapture:0},small:{bytesSent:0,packetsSent:0,framesEncoded:0,frameWidth:0,frameHeight:0,framesSent:0,fpsCapture:0},auxiliary:{bytesSent:0,packetsSent:0,framesEncoded:0,frameWidth:0,frameHeight:0,framesSent:0,fpsCapture:0},rtt:0},r=e.getPeerConnection(),n=e.getSSRC();if(r)try{if((this._spcStats||(yield r.getStats())).forEach((t=>{var r,o,s;let a,c;if("outbound-rtp"===t.type)if((t.mediaType||t.kind)===Ub.VIDEO){if(t.ssrc===n.video?(a=Ub.VIDEO,c=e.localMainVideoTrack):t.ssrc===n.small?a=Ub.SMALL:t.ssrc===n.auxiliary&&(c=e.localAuxVideoTrack,a=Ub.AUXILIARY),!a)return;if(i[a].bytesSent=t.bytesSent,i[a].packetsSent=t.packetsSent,i[a].framesEncoded=t.framesEncoded,Sw(t.keyFramesEncoded)||(i[a].keyFramesEncoded=t.keyFramesEncoded),Sw(t.nackCount)||(i[a].nackCount=t.nackCount),Sw(t.pliCount)||(i[a].pliCount=t.pliCount),Sw(t.retransmittedPacketsSent)||(i[a].retransmittedPacketsSent=t.retransmittedPacketsSent),Sw(t.totalEncodeTime)||(i[a].totalEncodeTime=t.totalEncodeTime),Sw(t.totalPacketSendDelay)||(i[a].totalPacketSendDelay=t.totalPacketSendDelay),!Sw(t.encoderImplementation)&&(a===Ub.VIDEO&&this._prevEncoderImplementation!==t.encoderImplementation||a===Ub.AUXILIARY&&this._prevAuxEncoderImpl!==t.encoderImplementation)){let i=2,r=this._prevEncoderImplementation;a===Ub.AUXILIARY&&(i=7,r=this._prevAuxEncoderImpl),jN.emit("262",{userId:e.userId,streamType:i,prevImplementation:r,implementation:t.encoderImplementation,codec:e.videoCodec,isHWCodec:t.powerEfficientEncoder}),this[a===Ub.VIDEO?"_prevEncoderImplementation":"_prevAuxEncoderImpl"]=t.encoderImplementation,this._log.info("".concat(a===Ub.AUXILIARY?"aux ":"","encoderImplementation change to ").concat(t.encoderImplementation,"(").concat(e.videoCodec,") HWEncoder: ").concat(t.powerEfficientEncoder));}t.ssrc===n.video?!Sw(t.qualityLimitationReason)&&0!==t.bytesSent&&this._prevQualityLimitationReason!==t.qualityLimitationReason&&(this._log.info("qualityLimitationReason change to ".concat(t.qualityLimitationReason)),jN.emit("263",{userId:e.userId,reason:t.qualityLimitationReason,prevReason:this._prevQualityLimitationReason,streamType:2,isQosClearFirst:null==(r=e.localMainVideoTrack)?void 0:r.isQosClearFirst}),this._prevQualityLimitationReason=t.qualityLimitationReason):t.ssrc===n.auxiliary&&!Sw(t.qualityLimitationReason)&&0!==t.bytesSent&&this._prevAuxQualityLimitationReason!==t.qualityLimitationReason&&(this._log.info("aux qualityLimitationReason change to ".concat(t.qualityLimitationReason)),jN.emit("263",{userId:e.userId,reason:t.qualityLimitationReason,prevReason:this._prevAuxQualityLimitationReason,streamType:7,isQosClearFirst:null==(o=e.localAuxVideoTrack)?void 0:o.isQosClearFirst}),this._prevAuxQualityLimitationReason=t.qualityLimitationReason);}else i.audio.bytesSent=t.bytesSent,i.audio.packetsSent=t.packetsSent;else "candidate-pair"===t.type?BO(t)&&(this.totalBytesSent=t.bytesSent,Rw(t.currentRoundTripTime)&&(i.rtt=Math.floor(1e3*t.currentRoundTripTime))):"media-source"===t.type&&(t.kind===Ub.AUDIO?(i.audio.audioLevel=t.audioLevel||0,i.audio.totalAudioEnergy=t.totalAudioEnergy||0,t.echoReturnLoss,t.totalSamplesDuration&&(i.audio.totalSamplesDuration=t.totalSamplesDuration)):t.kind===Ub.VIDEO&&(t.trackIdentifier===e.getVideoTrackId(Ub.VIDEO)?i.video.fpsCapture=t.framesPerSecond:t.trackIdentifier===e.getVideoTrackId(Ub.AUXILIARY)?i.auxiliary.fpsCapture=t.framesPerSecond:i.small.fpsCapture=t.framesPerSecond));if(!Sw(t.audioLevel)&&(null==(s=e.localMainAudioTrack)?void 0:s.mediaTrack)&&t.trackIdentifier===e.localMainAudioTrack.mediaTrack.id&&(i.audio.audioLevel=t.audioLevel||0),!Sw(t.frameWidth)){let r=Ub.SMALL;t.trackIdentifier===e.getVideoTrackId(Ub.VIDEO)||t.ssrc===n.video?r=Ub.VIDEO:(t.trackIdentifier===e.getVideoTrackId(Ub.AUXILIARY)||t.ssrc===n.auxiliary)&&(r=Ub.AUXILIARY),i[r].frameWidth=t.frameWidth,i[r].frameHeight=t.frameHeight,i[r].framesSent=t.framesSent;}})),e.localMainAudioTrack){let t=e.localMainAudioTrack.getInternalAudioLevel();i.audio.micAudioLevel=t,0===i.audio.audioLevel&&(i.audio.audioLevel=t);}this.totalBytesSent||(this.totalBytesSent+=i.audio.bytesSent+i.video.bytesSent+i.auxiliary.bytesSent),Object.keys(i).forEach((t=>{t===Ub.AUDIO?(e.localMainAudioTrack&&(e.localMainAudioTrack.stat=i[t]),e.localAuxAudioTrack&&(e.localAuxAudioTrack.stat=i[t])):t===Ub.VIDEO?e.localMainVideoTrack&&(e.localMainVideoTrack.stat=i[t]):t===Ub.AUXILIARY&&e.localAuxVideoTrack&&(e.localAuxVideoTrack.stat=i[t]);}));}catch(hb){this._log.warn("failed to getStats on sender connection ".concat(hb));}return 0===i.rtt&&(i.rtt=(null==(t=this.room.networkQuality)?void 0:t.uplinkRTT)||0),i}))}getReceiverStats(e){return HC(this,null,(function*(){var t;let i={tinyId:e.tinyId,userId:e.userId,rtt:0,hasAudio:!1,hasVideo:!1,hasAuxiliary:!1,isSmallSubscribed:!1,audio:{bytesReceived:0,packetsReceived:0,packetsLost:0,p2pDelay:0,totalJitter:0,totalJitterCount:0,audioLevel:0,totalAudioEnergy:0,insertedSamplesForDeceleration:0,removedSamplesForAcceleration:0},video:{bytesReceived:0,packetsReceived:0,packetsLost:0,framesReceived:0,framesDecoded:0,frameWidth:0,frameHeight:0,fpsDecoded:0,freezeCount:0,totalFreezesDuration:0,totalJitter:0,totalJitterCount:0},auxiliary:{bytesReceived:0,packetsReceived:0,packetsLost:0,framesReceived:0,framesDecoded:0,frameWidth:0,frameHeight:0,fpsDecoded:0,totalJitter:0,totalJitterCount:0}},r=e.getPeerConnection();if(r)try{let{ssrc:t}=e,{muteState:n,subscribeState:o}=e;(this._spcStats||(yield r.getStats())).forEach((r=>{if("inbound-rtp"===r.type){let s=(r.mediaType||r.kind)===Ub.AUDIO;if(s){if(r.ssrc!==t.audio||!n.hasAudio)return;i.audio.packetsReceived=r.packetsReceived,i.audio.bytesReceived=r.bytesReceived,i.audio.packetsLost=r.packetsLost,r.insertedSamplesForDeceleration&&(i.audio.insertedSamplesForDeceleration=r.insertedSamplesForDeceleration),r.removedSamplesForAcceleration&&(i.audio.removedSamplesForAcceleration=r.removedSamplesForAcceleration),r.totalSamplesDuration&&(i.audio.totalSamplesDuration=r.totalSamplesDuration),r.totalSamplesReceived&&(i.audio.totalSamplesReceived=r.totalSamplesReceived),r.concealedSamples&&(i.audio.concealedSamples=r.concealedSamples);let{remoteAudioTrack:o}=e;o.stat.packetsReceived=r.packetsReceived,o.stat.bytesReceived=r.bytesReceived,o.stat.packetsLost=r.packetsLost,i.audio.p2pDelay=o.stat.end2EndDelay,i.hasAudio=!0;}else {if(uD&&0===r.bytesReceived)return;let s;r.ssrc===t.video&&n.hasVideo&&(i.video.packetsReceived=r.packetsReceived,i.video.bytesReceived=r.bytesReceived,i.video.packetsLost=r.packetsLost,i.video.framesReceived=r.framesReceived,i.video.framesDecoded=r.framesDecoded,i.video.fpsDecoded=r.framesPerSecond,i.hasVideo=!0,s=e.remoteVideoTrack,n.hasSmall&&o.smallVideo&&(i.isSmallSubscribed=!0),r.decoderImplementation&&(!this._prevDecoderImplementationMap.has(i.userId)||this._prevDecoderImplementationMap.get(i.userId)!==r.decoderImplementation)&&(this._log.info("".concat(i.userId," decoderImplementation change to ").concat(r.decoderImplementation," HWDecoder: ").concat(r.powerEfficientDecoder)),jN.emit("262",{userId:this.room.userId,remoteUserId:i.userId,prevImplementation:this._prevDecoderImplementationMap.get(i.userId),implementation:r.decoderImplementation,codec:e.videoCodec,isHWCodec:r.powerEfficientDecoder}),this._prevDecoderImplementationMap.set(i.userId,r.decoderImplementation))),r.ssrc===t.auxiliary&&n.hasAuxiliary&&(i.auxiliary.packetsReceived=r.packetsReceived,i.auxiliary.bytesReceived=r.bytesReceived,i.auxiliary.packetsLost=r.packetsLost,i.auxiliary.framesReceived=r.framesReceived,i.auxiliary.framesDecoded=r.framesDecoded,i.auxiliary.fpsDecoded=r.framesPerSecond,s=e.remoteAuxiliaryTrack,i.hasAuxiliary=!0),s&&(s.stat.packetsReceived=r.packetsReceived,s.stat.bytesReceived=r.bytesReceived,s.stat.packetsLost=r.packetsLost,s.stat.framesReceived=r.framesReceived,s.stat.framesDecoded=r.framesDecoded,r.jitterBufferDelay&&(s.stat.jitterBufferDelay=Math.floor(r.jitterBufferDelay/r.jitterBufferEmittedCount*1e3)));}r.jitterBufferDelay&&(s?(i.audio.totalJitter=r.jitterBufferDelay,i.audio.totalJitterCount=r.jitterBufferEmittedCount):r.ssrc===t.video&&n.hasVideo?(i.video.totalJitter=r.jitterBufferDelay,i.video.totalJitterCount=r.jitterBufferEmittedCount):r.ssrc===t.auxiliary&&n.hasAuxiliary&&(i.auxiliary.totalJitter=r.jitterBufferDelay,i.auxiliary.totalJitterCount=r.jitterBufferEmittedCount));}else "candidate-pair"===r.type&&BO(r)&&(this.totalBytesReceived=r.bytesReceived,Rw(r.currentRoundTripTime)&&(i.rtt=Math.floor(1e3*r.currentRoundTripTime)));Sw(r.frameWidth)||((r.trackIdentifier===e.getMainStreamVideoTrackId()||r.ssrc===t.video)&&(i.video.frameWidth=r.frameWidth,i.video.frameHeight=r.frameHeight,e.remoteVideoTrack.stat.frameWidth=r.frameWidth,e.remoteVideoTrack.stat.frameHeight=r.frameHeight),(r.trackIdentifier===e.getAuxStreamVideoTrackId()||r.ssrc===t.auxiliary)&&(i.auxiliary.frameWidth=r.frameWidth,i.auxiliary.frameHeight=r.frameHeight,e.remoteAuxiliaryTrack.stat.frameWidth=r.frameWidth,e.remoteAuxiliaryTrack.stat.frameHeight=r.frameHeight)),!Sw(r.audioLevel)&&e.muteState.audioAvailable&&e.remoteAudioTrack.mediaTrack&&r.trackIdentifier===e.remoteAudioTrack.mediaTrack.id&&(i.audio.audioLevel=r.audioLevel||0,i.audio.totalAudioEnergy=r.totalAudioEnergy||0);})),0===i.audio.audioLevel&&e.muteState.audioAvailable&&(i.audio.audioLevel=e.remoteAudioTrack.getInternalAudioLevel()||0),this.totalBytesReceived||(this.totalBytesReceived+=i.audio.bytesReceived+i.video.bytesReceived+i.auxiliary.bytesReceived);}catch(n){this._log.warn("failed to getStats on receiver connection ".concat(n));}return 0===i.rtt&&(i.rtt=(null==(t=this.room.networkQuality)?void 0:t.uplinkRTT)||0),i}))}getStats(e,t){return HC(this,null,(function*(){let i={},r=[];if(this.room.singlePC){let e=this.room.singlePC.getPeerConnection();if(!e)return {senderStats:i,receiverStats:r};let t=Lw(),n=yield e.getStats(),o=Lw();o-t>2e3&&this._log.warn("getStats cost ".concat(o-t,"ms"));let s=[],a=new Set(["inbound-rtp","outbound-rtp","track","candidate-pair","media-source"]);n.forEach((e=>a.has(e.type)&&s.push(e))),this._spcStats=s;}e&&(i=yield this.getSenderStats(e));for(let[e,n]of t){let e=yield this.getReceiverStats(n);r.push(e);}return {senderStats:i,receiverStats:r}}))}getDifferenceValue(e,t){if(JM(e))return t;let i=t-e;return i<0?0:i}prepareReport(e){let{stats:t,report:i,freezeMap:r}=e;var n;if(!JM(t.senderStats)){let e={uint32_audio_level:t.senderStats.audio.audioLevel*Kk,uint32_audio_energy:1e6*(t.senderStats.audio.totalAudioEnergy||0),uint32_audio_codec_bitrate:t.senderStats.audio.bytesSent};t.senderStats.audio.micAudioLevel&&(e.uint32_mic_audio_level=t.senderStats.audio.micAudioLevel*Kk),t.senderStats.audio.totalSamplesDuration&&(i.msg_device_info.uint32_audio_capture_cost=t.senderStats.audio.totalSamplesDuration);let r=[];if(t.senderStats.video.bytesSent){let e={uint32_video_stream_type:2,uint32_video_codec_fps:t.senderStats.video.framesSent,uint32_video_capture_fps:t.senderStats.video.fpsCapture,uint32_video_width:t.senderStats.video.frameWidth,uint32_video_height:t.senderStats.video.frameHeight,uint32_video_codec_bitrate:t.senderStats.video.bytesSent,uint32_video_enc_fps:t.senderStats.video.framesEncoded,uint32_key_frame_count:t.senderStats.video.keyFramesEncoded,uint32_nack_count:t.senderStats.video.nackCount,uint32_pli_count:t.senderStats.video.pliCount,uint32_encode_cost:1e3*(t.senderStats.video.totalEncodeTime||0),uint32_send_packet_cost:1e3*(t.senderStats.video.totalPacketSendDelay||0),uint32_video_arq_packets:t.senderStats.video.retransmittedPacketsSent};r.push(e);}if(t.senderStats.small.bytesSent){let e={uint32_video_stream_type:3,uint32_video_codec_fps:t.senderStats.small.framesSent||0,uint32_video_capture_fps:t.senderStats.small.fpsCapture||0,uint32_video_width:t.senderStats.small.frameWidth||0,uint32_video_height:t.senderStats.small.frameHeight||0,uint32_video_codec_bitrate:t.senderStats.small.bytesSent,uint32_video_enc_fps:t.senderStats.small.framesEncoded||0,uint32_key_frame_count:t.senderStats.small.keyFramesEncoded,uint32_nack_count:t.senderStats.small.nackCount,uint32_pli_count:t.senderStats.small.pliCount,uint32_encode_cost:1e3*(t.senderStats.small.totalEncodeTime||0),uint32_send_packet_cost:1e3*(t.senderStats.small.totalPacketSendDelay||0),uint32_video_arq_packets:t.senderStats.small.retransmittedPacketsSent};r.push(e);}if(t.senderStats.auxiliary.bytesSent){let e={uint32_video_stream_type:7,uint32_video_codec_fps:t.senderStats.auxiliary.framesSent||0,uint32_video_capture_fps:t.senderStats.auxiliary.fpsCapture||0,uint32_video_width:t.senderStats.auxiliary.frameWidth||0,uint32_video_height:t.senderStats.auxiliary.frameHeight||0,uint32_video_codec_bitrate:t.senderStats.auxiliary.bytesSent,uint32_video_enc_fps:t.senderStats.auxiliary.framesEncoded||0,uint32_key_frame_count:t.senderStats.auxiliary.keyFramesEncoded,uint32_nack_count:t.senderStats.auxiliary.nackCount,uint32_pli_count:t.senderStats.auxiliary.pliCount,uint32_encode_cost:1e3*(t.senderStats.auxiliary.totalEncodeTime||0),uint32_send_packet_cost:1e3*(t.senderStats.auxiliary.totalPacketSendDelay||0),uint32_video_arq_packets:t.senderStats.auxiliary.retransmittedPacketsSent};r.push(e);}let n={uint32_bitrate:0,uint32_lost:0,uint32_rtt:t.senderStats.rtt};i.msg_up_stream_info={msg_audio_status:e,msg_video_status:r,msg_network_status:n};}let{statInterval:o}=this;i.msg_down_stream_info=[],t.receiverStats.forEach((e=>{let t={msg_user_info:{str_identifier:e.userId,uint64_tinyid:e.tinyId},msg_network_status:{uint32_rtt:e.rtt,uint32_bitrate:0,uint32_lost:0},msg_audio_status:{},msg_video_status:[]};if(e.hasAudio){let i={uint32_audio_p2p_delay:e.audio.p2pDelay,uint32_audio_cache_ms:e.audio.totalJitter,uint32_audio_cache_ms_count:e.audio.totalJitterCount,uint32_audio_codec_bitrate:e.audio.bytesReceived,uint32_audio_total_bitrate:e.audio.bytesReceived,uint32_audio_level:1e8*e.audio.audioLevel,uint32_audio_energy:1e6*e.audio.totalAudioEnergy,uint32_audio_receive:e.audio.packetsReceived,uint32_audio_origin_lost:e.audio.packetsLost};t.msg_audio_status=i;}if(e.hasVideo){let i=r.get("".concat(e.userId,"_").concat($b)),n=i?i.duration:0,o={uint32_video_stream_type:e.isSmallSubscribed?3:2,uint32_video_receive_fps:e.video.framesReceived,uint32_video_width:e.video.frameWidth,uint32_video_height:e.video.frameHeight,uint32_video_codec_bitrate:e.video.bytesReceived,uint32_video_receive:e.video.packetsReceived,uint32_video_origin_lost:e.video.packetsLost,uint32_video_block_time:n,uint32_video_dec_fps:e.video.framesDecoded,uint32_video_cache_ms:e.video.totalJitter,uint32_video_cache_ms_count:e.video.totalJitterCount};t.msg_video_status.push(o);}if(e.hasAuxiliary){let i=r.get("".concat(e.userId,"_").concat(Zb)),n=i?i.duration:0,o={uint32_video_stream_type:7,uint32_video_receive_fps:e.auxiliary.framesReceived,uint32_video_width:e.auxiliary.frameWidth,uint32_video_height:e.auxiliary.frameHeight,uint32_video_codec_bitrate:e.auxiliary.bytesReceived,uint32_video_receive:e.auxiliary.packetsReceived+e.auxiliary.packetsLost,uint32_video_origin_lost:e.auxiliary.packetsLost,uint32_video_block_time:n,uint32_video_dec_fps:e.auxiliary.framesDecoded,uint32_video_cache_ms:e.auxiliary.totalJitter,uint32_video_cache_ms_count:e.auxiliary.totalJitterCount};t.msg_video_status.push(o);}i.msg_down_stream_info.push(t);}));let s=this._prevReport,a=this._prevStats;if(this._prevReport=JSON.parse(JSON.stringify(i)),this._prevStats=JSON.parse(JSON.stringify(t)),i.msg_up_stream_info.msg_audio_status&&s.msg_up_stream_info.msg_audio_status){let e=s.msg_up_stream_info.msg_audio_status,t=i.msg_up_stream_info.msg_audio_status;if(0===e.uint32_audio_codec_bitrate)t.uint32_audio_codec_bitrate=0;else {let r=this.getDifferenceValue(e.uint32_audio_codec_bitrate,t.uint32_audio_codec_bitrate);t.uint32_audio_codec_bitrate=Math.round(8*r/o),i.msg_up_stream_info.msg_network_status.uint32_bitrate+=t.uint32_audio_codec_bitrate;}null!=(n=s.msg_device_info)&&n.uint32_audio_capture_cost?i.msg_device_info.uint32_audio_capture_cost=2*Math.floor(1e3*this.getDifferenceValue(s.msg_device_info.uint32_audio_capture_cost,i.msg_device_info.uint32_audio_capture_cost)/o):delete i.msg_device_info.uint32_audio_capture_cost;}let c=s.msg_up_stream_info.msg_video_status;i.msg_up_stream_info.msg_video_status.forEach((e=>{let t=c.find((t=>t.uint32_video_stream_type===e.uint32_video_stream_type));if(!t||0===t.uint32_video_codec_bitrate)return e.uint32_video_codec_bitrate=0,e.uint32_video_enc_fps=0,void(e.uint32_video_codec_fps=0);let r=0,n=0,s=0;t&&e.uint32_video_codec_bitrate>=t.uint32_video_codec_bitrate&&(r=t.uint32_video_codec_bitrate,n=t.uint32_video_enc_fps,s=t.uint32_video_codec_fps);let a=this.getDifferenceValue(r,e.uint32_video_codec_bitrate);e.uint32_video_codec_bitrate=Math.round(8*a/o),i.msg_up_stream_info.msg_network_status.uint32_bitrate+=e.uint32_video_codec_bitrate,e.uint32_video_enc_fps=Math.round(this.getDifferenceValue(n,e.uint32_video_enc_fps)/o),e.uint32_video_codec_fps=Math.round(this.getDifferenceValue(s,e.uint32_video_codec_fps)/o),HD&&115===oN()&&0===t.uint32_video_width&&0===t.uint32_video_height&&0===t.uint32_video_codec_fps&&(e.uint32_video_codec_fps=e.uint32_video_enc_fps),Sw(t.uint32_key_frame_count)||(e.uint32_key_frame_count=Math.round(this.getDifferenceValue(t.uint32_key_frame_count,e.uint32_key_frame_count))),Sw(t.uint32_nack_count)||(e.uint32_nack_count=Math.round(this.getDifferenceValue(t.uint32_nack_count,e.uint32_nack_count))),Sw(t.uint32_pli_count)||(e.uint32_pli_count=Math.round(this.getDifferenceValue(t.uint32_pli_count,e.uint32_pli_count))),Sw(t.uint32_video_arq_packets)||(e.uint32_video_arq_packets=Math.round(this.getDifferenceValue(t.uint32_video_arq_packets,e.uint32_video_arq_packets))),Sw(t.uint32_encode_cost)||(e.uint32_encode_cost=Math.round(this.getDifferenceValue(t.uint32_encode_cost,e.uint32_encode_cost)/o)),Sw(t.uint32_send_packet_cost)||(e.uint32_send_packet_cost=Math.round(this.getDifferenceValue(t.uint32_send_packet_cost,e.uint32_send_packet_cost)/o));}));let l=s.msg_down_stream_info;i.msg_down_stream_info=i.msg_down_stream_info.filter((e=>l.find((t=>t.msg_user_info.uint64_tinyid===e.msg_user_info.uint64_tinyid))));let d=i.msg_down_stream_info;return d.forEach((e=>{let t=l.find((t=>t.msg_user_info.uint64_tinyid===e.msg_user_info.uint64_tinyid));if(JM(e.msg_audio_status)||JM(t.msg_audio_status))e.msg_audio_status={};else {let i=e.msg_audio_status,r=t.msg_audio_status,n=this.getDifferenceValue(r.uint32_audio_cache_ms_count,i.uint32_audio_cache_ms_count);delete i.uint32_audio_cache_ms_count,i.uint32_audio_cache_ms=Math.floor(1e3*this.getDifferenceValue(r.uint32_audio_cache_ms,i.uint32_audio_cache_ms)/n)||0;let s=this.room.remotePublishedUserMap.get(e.msg_user_info.str_identifier);s&&(s.remoteAudioTrack.stat.jitterBufferDelay=i.uint32_audio_cache_ms),i.uint32_audio_origin_lost=this.getDifferenceValue(r.uint32_audio_origin_lost,i.uint32_audio_origin_lost),i.uint32_audio_receive=this.getDifferenceValue(r.uint32_audio_receive,i.uint32_audio_receive),i.uint32_audio_receive+=i.uint32_audio_origin_lost;let a=this.getDifferenceValue(r.uint32_audio_codec_bitrate,i.uint32_audio_codec_bitrate);i.uint32_audio_codec_bitrate=Math.round(8*a/o),i.uint32_audio_total_bitrate=Math.round(8*a/o);}if(e.msg_video_status&&t.msg_video_status){let i=t.msg_video_status;e.msg_video_status=e.msg_video_status.filter((e=>i.find((t=>t.uint32_video_stream_type===e.uint32_video_stream_type)))),e.msg_video_status.forEach((e=>{let t=i.find((t=>t.uint32_video_stream_type===e.uint32_video_stream_type)),r=t.uint32_video_receive,n=t.uint32_video_origin_lost,s=t.uint32_video_codec_bitrate,a=t.uint32_video_receive_fps,c=t.uint32_video_dec_fps;e.uint32_video_origin_lost=this.getDifferenceValue(n,e.uint32_video_origin_lost),e.uint32_video_receive=this.getDifferenceValue(r,e.uint32_video_receive)+e.uint32_video_origin_lost;let l=this.getDifferenceValue(s,e.uint32_video_codec_bitrate);e.uint32_video_codec_bitrate=Math.round(8*l/o);let d=this.getDifferenceValue(a,e.uint32_video_receive_fps);e.uint32_video_receive_fps=Math.round(d/o),e.uint32_video_dec_fps=Math.round(this.getDifferenceValue(c,e.uint32_video_dec_fps)/o);let u=this.getDifferenceValue(t.uint32_video_cache_ms_count,e.uint32_video_cache_ms_count);delete e.uint32_video_cache_ms_count,e.uint32_video_cache_ms=Math.floor(1e3*this.getDifferenceValue(t.uint32_video_cache_ms,e.uint32_video_cache_ms)/u)||0;}));}})),a&&t.receiverStats.forEach((e=>{if(e.audio.concealedSamples&&e.audio.totalSamplesReceived){let t=a.receiverStats.find((t=>t.userId===e.userId));if(t&&t.audio.concealedSamples&&t.audio.totalSamplesReceived){let i=e.audio.concealedSamples-t.audio.concealedSamples,r=e.audio.totalSamplesReceived-t.audio.totalSamplesReceived,n=Math.floor(i/r*1e3*o);if(n>o/5){let t=d.find((t=>t.msg_user_info.str_identifier===e.userId));t&&(t.msg_audio_status.uint32_audio_block_time=n);}}}})),i}getStatsReport(e){return HC(this,arguments,(function(e){var t=this;let{uplinkConnection:i,downlinkConnections:r,freezeMap:n}=e;return function*(){let e={msg_device_info:{},msg_up_stream_info:{msg_audio_status:{uint32_audio_format:11,uint32_audio_sample_rate:0,uint32_audio_codec_bitrate:0,uint32_audio_receive:0,uint32_audio_origin_lost:0,uint32_audio_level:0,uint32_audio_energy:0},msg_video_status:[],msg_network_status:{uint32_bitrate:0,uint32_rtt:0,uint32_lost:0}},msg_down_stream_info:[{msg_user_info:{str_identifier:"",uint64_tinyid:0},msg_audio_status:{uint32_audio_cache_ms:0,uint32_audio_format:11,uint32_audio_sample_rate:0,uint32_audio_codec_bitrate:0,uint32_audio_total_bitrate:0,uint32_audio_level:0,uint32_audio_energy:0,uint32_audio_receive:0,uint32_audio_origin_lost:0,uint32_audio_final_lost:0},msg_video_status:[{uint32_video_cache_ms:0,uint32_video_stream_type:0,uint32_video_receive_fps:0,uint32_video_width:0,uint32_video_height:0,uint32_video_codec_bitrate:0,uint32_video_receive:0,uint32_video_origin_lost:0,uint32_video_block_time:0,uint32_video_dec_fps:0}],msg_network_status:{uint32_bitrate:0,uint32_rtt:0,uint32_lost:0}}]},o=yield t.getStats(i,r);return "{}"===JSON.stringify(t._prevReport)&&(t._prevReport=JSON.parse(JSON.stringify(e))),t.prepareReport({stats:o,report:e,freezeMap:n}),t._prevReportTime=Date.now(),e}()}))}reset(){this._prevReportTime=0,this._prevReport={},this._prevEncoderImplementation="",this._prevQualityLimitationReason="",this._prevDecoderImplementationMap=new Map;}},sF=VC(jC());function aF(e){return new Promise((t=>HC(this,null,(function*(){let i=setTimeout((()=>{t({totalCost:1e4,local:0,dns:0,tcp:0,tls:0,request:0,response:0});}),1e4),r=Date.now(),n="https://".concat(e,"/?t=").concat(r);try{yield fetch(n);}catch(hb){}clearTimeout(i);let o=function(e){let t={totalCost:0,local:0,redirect:0,httpCache:0,dns:0,tcp:0,tls:0,request:0,response:0};try{let i=performance.getEntriesByType("resource").reverse();for(let r of i)if(r.name===e){let e=Math.round(r.duration),i=Math.max(Math.round(r.domainLookupStart-r.startTime),0),n=r.redirectStart>0?Math.max(Math.round(r.redirectEnd-r.redirectStart),0):0,o=r.fetchStart>0?Math.max(Math.round(r.domainLookupStart-r.fetchStart),0):0,s=Math.round(r.domainLookupEnd-r.domainLookupStart),a=Math.round(r.requestStart-r.secureConnectionStart),c=Math.round(r.secureConnectionStart-r.connectStart),l=Math.round(r.responseStart-r.requestStart),d=Math.round(r.responseEnd-(r.responseStart||r.startTime));t=MC(PC({},t),{totalCost:e,local:i,redirect:n,httpCache:o,dns:s,tcp:c,tls:a,request:l,response:d});break}}catch(i){}return t}(n);0===o.totalCost&&(o.totalCost=Date.now()-r),t(o);}))))}var cF=class extends sF.default{constructor(e){let{signalChannel:t,room:i}=e;super(),FC(this,"_room"),FC(this,"_signalChannel"),FC(this,"_log"),FC(this,"uplinkRTT",0),FC(this,"uplinkLoss",0),FC(this,"downlinkRTT",0),FC(this,"downlinkLoss",0),FC(this,"pingResults",{}),FC(this,"_downlinkPrevStatMap",new Map),FC(this,"_downlinkLossAndRTTMap",new Map),FC(this,"_interval",-1),FC(this,"_uplinkNetworkQuality",0),FC(this,"_downlinkNetworkQuality",0),this._room=i,this._signalChannel=t,this._log=sO.createLogger({id:"q",userId:this._room.userId,sdkAppId:this._room.sdkAppId}),this.initialize();}get uplinkNetworkQuality(){return this._uplinkNetworkQuality}set uplinkNetworkQuality(e){e!==this._uplinkNetworkQuality&&this._log.info("uplink ".concat(this.uplinkNetworkQuality," -> ").concat(e,", rtt: ").concat(this.uplinkRTT,", loss: ").concat(this.uplinkLoss," ws-rtt: ").concat(this._signalChannel.rtt)),this._uplinkNetworkQuality=e;}get downlinkNetworkQuality(){return this._downlinkNetworkQuality}set downlinkNetworkQuality(e){if(e!==this._downlinkNetworkQuality){let{rtt:t,loss:i}=this.getAverageLossAndRTT([...this._downlinkLossAndRTTMap.values()]);this._log.info("downlink ".concat(this.downlinkNetworkQuality," -> ").concat(e,", rtt: ").concat(t,", loss: ").concat(i," ws-rtt: ").concat(this._signalChannel.rtt));}this._downlinkNetworkQuality=e;}initialize(){this._signalChannel.on(lU.UPLINK_NETWORK_STATS,(e=>{this.handleUplinkNetworkQuality(e);})),this._signalChannel.on(iU,this.handleSignalConnectionStateChange.bind(this)),this.start();}handleUplinkNetworkQuality(e){var t,i;if(0!==e.data.code)return;let r=e.data.data;if(r.delay&&this.updateDelay(r.delay),this._room.signalChannel&&r.wsRtt&&(this._room.signalChannel.rtt=r.wsRtt),!this._room.uplinkConnection)return this.uplinkNetworkQuality=0,this.uplinkLoss=0,void(this.uplinkRTT=0);let n=null==(i=null==(t=this._room)?void 0:t.uplinkConnection)?void 0:i.getPeerConnection();if(n&&this.isPeerConnectionDisconnected(n))return this.uplinkNetworkQuality=6,this.uplinkLoss=0,void(this.uplinkRTT=0);let o=r.expectAudPkg+r.expectVidPkg,s=r.recvAudPkg+r.recvVidPkg,a=o-s;0===o&&0===s||(this.uplinkLoss=a<=0?0:Math.round(a/o*100),this.uplinkRTT=r.rtt,this.uplinkNetworkQuality=this.getNetworkQuality(this.uplinkLoss,this.uplinkRTT));}handleDownlinkNetworkQuality(){return HC(this,null,(function*(){if(0===this._room.remotePublishedUserMap.size)return void(this.downlinkNetworkQuality=0);let e=[...this._room.remotePublishedUserMap.values()],t=e.filter((e=>{var t;return (null==(t=e.getPeerConnection())?void 0:t.connectionState)===ck.CONNECTED}));if(e.filter((e=>this.isPeerConnectionDisconnected(e.getPeerConnection()))).length===e.length)return void(this.downlinkNetworkQuality=6);for(let n=0;n<t.length;n++){let e=t[n].getPeerConnection();if(!e)return;let{rtt:i,totalPacketsLost:r,totalPacketsReceived:o}=yield this.getStat(e);if(!this._downlinkPrevStatMap.has(e)){this._downlinkPrevStatMap.set(e,{totalPacketsLost:r,totalPacketsReceived:o});continue}let s=0,a=this._downlinkPrevStatMap.get(e),c=r-a.totalPacketsLost,l=o-a.totalPacketsReceived;s=c<=0||l<0?0:Math.round(c/(c+l)*100),this._downlinkPrevStatMap.set(e,{totalPacketsLost:r,totalPacketsReceived:o}),this._downlinkLossAndRTTMap.set(e,{rtt:i,loss:s,userId:t[n].getUserId(),audioDelay:t[n].remoteAudioTrack.stat.end2EndDelay,videoDelay:t[n].remoteVideoTrack.stat.end2EndDelay});}if([...this._downlinkPrevStatMap.keys()].forEach((e=>{this.isPeerConnectionDisconnected(e)&&(this._downlinkPrevStatMap.delete(e),this._downlinkLossAndRTTMap.delete(e));})),0===this._downlinkLossAndRTTMap.size)return this.downlinkRTT=0,this.downlinkLoss=0,void(this.downlinkNetworkQuality=0);let{rtt:i,loss:r}=this.getAverageLossAndRTT([...this._downlinkLossAndRTTMap.values()]);this.downlinkRTT=i,this.downlinkLoss=r,this.downlinkNetworkQuality=this.getNetworkQuality(r,i);}))}getStat(e){return HC(this,null,(function*(){let t={rtt:0,totalPacketsLost:0,totalPacketsReceived:0};if(!e||!zO())return t;let i=e.getReceivers();try{for(let e=0;e<i.length;e++)(yield i[e].getStats()).forEach((e=>{"candidate-pair"===e.type&&Rw(e.currentRoundTripTime)&&(t.rtt=Math.round(1e3*e.currentRoundTripTime)),"inbound-rtp"===e.type&&(e.mediaType===Ub.AUDIO||e.mediaType===Ub.VIDEO)&&(t.totalPacketsLost+=e.packetsLost,t.totalPacketsReceived+=e.packetsReceived);}));return 0===t.rtt&&(t.rtt=this.uplinkRTT),t}catch(r){return t}}))}getAverageLossAndRTT(e){let t={rtt:0,loss:0};return Array.isArray(e)&&e.length>0&&(e.forEach((e=>{t.rtt+=e.rtt,t.loss+=e.loss;})),Object.keys(t).forEach((i=>{t[i]=Math.round(t[i]/e.length);}))),t}getNetworkQuality(e,t){return e>50||t>500?5:e>30||t>350?4:e>20||t>200?3:e>10||t>100?2:e>=0||t>=0?1:0}handleSignalConnectionStateChange(e){"DISCONNECTED"===e.state?(this.uplinkRTT=0,this.uplinkLoss=0,this.uplinkNetworkQuality=6):"CONNECTED"===e.state&&6===this.uplinkNetworkQuality&&(this.uplinkNetworkQuality=5);}handleUplinkConnectionStateChange(e){let{state:t}=e;"DISCONNECTED"===t?(this.uplinkLoss=0,this.uplinkRTT=0,this.uplinkNetworkQuality=6):"CONNECTED"===t&&6===this.uplinkNetworkQuality&&(this.uplinkNetworkQuality=5);}isPeerConnectionDisconnected(e){return !(!e||e.connectionState!==ck.DISCONNECTED&&e.connectionState!==ck.FAILED&&e.connectionState!==ck.CLOSED)}setUplinkConnection(e){this._room.uplinkConnection=e,this._room.uplinkConnection?this._room.uplinkConnection.on("connection-state-changed",this.handleUplinkConnectionStateChange.bind(this)):(this.uplinkNetworkQuality=0,this.uplinkRTT=0,this.uplinkLoss=0);}start(){-1===this._interval?(this._log.debug("start network quality calculating"),this._interval=NP.run(Uk,(()=>{var e;this.handleDownlinkNetworkQuality();let t=[...this._downlinkLossAndRTTMap.values()];jN.emit(nO.NETWORK_QUALITY,{room:this._room,uplink:{rtt:this.uplinkRTT,loss:this.uplinkLoss},downlinks:t});let i=null==(e=this._room.scheduleResult.config)?void 0:e.pingDomainInfo,r={uplinkNetworkQuality:this.uplinkNetworkQuality,downlinkNetworkQuality:this.downlinkNetworkQuality,uplinkRTT:this.uplinkRTT,uplinkLoss:this.uplinkLoss,downlinkRTT:this.downlinkRTT,downlinkLoss:this.downlinkLoss};i&&(r=MC(PC({},r),{pingResults:this.uplinkRTT>i.rttThreshold||this.downlinkRTT>i.rttThreshold?this.pingResults:{}})),this.emit(cF.EVENT_NETWORK_QUALITY,r);let n=Date.now();if(i&&(this.uplinkRTT>i.rttThreshold||this.downlinkRTT>i.rttThreshold)&&n-cF.lastPingTime>1e3*i.interval){cF.lastPingTime=Date.now();let e=i.domain.map((e=>aF(e).then((t=>({domain:e,cost:t.totalCost})))));Promise.all(e).then((e=>{this.pingResults.isPoorNetwork=e.some((e=>e.cost>700)),this.pingResults.timestamp=n,this.pingResults.data=e,e.forEach((e=>{kvStatManager.addSuccessEvent({key:KV_REPORT_KEY_NETWORK.PING,cost:e.cost});})),this._log.warn("All ping results: ".concat(JSON.stringify(e)));})).catch((e=>{this._log.warn("Error during pinging domains: ".concat(e));}));}}),{delay:2e3})):this._log.info("network quality calculating is already started");}stop(){this._log.debug("stopped"),-1!==this._interval&&(NP.clearTask(this._interval),this._interval=-1),this._downlinkLossAndRTTMap.clear(),this._downlinkPrevStatMap.clear();}updateDelay(e){let{tinyIdToUserIdMap:t}=this._room;e.forEach((e=>{let{srcTinyId:i,videoDelay:r,audioDelay:n}=e,o=t.get(i);if(o){let e=this._room.remotePublishedUserMap.get(o);null==e||e.setDelay({videoDelay:r,audioDelay:n});}}));}},lF=cF;FC(lF,"EVENT_NETWORK_QUALITY","0"),FC(lF,"lastPingTime",0);var dF=class{constructor(e){this._signalInfo={tinyId:void 0,clientIp:"",signalIp:"",relayIp:"",relayInnerIp:"",relayPort:0},this._eventMap=new Map,this._captureCostSum=0,this._captureCostCount=0,this.isDestroyed=!1,this._frameWorkType=e.frameWorkType||30,this._component=e.component||0,this.connectionType=e.connectionType||1,this._language=e.language||0,this._room=e.room,this._keyPrefix="key_point",this._log=sO.createLogger({id:"kpm",userId:this._room.userId,sdkAppId:this._room.sdkAppId}),Object.getOwnPropertyNames(this.__proto__).forEach((e=>{e.startsWith("handle")&&yw(this[e])&&(this[e]=function(e){let{fn:t,context:i}=e;return function(){try{for(var e=arguments.length,r=new Array(e),n=0;n<e;n++)r[n]=arguments[n];let o=t.apply(i,r);return Nw(o)?o.catch((e=>sO.error("".concat(t.name,"() error observed ").concat(e)))):o}catch(hk){sO.error("".concat(t.name,"() error observed ").concat(hk));}}}({fn:this[e],context:this}));})),this.initData(),this.installEvents();}initData(){this._firstPublishedUserList=[],this._networkQuality={totalUplinkRTT:0,totalUplinkLoss:0,count:0,totalDownlinkRTTAndLossMap:new Map},this._basicInfo={string_sdk_version:cb,uint32_os_type:15,string_device_name:"",string_http_user_agent:navigator.userAgent,string_os_version:"",uint32_avg_rtt:0,uint32_avg_up_loss:0,uint32_scene:"live"===this._room.scene?1:0,uint32_joining_duration:0,uint32_networkType:0,uint32_framework:this._frameWorkType,uint32_component:this._component,uint32_connection_type:this.connectionType,uint32_caller_coding_language:this._language,string_domain:location.hostname},this._pathJoinRoom={uint64_start_time:0,uint64_send_request_acc_ip_cmd_start_time:0,uint64_send_request_acc_ip_cmd_end_time:0,uint64_send_request_enter_room_cmd_start_time:0,uint64_send_request_enter_room_cmd_end_time:0,uint64_send_first_video_frame_time:0,uint64_recv_userlist_time:0,uint64_end_time:0,int32_send_request_acc_ip_cmd_ret:0,int32_send_request_enter_room_cmd_ret:0,int32_end_ret:0},this._pathLeaveRoom={uint64_start_time:0,uint64_send_request_exit_room_cmd_start_time:0,uint64_send_request_exit_room_cmd_end_time:0,uint64_end_time:0,int32_send_request_exit_room_cmd_ret:0,int32_end_ret:0},this._localStreamStat={totalVideoBitrate:0,totalVideoFPS:0,totalVideoHeight:0,totalVideoWidth:0,totalAudioLevel:0,videoCount:0,audioLevelCount:0,publishStartTime:0,statsToReport:{uint32_audio_capture_db:0,uint32_video_big_capture_fps:0,uint32_video_big_bitrate:0,uint32_video_big_resolution:0}},this._pathMainVideoMap=new Map,this._pathMainAudioMap=new Map,this._pathAuxiliaryMap=new Map,this._remoteStreamStatMap=new Map,CN().then((e=>{this._basicInfo.string_os_version=wN(),this._basicInfo.string_device_name=e&&e.mobile?e.model:this._basicInfo.string_os_version;}));}addEvent(e,t){return this._eventMap.set(e,t),jN.on(e,t),this}installEvents(){this.handleUnload=this.handleUnload.bind(this),window.addEventListener("pagehide",this.handleUnload),this._room.once("banned",(()=>this.handleLeaveSuccess({room:this._room,roomId:this._room.roomId}))),this.addEvent(nO.JOIN_START,this.handleJoinStart).addEvent(nO.JOIN_SCHEDULE_SUCCESS,this.handleJoinScheduleSuccess).addEvent(nO.JOIN_SIGNAL_CONNECTION_START,this.handleSignalConnectionStart).addEvent(nO.JOIN_SIGNAL_CONNECTION_END,this.handleSignalConnectionEnd).addEvent(nO.JOIN_SEND_CMD,this.handleJoinSendCMD).addEvent(nO.JOIN_RECEIVED_CMD_RES,this.handleJoinReceivedCMDResponce).addEvent(nO.JOIN_SUCCESS,this.handleJoinSuccess).addEvent(nO.JOIN_FAILED,this.handleJoinFailed).addEvent(nO.LEAVE_START,this.handleLeaveStart).addEvent(nO.LEAVE_SUCCESS,this.handleLeaveSuccess).addEvent(nO.LEAVE_SEND_CMD,this.handleLeaveSendCMD).addEvent(nO.LOCAL_TRACK_CAPTURE_START,this.handleTrackCaptureStart).addEvent(nO.LOCAL_TRACK_CAPTURE_SUCCESS,this.handleTrackCaptureSuccess).addEvent(nO.LOCAL_TRACK_CAPTURE_FAILED,this.handleTrackCaptureFailed).addEvent(nO.PUBLISH_START,this.handlePublishStart).addEvent(nO.SEND_FIRST_VIDEO_FRAME,this.handleSendFirstVideoFrame).addEvent(nO.SUBSCRIBE_START,this.handleSubscribeStart).addEvent(nO.SUBSCRIBE_SUCCESS,this.handleSubscribed).addEvent(nO.PLAY_TRACK_START,this.handlePlayStart).addEvent(nO.VIDEO_LOADED_DATA,this.handleVideoLoadedData).addEvent(nO.PLAYER_STATE_CHANGED,(e=>{let{track:t,state:i,type:r}=e;!Dw(t)||!this.hitTest(t.room)||"PLAYING"===i&&(r===Ub.AUDIO?this.handleAudioPlaying(t):this.handleVideoPlaying(t));})).addEvent(nO.NETWORK_QUALITY,this.handleNetworkQuality).addEvent(nO.HEARTBEAT_REPORT,this.handleHeartbeatStats).addEvent(nO.RECEIVED_PUBLISHED_USER_LIST,this.handleReceivedPublishUserList).addEvent(nO.REMOTE_PUBLISH_STATE_CHANGED,(e=>{let{room:t,prevMuteState:i,muteState:r}=e;if(!this.hitTest(t))return;let n=i.hasAudio||i.hasVideo||i.hasSmall,o=i.hasAuxiliary,s=r.hasAudio||r.hasVideo||r.hasSmall,a=r.hasAuxiliary;!n&&s&&this.handleRemoteStreamAdded(r.userId,"main"),!o&&a&&this.handleRemoteStreamAdded(r.userId,"auxiliary");})).addEvent(nO.SINGLE_CONNECTION_STAT,(e=>{let{room:t,stat:i}=e;this.hitTest(t)&&(this._pathJoinRoom.int32_ice_cost=i.ice,this._pathJoinRoom.int32_dtls_cost=i.dtls,this._pathJoinRoom.int32_peer_connection_cost=i.peerConnection);}));}uninstallEvents(){window.removeEventListener("unload",this.handleUnload),this._eventMap.forEach(((e,t)=>jN.off(t,e))),this._eventMap.clear();}destroy(){this.uninstallEvents(),NP.clearTask(this._intervalId),0===this._pathJoinRoom.uint64_start_time&&(this._room=null),this.isDestroyed=!0;}handleUnload(){this._room.isJoined&&this.handleLeaveSuccess({room:this._room,roomId:this._room.roomId});}handleJoinStart(e){this.hitTest(e.room)&&(0===this._pathJoinRoom.uint64_start_time&&(this._pathJoinRoom.uint64_start_time=Date.now()),e.params&&(Sw(e.params.frameWorkType)||(this._frameWorkType=e.params.frameWorkType,this._basicInfo.uint32_framework=this._frameWorkType),Sw(e.params.component)||(this._component=e.params.component,this._basicInfo.uint32_component=this._component),Sw(e.params.language)||(this._language=e.params.language,this._basicInfo.uint32_caller_coding_language=this._language)));}handleJoinScheduleSuccess(e){let{room:t,detailCost:i}=e;if(this.hitTest(t)&&i){let{totalCost:e,local:t,dns:r,tcp:n,tls:o,request:s,response:a}=i;this._pathJoinRoom.int32_schedule_cost=e,this._pathJoinRoom.int32_schedule_local=t,this._pathJoinRoom.int32_schedule_dns=r,this._pathJoinRoom.int32_schedule_tcp=n,this._pathJoinRoom.int32_schedule_tls=o,this._pathJoinRoom.int32_schedule_request=s,this._pathJoinRoom.int32_schedule_response=a;}}handleSignalConnectionStart(e){let{room:t}=e;this.hitTest(t)&&0===this._pathJoinRoom.uint64_send_request_acc_ip_cmd_start_time&&(this._pathJoinRoom.uint64_send_request_acc_ip_cmd_start_time=Date.now());}handleSignalConnectionEnd(e){let{room:t,error:i}=e;this.hitTest(t)&&0===this._pathJoinRoom.uint64_send_request_acc_ip_cmd_end_time&&(this._pathJoinRoom.uint64_send_request_acc_ip_cmd_end_time=Date.now(),i&&(this._pathJoinRoom.int32_send_request_acc_ip_cmd_ret=i instanceof tb?Number(i.getExtraCode()||i.getCode()):ZC.UNKNOWN,this._pathJoinRoom.int32_end_ret=this._pathJoinRoom.int32_send_request_acc_ip_cmd_ret));}handleJoinSendCMD(e){this.hitTest(e.room)&&0===this._pathJoinRoom.uint64_send_request_enter_room_cmd_start_time&&(this._pathJoinRoom.uint64_send_request_enter_room_cmd_start_time=Date.now());}handleJoinReceivedCMDResponce(e){this.hitTest(e.room)&&0===this._pathJoinRoom.uint64_send_request_enter_room_cmd_end_time&&(this._pathJoinRoom.uint64_send_request_enter_room_cmd_end_time=Date.now(),this._pathJoinRoom.int32_send_request_enter_room_cmd_ret=e.code,0!==e.code&&(this._pathJoinRoom.int32_end_ret=this._pathJoinRoom.int32_send_request_enter_room_cmd_ret));}handleJoinSuccess(e){this.hitTest(e.room)&&0===this._pathJoinRoom.uint64_end_time&&(this._pathJoinRoom.uint64_end_time=Date.now(),this._pathJoinRoom.int32_end_ret=0,this._signalInfo=e.room.getSignalInfo());}handleJoinFailed(e){let{room:t,error:i}=e;this.hitTest(t)&&(this._pathJoinRoom.uint64_end_time=Date.now(),0===this._pathJoinRoom.int32_end_ret&&(this._pathJoinRoom.int32_end_ret=i.code||this._pathJoinRoom.int32_send_request_enter_room_cmd_ret||this._pathJoinRoom.int32_send_request_acc_ip_cmd_ret),setTimeout((()=>{this.report();})));}handleReceivedPublishUserList(e){this.hitTest(e.room)&&0===this._pathJoinRoom.uint64_recv_userlist_time&&(this._pathJoinRoom.uint64_recv_userlist_time=Date.now(),this._firstPublishedUserList=e.publishedUserList||[]);}handleSendFirstVideoFrame(e){let{room:t}=e;!this.hitTest(t)||0===this._pathJoinRoom.uint64_send_first_video_frame_time&&0!==this._pathJoinRoom.uint64_start_time&&(this._pathJoinRoom.uint64_send_first_video_frame_time=Date.now());}handleLeaveStart(e){this.hitTest(e.room)&&(this._pathLeaveRoom.uint64_start_time=Date.now());}handleLeaveSuccess(e){this.hitTest(e.room)&&0===this._pathLeaveRoom.uint64_end_time&&(this._pathLeaveRoom.uint64_end_time=Date.now(),0!==this._pathJoinRoom.uint64_end_time?this._basicInfo.uint32_joining_duration=this._pathLeaveRoom.uint64_end_time-this._pathJoinRoom.uint64_end_time:this._log.warn("pathJoinRoom endTime is 0"),this.report());}handleLeaveSendCMD(e){this.hitTest(e.room)&&(this._pathLeaveRoom.uint64_send_request_exit_room_cmd_start_time=Date.now(),this._pathLeaveRoom.uint64_send_request_exit_room_cmd_end_time=Date.now());}handleRemoteStreamAdded(e,t){var i;let r="".concat(e,"_").concat(t);if(!this._remoteStreamStatMap.has(r)){let n={userId:e,totalVideoFPS:0,totalVideoBitrate:0,totalAudioLevel:0,totalAudioBitrate:0,totalLoss:0,audioCount:0,audioLevelCount:0,videoCount:0,networkQualityCount:0,streamAddedTime:Date.now(),subscribeStartTime:0,subscribedTime:0,playStreamTime:0,statsToReport:MC(PC({},hF),{msg_user_info:new pF({userId:e,tinyId:null==(i=this._room.remotePublishedUserMap.get(e))?void 0:i.tinyId,role:20})})};n.statsToReport.uint32_stream_type="main"===t?2:7,this._remoteStreamStatMap.set(r,n);}}handleSubscribeStart(e){let{room:t,remotePublishedUser:i,streamType:r,subscribeState:n}=e;if(!this.hitTest(t))return;let{userId:o,tinyId:s,role:a}=i,c=new pF({userId:o,tinyId:s,role:"anchor"===a?20:21}),l=Date.now(),d="".concat(o,"_").concat(r),u=this._remoteStreamStatMap.get(d);u&&0===u.subscribeStartTime&&(u.subscribeStartTime=l),"main"===r?(i.muteState.hasVideo&&(n.video||n.smallVideo)&&!this._pathMainVideoMap.has(d)&&this._pathMainVideoMap.set(d,{statsToReport:{msg_user_info:c,uint64_start_enter_time:this._pathJoinRoom.uint64_start_time,uint64_render_first_frame_time:0,uint64_combine_first_frame_time:0},userId:o,sendSubscribeCMDTime:l}),i.muteState.hasAudio&&n.audio&&!this._pathMainAudioMap.has(d)&&this._pathMainAudioMap.set(d,{statsToReport:{msg_user_info:c,uint64_start_enter_time:this._pathJoinRoom.uint64_start_time,uint64_play_first_frame_time:0},userId:o,sendSubscribeCMDTime:l})):i.muteState.hasAuxiliary&&n.auxiliary&&!this._pathAuxiliaryMap.has(d)&&this._pathAuxiliaryMap.set(d,{sendSubscribeCMDTime:l});}handleSubscribed(e){let{room:t,remotePublishedUser:i,streamType:r}=e;if(this.hitTest(t)){let e="".concat(i.userId,"_").concat(r),t=this._remoteStreamStatMap.get(e);t&&0===t.subscribedTime&&(t.subscribedTime=Date.now());}}handlePlayStart(e){let{track:t}=e;if(!Dw(t)||!this.hitTest(t.room))return;let i="".concat(t.userId,"_").concat(t.streamType),r=this._remoteStreamStatMap.get(i);0===(null==r?void 0:r.playStreamTime)&&(r.playStreamTime=Date.now());}handleVideoLoadedData(e){let{track:t}=e;if(!Dw(t)||!this.hitTest(t.room))return;let i="".concat(t.userId,"_").concat(t.streamType),r=this._pathMainVideoMap.get(i);r&&0===r.statsToReport.uint64_combine_first_frame_time&&(r.statsToReport.uint64_combine_first_frame_time=Date.now());}handleVideoPlaying(e){let t="".concat(e.userId,"_").concat(e.streamType),i=Date.now(),r=this._pathMainVideoMap.get(t),n=this._remoteStreamStatMap.get(t);if(r&&(0===r.statsToReport.uint64_render_first_frame_time&&(r.statsToReport.uint64_render_first_frame_time=i),n)){let{statsToReport:e,playStreamTime:t,subscribedTime:o}=n;0===e.uint32_video_render_first&&t-o<=100&&(e.uint32_video_render_first=i-r.sendSubscribeCMDTime);}let o=this._pathAuxiliaryMap.get(t);if(o&&n){let{statsToReport:e,playStreamTime:t,subscribedTime:r}=n;0===e.uint32_video_render_first&&t-r<=100&&(e.uint32_video_render_first=i-o.sendSubscribeCMDTime);}}handleAudioPlaying(e){let t="".concat(e.userId,"_").concat(e.streamType),i=this._pathMainAudioMap.get(t);i&&0===i.statsToReport.uint64_play_first_frame_time&&(i.statsToReport.uint64_play_first_frame_time=Date.now());}handleNetworkQuality(e){this.hitTest(e.room)&&(this._networkQuality.totalUplinkLoss+=e.uplink.loss,this._networkQuality.totalUplinkRTT+=e.uplink.rtt,this._networkQuality.count++,e.downlinks.forEach((e=>{let{rtt:t,loss:i,userId:r,videoDelay:n,audioDelay:o}=e,s=this._networkQuality.totalDownlinkRTTAndLossMap.get(r);if(s)s.totalRTT+=t,s.totalLoss+=i,n&&(s.totalVideoDelay=(s.totalVideoDelay||0)+n,s.videoDelayCount=(s.videoDelayCount||0)+1),o&&(s.totalAudioDelay=(s.totalAudioDelay||0)+o,s.audioDelayCount=(s.audioDelayCount||0)+1),s.count++;else {let e,s,a,c;n&&(s=n,a=1),o&&(e=o,c=1),this._networkQuality.totalDownlinkRTTAndLossMap.set(r,{totalRTT:t,totalLoss:i,count:1,totalAudioDelay:e,totalVideoDelay:s,audioDelayCount:c,videoDelayCount:a});}})));}handleHeartbeatStats(e){if(this.hitTest(e.room)){let{msg_device_info:t,msg_up_stream_info:i,msg_down_stream_info:r}=e.report;if(i.msg_video_status[0]){let{uint32_video_codec_bitrate:e,uint32_video_enc_fps:t,uint32_video_width:r,uint32_video_height:n}=i.msg_video_status[0];this._localStreamStat.totalVideoBitrate+=e,this._localStreamStat.totalVideoFPS+=t,this._localStreamStat.totalVideoWidth+=r,this._localStreamStat.totalVideoHeight+=n,this._localStreamStat.videoCount++;}if(i.msg_audio_status){let{uint32_audio_level:e}=i.msg_audio_status;Math.floor(e/Kk*100)>0&&(this._localStreamStat.totalAudioLevel+=e/Kk,this._localStreamStat.audioLevelCount++);}r.forEach((e=>{let{msg_user_info:t,msg_audio_status:i,msg_video_status:r}=e,n=t.str_identifier,o=this._room.remotePublishedUserMap.get(n);if(r.forEach((e=>{let t=2===e.uint32_video_stream_type,i=7===e.uint32_video_stream_type,r="".concat(n,"_").concat(t?"main":"auxiliary"),s=this._remoteStreamStatMap.get(r);if(s&&(t&&(null==o?void 0:o.remoteVideoTrack.isSubscribed)||i&&(null==o?void 0:o.remoteAuxiliaryTrack))){s.totalVideoFPS+=e.uint32_video_receive_fps,s.totalVideoBitrate+=e.uint32_video_codec_bitrate,s.videoCount++,0===s.statsToReport.uint32_video_width&&(s.statsToReport.uint32_video_width=e.uint32_video_width),0===s.statsToReport.uint32_video_height&&(s.statsToReport.uint32_video_height=e.uint32_video_height);let i=t?o.remoteVideoTrack:o.remoteAuxiliaryTrack;i.stat.jitterBufferDelay&&(s.videoJitterBufferDelay=i.stat.jitterBufferDelay),i.stat.framesReceived&&(s.statsToReport.uint32_video_consume_render_rate=Math.floor(i.stat.framesDecoded/i.stat.framesReceived*wC(10,6)));}})),i){let e="".concat(n,"_","main"),t=this._remoteStreamStatMap.get(e);this._remoteStreamStatMap.has(e)&&t&&(null==o?void 0:o.remoteAudioTrack.isSubscribed)&&(t.totalAudioBitrate+=i.uint32_audio_codec_bitrate,t.audioCount++,o.remoteAudioTrack.stat.jitterBufferDelay&&(t.audioJitterBufferDelay=o.remoteAudioTrack.stat.jitterBufferDelay),Math.floor(i.uint32_audio_level/Kk*100)>0&&(t.totalAudioLevel+=i.uint32_audio_level/Kk,t.audioLevelCount++));}})),t.uint32_audio_capture_cost&&(this._captureCostSum+=t.uint32_audio_capture_cost,this._captureCostCount+=1,this._captureCostCount>=100&&(this._basicInfo.uint32_audio_capture_cost=Math.floor(this._captureCostSum/this._captureCostCount),this._captureCostSum=0,this._captureCostCount=0));}}handlePublishStart(e){let{room:t}=e;this.hitTest(t)&&0===this._localStreamStat.publishStartTime&&(this._localStreamStat.publishStartTime=Date.now());}handleTrackCaptureStart(e){let{track:t}=e;1===t.mediaType&&!this._pathJoinRoom.uint64_init_audio_start_time&&(this._pathJoinRoom.uint64_init_audio_start_time=Date.now()),4===t.mediaType&&!this._pathJoinRoom.uint64_init_camera_start_time&&(this._pathJoinRoom.uint64_init_camera_start_time=Date.now());}handleTrackCaptureSuccess(e){let{track:t}=e;1===t.mediaType&&!this._pathJoinRoom.uint64_init_audio_end_time&&(this._pathJoinRoom.int32_init_audio_ret=0,this._pathJoinRoom.uint64_init_audio_end_time=Date.now()),4===t.mediaType&&!this._pathJoinRoom.uint64_init_camera_end_time&&(this._pathJoinRoom.int32_init_camera_ret=0,this._pathJoinRoom.uint64_init_camera_end_time=Date.now());}handleTrackCaptureFailed(e){let{track:t,error:i}=e,r={NotFoundError:1,NotAllowedError:2,NotReadableError:3,OverConstrainedError:4,AbortError:5,InvalidStateError:6,SecurityError:7,TypeError:8}[i.name]||(i instanceof tb?i.getExtraCode()||i.getCode():ZC.UNKNOWN);1===t.mediaType&&!this._pathJoinRoom.uint64_init_audio_end_time&&(this._pathJoinRoom.int32_init_audio_ret=r,this._pathJoinRoom.uint64_init_audio_end_time=Date.now()),4===t.mediaType&&!this._pathJoinRoom.uint64_init_camera_end_time&&(this._pathJoinRoom.int32_init_camera_ret=r,this._pathJoinRoom.uint64_init_camera_end_time=Date.now());}hasVideoFlag(e){return this._firstPublishedUserList.findIndex((t=>t.userId===e&&t.flag&jb))>=0}hasAudioFlag(e){return this._firstPublishedUserList.findIndex((t=>t.userId===e&&t.flag&Jb))>=0}hasAuxFlag(e){return this._firstPublishedUserList.findIndex((t=>t.userId===e&&t.flag&Gb))>=0}hitTest(e){return e===this._room}prepareReport(){if(this._captureCostCount>0&&!this._basicInfo.uint32_audio_capture_cost&&(this._basicInfo.uint32_audio_capture_cost=Math.floor(this._captureCostSum/this._captureCostCount),this._captureCostSum=0,this._captureCostCount=0),this._networkQuality.count>0&&(this._basicInfo.uint32_avg_rtt=Math.floor(this._networkQuality.totalUplinkRTT/this._networkQuality.count),this._basicInfo.uint32_avg_up_loss=Math.floor(this._networkQuality.totalUplinkLoss/this._networkQuality.count)),this._localStreamStat.videoCount>0){this._localStreamStat.statsToReport.uint32_video_big_capture_fps=Math.floor(this._localStreamStat.totalVideoFPS/this._localStreamStat.videoCount),this._localStreamStat.statsToReport.uint32_video_big_bitrate=Math.floor(this._localStreamStat.totalVideoBitrate/this._localStreamStat.videoCount);let e=Math.floor(this._localStreamStat.totalVideoWidth/this._localStreamStat.videoCount),t=Math.floor(this._localStreamStat.totalVideoHeight/this._localStreamStat.videoCount);this._localStreamStat.statsToReport.uint32_video_big_resolution=e<<16|t;}this._localStreamStat.audioLevelCount>0&&(this._localStreamStat.statsToReport.uint32_audio_capture_db=Math.floor(this._localStreamStat.totalAudioLevel/this._localStreamStat.audioLevelCount*100)),this._remoteStreamStatMap.forEach(((e,t)=>{let{userId:i}=e,r=this._networkQuality.totalDownlinkRTTAndLossMap.get(i);if(r){let{totalLoss:t,count:i,audioDelayCount:n,videoDelayCount:o,totalAudioDelay:s,totalVideoDelay:a}=r;e.statsToReport.uint32_avg_down_loss=Math.floor(t/i),n&&s&&(e.statsToReport.uint32_audio_network_p2p_delay=Math.floor(s/n),e.audioJitterBufferDelay&&(e.statsToReport.uint32_p2p_delay=Math.floor(e.statsToReport.uint32_audio_network_p2p_delay+e.audioJitterBufferDelay))),o&&a&&(e.statsToReport.uint32_video_network_p2p_delay=Math.floor(a/o));}e.videoCount>0&&(e.statsToReport.uint32_video_avg_fps=Math.floor(e.totalVideoFPS/e.videoCount),e.statsToReport.uint32_video_avg_bitrate=Math.floor(e.totalVideoBitrate/e.videoCount)),e.audioCount>0&&(e.statsToReport.uint32_audio_recv_bitrate=e.statsToReport.uint32_audio_bitrate=Math.floor(e.totalAudioBitrate/e.audioCount)),e.audioLevelCount>0&&(e.statsToReport.uint32_audio_play_db=Math.floor(e.totalAudioLevel/e.audioLevelCount*100));let{callDurationCalculator:n}=this._room;n&&(e.statsToReport.uint32_audio_play_time=n.getDuration(t,Ub.AUDIO),e.statsToReport.uint32_video_play_time=n.getDuration(t,Ub.VIDEO)),e.statsToReport.uint32_video_render_first=Math.min(e.statsToReport.uint32_video_render_first,uF);let{badCaseDetector:o}=this._room,{dataFreeze:s,count:a}=o.getDataFreezeDuration(t),{renderFreeze:c}=o.getRenderFreezeDuration(t);e.statsToReport.uint32_video_block_count=a,e.statsToReport.uint32_video_block_time=Math.min(s,e.statsToReport.uint32_video_play_time),e.statsToReport.uint32_video_external_block_time=Math.min(c,e.statsToReport.uint32_video_play_time),o.isBlackStream(t)&&0===e.statsToReport.uint32_video_avg_fps?e.statsToReport.uint32_video_black_screen_subjective=1:e.statsToReport.uint32_video_black_screen_subjective=0,(0===e.subscribeStartTime||e.subscribeStartTime-e.streamAddedTime>100||0===e.playStreamTime)&&(this._pathMainAudioMap.delete(t),this._pathMainVideoMap.delete(t),e.statsToReport.uint32_video_render_first=0);})),this._pathMainAudioMap.forEach(((e,t)=>{this.hasAudioFlag(e.userId)?e.statsToReport.uint64_play_first_frame_time-e.statsToReport.uint64_start_enter_time>uF&&(e.statsToReport.uint64_play_first_frame_time=e.statsToReport.uint64_start_enter_time+uF):this._pathMainAudioMap.delete(t);})),this._pathMainVideoMap.forEach(((e,t)=>{this.hasVideoFlag(e.userId)?e.statsToReport.uint64_render_first_frame_time-e.statsToReport.uint64_start_enter_time>uF&&(e.statsToReport.uint64_render_first_frame_time=e.statsToReport.uint64_start_enter_time+uF):this._pathMainVideoMap.delete(t);})),this._pathJoinRoom.uint64_end_time-this._pathJoinRoom.uint64_start_time>uF&&(this._pathJoinRoom.uint64_end_time=this._pathJoinRoom.uint64_start_time+uF);}getReportData(){this._basicInfo.uint32_networkType=lw();let e={uint32_sdk_app_id:Number(this._room.sdkAppId),msg_user_info:new pF({userId:this._room.userId,tinyId:this._room.tinyId,role:"anchor"===this._room.role?20:21}),msg_basic_info:this._basicInfo,uint32_acc_ip:jw(this._signalInfo.relayIp),uint32_client_ip:jw(this._signalInfo.clientIp,!1),uint32_acc_port:this._signalInfo.relayPort||0,uint64_timestamp:Date.now(),uint32_seq:Math.floor(Math.random()*wC(2,31)),msg_path_enter_room:this._pathJoinRoom,msg_path_exit_room:this._pathLeaveRoom,msg_path_recv_video:[...this._pathMainVideoMap.values()].map((e=>e.statsToReport)),msg_quality_statistics:[...this._remoteStreamStatMap.values()].map((e=>e.statsToReport)),str_room_name:String(this._room.roomId||0),msg_path_recv_audio:[...this._pathMainAudioMap.values()].map((e=>e.statsToReport)),uint32_info_client_ip:jw(this._signalInfo.clientIp,!1),error_code:[],msg_local_statistics:this._localStreamStat.statsToReport};return eO(e),e}report(){return HC(this,null,(function*(){try{this.prepareReport();let e=this.getReportData();yield this.upload(e),this.initData();}catch(hO){this._log.warn(hO);}finally{this.isDestroyed&&(this._room=null);}}))}upload(e){return HC(this,null,(function*(){if(0===e.msg_path_enter_room.uint64_start_time)return;let t=Number(this._room.sdkAppId),i=yield Jk(e),r=i instanceof ArrayBuffer,n="".concat(nw(t,bb.KEY_POINT),"&gzip=").concat(+r),o=!1;navigator.sendBeacon&&(o=navigator.sendBeacon(n,i));let s=[this.uploadKVStat(IO),this.uploadKVStat(SO)];o||s.push(Gk({url:n,body:i})),yield Promise.all(s);}))}setConnectionType(e){this.connectionType=e,this._basicInfo.uint32_connection_type=e;}uploadKVStat(e){return HC(this,null,(function*(){let t=e.getReportData();if(0===t.stats_count.length&&0===t.stats_distribution.length)return;t.msg_sdk_basic_info=MC(PC({},t.msg_sdk_basic_info),{bytes_device_name:this._basicInfo.string_device_name||"",bytes_os_version:this._basicInfo.string_os_version||"",uint32_framework:this._frameWorkType,uint32_network_type:this._basicInfo.uint32_networkType||0}),this._log.debug(t);let i=yield Jk(t),r="".concat(nw(+this._room.sdkAppId,bb.KV_STAT),"&gzip=").concat(+(i instanceof ArrayBuffer)),n=!1;navigator.sendBeacon&&(n=navigator.sendBeacon(r,i)),n||Gk({url:r,body:i});}))}};UC([VP({settings:{timeout:500,retries:3}})],dF.prototype,"upload",1);var uF=5e3,hF={msg_user_info:null,uint32_video_avg_fps:0,uint32_video_width:0,uint32_video_height:0,uint32_video_avg_bitrate:0,uint32_video_block_time:0,uint32_video_play_time:0,uint32_audio_block_time:0,uint32_audio_play_time:0,uint32_audio_play_db:0,uint32_avg_down_loss:0,uint32_stream_type:0,uint32_video_render_first:0,uint32_video_block_count:0,uint32_audio_block_count:0,uint32_audio_bitrate:0,uint32_video_black_screen_subjective:0,uint32_audio_recv_bitrate:0,uint32_video_external_block_time:0,uint32_video_consume_render_rate:0},pF=class{constructor(e){this.str_identifier=String(e.userId),this.str_tinyid=String(e.tinyId||0),this.uint32_role=e.role;}},mF=dF,_F=class{constructor(){FC(this,"_startTime"),FC(this,"_endTime"),this._startTime=0,this._endTime=0,this.start();}start(){0===this._startTime&&(this._startTime=Lw());}stop(){0===this._endTime&&(this._endTime=Lw());}getDuration(){return 0===this._endTime?Lw()-this._startTime:this._endTime-this._startTime}get endTime(){return this._endTime}},fF=class{constructor(e){FC(this,"_room",null),FC(this,"_durationMap"),FC(this,"_eventMap",new Map),this._room=e.room,this._durationMap=new Map,this.installEvents();}installEvents(){this._eventMap.set(nO.SUBSCRIBE_SUCCESS,this.handleSubscribed).set(nO.UNSUBSCRIBE_SUCCESS,this.handleStreamStopped).set(nO.REMOTE_PUBLISH_STATE_CHANGED,(e=>{let{room:t,prevMuteState:i,muteState:r}=e;var n;let{userId:o}=r;if(!this.hitTest(t))return;i.hasAudio&&!r.hasAudio&&this.stopDurationItem("".concat(o,"_","main"),Ub.AUDIO),i.hasVideo&&!r.hasVideo&&this.stopDurationItem("".concat(o,"_","main"),Ub.VIDEO),i.hasAuxiliary&&!r.hasAuxiliary&&this.stopDurationItem("".concat(o,"_","auxiliary"),Ub.VIDEO);let s=null==(n=this._room)?void 0:n.remotePublishedUserMap.get(o);!s||(!i.hasAudio&&r.hasAudio&&s.remoteAudioTrack.isSubscribed&&this.addDuractionItem(o,Ub.AUDIO,"main"),!i.hasVideo&&r.hasVideo&&s.remoteVideoTrack.isSubscribed&&this.addDuractionItem(o,Ub.VIDEO,"main"),!i.hasAuxiliary&&r.hasAuxiliary&&s.remoteAuxiliaryTrack.isSubscribed&&this.addDuractionItem(o,Ub.VIDEO,"auxiliary"));})),this._eventMap.forEach(((e,t)=>jN.on(t,e,this)));}uninstallEvents(){this._eventMap.forEach(((e,t)=>jN.off(t,e,this))),this._eventMap.clear();}handleSubscribed(e){let{room:t,streamType:i,remotePublishedUser:r}=e;if(!this.hitTest(t))return;let{userId:n}=r,o="".concat(n,"_").concat(i);if(r.muteState.hasAudio&&"main"===i)if(r.remoteAudioTrack.isSubscribed){let e=new _F,t=this._durationMap.get(o);t?this.isRecording(t.audio)||t.audio.push(e):this._durationMap.set(o,{userId:n,type:i,audio:[e],video:[]});}else this.stopDurationItem(o,Ub.AUDIO);if(r.muteState.hasVideo||r.muteState.hasAuxiliary)if(r.remoteVideoTrack.isSubscribed||r.remoteAuxiliaryTrack.isSubscribed){let e=new _F,t=this._durationMap.get(o);t?this.isRecording(t.video)||t.video.push(e):this._durationMap.set(o,{userId:n,type:i,audio:[],video:[e]});}else this.stopDurationItem(o,Ub.VIDEO);}handleStreamStopped(e){let{room:t,streamType:i,remotePublishedUser:r}=e;if(!this.hitTest(t))return;let{userId:n}=r,o="".concat(n,"_").concat(i);this.stopDurationItem(o,Ub.AUDIO),this.stopDurationItem(o,Ub.VIDEO);}isRecording(e){return e.findIndex((e=>0===e.endTime))>=0}addDuractionItem(e,t,i){let r="".concat(e,"_").concat(i),n=new _F,o=this._durationMap.get(r);o?this.isRecording(o[t])||o[t].push(n):this._durationMap.set(r,{userId:e,type:i,audio:t===Ub.AUDIO?[n]:[],video:t===Ub.AUDIO?[]:[n]});}stopDurationItem(e,t){if(this._durationMap.has(e)){let i=this._durationMap.get(e)[t].find((e=>0===e.endTime));i&&i.stop();}}hitTest(e){return this._room===e}getDuration(e,t){return this._durationMap.has(e)?this._durationMap.get(e)[t].reduce(((e,t)=>e+t.getDuration()),0):0}getDurationMap(){return this._durationMap}reset(){this._durationMap.clear();}destroy(){this._room=null,this.uninstallEvents();}},gF=class{constructor(e){FC(this,"_room"),FC(this,"_renderFreezeMap",new Map),FC(this,"_isVideoPlayingEventFiredMap",new Map),FC(this,"_dataFreezeMap",new Map),FC(this,"_monitorFreezeData",new Map),FC(this,"_eventMap",new Map),this._room=e.room,this.installEvents();}installEvents(){this._eventMap.set(nO.LEAVE_SUCCESS,(e=>{let{room:t}=e;this.hitTest(t)&&this.stop();})).set(nO.PLAY_TRACK_START,this.onPlayTrackStart).set(nO.UNSUBSCRIBE_SUCCESS,(e=>{let{room:t,streamType:i,remotePublishedUser:r}=e;if(!this.hitTest(t))return;let{userId:n}=r,o="".concat(n,"_").concat(i);this.stopDataFreeze({key:o,userId:n,type:i});})).set(nO.REMOTE_PUBLISH_STATE_CHANGED,(e=>{let{room:t,prevMuteState:i,muteState:r}=e;if(!this.hitTest(t))return;let{userId:n}=r;if(i.hasVideo&&!r.hasVideo){let e="main",t="".concat(r.userId,"_").concat(e);this.stopDataFreeze({key:t,userId:n,type:e});}if(i.hasAuxiliary&&!r.hasAuxiliary){let e="auxiliary",t="".concat(r.userId,"_").concat(e);this.stopDataFreeze({key:t,userId:n,type:e});}})).set(nO.PLAYER_STATE_CHANGED,(e=>{let{track:t,state:i,reason:r,type:n}=e;if(Dw(t)&&this.hitTest(t.room)&&n===Ub.VIDEO){if("PLAYING"===i){let e="".concat(t.userId,"_").concat(t.streamType);this._isVideoPlayingEventFiredMap.set(e,!0);}r===Ub.MUTE?this.onVideoTrackMuted(t):r===Ub.UNMUTE&&this.onVideoTrackUnmuted(t);}})).set(nO.HEARTBEAT_REPORT,this.onHearBeatReport),this._eventMap.forEach(((e,t)=>jN.on(t,e,this)));}uninstallEvents(){this._eventMap.forEach(((e,t)=>jN.off(t,e,this))),this._eventMap.clear();}stop(){this._renderFreezeMap.clear(),this._dataFreezeMap.clear(),this._isVideoPlayingEventFiredMap.clear();}onVideoTrackMuted(e){if(!e.isSubscribed)return;let{userId:t,streamType:i}=e,r="".concat(t,"_").concat(i),n=this._dataFreezeMap.get(r),o=new _F;n?n.durationItemList.push(o):this._dataFreezeMap.set(r,{userId:t,type:i,durationItemList:[o],isFreezing(){let e=this.durationItemList[this.durationItemList.length-1];return e&&0===e.endTime}});}onVideoTrackUnmuted(e){if(!e.isSubscribed)return;let{userId:t,streamType:i}=e,r="".concat(t,"_").concat(i);this.stopDataFreeze({key:r,userId:t,type:i});}onHearBeatReport(e){let{room:t,report:i}=e;!this.hitTest(t)||i.msg_down_stream_info.forEach((e=>{let t=this._room.remotePublishedUserMap.get(e.msg_user_info.str_identifier);if(!t)return;let{userId:i,muteState:r}=t;e.msg_video_status.forEach((e=>{2===e.uint32_video_stream_type&&r.hasVideo&&!r.videoMuted&&t.remoteVideoTrack.isSubscribed&&this.handleRenderFreeze({userId:i,fps:e.uint32_video_dec_fps,type:"main"}),7===e.uint32_video_stream_type&&r.hasAuxiliary&&t.remoteAuxiliaryTrack.isSubscribed&&this.handleRenderFreeze({userId:i,fps:e.uint32_video_dec_fps,type:"auxiliary"});}));}));}stopDataFreeze(e){let{key:t,userId:i,type:r}=e,n=this._dataFreezeMap.get(t);if(!n||!n.isFreezing())return;let o=n.durationItemList[n.durationItemList.length-1];o.stop();let s=o.getDuration();s>Sk?this._monitorFreezeData.set(t,{userId:i,type:r,duration:s}):n.durationItemList.pop();}getTotalDuration(e){return e.reduce(((e,t)=>{let i=t.getDuration();return e+Math.min(i,5e3)}),0)}handleRenderFreeze(e){return HC(this,arguments,(function(e){var t=this;let{userId:i,fps:r,type:n}=e;return function*(){let e="".concat(i,"_").concat(n),o=t._renderFreezeMap.get(e);if(r<=2){let r=Lw();o&&!o.isFreeze&&(o.freezeTimeline.push({startTime:r,endTime:0}),o.isFreeze=!0),o||t._renderFreezeMap.set(e,{userId:i,type:n,isFreeze:!0,freezeTimeline:[{startTime:r,endTime:0}],renderFreezeTotal:0});}else if(o&&o.isFreeze){o.isFreeze=!1;let e=o.freezeTimeline.pop();if(e){e.endTime=Lw();let t=e.endTime-e.startTime;o.freezeTimeline.push(e),o.renderFreezeTotal+=Math.min(5e3,t);}}}()}))}onPlayTrackStart(e){let{track:t}=e;if(!Dw(t)||!this.hitTest(t.room)||t.kind!==Ub.VIDEO||t.hasFlag)return;let i="".concat(t.userId,"_").concat(t.streamType);this._isVideoPlayingEventFiredMap.has(i)||this._isVideoPlayingEventFiredMap.set(i,!1);}getDataFreezeDuration(e){let t={dataFreeze:0,count:0},i=this._dataFreezeMap.get(e);if(i){if(i.isFreezing()){let e=i.durationItemList[i.durationItemList.length-1];e.stop(),e.getDuration()<Sk&&i.durationItemList.pop();}t.dataFreeze=this.getTotalDuration(i.durationItemList),t.count=i.durationItemList.length;}return t}getRenderFreezeDuration(e){let t=this._renderFreezeMap.get(e),i=0,r=0;if(t)if(t.isFreeze){let e=Lw()-t.freezeTimeline[t.freezeTimeline.length-1].startTime;i=t.renderFreezeTotal+Math.min(e,5e3),r=t.freezeTimeline.length;}else i=t.renderFreezeTotal;return {renderFreeze:i,count:r}}getMonitorFreeze(){return this._monitorFreezeData}isBlackStream(e){return !!this._isVideoPlayingEventFiredMap.has(e)&&!this._isVideoPlayingEventFiredMap.get(e)}resetMonitor(){this._monitorFreezeData.clear();}hitTest(e){return e===this._room}destroy(){this.uninstallEvents();}},TF=VC(jC(),1),EF=[1,0,0,0,1,1,0,1],vF=class extends NL{constructor(e,t){if(super(e,{useDefaultProgram:!0,useFbo:!0,create2d:!0,name:"mirror",logger:t}),e instanceof vx)try{this.setTexBuffer(EF);}catch(hk){e.destroy(new tb({code:ZC.VIDEO_MANAGER_ERROR,extraCode:3,message:"create video node ".concat(this.name," error ").concat(hk.message||hk)}));}}draw2d(e,t,i,r,n){if(this.ctx2d){this.ctx2d.save(),this.ctx2d.scale(-1,1),this.ctx2d.translate(-this.width,0);let o=super.draw2d(e,t,i,r,n);return this.ctx2d.restore(),o}return !1}render(e){var t;return !(null==(t=this.input)||!t.requestFrame(e))&&(this.useProgram(),this.useBufferFrame(),this.useInputTexture(),this.draw(),!0)}},yF=class{constructor(e,t){this.node=e,this.layout=t,FC(this,"positionBuffer");}get x(){return this.layout.x||this.node.x}get y(){return this.layout.y||this.node.y}get width(){return this.layout.width||this.node.width}get height(){return this.layout.height||this.node.height}get right(){return this.x+this.width}get bottom(){return this.y+this.height}},SF=class extends NL{constructor(e,t){super(e,{useDefaultProgram:!0,useFbo:!0,name:"mix",create2d:!0,logger:t}),FC(this,"inputs",[]);}addInput(e,t){if(this.inputs[t.zIndex])throw new Error("input already exists");let i=new yF(e,t);this.inputs[t.zIndex]=i;}resize(e,t){let i=this.inputs.reduce(((e,t)=>t?Object.assign(e,{width:Math.max(e.width,t.right),height:Math.max(e.height,t.bottom)}):e),{width:0,height:0});super.resize(i.width,i.height),this.context instanceof vx&&this.inputs.forEach((e=>{if(e){let t=this.layout2texCoords(e);e.positionBuffer?this.changeBufferData(e.positionBuffer,t):e.positionBuffer=this.createBuffer(t);}}));}connect(e){for(var t=arguments.length,i=new Array(t>1?t-1:0),r=1;r<t;r++)i[r-1]=arguments[r];return super.connect(e,...i),this.resize(0,0),e}removeInput(e){this.inputs[this.inputs.findIndex((t=>(null==t?void 0:t.node)===e))]=void 0;}render(e){let t=this.context.ctx;if(t.clearColor(0,0,0,0),!this.inputs.reduce(((t,i)=>(!i||!i.node.requestFrame(e))&&t),!0)&&t){this.useProgram(),t.enable(t.BLEND),t.blendFunc(t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA),this.useBufferFrame();for(let e=0;e<this.inputs.length;e++){let t=this.inputs[e];t&&(t.node.useTexture(),this.draw(t.positionBuffer));}return !0}return !1}render2d(e){if(!this.inputs.reduce(((t,i)=>(!i||!i.node.requestFrame(e))&&t),!0)&&this.ctx2d){this.ctx2d.clearRect(0,0,this.width,this.height);for(let e=0;e<this.inputs.length;e++){let t=this.inputs[e];t&&this.draw2d(t.node.image,t.x,t.y,t.width,t.height);}return !0}return !1}getInfo(){let{totalFrames:e,x:t,y:i,width:r,height:n,name:o}=this,s=Date.now(),a=(e-this.lastInfo.totalFrames)/((s-this.lastInfo.timestamp)/1e3)|0;return this.lastInfo={totalFrames:e,x:t,y:i,width:r,height:n,timestamp:s,fps:a,name:o},PC({parent:this.inputs.filter((e=>e)).map((e=>e.node.getInfo()))},this.lastInfo)}close(){super.close(),this.inputs.forEach((e=>{var t,i;if(e&&(null==(t=e.node)||t.disconnect(),e.positionBuffer&&this.context instanceof vx))try{null==(i=this.context.ctx)||i.deleteBuffer(e.positionBuffer);}catch(r){}}));}},IF=class extends gx{constructor(e,t){super(e,t.input,{name:"vb",create2d:!1,useDefaultProgram:!1,useFbo:!1,createTexture:!0,logger:e.log}),FC(this,"_bgTexture"),FC(this,"_waterMarkTexture"),FC(this,"_lastMaskTexture"),FC(this,"_lastMaskFbo"),FC(this,"_textureValid",!1),FC(this,"_selfieTextureValid",!1),FC(this,"_selfieSegmentation"),FC(this,"wasm"),FC(this,"_prePrograme"),FC(this,"_segmentationMask"),FC(this,"_weixin",!1),t.selfieSegmentation&&(this._selfieSegmentation=t.selfieSegmentation,this._selfieSegmentation.onResults=this.onPredict.bind(this));try{this.init(t);}catch(ub){e.log.error(ub),e.destroy(new tb({code:ZC.VIDEO_MANAGER_ERROR,extraCode:6,message:"init vb node error ".concat(ub.message||ub)}));}}init(e){var t,i;let r=e.Wasm,n=this.context.ctx;if(this.wasm=new r.AllIn1(n),this.wasm.blurRadius=e.blurRadius||3,this.wasm.mirror=!!e.mirror,this.wasm.vbMode="blur"===e.bg?1:e.bg instanceof HTMLImageElement?2:"green"===e.bg?3:0,e.waterMark){let{x:t,y:i,width:r,height:n}=e.waterMark;this.wasm.setWaterMark(t,i,r,n);}if(e.beautyParams){let{beauty:r,brightness:n,ruddy:o}=e.beautyParams;this.wasm.setBeauty(r,n,o,null==(t=this.context._canvas)?void 0:t.width,null==(i=this.context._canvas)?void 0:i.height);}if(this.program=this.wasm.init(),this.useProgram(),this.setAttributes(this.positionBuffer,this.texCoordBuffer),n.uniform1i(n.getUniformLocation(this.program,"mask"),1),e.bg instanceof HTMLImageElement&&(n.uniform1i(n.getUniformLocation(this.program,"bg"),2),this._bgTexture=this.createTexture(e.bg)),e.waterMark&&(n.uniform1i(n.getUniformLocation(this.program,"waterMark"),3),this._waterMarkTexture=this.createTexture(e.waterMark.image)),n.uniform1i(n.getUniformLocation(this.program,"lastMask"),4),this._weixin){let e=this.context.createShader(n.FRAGMENT_SHADER,"#version 300 es\nprecision highp float;\nuniform sampler2D u_texture;\nuniform sampler2D mask;\n\nin vec2 v_texCoord;\nout vec4 outColor;\nvoid main() {\n  outColor = vec4(texture(u_texture, v_texCoord).rgb, texture(mask, v_texCoord).a);\n}"),t=this.context.createShader(n.VERTEX_SHADER,"#version 300 es\nin vec2 a_position;\nin vec2 a_texCoord;\nout vec2 v_texCoord;\nvoid main() {\n  gl_Position = vec4(a_position.x, a_position.y, 0, 1);\n  v_texCoord = a_texCoord;\n}");this._prePrograme=this.context.createProgram(t,e),n.useProgram(this._prePrograme),this.setAttributes(this.positionBuffer,this.texCoordBuffer),n.uniform1i(n.getUniformLocation(this._prePrograme,"mask"),1);}}onPredict(e){var t;let i=this.context.ctx;this._weixin&&(this._lastMaskTexture||(this._lastMaskTexture=this.createTexture(this.image),this._lastMaskFbo=this.createFramebuffer(this._lastMaskTexture))),this.useProgram(),this._weixin?this.useTexture():null==this||this._selfieSegmentation.bindTexture(),i.activeTexture(i.TEXTURE1),null==(t=this._selfieSegmentation)||t.bindTexture2d(e),i.activeTexture(i.TEXTURE2),i.bindTexture(i.TEXTURE_2D,this._bgTexture||null),i.activeTexture(i.TEXTURE3),i.bindTexture(i.TEXTURE_2D,this._waterMarkTexture||null),this.useBufferFrame(),i.drawArrays(i.TRIANGLE_STRIP,0,4),this._segmentationMask=e,this.totalFrames++;}render(e){var t,i,r,n;let o=this.context.ctx,{image:s}=this;this.tryVideoFrameCallback(s);let{videoWidth:a,videoHeight:c}=s;s.width=a,s.height=c;let l=!1;if(this.totalFrames)this._weixin?this.useTexture():null==(t=this._selfieSegmentation)||t.bindTexture(),l=this._selfieTextureValid,this._selfieTextureValid=!0;else {if(!this.program)return !1;this.useTexture(),l=this._textureValid,this._textureValid=!0;}return this.width===a&&this.height===c&&l?o.texSubImage2D(o.TEXTURE_2D,0,0,0,o.RGBA,o.UNSIGNED_BYTE,s):(this.resize(a,c),o.texImage2D(o.TEXTURE_2D,0,o.RGBA,o.RGBA,o.UNSIGNED_BYTE,s)),this._weixin&&(o.useProgram(this._prePrograme),this.useTexture(),this._segmentationMask&&(o.activeTexture(o.TEXTURE1),null==(i=this._selfieSegmentation)||i.bindTexture2d(this._segmentationMask),o.bindFramebuffer(o.FRAMEBUFFER,this._lastMaskFbo||null)),o.drawArrays(o.TRIANGLE_STRIP,0,4),null==(r=this._selfieSegmentation)||r.bindTexture(),this._segmentationMask?o.copyTexSubImage2D(o.TEXTURE_2D,0,0,0,0,0,a,c):o.copyTexImage2D(o.TEXTURE_2D,0,o.RGBA,0,0,a,c,0)),null==(n=this._selfieSegmentation)||n.send(a,c),this.totalFrames||(o.activeTexture(o.TEXTURE2),o.bindTexture(o.TEXTURE_2D,this._bgTexture||null),o.activeTexture(o.TEXTURE3),o.bindTexture(o.TEXTURE_2D,this._waterMarkTexture||null),o.drawArrays(o.TRIANGLE_STRIP,0,4)),!1}close(){var e;super.close();let t=this.context.ctx;this._bgTexture&&t.deleteTexture(this._bgTexture),this._waterMarkTexture&&t.deleteTexture(this._waterMarkTexture),this._lastMaskTexture&&t.deleteTexture(this._lastMaskTexture),this._lastMaskFbo&&t.deleteFramebuffer(this._lastMaskFbo),this._prePrograme&&t.deleteProgram(this._prePrograme),null==(e=this.wasm)||e.close();}},RF=class extends TF.EventEmitter{constructor(e){super(),this.room=e,FC(this,"videoContext"),FC(this,"_glVideoContext"),FC(this,"_2dVideoContext"),FC(this,"destination"),FC(this,"smallVideoContext"),FC(this,"smallDestination"),FC(this,"smallTrackSource"),FC(this,"smallImageSource"),FC(this,"_isMirror",!1),FC(this,"cameraTrack"),FC(this,"cameraNode"),FC(this,"mirrorNode"),FC(this,"mixNode"),FC(this,"screenTrack"),FC(this,"screenNode"),FC(this,"selfModel",!1),FC(this,"blurRadius",3),FC(this,"arTrack"),FC(this,"Wasm"),FC(this,"waterMarkNode"),FC(this,"_waterMarkOption"),FC(this,"watermarkImageList",[]),FC(this,"_beautyParams"),FC(this,"isUsingArTrack",!1),FC(this,"_isMixScreen",!1),FC(this,"_virtualBackground"),FC(this,"_virtualBackgroundAbortCallback"),FC(this,"virtualBackgroundInstance"),FC(this,"_bgAssetPath"),FC(this,"log",sO.createLogger({id:"vm"})),FC(this,"_checkId",0),FC(this,"_use2d",!1),FC(this,"_autoSwitchRenderMode",!0),FC(this,"_selfieSegmentation"),FC(this,"encodePipeline",[]),FC(this,"decodePipeline",[]),e&&(this.log.setUserId(e.userId),this.log.setSdkAppId(e.sdkAppId)),this.smallVideoContext=new yx({frameRate:15,logger:this.log,name:"s"}),this.enablePrintDetail();}get _hasVirtualBg(){return !!this._virtualBackground}get _hasWaterMark(){return this.watermarkImageList.length>0}get renderMode(){return this._autoSwitchRenderMode?"auto":this._use2d?"2d":"webgl"}set renderMode(e){if(this._autoSwitchRenderMode="auto"===e,this._autoSwitchRenderMode)return;let t="2d"===e;this._use2d!==t&&(this._use2d=t,this.clear(),this.videoContext=this._use2d?this.get2dVideoContext():this.getGlVideoContext(),this.update());}get2dVideoContext(){return this._2dVideoContext?this._2dVideoContext.destroy():this._2dVideoContext=new yx({frameRate:15,logger:this.log,name:"m"}),this._2dVideoContext.create({alpha:this._hasWaterMark||this._hasVirtualBg}),this._2dVideoContext}getGlVideoContext(){if(this._glVideoContext){if(this._glVideoContext.available)return this._glVideoContext}else this._glVideoContext=new vx({frameRate:15,logger:this.log,name:"m"});return this.initializeGlVideoContext(),this._glVideoContext}initializeGlVideoContext(){try{this._glVideoContext.create(),this._glVideoContext.on("unavailable",(e=>{var t;this.emit("error",e),this.log.warn("video context unavailable",e),null==(t=this._virtualBackgroundAbortCallback)||t.call(this,e),this.update();}));}catch(db){this.emit("error",db);}}enablePrintDetail(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:2e3;this._checkId=NP.run(Bk,(()=>{this.destination&&this.log.debug(this.destination.getInfo());}),{delay:e});}destroy(){var e,t;null==(e=this._2dVideoContext)||e.destroy(),null==(t=this._glVideoContext)||t.destroy(),this.smallVideoContext.destroy(),NP.clearTask(this._checkId);}get needAlpha(){return this._hasWaterMark||this._hasVirtualBg}get active(){return (hN||this._isMixScreen||this._isMirror||this._hasWaterMark||this._hasVirtualBg||this._beautyParams)&&this.checkOrCreateVideoContext()}sendCreateResult(){let e=arguments.length>1?arguments[1]:void 0,t="videoCtxGl"===(arguments.length>0&&void 0!==arguments[0]?arguments[0]:"videoCtxGl")?512700:512701;e?IO.addFailedEvent({key:t,error:e}):IO.addSuccessEvent({key:t});}checkOrCreateVideoContext(){let e=this._use2d;if(this._autoSwitchRenderMode&&(this._use2d=!this._hasVirtualBg),this.videoContext)if(this.videoContext.available){let t=!this.videoContext.hasAlpha&&this.needAlpha;if(this._autoSwitchRenderMode&&e===this._hasVirtualBg)this.clear();else {if(!t)return !0;if(!this._use2d)return !0;this.clear();}}else {if(this._glVideoContext=new vx({frameRate:15,logger:this.log,name:"m"}),this.initializeGlVideoContext(),this._glVideoContext.available)return this.videoContext=this._glVideoContext,this.videoContext.available;this.log.warn("webgl is still not available"),this.clear(),this._use2d=!0;}return this.videoContext=this._use2d?this.get2dVideoContext():this.getGlVideoContext(),this.videoContext.available}get smallTrack(){var e;return null==(e=this.smallDestination)?void 0:e.videoTrack}get hasSmall(){return !!this.smallTrack}get initialTrack(){var e;return null==(e=this.cameraTrack)?void 0:e.mediaTrack}initVirtualBackground(e){return this._selfieSegmentation=e,this._selfieSegmentation.changeModel()}_setMainOutput(e){var t;try{let i=this.cameraTrack,{small:r,settings:n,player:o}=i;r?(this.smallVideoContext.available||(this.smallVideoContext.create({alpha:!1}),this.smallDestination=new mx(this.smallVideoContext,r,this.log)),this.smallVideoContext.frameRate=r.frameRate,this.smallDestination.resolution=r,e?(this.smallTrackSource&&(this.smallTrackSource.close(),delete this.smallTrackSource),this.smallImageSource?this.smallImageSource.image=e:(this.smallImageSource=this.smallVideoContext.createVideoImageSource(e),this.smallImageSource.connect(this.smallDestination))):(this.smallImageSource&&(this.smallImageSource.close(),delete this.smallImageSource),this.smallTrackSource?this.smallTrackSource.replaceTrack(this.initialTrack):(this.smallTrackSource=this.smallVideoContext.createVideoTrackSource(this.initialTrack,"smallTrackSource"),this.smallTrackSource.width=n.width,this.smallTrackSource.height=n.height,this.smallTrackSource.connect(this.smallDestination)))):this.smallVideoContext.available&&(this.smallVideoContext.destroy(),delete this.smallDestination,delete this.smallTrackSource,delete this.smallImageSource),hN&&o.setCanvas(e);let s=e&&(null==(t=this.destination)?void 0:t.videoTrack)||this.initialTrack;return this.isUsingArTrack&&this.arTrack&&(this.emit("output-track-changed"),s=this.arTrack),this._selfieSegmentation&&e&&!this._use2d&&(this._selfieSegmentation._glName||this._selfieSegmentation.setCanvas(e)),this.log.info("set main output ".concat(s?s.label:"no output track")),i.setOutputMediaStreamTrack(s)}catch(ub){this.log.error("set main output failed",ub);}}update(){return HC(this,null,(function*(){var e,t;if(!this.cameraTrack||!this.cameraTrack.mediaTrack)return;if(!this.active)return this.cameraNode&&this.clear(),this._setMainOutput();let{settings:i,profile:r}=this.cameraTrack;if(this._use2d||!this._virtualBackground&&!this._beautyParams?(this.destination||(this.destination=this.videoContext.createVideoTrackDestination({name:"mainDestination2d",logger:this.log})),16===fN?this.initialTrack instanceof CanvasCaptureMediaStreamTrack?(this.cameraNode&&(this.cameraNode instanceof gx?(this.cameraNode.close(),delete this.cameraNode):this.cameraNode.image=this.initialTrack.canvas),this.cameraNode||(this.cameraNode=this.videoContext.createVideoImageSource(this.initialTrack.canvas,{name:"cameraCanvasSource",logger:this.log}))):(this.cameraNode&&(this.cameraNode instanceof gx?this.cameraNode.replaceTrack(this.initialTrack):(this.cameraNode.close(),delete this.cameraNode)),this.cameraNode||(this.cameraNode=this.videoContext.createVideoTrackSource(this.initialTrack,"cameraTrackSource"))):this.cameraNode?this.cameraNode.replaceTrack(this.initialTrack):this.cameraNode=this.videoContext.createVideoTrackSource(this.initialTrack,"cameraNodeSource"),this.cameraNode.resize(i.width,i.height)):(this.cameraNode&&this.cameraNode.close(),this.destination?this.destination.disableCheckMute():this.destination=new px(this.videoContext,{name:"mainDestination",logger:this.log}),this.cameraNode=new IF(this.videoContext,{input:this.cameraTrack.mediaTrack,mirror:this._isMirror,bg:this._virtualBackground,selfModel:this.selfModel,waterMark:this._waterMarkOption,beautyParams:this._beautyParams,useTflite:!0,blurRadius:this.blurRadius,assetPath:this._bgAssetPath,selfieSegmentation:this._selfieSegmentation,Wasm:this.Wasm}),this.cameraNode.connect(this.destination),this.destination.enableCheckMute()),this.videoContext.frameRate=r.frameRate,this._use2d){let i=this.cameraNode;i.disconnect(),this._isMirror&&(this.mirrorNode||(this.mirrorNode=new vF(this.videoContext,this.log)),i=i.connect(this.mirrorNode),i.disconnect(),this.log.info("start mirror")),this.mixNode&&this.mixNode.close(),delete this.mixNode,(this._isMixScreen||this._hasWaterMark)&&(this.mixNode=new SF(this.videoContext,this.log),i.connect(this.mixNode,{zIndex:1}),this._hasWaterMark&&!this.waterMarkNode&&this._waterMarkOption&&(this.waterMarkNode=this.videoContext.createVideoImageSource(this._waterMarkOption.image,{autoResize:!1,logger:this.log}),this.waterMarkNode.resize(this._waterMarkOption.width,this._waterMarkOption.height),this.waterMarkNode.x=this._waterMarkOption.x,this.waterMarkNode.y=this._waterMarkOption.y),null==(e=this.waterMarkNode)||e.connect(this.mixNode,{zIndex:2}),this._isMixScreen&&this.screenTrack&&!this.screenNode&&(this.screenNode=this.videoContext.createVideoTrackSource(this.screenTrack.mediaTrack,"screenNodeSource")),null==(t=this.screenNode)||t.connect(this.mixNode,{zIndex:0}),i=this.mixNode,this.log.info("start mix","".concat(this.mixNode.width,"x").concat(this.mixNode.height))),i.connect(this.destination);}return this.log.info("update ".concat(this._use2d?"2d":"webgl")),this._setMainOutput(this.videoContext._canvas)}))}changeInput(e){var t,i,r,n;if(e instanceof EL)return this.log.info("change screen input",null==(t=e.mediaTrack)?void 0:t.label),this.setScreenTrack(e);if(e instanceof _L)return this.log.info("change video input",null==(i=e.mediaTrack)?void 0:i.label),this.setCameraTrack(e);if(e instanceof Sx){this.log.info("change remote input",null==(r=e.mediaTrack)?void 0:r.label);let t=e.mediaTrack;return e.setOutputMediaStreamTrack(t)}this.log.warn("change unknown input",null==(n=e.mediaTrack)?void 0:n.label);}configPipeline(e){}removeInput(e){var t;e instanceof EL?(null==(t=this.screenNode)||t.close(),delete this.screenNode,delete this.screenTrack,this.update()):e instanceof _L?(this.clear(),delete this.cameraTrack,this.smallImageSource&&(this.smallImageSource.close(),delete this.smallImageSource),this.smallTrackSource&&(this.smallTrackSource.close(),delete this.smallTrackSource)):e instanceof Sx&&e.source&&e.source.context.destroy();}setCameraTrack(e){return HC(this,null,(function*(){this.cameraTrack=e,this.update();}))}setScreenTrack(e){return this.screenTrack=e,this._isMixScreen&&(this.screenNode?this.screenNode.replaceTrack(e.mediaTrack):this.update()),e.setOutputMediaStreamTrack(e.mediaTrack)}getWatermarkImage(e,t){return HC(this,null,(function*(){let i=document.createElement("canvas");t&&e&&(i.height=t,i.width=e);let r=i.getContext("2d");if(!r)throw new tb({code:ZC.NOT_SUPPORTED,message:"Make image failed because of canvas context is null"});return this.watermarkImageList.sort(((e,t)=>e.zIndex-t.zIndex)),this.watermarkImageList.forEach((e=>{let{image:t,x:i,y:n,width:o,height:s}=e;r.drawImage(t,i,n,o,s);})),$w(i.toDataURL())}))}pushWaterMarkImageList(e){let{type:t}=e;this.watermarkImageList.some((t=>t.imageUrl===e.imageUrl&&t.height===e.height&&t.width===e.width&&t.x===e.x&&t.y===e.y&&t.type===e.type&&t.zIndex===e.zIndex))||(("mute"===t||"watermark"===t)&&(this.watermarkImageList=this.watermarkImageList.filter((e=>e.type!==t))),this.watermarkImageList.push(e));}setBeautyParams(e){return HC(this,null,(function*(){this._beautyParams=e,this.update();}))}stopBeauty(){return HC(this,null,(function*(){this._beautyParams=void 0,this.update();}))}setWatermark(e){return HC(this,null,(function*(){let t;try{t=yield $w((null==e?void 0:e.imageElement)||e.imageUrl);}catch(c){throw new tb({code:ZC.INVALID_PARAMETER,message:"load image failed, url: ".concat(e.imageUrl)})}let{x:i=0,y:r=0,width:n=t.width,height:o=t.height,type:s="watermark",zIndex:a=2}=e;this.pushWaterMarkImageList({x:i,y:r,width:n,height:o,image:t,zIndex:a,type:s,imageUrl:e.imageUrl}),yield this.freshWatermark(),this.log.info("set watermark",JSON.stringify(this.watermarkImageList));}))}deleteWatermark(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"watermark";return HC(this,null,(function*(){this.watermarkImageList=this.watermarkImageList.filter((t=>t.type!==e)),this.log.info("delete watermark",e,JSON.stringify(this.watermarkImageList)),yield this.freshWatermark();}))}freshWatermark(){return HC(this,null,(function*(){var e,t,i;null==(e=this.waterMarkNode)||e.close(),delete this.waterMarkNode,delete this._waterMarkOption;let r=yield this.getWatermarkImage(null==(t=this.cameraTrack)?void 0:t.settings.width,null==(i=this.cameraTrack)?void 0:i.settings.height);this._waterMarkOption={x:0,y:0,width:r.width,height:r.height,image:r},this.update();}))}setVirtualBackground(e){return HC(this,null,(function*(){if(e){if(e.onAbort&&(this._virtualBackgroundAbortCallback=e.onAbort),this._use2d&&!this._autoSwitchRenderMode)return Promise.reject(new Error("not support virtual background in 2d mode"));this._bgAssetPath=e.assetPath,"image"===e.type?this._virtualBackground=yield $w(e.imageUrl):(this.blurRadius=e.blurLevel||this.blurRadius||3,this._virtualBackground=e.type);}else delete this._virtualBackground,delete this._virtualBackgroundAbortCallback;if(this.log.info("".concat(this._virtualBackground?"start":"stop"," virtual background, ").concat((null==e?void 0:e.type)||"",", ").concat(this.blurRadius||"")),yield this.update(),this._virtualBackground&&!this._glVideoContext.available)throw new tb({code:ZC.INVALID_OPERATION,message:"webgl context create failed, ".concat(this._glVideoContext.error)})}))}get mixScreen(){return this._isMixScreen}set mixScreen(e){var t;this._isMixScreen=e,this._isMixScreen||(null==(t=this.screenNode)||t.close(),delete this.screenNode),this.update();}set mirror(e){var t;this._isMirror!==e&&(this._isMirror=e,this._isMirror||(null==(t=this.mirrorNode)||t.close(),delete this.mirrorNode),this.update());}get mirror(){return this._isMirror}enableAr(e){this.arTrack=e,this.isUsingArTrack=!0,this.update();}updateAr(){return HC(this,null,(function*(){var e;null==(e=this.cameraTrack)||!e.mediaTrack||(yield this.virtualBackgroundInstance.ar.updateInputTrack(this.cameraTrack.mediaTrack.clone()));}))}disableAr(){var e;this.isUsingArTrack=!1,null==(e=this.arTrack)||e.stop(),this.arTrack=void 0,this.update();}clear(){var e;null==(e=this.videoContext)||e.disconnect(),delete this.destination,delete this.cameraNode,delete this.mirrorNode,delete this.screenNode,delete this.waterMarkNode;}addEncodeProcessor(e){let{processor:t,type:i}=e;this.encodePipeline.includes(t)||(this.encodePipeline[i]=t);}addDecodeProcessor(e){let{processor:t,type:i}=e;this.decodePipeline.includes(t)||(this.decodePipeline[i]=t);}removeEncodeProcessor(e){let{type:t}=e;this.encodePipeline[t]=void 0;}removeDecodeProcessor(e){let{type:t}=e;this.decodePipeline[t]=void 0;}},AF=0,CF=class extends AP{constructor(e){super("room"),this.seq=++AF,this.role="anchor",this.joinParams=null,this.localTracks=new Set,this.enableAutoPlayDialog=!0,this.autoReceiveAudio=!0,this.autoReceiveVideo=!0,this.checkSystemResult={result:!0,detail:{isBrowserSupported:!0,isWebRTCSupported:!0,isWebCodecsSupported:!0,isMediaDevicesSupported:!0,isScreenShareSupported:!0,isSmallStreamSupported:!0,isH264EncodeSupported:!0,isVp8EncodeSupported:!0,isH264DecodeSupported:!0,isVp8DecodeSupported:!0}},this.scheduleResult={domains:null,iceServers:null,iceTransportPolicy:null,trtcAutoConf:null},this._isUsingCachedSchedule=!1,this._log=sO.createLogger({id:"r".concat(this.seq)}),this._joinedTimestamp=0,this.isDestroyed=!1,this.useStringRoomId=!!e.useStringRoomId,Aw(e.autoReceiveAudio)&&(this.autoReceiveAudio=e.autoReceiveAudio),Aw(e.autoReceiveVideo)&&(this.autoReceiveVideo=e.autoReceiveVideo),Aw(e.enableAutoPlayDialog)&&(this.enableAutoPlayDialog=e.enableAutoPlayDialog),this._sdkType=e.sdkType,this.keyPointManager=new mF({room:this,frameWorkType:e.frameWorkType,component:e.component,language:e.language}),this.callDurationCalculator=new fF({room:this}),this.badCaseDetector=new gF({room:this}),this.audioManager=new IL(this),this.videoManager=new RF(this);}get scriptTransformWorker(){}get isMainStreamPublished(){for(let e of this.localTracks)if(4&e.mediaType)return !0;return !1}get isAuxStreamPublished(){for(let e of this.localTracks)if(2&e.mediaType)return !0;return !1}get hasAuxStream(){for(let e of this.remotePublishedUserMap.values())if(e.muteState.hasAuxiliary)return !0;return this.isAuxStreamPublished}get localMainVideoTrack(){for(let e of this.localTracks)if(4&e.mediaType)return e;return null}get localAuxVideoTrack(){for(let e of this.localTracks)if(2&e.mediaType)return e;return null}getLogger(){return this._log}get isJoining(){return "joining"===this.state.toString()}get isJoined(){return "joined"===this.state}get isLeft(){return "left"===this.state}addTrack(e){return HC(this,null,(function*(){return this.publish(e)}))}removeTrack(e){return HC(this,null,(function*(){return this.unpublish(e)}))}replaceTrack(e){return HC(this,null,(function*(){}))}setEncodedDataProcessingListener(e){throw new Error("Method not implemented.")}enableAIVoice(e){throw new Error("Method not implemented.")}setProxyServer(e){if(Iw(e))e.startsWith("wss://")?this.proxy_ws=e:e.startsWith("https://")&&(this.proxy_wt=e);else if(gw(e)){let{websocketProxy:t,webtransportProxy:i,loggerProxy:r,scheduleProxy:n,unifiedProxy:o}=e;this.proxy_ws=t,this.proxy_wt=i,this.proxy_unified=o,o?(QN([o,o]),gb("https://".concat(o))):(r&&gb(r),n&&QN(n));}jN.once(nO.JOIN_RECEIVED_CMD_RES,(()=>this.sendAbilityStatus({sched_domain:YN.main,sched_back_domain:YN.backup,signal_domain:this.proxy_ws||this.proxy_wt||""})));}getRemoteAudioStats(){return HC(this,null,(function*(){let e={};return this.remotePublishedUserMap.forEach((t=>{e[t.userId]=t.remoteAudioTrack.stat;})),e}))}getTransportStats(){return HC(this,null,(function*(){var e;let t={rtt:(null==(e=this.quality)?void 0:e.uplinkRTT)||0,downlinksRTT:{}};if(this.quality)for(let i of this.quality.downlinkInfo)t.downlinksRTT[i.userId]=i.rtt;return t}))}getRemoteVideoStats(){return HC(this,arguments,(function(){var e=this;let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"main";return function*(){let i={};return e.remotePublishedUserMap.forEach((e=>{let r="auxiliary"===t?e.remoteAuxiliaryTrack:e.remoteVideoTrack;i[e.userId]=r.stat;})),i}()}))}checkDestroy(){if(this.isDestroyed)throw new tb({code:ZC.INVALID_OPERATION,message:xN({key:zk.CLIENT_DESTROYED,data:{funName:"join"}})})}destroy(){if(this.isJoined)throw this._log.warn(qk.INVALID_DESTROY),new tb({code:ZC.INVALID_OPERATION,message:xN({key:zk.INVALID_DESTROY})});this._log.info("destroy room"),this.audioManager.destroy(),this.videoManager.destroy(),this.keyPointManager.destroy(),this.callDurationCalculator.destroy(),this.badCaseDetector.destroy(),this.isDestroyed=!0,jN.emit(nO.ROOM_DESTROY,{room:this});}schedule(e,t){return HC(this,null,(function*(){var i,r;let n=Lw();try{let{isCached:o,result:s,detailCost:a}=yield qN({userId:this.userId,sdkAppId:this.sdkAppId,roomId:this.useStringRoomId?e.strRoomId:e.roomId,useStringRoomId:this.useStringRoomId,version:cb,userSig:this.userSig,role:"live"===this.scene?e.role:void 0,frameWorkType:t,latencyLevel:e.latencyLevel});this._isUsingCachedSchedule=o,this._log.info("schedule cache:".concat(+o," ").concat(qw(s,{keysToExclude:["username","credential"]}))),o&&jN.once(nO.JOIN_RECEIVED_CMD_RES,(()=>this.sendAbilityStatus({scheduleCache:1}))),this.scheduleResult=PC(PC({},this.scheduleResult),s),Rw(null==(i=s.config)?void 0:i.retryCount)&&dk(s.config.retryCount),Iw(null==(r=s.config)?void 0:r.loggerDomain)&&gb(s.config.loggerDomain),jN.emit(nO.JOIN_SCHEDULE_SUCCESS,{room:this,schedule:this.scheduleResult,detailCost:a}),IO.addSuccessEvent({key:521700,cost:Lw()-n,split:50});}catch(o){throw IO.addFailedEvent({key:521700,error:o}),o}}))}},bF=VC(jC(),1),kF=Symbol("instance"),DF=Symbol("cacheResult"),NF=class{constructor(e,t,i){this.oldState=e,this.newState=t,this.action=i,this.aborted=!1;}abort(e){this.aborted=!0,LF.call(e,this.oldState,new Error("action '".concat(this.action,"' aborted")));}toString(){return "".concat(this.action,"ing")}},wF=class extends Error{constructor(e,t,i){super(t),this.state=e,this.message=t,this.cause=i;}};var OF=new Map;function PF(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return (r,n,o)=>{let s=i.action||n;if(!i.context){let i=OF.get(r)||[];OF.has(r)||OF.set(r,i),i.push({from:e,to:t,action:s});}let a=o.value;o.value=function(){let r=this;for(var n=arguments.length,o=new Array(n),c=0;c<n;c++)o[c]=arguments[c];if(i.context&&(r=xF.get("function"==typeof i.context?i.context.call(this,...o):i.context)),r.state===t)return r[DF];r.state instanceof NF&&r.state.action==i.abortAction&&r.state.abort(r);let l=null;if(Array.isArray(e)?0==e.length?r.state instanceof NF&&r.state.abort(r):("string"!=typeof r.state||!e.includes(r.state))&&(l=new wF(r._state,"".concat(r.name," ").concat(s," to ").concat(t," failed: current state ").concat(r._state," not in from config"))):e!==r.state&&(l=new wF(r._state,"".concat(r.name," ").concat(s," to ").concat(t," failed: current state ").concat(r._state," not from ").concat(e))),l){if(!i.fail){if(i.ignoreError)return l;throw l}i.fail.call(this,l);}let d=r.state,u=new NF(d,t,s);LF.call(r,u);let h=e=>{var n;return r[DF]=e,u.aborted||(LF.call(r,t),null===(n=i.success)||void 0===n||n.call(this,r[DF])),e},p=e=>{let t=e instanceof Error?e.message:String(e);if(LF.call(r,d,e),!i.fail){if(i.ignoreError)return e;throw e}i.fail.call(this,new wF(r._state,"action '".concat(s,"' failed :").concat(t),e instanceof Error?e:new Error(t)));};try{let e=a.apply(this,o);return function(e){return "object"==typeof e&&e&&"then"in e}(e)?e.then(h).catch(p):h(e)}catch(m){p(m);}};}}var MF="undefined"!=typeof window&&window.__AFSM__?(e,t)=>{window.dispatchEvent(new CustomEvent(e,{detail:t}));}:"undefined"!=typeof importScripts?(e,t)=>{postMessage({type:e,payload:t});}:()=>{};function LF(e,t){let i=this._state;this._state=e;let r=e.toString();e&&this.emit(r,i),this.emit(xF.STATECHANGED,e,i,t),this.updateDevTools({value:e,old:i,err:t instanceof Error?t.message:String(t)});}var xF=class extends bF.default{constructor(e,t,i){super(),this.name=e,this.groupName=t,this._state=xF.INIT,e||(e=Date.now().toString(36)),i?Object.setPrototypeOf(this,i):i=Object.getPrototypeOf(this),t||(this.groupName=this.constructor.name);let r=i[kF];r?this.name=r.name+"-"+r.count++:i[kF]={name:this.name,count:0},this.updateDevTools({diagram:this.stateDiagram});}get stateDiagram(){let e=Object.getPrototypeOf(this),t=OF.get(e)||[],i=new Set,r=[],n=[],o=new Set,s=Object.getPrototypeOf(e);OF.has(s)&&(s.stateDiagram.forEach((e=>i.add(e))),s.allStates.forEach((e=>o.add(e)))),t.forEach((e=>{let{from:t,to:i,action:o}=e;"string"==typeof t?r.push({from:t,to:i,action:o}):t.length?t.forEach((e=>{r.push({from:e,to:i,action:o});})):n.push({to:i,action:o});})),r.forEach((e=>{let{from:t,to:r,action:n}=e;o.add(t),o.add(r),o.add(n+"ing"),i.add("".concat(t," --\x3e ").concat(n,"ing : ").concat(n)),i.add("".concat(n,"ing --\x3e ").concat(r," : ").concat(n," 🟢")),i.add("".concat(n,"ing --\x3e ").concat(t," : ").concat(n," 🔴"));})),n.forEach((e=>{let{to:t,action:r}=e;i.add("".concat(r,"ing --\x3e ").concat(t," : ").concat(r," 🟢")),o.forEach((e=>{e!==t&&i.add("".concat(e," --\x3e ").concat(r,"ing : ").concat(r));}));}));let a=[...i];return Object.defineProperties(e,{stateDiagram:{value:a},allStates:{value:o}}),a}static get(e){let t;return "string"==typeof e?(t=xF.instances.get(e),t||xF.instances.set(e,t=new xF(e,void 0,Object.create(xF.prototype)))):(t=xF.instances2.get(e),t||xF.instances2.set(e,t=new xF(e.constructor.name,void 0,Object.create(xF.prototype)))),t}static getState(e){var t;return null===(t=xF.get(e))||void 0===t?void 0:t.state}updateDevTools(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};MF(xF.UPDATEAFSM,Object.assign({name:this.name,group:this.groupName},e));}get state(){return this._state}set state(e){LF.call(this,e);}};xF.STATECHANGED="stateChanged",xF.UPDATEAFSM="updateAFSM",xF.INIT="[*]",xF.ON="on",xF.OFF="off",xF.instances=new Map,xF.instances2=new WeakMap;var VF=VC(jC()),UF=VC(QC());function FF(e){var t;let i=[];for(let r=0;r<e.rtp.length;r++){if(["rtx","red","ulpfec"].includes(e.rtp[r].codec))continue;let n=e.fmtp.filter((t=>t.payload===e.rtp[r].payload))[0];i.push({payload:e.rtp[r].payload,codec:e.rtp[r].codec,fmtp:n?n.config:"",rate:e.rtp[r].rate,rtx:"rtx"===(null==(t=e.rtp[r+1])?void 0:t.codec)?e.rtp[r+1].payload:0,rtcpFb:((null==e?void 0:e.rtcpFb)||[]).filter((t=>t.payload===e.rtp[r].payload)).map((e=>{let{type:t,subtype:i}=e;return {id:t,params:i?[i]:[]}}))});}return i}var BF=(e,t)=>HC(void 0,null,(function*(){var i;let r=YU(e),n={ice:{ufrag:"",password:""},dtls:{hash:"",fingerprint:"",setup:""},audio:{codecs:[],extensions:[]},video:{codecs:[],decoders:[],extensions:[]},useDataChannel:!1};n.ice.ufrag=String(r.media[0].iceUfrag),n.ice.password=r.media[0].icePwd||"",r.fingerprint&&(n.dtls.hash=r.fingerprint.type,n.dtls.fingerprint=r.fingerprint.hash,n.dtls.setup=r.setup||""),r.media[0].fingerprint&&(n.dtls.hash=r.media[0].fingerprint.type,n.dtls.fingerprint=r.media[0].fingerprint.hash),n.dtls.setup=r.media[0].setup||"";let o=r.media[0],s=r.media[1];o.ext&&(n.audio.extensions=o.ext.map((e=>({id:e.value,uri:e.uri})))),s.ext&&(n.video.extensions=s.ext.map((e=>({id:e.value,uri:e.uri}))));let a={codec:o.rtp[0].codec,fmtp:o.fmtp[0].config,payload:o.fmtp[0].payload,rate:o.rtp[0].rate,channel:o.rtp[0].encoding,rtcpFb:[],rtx:0};null==(i=o.rtcpFb)||i.forEach((e=>{let{payload:t,type:i,subtype:r}=e;if(t===a.payload){let e={id:i,params:[]};r&&e.params.push(r),a.rtcpFb.push(e);}})),n.audio.codecs.push(a);let c=["h264","vp8"];return t&&c.shift(),n.video.codecs=[...FF(s)].filter((e=>c.includes(e.codec.toLocaleLowerCase()))),n.video.decoders=(yield function(){return HC(this,null,(function*(){let e=new RTCPeerConnection;e.addTransceiver(Ub.VIDEO,{direction:Ub.TRANSCEIVER_DIRECTION_RECVONLY});let t=yield e.createOffer();if(!t.sdp)return [];let i=FF(YU(t.sdp).media[0]);return e.close(),i}))}()).filter((e=>["h264","vp8"].includes(e.codec.toLocaleLowerCase()))),n})),HF=e=>{let{serverAbility:t,clientAbility:i,offerSDP:r,enableCustomMessage:n}=e,o=YU(r),s={extmapAllowMixed:"extmap-allow-mixed",groups:o.groups,icelite:"ice-lite",media:[],msidSemantic:{semantic:"",token:"WMS"},name:"-",origin:{address:"127.0.0.1",username:"-",sessionId:String(Date.now()),sessionVersion:1,netType:"IN",ipVer:4},timing:{start:0,stop:0},version:0},a={candidates:t.candidates.map((e=>({component:1,foundation:"1",generation:0,ip:e.ip,port:e.port,priority:e.priority,transport:e.foundation,type:e.type}))),connection:{version:4,ip:"0.0.0.0"},direction:Ub.TRANSCEIVER_DIRECTION_RECVONLY,ext:t.audio.extensions.map((e=>({value:e.id,uri:e.uri}))),fingerprint:{type:t.dtls.hash,hash:t.dtls.fingerprint},fmtp:[{payload:t.audio.codecs[0].payload,config:t.audio.codecs[0].fmtp}],icePwd:t.ice.password,iceUfrag:t.ice.ufrag,mid:"0",payloads:String(t.audio.codecs[0].payload),port:o.media[0].port,protocol:o.media[0].protocol,type:Ub.AUDIO,setup:t.dtls.setup,rtcpFb:t.audio.codecs[0].rtcpfb.map((e=>({payload:t.audio.codecs[0].payload,type:e.id,subtype:e.params[0]}))),rtcpMux:"rtcp-mux",rtcpRsize:"rtcp-rsize",rtp:[{payload:t.audio.codecs[0].payload,codec:t.audio.codecs[0].codec,rate:t.audio.codecs[0].rate,encoding:t.audio.codecs[0].channels}]};return s.media.push(a),[1,2,3].forEach((e=>{s.media.push(jF({mid:e,serverAbility:t,clientAbility:i,parsedOffer:o}));})),n&&s.media.push(o.media.find((e=>"dc"===e.mid))),QU(s)},jF=e=>{let{mid:t,serverAbility:i,clientAbility:r,parsedOffer:n,isDownlink:o=!1}=e,s={candidates:i.candidates.map((e=>({component:1,foundation:"1",generation:0,ip:e.ip,port:e.port,priority:e.priority,transport:e.foundation,type:e.type}))),connection:{version:4,ip:"0.0.0.0"},direction:Ub.TRANSCEIVER_DIRECTION_RECVONLY,ext:i.video.extensions.map((e=>({value:e.id,uri:e.uri}))),fingerprint:{type:i.dtls.hash,hash:i.dtls.fingerprint},fmtp:[],icePwd:i.ice.password,iceUfrag:i.ice.ufrag,mid:String(t),payloads:"",port:n.media[0].port,protocol:n.media[0].protocol,type:Ub.VIDEO,setup:i.dtls.setup,rtcpFb:[],rtcpMux:"rtcp-mux",rtcpRsize:"rtcp-rsize",rtp:[]};if(o)(i.video.decoders||i.video.codecs).forEach((e=>{WF(s,e);}));else {let e=i.video.codecs.findIndex((e=>e.codec.toLowerCase()===(i.useVp8?"vp8":"h264"))),t=i.video.codecs[e]||r.video.codecs[0];WF(s,t);}return s},WF=(e,t)=>{e.payloads="".concat(e.payloads," ").concat(t.payload).trim(),e.fmtp.push({payload:t.payload,config:t.fmtp}),e.rtcpFb=[...e.rtcpFb||[],...(t.rtcpfb||t.rtcpFb).map((e=>({payload:t.payload,type:e.id,subtype:e.params[0]})))],e.rtp.push({payload:t.payload,codec:t.codec.toUpperCase(),rate:t.rate}),t.rtx&&(e.payloads="".concat(e.payloads," ").concat(t.rtx),e.fmtp.push({payload:t.rtx,config:"apt=".concat(t.payload)}),e.rtp.push({payload:t.rtx,codec:"rtx",rate:t.rate}));};var GF=(e,t,i)=>{let r=UF.default.parse(e);return r.media.forEach(((e,n)=>{var o;(e.type===Ub.AUDIO||e.type===Ub.VIDEO)&&(function(e){if(!e.rtcpFb)return;let t=[];e.rtcpFb.forEach(((i,r)=>{var n;t.push(i),e.rtcpFb&&(null==(n=e.rtcpFb[r+1])?void 0:n.payload)!==i.payload&&"rrtr"!==i.type&&t.push({payload:i.payload,type:"rrtr"});})),e.rtcpFb=t;}(e),function(e){e.type===Ub.VIDEO&&e.fmtp&&e.fmtp.forEach((e=>{e.config.includes("apt")||(e.config+=";sps-pps-idr-in-keyframe=1");}));}(e),function(e){e.type===Ub.AUDIO&&e.fmtp&&e.fmtp.forEach((e=>{e.config+=";sprop-stereo=1;stereo=1";}));}(e),function(e){let t=new Set(["urn:ietf:params:rtp-hdrext:sdes:mid","urn:ietf:params:rtp-hdrext:sdes:rtp-stream-id","urn:ietf:params:rtp-hdrext:sdes:repaired-rtp-stream-id"]);e.ext&&(e.ext=e.ext.filter((e=>!t.has(e.uri))));}(e),e.type===Ub.VIDEO&&(n<4?(e.payloads="",e.fmtp=[],e.rtp=[],e.rtcpFb=[],t.video.codecs.forEach((t=>WF(e,t)))):i&&(e.payloads="",e.fmtp=[],e.rtp=[],e.rtcpFb=[],(i.video.decoders||i.video.codecs).forEach((t=>WF(e,t)))))),(null==(o=e.payloads)?void 0:o.includes("datachannel"))&&r.groups&&e.mid&&(r.groups[0].mids=r.groups[0].mids.replace(e.mid,"dc"),e.mid="dc");})),UF.default.write(r)},JF=VC(jC()),KF=class extends JF.EventEmitter{constructor(e){super(),this.room=e,FC(this,"mainFpsHealth",1),FC(this,"mainBitrateHealth",1),FC(this,"badMainBitrateHealthCount",0),FC(this,"lastEmitBadHealthTime",0),FC(this,"log"),!aD&&sN&&jN.on("262",this.onVideoCodecChanged,this),this.log=e.getLogger().createChild({id:"h-d"});}onVideoCodecChanged(e){let{remoteUserId:t,streamType:i,isHWCodec:r,codec:n}=e;if(!t&&7!==i&&"h264"===n){if(!r)return void this.room.off("heartbeat-report",this.onHeartbeatReport,this);this.room.listeners("heartbeat-report").includes(this.onHeartbeatReport)||this.room.on("heartbeat-report",this.onHeartbeatReport,this);}}onHeartbeatReport(e){Date.now()-this.lastEmitBadHealthTime<3e4||(e.msg_up_stream_info.msg_video_status.forEach((e=>{if(e.uint32_video_enc_fps&&e.uint32_video_capture_fps){let t=e.uint32_video_enc_fps/e.uint32_video_capture_fps;2===e.uint32_video_stream_type&&(this.mainFpsHealth=t);}if(e.uint32_video_codec_bitrate&&2===e.uint32_video_stream_type){let{localMainVideoTrack:t}=this.room;t&&(this.mainBitrateHealth=e.uint32_video_codec_bitrate/1e3/t.profile.bitrate);}})),this.log.debug("mainBitrateHealth: ".concat(this.mainBitrateHealth," mainFpsHealth: ").concat(this.mainFpsHealth)),this.mainBitrateHealth>.5&&(this.badMainBitrateHealthCount=0),this.mainFpsHealth>.9&&this.mainBitrateHealth<.5&&(this.badMainBitrateHealthCount++,this.badMainBitrateHealthCount>3&&(this.badMainBitrateHealthCount=0,this.lastEmitBadHealthTime=Date.now(),this.log.warn("bad main bitrate health: ".concat(this.mainBitrateHealth)),this.emit("1",{isAux:!1}))));}destroy(){jN.off("262",this.onVideoCodecChanged,this),this.room.off("heartbeat-report",this.onHeartbeatReport,this);}};FC(KF,"EVENT_BAD_HEALTH","bad_health");var zF=KF;function qF(e){let{seiMessageList:t,isAudio:i}=e;return new TransformStream({transform(e,r){let n=e;i?audioEncodePipeline.forEach((e=>{n=e({frame:n});})):videoEncodePipeline.forEach((e=>{n=e({frame:n,seiMessageList:t});})),r.enqueue(n);}})}function YF(e,t){return new TransformStream({transform(i,r){let n=i;videoDecodePipeline.forEach((i=>{n=i({frame:n,onSEI:i=>{i.forEach((i=>{self.postMessage({type:"sei",seiPayloadType:i.seiPayloadType,data:i.seiPayload.buffer,userId:e,streamType:t});}));}});})),r.enqueue(n);}})}var QF,XF=((QF=XF||{}).TRACK="track",QF.DATA_CHANNEL_MESSAGE="data_channel_msg",QF[QF.CONNECTION_STATE_CHANGED="connection-state-changed"]="CONNECTION_STATE_CHANGED",QF[QF.FIREWALL_RESTRICTION="firewall-restriction"]="FIREWALL_RESTRICTION",QF.RECONNECTED="spc-reconnected",QF.RECONNECT_FAILED="spc-reconnect-failed",QF.ERROR="error",QF.SEI_MESSAGE="sei-message",QF),$F=0,ZF=!1,eB=new Set,tB=1,iB=class extends VF.default{constructor(e){let{signalChannel:t,room:i,enableCustomMessage:r}=e;super(),FC(this,"stat",{iceStartTime:0,iceEndTime:0,dtlsStartTime:0,dtlsEndTime:0,peerConnectionStartTime:0,peerConnectionEndTime:0}),FC(this,"currentState","DISCONNECTED"),FC(this,"_room"),FC(this,"_signalChannel"),FC(this,"_peerConnection",null),FC(this,"_datachannel",null),FC(this,"_enableCustomMessage"),FC(this,"_log"),FC(this,"_downlinkMIDMap",new Map),FC(this,"_downlinkMIDUserIDMap",new Map),FC(this,"_reconnectionTimer",-1),FC(this,"reconnectionCount",0),FC(this,"clientAbility"),FC(this,"_serverAbility",null),FC(this,"addDownlinkQueue",new Set),FC(this,"removeDownlinkQueue",new Set),FC(this,"_parsedAnswer",null),FC(this,"_updateSDPPromise",null),FC(this,"_waitForPCConnectedPromise"),FC(this,"clearConnectTimeout"),FC(this,"_isSDPLogged",!1),FC(this,"enableInsertableStreams",!1),FC(this,"insertableStreamsAbortMap",new Map),FC(this,"scriptTransformWorker"),FC(this,"_isRelayTried",!1),FC(this,"_rttOverCount",0),this._room=i,this._enableCustomMessage=r,this._signalChannel=t,this._log=sO.createLogger({id:"spc".concat(tB++),userId:this._room.userId,sdkAppId:this._room.sdkAppId}),this._room.enableCodecPipeline&&(oP?this.enableInsertableStreams=!0:this.initScriptTransformWorker()),this._room.healthDetector.on("1",this.onBadHealth,this);}get isH264EncodeSupported(){let e=this._room.checkSystemResult.detail.isH264EncodeSupported;return this._serverAbility&&(e=e&&!!this._serverAbility.video.codecs.find((e=>"h264"===e.codec.toLowerCase()))),e}addAbortController(e,t){var i;null==(i=this.insertableStreamsAbortMap.get(e))||i.abort("destory"),this.insertableStreamsAbortMap.set(e,t);}get isVP8EncodeSupported(){let e=this._room.checkSystemResult.detail.isVp8EncodeSupported;return this._serverAbility&&(e=e&&this._serverAbility.video.codecs.find((e=>"vp8"===e.codec.toLowerCase()))),e}get videoCodec(){var e,t;let i=null==(e=this._parsedAnswer)?void 0:e.media[1].rtp.find((e=>["h264","vp8"].includes(e.codec.toLowerCase())));return i?i.codec.toLowerCase():null!=(t=this._serverAbility)&&t.useVp8?"vp8":"h264"}get downlinkVideoCodec(){var e;return null!=(e=this._serverAbility)&&e.video.decoders.find((e=>"h264"===e.codec.toLowerCase()))?"h264":"vp8"}get isUsingH264(){return "h264"===this.videoCodec}get is42001fSupported(){return !!this.clientAbility&&!!this.clientAbility.video.codecs.find((e=>e.fmtp.includes("42001f")))}get uplinkSSRC(){return this._peerConnection&&this._peerConnection.localDescription?(e=>{let t=YU(e),i={audioSsrc:0,audioRtxSsrc:0,bigVideoSsrc:0,bigVideoRtxSsrc:0,smallVideoSsrc:0,smallVideoRtxSsrc:0,auxVideoSsrc:0,auxVideoRtxSsrc:0};return t.media.forEach(((e,t)=>{var r;if(e.ssrcs&&!Sw(e.ssrcs[0].id)){let n=Number(e.ssrcs[0].id),o=Number(null==(r=e.ssrcs.filter((e=>"cname"===e.attribute))[1])?void 0:r.id);switch(t){case 0:i.audioSsrc=n;break;case 1:i.bigVideoSsrc=n,i.bigVideoRtxSsrc=o;break;case 2:i.smallVideoSsrc=n,i.smallVideoRtxSsrc=o;break;case 3:i.auxVideoSsrc=n,i.auxVideoRtxSsrc=o;}}})),i})(this._peerConnection.localDescription.sdp):{audioSsrc:0,audioRtxSsrc:0,bigVideoSsrc:0,bigVideoRtxSsrc:0,smallVideoSsrc:0,smallVideoRtxSsrc:0,auxVideoSsrc:0,auxVideoRtxSsrc:0}}onBadHealth(e){let{isAux:t}=e;this.useHWEncoder(!1,t?7:2);}initScriptTransformWorker(){sP&&(this.scriptTransformWorker=function(e){let t=[pL],i=[LV,PV,MV,OV,qF,YF],r="const videoEncodePipeline=[".concat(e.videoEncodePipeline.toString(),"];\n                    const videoDecodePipeline=[").concat(e.videoDecodePipeline.toString(),"];\n                    const audioEncodePipeline = [").concat(e.audioEncodePipeline.toString(),"];\n                    const audioDecodePipeline = [").concat(e.audioDecodePipeline.toString(),"];"),n="(()=>{".concat(t.map((e=>"const ".concat(e.name,"=(()=>").concat(e.toString(),")()"))).join("\n"),"\n").concat(i.map((e=>e.toString())).join("\n"),";(").concat((()=>{let e=[],t=[],i=[];self.onmessage=r=>{"sei"===r.data.type&&(r.data.isMain?(e.push(r.data.data),r.data.small&&i.push(r.data.data)):t.push(r.data.data));},self.onrtctransform=r=>{let{options:n}=r.transformer,o=n.isReceiver?YF(n.userId,n.streamType):qF({seiMessageList:n.isMain?n.small?i:e:t});r.transformer.readable.pipeThrough(o).pipeTo(r.transformer.writable);};}),")();").concat(r,"})()"),o=new Blob([n],{type:"text/javascript"}),s=URL.createObjectURL(o),a=new Worker(s);return URL.revokeObjectURL(s),a}({videoEncodePipeline:this._room.videoManager.encodePipeline,videoDecodePipeline:this._room.videoManager.decodePipeline,audioEncodePipeline:this._room.audioManager.encodePipeline,audioDecodePipeline:this._room.audioManager.decodePipeline}),this.scriptTransformWorker.onmessage=e=>{"sei"===e.data.type&&this.emit("sei-message",e.data);},this.scriptTransformWorker.onerror=e=>{this._log.error("scriptTransformWorker error: ",e);});}get isReconnecting(){return "RECONNECTING"===this.currentState||this._reconnectionTimer>0||this.reconnectionCount>0}get dtlsTransport(){if(!this._peerConnection)return null;let e=this._peerConnection.getSenders();return 0===e.length?null:e[0].transport}initialize(){return HC(this,null,(function*(){var e;let t;try{return this._peerConnection=new RTCPeerConnection({encodedInsertableStreams:this.enableInsertableStreams,offerExtmapAllowMixed:!0,iceServers:this._room.getIceServers(),iceTransportPolicy:this._room.getIceTransportPolicy(),sdpSemantics:this._room.sdpSemantics,bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",tcpCandidatePolicy:"disable",IceTransportsType:"nohost"}),this._peerConnection.oniceconnectionstatechange=()=>{if(!this._peerConnection)return;let e=this._peerConnection.iceConnectionState;this._log.debug("ice state: ".concat(e)),"checking"===e&&0===this.stat.iceStartTime?this.stat.iceStartTime=Date.now():"connected"===e&&0===this.stat.iceEndTime?(this.stat.iceEndTime=Date.now(),IO.addSuccessEvent({key:521711,cost:this.stat.iceEndTime-this.stat.iceStartTime})):"failed"===e&&IO.addFailedEvent({key:521711});},this._peerConnection.onconnectionstatechange=this.onConnectionStateChange.bind(this),this._peerConnection.ontrack=e=>this.emit("track",e),this._enableCustomMessage&&(this._datachannel=this._peerConnection.createDataChannel("".concat(this._room.userId,"dc")),this._datachannel.binaryType="arraybuffer",this._datachannel.onopen=()=>{this._log.info("datachannel open");},this._datachannel.onclose=()=>{this._log.warn("datachannel close");},this._datachannel.onmessage=e=>{let t=new nB(e.data);this.emit("data_channel_msg",{data:t});},this._datachannel.onerror=e=>{this._log.warn("datachannel error",e);}),this._peerConnection.addTransceiver(Ub.AUDIO,{direction:Ub.TRANSCEIVER_DIRECTION_SENDONLY}),this._peerConnection.addTransceiver(Ub.VIDEO,{direction:Ub.TRANSCEIVER_DIRECTION_SENDONLY}),this._peerConnection.addTransceiver(Ub.VIDEO,{direction:Ub.TRANSCEIVER_DIRECTION_SENDONLY}),this._peerConnection.addTransceiver(Ub.VIDEO,{direction:Ub.TRANSCEIVER_DIRECTION_SENDONLY}),t=yield this._peerConnection.createOffer(),this.clientAbility=yield BF(t.sdp,(null==(e=this._room.scheduleResult.config)?void 0:e.remove264FromSDP)||!1),yield this.setOffer(t),this.dtlsTransport&&(this.dtlsTransport.onstatechange=()=>{let{dtlsTransport:e}=this;!e||(this._log.debug("dtls state: ".concat(e.state)),"connecting"===e.state&&0===this.stat.dtlsStartTime?this.stat.dtlsStartTime=Date.now():"connected"===e.state&&0===this.stat.dtlsEndTime&&(this.stat.dtlsEndTime=Date.now()));}),IO.addSuccessEvent({key:521707}),this.clientAbility}catch(ub){throw IO.addFailedEvent({key:521707,error:ub}),this._log.error("initialize failed ".concat(ub," \noffer: ").concat(null==t?void 0:t.sdp)),ub}}))}setPriority(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"high";if(this._peerConnection)try{this._peerConnection.getSenders().forEach((t=>{let i=t.getParameters();i.encodings[0]&&(i.encodings[0].priority=e,i.encodings[0].networkPriority=e,t.setParameters(i).catch((e=>{this._log.warn("setPriority error ",e);})));}));}catch(hk){this._log.warn("setPriority error ",hk);}}connect(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return HC(this,null,(function*(){var i,r;try{if("CONNECTED"===this.currentState)return;let n=Lw(),o={type:"answer",sdp:HF({serverAbility:e,clientAbility:this.clientAbility,offerSDP:this._peerConnection.localDescription.sdp,enableCustomMessage:this._enableCustomMessage})};this._serverAbility=e,yield this.setAnswer(o),yield this.waitForPeerConnectionConnected();let s=(null==(i=this._room.scheduleResult.config)?void 0:i.priority)||(null==(r=this._room.joinParams)?void 0:r.priority)||new URLSearchParams(location.search).get("priority");s&&this.setPriority(s),t||IO.addSuccessEvent({key:521703,cost:Lw()-n});}catch(hb){let i=hb instanceof tb&&hb.code===ZC.API_CALL_ABORTED;throw i||this._log.error("connect failed: ".concat(hb),e),this.reset(),!i&&!this.isReconnecting&&(IO.addFailedEvent({key:521703,error:hb}),this.emitConnectionStateChangedEvent("DISCONNECTED"),this.startReconnection()),hb}}))}reconnect(){return HC(this,null,(function*(){if(-1===this._reconnectionTimer){if(!this._signalChannel.isConnected)return this._log.warn("reconnect() wait signal channel is connected"),void this._signalChannel.once(rU,this.reconnect,this);try{this.reconnectionCount++,this._log.warn("reconnect() trying [".concat(this.reconnectionCount,"]")),this.reset();let e=yield this.initialize(),t=yield this._signalChannel.sendWaitForResponse({command:PU,responseCommand:lU.REBUILD_PEER_CONNECTION_RES,data:{ability:e},enableLog:!1});if(0!==t.data.code)throw new tb({code:t.data.code,message:t.data.message});yield this.connect(t.data.data.ability,!0),IO.addSuccessEvent({key:521704}),this._log.warn("reconnect() success"),this.stopReconnection(),jN.emit(nO.SPC_RECONNECTED,{room:this._room}),this.emit("spc-reconnected");}catch(db){if(!this.isReconnecting)return;if(null!=db&&db.message.includes("timeout")){let e=Ew(this.reconnectionCount);this._log.warn("reconnect() timeout, try again after ".concat(e/1e3,"s")),yield tO(e,(e=>{this._reconnectionTimer=e;})),this.clearReconnectionTimer(),yield this.reconnect();}else this._log.error("reconnect() failed ".concat(null==db?void 0:db.code," ").concat(db)),IO.addFailedEvent({key:521704,error:db}),this.reconnectionCount>=uk()&&this._log.warn("SDK has tried reconnect for ".concat(uk()," times, but all failed, please check your network")),this.stopReconnection(),this.emitConnectionStateChangedEvent("DISCONNECTED"),this.emit("error");}}else this._log.warn("reconnect() is reconnecting, ignore current reconnection");}))}getPeerConnection(){return this._peerConnection}startReconnection(){return HC(this,null,(function*(){this.isReconnecting||(this._log.warn("start reconnect"),this._updateSDPPromise=null,this.emitConnectionStateChangedEvent("RECONNECTING"),yield this.reconnect());}))}stopReconnection(){var e;this.isReconnecting&&(this._log.info("stop reconnect"),this.reconnectionCount=0,this.clearReconnectionTimer(),null==(e=this.clearConnectTimeout)||e.call(this),this._signalChannel.off(rU,this.reconnect,this),"RECONNECTING"===this.currentState&&this.emitConnectionStateChangedEvent("DISCONNECTED"));}checkPeerConnectionToReconnect(){var e;!this.isReconnecting&&(null==(e=this._peerConnection)?void 0:e.connectionState)===ck.CLOSED&&this.startReconnection();}clearReconnectionTimer(){-1!==this._reconnectionTimer&&(clearTimeout(this._reconnectionTimer),this._reconnectionTimer=-1);}onConnectionStateChange(e){let t=this._peerConnection.iceConnectionState,i=this.getDTLSTransportState();this._log.info("connectionState: ".concat(e.target.connectionState," ICE: ").concat(t," DTLS: ").concat(i)),e.target.connectionState===ck.CONNECTING&&(0===this.stat.peerConnectionStartTime&&(this.stat.peerConnectionStartTime=Date.now()),this.emitConnectionStateChangedEvent("CONNECTING")),(e.target.connectionState===ck.FAILED||e.target.connectionState===ck.CLOSED)&&(this.emitConnectionStateChangedEvent("DISCONNECTED"),this._room.forceRelay?this.switchRelay(!1):this.startReconnection()),(e.target.connectionState===ck.CONNECTED||e.target.connectionState===ck.COMPLETED)&&(0===this.stat.peerConnectionEndTime&&(this.stat.peerConnectionEndTime=Date.now()),jN.emit(nO.SINGLE_CONNECTION_STAT,{room:this._room,stat:{ice:this.stat.iceEndTime-this.stat.iceStartTime,dtls:this.stat.dtlsEndTime-this.stat.dtlsStartTime,peerConnection:this.stat.peerConnectionEndTime-this.stat.peerConnectionStartTime}}),this.logSelectedCandidate(),this.emitConnectionStateChangedEvent("CONNECTED"));}getDTLSTransportState(){if(!this._peerConnection)return ak;let e=null;return qO()&&0!==this._peerConnection.getSenders().length?(e=this._peerConnection.getSenders()[0].transport,zO()&&0!==this._peerConnection.getReceivers().length&&e?e.state:ak):ak}emitConnectionStateChangedEvent(e){e!==this.currentState&&("RECONNECTING"===this.currentState&&"CONNECTING"===e||(this.emit(XF.CONNECTION_STATE_CHANGED,{prevState:this.currentState,state:e}),this.currentState=e));}logSelectedCandidate(){return HC(this,null,(function*(){if(!this._peerConnection)return;let e=yield this._peerConnection.getStats();for(let[t,i]of e)if(BO(i)){let t=e.get(i.localCandidateId),r=e.get(i.remoteCandidateId);t&&(this._log.info("local candidate: ".concat(t.candidateType," ").concat(t.protocol,":").concat(t.ip||t.address,":").concat(t.port," ").concat(t.networkType||""," ").concat("relay"===t.candidateType?"relayProtocol:".concat(t.relayProtocol):"")),t.networkType&&cw(t.networkType)),r&&this._log.info("remote candidate: ".concat(r.candidateType," ").concat(r.protocol,":").concat(r.ip||r.address,":").concat(r.port));break}}))}waitForPeerConnectionConnected(){return this._waitForPCConnectedPromise||(this._waitForPCConnectedPromise=new Promise(((e,t)=>{if("CONNECTED"===this.currentState)return e();let i=t=>{"CONNECTED"===t.state&&(clearTimeout(o),n(),e());},r=e=>{let{room:i}=e;i===this._room&&(clearTimeout(o),n(),t(new tb({code:ZC.API_CALL_ABORTED,message:xN({key:zk.CONNECTION_ABORTED,data:"leave room"})})));},n=()=>{jN.off(nO.LEAVE_SUCCESS,r,this),this.off(XF.CONNECTION_STATE_CHANGED,i,this);},o=setTimeout((()=>{n();let e=new tb({code:ZC.API_CALL_TIMEOUT,message:"connection timeout"});$F+=1,(e=>$F>2&&!ZF&&0===eB.size&&e)(this._signalChannel.isConnected)&&(this._log.warn("firewall restriction"),ZF=!0,this.emit(XF.FIREWALL_RESTRICTION)),t(e);}),Ck);this.clearConnectTimeout=()=>{n(),clearTimeout(o),delete this.clearConnectTimeout;},jN.on(nO.LEAVE_SUCCESS,r,this),this.on(XF.CONNECTION_STATE_CHANGED,i,this);})),this._waitForPCConnectedPromise=this._waitForPCConnectedPromise.finally((()=>{this._waitForPCConnectedPromise=null,delete this.clearConnectTimeout;}))),this._waitForPCConnectedPromise}waitForReconnected(){return this.isReconnecting?new Promise(((e,t)=>{this.once("spc-reconnected",e),this.once("error",t);})):Promise.resolve()}addDownlink(e){return HC(this,null,(function*(){if(this._log.info("addDownlink(".concat(e.userId,") trying")),this.isReconnecting&&(yield this.waitForReconnected()),this._updateSDPPromise&&(yield this._updateSDPPromise),this.updateLocalAndRemoteSDPConfig(e),0===this.addDownlinkQueue.size)try{yield this.updateSDP(),this._log.info("addDownlink(".concat(e.userId,") done"));}catch(hk){this._log.error("addDownlink(".concat(e.userId,") failed ").concat(hk)),yield this.startReconnection();}}))}updateLocalAndRemoteSDPConfig(e){let{ssrc:t,userId:i,tinyId:r}=e;if(!this._peerConnection)return;this._log.info("updateLocalAndRemoteSDPConfig ".concat(i," ").concat(JSON.stringify(t)));let n=this._peerConnection.getTransceivers().slice(4).filter((e=>"inactive"===e.direction)).slice(0,3).map((e=>(e.direction=Ub.TRANSCEIVER_DIRECTION_RECVONLY,Number(e.mid))));this._parsedAnswer||(this._parsedAnswer=YU(this._peerConnection.remoteDescription.sdp));let o,s,a,c=this._parsedAnswer.media.filter((e=>{var t;return null==(t=e.ssrcs)?void 0:t.find((e=>{var t;return null==(t=e.value)?void 0:t.includes(r)}))}));if(3===c.length)o=c[0],s=c[1],a=c[2];else if(3===n.length)o=this._parsedAnswer.media.find((e=>Number(e.mid)===Number(n[0]))),s=this._parsedAnswer.media.find((e=>Number(e.mid)===Number(n[1]))),a=this._parsedAnswer.media.find((e=>Number(e.mid)===Number(n[2])));else if(0===n.length){this._peerConnection.addTransceiver(Ub.AUDIO,{direction:Ub.TRANSCEIVER_DIRECTION_RECVONLY}),this._peerConnection.addTransceiver(Ub.VIDEO,{direction:Ub.TRANSCEIVER_DIRECTION_RECVONLY}),this._peerConnection.addTransceiver(Ub.VIDEO,{direction:Ub.TRANSCEIVER_DIRECTION_RECVONLY}),o=JSON.parse(JSON.stringify(this._parsedAnswer.media[0]));let e=jF({mid:1,serverAbility:this._serverAbility,clientAbility:this.clientAbility,parsedOffer:YU(this._peerConnection.localDescription.sdp),isDownlink:!0});s=JSON.parse(JSON.stringify(e)),a=JSON.parse(JSON.stringify(e)),o.mid=this._parsedAnswer.media.length,this._parsedAnswer.media.push(o),s.mid=this._parsedAnswer.media.length,this._parsedAnswer.media.push(s),a.mid=this._parsedAnswer.media.length,this._parsedAnswer.media.push(a);}o.direction=Ub.TRANSCEIVER_DIRECTION_SENDONLY;let l="".concat(r,"-").concat(t.audio);o.ssrcs=[{id:t.audio,attribute:"cname",value:"".concat(l)},{id:t.audio,attribute:"msid",value:"".concat(l,"-").concat(Ub.MAIN," ").concat(l,"-audio")}],s.direction=Ub.TRANSCEIVER_DIRECTION_SENDONLY,s.ssrcs=[{id:t.video,attribute:"cname",value:"".concat(l)},{id:t.video,attribute:"msid",value:"".concat(l,"-").concat(Ub.MAIN," ").concat(l,"-bigvideo")},{id:t.videoRtx,attribute:"cname",value:"".concat(l)},{id:t.videoRtx,attribute:"msid",value:"".concat(l,"-").concat(Ub.MAIN," ").concat(l,"-bigvideo")}],s.ssrcGroups=[{semantics:"FID",ssrcs:"".concat(t.video," ").concat(t.videoRtx)}],a.direction=Ub.TRANSCEIVER_DIRECTION_SENDONLY;let d="".concat(l,"-aux");a.ssrcs=[{id:t.auxiliary,attribute:"cname",value:d},{id:t.auxiliary,attribute:"msid",value:"".concat(d," ").concat(l,"-aux").concat(Ub.VIDEO)},{id:t.auxiliaryRtx,attribute:"cname",value:"".concat(d," ").concat(l,"-aux").concat(Ub.VIDEO)},{id:t.auxiliaryRtx,attribute:"msid",value:"".concat(d," ").concat(l,"-aux").concat(Ub.VIDEO)}],a.ssrcGroups=[{semantics:"FID",ssrcs:"".concat(t.auxiliary," ").concat(t.auxiliaryRtx)}],this._parsedAnswer.groups&&(this._parsedAnswer.groups[0].mids=this._parsedAnswer.media.map((e=>e.mid)).join(" ")),this._downlinkMIDMap.set(i,[o.mid,s.mid,a.mid]),this._downlinkMIDUserIDMap.set(o.mid,i),this._downlinkMIDUserIDMap.set(s.mid,i),this._downlinkMIDUserIDMap.set(a.mid,i);}removeDownlink(e){return HC(this,null,(function*(){if(!this._downlinkMIDMap.has(e)||!this._peerConnection)return;this._log.info("removeDownlink(".concat(e,") trying")),this.isReconnecting&&(yield this.waitForReconnected()),this._updateSDPPromise&&(yield this._updateSDPPromise);let t=this._downlinkMIDMap.get(e),i=!1;this._peerConnection.getTransceivers().forEach((e=>{null!=t&&t.includes(Number(e.mid))&&(i=!0,e.direction="inactive");})),this._parsedAnswer||(this._parsedAnswer=YU(this._peerConnection.remoteDescription.sdp)),this._parsedAnswer.media.forEach((e=>{null!=t&&t.includes(Number(e.mid))&&(i=!0,e.direction="inactive",e.ssrcs=[],e.ssrcGroups=[]);})),0===this.removeDownlinkQueue.size&&i&&(yield this.updateSDP()),this._downlinkMIDMap.delete(e),null==t||t.forEach((e=>this._downlinkMIDUserIDMap.delete(e))),this._log.info("removeDownlink(".concat(e,") done"));}))}setBandwidth(e){return HC(this,null,(function*(){if(!this._peerConnection)return;let{audio:t,bigVideo:i,smallVideo:r,auxVideo:n}=e;try{if(tP()){let e=this._peerConnection.getSenders().slice(0,4);for(let s=0;s<e.length;s++){let o,a=e[s];0===s&&t?o=t:1===s&&i?o=i:2===s&&r?o=r:3===s&&n&&(o=n),o&&(yield this.setSenderMaxBitrate(a,o));}let o=!1;i&&e[1].track&&(o=this.setStartBitrate(1,i)),n&&e[3].track&&(o=this.setStartBitrate(3,n)||o),o&&(yield this.updateSDP());}else yield this.setBandwidthBySDP(e);this._log.info("setBandwidth ".concat(JSON.stringify(e)));}catch(o){this._log.error("failed to set bandwidth: ".concat(o));}}))}setStartBitrate(e,t){var i,r;return !(null==(i=this._peerConnection)||!i.remoteDescription||(this._parsedAnswer||(this._parsedAnswer=YU(this._peerConnection.remoteDescription.sdp)),null==(r=this._parsedAnswer.media[e])||!r.fmtp[0]))&&(this._parsedAnswer.media[e].fmtp[0].config+=";x-google-start-bitrate=".concat(t>5e3?5e3:t),!0)}setSenderMaxBitrate(e,t){let i=e.getParameters();return (!i.encodings||0===i.encodings.length)&&(i.encodings=[{}]),"unlimited"===t?delete i.encodings[0].maxBitrate:i.encodings[0].maxBitrate=1e3*t,e.setParameters(i)}setBandwidthBySDP(e){let{audio:t,bigVideo:i,smallVideo:r,auxVideo:n}=e;if(!this._peerConnection||!this._peerConnection.localDescription)return;let o=YU(this._peerConnection.localDescription.sdp);this._parsedAnswer||(this._parsedAnswer=YU(this._peerConnection.remoteDescription.sdp));let s=uD?"TIAS":"AS";t&&(o.media[0].bandwidth=[{type:s,limit:uD?1e3*t:t}],this._parsedAnswer.media[0].bandwidth=[{type:s,limit:uD?1e3*t:t}]),i&&(o.media[1].bandwidth=[{type:s,limit:uD?1e3*i:i}],this._parsedAnswer.media[1].bandwidth=[{type:s,limit:uD?1e3*i:i}]),r&&(o.media[2].bandwidth=[{type:s,limit:uD?1e3*r:r}],this._parsedAnswer.media[2].bandwidth=[{type:s,limit:uD?1e3*r:r}]),n&&(o.media[3].bandwidth=[{type:s,limit:uD?1e3*n:n}],this._parsedAnswer.media[3].bandwidth=[{type:s,limit:uD?1e3*n:n}]);let a={type:"offer",sdp:QU(o)};return this.updateSDP({localDescription:a})}setScaleResolutionDownBy(e,t,i){let r=e.getParameters();(!r.encodings||0===r.encodings.length)&&(r.encodings=[{}]);let n=r.encodings[0].scaleResolutionDownBy;if(Sw(n)?1===t:t===n)return;let o="setScaleResolutionDownBy ".concat(i," ").concat(t);return n&&(o+=" prevScale: ".concat(n)),this._log.warn(o),r.encodings[0].scaleResolutionDownBy=t,e.setParameters(r)}updateSDP(){let{localDescription:e}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if(!this._parsedAnswer)return Promise.resolve();let t=QU(this._parsedAnswer);return this._updateSDPPromise=new Promise(((i,r)=>HC(this,null,(function*(){var n,o;try{!e&&this._peerConnection&&(this._log.info("creating offer"),e=yield this._peerConnection.createOffer()),e&&(yield this.setOffer(e)),yield this.setAnswer({type:"answer",sdp:t}),this._updateSDPPromise=null,i();}catch(QF){this._log.error(QF),!this._isSDPLogged&&this._peerConnection&&(this._log.warn("current offer: ".concat(this.filterSDPDirection(null==(n=this._peerConnection.localDescription)?void 0:n.sdp)," \nnext offer: ").concat(this.filterSDPDirection(null==e?void 0:e.sdp))),this._log.warn("current answer: ".concat(this.filterSDPDirection(null==(o=this._peerConnection.remoteDescription)?void 0:o.sdp)," \nnext answer: ").concat(this.filterSDPDirection(t))),this._log.warn("offer: ".concat(null==e?void 0:e.sdp)),this._log.warn("answer: ".concat(t)),this._log.warn("transceivers: ".concat(JSON.stringify(this._peerConnection.getTransceivers().map((e=>{let{mid:t,currentDirection:i,direction:r,stopped:n}=e;return {mid:t,currentDirection:i,direction:r,stopped:n}}))))),this._log.warn("parsedAnswer: ".concat(JSON.stringify(this._parsedAnswer))),this._isSDPLogged=!0),this._updateSDPPromise=null,r(QF);}})))),this._updateSDPPromise}setTransceiverDirection(e,t){return HC(this,null,(function*(){if(!uD||!this._peerConnection||!this._parsedAnswer)return;this._log.info("setting transceiver ".concat(t.join(",")," direction to ").concat(e));let i=this._peerConnection.getTransceivers();t.forEach((t=>{i[t].direction!==e&&(i[t].direction=e);}));for(let r of t){let t=this._parsedAnswer.media[r].direction;e===Fb.INACTIVE&&t===Fb.RECVONLY&&(this._parsedAnswer.media[r].direction=e),e===Fb.SENDONLY&&t===Fb.INACTIVE&&(this._parsedAnswer.media[r].direction=Fb.RECVONLY);}yield this.updateSDP();}))}filterSDPDirection(){return YU(arguments.length>0&&void 0!==arguments[0]?arguments[0]:"").media.map((e=>e.direction))}setOffer(e){return this._log.info("setting offer"),this._log.debug(e.sdp),this._peerConnection.setLocalDescription({type:"offer",sdp:GF(e.sdp,this.clientAbility,this._serverAbility)})}setAnswer(e){return this._log.info("setting answer"),this._log.debug(e.sdp),this._peerConnection.setRemoteDescription(e)}switchVideoEncoder(e){return HC(this,null,(function*(){if(!this._peerConnection||!this._parsedAnswer||!this._serverAbility)return;let t=!1;this._parsedAnswer.media.forEach((i=>{var r;if(i.type===Ub.VIDEO){let n=this._serverAbility.video.codecs.find((t=>t.codec.toLowerCase()===e));n&&(null==(r=i.payloads)||!r.includes(String(n.payload)))&&(i.fmtp=[],i.payloads="",i.rtp=[],i.rtcpFb=[],WF(i,n),t=!0);}})),t&&(this._log.warn("switch video encoder to ".concat(e)),yield this.updateSDP());}))}useHWEncoder(){let e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0],t=arguments.length>1?arguments[1]:void 0;return HC(this,null,(function*(){if(!this._peerConnection||!this._parsedAnswer||!this._serverAbility)return;let i=!1,r=[];Sw(t)?r=this._parsedAnswer.media.slice(1,4):2===t?r.push(this._parsedAnswer.media[1]):3===t?r.push(this._parsedAnswer.media[2]):7===t&&r.push(this._parsedAnswer.media[3]),r.forEach((t=>{var r;if(t.type===Ub.VIDEO){let n;e&&this.is42001fSupported?n=this.clientAbility.video.codecs.find((e=>e.fmtp.includes("42001f"))):e||(n=this._serverAbility.video.codecs.find((e=>e.codec.toLowerCase()===(this._serverAbility.useVp8?"vp8":"h264")))),n&&(null==(r=t.payloads)||!r.includes(String(n.payload)))&&(t.fmtp=[],t.payloads="",t.rtp=[],t.rtcpFb=[],WF(t,n),i=!0);}})),i&&(this._log.warn("use ".concat(e?"hw":"sw"," encoder")),yield this.updateSDP());}))}sendDataChannelMessage(e){var t;null==(t=this._datachannel)||t.send(e);}reset(){var e;null==(e=this._peerConnection)||e.close(),this._waitForPCConnectedPromise=null,this._parsedAnswer=null;}close(){this._log.info("close pc"),this.removeRTCListener(),this.insertableStreamsAbortMap.forEach((e=>UN(e.abort)&&e.abort("destroy"))),this.insertableStreamsAbortMap.clear(),this.reset(),this.emitConnectionStateChangedEvent("DISCONNECTED"),this._downlinkMIDMap.clear(),this.stopReconnection(),this.removeAllListeners(),this._room.healthDetector.off("1",this.onBadHealth,this);}getReceiversByUserId(e){if(!this._peerConnection)return [];let t=this._peerConnection.getReceivers();return (this._downlinkMIDMap.get(e)||[]).map((e=>t[e]))}get isUsingRelay(){return "relay"===this._room.getIceTransportPolicy()}detectTCPAndUDP(e){let{uplinkRTT:t,downlinkRTT:i}=e;var r;if("CONNECTED"!==this.currentState||this._isRelayTried&&!this._room.forceRelay||0===this._room.getIceServers().length)return;let n=this._signalChannel.rtt,o=Math.max(t,i),{rttRatioThreshold:s,rttThreshold:a}=(null==(r=this._room.scheduleResult.config)?void 0:r.useTurnTcpInfo)||{};if(!(s&&a&&n&&o))return;let c=Math.floor(o/n),l=(this._isRelayTried||c>s)&&o>a;l?++this._rttOverCount<5||(this._log.warn("detectTCPAndUDP ws-rtt: ".concat(n," upRTT: ").concat(t," downRTT: ").concat(i," ratio: ").concat(c," over-count: ").concat(this._rttOverCount," isOver: ").concat(l," isRelayTried: ").concat(this._isRelayTried," force-relay: ").concat(this._room.forceRelay)),this.isUsingRelay||this._isRelayTried?this._room.forceRelay&&this.switchRelay(!1):(this._isRelayTried=!0,this._rttOverCount=0,this.switchRelay(!0))):this._rttOverCount=0;}switchRelay(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return HC(this,null,(function*(){if(this.isUsingRelay===e)return;let i=e?"relay":"udp",r=e?521709:521710;try{this._room.forceRelay=e,this._log.warn("switchRelay ".concat(i));let t=Date.now();yield this.doSwitchRelay(i),this._log.warn("switchRelay ".concat(i," success")),IO.addSuccessEvent({key:r,cost:Date.now()-t});}catch(hb){this._log.warn("switchRelay ".concat(i," failed"),hb),IO.addFailedEvent({key:r,error:hb}),t?this._room.reJoin():yield this.switchRelay(!e,!0);}}))}doSwitchRelay(e){return new Promise(((t,i)=>{let r=setTimeout((()=>{this.stopReconnection(),i(new Error("switch ".concat(e," timeout")));}),1e4);this.startReconnection().then(t,i).finally((()=>clearTimeout(r)));}))}removeRTCListener(){this._peerConnection&&(this._peerConnection.oniceconnectionstatechange=null,this._peerConnection.onconnectionstatechange=null,this._peerConnection.ontrack=null),this.dtlsTransport&&(this.dtlsTransport.onstatechange=null);}};UC([sL("reconnect")],iB.prototype,"startReconnection",1),UC([aL((e=>e.userId))],iB.prototype,"addDownlink",1),UC([aL((e=>e))],iB.prototype,"removeDownlink",1),UC([oL(!0)],iB.prototype,"updateSDP",1),UC([cL(521712,!1)],iB.prototype,"setOffer",1),UC([cL(521713,!1)],iB.prototype,"setAnswer",1);var rB=class{constructor(e){FC(this,"tag"),FC(this,"len"),FC(this,"data");let t=new DataView(e);this.tag=t.getUint16(),this.len=t.getUint16(2),this.data=new Uint8Array(e).slice(4,4+this.len).buffer;}},nB=class{constructor(e){FC(this,"tinyId"),FC(this,"data");let t=new DataView(e),i=0,r=[];for(;i<t.byteLength;){let n=t.getUint16(i+2),o=new rB(new Uint8Array(e).slice(i,i+2+2+n).buffer);r.push(o),i+=4+n;}r.forEach((e=>{1===e.tag?this.tinyId=(new TextDecoder).decode(e.data):2===e.tag&&(this.data=e.data);}));}},oB=new Set;function sB(){let e=Math.floor(4294967296*Math.random());return oB.has(e)?sB():(oB.add(e),e)}var aB=VC(jC()),cB=class extends aB.default{constructor(e){super(),FC(this,"userId"),FC(this,"tinyId"),FC(this,"_sdpSemantics"),FC(this,"_isUplink"),FC(this,"_room"),FC(this,"_log"),FC(this,"_currentState","DISCONNECTED"),FC(this,"_prevTime",-1),this.userId=e.userId,this.tinyId=e.tinyId,this._room=e.room,this._sdpSemantics=e.room.sdpSemantics,this._isUplink=e.isUplink,this._log=sO.createLogger({id:"n",userId:this._room.userId,remoteUserId:this._isUplink?void 0:this.userId,sdkAppId:this._room.sdkAppId,isLocal:this._isUplink});}get _peerConnection(){var e;return (null==(e=this.singlePC)?void 0:e.getPeerConnection())||null}get singlePC(){return this._room.singlePC}get _signalChannel(){return this._room.signalChannel}close(e){this._log.info("close connection"),this.emit("closed",e);}emitConnectionStateChangedEvent(e){return e!==this._currentState&&(jN.emit(nO.PEER_CONNECTION_STATE_CHANGED,{room:this._room,prevState:this._currentState,state:e,remoteUserId:this._isUplink?void 0:this.userId}),this.emit("connection-state-changed",{prevState:this._currentState,state:e}),this._currentState=e,!0)}getPeerConnection(){return this._peerConnection}getRoom(){return this._room}getUserId(){return this.userId}getTinyId(){return this.tinyId}getCurrentState(){return this._currentState}get isH264(){var e,t;return !(null==(t=null==(e=this._peerConnection)?void 0:e.remoteDescription)||!t.sdp.includes("H264"))}},lB=class extends cB{constructor(e){super(MC(PC({},e),{isUplink:!0})),FC(this,"localMainAudioTrack",null),FC(this,"localMainVideoTrack",null),FC(this,"localAuxAudioTrack",null),FC(this,"localAuxVideoTrack",null),FC(this,"_isPublishingAux",!1),FC(this,"_publishingLocalAudioTrack"),FC(this,"_publishingLocalVideoTrack"),FC(this,"_mediaSettings",{videoCodec:"",videoWidth:0,videoHeight:0,videoBps:0,videoFps:0,audioCodec:"opus",audioFs:0,audioChannel:0,audioBps:0,smallVideoWidth:0,smallVideoHeight:0,smallVideoFps:0,smallVideoBps:0,auxVideoWidth:0,auxVideoHeight:0,auxVideoFps:0,auxVideoBps:0}),FC(this,"_flag",0),FC(this,"_checkPublishStateTimeoutId",-1),this.initialize();}get videoCodec(){var e;return (null==(e=this.singlePC)?void 0:e.videoCodec)||"h264"}get ssrc(){if(!this.singlePC)return {audio:0,video:0,videoRtx:0,small:0,smallRtx:0,auxiliary:0,auxiliaryRtx:0};let{audioSsrc:e,bigVideoSsrc:t,bigVideoRtxSsrc:i,smallVideoSsrc:r,smallVideoRtxSsrc:n,auxVideoSsrc:o,auxVideoRtxSsrc:s}=this.singlePC.uplinkSSRC;return {audio:e||0,video:t||0,videoRtx:i||0,small:r||0,smallRtx:n||0,auxiliary:o||0,auxiliaryRtx:s||0}}get flag(){return this._flag}set flag(e){this._flag!==e&&(this._flag=e,this.checkPublishState());}checkPublishState(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];if(!e&&this._checkPublishStateTimeoutId>0)return;let{publishState:t,serverPublishState:i}=this,r=Object.keys(t).find((e=>t[e]!==i[e]));if(r){if(!e)return void(this._checkPublishStateTimeoutId=NP.run(Hk,(()=>this.checkPublishState(!0)),{delay:1e4,count:1}));this._log.warn("publish state not matched, ".concat(r," local:").concat(t[r]," server:").concat(i[r]," ").concat(wN()," ").concat(bN())),IO.addCount({key:521e3});}NP.clearTask(this._checkPublishStateTimeoutId),this._checkPublishStateTimeoutId=-1;}get isMainStreamPublished(){return !(!this.localMainAudioTrack&&!this.localMainVideoTrack)}get isAuxStreamPublished(){return !(!this.localAuxVideoTrack&&!this.localAuxAudioTrack)}get publishState(){var e,t,i,r;let n={audio:!1,bigVideo:!1,smallVideo:!1,auxVideo:!1};if(this._peerConnection){let o=this._peerConnection.getSenders();o&&(YO()?(n.audio=!(null==(e=o[0])||!e.track),n.bigVideo=!(null==(t=o[1])||!t.track),n.smallVideo=!(null==(i=o[2])||!i.track),n.auxVideo=!(null==(r=o[3])||!r.track)):o.forEach((e=>{e.track&&(e.track.kind===Ub.AUDIO?n.audio=!0:(n.bigVideo=!0,this._room.videoManager.hasSmall&&(n.smallVideo=!0)));})));}return n}get serverPublishState(){return {audio:!!(this.flag&Jb),bigVideo:!!(this.flag&jb),smallVideo:!!(this.flag&Wb),auxVideo:!!(this.flag&Gb)}}get muteState(){var e,t,i;return {audio:!(null==(e=this.localMainAudioTrack)||!e.muted),bigVideo:!(null==(t=this.localMainVideoTrack)||!t.muted),auxVideo:!(null==(i=this.localAuxVideoTrack)||!i.muted)}}initialize(){this.installEvents();}close(e){var t;let i=(null==(t=this._peerConnection)?void 0:t.getSenders())||[];for(let r of i)r.replaceTrack(null);super.close(e),this.uninstallTrackMuteEvents(this.localMainAudioTrack,this.localMainVideoTrack,this.localAuxVideoTrack),this.emitConnectionStateChangedEvent("DISCONNECTED");}installEvents(){var e,t;this.listeners("connection-state-changed").includes(this.handleConnectionStateChange)||this.on("connection-state-changed",this.handleConnectionStateChange,this),null!=(e=this.singlePC)&&e.listeners("spc-reconnected").includes(this.onSinglePCReconnected)||null==(t=this.singlePC)||t.on("spc-reconnected",this.onSinglePCReconnected,this);}uninstallEvents(){var e;this.off("connection-state-changed",this.handleConnectionStateChange,this),null==(e=this.singlePC)||e.off("spc-reconnected",this.onSinglePCReconnected,this);}emitConnectionStateChangedEvent(e,t){var i,r,n;let o=this._currentState,s=super.emitConnectionStateChangedEvent(e);return s&&o!==e&&(t?t.emit("connection-state-changed",{prevState:o,state:e}):(null==(i=this.localMainVideoTrack)||i.emit("connection-state-changed",{prevState:o,state:e}),null==(r=this.localAuxVideoTrack)||r.emit("connection-state-changed",{prevState:o,state:e}),null==(n=this._publishingLocalVideoTrack)||n.emit("connection-state-changed",{prevState:o,state:e}))),s}onVideoEncodeFailed(e){var t,i;e&&e.isMediaTrackActive&&"h264"===this.videoCodec&&(this._log.warn("h264 encoder not working"),null!=(t=this.singlePC)&&t.isVP8EncodeSupported&&(this._log.warn("switch to vp8"),null==(i=this.singlePC)||i.switchVideoEncoder("vp8")));}publish(e){return HC(this,arguments,(function(e){var t=this;let{localAudioTrack:i,localVideoTrack:r,isAuxiliary:n}=e;return function*(){var e,o,s,a,c,l,d;if(!t.singlePC)return;yield t.singlePC.waitForPeerConnectionConnected();let u,{publishState:h,muteState:p}=t;if(i&&(t._publishingLocalAudioTrack=i,h.audio=!0,p.audio=i.muted),r){if(!t.singlePC.isH264EncodeSupported&&!t.singlePC.isVP8EncodeSupported)throw new tb({code:ZC.NOT_SUPPORTED_H264,message:xN({key:zk.NOT_SUPPORTED_H264ENCODE})});aD&&115===oN()&&r.profile.width*r.profile.height<=230400&&(t._log.warn("fallback video to 480p"),r.setProfile(xb["480p_2"]),yield r.applyProfile()),t._publishingLocalVideoTrack=r,n?(h.auxVideo=!0,p.auxVideo=r.muted):(h.bigVideo=!0,p.bigVideo=r.muted);}if(t._isPublishingAux=n,r&&!n&&r.small&&(u=t._room.videoManager.smallTrack,h.smallVideo=!0),yield t._signalChannel.sendWaitForResponseWithRetry({command:LU,responseCommand:lU.SPC_PUBLISH_RESULT,data:MC(PC({},t.singlePC.uplinkSSRC),{state:h,muteState:p}),retries:3}),yield t.publishByTransceiver({localAudioTrack:i,localVideoTrack:r,smallTrack:u,isAuxiliary:n}),t._publishingLocalAudioTrack=null,t._publishingLocalVideoTrack=null,t._isPublishingAux=!1,r){t[n?"localAuxVideoTrack":"localMainVideoTrack"]=r;let{scaleResolutionDownBy:e}=r;yield t.singlePC.setScaleResolutionDownBy(t._peerConnection.getSenders()[n?3:1],e,r.streamType);}i&&(t[n?"localAuxAudioTrack":"localMainAudioTrack"]=i),yield t.singlePC.setBandwidth({audio:(null==(e=t.localMainAudioTrack)?void 0:e.profile.bitrate)||(null==(o=t.localAuxAudioTrack)?void 0:o.profile.bitrate),bigVideo:null==(s=t.localMainVideoTrack)?void 0:s.profile.bitrate,smallVideo:null==(c=null==(a=t.localMainVideoTrack)?void 0:a.small)?void 0:c.bitrate,auxVideo:null==(l=t.localAuxVideoTrack)?void 0:l.profile.bitrate}),t.sendMediaSettings(),t.installTrackMuteEvents(i,r),!n&&(t._room.preferHW||(null==(d=t._room.scheduleResult.config)?void 0:d.preferHW))&&r&&r.profile.width*r.profile.height>=921600&&t.singlePC.useHWEncoder(!0,2);}()}))}publishByTransceiver(e){let{localAudioTrack:t,localVideoTrack:i,smallTrack:r,isAuxiliary:n}=e;if(!QO())return;this._log.info("publish by transceiver");let o=null==i?void 0:i.outMediaTrack,s=null==t?void 0:t.outMediaTrack,a=this._peerConnection.getTransceivers(),c=[],l=[],d=(e,t,i)=>{var r,n;let o=a[t].sender.replaceTrack(i);l.push(t),null!=(r=this.singlePC)&&r.enableInsertableStreams&&o.then((()=>this.createEncodedStreams(a[t].sender,e))),null!=(n=this.singlePC)&&n.scriptTransformWorker&&this.initSenderTransfrom(a[t].sender,e),c.push(o);};s&&d(t.mediaType,0,s),o&&d(i.mediaType,n?3:1,o),r&&d(8,2,r);let u=this.singlePC.setTransceiverDirection(Fb.SENDONLY,l);return c.push(u),Promise.all(c)}getTrackByMediaType(e){switch(e){case 1:return this.localMainAudioTrack||this._publishingLocalAudioTrack;case 4:case 8:return this.localMainVideoTrack||this._publishingLocalVideoTrack;case 2:return this.localAuxVideoTrack||this._publishingLocalVideoTrack;default:return null}}createEncodedStreams(e,t){var i,r;if(this.singlePC.insertableStreamsAbortMap.has(e))return;let n=e.createEncodedStreams(),o=new AbortController;null==(i=this.singlePC)||i.addAbortController(e,o),(null!=(r=this.getTrackByMediaType(t))&&r.enableEncodeFrame?n.readable.pipeThrough(new TransformStream({transform:(e,i)=>{var r;let n=this.getTrackByMediaType(t);i.enqueue((null==(r=this.singlePC)?void 0:r.isUsingH264)&&n?n.encodeFrame(e,8===t):e);}}),o):n.readable).pipeTo(n.writable,o).catch((e=>{this._log.debug("encoded stream error",e),"destory"!==e&&this._log.warn(e);}));}initSenderTransfrom(e,t){if(!this._peerConnection||!this.singlePC||!this.singlePC.scriptTransformWorker)return;let i=2!==t,r=8===t;e.transform||(e.transform=new RTCRtpScriptTransform(this.singlePC.scriptTransformWorker,{isReceiver:!1,isAudio:1===t,isMain:i,isSmall:r}));}enableSmall(e){return HC(this,null,(function*(){if(!this.singlePC)return;let t=this._peerConnection.getTransceivers();e?this._room.videoManager.smallTrack&&(yield t[2].sender.replaceTrack(this._room.videoManager.smallTrack),yield this.singlePC.setTransceiverDirection(Fb.SENDONLY,[2])):(yield t[2].sender.replaceTrack(null),yield this.singlePC.setTransceiverDirection(Fb.INACTIVE,[2])),this.updateMediaSettings(),yield this.doPublishChange();}))}installTrackMuteEvents(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];t.forEach((e=>{e&&(null==e||e.on("mute",this.sendMutedFlag,this),null==e||e.on("unmute",this.sendMutedFlag,this));}));}uninstallTrackMuteEvents(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];t.forEach((e=>{e&&(null==e||e.off("mute",this.sendMutedFlag,this),null==e||e.off("unmute",this.sendMutedFlag,this));}));}unpublish(e){return HC(this,arguments,(function(e){var t=this;let{localAudioTrack:i,localVideoTrack:r}=e;return function*(){let e=r&&r===t.localAuxVideoTrack,n=null==r?void 0:r.outMediaTrack,o=t._peerConnection.getSenders(),s=[];i&&(e?t.localAuxAudioTrack=null:t.localMainAudioTrack=null,!t.localMainAudioTrack&&!t.localAuxAudioTrack&&(yield o[0].replaceTrack(null),s.push(0))),n&&(e?(yield o[3].replaceTrack(null),t.localAuxVideoTrack=null,t._mediaSettings=MC(PC({},t._mediaSettings),{auxVideoBps:0,auxVideoFps:0,auxVideoWidth:0,auxVideoHeight:0}),s.push(3)):(yield o[1].replaceTrack(null),yield o[2].replaceTrack(null),t.localMainVideoTrack=null,t._mediaSettings=MC(PC({},t._mediaSettings),{videoWidth:0,videoHeight:0,videoBps:0,videoFps:0,audioFs:0,audioChannel:0,audioBps:0,smallVideoWidth:0,smallVideoHeight:0,smallVideoFps:0,smallVideoBps:0}),s.push(1,2))),t.isMainStreamPublished||t.isAuxStreamPublished?(yield t.singlePC.setTransceiverDirection(Fb.INACTIVE,s),yield t.doPublishChange(!1)):yield t.doUnpublish(),t.uninstallTrackMuteEvents(i,r),null==r||r.emit("connection-state-changed",{prevState:t._currentState,state:"DISCONNECTED"});}()}))}doPublishChange(){let e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];return HC(this,null,(function*(){let t={state:this.publishState,constraintConfig:this._mediaSettings},i=yield this._signalChannel.sendWaitForResponseWithRetry({command:fU,data:t,responseCommand:lU.PUBLISH_STATE_CHANGE_RESULT,enableLog:e,retries:3});this.checkPublishResultCode(i.data.code,i.data.message);}))}doUnpublish(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];return this._signalChannel.sendWaitForResponse({command:gU,commandDesc:"unpublish",responseCommand:lU.UNPUBLISH_RESULT,enableLog:e}).catch((e=>{if(e.getCode()===ZC.API_CALL_TIMEOUT)return Promise.resolve();throw e}))}updateMediaSettings(){let{detail:{isH264EncodeSupported:e,isVp8EncodeSupported:t}}=this._room.checkSystemResult;e?this._mediaSettings.videoCodec="H264":t&&(this._mediaSettings.videoCodec="VP8");let i=this._publishingLocalAudioTrack||this.localMainAudioTrack||this.localAuxAudioTrack,{localMainVideoTrack:r,localAuxVideoTrack:n}=this;if(this._publishingLocalVideoTrack&&(this._isPublishingAux?n=this._publishingLocalVideoTrack:r=this._publishingLocalVideoTrack),rP){if(i&&i.outMediaTrack){let e=i.outMediaTrack.getSettings();this._mediaSettings.audioChannel=e.channelCount||1,this._mediaSettings.audioBps=1e3*i.profile.bitrate,this._mediaSettings.audioFs=e.sampleRate||0;}if(r&&r.outMediaTrack){let e=r.outMediaTrack.getSettings();this._mediaSettings.videoWidth=e.width||0,this._mediaSettings.videoHeight=e.height||0,this._mediaSettings.videoFps=e.frameRate||0,this._mediaSettings.videoBps=1e3*r.profile.bitrate,r.small&&(this._mediaSettings.smallVideoWidth=r.small.width,this._mediaSettings.smallVideoHeight=r.small.height,this._mediaSettings.smallVideoFps=r.small.frameRate,this._mediaSettings.smallVideoBps=1e3*r.small.bitrate);}if(n&&n.outMediaTrack){let e=n.outMediaTrack.getSettings();this._mediaSettings.auxVideoWidth=e.width||0,this._mediaSettings.auxVideoHeight=e.height||0,this._mediaSettings.auxVideoFps=e.frameRate||0,this._mediaSettings.auxVideoBps=1e3*n.profile.bitrate;}}else i&&i.outMediaTrack&&(this._mediaSettings.audioChannel=i.profile.channelCount,this._mediaSettings.audioBps=1e3*i.profile.bitrate,this._mediaSettings.audioFs=i.profile.sampleRate),r&&r.outMediaTrack&&(this._mediaSettings.videoWidth=r.profile.width,this._mediaSettings.videoHeight=r.profile.height,this._mediaSettings.videoFps=r.profile.frameRate,this._mediaSettings.videoBps=1e3*r.profile.bitrate);this._log.info("updateMediaSettings: ".concat(JSON.stringify(this._mediaSettings)));}sendMediaSettings(){this.updateMediaSettings(),this._signalChannel.sendWaitForResponse({command:OU,data:this._mediaSettings,responseCommand:lU.UPDATE_CONSTRAINT_CONFIG_RES}).then((e=>{0!==e.data.code&&this._log.warn(e.data.message);})).catch((()=>{}));}addTrack(e){return HC(this,null,(function*(){if(!this._peerConnection)return;let t=e===this.localAuxAudioTrack||e===this.localAuxVideoTrack;this._log.info("is adding ".concat(e.kind," track to current published local ").concat(t?Ub.AUXILIARY:Ub.MAIN," stream")),YO()&&(yield this.addTrackByTransceiver(e,t));}))}addTrackByTransceiver(e,t){return HC(this,null,(function*(){var i;if(!e.mediaTrack)return;let r=this._peerConnection.getTransceivers();if(e.kind===Ub.AUDIO)yield r[0].sender.replaceTrack(e.outMediaTrack);else {let n=t?3:1;yield r[n].sender.replaceTrack(e.outMediaTrack),1===n&&(null==(i=this.localMainVideoTrack)?void 0:i.small)&&(yield r[2].sender.replaceTrack(this._room.videoManager.smallTrack)),r[n].direction===Fb.INACTIVE&&(yield this.singlePC.setTransceiverDirection(Fb.SENDONLY,[n]));}this.updateMediaSettings(),yield this.doPublishChange();}))}removeTrack(e){return HC(this,null,(function*(){if(!this._peerConnection)return;let t=e===this.localAuxAudioTrack||e===this.localAuxVideoTrack;this._log.info("is removing ".concat(e.kind," track from current published local ").concat(t?Ub.AUXILIARY:Ub.MAIN," stream")),YO()&&(yield this.removeTrackByTransceiver(e,t));}))}removeTrackByTransceiver(e,t){return HC(this,null,(function*(){if(!e.mediaTrack)return;let i=this._peerConnection.getTransceivers();if(e.kind===Ub.AUDIO)yield i[0].sender.replaceTrack(null);else {let e=t?3:1;yield i[e].sender.replaceTrack(null),1===e&&this._room.videoManager.hasSmall&&(yield i[2].sender.replaceTrack(null)),yield this.singlePC.setTransceiverDirection(Fb.INACTIVE,[e]);}this.updateMediaSettings(),yield this.doPublishChange();}))}replaceTrack(e){return HC(this,null,(function*(){var t;let i=null==(t=this._peerConnection)?void 0:t.getSenders(),r=e.outMediaTrack||e.mediaTrack;if(!i||0===i.length||!r||i.find((e=>e.track===r)))return !1;let n=e===this.localAuxAudioTrack||e===this.localAuxVideoTrack;return this._log.info("is replacing ".concat(r.kind," track ").concat(r.id," on ").concat(n?Ub.AUXILIARY:Ub.MAIN," stream")),r.kind===Ub.AUDIO&&i[0]&&(yield i[0].replaceTrack(r)),r.kind===Ub.VIDEO&&(!n&&i[1]&&(yield i[1].replaceTrack(r)),n&&i[3]&&(yield i[3].replaceTrack(r))),!0}))}setBandwidth(e){return HC(this,arguments,(function(e){var t=this;let{bandwidth:i,type:r,videoType:n}=e;return function*(){if(t.singlePC){let e={};r===Ub.AUDIO?e.audio=i:"big"===n?e.bigVideo=i:"small"===n?e.smallVideo=i:e.auxVideo=i,yield t.singlePC.setBandwidth(e);}}()}))}sendMutedFlag(e){e===this.localAuxAudioTrack||e===this.localAuxVideoTrack||(this._log.info("send muted state: ".concat(JSON.stringify(this.muteState))),this._signalChannel.sendWaitForResponseWithRetry({command:mU,responseCommand:lU.MUTE_RESULT,data:this.muteState,retries:3}).catch((()=>{})));}handleConnectionStateChange(e){"CONNECTED"===e.state&&(this.localMainVideoTrack||this._publishingLocalVideoTrack&&!this._isPublishingAux)&&jN.emit(nO.SEND_FIRST_VIDEO_FRAME,{room:this._room});}getVideoTrackId(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:Ub.VIDEO;if(this._peerConnection){let t=this._peerConnection.getSenders();if(e===Ub.AUXILIARY&&t[3]&&t[3].track)return t[3].track.id;if(e===Ub.VIDEO&&t[1]&&t[1].track)return t[1].track.id}if(this.localMainVideoTrack&&e===Ub.VIDEO){let e=this.localMainVideoTrack.mediaTrack;if(e)return e.id}if(this.localAuxVideoTrack&&e===Ub.AUXILIARY){let e=this.localAuxVideoTrack.mediaTrack;if(e)return e.id}return ""}getSSRC(){return this.ssrc}checkPublishResultCode(e,t){if(0!==e)throw e===vk?(this._log.error(qk.NOT_SUPPORTED_H264ENCODE),new tb({code:ZC.NOT_SUPPORTED_H264,message:xN({key:zk.NOT_SUPPORTED_H264ENCODE})})):new tb({code:ZC.UNKNOWN,message:xN({key:zk.SIGNAL_RESPONSE_FAILED,data:{signalResponse:lU.PUBLISH_RESULT,code:e,message:t}})})}onSinglePCReconnected(){return HC(this,null,(function*(){this.isMainStreamPublished&&(this._log.warn("republish main stream"),yield this.publish({localAudioTrack:this.localMainAudioTrack,localVideoTrack:this.localMainVideoTrack,isAuxiliary:!1})),this.isAuxStreamPublished&&(this._log.warn("republish aux stream"),yield this.publish({localAudioTrack:this.localAuxAudioTrack,localVideoTrack:this.localAuxVideoTrack,isAuxiliary:!0}));}))}};UC([$M((function(e){let{localVideoTrack:t}=e;null==t||t.once("6",this.onVideoEncodeFailed,this);}))],lB.prototype,"publish",1),UC([$M((function(e){let{localVideoTrack:t}=e;null==t||t.off("6",this.onVideoEncodeFailed,this);}))],lB.prototype,"unpublish",1);var dB=lB;function uB(e){return Object.keys(e).filter((t=>e[t]))}var hB=class extends cB{constructor(e){super(MC(PC({},e),{isUplink:!1})),FC(this,"_flag",0),FC(this,"isRobot",!1),FC(this,"role","anchor"),FC(this,"remoteAudioTrack"),FC(this,"remoteVideoTrack"),FC(this,"remoteAuxiliaryTrack"),FC(this,"ssrc",{audio:0,video:0,videoRtx:0,auxiliary:0,auxiliaryRtx:0}),FC(this,"jitterBufferTimeoutId",-1),this.flag=e.flag,this.isRobot=e.isRobot||!1,this.remoteAudioTrack=new bL(this._room,this),this.remoteVideoTrack=new Sx(this._room,this),this.remoteAuxiliaryTrack=new Ix(this._room,this),this.initialize();}get videoCodec(){var e;return (null==(e=this.singlePC)?void 0:e.downlinkVideoCodec)||"h264"}get subscribeState(){return {audio:this.remoteAudioTrack.isSubscribed||this.remoteAudioTrack.isSubscribing,video:this.remoteVideoTrack.isBig&&(this.remoteVideoTrack.isSubscribed||this.remoteVideoTrack.isSubscribing),smallVideo:this.remoteVideoTrack.isSmall&&(this.remoteVideoTrack.isSubscribed||this.remoteVideoTrack.isSubscribing),auxiliary:this.remoteAuxiliaryTrack.isSubscribed||this.remoteAuxiliaryTrack.isSubscribing}}get muteState(){return Bw(this.flag,this.userId)}get flag(){return this._flag}set flag(e){var t,i,r;e!==this._flag&&(this._flag=e,null==(t=this.remoteAudioTrack)||t.onFlagChanged(),null==(i=this.remoteVideoTrack)||i.onFlagChanged(),null==(r=this.remoteAuxiliaryTrack)||r.onFlagChanged());}get hasMainStream(){return this.muteState.hasAudio||this.muteState.hasVideo||this.muteState.hasSmall}get hasAuxStream(){return this.muteState.hasAuxiliary}get isMainStreamSubscribed(){return (this.subscribeState.audio||this.subscribeState.video||this.subscribeState.smallVideo)&&(this.muteState.hasAudio||this.muteState.hasVideo||this.muteState.hasSmall)}get isAuxStreamSubscribed(){return this.subscribeState.auxiliary&&this.muteState.hasAuxiliary}get isSmallStreamSubscribed(){return this.subscribeState.smallVideo&&this.muteState.hasSmall}get isBigStreamSubscribed(){return this.subscribeState.video&&this.muteState.hasVideo}isStreamUnpublished(e){return e===Ub.MAIN?!this.muteState.hasAudio&&!this.muteState.hasVideo:!this.muteState.hasAuxiliary}initialize(){this.installEvents();}close(e){clearTimeout(this.jitterBufferTimeoutId),super.close(e),this.emitConnectionStateChangedEvent("DISCONNECTED"),this.remoteAudioTrack.close(),this.remoteVideoTrack.close(),this.remoteAuxiliaryTrack.close(),this.uninstallEvents(),this.removeDownlink();}installEvents(){!this.singlePC||(this.listeners("track").includes(this.onTrack)||this.singlePC.on("track",this.onTrack,this),this.listeners("spc-reconnected").includes(this.onSinglePCReconnected)||this.singlePC.on("spc-reconnected",this.onSinglePCReconnected,this));}uninstallEvents(){!this.singlePC||(this.singlePC.off("track",this.onTrack,this),this.singlePC.off("spc-reconnected",this.onSinglePCReconnected,this));}emitConnectionStateChangedEvent(e){var t,i;let r=this._currentState,n=super.emitConnectionStateChangedEvent(e);return n&&r!==e&&(null==(t=this.remoteVideoTrack)||t.emit("connection-state-changed",{prevState:r,state:e}),null==(i=this.remoteAuxiliaryTrack)||i.emit("connection-state-changed",{prevState:r,state:e})),n}onTrack(e){var t;let i=e.streams[0],{track:r,receiver:n}=e;if(!i.id.includes(this.tinyId))return;let o=i.id.includes("aux")?"auxiliary":"main";this._log.debug("ontrack ".concat(o," ").concat(r.kind));let s=Ub.AUDIO;r.kind===Ub.VIDEO&&(s=o===Ub.MAIN?Ub.VIDEO:Ub.AUXILIARY);let a=this.remoteAudioTrack;s===Ub.VIDEO?a=this.remoteVideoTrack:s===Ub.AUXILIARY&&(a=this.remoteAuxiliaryTrack),null!=(t=this.singlePC)&&t.scriptTransformWorker&&this.initReceiverTransform(n,o,r.kind===Ub.AUDIO),this.singlePC.enableInsertableStreams&&this.createEncodedStreams(a,n),a.setInputMediaStreamTrack(r);}createEncodedStreams(e,t){if(!this.singlePC.insertableStreamsAbortMap.has(t)){let i=t.createEncodedStreams(),r=new AbortController,n={abortController:r,enqueue:t=>{var i;return null!=(i=this.singlePC)&&i.isUsingH264?e.decodeFrame(t):t}};(e.enableDecodeFrame?i.readable.pipeThrough(new TransformStream({transform:(e,t)=>t.enqueue(n.enqueue(e))})):i.readable).pipeTo(i.writable,r).catch((e=>{"destory"!==e&&this._log.warn(e);})),this.singlePC.addAbortController(t,r);}}initReceiverTransform(e,t,i){!this._peerConnection||!this.singlePC||!this.singlePC.scriptTransformWorker||e.transform||(e.transform=new RTCRtpScriptTransform(this.singlePC.scriptTransformWorker,{isReceiver:!0,isAudio:i,userId:this.userId,streamType:t}));}subscribe(e,t){return HC(this,null,(function*(){try{if(this._log.info("subscribe ".concat(t," ").concat(uB(e))),this.hasSSRC){let t="subscribe_change";Object.values(e).find((e=>!0===e))||(t="unsubscribe"),yield this.sendSubscription(t,e);}else yield this.doSubscribe(e),this.checkTrackEnded(e);}catch(ub){throw this._room.isJoined&&this.isStreamUnpublished(t)?(this._log.warn("".concat(ub.message," ").concat(JSON.stringify(this.muteState))),new tb({code:ZC.REMOTE_STREAM_NOT_EXIST,message:"remote user ".concat(this.userId," unpublished stream")})):ub}}))}checkTrackEnded(e){var t,i,r;if((e.audio&&"ended"===(null==(t=this.remoteAudioTrack.mediaTrack)?void 0:t.readyState)||e.video&&"ended"===(null==(i=this.remoteVideoTrack.mediaTrack)?void 0:i.readyState)||e.auxiliary&&"ended"===(null==(r=this.remoteAuxiliaryTrack.mediaTrack)?void 0:r.readState))&&this.singlePC&&!this.singlePC.isReconnecting){if(this._log.warn("remote track ended start spc reconnect"),sN&&lN<92)return;this.singlePC.startReconnection();}}unsubscribe(e){return HC(this,arguments,(function(e){var t=this;let{remoteTracks:i,streamType:r}=e;return function*(){var e;if("main"===r&&!t.isMainStreamSubscribed||"auxiliary"===r&&!t.isAuxStreamSubscribed)return void t._log.info("".concat(r," stream already unsubscribed"));let n=PC({},t.subscribeState);i.forEach((e=>{switch(e.mediaType){case 1:n.audio=!1;break;case 4:n.video=!1;break;case 8:n.smallVideo=!1;break;case 2:n.auxiliary=!1;}}));let o="subscribe_change";Object.values(n).find((e=>!0===e))||(o="unsubscribe"),t._log.info("".concat("unsubscribe"===o?o:"subscribe"," ").concat(r," [").concat(uB(n),"]")),"unsubscribe"===o&&(null==(e=t.singlePC)||e.removeDownlinkQueue.add(t.tinyId)),yield t.sendSubscription(o,n),"unsubscribe"===o&&(yield t.removeDownlink());}()}))}sendSubscription(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this.subscribeState,i={srcTinyId:this.tinyId,srcUserId:this.userId},r=EU,n=lU.UNSUBSCRIBE_RESULT;return "subscribe_change"===e&&(i={audio:t.audio,bigVideo:t.video,auxVideo:t.auxiliary,smallVideo:t.smallVideo,srcTinyId:this.tinyId},r=vU,n=lU.SUBSCRIBE_CHANGE_RESULT),this._signalChannel.sendWaitForResponseWithRetry({command:r,data:i,responseCommand:n,timeout:1e4,retries:3}).then((t=>{let{data:i}=t;if(0!==i.code){let t=new tb({code:i.code,message:xN({key:zk.ERROR_MESSAGE,data:{type:e,message:i.message}})});throw this._log.error(t),t}}))}getMainStreamVideoTrackId(){return this.remoteVideoTrack&&this.remoteVideoTrack.mediaTrack?this.remoteVideoTrack.mediaTrack.id:""}getAuxStreamVideoTrackId(){return this.remoteAuxiliaryTrack&&this.remoteAuxiliaryTrack.mediaTrack?this.remoteAuxiliaryTrack.mediaTrack.id:""}setDelay(e){let{audioDelay:t,videoDelay:i}=e;this.remoteAudioTrack.stat.end2EndDelay=t,this.remoteVideoTrack.stat.end2EndDelay=i;}onSinglePCReconnected(){(this.ssrc.audio||this.ssrc.video||this.ssrc.auxiliary)&&(this._log.warn("resubscribe ".concat(JSON.stringify(this.subscribeState))),this.doSubscribe(this.subscribeState));}get hasSSRC(){return this.ssrc.audio&&this.ssrc.video&&this.ssrc.auxiliary}doSubscribe(){return HC(this,arguments,(function(){var e=this;let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.subscribeState,i=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];return function*(){if(e.singlePC){e.singlePC.addDownlinkQueue.add(e.tinyId),yield e.singlePC.waitForPeerConnectionConnected();try{if(i||!e.hasSSRC){let i={audioSsrc:sB(),bigVideoSsrc:sB(),bigVideoRtxSsrc:sB(),auxVideoSsrc:sB(),auxVideoRtxSsrc:sB()},{audioSsrc:n,bigVideoSsrc:o,bigVideoRtxSsrc:s,auxVideoSsrc:a,auxVideoRtxSsrc:c}=i;e.ssrc={audio:n,video:o,videoRtx:s,auxiliary:a,auxiliaryRtx:c},e.singlePC.addDownlinkQueue.delete(e.tinyId),yield e.singlePC.addDownlink({userId:e.userId,tinyId:e.tinyId,ssrc:e.ssrc});try{let r=yield e._signalChannel.sendWaitForResponseWithRetry({command:xU,responseCommand:lU.SPC_SUBSCRIBE_RESULT,data:{srcUserId:e.userId,srcTinyId:e.tinyId,audio:t.audio,bigVideo:t.video,auxVideo:t.auxiliary,smallVideo:t.smallVideo,customData:!1,ssrc:i},retries:3,retryTimeout:0});if(0!==r.data.code)throw new tb({code:r.data.code,message:r.data.message})}catch(r){throw yield e.removeDownlink(),r}return}e.singlePC.addDownlinkQueue.delete(e.tinyId),yield e.singlePC.addDownlink({userId:e.userId,tinyId:e.tinyId,ssrc:e.ssrc});}finally{let t=e._room.scheduleResult.config;((null==t?void 0:t.jitterDelay)||(null==t?void 0:t.jitterDelayAux))&&e.setJitterBufferDelay({mainDelay:t.jitterDelay,auxDelay:t.jitterDelayAux});}}}()}))}removeDownlink(){return HC(this,null,(function*(){if(!this.singlePC)return;this.ssrc={audio:0,video:0,videoRtx:0,auxiliary:0,auxiliaryRtx:0},this.singlePC.removeDownlinkQueue.delete(this.tinyId);let e=this._room.scheduleResult.config;((null==e?void 0:e.jitterDelay)||(null==e?void 0:e.jitterDelayAux))&&this.setJitterBufferDelay({mainDelay:0,auxDelay:0}),yield this.singlePC.removeDownlink(this.userId);}))}setJitterBufferDelay(e){let{mainDelay:t,auxDelay:i}=e;if(!this.singlePC||!this._peerConnection||FN(t)&&FN(i))return Promise.resolve();this._log.info("set jitterBuffer main: ".concat(t," aux: ").concat(i));let r=this.singlePC.getReceiversByUserId(this.userId);return Rw(t)&&(this.remoteAudioTrack.jitterBufferDelay=t,this.remoteVideoTrack.jitterBufferDelay=t),Rw(i)&&(this.remoteAuxiliaryTrack.jitterBufferDelay=i,FN(t)&&(this.remoteAudioTrack.jitterBufferDelay=i)),new Promise((e=>{this.doSetJitterBufferDelay({mainDelay:t,auxDelay:i,receivers:r,resolve:e});}))}doSetJitterBufferDelay(e){let{mainDelay:t,auxDelay:i,receivers:r,resolve:n}=e;try{if(0===t&&0===i)return r.forEach((e=>e.jitterBufferTarget=0)),n();if(r.forEach((e=>{var r;let n=e.track===this.remoteAuxiliaryTrack.outMediaTrack||FN(t)&&e.track===this.remoteAudioTrack.outMediaTrack;if(n&&FN(i)||!n&&FN(t))return;let o=n?i||0:t,s=(e.jitterBufferTarget||0)+100;s>o||(e.jitterBufferTarget=s,this._log.debug("set ".concat(n?"aux ":"").concat(null==(r=null==e?void 0:e.track)?void 0:r.kind," jitterBuffer delay ").concat(s," -> ").concat(o)));})),!r.find((e=>{let r=e.track===this.remoteAuxiliaryTrack.outMediaTrack?i||0:t;return e.jitterBufferTarget<r})))return this._log.info("set jitterBuffer main: ".concat(t," aux: ").concat(i," done")),n();this.jitterBufferTimeoutId=setTimeout((()=>{this.doSetJitterBufferDelay({mainDelay:t,auxDelay:i,receivers:r,resolve:n});}),1e3);}catch(hb){this._log.warn("set jitterBuffer delay error: ".concat(hb)),clearTimeout(this.jitterBufferTimeoutId),n();}}get audioReceiver(){var e;return (null==(e=this.singlePC)?void 0:e.getReceiversByUserId(this.userId)[0])||null}};UC([oL(),ZM((e=>function(){for(var t=arguments.length,i=new Array(t),r=0;r<t;r++)i[r]=arguments[r];return new Promise(((t,r)=>{let n=e=>{this.off("closed",n),r(new tb({code:ZC.API_CALL_ABORTED,message:xN({key:zk.CONNECTION_ABORTED,data:e})}));};this.on("closed",n),e.apply(this,i).then(t,r).finally((()=>{this.off("closed",n);}));}))}))],hB.prototype,"subscribe",1),UC([oL()],hB.prototype,"unsubscribe",1),UC([aL((()=>"jitter"))],hB.prototype,"setJitterBufferDelay",1);var pB=hB;var mB=VC(jC());var _B=class extends mB.EventEmitter{constructor(e,t){super(),this.room=e,this.signalChannel=t,FC(this,"log"),FC(this,"cmdIdSeqMap",new Map),FC(this,"messageMap",new Map),this.log=sO.createLogger({id:"cmm",userId:e.userId}),this.onReceiveMsg=this.onReceiveMsg.bind(this),t.on(lU.RECEIVE_CUSTOM_MSG,this.onReceiveMsg),this.room.on("peer-leave",(e=>{[...this.messageMap.keys()].forEach((t=>{t.split("_").slice(0,-1).join("_")===e&&this.messageMap.delete(t);}));}));}send(e){let{cmdId:t,data:i}=e,r=this.cmdIdSeqMap.get(t)||Math.floor(16383*Math.random()),n={cmdId:t,msg:btoa(String.fromCharCode(...new Uint8Array(i))),ordered:!0,reliable:!0,streamSeq:r};this.cmdIdSeqMap.set(t,r+1),this.signalChannel.send(FU,n),this.log.debug("send custom msg: ".concat(JSON.stringify(n)));}onReceiveMsg(e){let{data:t}=e.data,i=this.room.tinyIdToUserIdMap.get(t.srcTinyId);if(i){let e={userId:i,cmdId:t.cmdId,seq:t.streamSeq,data:Uint8Array.from(atob(t.msg),(e=>e.charCodeAt(0))).buffer};if(t.ordered){let t="".concat(i,"_").concat(e.cmdId),r=this.messageMap.get(t);if(r&&0!==r.lastSeq)if(Math.abs(r.lastSeq-e.seq)>_B.SEQ_INTERVAL)this.messageMap.set(t,{lastSeq:e.seq,cachedMessageMap:new Map}),this.emitMessage(e);else if(e.seq>r.lastSeq){if(e.seq===r.lastSeq+1)this.emitMessage(e);else if(!r.cachedMessageMap.has(e.seq)){let t=setTimeout((()=>this.emitMessage(e,!0)),5e3);r.cachedMessageMap.set(e.seq,{message:e,timeoutId:t});}}else this.log.debug("drop message ".concat(e.userId,"-").concat(e.cmdId,"-").concat(e.seq));else r||(r={lastSeq:0,cachedMessageMap:new Map},this.messageMap.set(t,r),setTimeout((()=>this.emitMessage(e,!0)),100)),r.cachedMessageMap.set(e.seq,{message:e});}else this.emit("message",e);}else {this.log.warn("receive msg from unknown user, wait peer-join tinyId: ".concat(t.srcTinyId));let i=r=>{r.tinyId===t.srcTinyId&&(this.room.off("peer-join",i),this.onReceiveMsg(e));};this.room.on("peer-join",i),tO(2e3).then((()=>this.room.off("peer-join",i)));}}emitMessage(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];var i;let r=this.messageMap.get("".concat(e.userId,"_").concat(e.cmdId)),n=e;if(r){if(t){let e=[...r.cachedMessageMap.values()].sort(((e,t)=>e.message.seq-t.message.seq));e[0]&&(n=e[0].message);}0!==r.lastSeq&&n.seq-r.lastSeq>1&&this.log.debug("msg lost userId: ".concat(n.userId," seq: ").concat(r.lastSeq," -> ").concat(n.seq)),r.lastSeq=n.seq,clearTimeout(null==(i=r.cachedMessageMap.get(n.seq))?void 0:i.timeoutId),r.cachedMessageMap.delete(n.seq);}this.log.debug("receive custom msg: ".concat(JSON.stringify(n))),this.emit("message",n);let o=null==r?void 0:r.cachedMessageMap.get(n.seq+1);o&&this.emitMessage(o.message);}},fB=_B;FC(fB,"SEQ_INTERVAL",300);var{isString:gB,isUndefined:TB,getNetworkType:EB,isEmpty:vB}=ob,yB=class extends CF{constructor(e){super(e),this._heartbeat=-1,this._lastHeartBeatTime=-1,this._joinTimeout=-1,this._firstPublishedList=null,this._joinReject=null,this._isRelayChanged=!1,this.signalChannel=null,this.uplinkConnection=null,this.singlePC=null,this.enableSPC=XO,this._changeBigSmallRecords=new Map,this.forceRelay=!1,this._turnServers=[],this._syncUserListInterval=-1,this._smallStreamConfig={bitrate:100,frameRate:15,height:120,width:160},this.enableSEI=!1,this._enableAudioVolumeEvaluation=!1,this._audioVolumeIntervalId=0,this._enableMultiAuxStream=!1,this._pureAudioPushMode=!1,this.preferHW=!1,this._updateAudioLevelTaskId=-1,this._stats=new oF(this,this._log),this.userManager=new bx(this.userId,this._log),this._version=cb,this.sdpSemantics=Ek,TB(e.sdpSemantics)?lO.isUnifiedPlanDefault()&&(this.sdpSemantics=Tk):this.sdpSemantics=e.sdpSemantics,this._log.info("sdpSemantics: ".concat(this.sdpSemantics,", netType: ").concat(EB())),e.iceTransportPolicy&&(this._iceTransportPolicy=e.iceTransportPolicy),this._enableMultiAuxStream=!TB(e.enableMultiAuxStream)&&e.enableMultiAuxStream,this.enableSEI=e.enableSEI&&XO,!TB(e.enableSPC)&&XO&&(this.enableSPC=e.enableSPC),this.preferHW=!!e.preferHW,this._initBusinessInfo(e),this.healthDetector=new zF(this);}get isMainStreamPublished(){var e;return !(null==(e=this.uplinkConnection)||!e.isMainStreamPublished)}get isMainAudioPublished(){var e;return !(null==(e=this.uplinkConnection)||!e.localMainAudioTrack)}get isAuxStreamPublished(){var e;return !(null==(e=this.uplinkConnection)||!e.isAuxStreamPublished)}get hasAuxStream(){return [...this.remotePublishedUserMap.values()].findIndex((e=>e.muteState.hasAuxiliary))>=0}get userMap(){return this.userManager.userMap}get remotePublishedUserMap(){return this.userManager.remotePublishedUserMap}get tinyIdToUserIdMap(){return new Map([...this.userMap.values()].map((e=>[e.tinyId,e.userId])))}join(e,t,i){return HC(this,null,(function*(){return this.userManager.mySelfId=this.userId,this.userManager.on("1",(e=>{this.emit("peer-join",e);})),this.userManager.on("2",(e=>{this.closeDownLinkConnection(e,"remote user exitRoom"),this.emit("peer-leave",e);})),this.userManager.on("3",this.createDownlinkConnection,this),this.userManager.on("5",this.closeDownLinkConnection,this),this.userManager.on("6",(e=>{var t=((e,t)=>{var i={};for(var r in e)kC.call(e,r)&&t.indexOf(r)<0&&(i[r]=e[r]);if(null!=e&&CC)for(var r of CC(e))t.indexOf(r)<0&&DC.call(e,r)&&(i[r]=e[r]);return i})(e,[]);jN.emit(nO.REMOTE_PUBLISH_STATE_CHANGED,PC({room:this},t)),this.emit("remote-publish-state-changed",PC({},t));})),this.joinParams=e,new Promise(((t,i)=>HC(this,null,(function*(){var r,n;this._joinReject=i;try{this.checkDestroy();try{yield Promise.all([this.initialize(),this.initSinglePC()]);}catch(o){if(!(o instanceof tb&&o.code===ZC.SPC_INITIALIZED_FAILED))return i(o);null==(r=this.signalChannel)||r.destroy(),yield this.initialize();}let s=Lw();yield this.doJoin(e,null==(n=this.singlePC)?void 0:n.clientAbility),IO.addSuccessEvent({key:521708,cost:Lw()-s}),t(),this._firstPublishedList&&this.onPublishedUserList({data:{userList:this._firstPublishedList}});}catch(dO){IO.addFailedEvent({key:521708,error:dO}),i(dO);}this._joinReject=null;}))))}))}initSinglePC(){return HC(this,null,(function*(){if(this.enableSPC&&!this.singlePC){this.singlePC=new iB({signalChannel:this.signalChannel,room:this,enableCustomMessage:!1}),this.singlePC.on("sei-message",(e=>this.emit("sei-message",e))),this.singlePC.once("error",(()=>this.fallbackToMPC()));try{return yield this.singlePC.initialize()}catch(db){throw this.fallbackToMPC(),new tb({code:ZC.SPC_INITIALIZED_FAILED,message:null==db?void 0:db.message})}}}))}doJoin(e,t){return new Promise(((i,r)=>HC(this,null,(function*(){var n,o,s;e.privateMapKey&&(this.privateMapKey=e.privateMapKey),e.latencyLevel&&(this.latencyLevel=e.latencyLevel),this.signalChannel.once(oU,(e=>{this.clearJoinTimeout(),jN.emit(nO.JOIN_SIGNAL_CONNECTION_END,{room:this,error:e}),r(e);})),Aw(null==(o=null==(n=this.scheduleResult)?void 0:n.config)?void 0:o.singlePC)&&XO&&(this.enableSPC=this.scheduleResult.config.singlePC),this.keyPointManager.setConnectionType(this.singlePC?1:2);let a={roomId:String(e.roomId||e.strRoomId),useStringRoomId:this.useStringRoomId,privateMapKey:this.privateMapKey,latencyLevel:this.latencyLevel,trtcRole:e.role,trtcScene:"live"===this.scene?2:1,sdpSemantics:this.sdpSemantics,version:this._version,ua:navigator&&navigator.userAgent||"",terminalType:ON(),netType:lw(),bussinessInfo:this._businessInfo,ability:t,sdkType:this._sdkType,userSig:this.userSig,receiveMix:!0};this._log.debug("join room signal data: ".concat(JSON.stringify(a)));let c=5e3;(null==(s=this.scheduleResult.config)?void 0:s.enterRoomTimeout)&&this.scheduleResult.config.enterRoomTimeout>=1&&(c=1e3*this.scheduleResult.config.enterRoomTimeout),this._joinTimeout=window.setTimeout((()=>{r(new tb({code:ZC.JOIN_ROOM_FAILED,message:xN({key:zk.JOIN_ROOM_TIMEOUT})}));}),c),jN.emit(nO.JOIN_SEND_CMD,{room:this}),this.signalChannel.send(this.singlePC?MU:uU,a),this.signalChannel.once(lU.JOIN_ROOM_RESULT,(t=>{this.clearJoinTimeout();let{code:n,message:o,data:s,tinyId:a}=t.data;jN.emit(nO.JOIN_RECEIVED_CMD_RES,{room:this,code:n}),0===n?(this._log.info("Join room success, start heartbeat"),a&&(this.tinyId=a),this.startHeartbeat(),this.syncUserList(),this.startSyncUserListInterval(),this._firstPublishedList=s.publishers,this.singlePC&&this.singlePC.connect(MC(PC({},s.ability),{useVp8:s.ability.useVp8||!!e.useVp8})).catch((()=>{})),i()):(this._log.error("Join room failed result: ".concat(n," error: ").concat(o)),r(new tb({code:ZC.JOIN_ROOM_FAILED,extraCode:n,message:xN({key:zk.JOIN_ROOM_FAILED,data:{error:o,code:n}})})));}));}))))}reJoin(){let e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];return HC(this,null,(function*(){if(this.isJoined)try{this._log.warn("reJoin pending: ".concat(this.joinParams.roomId));let t,i=[];if(this.singlePC&&(this.singlePC.close(),this.singlePC=null,i.push(this.initSinglePC().then((e=>(t=e,e))))),this.signalChannel&&(this.signalChannel.race=e,this.signalChannel.close(),i.push(this.signalChannel.connect())),yield Promise.all(i),yield this.doJoin(MC(PC({},this.joinParams),{role:"anchor"===this.role?20:21,privateMapKey:this.privateMapKey,latencyLevel:this.latencyLevel}),t),this._log.warn("reJoin success"),GN.logSuccessEvent({userId:this.userId,eventType:mk.REJOIN}),this.singlePC){let e=t=>{var i;"CONNECTED"===t.state&&(null==(i=this.singlePC)||i.off(XF.CONNECTION_STATE_CHANGED,e),this.uplinkConnection instanceof dB&&(this.uplinkConnection.installEvents(),this.uplinkConnection.onSinglePCReconnected()),this.remotePublishedUserMap.forEach((e=>{e.installEvents(),e.onSinglePCReconnected();})));};this.singlePC.on(XF.CONNECTION_STATE_CHANGED,e),this.checkConnectionsToReconnect(),this.uplinkConnection instanceof nF&&!this.uplinkConnection.getIsReconnecting()&&this.uplinkConnection.startReconnection();}}catch(hk){this._log.warn("reJoin fail ".concat(hk)),this.reset(),GN.logFailedEvent({userId:this.userId,eventType:mk.REJOIN,error:hk}),this.emit("error",new tb({code:ZC.JOIN_ROOM_FAILED,message:xN({key:zk.REJOIN_ROOM_FAILED,data:{roomId:this.joinParams.roomId}})}));}else this._log.warn("reJoin abort");}))}initialize(){return HC(this,null,(function*(){let e,{mainUrl:t,backupUrl:i}=this.getSignalChannelUrl(),r=this.signalChannel||function(e){let t=[...BU.values()].find((t=>t.room.userId===e&&!t.room.isJoined));return t||null}(this.userId),n=!!(r&&r.isConnected&&r.keepAlive);return Array.isArray(this.scheduleResult.domains)&&this.scheduleResult.domains.length>0&&(e=this.scheduleResult.domains[0]),this._log.info("".concat(n?"reuse":"setup"," signal channel")),n?(r.url=t,r.backupUrl=i,r.room=this,this.signalChannel=r):(this.signalChannel=new HU({sdkAppId:this.sdkAppId,userId:this.userId,userSig:this.userSig,url:t,backupUrl:i,race:this.enableSPC&&!this.proxy_ws,room:this,signalDomainWhenUnifiedProxy:this.proxy_unified?e:void 0}),this._customMessageManager=new fB(this,this.signalChannel),this._customMessageManager.on("message",(e=>{this.emit("custom-message",e);}))),this.networkQuality||(this.networkQuality=new lF({signalChannel:this.signalChannel,room:this}),this.networkQuality.on(lF.EVENT_NETWORK_QUALITY,(e=>{var t;this.emit("network-quality",e),null==(t=this.singlePC)||t.detectTCPAndUDP(e);}))),MP(this,this.signalChannel).add(iU,(e=>{jN.emit(nO.SIGNAL_CONNECTION_STATE_CHANGED,PC({room:this},e)),this.emit("signal-connection-state-changed",e);})).add(nU,(e=>{this.reset(),this.emit("error",e);})).add(lU.PEER_JOIN,(e=>{let{srcTinyId:t,userId:i,role:r}=e.data.data;this.userManager.addUser({userId:i,tinyId:t,role:r});})).add(lU.PEER_LEAVE,(e=>{let{userId:t,reason:i=0}=e.data.data;this.userManager.deleteUser(t,i);})).add(lU.UPDATE_REMOTE_MUTE_STAT,(e=>{this._lastHeartBeatTime>0&&Date.now()-this._lastHeartBeatTime>=1e4&&this.doHeartbeat(),this.onPublishedUserList(e.data);})).add(lU.CLIENT_BANNED,(e=>{let t=e.data.data,{reason:i}=t;if(GN.uploadEvent({log:"stat-banned:".concat(i),userId:this.userId}),"user_time_out"===i)return this._log.warn("".concat(i," last heart beat time: ").concat(this._lastHeartBeatTime," interval: ").concat(Date.now()-this._lastHeartBeatTime,", visibility: ").concat(document.visibilityState)),void this.reJoin();this._log["kick"===i?"error":"info"]("user was banned because of [".concat(i,"]")),this.reset(),this.emit("banned",{reason:i});})),this.signalChannel.once(tU,(e=>{this.tinyId=e.signalInfo.tinyId,jN.emit(nO.JOIN_SIGNAL_CONNECTION_END,{room:this});})),jN.emit(nO.JOIN_SIGNAL_CONNECTION_START,{room:this}),yield this.signalChannel.connect(),n&&jN.emit(nO.JOIN_SIGNAL_CONNECTION_END,{room:this}),n}))}setSignalChannel(e){this.signalChannel=e,e||LP(this);}leave(){return HC(this,null,(function*(){var e;try{yield this.doHeartbeat();}catch(hk){}this._log.info("leave() => leaving room"),jN.emit(nO.LEAVE_SEND_CMD,{room:this}),null==(e=this.signalChannel)||e.send(hU);}))}clearNetworkQuality(){this.networkQuality&&(this.networkQuality.stop(),delete this.networkQuality);}closeConnections(){this.remotePublishedUserMap.forEach((e=>{this.closeDownLinkConnection(e.userId,"you exitRoom");}));}clearJoinTimeout(){clearTimeout(this._joinTimeout),this._joinTimeout=-1;}startHeartbeat(){-1===this._heartbeat&&(this._heartbeat=NP.run(Uk,this.doHeartbeat.bind(this),{delay:2e3}));}stopHeartbeat(){-1!==this._heartbeat&&(this._log.info("stopHeartbeat"),NP.clearTask(this._heartbeat),this._heartbeat=-1,this._lastHeartBeatTime=-1);}doHeartbeat(){return HC(this,null,(function*(){var e;let t=this.badCaseDetector.getMonitorFreeze(),i=yield this._stats.getStatsReport({uplinkConnection:this.uplinkConnection,downlinkConnections:this.remotePublishedUserMap,freezeMap:t});this.badCaseDetector.resetMonitor();let r=null!=(e=this.signalChannel)&&e.isConnected?function(e){if(Rx.has(e)){let t=Rx.get(e).map((e=>({uint32_event_id:e.eventId,uint64_date:e.timestamp,str_userid:e.remoteUserId,uint32_param1:e.param1,uint32_param2:e.param2,uint32_video_stream_type:e.streamType})));return Rx.delete(e),t}return []}(this.userId):[],n=MC(PC({str_sdk_version:ab,uint64_datetime:(new Date).getTime(),msg_user_info:{str_identifier:this.userId,uint64_tinyid:this.tinyId},msg_event_msg:r,str_acc_ip:this.getSignalInfo().relayIp,str_client_ip:this.getSignalInfo().clientIp},i),{msg_device_info:PC({uint32_terminal_type:15,str_device_name:navigator.platform,str_os_version:"",uint32_net_type:lw()},i.msg_device_info)});if(this.heartbeatReport=n,jN.emit(nO.HEARTBEAT_REPORT,{room:this,report:n}),this.signalChannel){if(this.signalChannel.isConnected){this.signalChannel.send(pU,n);let e=Date.now();this._lastHeartBeatTime>0&&e-this._lastHeartBeatTime>1e4&&this._log.warn("heartbeat took ".concat(e-this._lastHeartBeatTime)),this._lastHeartBeatTime=e;}this.emit("heartbeat-report",MC(PC({},n),{bytes_sent:this._stats.totalBytesSent+this.signalChannel.bytesSent,bytes_received:this._stats.totalBytesReceived+this.signalChannel.bytesReceived}));}!this._isRelayChanged&&this.isRelayMaybeFailed()&&(this.reJoin(),this._isRelayChanged=!0);}))}onPublishedUserList(e){if(!this.isJoined)return;let t=e.data.userList.filter((e=>e.flag!==Yb)).map((e=>{let{userId:t,srcTinyId:i,flag:r}=e;t===this.userId&&this.uplinkConnection&&(this.uplinkConnection.flag=r);let n=this.remotePublishedUserMap.get(t);return n&&this.checkSubscribeBigSmallVideo(n),{userId:t,tinyId:i,flag:r}}));e.data.mixRobotList.forEach((e=>{let{userId:i,srcTinyId:r,flag:n,mixUserList:o}=e;t.unshift({userId:i,tinyId:r,flag:n,isRobot:!0,mixUserList:o});})),jN.emit(nO.RECEIVED_PUBLISHED_USER_LIST,{room:this,publishedUserList:t}),this.userManager.setRemotePublishedUserList(t);}closeUplink(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"you unpublished";this.uplinkConnection&&(this.localTracks.size>0&&this.uplinkConnection.doUnpublish(),this.uplinkConnection.close(e),this.uplinkConnection instanceof nF&&(this.uplinkConnection=null)),this.localTracks.forEach((e=>e.unpublish())),this.localTracks.clear();}createDownlinkConnection(e){let{userId:t,tinyId:i,flag:r,isRobot:n}=e,o=new(this.singlePC?pB:eF)({userId:t,tinyId:i,room:this,signalChannel:this.signalChannel,enableSEI:this.enableSEI,flag:r,isRobot:n});this.userManager.addRemotePublishedUser(o),this.installDownlinkEvents(o,t),this.emit("remote-published",o);}closeDownLinkConnection(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"remote user unpublished",i=this.remotePublishedUserMap.get(e);i&&(i.close(t),this.emit("remote-unpublished",i));}installDownlinkEvents(e,t){e.on("error",(e=>{let i=e.getCode();i!==ZC.ICE_TRANSPORT_ERROR&&(i===ZC.DOWNLINK_RECONNECTION_FAILED&&this.closeDownLinkConnection(t),this.emit("error",e));})),e.on("connection-state-changed",(t=>{this.emit("media-connection-state-changed",MC(PC({},t),{userId:e.userId}));})),e.on("firewall-restriction",(()=>{this.emit("firewall-restriction");}));}startSyncUserListInterval(){-1===this._syncUserListInterval&&(this._syncUserListInterval=NP.run(Uk,this.syncUserList.bind(this)));}stopSyncUserListInterval(){NP.clearTask(this._syncUserListInterval),this._syncUserListInterval=-1;}syncUserList(){return this.getUserList().then((e=>{this.userManager.setUserList(e);})).catch((e=>{this._log.debug("sync user list failed: ".concat(e));}))}getUserList(){var e;return null!=(e=this.signalChannel)&&e.isConnected?this.signalChannel.sendWaitForResponse({command:NU,responseCommand:lU.USER_LIST_RES,enableLog:!1,timeout:2e3}).then((e=>{let{data:t}=e,{code:i,message:r}=t;if(0===i)return (t.data&&t.data.userList||[]).map((e=>{let{userId:t,srcTinyId:i,role:r}=e;return {userId:t,tinyId:i,role:r}}));throw xN({key:zk.SIGNAL_RESPONSE_FAILED,data:{signalResponse:lU.USER_LIST_RES,code:i,message:r}})})):Promise.reject("not connected")}getAllConnections(){let e=[...this.remotePublishedUserMap.values()];return this.uplinkConnection&&e.push(this.uplinkConnection),e}isRelayMaybeFailed(){if(this.signalChannel&&!this.signalChannel.isOnline||!KU)return !1;if(this.singlePC)return this.singlePC.reconnectionCount>6;let e=this.getAllConnections();if(0===e.length)return !1;for(let t=0;t<e.length;t++)if(e[t].getReconnectionCount()<6)return !1;return !0}checkConnectionsToReconnect(){var e;this.singlePC?(null==(e=this.singlePC.getPeerConnection())?void 0:e.connectionState)===ck.CLOSED&&!this.singlePC.isReconnecting&&(this._log.warn("spc pc is closed but not reconnect"),this.singlePC.startReconnection()):this.getAllConnections().forEach((e=>{if(e instanceof zU&&!e.getIsReconnecting()){let t=e.getPeerConnection();t&&t.connectionState===ck.CLOSED&&(this._log.warn("[".concat(e.getUserId(),"] pc is closed but not reconnect")),e.startReconnection());}}));}fallbackToMPC(){return HC(this,null,(function*(){var e;if(this._log.warn("fallback to multi pc"),GN.uploadEvent({log:"stat-fallback",userId:this.userId}),this.enableSPC=!1,null==(e=this.singlePC)||e.close(),this.singlePC=null,this.isJoined&&(yield this.reJoin(!1)),this.uplinkConnection){let e=this.uplinkConnection;this.uplinkConnection=new nF({userId:this.userId,tinyId:this.tinyId,room:this,signalChannel:this.signalChannel,enableSEI:this.enableSEI}),e.isMainStreamPublished&&(yield this.uplinkConnection.publish({localAudioTrack:e.localMainAudioTrack,localVideoTrack:e.localMainVideoTrack,isAuxiliary:!1})),e.isAuxStreamPublished&&(yield this.uplinkConnection.publish({localAudioTrack:e.localAuxAudioTrack,localVideoTrack:e.localAuxVideoTrack,isAuxiliary:!0})),e.close();}for(let t of [...this.remotePublishedUserMap.values()]){let e=new eF({userId:t.userId,tinyId:t.tinyId,room:this,signalChannel:this.signalChannel,enableSEI:this.enableSEI,flag:t.flag,remoteAudioTrack:t.remoteAudioTrack,remoteVideoTrack:t.remoteVideoTrack,remoteAuxiliaryTrack:t.remoteAuxiliaryTrack});this.installDownlinkEvents(e,t.userId),this.remotePublishedUserMap.set(t.userId,e),t.isMainStreamSubscribed&&(yield e.subscribe(t.subscribeState,"main")),t.isAuxStreamSubscribed&&(yield e.subscribe(t.subscribeState,"auxiliary"));}}))}destroy(){this.isDestroyed||(this.signalChannel&&(this._log.info("destroying SignalChannel"),this.signalChannel.close(),this.signalChannel=null),super.destroy(),this._joinReject&&(this._joinReject(new tb({code:ZC.INVALID_OPERATION,message:xN({key:zk.CLIENT_DESTROYED,data:{funName:"join"}})})),this.clearJoinTimeout(),this.reset()),this.removeAllListeners(),this.healthDetector.destroy(),NP.clearTask(this._audioVolumeIntervalId));}switchRole(e){return HC(this,null,(function*(){this.role!==e&&("audience"===e&&this.uplinkConnection&&this.closeUplink("you switch role to audience"),yield this.doSwitchRole(e));}))}doSwitchRole(e){let t={command:wU,data:{role:"anchor"===e?20:21,privateMapKey:this.privateMapKey,latencyLevel:this.latencyLevel},responseCommand:lU.SWITCH_ROLE_RES,retries:1};return this._log.info("switchRole signal data: ".concat(JSON.stringify(t.data))),this.signalChannel.sendWaitForResponseWithRetry(t).then((t=>{let{code:i,message:r}=t.data;if(0!==i)throw new tb({code:ZC.SWITCH_ROLE_FAILED,message:xN({key:zk.SWITCH_ROLE_FAILED,data:{message:r,code:i}})});this.role=e;})).catch((e=>{throw e instanceof tb&&e.getCode()===ZC.API_CALL_TIMEOUT&&(e=new tb({code:ZC.SWITCH_ROLE_FAILED,message:xN({key:zk.SWITCH_ROLE_TIMEOUT})})),this._log.error(e),e}))}publish(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];return HC(this,null,(function*(){let e={},i={};t.forEach((t=>{t instanceof hL&&(t instanceof vL?i.audio=t:e.audio=t),t instanceof _L&&(t instanceof EL&&2===t.mediaType?i.video=t:e.video=t);}));let r=vB(e),n=vB(i);(!r||!n)&&!this.uplinkConnection&&(this.singlePC?this.uplinkConnection=new dB({userId:this.userId,tinyId:this.tinyId,room:this}):this.uplinkConnection=new nF({userId:this.userId,tinyId:this.tinyId,room:this,signalChannel:this.signalChannel,enableSEI:this.enableSEI}),this.uplinkConnection.on("connection-state-changed",(e=>{this.emit("media-connection-state-changed",MC(PC({},e),{userId:this.userId}));})),this.uplinkConnection.on("firewall-restriction",(()=>{this.emit("firewall-restriction");})),this.uplinkConnection.on("error",(e=>{let t=e.getCode();t!==ZC.ICE_TRANSPORT_ERROR&&(t===ZC.UPLINK_RECONNECTION_FAILED&&this.closeUplink(),this.emit("error",e));})));let o=t.map((e=>e.kind)).join(",");r||(this._log.info("publish() => main ".concat(o)),yield this.uplinkConnection.publish({localAudioTrack:e.audio,localVideoTrack:e.video,isAuxiliary:!1}),this._log.info("main is published")),n||(this._log.info("publish() => aux ".concat(o)),yield this.uplinkConnection.publish({localAudioTrack:i.audio,localVideoTrack:i.video,isAuxiliary:!0}),this._log.info("aux is published"));}))}unpublish(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];return HC(this,null,(function*(){if("live"===this.scene&&"anchor"!==this.role||!this.isMainStreamPublished&&!this.isAuxStreamPublished||!this.uplinkConnection)return;let e={},i={};t.forEach((t=>{!t.mediaTrack||!t.isPublished||(t instanceof hL&&(t instanceof vL?i.audio=t:e.audio=t),t instanceof _L&&(t instanceof EL&&2===t.mediaType?i.video=t:e.video=t));}));try{let r=t.map((e=>e.kind)).join(",");vB(e)||(this._log.info("unpublish() => main ".concat(r)),yield this.uplinkConnection.unpublish({localAudioTrack:e.audio,localVideoTrack:e.video})),vB(i)||(this._log.info("unpublish() => aux ".concat(r)),yield this.uplinkConnection.unpublish({localAudioTrack:i.audio,localVideoTrack:i.video}));}catch(r){}0===this.localTracks.size&&this.closeUplink("you unpublished");}))}addTrack(e){if(!this.uplinkConnection||!e.mediaTrack)return Promise.resolve();let t=this.uplinkConnection.addTrack(e);return e.publish(this,t),t}removeTrack(e){return this.uplinkConnection&&e.mediaTrack?this.uplinkConnection.removeTrack(e).then((t=>(e.unpublish(),t))):Promise.resolve()}replaceTrack(e){return this.uplinkConnection&&e.mediaTrack&&eP()?this.uplinkConnection.replaceTrack(e).then((t=>{t&&jN.emit(nO.LOCAL_TRACK_REPLACED,{track:e});})):Promise.resolve()}setBandWidth(e){return HC(this,null,(function*(){!this.uplinkConnection||(yield this.uplinkConnection.setBandwidth(e),yield this.uplinkConnection.sendMediaSettings());}))}enableSmall(e){return HC(this,null,(function*(){if(!this.uplinkConnection||!this.uplinkConnection.localMainVideoTrack)return Promise.resolve();e&&this.uplinkConnection.localMainVideoTrack.small&&(yield this.setBandWidth({type:Ub.VIDEO,videoType:Ub.SMALL,bandwidth:this.uplinkConnection.localMainVideoTrack.small.bitrate})),yield this.uplinkConnection.enableSmall(e);}))}subscribe(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];return HC(this,null,(function*(){if(t=t.filter((e=>!e.isSubscribed)),0===t.length)return;let{userId:e}=t[0],i=this.remotePublishedUserMap.get(e);if(!i)return;let r=t.find((e=>2===e.mediaType))?"auxiliary":"main";try{let n=PC({},i.subscribeState);t.forEach((e=>{switch(e.mediaType){case 1:n.audio=!0;break;case 4:n.video=!0;break;case 8:n.smallVideo=!0;break;case 2:n.auxiliary=!0;}}));let o=this._changeBigSmallRecords.get(e);o&&o.options.smallVideo&&i.muteState.hasSmall&&n.video&&(n.video=!1,n.smallVideo=!0),jN.emit(nO.SUBSCRIBE_START,{room:this,streamType:r,remotePublishedUser:i,subscribeState:n}),this._log.info("subscribe() => ".concat(e," ").concat(r," [").concat(XU(n),"] prev: [").concat(XU(i.subscribeState),"]")),yield i.subscribe(n,r),this._log.info("subscribe ".concat(e," ").concat(r," done"));for(let e of t)e.mediaTrack||(yield e.waitHasMediaTrack());jN.emit(nO.SUBSCRIBE_SUCCESS,{room:this,streamType:r,remotePublishedUser:i});}catch(hb){let i=hb instanceof tb?hb.getCode():ZC.UNKNOWN,n=hb;throw hb instanceof tb?i===ZC.REMOTE_STREAM_NOT_EXIST&&(n=new tb({code:ZC.API_CALL_ABORTED,message:xN({key:zk.API_CALL_ABORTED,data:{message:hb.message,userId:e,streamType:r}})}),this._log.warn(n)):(n=new tb({code:i,message:xN({key:zk.SUBSCRIBE_FAILED,data:{message:hb.message,userId:e,streamType:r}})}),this._log.error(n)),n}}))}unsubscribe(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];return HC(this,null,(function*(){let{userId:e}=t[0],i=this.remotePublishedUserMap.get(e);if(!i)return;let r=t.find((e=>2===e.mediaType))?"auxiliary":"main";this._log.info("unsubscribe() => ".concat(e," ").concat(r));try{yield i.unsubscribe({remoteTracks:t,streamType:r});}catch(hb){this._log.warn("unsubscribe() => failed ".concat(hb));}t.forEach((e=>{e.unsubscribe(),8===e.mediaType&&e.setMediaType(4);})),jN.emit(nO.UNSUBSCRIBE_SUCCESS,{room:this,streamType:r,remotePublishedUser:i});}))}setEncodedDataProcessingListener(e){throw new Error("Method not implemented.")}enableAudioVolumeEvaluation(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:2e3,t=arguments.length>1?arguments[1]:void 0;if(e<=0)return this._enableAudioVolumeEvaluation=!1,void NP.clearTask(this._audioVolumeIntervalId);e=Math.floor(Math.max(e,100)),jN.emit(nO.AUDIO_LEVEL_INTERVAL,{interval:e}),this._audioVolumeIntervalId&&NP.clearTask(this._audioVolumeIntervalId),this._enableAudioVolumeEvaluation=!0,this._audioVolumeIntervalId=NP.run(Fk,(()=>{var i;RM.isRunning?this.stopUpdateAudioLevelFromSenderStat():this.updateAudioLevelFromSenderStat(e,t);let r=[];null==(i=this.remotePublishedUserMap)||i.forEach((e=>{if(e.muteState.hasAudio){RM.isRunning?e.remoteAudioTrack.volume=0:this.updateDownlinkAudioLevelFromReceiver(e);let t=Math.floor(100*e.remoteAudioTrack.getAudioLevel());r.push({userId:e.userId,volume:t});}})),this.emit("audio-volume",r);}),{fps:1e3/e,backgroundTask:t});}updateAudioLevelFromSenderStat(e,t){return HC(this,null,(function*(){var i;if(!this.uplinkConnection||!this.uplinkConnection.localMainAudioTrack||-1!==this._updateAudioLevelTaskId)return;let r=null==(i=this.uplinkConnection.getPeerConnection())?void 0:i.getSenders()[0];if(!r)return;let n=Math.max(e,500);this._log.warn("updateAudioLevelFromSenderStat ".concat(n)),this._updateAudioLevelTaskId=NP.run(Fk,(()=>HC(this,null,(function*(){let e=yield r.getStats();this._updateAudioLevelTaskId<0||e.forEach((e=>{"media-source"===e.type&&e.audioLevel&&(this.uplinkConnection.localMainAudioTrack.volume=e.audioLevel);}));}))),{delay:n,backgroundTask:t});}))}stopUpdateAudioLevelFromSenderStat(){var e;-1!==this._updateAudioLevelTaskId&&(this._log.warn("stopUpdateAudioLevelFromSenderStat"),NP.clearTask(this._updateAudioLevelTaskId),this._updateAudioLevelTaskId=-1,null!=(e=this.uplinkConnection)&&e.localMainAudioTrack&&(this.uplinkConnection.localMainAudioTrack.volume=0));}updateDownlinkAudioLevelFromReceiver(e){var t;let{audioReceiver:i}=e;if(!iP||!i)return;let r=null==(t=i.getSynchronizationSources()[0])?void 0:t.audioLevel;this._log.debug("updateDownlinkAudioLevelFromReceiver"),r&&(e.remoteAudioTrack.volume=Math.min(2*r,1));}getLocalAudioStats(){return HC(this,null,(function*(){var e;let t={};return t[this.userId]={bytesSent:0,packetsSent:0,audioLevel:0},null!=(e=this.uplinkConnection)&&e.localMainAudioTrack&&(t[this.userId]=this.uplinkConnection.localMainAudioTrack.stat),t}))}getLocalVideoStats(){return HC(this,null,(function*(){var e,t;let i={};return i[this.userId]=(null==(t=null==(e=this.uplinkConnection)?void 0:e.localMainVideoTrack)?void 0:t.stat)||{bytesSent:0,packetsSent:0,framesEncoded:0,framesSent:0,frameWidth:0,frameHeight:0,fpsCapture:0},i}))}getTransportStats(){return HC(this,null,(function*(){let e={rtt:0,downlinksRTT:{}};if(this.uplinkConnection){let t=yield this._stats.getSenderStats(this.uplinkConnection);e.rtt=t.rtt;}for(let[,t]of this.remotePublishedUserMap){let i=yield this._stats.getReceiverStats(t);e.downlinksRTT[i.userId]=i.rtt;}return e}))}getRemoteVideoStats(e){return HC(this,null,(function*(){let t={};for(let[i,r]of this.remotePublishedUserMap)"main"===e&&r.muteState.hasVideo&&(t[i]=r.remoteVideoTrack.stat),"auxiliary"===e&&r.muteState.hasAuxiliary&&(t[i]=r.remoteAuxiliaryTrack.stat);return t}))}getRemoteAudioStats(){return HC(this,null,(function*(){let e={};for(let[t,i]of this.remotePublishedUserMap)i.muteState.hasAudio&&(e[t]=i.remoteAudioTrack.stat);return e}))}setTurnServer(e,t){this._log.info("set turn server: ".concat(JSON.stringify(e)," ").concat(t||""));let i=[];Array.isArray(e)?e.forEach((e=>i.push(ob.getTurnServer(e)))):ob.isPlainObject(e)&&i.push(ob.getTurnServer(e)),this._turnServers=i,t&&(this._iceTransportPolicy=t);}sendStartMixTranscode(e){return this.signalChannel.sendWaitForResponse({command:AU,data:e,timeout:5e3,responseCommand:lU.START_MIX_TRANSCODE_RES,commandDesc:"startMixTranscode"})}sendStopMixTranscode(e){return this.signalChannel.sendWaitForResponse({command:CU,data:e,timeout:5e3,responseCommand:lU.STOP_MIX_TRANSCODE_RES,commandDesc:"stopMixTranscode"})}sendStartPublishCDN(e){let t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];return this.signalChannel.sendWaitForResponse({command:t?yU:IU,data:e,timeout:5e3,responseCommand:t?lU.START_PUBLISH_TENCENT_CDN_RES:lU.START_PUBLISH_GIVEN_CDN_RES,commandDesc:"startPublishCDN"})}sendStopPublishCDN(e){let t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];return this.signalChannel.sendWaitForResponse({command:t?SU:RU,data:e,timeout:5e3,responseCommand:t?lU.STOP_PUBLISH_TENCENT_CDN_RES:lU.STOP_PUBLISH_GIVEN_CDN_RES,commandDesc:"stopPublishCDN"})}sendStartPushStreamToRoom(e){return this.signalChannel.sendWaitForResponse({command:bU,data:e,timeout:5e3,responseCommand:lU.START_PUBLISH_CDN_STREAM_RES,commandDesc:"startPublishCDNStream"})}sendUpdatePushStreamToRoom(e){return this.signalChannel.sendWaitForResponse({command:kU,data:e,timeout:5e3,responseCommand:lU.UPDATE_PUBLISH_CDN_STREAM_RES,commandDesc:"updatePublishCDNStream"})}sendStopPushStreamToRoom(e){return this.signalChannel.sendWaitForResponse({command:DU,data:e,timeout:5e3,responseCommand:lU.STOP_PUBLISH_CDN_STREAM_RES,commandDesc:"stopPublishCDNStream"})}sendAbilityStatus(e){var t;null==(t=this.signalChannel)||t.sendWaitForResponse({command:VU,data:e,timeout:5e3,responseCommand:lU.ABILITY_STATUS_REPORT_RESULT,commandDesc:"ability status report"}).catch((e=>{}));}getIceServers(){return 0===this._turnServers.length&&this.scheduleResult.iceServers?this.scheduleResult.iceServers:this._turnServers}getIceTransportPolicy(){return this.forceRelay?"relay":this._iceTransportPolicy||this.scheduleResult.iceTransportPolicy||"all"}getLogger(){return this._log}enableAIVoice(){throw new Error("Method not implemented.")}getSignalChannelUrl(){let e={mainUrl:"",backupUrl:""},t=ob.getEnv();return t?(e.mainUrl="wss://".concat(t,".rtc.qq.com"),e.backupUrl=e.mainUrl):this.proxy_ws?(e.mainUrl=this.proxy_ws,e.backupUrl=e.mainUrl):this.proxy_unified?(e.mainUrl="wss://".concat(this.proxy_unified),e.backupUrl=e.mainUrl):Array.isArray(this.scheduleResult.domains)&&this.scheduleResult.domains.length>0&&(e.mainUrl="wss://".concat(this.scheduleResult.domains[0]),e.backupUrl=e.mainUrl,this.scheduleResult.domains[1]&&(e.backupUrl="wss://".concat(this.scheduleResult.domains[1]))),e}getSignalInfo(){var e;return (null==(e=this.signalChannel)?void 0:e.getSignalInfo())||{clientIp:"",relayIp:""}}reset(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];this.stopSyncUserListInterval(),this.stopHeartbeat(),this.closeConnections(),this.clearNetworkQuality(),this.closeUplink("you exitRoom"),this.signalChannel&&(e&&this.signalChannel.keepAlive&&this.signalChannel.isConnected?this.signalChannel.stopKeepAliveIn(3600):(this.signalChannel.close(),this.setSignalChannel(null))),this._stats.reset(),this.userManager.clear(),this.userManager.removeAllListeners(),this.singlePC&&(this.singlePC.close(),this.singlePC=null),this.scheduleResult={domains:null,iceServers:null,iceTransportPolicy:null,trtcAutoConf:null};}checkSubscribeBigSmallVideo(e){return HC(this,null,(function*(){let{subscribeState:t,userId:i,muteState:{hasSmall:r,hasVideo:n}}=e;if(!r&&!n||!t.video&&!t.smallVideo)return;let o=this._changeBigSmallRecords.get(i);if(!o||o.isSubscribing||o.reSubscribeCount<=0)return;let{options:s,reSubscribeCount:a}=o;if(s.video&&t.video||s.smallVideo&&t.smallVideo&&r)return;let c={audio:e.remoteAudioTrack.isSubscribed||e.remoteAudioTrack.isSubscribing,auxiliary:e.remoteAuxiliaryTrack.isSubscribed||e.remoteAuxiliaryTrack.isSubscribing,video:s.video,smallVideo:s.smallVideo};try{if(!r&&c.smallVideo&&(c.video=!0,c.smallVideo=!1),c.smallVideo===t.smallVideo&&c.video===t.video)return;o.isSubscribing=!0,o.reSubscribeCount=a-1,yield e.subscribe(c,"main"),e.remoteVideoTrack.setMediaType(c.smallVideo?8:4),this._log.info("change [".concat(i,"] to ").concat(c.smallVideo?"small":"big"," video successfully. count ").concat(xk-o.reSubscribeCount,".")),o.isSubscribing=!1,o.reSubscribeCount=xk;}catch(l){this._log.info("change [".concat(i,"] to ").concat(c.smallVideo?"small":"big"," video failed. count ").concat(xk-o.reSubscribeCount,".")),o.isSubscribing=!1,0===o.reSubscribeCount&&this._changeBigSmallRecords.delete(i);}}))}changeType(e,t){let i={options:{video:!e,smallVideo:e},isSubscribing:!1,reSubscribeCount:xk};this._changeBigSmallRecords.set(t.userId,i),this._log.info("set [".concat(t.userId,"] video prefer type: ").concat(e?"small":"big"));}get smallStreamConfig(){return this._smallStreamConfig}_initBusinessInfo(e){this._businessInfo=e.businessInfo;let t={};if(gB(e.businessInfo)&&(t=JSON.parse(e.businessInfo)),!TB(e.pureAudioPushMode)){if(!Number.isInteger(Number(e.pureAudioPushMode)))throw new tb({code:ZC.INVALID_PARAMETER,message:xN({key:zk.INVALID_PURE_AUDIO})});this._pureAudioPushMode=e.pureAudioPushMode,t.Str_uc_params||(t.Str_uc_params={}),t.Str_uc_params.pure_audio_push_mod=this._pureAudioPushMode;}if(!TB(e.userDefineRecordId)){let i=/^[A-Za-z0-9_-]{1,64}$/gi;if(null===e.userDefineRecordId.match(i))throw new tb({code:ZC.INVALID_PARAMETER,message:xN({key:zk.INVALID_USER_DEFINE_RECORDID})});t.Str_uc_params||(t.Str_uc_params={}),t.Str_uc_params.userdefine_record_id=e.userDefineRecordId;}if(!TB(e.userDefinePushArgs)){if(!(gB(e.userDefinePushArgs)&&String(e.userDefinePushArgs)&&String(e.userDefinePushArgs).length<=256))throw new tb({code:ZC.INVALID_PARAMETER,message:xN({key:zk.INVALID_USER_DEFINE_PUSH_ARGS})});t.Str_uc_params||(t.Str_uc_params={}),t.Str_uc_params.userdefine_push_args=e.userDefinePushArgs;}vB(t)||(this._businessInfo=JSON.stringify(t));}sendCustomMessage(e){var t;null==(t=this._customMessageManager)||t.send(e);}enableInsertableStreams(){if(this.singlePC&&!this.singlePC.enableInsertableStreams&&oP)return this.singlePC.enableInsertableStreams=!0,this.singlePC.startReconnection()}sendSignalMessage(e){var t;return this.signalChannel?null==(t=this.signalChannel)?void 0:t.sendWaitForResponseWithRetry(e):Promise.reject(new tb({code:ZC.INVALID_OPERATION,message:"not join"}))}get enableCodecPipeline(){return this.videoManager.encodePipeline.length>0||this.videoManager.decodePipeline.length>0||this.audioManager.encodePipeline.length>0||this.audioManager.decodePipeline.length>0}get scriptTransformWorker(){var e;return null==(e=this.singlePC)?void 0:e.scriptTransformWorker}};return UC([PF(["left",xF.INIT],"joined"),VP({settings:{retries:1,timeout:0},onRetrying(e){this._log.warn("join retry ".concat(e));},onRetryFailed(e){this._log.error("join failed",e);},onError(e,t){this._isUsingCachedSchedule&&!this.isDestroyed?(this._log.warn("is using cached schedule, retry join"),zN(!0),this.reset(),t()):this.signalChannel&&this.signalChannel.isConnected&&this.signalChannel.keepAlive?(this._log.warn("is using keepAlive ws, retry join"),this.signalChannel.close(),this.reset(),t()):(this.reset(),t());}}),ZM((e=>{let t=new $V;return function(i,r,n){return HC(this,null,(function*(){let o=String(i.roomId||i.strRoomId);if(this.userId=i.userId,this.sdkAppId=i.sdkAppId,this.userSig=i.userSig,this._log.setSdkAppId(this.sdkAppId),this._log.setUserId(this.userId),this.scene=r,i.privateMapKey=i.privateMapKey||"",this.isJoined)throw new tb({code:ZC.INVALID_OPERATION,message:xN({key:zk.INVALID_JOIN})});if(this.checkDestroy(),t.isJoined({userId:this.userId,roomId:o,sdkAppId:this.sdkAppId,room:this}))throw new tb({code:ZC.INVALID_OPERATION,message:xN({key:zk.REPEAT_JOIN,data:this.userId})});t.add({room:this,roomId:o}),this.role=21===i.role?"audience":"anchor",this._log.info("Join() => joining room: ".concat(o," useStringRoomId: ").concat(this.useStringRoomId," scene: ").concat(this.scene," role: ").concat(this.role)),jN.emit(nO.JOIN_START,{room:this,roomId:o,params:i});let s=ob.getEnv();s||(s=kb.QCLOUD,this.proxy_ws&&(this.proxy_ws.startsWith(Bb.OLD_CLOUD_LADDER)?s=kb.OLD_CLOUD_LADDER:this.proxy_ws.startsWith(Bb.WEBRTC)&&(s=kb.WEBRTC))),GN.setConfig({env:s,sdkAppId:String(this.sdkAppId),userId:this.userId,roomId:o}),lO.checkSystemRequirementsInternal().then((e=>{this.checkSystemResult=e,ZV.call(this);}));try{!this.proxy_ws&&!this.proxy_wt&&!this.scheduleResult.domains&&!ob.getEnv()&&(yield this.schedule(i,n));let t=yield e.call(this,i,r,n);return this.roomId=o,this._joinedTimestamp=ob.performanceNow(),jN.emit(nO.JOIN_SUCCESS,{room:this}),30===n&&!i.component&&GN.uploadEvent({log:"stat-conv-".concat(Number(vN),"-").concat(location.hostname),userId:this.userId}),t}catch(a){throw t.delete({room:this,roomId:o}),jN.emit(nO.JOIN_FAILED,{room:this,error:a}),a}}))}}))],yB.prototype,"join",1),UC([PF("joined","left",{ignoreError:!0,success(){this.reset(!0);}}),ZM((e=>function(){return HC(this,null,(function*(){jN.emit(nO.LEAVE_START,{room:this}),yield e.call(this),jN.emit(nO.LEAVE_SUCCESS,{room:this,roomId:this.roomId});}))})),sL("leave room"),UP({fnName:"publish",validateArgs:!1}),UP({fnName:"unsubscribe",validateArgs:!1})],yB.prototype,"leave",1),UC([oL(),ZM((e=>function(){for(var t=arguments.length,i=new Array(t),r=0;r<t;r++)i[r]=arguments[r];return HC(this,null,(function*(){if("live"===this.scene&&"anchor"!==this.role||(i=i.filter((e=>e.outMediaTrack&&"capture"===e.state)),!i.length))return;jN.emit("61",{room:this});let t=e.apply(this,i);return i.forEach((e=>e.publish(this,t))),t}))})),VP({settings:{retries:uk,timeout:e=>Ew(e)},onError(e,t,i){var r;null!=(r=e.message)&&r.includes("timeout")?(this._log.warn("publish timeout"),t()):(this._log.error("publish failed: ".concat(e)),i(e),jN.emit(nO.PUBLISH_FAILED,{room:this}));}})],yB.prototype,"publish",1),UC([UP({fnName:"publish"}),function(e){return function(t,i,r){let n=r.value;return r.value=function(){for(var t=arguments.length,i=new Array(t),r=0;r<t;r++)i[r]=arguments[r];let o=rL.get(this);if(o){let t=o.queue.filter(((t,r)=>{if(0===r)return !0;let n=!0;return t.args.forEach((e=>{i.find((t=>t===e))||(n=!1);})),!n||(t.reject(new tb({code:ZC.API_CALL_ABORTED,message:e})),!1)}));o.queue=t;}return n.apply(this,i)},r}}("api-call"),oL(),ZM((e=>function(){for(var t=arguments.length,i=new Array(t),r=0;r<t;r++)i[r]=arguments[r];let n=e.apply(this,i);return i.forEach((e=>e.unpublish())),n})),$M((function(){var e,t;0===this.localTracks.size&&qO()&&(null==(t=null==(e=this.singlePC)?void 0:e.getPeerConnection())||t.getSenders().forEach((e=>e.track&&e.replaceTrack(null))));}))],yB.prototype,"unpublish",1),UC([aL((e=>e.userId))],yB.prototype,"replaceTrack",1),UC([aL((function(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];return t[0].userId})),RL(),ZM((e=>function(){for(var t=arguments.length,i=new Array(t),r=0;r<t;r++)i[r]=arguments[r];let n=e.apply(this,i);return i.forEach((e=>!e.isSubscribed&&e.subscribe(n))),n})),VP({settings:{retries:uk,timeout:e=>Ew(e)},onError(e,t,i,r){e.message.includes("timeout")?(this._log.warn("subscribe timeout"),t()):(this._log.error("subscribe failed: ".concat(e)),i(e),jN.emit(nO.SUBSCRIBE_FAILED,{room:this,remoteTracks:r}));}})],yB.prototype,"subscribe",1),UC([UP({fnName:"subscribe",callback(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];this.singlePC||t.forEach((e=>{let t=this.remotePublishedUserMap.get(e.userId);t&&!t.isMainStreamSubscribed&&!t.isAuxStreamSubscribed&&t.close("you unsubscribed");}));}}),aL((function(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];return t[0].userId}))],yB.prototype,"unsubscribe",1),XV.create=XV._create.bind(XV,yB),XV})); 
		} (trtc$2, trtc$2.exports));
		return trtc$2.exports;
	}

	var trtcExports = requireTrtc();
	var TRTC = /*@__PURE__*/getDefaultExportFromCjs(trtcExports);

	var trtc = {
	  data: function data() {
	    return {
	      trtc: null,
	      remoteUsersViews: [],
	      isMutedVideo: false,
	      isMutedAudio: false,
	      camStatus: 'stopped',
	      // stopped, starting, started, stopping
	      micStatus: 'stopped',
	      roomStatus: 'exited',
	      // exited, exiting, entering, entered
	      sdkAppId: 1600034165,
	      sdkSecretKey: 'd5e0d1870929a2f52025a0cf19a9281ac133d3b8391877a3dab09bc40a2b2b30',
	      microphoneId: '',
	      // audio device id
	      cameraId: '' // video device id
	    };
	  },
	  methods: {
	    initTRTC: function initTRTC(_ref) {
	      var sdkAppId = _ref.sdkAppId,
	        sdkSecretKey = _ref.sdkSecretKey;
	      if (this.trtc) return;
	      this.sdkAppId = sdkAppId;
	      this.sdkSecretKey = sdkSecretKey;
	      this.trtc = TRTC.create();
	      console.log('trtc instance created.');
	    },
	    enterRoom: function enterRoom(_ref2) {
	      var _this = this;
	      return _asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee() {
	        var userId, roomId, _ref2$autoReceiveAudi, autoReceiveAudio;
	        return _regeneratorRuntime().wrap(function _callee$(_context) {
	          while (1) switch (_context.prev = _context.next) {
	            case 0:
	              userId = _ref2.userId, roomId = _ref2.roomId, _ref2$autoReceiveAudi = _ref2.autoReceiveAudio, autoReceiveAudio = _ref2$autoReceiveAudi === void 0 ? true : _ref2$autoReceiveAudi;
	              _this.roomStatus = 'entering';
	              _this.initTRTC();
	              _context.prev = 3;
	              _context.next = 6;
	              return _this.trtc.enterRoom({
	                roomId: roomId,
	                sdkAppId: parseInt(_this.sdkAppId, 10),
	                userId: userId,
	                userSig: new LibGenerateTestUserSig(_this.sdkAppId, _this.sdkSecretKey, 604800).genTestUserSig(userId),
	                autoReceiveAudio: autoReceiveAudio
	              });
	            case 6:
	              _this.roomStatus = 'entered';
	              _this.installEventHandlers();
	              _this.startGetAudioLevel();
	              // this.reportSuccessEvent('enterRoom');
	              console.log("Enter room [".concat(roomId, "] success."));
	              _context.next = 17;
	              break;
	            case 12:
	              _context.prev = 12;
	              _context.t0 = _context["catch"](3);
	              _this.roomStatus = 'exited';
	              console.error('enterRoom room failed', _context.t0);
	              throw _context.t0;
	            case 17:
	            case "end":
	              return _context.stop();
	          }
	        }, _callee, null, [[3, 12]]);
	      }))();
	    },
	    handleStartLocalAudio: function handleStartLocalAudio() {
	      var _this2 = this;
	      return _asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee2() {
	        return _regeneratorRuntime().wrap(function _callee2$(_context2) {
	          while (1) switch (_context2.prev = _context2.next) {
	            case 0:
	              _this2.micStatus = 'starting';
	              _this2.initTRTC();
	              _context2.prev = 2;
	              _context2.next = 5;
	              return _this2.trtc.startLocalAudio({
	                mute: true,
	                option: {
	                  microphoneId: _this2.microphoneId
	                }
	              });
	            case 5:
	              _this2.isMutedAudio = true;
	              _this2.micStatus = 'started';
	              console.log('Local audio started successfully');
	              _context2.next = 14;
	              break;
	            case 10:
	              _context2.prev = 10;
	              _context2.t0 = _context2["catch"](2);
	              _this2.micStatus = 'stopped';
	              throw _context2.t0;
	            case 14:
	            case "end":
	              return _context2.stop();
	          }
	        }, _callee2, null, [[2, 10]]);
	      }))();
	    },
	    handleStopLocalAudio: function handleStopLocalAudio() {
	      var _this3 = this;
	      return _asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee3() {
	        return _regeneratorRuntime().wrap(function _callee3$(_context3) {
	          while (1) switch (_context3.prev = _context3.next) {
	            case 0:
	              if (!(_this3.micStatus !== 'started')) {
	                _context3.next = 3;
	                break;
	              }
	              console.log('The audio has not been started');
	              return _context3.abrupt("return");
	            case 3:
	              _this3.micStatus = 'stopping';
	              _this3.initTRTC();
	              _context3.prev = 5;
	              _context3.next = 8;
	              return _this3.trtc.stopLocalAudio();
	            case 8:
	              _this3.micStatus = 'stopped';
	              console.log('Local audio stopped successfully');
	              _context3.next = 16;
	              break;
	            case 12:
	              _context3.prev = 12;
	              _context3.t0 = _context3["catch"](5);
	              _this3.micStatus = 'started';
	              throw _context3.t0;
	            case 16:
	            case "end":
	              return _context3.stop();
	          }
	        }, _callee3, null, [[5, 12]]);
	      }))();
	    },
	    handleStartLocalVideo: function handleStartLocalVideo(viewDomId) {
	      var _this4 = this;
	      return _asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee4() {
	        return _regeneratorRuntime().wrap(function _callee4$(_context4) {
	          while (1) switch (_context4.prev = _context4.next) {
	            case 0:
	              _this4.camStatus = 'starting';
	              _this4.initTRTC();
	              _context4.prev = 2;
	              _context4.next = 5;
	              return _this4.trtc.startLocalVideo({
	                view: viewDomId,
	                option: {
	                  cameraId: _this4.cameraId,
	                  profile: '1080p'
	                }
	              });
	            case 5:
	              _this4.camStatus = 'started';
	              _this4.isMutedVideo = false;
	              console.log('Local video started successfully');
	              _context4.next = 15;
	              break;
	            case 10:
	              _context4.prev = 10;
	              _context4.t0 = _context4["catch"](2);
	              _this4.camStatus = 'stopped';
	              console.log("Local video is failed to started. Error: ".concat(_context4.t0.message));
	              throw _context4.t0;
	            case 15:
	            case "end":
	              return _context4.stop();
	          }
	        }, _callee4, null, [[2, 10]]);
	      }))();
	    },
	    handleStopLocalVideo: function handleStopLocalVideo() {
	      var _this5 = this;
	      return _asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee5() {
	        return _regeneratorRuntime().wrap(function _callee5$(_context5) {
	          while (1) switch (_context5.prev = _context5.next) {
	            case 0:
	              if (!(_this5.camStatus !== 'started')) {
	                _context5.next = 3;
	                break;
	              }
	              console.log('The video has not been started');
	              return _context5.abrupt("return");
	            case 3:
	              _this5.camStatus = 'stopping';
	              _this5.initTRTC();
	              _context5.prev = 5;
	              _context5.next = 8;
	              return _this5.trtc.stopLocalVideo();
	            case 8:
	              _this5.camStatus = 'stopped';
	              console.log('Local audio stopped successfully');
	              _context5.next = 17;
	              break;
	            case 12:
	              _context5.prev = 12;
	              _context5.t0 = _context5["catch"](5);
	              _this5.camStatus = 'started';
	              console.log("Local audio is failed to stopped. Error: ".concat(_context5.t0.message));
	              throw _context5.t0;
	            case 17:
	            case "end":
	              return _context5.stop();
	          }
	        }, _callee5, null, [[5, 12]]);
	      }))();
	    },
	    exitRoom: function exitRoom() {
	      var _this6 = this;
	      return _asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee6() {
	        return _regeneratorRuntime().wrap(function _callee6$(_context6) {
	          while (1) switch (_context6.prev = _context6.next) {
	            case 0:
	              if (!(_this6.roomStatus !== 'entered')) {
	                _context6.next = 3;
	                break;
	              }
	              console.log('The room has not been entered');
	              return _context6.abrupt("return");
	            case 3:
	              _this6.roomStatus = 'exiting';
	              _this6.stopGetAudioLevel();
	              _context6.prev = 5;
	              _context6.next = 8;
	              return _this6.trtc.exitRoom();
	            case 8:
	              _this6.roomStatus = 'exited';
	              _this6.remoteUsersViews = [];
	              _this6.uninstallEventHandlers();
	              console.log('Exit room success.');
	              _context6.next = 19;
	              break;
	            case 14:
	              _context6.prev = 14;
	              _context6.t0 = _context6["catch"](5);
	              _this6.roomStatus = 'entered';
	              console.log("Exit room failed. Error: ".concat(_context6.t0.message));
	              throw _context6.t0;
	            case 19:
	              if (_this6.micStatus === 'started') _this6.handleStopLocalAudio();
	              if (_this6.camStatus === 'started') _this6.handleStopLocalVideo();
	              if (_this6.shareStatus === 'shared') _this6.handleStopScreenShare();
	            case 22:
	            case "end":
	              return _context6.stop();
	          }
	        }, _callee6, null, [[5, 14]]);
	      }))();
	    },
	    muteVideo: function muteVideo() {
	      var _this7 = this;
	      return _asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee7() {
	        return _regeneratorRuntime().wrap(function _callee7$(_context7) {
	          while (1) switch (_context7.prev = _context7.next) {
	            case 0:
	              _context7.prev = 0;
	              _context7.next = 3;
	              return _this7.trtc.updateLocalVideo({
	                mute: true
	              });
	            case 3:
	              _this7.isMutedVideo = true;
	              console.log('Mute video success.');
	              _context7.next = 10;
	              break;
	            case 7:
	              _context7.prev = 7;
	              _context7.t0 = _context7["catch"](0);
	              console.log("Mute video error: ".concat(_context7.t0.message));
	            case 10:
	            case "end":
	              return _context7.stop();
	          }
	        }, _callee7, null, [[0, 7]]);
	      }))();
	    },
	    muteAudio: function muteAudio() {
	      var _this8 = this;
	      return _asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee8() {
	        return _regeneratorRuntime().wrap(function _callee8$(_context8) {
	          while (1) switch (_context8.prev = _context8.next) {
	            case 0:
	              _context8.prev = 0;
	              _context8.next = 3;
	              return _this8.trtc.updateLocalAudio({
	                mute: true
	              });
	            case 3:
	              _this8.isMutedAudio = true;
	              console.log('Mute audio success.');
	              _context8.next = 10;
	              break;
	            case 7:
	              _context8.prev = 7;
	              _context8.t0 = _context8["catch"](0);
	              console.log("Mute audio error: ".concat(_context8.t0.message));
	            case 10:
	            case "end":
	              return _context8.stop();
	          }
	        }, _callee8, null, [[0, 7]]);
	      }))();
	    },
	    unmuteVideo: function unmuteVideo() {
	      var _this9 = this;
	      return _asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee9() {
	        return _regeneratorRuntime().wrap(function _callee9$(_context9) {
	          while (1) switch (_context9.prev = _context9.next) {
	            case 0:
	              _context9.prev = 0;
	              _context9.next = 3;
	              return _this9.trtc.updateLocalVideo({
	                mute: false
	              });
	            case 3:
	              _this9.isMutedVideo = false;
	              console.log('Unmute video success.');
	              _context9.next = 10;
	              break;
	            case 7:
	              _context9.prev = 7;
	              _context9.t0 = _context9["catch"](0);
	              console.log("Unmute video error: ".concat(_context9.t0.message));
	            case 10:
	            case "end":
	              return _context9.stop();
	          }
	        }, _callee9, null, [[0, 7]]);
	      }))();
	    },
	    // 静音某个远端用户  * 代表所有用户
	    muteRemoteAudio: function muteRemoteAudio() {
	      var _arguments = arguments,
	        _this10 = this;
	      return _asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee10() {
	        var remoteUserId, mute;
	        return _regeneratorRuntime().wrap(function _callee10$(_context10) {
	          while (1) switch (_context10.prev = _context10.next) {
	            case 0:
	              remoteUserId = _arguments.length > 0 && _arguments[0] !== undefined ? _arguments[0] : '*';
	              mute = _arguments.length > 1 ? _arguments[1] : undefined;
	              _context10.prev = 2;
	              _context10.next = 5;
	              return _this10.trtc.muteRemoteAudio(remoteUserId, mute);
	            case 5:
	              console.log('mute remote audio success.');
	              _context10.next = 11;
	              break;
	            case 8:
	              _context10.prev = 8;
	              _context10.t0 = _context10["catch"](2);
	              console.log("mute remote audio error: ".concat(_context10.t0.message));
	            case 11:
	            case "end":
	              return _context10.stop();
	          }
	        }, _callee10, null, [[2, 8]]);
	      }))();
	    },
	    unmuteAudio: function unmuteAudio() {
	      var _this11 = this;
	      return _asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee11() {
	        return _regeneratorRuntime().wrap(function _callee11$(_context11) {
	          while (1) switch (_context11.prev = _context11.next) {
	            case 0:
	              _context11.prev = 0;
	              _context11.next = 3;
	              return _this11.trtc.updateLocalAudio({
	                mute: false
	              });
	            case 3:
	              _this11.isMutedAudio = false;
	              console.log('Unmute audio success.');
	              _context11.next = 10;
	              break;
	            case 7:
	              _context11.prev = 7;
	              _context11.t0 = _context11["catch"](0);
	              console.log("Unmute audio error: ".concat(_context11.t0.message));
	            case 10:
	            case "end":
	              return _context11.stop();
	          }
	        }, _callee11, null, [[0, 7]]);
	      }))();
	    },
	    startGetAudioLevel: function startGetAudioLevel() {
	      this.trtc.on(TRTC.EVENT.AUDIO_VOLUME, function (event) {
	        event.result.forEach(function (_ref3) {
	          var userId = _ref3.userId,
	            volume = _ref3.volume;
	          var isMe = userId === '';
	          if (isMe) {
	            console.log("my volume: ".concat(volume));
	          } else {
	            console.log("user: ".concat(userId, " volume: ").concat(volume));
	          }
	        });
	      });
	      this.trtc.enableAudioVolumeEvaluation(2000);
	    },
	    stopGetAudioLevel: function stopGetAudioLevel() {
	      this.trtc && this.trtc.enableAudioVolumeEvaluation(-1);
	    },
	    installEventHandlers: function installEventHandlers() {
	      this.trtc.on(TRTC.EVENT.ERROR, this.handleError);
	      this.trtc.on(TRTC.EVENT.KICKED_OUT, this.handleKickedOut);
	      this.trtc.on(TRTC.EVENT.REMOTE_USER_ENTER, this.handleRemoteUserEnter);
	      this.trtc.on(TRTC.EVENT.REMOTE_USER_EXIT, this.handleRemoteUserExit);
	      this.trtc.on(TRTC.EVENT.REMOTE_VIDEO_AVAILABLE, this.handleRemoteVideoAvailable);
	      this.trtc.on(TRTC.EVENT.REMOTE_VIDEO_UNAVAILABLE, this.handleRemoteVideoUnavailable);
	      this.trtc.on(TRTC.EVENT.REMOTE_AUDIO_UNAVAILABLE, this.handleRemoteAudioUnavailable);
	      this.trtc.on(TRTC.EVENT.REMOTE_AUDIO_AVAILABLE, this.handleRemoteAudioAvailable);
	      this.trtc.on(TRTC.EVENT.SCREEN_SHARE_STOPPED, this.handleScreenShareStopped);
	      this.trtc.on(TRTC.EVENT.CUSTOM_MESSAGE, this.handleCustomMessage);
	    },
	    uninstallEventHandlers: function uninstallEventHandlers() {
	      this.trtc.off(TRTC.EVENT.ERROR, this.handleError);
	      this.trtc.off(TRTC.EVENT.KICKED_OUT, this.handleKickedOut);
	      this.trtc.off(TRTC.EVENT.REMOTE_USER_ENTER, this.handleRemoteUserEnter);
	      this.trtc.off(TRTC.EVENT.REMOTE_USER_EXIT, this.handleRemoteUserExit);
	      this.trtc.off(TRTC.EVENT.REMOTE_VIDEO_AVAILABLE, this.handleRemoteVideoAvailable);
	      this.trtc.off(TRTC.EVENT.REMOTE_VIDEO_UNAVAILABLE, this.handleRemoteVideoUnavailable);
	      this.trtc.off(TRTC.EVENT.REMOTE_AUDIO_UNAVAILABLE, this.handleRemoteAudioUnavailable);
	      this.trtc.off(TRTC.EVENT.REMOTE_AUDIO_AVAILABLE, this.handleRemoteAudioAvailable);
	      this.trtc.off(TRTC.EVENT.SCREEN_SHARE_STOPPED, this.handleScreenShareStopped);
	      this.trtc.off(TRTC.EVENT.CUSTOM_MESSAGE, this.handleCustomMessage);
	    },
	    handleError: function handleError(error) {
	      console.log("Local error: ".concat(error.message));
	      alert(error);
	    },
	    handleKickedOut: function handleKickedOut(event) {
	      var _this12 = this;
	      return _asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee12() {
	        return _regeneratorRuntime().wrap(function _callee12$(_context12) {
	          while (1) switch (_context12.prev = _context12.next) {
	            case 0:
	              console.log("User has been kicked out for ".concat(event.reason));
	              _this12.trtc = null;
	              _context12.next = 4;
	              return _this12.exitRoom();
	            case 4:
	            case "end":
	              return _context12.stop();
	          }
	        }, _callee12);
	      }))();
	    },
	    handleRemoteUserEnter: function handleRemoteUserEnter(event) {
	      var userId = event.userId;
	      console.log("Remote User [".concat(userId, "] entered"));
	    },
	    handleRemoteUserExit: function handleRemoteUserExit(event) {
	      console.log("Remote User [".concat(event.userId, "] exit"));
	    },
	    handleRemoteVideoAvailable: function handleRemoteVideoAvailable(event) {
	      var _this13 = this;
	      var userId = event.userId,
	        streamType = event.streamType;
	      try {
	        console.log("[".concat(userId, "] [").concat(streamType, "] video available"));
	        if (streamType === TRTC.TYPE.STREAM_TYPE_MAIN) {
	          this.remoteUsersViews.push("".concat(userId, "_main"));
	          this.$nextTick(/*#__PURE__*/_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee13() {
	            return _regeneratorRuntime().wrap(function _callee13$(_context13) {
	              while (1) switch (_context13.prev = _context13.next) {
	                case 0:
	                  _context13.next = 2;
	                  return _this13.trtc.startRemoteVideo({
	                    userId: userId,
	                    streamType: streamType,
	                    view: "".concat(userId, "_main"),
	                    option: {
	                      fillMode: 'contain'
	                    }
	                  });
	                case 2:
	                case "end":
	                  return _context13.stop();
	              }
	            }, _callee13);
	          })));
	        } else {
	          this.remoteUsersViews.push("".concat(userId, "_screen"));
	          this.$nextTick(/*#__PURE__*/_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee14() {
	            return _regeneratorRuntime().wrap(function _callee14$(_context14) {
	              while (1) switch (_context14.prev = _context14.next) {
	                case 0:
	                  _context14.next = 2;
	                  return _this13.trtc.startRemoteVideo({
	                    userId: userId,
	                    streamType: streamType,
	                    view: "".concat(userId, "_screen")
	                    // option: {
	                    //   fillMode: 'fill',
	                    // },
	                  });
	                case 2:
	                case "end":
	                  return _context14.stop();
	              }
	            }, _callee14);
	          })));
	        }
	        console.log("Play remote video success: [".concat(userId, "]"));
	      } catch (error) {
	        console.log("Play remote video failed: [".concat(userId, "], error: ").concat(error.message));
	      }
	    },
	    handleRemoteVideoUnavailable: function handleRemoteVideoUnavailable(event) {
	      console.log("[".concat(event.userId, "] [").concat(event.streamType, "] video unavailable"));
	      var streamType = event.streamType;
	      this.trtc.stopRemoteVideo({
	        userId: event.userId,
	        streamType: streamType
	      });
	      if (streamType === TRTC.TYPE.STREAM_TYPE_MAIN) {
	        this.remoteUsersViews = this.remoteUsersViews.filter(function (userId) {
	          return userId !== "".concat(event.userId, "_main");
	        });
	      } else {
	        this.remoteUsersViews = this.remoteUsersViews.filter(function (userId) {
	          return userId !== "".concat(event.userId, "_screen");
	        });
	      }
	    },
	    handleRemoteAudioUnavailable: function handleRemoteAudioUnavailable(event) {
	      console.log("[".concat(event.userId, "] audio unavailable"));
	    },
	    handleRemoteAudioAvailable: function handleRemoteAudioAvailable(event) {
	      console.log("[".concat(event.userId, "] audio available"));
	    },
	    handleScreenShareStopped: function handleScreenShareStopped() {
	      this.shareStatus = 'stopped';
	      console.log('Stop share screen success');
	    },
	    handleCustomMessage: function handleCustomMessage(event) {
	      // event.userId: 远端发消息的 userId
	      // event.cmdId: 您自定义的消息 Id
	      // event.seq: 消息的序号
	      // event.data: 消息内容，ArrayBuffer 类型
	      console.log("received custom msg from ".concat(event.userId, ", message: ").concat(new TextDecoder().decode(event.data)));
	    },
	    getDevice: function getDevice() {
	      var _this14 = this;
	      return _asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee15() {
	        var microphoneList, cameraList;
	        return _regeneratorRuntime().wrap(function _callee15$(_context15) {
	          while (1) switch (_context15.prev = _context15.next) {
	            case 0:
	              _context15.next = 2;
	              return TRTC.getMicrophoneList();
	            case 2:
	              microphoneList = _context15.sent;
	              _context15.next = 5;
	              return TRTC.getCameraList();
	            case 5:
	              cameraList = _context15.sent;
	              // let speakerList = await TRTC.getSpeakerList();
	              console.log(microphoneList, cameraList, 'microphoneList-----cameraList-----');
	              if (microphoneList.length > 0) _this14.microphoneId = microphoneList[0].deviceId;
	              if (cameraList.length > 0) _this14.cameraId = cameraList[0].deviceId;
	            case 9:
	            case "end":
	              return _context15.stop();
	          }
	        }, _callee15);
	      }))();
	    }
	  }
	};

	var index = {
	  imChat: imChat,
	  trtc: trtc
	};

	return index;

}));
//# sourceMappingURL=index.js.map
